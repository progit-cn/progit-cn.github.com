<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0">
<title>Pro Git</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-check-square-o:first-child,ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after,a[href^="mailto:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Pro Git</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_pro_git">Pro Git</a>
<ul class="sectlevel1">
<li><a href="#_preface_by_scott_chacon">Preface by Scott Chacon</a></li>
<li><a href="#_preface_by_ben_straub">Preface by Ben Straub</a></li>
<li><a href="#_dedications">Dedications</a></li>
<li><a href="#_getting_started">起步</a>
<ul class="sectlevel2">
<li><a href="#_关于版本控制">关于版本控制</a></li>
<li><a href="#_git_简史">Git 简史</a></li>
<li><a href="#_git_基础">Git 基础</a></li>
<li><a href="#_命令行">命令行</a></li>
<li><a href="#_安装_git">安装 Git</a></li>
<li><a href="#_first_time">First-Time Git Setup</a></li>
<li><a href="#_git_help">获取帮助</a></li>
<li><a href="#_总结">总结</a></li>
</ul>
</li>
<li><a href="#_git_basics_chapter">Git 基础</a>
<ul class="sectlevel2">
<li><a href="#_getting_a_repo">获取 Git 仓库</a></li>
<li><a href="#_记录每次更新到仓库">记录每次更新到仓库</a></li>
<li><a href="#_viewing_history">Viewing the Commit History</a></li>
<li><a href="#_undoing">Undoing Things</a></li>
<li><a href="#_remote_repos">Working with Remotes</a></li>
<li><a href="#_git_tagging">Tagging</a></li>
<li><a href="#_git_aliases">Git Aliases</a></li>
<li><a href="#_总结_2">总结</a></li>
</ul>
</li>
<li><a href="#_git_branching">Git 分支</a>
<ul class="sectlevel2">
<li><a href="#_git_branches_overview">分支简介</a></li>
<li><a href="#_basic_branching_and_merging">Basic Branching and Merging</a></li>
<li><a href="#_branch_management">Branch Management</a></li>
<li><a href="#_branching_workflows">Branching Workflows</a></li>
<li><a href="#_remote_branches">Remote Branches</a></li>
<li><a href="#_rebasing">衍合</a></li>
<li><a href="#_总结_3">总结</a></li>
</ul>
</li>
<li><a href="#_伺服器上的_git">伺服器上的 Git</a>
<ul class="sectlevel2">
<li><a href="#_the_protocols">The Protocols</a></li>
<li><a href="#_git_on_the_server">Getting Git on a Server</a></li>
<li><a href="#_generate_ssh_key">Generating Your SSH Public Key</a></li>
<li><a href="#_setting_up_server">Setting Up the Server</a></li>
<li><a href="#_git_daemon">Git Daemon</a></li>
<li><a href="#_smart_http_2">Smart HTTP</a></li>
<li><a href="#_gitweb">GitWeb</a></li>
<li><a href="#_gitlab">GitLab</a></li>
<li><a href="#_third_party_hosted_options">Third Party Hosted Options</a></li>
<li><a href="#_总结_4">总结</a></li>
</ul>
</li>
<li><a href="#_distributed_git">Distributed Git</a>
<ul class="sectlevel2">
<li><a href="#_distributed_workflows">Distributed Workflows</a></li>
<li><a href="#_contributing_project">Contributing to a Project</a></li>
<li><a href="#_maintaining_a_project">Maintaining a Project</a></li>
<li><a href="#_summary_2">Summary</a></li>
</ul>
</li>
<li><a href="#_github">GitHub</a>
<ul class="sectlevel2">
<li><a href="#_account_setup_and_configuration">Account Setup and Configuration</a></li>
<li><a href="#_contributing_to_a_project">Contributing to a Project</a></li>
<li><a href="#_maintaining_gh_project">Maintaining a Project</a></li>
<li><a href="#_github_orgs">Managing an organization</a></li>
<li><a href="#_scripting_github">Scripting GitHub</a></li>
<li><a href="#_summary_3">Summary</a></li>
</ul>
</li>
<li><a href="#_git_tools">Git 工具</a>
<ul class="sectlevel2">
<li><a href="#_revision_selection">选择修订版本（Revision）</a></li>
<li><a href="#_interactive_staging">Interactive Staging</a></li>
<li><a href="#_git_stashing">Stashing and Cleaning</a></li>
<li><a href="#_signing">Signing Your Work</a></li>
<li><a href="#_searching">搜索</a></li>
<li><a href="#_rewriting_history">Rewriting History</a></li>
<li><a href="#_git_reset">Reset Demystified</a></li>
<li><a href="#_advanced_merging">Advanced Merging</a></li>
<li><a href="#_rerere">Rerere</a></li>
<li><a href="#_使用_git_调试">使用 Git 调试</a></li>
<li><a href="#_git_submodules">Submodules</a></li>
<li><a href="#_bundling">打包</a></li>
<li><a href="#_replace">Replace</a></li>
<li><a href="#_credential_caching">凭证存储</a></li>
<li><a href="#_总结_5">总结</a></li>
</ul>
</li>
<li><a href="#_customizing_git">Customizing Git</a>
<ul class="sectlevel2">
<li><a href="#_git_config">Git Configuration</a></li>
<li><a href="#_git_attributes">Git Attributes</a></li>
<li><a href="#_git_hooks">Git Hooks</a></li>
<li><a href="#_an_example_git_enforced_policy">An Example Git-Enforced Policy</a></li>
<li><a href="#_summary_5">Summary</a></li>
</ul>
</li>
<li><a href="#_git_and_other_systems">Git and Other Systems</a>
<ul class="sectlevel2">
<li><a href="#_git_as_a_client">Git as a Client</a></li>
<li><a href="#_migrating">Migrating to Git</a></li>
<li><a href="#_summary_6">Summary</a></li>
</ul>
</li>
<li><a href="#_git_internals">Git Internals</a>
<ul class="sectlevel2">
<li><a href="#_plumbing_porcelain">Plumbing and Porcelain</a></li>
<li><a href="#_objects">Git Objects</a></li>
<li><a href="#_git_refs">Git References</a></li>
<li><a href="#_packfiles">Packfiles</a></li>
<li><a href="#_refspec">The Refspec</a></li>
<li><a href="#_transfer_protocols">Transfer Protocols</a></li>
<li><a href="#_maintenance_and_data_recovery">Maintenance and Data Recovery</a></li>
<li><a href="#_environment_variables">Environment Variables</a></li>
<li><a href="#_summary_7">Summary</a></li>
</ul>
</li>
<li><a href="#_git_in_other_environments">Appendix A: Git in Other Environments</a>
<ul class="sectlevel2">
<li><a href="#_graphical_interfaces">Graphical Interfaces</a></li>
<li><a href="#_git_in_visual_studio">Git in Visual Studio</a></li>
<li><a href="#_git_in_eclipse">Git in Eclipse</a></li>
<li><a href="#_git_in_bash">Git in Bash</a></li>
<li><a href="#_git_in_zsh">Git in Zsh</a></li>
<li><a href="#_git_powershell">Git in Powershell</a></li>
<li><a href="#_summary_9">Summary</a></li>
</ul>
</li>
<li><a href="#_embedding_git_in_your_applications">Appendix B: Embedding Git in your Applications</a>
<ul class="sectlevel2">
<li><a href="#_command_line_git">Command-line Git</a></li>
<li><a href="#_libgit2">Libgit2</a></li>
<li><a href="#_jgit">JGit</a></li>
</ul>
</li>
<li><a href="#_git_commands">Appendix C: Git Commands</a>
<ul class="sectlevel2">
<li><a href="#_setup_and_config">Setup and Config</a></li>
<li><a href="#_getting_and_creating_projects">Getting and Creating Projects</a></li>
<li><a href="#_basic_snapshotting">Basic Snapshotting</a></li>
<li><a href="#_branching_and_merging">Branching and Merging</a></li>
<li><a href="#_sharing_and_updating_projects">Sharing and Updating Projects</a></li>
<li><a href="#_inspection_and_comparison">Inspection and Comparison</a></li>
<li><a href="#_debugging_2">Debugging</a></li>
<li><a href="#_patching">Patching</a></li>
<li><a href="#_email">Email</a></li>
<li><a href="#_external_systems">External Systems</a></li>
<li><a href="#_administration_2">Administration</a></li>
<li><a href="#_plumbing_commands">Plumbing Commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="_pro_git" class="sect0">Pro Git</h1>
<div class="sect1">
<h2 id="_preface_by_scott_chacon">Preface by Scott Chacon</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to the second edition of Pro Git.
The first edition was published over four years ago now.
Since then a lot has changed and yet many important things have not.
While most of the core commands and concepts are still valid today as the Git core team is pretty fantastic at keeping things backward compatible, there have been some significant additions and changes in the community surrounding Git.
The second edition of this book is meant to address those changes and update the book so it can be more helpful to the new user.</p>
</div>
<div class="paragraph">
<p>When I wrote the first edition, Git was still a relatively difficult to use and barely adopted tool for the harder core hacker.
It was starting to gain steam in certain communities, but had not reached anywhere near the ubiquity it has today.
Since then, nearly every open source community has adopted it.
Git has made incredible progress on Windows, in the explosion of graphical user interfaces to it for all platforms, in IDE support and in business use.
The Pro Git of four years ago knows about none of that.
One of the main aims of this new edition is to touch on all of those new frontiers in the Git community.</p>
</div>
<div class="paragraph">
<p>The Open Source community using Git has also exploded.
When I originally sat down to write the book nearly five years ago (it took me a while to get the first version out), I had just started working at a very little known company developing a Git hosting website called GitHub.
At the time of publishing there were maybe a few thousand people using the site and just four of us working on it.
As I write this introduction, GitHub is announcing our 10 millionth hosted project, with nearly 5 million registered developer accounts and over 230 employees.
Love it or hate it, GitHub has heavily changed large swaths of the Open Source community in a way that was barely conceivable when I sat down to write the first edition.</p>
</div>
<div class="paragraph">
<p>I wrote a small section in the original version of Pro Git about GitHub as an example of hosted Git which I was never very comfortable with.
I didn&#8217;t much like that I was writing what I felt was essentially a community resource and also talking about my company in it.
While I still don&#8217;t love that conflict of interests, the importance of GitHub in the Git community is unavoidable.
Instead of an example of Git hosting, I have decided to turn that part of the book into more deeply describing what GitHub is and how to effectively use it.
If you are going to learn how to use Git then knowing how to use GitHub will help you take part in a huge community, which is valuable no matter which Git host you decide to use for your own code.</p>
</div>
<div class="paragraph">
<p>The other large change in the time since the last publishing has been the development and rise of the HTTP protocol for Git network transactions. Most of the examples in the book have been changed to HTTP from SSH because it&#8217;s so much simpler.</p>
</div>
<div class="paragraph">
<p>It&#8217;s been amazing to watch Git grow over the past few years from a relatively obscure version control system to basically dominating commercial and open source version control. I&#8217;m happy that Pro Git has done so well and has also been able to be one of the few technical books on the market that is both quite successful and fully open source.</p>
</div>
<div class="paragraph">
<p>I hope you enjoy this updated edition of Pro Git.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preface_by_ben_straub">Preface by Ben Straub</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first edition of this book is what got me hooked on Git. This was my introduction to a style of making software that felt more natural than anything I had seen before. I had been a developer for several years by then, but this was the right turn that sent me down a much more interesting path than the one I was on.</p>
</div>
<div class="paragraph">
<p>Now, years later, I&#8217;m a contributer to a major Git implementation, I&#8217;ve worked for the largest Git hosting company, and I&#8217;ve traveled the world teaching people about Git. When Scott asked if I&#8217;d be interested in working on the second edition, I didn&#8217;t even have to think.</p>
</div>
<div class="paragraph">
<p>It&#8217;s been a great pleasure and privilege to work on this book. I hope it helps you as much as it did me.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dedications">Dedications</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>To my wife, Becky, without whom this adventure never would have begun. — Ben</em></p>
</div>
<div class="paragraph">
<p><em>This edition is dedicated to my girls.
To my wife Jessica who has supported me for all of these years and to my daughter Josephine,
who will support me when I&#8217;m too old to know what&#8217;s going on. — Scott</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">起步</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本章关于开始学习 Git。
我们从介绍有关版本控制工具的一些背景知识开始，然后讲解如何在您的系统运行 Git，最后是关于如何设置 Git 开始您的工作。
通过本章的学习，您应该了解为什么 Git 这么流行，为什么您应该使用 Git 以及您应该如何设置以便使用 Git。</p>
</div>
<div class="sect2">
<h3 id="_关于版本控制">关于版本控制</h3>
<div class="paragraph">
<p>
什么是“版本控制”？我为什么要关心它呢？
版本控制是一种记录一个或若干文件内容变化，以便将来查阅特定版本修订情况的系统。
在本书所展示的例子中，我们对保存着软件源代码的文件作版本控制，但实际上，您可以对任何类型的文件进行版本控制。</p>
</div>
<div class="paragraph">
<p>如果您是位图形或网页设计师，可能会需要保存某一幅图片或页面布局文件的所有修订版本（这或许是您非常渴望拥有的功能），采用版本控制系统（VCS）是个明智的选择。
有了它您就可以将某个文件回溯到之前的状态，甚至将整个项目都回退到过去某个时间点的状态，您可以比较文件的变化细节，查出最后是谁修改了哪个地方，从而找出导致怪异问题出现的原因，又是谁在何时报告了某个功能缺陷等等。
使用版本控制系统通常还意味着，就算您乱来一气把整个项目中的文件改的改删的删，您也照样可以轻松恢复到原先的样子。
但额外增加的工作量却微乎其微。</p>
</div>
<div class="sect3">
<h4 id="_本地版本控制系统">本地版本控制系统</h4>
<div class="paragraph">
<p>
许多人习惯用复制整个项目目录的方式来保存不同的版本，或许还会改名加上备份时间以示区别。
这么做唯一的好处就是简单，但是特别容易犯错。
有时候会混淆所在的工作目录，一不小心会写错文件或者覆盖意想外的文件。</p>
</div>
<div class="paragraph">
<p>为了解决这个问题，人们很久以前就开发了许多种本地版本控制系统，大多都是采用某种简单的数据库来记录文件的历次更新差异。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/local.png" alt="本地版本控制图解">
</div>
<div class="title">Figure 1. 本地版本控制.</div>
</div>
<div class="paragraph">
<p>其中最流行的一种叫做 RCS，现今许多计算机系统上都还看得到它的踪影。
甚至在流行的 Mac OS X 系统上安装了开发者工具包之后，也可以使用 <code>rcs</code> 命令。
它的工作原理是在硬盘上保存补丁集（补丁是指文件修订前后的变化）；通过应用所有的补丁，可以重新计算出各个版本的文件内容。</p>
</div>
</div>
<div class="sect3">
<h4 id="_集中化的版本控制系统">集中化的版本控制系统</h4>
<div class="paragraph">
<p>
接下来人们又遇到一个问题，如何让在不同系统上的开发者协同工作？
于是，集中化的版本控制系统（Centralized Version Control Systems，简称 CVCS）应运而生。
这类系统，诸如 CVS、Subversion 以及 Perforce 等，都有一个单一的集中管理的服务器，保存所有文件的修订版本，而协同工作的人们都通过客户端连到这台服务器，取出最新的文件或者提交更新。
多年以来，这已成为版本控制系统的标准做法。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/centralized.png" alt="集中化的版本控制图解">
</div>
<div class="title">Figure 2. 集中化的版本控制.</div>
</div>
<div class="paragraph">
<p>这种做法带来了许多好处，特别是相较于老式的本地 VCS 来说。
现在，每个人都可以在一定程度上看到项目中的其他人正在做些什么。
而管理员也可以轻松掌控每个开发者的权限，并且管理一个 CVCS 要远比在各个客户端上维护本地数据库来得轻松容易。</p>
</div>
<div class="paragraph">
<p>事分两面，有好有坏。
这么做最显而易见的缺点是中央服务器的单点故障。
如果宕机一小时，那么在这一小时内，谁都无法提交更新，也就无法协同工作。
如果中心数据库所在的磁盘发生损坏，又没有做恰当备份，毫无疑问您将丢失所有数据——包括项目的整个变更历史，只剩下人们在各自机器上保留的单独快照。
本地版本控制系统也存在类似问题，只要整个项目的历史记录被保存在单一位置，就有丢失所有历史更新记录的风险。</p>
</div>
</div>
<div class="sect3">
<h4 id="_分布式版本控制系统">分布式版本控制系统</h4>
<div class="paragraph">
<p>
于是分布式版本控制系统（Distributed Version Control System，简称 DVCS）面世了。
在这类系统中，像 Git、Mercurial、Bazaar 以及 Darcs 等，客户端并不只提取最新版本的文件快照，而是把代码仓库完整地镜像下来。
这么一来，任何一处协同工作用的服务器发生故障，事后都可以用任何一个镜像出来的本地仓库恢复。
因为每一次的提取操作，实际上都是一次对代码仓库的完整备份。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/distributed.png" alt="分布式版本控制图解">
</div>
<div class="title">Figure 3. 分布式版本控制.</div>
</div>
<div class="paragraph">
<p>更进一步，许多这类系统都可以指定和若干不同的远端代码仓库进行交互。籍此，您就可以在同一个项目中，分别和不同工作小组的人相互协作。
您可以根据需要设定不同的协作流程，比如层次模型式的工作流，而这在以前的集中式系统中是无法实现的。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_简史">Git 简史</h3>
<div class="paragraph">
<p>同生活中的许多伟大事物一样，Git 诞生于一个极富纷争大举创新的年代。</p>
</div>
<div class="paragraph">
<p>Linux 内核开源项目有着为数众广的参与者。
绝大多数的 Linux 内核维护工作都花在了提交补丁和保存归档的繁琐事务上（1991－2002年间）。
到 2002 年，整个项目组开始启用一个专有的分布式版本控制系统 BitKeeper 来管理和维护代码。</p>
</div>
<div class="paragraph">
<p>到了 2005 年，开发 BitKeeper 的商业公司同 Linux 内核开源社区的合作关系结束，他们收回了 Linux 内核社区免费使用 BitKeeper 的权力。
这就迫使 Linux 开源社区（特别是 Linux 的缔造者 Linux Torvalds）基于使用 BitKcheper 时的经验教训，开发出自己的版本系统。
他们对新的系统制订了若干目标：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>速度</p>
</li>
<li>
<p>简单的设计</p>
</li>
<li>
<p>对非线性开发模式的强力支持（允许成千上万个并行开发的分支）</p>
</li>
<li>
<p>完全分布式</p>
</li>
<li>
<p>有能力高效管理类似 Linux 内核一样的超大规模项目（速度和数据量）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>自诞生于 2005 年以来，Git 日臻成熟完善，在高度易用的同时，仍然保留着初期设定的目标。
它的速度飞快，极其适合管理大项目，有着令人难以置信的非线性分支管理系统（参见 <a href="#_git_branching">Git 分支</a>）。</p>
</div>
</div>
<div class="sect2">
<h3 id="_git_基础">Git 基础</h3>
<div class="paragraph">
<p>那么，简单地说，Git 究竟是怎样的一个系统呢？
请注意接下来的内容非常重要，若您理解了 Git 的思想和基本工作原理，用起来就会知其所以然，游刃有余。
在开始学习 Git 的时候，请努力分清您对其它版本管理系统的已有认识，如 Subversion 和 Perforce 等；这么做能帮助您使用工具时避免发生混淆。
Git 在保存和对待各种信息的时候与其它版本控制系统有很大差异，尽管操作起来的命令形式非常相近，理解这些差异将有助于防止您使用中的困惑。</p>
</div>
<div class="sect3">
<h4 id="_直接记录快照_而非差异比较">直接记录快照，而非差异比较</h4>
<div class="paragraph">
<p>Git 和其它版本控制系统（包括 Subversion 和近似工具）的主要差别在于 Git 对待数据的方法。
概念上来区分，其它大部分系统以文件变更列表的方式存储信息。
这类系统（CVS、Subversion、Perforce、Bazaar 等等）将它们保存的信息看作是一组基本文件和每个文件随时间逐步累积的差异。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/deltas.png" alt="存储每个文件与初始版本的差异。">
</div>
<div class="title">Figure 4. 存储每个文件与初始版本的差异.</div>
</div>
<div class="paragraph">
<p>Git 不按照以上方式对待或保存数据。
反之，Git 更像是把数据看作是对小型文件系统的一组快照。
每次您提交更新，或在 Git 中保存项目状态时，它主要对当时的全部文件制作一个快照并保存这个快照的索引。
为了高效，如果文件没有修改，Git 不再重新存储该文件，而是只保留一个链接指向之前存储的文件。
Git 对待数据更像是一个 <strong>快照流</strong>。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/snapshots.png" alt="Git 存储项目随时间改变的快照。">
</div>
<div class="title">Figure 5. 存储项目随时间改变的快照.</div>
</div>
<div class="paragraph">
<p>这是 Git 与几乎所有其它版本控制系统的重要区别。
因此 Git 重新考虑了以前每一代版本控制系统延续下来的诸多方面。
Git 更像是一个小型的文件系统，提供了许多以此为基础构建的超强工具，而不只是一个简单的 VCS。
稍后我们在<a href="#_git_branching">Git 分支</a>讨论 Git 分支管理时，将探究这种方式对待数据所能获得的益处。</p>
</div>
</div>
<div class="sect3">
<h4 id="_近乎所有操作都是本地执行">近乎所有操作都是本地执行</h4>
<div class="paragraph">
<p>在 Git 中的绝大多数操作都只需要访问本地文件和资源，一般不需要来自网络上其它计算机的信息。
如果您习惯于所有操作都有网络延时开销的集中式版本控制系统，Git 在这方面会让您感到速度之神赐给了 Git 超凡的能量。
因为您在本地磁盘上就有项目的完整历史，所以大部分操作看起来瞬间完成。</p>
</div>
<div class="paragraph">
<p>举个例子，要浏览项目的历史，Git 不需外连到服务器去获取历史，然后再显示出来——它只需直接从本地数据库中读取。
您能立即看到项目历史。
如果您想查看当前版本与一个月前的版本之间引入的修改，Git 会查找到一个月前的文件做一次本地的差异计算，而不是由远程服务器处理或从远程服务器拉回旧版本文件再来本地处理。</p>
</div>
<div class="paragraph">
<p>这也意味着您离线或者没有 VPN 时，几乎可以进行任何操作。
如您在飞机或火车上想做些工作，您能愉快地提交，直到有网络连接时再上传。
如您回家后 VPN 客户端不正常，您仍能工作。
使用其它系统，做到如此是不可能或很费力的。
比如，用 Perforce，您没有连接服务器时几乎不能做什么事；用 Subversion 和 CVS，您能修改文件，但不能向数据库提交修改（因为您的本地数据库离线了）。
这看起来不是大问题，但是您可能会惊喜地发现它带来的巨大的不同。</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_保证完整性">Git 保证完整性</h4>
<div class="paragraph">
<p>Git 中所有数据在存储前都计算校验和，然后以校验和来引用。
这意味着不可能在 Git 不知情时更改任何文件内容或目录内容。
这个功能建构在 Git 底层，是构成 Git 哲学不可或缺的部分。
若您在传送过程中丢失信息或损坏文件，Git 就能发现。</p>
</div>
<div class="paragraph">
<p>Git 用以计算校验和的机制叫做 SHA-1 散列（hash，哈希）。
这是一个由 40 个十六进制字符（0-9 和 a-f）组成字符串，基于 Git 中文件的内容或目录结构计算出来。
SHA-1 哈希看起来是这样：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>24b9da6552252987aa493b52f8696cd6d3b00373</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git 中使用这种哈希值的情况很多，您将经常看到这种哈希值。
实际上，Git 数据库中保存的信息都是以文件内容的哈希值来索引，而不是文件名。</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_一般只添加数据">Git 一般只添加数据</h4>
<div class="paragraph">
<p>您执行的 Git 操作，几乎只往 Git 数据库中增加数据。
很难让 Git 执行任何不可逆操作，或者让它以任何方式清除数据。
同别的 VCS 一样，未提交更新时有可能丢失或弄乱修改的内容；但是一旦您提交快照到 Git 中，就难以再丢失数据，特别是如果您定期的推送数据库到其它仓库的话。</p>
</div>
<div class="paragraph">
<p>这使得我们使用 Git 成为一个安心愉悦的过程，因为我们深知可以尽情做各种尝试，而没有把事情弄糟的危险。
更深度探讨 Git 如何保存数据及恢复丢失数据的话题，请参考<a href="#_undoing">Undoing Things</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_三种状态">三种状态</h4>
<div class="paragraph">
<p>好，请注意。
如果您希望后面的学习更顺利，记住下面这些关于 Git 的概念。
Git 有三种状态，您的文件可能处于其中之一：已提交（committed）、已修改（modified）和已暂存（staged）。
已提交表示数据已经安全的保存在本地数据库中。
已修改表示修改了文件，但还没保存到数据库中。
已暂存表示对一个已修改文件的当前版本做了标记，使之包含在下次提交的快照中。</p>
</div>
<div class="paragraph">
<p>由此引入 Git 项目的三个工作区域的概念：Git 仓库、工作目录以及暂存区域。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/areas.png" alt="工作目录、暂存区域以及 Git 仓库。">
</div>
<div class="title">Figure 6. 工作目录、暂存区域以及 Git 仓库.</div>
</div>
<div class="paragraph">
<p>Git 仓库目录是 Git 用来保存项目的元数据和对象数据库的地方。
这是 Git 中最重要的部分，从其它计算机克隆仓库时，拷贝的就是这里的数据。</p>
</div>
<div class="paragraph">
<p>工作目录是对项目的某个版本独立提取出来的内容。
这些从 Git 仓库的压缩数据库中提取出来的文件，放在磁盘上供您使用或修改。</p>
</div>
<div class="paragraph">
<p>暂存区域是一个文件，保存了下次将提交的文件列表信息，一般在 Git 仓库目录中。
有时候也被称作`&#8216;索引&#8217;'，不过一般说法还是叫暂存区域。</p>
</div>
<div class="paragraph">
<p>基本的 Git 工作流程如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在工作目录中修改文件。</p>
</li>
<li>
<p>暂存文件，将文件的快照放入暂存区域。</p>
</li>
<li>
<p>提交更新，找到暂存区域的文件，将快照永久性存储到 Git 仓库目录。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>如果 Git 目录中保存着的特定版本文件，就属于已提交状态。
如果作了修改并已放入暂存区域，就属于已暂存状态。
如果自上次取出后，作了修改但还没有放到暂存区域，就是已修改状态。
在<a href="#_git_basics_chapter">Git 基础</a>一章，您会进一步了解这些状态的细节，并学会如何根据文件状态实施后续操作，以及怎样跳过暂存直接提交。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_命令行">命令行</h3>
<div class="paragraph">
<p>Git 有多种使用方式。
您可以使用原生的命令行模式，也可以使用 GUI 模式，这些 GUI 软件也能提供多种功能。
在本书中，我们将使用命令行模式。
这是因为首先，只有在命令行模式下您才能执行 Git 的*所有*命令，而大多数的 GUI 软件只实现了 Git 所有功能的一个子集以降低操作难度。
如果您学会了在命令行下如何操作，那么您在操作 GUI 软件时应该也不会遇到什么困难，但是，反之则不成立。
此外，由于每个人的想法与侧重点不同，不同的人常常会安装不同的 GUI 软件，但_所有_人一定会有命令行工具。</p>
</div>
<div class="paragraph">
<p>假如您是 Mac 用户，我们希望您懂得如何使用终端（Terminal）；假如您是 Windows 用户，我们希望您懂得如何使用命令窗口（Command Prompt）或 PowerShell。
如果您尚未掌握以上技能，我们建议您先停下来快速学习一下，本书中的讲述和举例将用到这些技能。</p>
</div>
</div>
<div class="sect2">
<h3 id="_安装_git">安装 Git</h3>
<div class="paragraph">
<p>在您开始使用 Git 前，需要将它安装在您的计算机上。
即便已经安装，最好将它升级到最新的版本。
你可以通过软件包或者其它安装程序来安装，或者下载源码编译安装。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>本书写作时使用的 Git 版本为 <strong>2.0.0</strong>。尽管我们使用的大部分命令即使在很古老的 Git 版本上还可以使用，仍有少部分命令不好用或者在旧版本中的行为有差异。因为 Git 在保持向后兼容方便表现很好，这些命令在2.0 之后的版本应该有效。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_在_linux_上安装">在 Linux 上安装</h4>
<div class="paragraph">
<p>
如果您想在 Linux 上用二进制安装程序来安装 Git，您可以使用发行版包含的基础包管理工具来安装。
例如使用 Fedora，您可以使用 yum：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ yum install git</pre>
</div>
</div>
<div class="paragraph">
<p>如果您在基于 Debian 的发行版上，尝试用 apt-get：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ apt-get install git</pre>
</div>
</div>
<div class="paragraph">
<p>要了解更多选择，在 Git 官方网站上有不同 Unix 风格的系统上安装的说明，网址为 <a href="http://git-scm.com/download/linux" class="bare">http://git-scm.com/download/linux</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_在_mac_上安装">在 Mac 上安装</h4>
<div class="paragraph">
<p>
在 Mac 上安装 Git 有多种方式。
最简单的方法是安装 Xcode Command Line Tools。
在 Mavericks （10.9） 或更高版本的系统中，在 Terminal 里尝试第一次运行 <em>git</em> 命令即可。
如果没有安装过命令行开发者工具，将会提示您安装。</p>
</div>
<div class="paragraph">
<p>如果您想安装更新的版本，可以使用二进制安装程序。
官方维护的 OSX Git 安装程序 可以在 Git 官方网站下载，网址为 <a href="http://git-scm.com/download/mac" class="bare">http://git-scm.com/download/mac</a>。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-osx-installer.png" alt="Git OS X 安装程序。">
</div>
<div class="title">Figure 7. Git OS X 安装程序.</div>
</div>
<div class="paragraph">
<p>您也可以将它作为 GitHub for Mac 的一部分来安装。
他们的 图形化 Git 工具有一个安装命令行工具的选项。
您可以在 GitHub for Mac 的网站上下载此工具，网址为 <a href="http://mac.github.com" class="bare">http://mac.github.com</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_在_windows_上安装">在 Windows 上安装</h4>
<div class="paragraph">
<p>在 Windows 上安装 Git 也有很多安装方法。
官方版本可以在 Git 官网下载。
打开 <a href="http://git-scm.com/download/win" class="bare">http://git-scm.com/download/win</a>，下载会自动开始。
要注意这是一个名为 Git for Windows的项目（也叫做 msysGit），和 Git 是分别独立的项目；更多信息请访问 <a href="http://msysgit.github.io/" class="bare">http://msysgit.github.io/</a>。</p>
</div>
<div class="paragraph">
<p>另一个简单的方法是安装 GitHub for Windows。
该安装程序包含图形化和命令行版本的 Git。
它也能支持 Powershell，提供稳定的凭证缓存和健全的 CRLF 设置。
稍后我们会对这方面有更多了解，现在只要一句话就够了，这些都是你所需要的。
你可以在 GitHub for Windows 网站下载，网址为 <a href="http://windows.github.com" class="bare">http://windows.github.com</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_从源代码安装">从源代码安装</h4>
<div class="paragraph">
<p>有人觉得从源码安装 Git 更实用，因为您能得到最新的版本。
二进制安装程序倾向于有一些滞后，当然近几年 Git 已经成熟，这个差异不再显著。</p>
</div>
<div class="paragraph">
<p>如果您想从源码安装 Git，需要安装 Git 依赖的库：curl、zlib、openssl、expat，还有libiconv。
如果您的系统上有 yum （如 Fedora）或者 apt-get（如基于 Debian 的系统），可以使用一下命令之一来安装所有的依赖：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ yum install curl-devel expat-devel gettext-devel \
  openssl-devel zlib-devel</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ apt-get install libcurl4-gnutls-dev libexpat1-dev gettext \
  libz-dev libssl-dev</pre>
</div>
</div>
<div class="paragraph">
<p>当您安装好所有的必要依赖，您可以继续从几个地方来取得最新发布版本的 tar 包。
您可以从 Kernel.org 网站获取，网址为 <a href="https://www.kernel.org/pub/software/scm/git" class="bare">https://www.kernel.org/pub/software/scm/git</a>，或从 GitHub 网站上的镜像来获得，网址为 <a href="https://github.com/git/git/releases" class="bare">https://github.com/git/git/releases</a>。</p>
</div>
<div class="paragraph">
<p>通常在 GitHub 上的是最新版本，但 kernel.org 上包含有文件下载签名，如果你想验证下载正确性的话。</p>
</div>
<div class="paragraph">
<p>接着，编译并安装：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ tar -zxf git-1.9.1.tar.gz
$ cd git-1.9.1
$ make configure
$ ./configure --prefix=/usr
$ make all doc info
$ sudo make install install-doc install-html install-info</pre>
</div>
</div>
<div class="paragraph">
<p>完成后，你可以使用 Git 来获取 Git 的升级：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git clone git://git.kernel.org/pub/scm/git/git.git</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_first_time">First-Time Git Setup</h3>
<div class="paragraph">
<p>Now that you have Git on your system, you&#8217;ll want to do a few things to customize your Git environment.
You should have to do these things only once on any given computer; they&#8217;ll stick around between upgrades.
You can also change them at any time by running through the commands again.</p>
</div>
<div class="paragraph">
<p>Git comes with a tool called <code>git config</code> that lets you get and set configuration variables that control all aspects of how Git looks and operates.
These variables can be stored in three different places:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>/etc/gitconfig</code> file: Contains values for every user on the system and all their repositories.
If you pass the option <code>--system</code> to <code>git config</code>, it reads and writes from this file specifically.</p>
</li>
<li>
<p><code>~/.gitconfig</code> or <code>~/.config/git/config</code> file: Specific to your user.
You can make Git read and write to this file specifically by passing the <code>--global</code> option.</p>
</li>
<li>
<p><code>config</code> file in the Git directory (that is, <code>.git/config</code>) of whatever repository you&#8217;re currently using: Specific to that single repository.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each level overrides values in the previous level, so values in <code>.git/config</code> trump those in <code>/etc/gitconfig</code>.</p>
</div>
<div class="paragraph">
<p>On Windows systems, Git looks for the <code>.gitconfig</code> file in the <code>$HOME</code> directory (<code>C:\Users\$USER</code> for most people).
It also still looks for <code>/etc/gitconfig</code>, although it&#8217;s relative to the MSys root, which is wherever you decide to install Git on your Windows system when you run the installer.</p>
</div>
<div class="sect3">
<h4 id="_your_identity">Your Identity</h4>
<div class="paragraph">
<p>The first thing you should do when you install Git is to set your user name and e-mail address.
This is important because every Git commit uses this information, and it&#8217;s immutably baked into the commits you start creating:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global user.name "John Doe"
$ git config --global user.email johndoe@example.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, you need to do this only once if you pass the <code>--global</code> option, because then Git will always use that information for anything you do on that system.
If you want to override this with a different name or e-mail address for specific projects, you can run the command without the <code>--global</code> option when you&#8217;re in that project.</p>
</div>
<div class="paragraph">
<p>Many of the GUI tools will help you do this when you first run them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_your_editor">Your Editor</h4>
<div class="paragraph">
<p>Now that your identity is set up, you can configure the default text editor that will be used when Git needs you to type in a message.
If not configured, Git uses your system&#8217;s default editor, which is generally Vim.
If you want to use a different text editor, such as Emacs, you can do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.editor emacs</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vim and Emacs are popular text editors often used by developers on Unix based systems like Linux and Mac. If you are not familiar with either of these editors or are on a Windows system, you may need to search for instructions for how to set up your favorite editor with Git.
If you don&#8217;t set an editor like this and you don&#8217;t know what Vim or Emacs are, you will likely get into a really confusing state when they are launched.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_checking_your_settings">Checking Your Settings</h4>
<div class="paragraph">
<p>If you want to check your settings, you can use the <code>git config --list</code> command to list all the settings Git can find at that point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --list
user.name=John Doe
user.email=johndoe@example.com
color.status=auto
color.branch=auto
color.interactive=auto
color.diff=auto
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may see keys more than once, because Git reads the same key from different files (<code>/etc/gitconfig</code> and <code>~/.gitconfig</code>, for example).
In this case, Git uses the last value for each unique key it sees.</p>
</div>
<div class="paragraph">
<p>You can also check what Git thinks a specific key&#8217;s value is by typing <code>git config &lt;key&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config user.name
John Doe</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_help">获取帮助</h3>
<div class="paragraph">
<p>若您使用 Git 时需要获取帮助，有三种方法可以找到 Git 命令的使用手册：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git help &lt;verb&gt;
$ git &lt;verb&gt; --help
$ man git-&lt;verb&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>例如，要想获得 config 命令的手册，执行</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git help config</code></pre>
</div>
</div>
<div class="paragraph">
<p>这些命令很棒，因为你随时随地可以使用而无需联网。
如果您觉得手册或者本书的内容还不够用，您可以尝试在 Freenode IRC 服务器（ irc.freenode.net ）的 <code>#git</code> 或 <code>#github</code> 频道寻求帮助。
这些频道经常有上百人在线，他们都精通 Git 并且乐于助人。</p>
</div>
</div>
<div class="sect2">
<h3 id="_总结">总结</h3>
<div class="paragraph">
<p>您应该已经对 Git 是什么、Git 与您可能正在使用的集中式版本控制系统有何区别等问题有了基本的了解。
现在，在您的个人系统中应该也有了一份能够工作的 Git 版本。
是时候开始学习有关 Git 的基础知识了。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_basics_chapter">Git 基础</h2>
<div class="sectionbody">
<div class="paragraph">
<p>假如您只能阅读一章来学习 Git，本章就是您的不二选择。
本章内容涵盖您在使用 Git 完成各种工作中将要使用的各种基本命令。
在学习完本章之后，您应该能够配置并初始化一个仓库（repository）、开始或停止跟踪（track）文件、暂存（stage）或提交（commit)更改。
本章也将向您演示如何配置 Git 来忽略指定的文件和文件模式、如何迅速而简单地撤销错误操作、如何浏览您的项目的历史版本以及不同提交（commits）间的差异、如何向您的远程仓库推送（push）以及如何从您的远程仓库拉取（pull）文件。</p>
</div>
<div class="sect2">
<h3 id="_getting_a_repo">获取 Git 仓库</h3>
<div class="paragraph">
<p>有两种取得 Git 项目仓库的方法。
第一种是在现有项目或目录下导入所有文件到 Git 中；
第二种是从一个服务器克隆一个现有的 Git 仓库。</p>
</div>
<div class="sect3">
<h4 id="_在现有目录中初始化仓库">在现有目录中初始化仓库</h4>
<div class="paragraph">
<p>如果您打算使用 Git 来对现有的项目进行管理，您只需要进入该项目目录并输入：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git init</code></pre>
</div>
</div>
<div class="paragraph">
<p>该命令将创建一个名为 <code>.git</code> 的子目录，这个子目录含有您初始化的 Git 仓库中所有的必须文件，这些文件是 Git 仓库的骨干。
但是，在这个时候，我们仅仅是做了一个初始化的操作，您的项目里的文件还没有被跟踪。
(参见 <a href="#_git_internals">Git Internals</a> 来了解更多关于到底 <code>.git</code> 文件夹中包含了哪些文件的信息。)</p>
</div>
<div class="paragraph">
<p>如果您是在一个已经存在文件的文件夹（而不是空文件夹）中初始化 Git 仓库来进行版本控制的话，您应该开始跟踪这些文件并提交。
您可通过 <code>git add</code> 命令来实现对指定文件的跟踪，然后执行 <code>git commit</code> 提交：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add *.c
$ git add LICENSE
$ git commit -m 'initial project version'</code></pre>
</div>
</div>
<div class="paragraph">
<p>稍后我们再逐一解释每一条指令的意思。
现在，您已经得到了一个实际维护（或者说是跟踪）着若干个文件的 Git 仓库。</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_cloning">克隆现有的仓库</h4>
<div class="paragraph">
<p>如果您想获得一份已经存在了的 Git 仓库的拷贝，比如说，您想为某个开源项目贡献自己的一份力，这时就要用到 <code>git clone</code> 命令。
如果您对其它的 VCS 系统（比如说Subversion）很熟悉，请留心一下您所使用的命令是"clone"而不是"checkout"。
这是 Git 区别于其它版本控制系统的一个重要特性，Git 克隆的是该 Git 仓库服务器上的几乎所有数据，而不是仅仅复制完成您的工作所需要文件。
当您执行 <code>git clone</code> 命令的时候，默认配置下远程 Git 仓库中的每一个文件的每一个版本都将被拉取下来。
事实上，如果您的服务器的磁盘坏掉了，您通常可以使用任何一个克隆下来的用户端来重建服务器上的仓库（虽然可能会丢失某些服务器端的挂钩设置，但是所有版本的数据仍在，详见 <a href="#_git_on_the_server">Getting Git on a Server</a> ）。</p>
</div>
<div class="paragraph">
<p>克隆仓库的命令格式是 <code>git clone [url]</code> 。
比如，要克隆 Git 的可链接库 libgit2，可以用下面的命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://github.com/libgit2/libgit2</code></pre>
</div>
</div>
<div class="paragraph">
<p>这会在当前目录下创建一个名为 ``libgit2`` 的目录，并在这个目录下初始化一个 <code>.git</code> 文件夹，从远程仓库拉取下所有数据放入 <code>.git</code> 文件夹，然后从中读取最新版本的文件的拷贝。
如果您进入到这个新建的 <code>libgit2</code> 文件夹，您会发现所有的项目文件已经在里面了，准备就绪等待后续的开发和使用。
如果您想在克隆远程仓库的时候，自定义本地仓库的名字，您可以使用如下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://github.com/libgit2/libgit2 mylibgit</code></pre>
</div>
</div>
<div class="paragraph">
<p>这将执行与上一个命令相同的操作，不过在本地创建的仓库名字变为 <code>mylibgit</code>。</p>
</div>
<div class="paragraph">
<p>Git 支持多种数据传输协议。
上面的例子使用的是 <code>https://</code> 协议，不过您也可以使用 <code>git://</code> 协议或者使用 SSH 传输协议，比如 <code>user@server:path/to/repo.git</code> 。
<a href="#_git_on_the_server">Getting Git on a Server</a>将会介绍所有这些协议在服务器端如何配置使用，以及各种方式之间的利弊。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_记录每次更新到仓库">记录每次更新到仓库</h3>
<div class="paragraph">
<p>现在我们手上有了一个真实项目的 Git 仓库，并从这个仓库中取出了所有文件的工作拷贝。
接下来，对这些文件做些修改，在完成了一个阶段的目标之后，提交本次更新到仓库。</p>
</div>
<div class="paragraph">
<p>请记住，您工作目录下的每一个文件都不外乎这两种状态：已跟踪或未跟踪。
已跟踪的文件是指那些被纳入了版本控制的文件，在上一次快照中有它们的记录，在工作一段时间后，它们的状态可能处于未修改，已修改或已放入暂存区。
工作目录中除已跟踪文件以外的所有其它文件都属于未跟踪文件，它们既不存在于上次快照的记录中，也没有放入暂存区。
初次克隆某个仓库的时候，工作目录中的所有文件都属于已跟踪文件，并处于未修改状态。</p>
</div>
<div class="paragraph">
<p>编辑过某些文件之后，由于自上次提交后你对它们做了修改，Git 将它们标记为已修改文件。
我们逐步将这些修改过的文件放入暂存区，然后提交所有暂存了的修改，如此反复。所以使用 Git 时文件的生命周期如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/lifecycle.png" alt="Git 下文件生命周期图。">
</div>
<div class="title">Figure 8. 文件的状态变化周期</div>
</div>
<div class="sect3">
<h4 id="_checking_status">检查当前文件状态</h4>
<div class="paragraph">
<p>要查看哪些文件处于什么状态，可以用 <code>git status</code> 命令。
如果在克隆仓库后立即使用此命令，会看到类似这样的输出：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
nothing to commit, working directory clean</code></pre>
</div>
</div>
<div class="paragraph">
<p>这说明您现在的工作目录相当干净。换句话说，所有已跟踪文件在上次提交后都未被更改过。
此外，上面的信息还表明，当前目录下没有出现任何处于未跟踪状态的新文件，否则 Git 会在这里列出来。
最后，该命令还显示了当前所在分支，并告诉您这个分支同远程服务器上对应的分支没有偏离。
现在，分支名是 ``master``,这是默认的分支名。
我们在 <a href="#_git_branching">Git 分支</a>  会详细讨论分支和引用。</p>
</div>
<div class="paragraph">
<p>现在，让我们在工程下创建一个新的 README 文件。
如果之前并不存在这个文件，使用 <code>git status</code> 命令，您将看到一个新的未跟踪文件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'My Project' &gt; README
$ git status
On branch master
Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

    README

nothing added to commit but untracked files present (use "git add" to track)</code></pre>
</div>
</div>
<div class="paragraph">
<p>在状态报告中可以看到新建的 README 文件出现在 <code>Untracked files</code> 下面。
未跟踪的文件意味着 Git 在之前的快照（提交）中没有这些文件；Git 不会自动将之纳入跟踪范围，除非您明明白白地告诉它“我需要跟踪该文件”，
这样的处理让您不必担心将生成的二进制文件或其它不想被跟踪的文件包含进来。
不过现在的例子中，我们确实想要跟踪管理 README 这个文件。</p>
</div>
</div>
<div class="sect3">
<h4 id="_tracking_files">跟踪新文件</h4>
<div class="paragraph">
<p>使用命令 <code>git add</code> 开始跟踪一个文件。
所以，要跟踪 README 文件，运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add README</code></pre>
</div>
</div>
<div class="paragraph">
<p>此时再运行 <code>git status</code> 命令，会看到 README 文件已被跟踪，并处于暂存状态：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    new file:   README</code></pre>
</div>
</div>
<div class="paragraph">
<p>只要在 <code>Changes to be committed</code> 这行下面的，就说明是已暂存状态。
如果此时提交，那么该文件此时此刻的版本将被留存在历史记录中。
您可能会想起之前我们使用 <code>git init</code> 后就运行了 <code>git add (files)</code> 命令，开始跟踪当前目录下的文件。
<code>git add</code> 命令使用文件或目录的路径作为参数；如果参数是目录的路径，该命令将递归地跟踪该目录下的所有文件。</p>
</div>
</div>
<div class="sect3">
<h4 id="_暂存已修改文件">暂存已修改文件</h4>
<div class="paragraph">
<p>现在我们来修改一个已被跟踪的文件。
如果您修改了一个名为 <code>CONTRIBUTING.md</code> 的已被跟踪的文件，然后运行 <code>git status</code> 命令，会看到下面内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    new file:   README

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>文件 <code>CONTRIBUTING.md</code> 出现在 <code>Changes not staged for commit</code> 这行下面，说明已跟踪文件的内容发生了变化，但还没有放到暂存区。
要暂存这次更新，需要运行 <code>git add</code> 命令。这是个多功能命令：可以用它开始跟踪新文件，或者把已跟踪的文件放到暂存区，还能用于合并时把有冲突的文件标记为已解决状态等。将这个命令理解为“添加内容到下一次提交中”而不是“将一个文件添加到工程中”要更加合适。
现在让我们运行 <code>git add</code> 将"CONTRIBUTING.md"放到暂存区，然后再看看 <code>git status</code> 的输出：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add CONTRIBUTING.md
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    new file:   README
    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在两个文件都已暂存，下次提交时就会一并记录到仓库。
假设此时，您想要在 <code>CONTRIBUTING.md</code> 里再加条注释，
重新编辑存盘后，准备好提交。
不过且慢，再运行 <code>git status</code> 看看：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim CONTRIBUTING.md
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    new file:   README
    modified:   CONTRIBUTING.md

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>怎么回事？
现在 <code>CONTRIBUTING.md</code> 文件同时出现在暂存区和非暂存区。
这怎么可能呢？
好吧，实际上 Git 只不过暂存了您运行 <code>git add</code> 命令时的版本，
如果您现在提交，<code>CONTRIBUTING.md</code> 的版本是您最后一次运行 <code>git add</code> 命令时的那个版本，而不是您运行 <code>git commit</code> 时，在工作目录中的当前版本。
所以，运行了 <code>git add</code> 之后又作了修订的文件，需要重新运行 <code>git add</code> 把最新版本重新暂存起来：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add CONTRIBUTING.md
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    new file:   README
    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_状态简览">状态简览</h4>
<div class="paragraph">
<p><code>git status</code> 命令的输出十分详细，但其用语有些繁琐。如果您使用 <code>git status -s</code> 命令或 <code>git status --short</code>        命令，您将得到一种更为紧凑的格式输出。运行 <code>git status -s</code> ，状态报告输出如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status -s
 M README
MM Rakefile
A  lib/git.rb
M  lib/simplegit.rb
?? LICENSE.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>新添加的未跟踪文件前面有 <code>??</code> 标记，新添加到暂存区中的文件前面有 <code>A</code> 标记。修改过的文件前面有 <code>M</code> 标记，您可能注意到了 <code>M</code> 用两个可以出现的位置，出现在右边的 <code>M</code> 表示该文件被修改了但是还没放入暂存区，出现在靠左边的 <code>M</code> 表示该文件被修改了并放入了暂存区。例如，上面的状态报告显示： <code>README</code> 文件在工作区被修改了但是还没有将修改后的文件放入暂存区,<code>lib/simplegit.rb</code> 文件被修改了并将修改后的文件放入了暂存区，而 <code>Rakefile</code> 在工作区被修改并提交到暂存区后又在工作区中被修改了，所以在暂存区和工作区都有该文件被修改了的记录。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ignoring">忽略文件</h4>
<div class="paragraph">
<p>一般我们总会有些文件无需纳入 Git 的管理，也不希望它们总出现在未跟踪文件列表。
通常都是些自动生成的文件，比如日志文件，或者编译过程中创建的临时文件等。
在这种情况下，我们可以创建一个名为 <code>.gitignore</code> 的文件，列出要忽略的文件模式。
来看一个实际的例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .gitignore
*.[oa]
*~</code></pre>
</div>
</div>
<div class="paragraph">
<p>第一行告诉 Git 忽略所有以 <code>.o</code> 或 <code>.a</code> 结尾的文件。一般这类对象文件和存档文件都是编译过程中出现的。
第二行告诉 Git 忽略所有以波浪符（~）结尾的文件，许多文本编辑软件（比如 Emacs）都用这样的文件名保存副本。
此外，您可能还需要忽略 log，tmp 或者 pid 目录，以及自动生成的文档等等。
要养成一开始就设置好 .gitignore 文件的习惯，以免将来误提交这类无用的文件。</p>
</div>
<div class="paragraph">
<p>文件 <code>.gitignore</code> 的格式规范如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>所有空行或者以 <code>＃</code> 开头的行都会被 Git 忽略。</p>
</li>
<li>
<p>可以使用标准的 glob 模式匹配。</p>
</li>
<li>
<p>匹配模式以（<code>/</code>）结尾说明要忽略的是目录。</p>
</li>
<li>
<p>要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号（<code>!</code>）取反。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所谓的 glob 模式是指 shell 所使用的简化了的正则表达式。
星号（<code>*</code>）匹配零个或多个任意字符；<code>[abc]</code> 匹配任何一个列在方括号中的字符（这个例子要么匹配一个 a，要么匹配一个 b，要么匹配一个 c）；问号（<code>?</code>）只匹配一个任意字符；如果在方括号中使用短划线分隔两个字符，表示所有在这两个字符范围内的都可以匹配（比如 <code>[0-9]</code> 表示匹配所有 0 到 9 的数字）。
使用两个星号（<code>*</code>) 表示匹配任意中间目录，比如`a/**/z` 可以匹配 <code>a/z</code>, <code>a/b/z</code> 或 `a/b/c/z`等。</p>
</div>
<div class="paragraph">
<p>我们再看一个 .gitignore 文件的例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># no .a files
*.a

# but do track lib.a, even though you're ignoring .a files above
!lib.a

# only ignore the root TODO file, not subdir/TODO
/TODO

# ignore all files in the build/ directory
build/

# ignore doc/notes.txt, but not doc/server/arch.txt
doc/*.txt

# ignore all .txt files in the doc/ directory
doc/**/*.txt</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>GitHub 有一个十分详细的针对数十种工程及语言的 <code>.gitignore</code> 文件列表，详见：https://github.com/github/gitignore[]</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_git_diff_staged">查看已暂存和未暂存的修改</h4>
<div class="paragraph">
<p>如果 <code>git status</code> 命令的输出对于您来说过于模糊，您想知道具体修改了什么地方，可以用 <code>git diff</code> 命令。
稍后我们会详细介绍 <code>git diff</code>，您可能通常会用它来回答这两个问题：当前做的哪些更新还没有暂存？
有哪些更新已经暂存起来准备好了下次提交？
尽管 <code>git status</code> 已经通过在相应栏下列出文件名的方式回答了这个问题，<code>git diff</code> 将通过文件补丁的格式显示具体哪些行发生了改变。</p>
</div>
<div class="paragraph">
<p>假如再次修改 README 文件后暂存，然后编辑 <code>CONTRIBUTING.md</code> 文件后先不暂存，
运行 <code>status</code> 命令将会看到：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    new file:   README

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>要查看尚未暂存的文件更新了哪些部分，不加参数直接输入 <code>git diff</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index 8ebb991..643e24f 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -65,7 +65,8 @@ branch directly, things can get messy.
 Please include a nice description of your changes when you submit your PR;
 if we have to read the whole diff to figure out why you're contributing
 in the first place, you're less likely to get feedback and have your change
-merged in.
+merged in. Also, split your changes into comprehensive chunks if you patch is
+longer than a dozen lines.

 If you are starting to work on a particular area, feel free to submit a PR
 that highlights your work in progress (and note in the PR title that it's</code></pre>
</div>
</div>
<div class="paragraph">
<p>此命令比较的是工作目录中当前文件和暂存区域快照之间的差异，
也就是修改之后还没有暂存起来的变化内容。</p>
</div>
<div class="paragraph">
<p>若要查看已暂存的将要添加到下次提交里的内容，可以用 <code>git diff --cached</code> 命令。（Git 1.6.1 及更高版本还允许使用 <code>git diff --staged</code>，效果是相同的，但更好记些。）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --staged
diff --git a/README b/README
new file mode 100644
index 0000000..03902a1
--- /dev/null
+++ b/README
@@ -0,0 +1 @@
+My Project</code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意，git diff 本身只显示尚未暂存的改动，而不是自上次提交以来所做的所有改动。
所以有时候您一下子暂存了所有更新过的文件后，运行 <code>git diff</code> 后却什么也没有，就是这个原因。</p>
</div>
<div class="paragraph">
<p>像之前说的，暂存 <code>CONTRIBUTING.md</code> 后再编辑，运行 <code>git status</code> 会看到暂存前后的两个版本,如果我们的环境（终端输出）看起来如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add CONTRIBUTING.md
$ echo 'test line' &gt;&gt; CONTRIBUTING.md
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    modified:   CONTRIBUTING.md

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在运行 <code>git diff</code> 看暂存前后的变化：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index 643e24f..87f08c8 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -119,3 +119,4 @@ at the
 ## Starter Projects

 See our [projects list](https://github.com/libgit2/libgit2/blob/development/PROJECTS.md).
+# test line</code></pre>
</div>
</div>
<div class="paragraph">
<p>然后用 <code>git diff --cached</code> 查看已经暂存起来的变化：（--staged 和 --cached 是同义词）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --cached
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index 8ebb991..643e24f 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -65,7 +65,8 @@ branch directly, things can get messy.
 Please include a nice description of your changes when you submit your PR;
 if we have to read the whole diff to figure out why you're contributing
 in the first place, you're less likely to get feedback and have your change
-merged in.
+merged in. Also, split your changes into comprehensive chunks if you patch is
+longer than a dozen lines.

 If you are starting to work on a particular area, feel free to submit a PR
 that highlights your work in progress (and note in the PR title that it's</code></pre>
</div>
</div>
<div id="_git_difftool" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Git Diff 的插件版本</div>
<div class="paragraph">
<p>在本书中，我们使用 <code>git diff</code> 来分析文件差异。但是，如果您喜欢通过图形化的方式或其它格式输出方式的话，可以使用 <code>git difftool</code> 命令来用 Araxis ，emerge 或 vimdiff 等软件输出 diff 分析结果。使用 <code>git difftool --tool-help</code> 命令来看您的系统支持哪些 Git Diff 插件。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_committing_changes">提交更新</h4>
<div class="paragraph">
<p>现在的暂存区域已经准备妥当可以提交了。
在此之前，请一定要确认还有什么修改过的或新建的文件还没有 <code>git add</code> 过，否则提交的时候不会记录这些还没暂存起来的变化。
这些修改过的文件只保留在本地磁盘。
所以，每次准备提交前，先用 <code>git status</code> 看下，是不是都已暂存起来了，
然后再运行提交命令 <code>git commit</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>这种方式会启动文本编辑器以便输入本次提交的说明。
(默认会启用 shell 的环境变量 <code>$EDITOR</code> 所指定的软件，一般都是 vim 或 emacs。当然也可以按照 <a href="#_getting_started">起步</a> 介绍的方式，使用 <code>git config --global core.editor</code> 命令设定您喜欢的编辑软件。）</p>
</div>
<div class="paragraph">
<p>编辑器会显示类似下面的文本信息（本例选用 Vim 的屏显方式展示）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># Please enter the commit message for your changes. Lines starting
# with '#' will be ignored, and an empty message aborts the commit.
# On branch master
# Changes to be committed:
#	new file:   README
#	modified:   CONTRIBUTING.md
#
~
~
~
".git/COMMIT_EDITMSG" 9L, 283C</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看到，默认的提交消息包含最后一次运行 <code>git status</code> 的输出，放在注释行里，另外开头还有一空行，供您输入提交说明。
您完全可以去掉这些注释行，不过留着也没关系，多少能帮您回想起这次更新的内容有哪些。
(如果想要更详细的对修改了哪些内容的提示，可以用 <code>-v</code> 选项，这会将你所做的改变的 diff 输出放到编辑器中从而使你知道本次提交具体做了哪些修改。）
退出编辑器时，Git 会丢掉注释行，用您输入提交附带信息生成一次提交。</p>
</div>
<div class="paragraph">
<p>另外，您也可以在 <code>commit</code> 命令后添加 <code>-m</code> 选项，将提交信息与命令放在同一行，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -m "Story 182: Fix benchmarks for speed"
[master 463dc4f] Story 182: Fix benchmarks for speed
 2 files changed, 2 insertions(+)
 create mode 100644 README</code></pre>
</div>
</div>
<div class="paragraph">
<p>好，现在您已经创建了第一个提交！
可以看到，提交后它会告诉您，当前是在哪个分支（<code>master</code>）提交的，本次提交的完整 SHA-1 校验和是什么（<code>463dc4f</code>），以及在本次提交中，有多少文件修订过，多少行添改和删改过。</p>
</div>
<div class="paragraph">
<p>请记住，提交时记录的是放在暂存区域的快照。
任何还未暂存的仍然保持已修改状态，可以在下次提交时纳入版本管理。
每一次运行提交操作，都是对您项目作一次快照，以后可以回到这个状态，或者进行比较。</p>
</div>
</div>
<div class="sect3">
<h4 id="_跳过使用暂存区域">跳过使用暂存区域</h4>
<div class="paragraph">
<p>
尽管使用暂存区域的方式可以精心准备要提交的细节，但有时候这么做略显繁琐。
Git 提供了一个跳过使用暂存区域的方式，
只要在提交的时候，给 <code>git commit</code> 加上 <code>-a</code> 选项，Git 就会自动把所有已经跟踪过的文件暂存起来一并提交，从而跳过 <code>git add</code> 步骤：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md

no changes added to commit (use "git add" and/or "git commit -a")
$ git commit -a -m 'added new benchmarks'
[master 83e38c7] added new benchmarks
 1 file changed, 5 insertions(+), 0 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>看到了吗？提交之前不再需要 <code>git add</code> 文件“CONTRIBUTING.md”了。</p>
</div>
</div>
<div class="sect3">
<h4 id="_removing_files">移除文件</h4>
<div class="paragraph">
<p>
要从 Git 中移除某个文件，就必须要从已跟踪文件清单中移除（确切地说，是从暂存区域移除），然后提交。
可以用 <code>git rm</code> 命令完成此项工作，并连带从工作目录中删除指定的文件，这样以后就不会出现在未跟踪文件清单中了。</p>
</div>
<div class="paragraph">
<p>如果只是简单地从工作目录中手工删除文件，运行 <code>git status</code> 时就会在 “Changes not staged for commit” 部分（也就是 <em>未暂存清单</em>）看到：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ rm PROJECTS.md
$ git status
On branch master
Your branch is up-to-date with 'origin/master'.
Changes not staged for commit:
  (use "git add/rm &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

        deleted:    PROJECTS.md

no changes added to commit (use "git add" and/or "git commit -a")</code></pre>
</div>
</div>
<div class="paragraph">
<p>然后再运行 <code>git rm</code> 记录此次移除文件的操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rm PROJECTS.md
rm 'PROJECTS.md'
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    deleted:    PROJECTS.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>下一次提交时，该文件就不再纳入版本管理了。
如果删除之前修改过并且已经放到暂存区域的话，则必须要用强制删除选项 <code>-f</code>（译注：即 force 的首字母）。
这是一种安全特性，用于防止误删还没有添加到快照的数据，这样的数据不能被 Git 恢复。</p>
</div>
<div class="paragraph">
<p>另外一种情况是，我们想把文件从 Git 仓库中删除（亦即从暂存区域移除），但仍然希望保留在当前工作目录中。
换句话说，您想让文件保留在磁盘，但是并不想让 Git 继续跟踪。
当您忘记添加 <code>.gitignore</code> 文件，不小心把一个很大的日志文件或一堆 <code>.a</code> 这样的编译生成文件添加到暂存区时，这一做法尤其有用。
为达到这一目的，使用 <code>--cached</code> 选项：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rm --cached README</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>git rm</code> 命令后面可以列出文件或者目录的名字，也可以使用 <code>glob</code> 模式。
比方说：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rm log/\*.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>注意到星号 <code>*</code> 之前的反斜杠 <code>\</code>，
因为 Git 有它自己的文件模式扩展匹配方式，所以我们不用 shell 来帮忙展开。
此命令删除 <code>log/</code> 目录下扩展名为 <code>.log</code> 的所有文件。
类似的比如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rm \*~</code></pre>
</div>
</div>
<div class="paragraph">
<p>该命令为删除以 <code>~</code> 结尾的所有文件。</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_mv">移动文件</h4>
<div class="paragraph">
<p>
不像其它的 VCS 系统，Git 并不显式跟踪文件移动操作。
如果在 Git 中重命名了某个文件，仓库中存储的元数据并不会体现出这是一次改名操作。
不过 Git 非常聪明，它会推断出究竟发生了什么，至于具体是如何做到的，我们稍后再谈。</p>
</div>
<div class="paragraph">
<p>既然如此，当您看到 Git 的 <code>mv</code> 命令时一定会困惑不已。
要在 Git 中对文件改名，可以这么做：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git mv file_from file_to</code></pre>
</div>
</div>
<div class="paragraph">
<p>它会恰如预期般正常工作。
实际上，即便此时查看状态信息，也会明白无误地看到关于重命名操作的说明：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git mv README.md README
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    renamed:    README.md -&gt; README</code></pre>
</div>
</div>
<div class="paragraph">
<p>其实，运行 <code>git mv</code> 就相当于运行了下面三条命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ mv README.md README
$ git rm README.md
$ git add README</code></pre>
</div>
</div>
<div class="paragraph">
<p>如此分开操作，Git 也会意识到这是一次改名，所以不管何种方式结果都一样。
两者唯一的区别是，<code>mv</code> 是一条命令而另一种方式需要三条命令，直接用 <code>git mv</code> 轻便得多。
不过有时候用其他工具批处理改名的话，要记得在提交前删除老的文件名，再添加新的文件名。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_viewing_history">Viewing the Commit History</h3>
<div class="paragraph">
<p>After you have created several commits, or if you have cloned a repository with an existing commit history, you&#8217;ll probably want to look back to see what has happened.
The most basic and powerful tool to do this is the <code>git log</code> command.</p>
</div>
<div class="paragraph">
<p>These examples use a very simple project called &#8220;simplegit&#8221;.
To get the project, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">git clone https://github.com/schacon/simplegit-progit</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run <code>git log</code> in this project, you should get output that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number

commit 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 16:40:33 2008 -0700

    removed unnecessary test

commit a11bef06a3f659402fe7563abf99ad00de2209e6
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 10:31:28 2008 -0700

    first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, with no arguments, <code>git log</code> lists the commits made in that repository in reverse chronological order – that is, the most recent commits show up first.
As you can see, this command lists each commit with its SHA-1 checksum, the author&#8217;s name and e-mail, the date written, and the commit message.</p>
</div>
<div class="paragraph">
<p>A huge number and variety of options to the <code>git log</code> command are available to show you exactly what you&#8217;re looking for.
Here, we&#8217;ll show you some of the most popular.</p>
</div>
<div class="paragraph">
<p>One of the more helpful options is <code>-p</code>, which shows the difference introduced in each commit.
You can also use <code>-2</code>, which limits the output to only the last two entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -p -2
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number

diff --git a/Rakefile b/Rakefile
index a874b73..8f94139 100644
--- a/Rakefile
+++ b/Rakefile
@@ -5,7 +5,7 @@ require 'rake/gempackagetask'
 spec = Gem::Specification.new do |s|
     s.platform  =   Gem::Platform::RUBY
     s.name      =   "simplegit"
-    s.version   =   "0.1.0"
+    s.version   =   "0.1.1"
     s.author    =   "Scott Chacon"
     s.email     =   "schacon@gee-mail.com"
     s.summary   =   "A simple gem for using Git in Ruby code."

commit 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 16:40:33 2008 -0700

    removed unnecessary test

diff --git a/lib/simplegit.rb b/lib/simplegit.rb
index a0a60ae..47c6340 100644
--- a/lib/simplegit.rb
+++ b/lib/simplegit.rb
@@ -18,8 +18,3 @@ class SimpleGit
     end

 end
-
-if $0 == __FILE__
-  git = SimpleGit.new
-  puts git.show
-end
\ No newline at end of file</code></pre>
</div>
</div>
<div class="paragraph">
<p>This option displays the same information but with a diff directly following each entry.
This is very helpful for code review or to quickly browse what happened during a series of commits that a collaborator has added.
You can also use a series of summarizing options with <code>git log</code>.
For example, if you want to see some abbreviated stats for each commit, you can use the <code>--stat</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --stat
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number

 Rakefile | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

commit 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 16:40:33 2008 -0700

    removed unnecessary test

 lib/simplegit.rb | 5 -----
 1 file changed, 5 deletions(-)

commit a11bef06a3f659402fe7563abf99ad00de2209e6
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 10:31:28 2008 -0700

    first commit

 README           |  6 ++++++
 Rakefile         | 23 +++++++++++++++++++++++
 lib/simplegit.rb | 25 +++++++++++++++++++++++++
 3 files changed, 54 insertions(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the <code>--stat</code> option prints below each commit entry a list of modified files, how many files were changed, and how many lines in those files were added and removed.
It also puts a summary of the information at the end.</p>
</div>
<div class="paragraph">
<p>Another really useful option is <code>--pretty</code>.
This option changes the log output to formats other than the default.
A few prebuilt options are available for you to use.
The <code>oneline</code> option prints each commit on a single line, which is useful if you&#8217;re looking at a lot of commits.
In addition, the <code>short</code>, <code>full</code>, and <code>fuller</code> options show the output in roughly the same format but with less or more information, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=oneline
ca82a6dff817ec66f44342007202690a93763949 changed the version number
085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7 removed unnecessary test
a11bef06a3f659402fe7563abf99ad00de2209e6 first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most interesting option is <code>format</code>, which allows you to specify your own log output format.
This is especially useful when you&#8217;re generating output for machine parsing – because you specify the format explicitly, you know it won&#8217;t change with updates to Git:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=format:"%h - %an, %ar : %s"
ca82a6d - Scott Chacon, 6 years ago : changed the version number
085bb3b - Scott Chacon, 6 years ago : removed unnecessary test
a11bef0 - Scott Chacon, 6 years ago : first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#pretty_format">Useful options for <code>git log --pretty=format</code></a> lists some of the more useful options that format takes.</p>
</div>
<table id="pretty_format" class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Useful options for <code>git log --pretty=format</code></caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description of Output</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%H</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commit hash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%h</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abbreviated commit hash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%T</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tree hash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abbreviated tree hash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%P</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parent hashes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%p</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abbreviated parent hashes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%an</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Author name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%ae</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Author e-mail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%ad</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Author date (format respects the –date= option)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%ar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Author date, relative</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%cn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Committer name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%ce</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Committer email</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%cd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Committer date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%cr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Committer date, relative</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subject</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You may be wondering what the difference is between <em>author</em> and <em>committer</em>.
The author is the person who originally wrote the work, whereas the committer is the person who last applied the work.
So, if you send in a patch to a project and one of the core members applies the patch, both of you get credit – you as the author, and the core member as the committer.
We&#8217;ll cover this distinction a bit more in <a href="#_distributed_git">Distributed Git</a>.</p>
</div>
<div class="paragraph">
<p>The oneline and format options are particularly useful with another <code>log</code> option called <code>--graph</code>.
This option adds a nice little ASCII graph showing your branch and merge history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=format:"%h %s" --graph
* 2d3acf9 ignore errors from SIGCHLD on trap
*  5e3ee11 Merge branch 'master' of git://github.com/dustin/grit
|\
| * 420eac9 Added a method for getting the current branch.
* | 30e367c timeout code and tests
* | 5a09431 add timeout protection to grit
* | e1193f8 support for heads with slashes in them
|/
* d6016bc require time for xmlschema
*  11d191e Merge branch 'defunkt' into local</code></pre>
</div>
</div>
<div class="paragraph">
<p>This type of output will become more interesting as we go through branching and merging in the next chapter.</p>
</div>
<div class="paragraph">
<p>Those are only some simple output-formatting options to <code>git log</code> – there are many more.
<a href="#log_options">Common options to <code>git log</code></a> lists the options we&#8217;ve covered so far, as well as some other common formatting options that may be useful, along with how they change the output of the log command.</p>
</div>
<table id="log_options" class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Common options to <code>git log</code></caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-p</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show the patch introduced with each commit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--stat</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show statistics for files modified in each commit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--shortstat</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display only the changed/insertions/deletions line from the --stat command.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--name-only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show the list of files modified after the commit information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--name-status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show the list of files affected with added/modified/deleted information as well.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--abbrev-commit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show only the first few characters of the SHA-1 checksum instead of all 40.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--relative-date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display the date in a relative format (for example, &#8220;2 weeks ago&#8221;) instead of using the full date format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--graph</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display an ASCII graph of the branch and merge history beside the log output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--pretty</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show commits in an alternate format. Options include oneline, short, full, fuller, and format (where you specify your own format).</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_limiting_log_output">Limiting Log Output</h4>
<div class="paragraph">
<p>In addition to output-formatting options, <code>git log</code> takes a number of useful limiting options – that is, options that let you show only a subset of commits.
You&#8217;ve seen one such option already – the <code>-2</code> option, which show only the last two commits.
In fact, you can do <code>-&lt;n&gt;</code>, where <code>n</code> is any integer to show the last <code>n</code> commits.
In reality, you&#8217;re unlikely to use that often, because Git by default pipes all output through a pager so you see only one page of log output at a time.</p>
</div>
<div class="paragraph">
<p>However, the time-limiting options such as <code>--since</code> and <code>--until</code> are very useful.
For example, this command gets the list of commits made in the last two weeks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --since=2.weeks</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command works with lots of formats – you can specify a specific date like <code>"2008-01-15"</code>, or a relative date such as <code>"2 years 1 day 3 minutes ago"</code>.</p>
</div>
<div class="paragraph">
<p>You can also filter the list to commits that match some search criteria.
The <code>--author</code> option allows you to filter on a specific author, and the <code>--grep</code> option lets you search for keywords in the commit messages.
(Note that if you want to specify both author and grep options, you have to add <code>--all-match</code> or the command will match commits with either.)</p>
</div>
<div class="paragraph">
<p>Another really helpful filter is the <code>-S</code> option which takes a string and only shows the commits that introduced a change to the code that added or removed that string.  For instance, if you wanted to find the last commit that added or removed a reference to a specific function, you could call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -Sfunction_name</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last really useful option to pass to <code>git log</code> as a filter is a path.
If you specify a directory or file name, you can limit the log output to commits that introduced a change to those files.
This is always the last option and is generally preceded by double dashes (<code>--</code>) to separate the paths from the options.</p>
</div>
<div class="paragraph">
<p>In <a href="#limit_options">Options to limit the output of <code>git log</code></a> we&#8217;ll list these and a few other common options for your reference.</p>
</div>
<table id="limit_options" class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Options to limit the output of <code>git log</code></caption>
<colgroup>
<col style="width: 33%;">
<col style="width: 66%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-(n)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Show only the last n commits</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--since</code>, <code>--after</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limit the commits to those made after the specified date.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--until</code>, <code>--before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limit the commits to those made before the specified date.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--author</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only show commits in which the author entry matches the specified string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--committer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only show commits in which the committer entry matches the specified string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--grep</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only show commits with a commit message containing the string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-S</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only show commits adding or removing code matching the string</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, if you want to see which commits modifying test files in the Git source code history were committed by Junio Hamano and were not merges in the month of October 2008, you can run something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty="%h - %s" --author=gitster --since="2008-10-01" \
   --before="2008-11-01" --no-merges -- t/
5610e3b - Fix testcase failure when extended attributes are in use
acd3b9e - Enhance hold_lock_file_for_{update,append}() API
f563754 - demonstrate breakage of detached checkout with symbolic link HEAD
d1a43f2 - reset --hard/read-tree --reset -u: remove unmerged new paths
51a94af - Fix "checkout --track -b newbranch" on detached HEAD
b0ad11e - pull: allow "git pull origin $something:$current_branch" into an unborn branch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of the nearly 40,000 commits in the Git source code history, this command shows the 6 that match those criteria.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_undoing">Undoing Things</h3>
<div class="paragraph">
<p>At any stage, you may want to undo something.
Here, we&#8217;ll review a few basic tools for undoing changes that you&#8217;ve made.
Be careful, because you can&#8217;t always undo some of these undos.
This is one of the few areas in Git where you may lose some work if you do it wrong.</p>
</div>
<div class="paragraph">
<p>One of the common undos takes place when you commit too early and possibly forget to add some files, or you mess up your commit message.
If you want to try that commit again, you can run commit with the <code>--amend</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit --amend</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command takes your staging area and uses it for the commit.
If you&#8217;ve made no changes since your last commit (for instance, you run this command immediately after your previous commit), then your snapshot will look exactly the same, and all you&#8217;ll change is your commit message.</p>
</div>
<div class="paragraph">
<p>The same commit-message editor fires up, but it already contains the message of your previous commit.
You can edit the message the same as always, but it overwrites your previous commit.</p>
</div>
<div class="paragraph">
<p>As an example, if you commit and then realize you forgot to stage the changes in a file you wanted to add to this commit, you can do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -m 'initial commit'
$ git add forgotten_file
$ git commit --amend</code></pre>
</div>
</div>
<div class="paragraph">
<p>You end up with a single commit – the second commit replaces the results of the first.</p>
</div>
<div class="sect3">
<h4 id="_unstaging">Unstaging a Staged File</h4>
<div class="paragraph">
<p>The next two sections demonstrate how to wrangle your staging area and working directory changes.
The nice part is that the command you use to determine the state of those two areas also reminds you how to undo changes to them.
For example, let&#8217;s say you&#8217;ve changed two files and want to commit them as two separate changes, but you accidentally type <code>git add *</code> and stage them both.
How can you unstage one of the two?
The <code>git status</code> command reminds you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add .
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    renamed:    README.md -&gt; README
    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>Right below the &#8220;Changes to be committed&#8221; text, it says use <code>git reset HEAD &lt;file&gt;...</code> to unstage.
So, let&#8217;s use that advice to unstage the <code>CONTRIBUTING.md</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git reset HEAD CONTRIBUTING.md
Unstaged changes after reset:
M	CONTRIBUTING.md
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    renamed:    README.md -&gt; README

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command is a bit strange, but it works.
The <code>CONTRIBUTING.md</code> file is modified but once again unstaged.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>While <code>git reset</code> <em>can</em> be a dangerous command if you call it with <code>--hard</code>, in this instance the file in your working directory is not touched. Calling <code>git reset</code> without an option is not dangerous - it only touches your staging area.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For now this magic invocation is all you need to know about the <code>git reset</code> command. We&#8217;ll go into much more detail about what <code>reset</code> does and how to master it to do really interesting things in <a href="#_git_reset">Reset Demystified</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_unmodifying_a_modified_file">Unmodifying a Modified File</h4>
<div class="paragraph">
<p>What if you realize that you don&#8217;t want to keep your changes to the <code>CONTRIBUTING.md</code> file?
How can you easily unmodify it – revert it back to what it looked like when you last committed (or initially cloned, or however you got it into your working directory)?
Luckily, <code>git status</code> tells you how to do that, too.
In the last example output, the unstaged area looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

    modified:   CONTRIBUTING.md</code></pre>
</div>
</div>
<div class="paragraph">
<p>It tells you pretty explicitly how to discard the changes you&#8217;ve made.
Let&#8217;s do what it says:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -- CONTRIBUTING.md
$ git status
On branch master
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

    renamed:    README.md -&gt; README</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the changes have been reverted.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s important to understand that <code>git checkout -- [file]</code> is a dangerous command. Any changes you made to that file are gone – you just copied another file over it.
Don&#8217;t ever use this command unless you absolutely know that you don&#8217;t want the file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you would like to keep the changes you&#8217;ve made to that file but still need to get it out of the way for now, we&#8217;ll go over stashing and branching in <a href="#_git_branching">Git 分支</a>; these are generally better ways to go.</p>
</div>
<div class="paragraph">
<p>Remember, anything that is <em>committed</em> in Git can almost always be recovered.
Even commits that were on branches that were deleted or commits that were overwritten with an <code>--amend</code> commit can be recovered (see <a href="#_data_recovery">Data Recovery</a> for data recovery).
However, anything you lose that was never committed is likely never to be seen again.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_remote_repos">Working with Remotes</h3>
<div class="paragraph">
<p>To be able to collaborate on any Git project, you need to know how to manage your remote repositories.
Remote repositories are versions of your project that are hosted on the Internet or network somewhere.
You can have several of them, each of which generally is either read-only or read/write for you.
Collaborating with others involves managing these remote repositories and pushing and pulling data to and from them when you need to share work.
Managing remote repositories includes knowing how to add remote repositories, remove remotes that are no longer valid, manage various remote branches and define them as being tracked or not, and more.
In this section, we&#8217;ll cover some of these remote-management skills.</p>
</div>
<div class="sect3">
<h4 id="_showing_your_remotes">Showing Your Remotes</h4>
<div class="paragraph">
<p>To see which remote servers you have configured, you can run the <code>git remote</code> command.
It lists the shortnames of each remote handle you&#8217;ve specified.
If you&#8217;ve cloned your repository, you should at least see origin – that is the default name Git gives to the server you cloned from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://github.com/schacon/ticgit
Cloning into 'ticgit'...
remote: Reusing existing pack: 1857, done.
remote: Total 1857 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (1857/1857), 374.35 KiB | 268.00 KiB/s, done.
Resolving deltas: 100% (772/772), done.
Checking connectivity... done.
$ cd ticgit
$ git remote
origin</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify <code>-v</code>, which shows you the URLs that Git has stored for the shortname to be used when reading and writing to that remote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote -v
origin	https://github.com/schacon/ticgit (fetch)
origin	https://github.com/schacon/ticgit (push)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have more than one remote, the command lists them all.
For example, a repository with multiple remotes for working with several collaborators might look something like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd grit
$ git remote -v
bakkdoor  https://github.com/bakkdoor/grit (fetch)
bakkdoor  https://github.com/bakkdoor/grit (push)
cho45     https://github.com/cho45/grit (fetch)
cho45     https://github.com/cho45/grit (push)
defunkt   https://github.com/defunkt/grit (fetch)
defunkt   https://github.com/defunkt/grit (push)
koke      git://github.com/koke/grit.git (fetch)
koke      git://github.com/koke/grit.git (push)
origin    git@github.com:mojombo/grit.git (fetch)
origin    git@github.com:mojombo/grit.git (push)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means we can pull contributions from any of these users pretty easily. We may additionally have permission to push to one or more of these, though we can&#8217;t tell that here.</p>
</div>
<div class="paragraph">
<p>Notice that these remotes use a variety of protocols; we&#8217;ll cover more about this in <a href="#_git_on_the_server">Getting Git on a Server</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_remote_repositories">Adding Remote Repositories</h4>
<div class="paragraph">
<p>I&#8217;ve mentioned and given some demonstrations of adding remote repositories in previous sections, but here is how to do it explicitly.
To add a new remote Git repository as a shortname you can reference easily, run <code>git remote add [shortname] [url]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote
origin
$ git remote add pb https://github.com/paulboone/ticgit
$ git remote -v
origin	https://github.com/schacon/ticgit (fetch)
origin	https://github.com/schacon/ticgit (push)
pb	https://github.com/paulboone/ticgit (fetch)
pb	https://github.com/paulboone/ticgit (push)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can use the string <code>pb</code> on the command line in lieu of the whole URL.
For example, if you want to fetch all the information that Paul has but that you don&#8217;t yet have in your repository, you can run <code>git fetch pb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch pb
remote: Counting objects: 43, done.
remote: Compressing objects: 100% (36/36), done.
remote: Total 43 (delta 10), reused 31 (delta 5)
Unpacking objects: 100% (43/43), done.
From https://github.com/paulboone/ticgit
 * [new branch]      master     -&gt; pb/master
 * [new branch]      ticgit     -&gt; pb/ticgit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Paul&#8217;s master branch is now accessible locally as <code>pb/master</code> – you can merge it into one of your branches, or you can check out a local branch at that point if you want to inspect it.
(We&#8217;ll go over what branches are and how to use them in much more detail in <a href="#_git_branching">Git 分支</a>.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_fetching_and_pulling">Fetching and Pulling from Your Remotes</h4>
<div class="paragraph">
<p>As you just saw, to get data from your remote projects, you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch [remote-name]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command goes out to that remote project and pulls down all the data from that remote project that you don&#8217;t have yet.
After you do this, you should have references to all the branches from that remote, which you can merge in or inspect at any time.</p>
</div>
<div class="paragraph">
<p>If you clone a repository, the command automatically adds that remote repository under the name &#8220;origin&#8221;.
So, <code>git fetch origin</code> fetches any new work that has been pushed to that server since you cloned (or last fetched from) it.
It&#8217;s important to note that the <code>git fetch</code> command pulls the data to your local repository – it doesn&#8217;t automatically merge it with any of your work or modify what you&#8217;re currently working on.
You have to merge it manually into your work when you&#8217;re ready.</p>
</div>
<div class="paragraph">
<p>If you have a branch set up to track a remote branch (see the next section and <a href="#_git_branching">Git 分支</a> for more information), you can use the <code>git pull</code> command to automatically fetch and then merge a remote branch into your current branch.
This may be an easier or more comfortable workflow for you; and by default, the <code>git clone</code> command automatically sets up your local master branch to track the remote master branch (or whatever the default branch is called) on the server you cloned from.
Running <code>git pull</code> generally fetches data from the server you originally cloned from and automatically tries to merge it into the code you&#8217;re currently working on.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pushing_remotes">Pushing to Your Remotes</h4>
<div class="paragraph">
<p>When you have your project at a point that you want to share, you have to push it upstream.
The command for this is simple: <code>git push [remote-name] [branch-name]</code>.
If you want to push your master branch to your <code>origin</code> server (again, cloning generally sets up both of those names for you automatically), then you can run this to push any commits you&#8217;ve done back up to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command works only if you cloned from a server to which you have write access and if nobody has pushed in the meantime.
If you and someone else clone at the same time and they push upstream and then you push upstream, your push will rightly be rejected.
You&#8217;ll have to pull down their work first and incorporate it into yours before you&#8217;ll be allowed to push.
See <a href="#_git_branching">Git 分支</a> for more detailed information on how to push to remote servers.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspecting_remote">Inspecting a Remote</h4>
<div class="paragraph">
<p>If you want to see more information about a particular remote, you can use the <code>git remote show [remote-name]</code> command.
If you run this command with a particular shortname, such as <code>origin</code>, you get something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote show origin
* remote origin
  Fetch URL: https://github.com/schacon/ticgit
  Push  URL: https://github.com/schacon/ticgit
  HEAD branch: master
  Remote branches:
    master                               tracked
    dev-branch                           tracked
  Local branch configured for 'git pull':
    master merges with remote master
  Local ref configured for 'git push':
    master pushes to master (up to date)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It lists the URL for the remote repository as well as the tracking branch information.
The command helpfully tells you that if you&#8217;re on the master branch and you run <code>git pull</code>, it will automatically merge in the master branch on the remote after it fetches all the remote references.
It also lists all the remote references it has pulled down.</p>
</div>
<div class="paragraph">
<p>That is a simple example you&#8217;re likely to encounter.
When you&#8217;re using Git more heavily, however, you may see much more information from <code>git remote show</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote show origin
* remote origin
  URL: https://github.com/my-org/complex-project
  Fetch URL: https://github.com/my-org/complex-project
  Push  URL: https://github.com/my-org/complex-project
  HEAD branch: master
  Remote branches:
    master                           tracked
    dev-branch                       tracked
    markdown-strip                   tracked
    issue-43                         new (next fetch will store in remotes/origin)
    issue-45                         new (next fetch will store in remotes/origin)
    refs/remotes/origin/issue-11     stale (use 'git remote prune' to remove)
  Local branches configured for 'git pull':
    dev-branch merges with remote dev-branch
    master     merges with remote master
  Local refs configured for 'git push':
    dev-branch                     pushes to dev-branch                     (up to date)
    markdown-strip                 pushes to markdown-strip                 (up to date)
    master                         pushes to master                         (up to date)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command shows which branch is automatically pushed to when you run <code>git push</code> while on certain branches.
It also shows you which remote branches on the server you don&#8217;t yet have, which remote branches you have that have been removed from the server, and multiple branches that are automatically merged when you run <code>git pull</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_removing_and_renaming_remotes">Removing and Renaming Remotes</h4>
<div class="paragraph">
<p>If you want to rename a reference you can run <code>git remote rename</code> to change a remote&#8217;s shortname.
For instance, if you want to rename <code>pb</code> to <code>paul</code>, you can do so with <code>git remote rename</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote rename pb paul
$ git remote
origin
paul</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s worth mentioning that this changes your remote branch names, too.
What used to be referenced at <code>pb/master</code> is now at <code>paul/master</code>.</p>
</div>
<div class="paragraph">
<p>If you want to remove a remote for some reason – you&#8217;ve moved the server or are no longer using a particular mirror, or perhaps a contributor isn&#8217;t contributing anymore – you can use <code>git remote rm</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote rm paul
$ git remote
origin</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_tagging">Tagging</h3>
<div class="paragraph">
<p>
Like most VCSs, Git has the ability to tag specific points in history as being important.
Typically people use this functionality to mark release points (v1.0, and so on).
In this section, you&#8217;ll learn how to list the available tags, how to create new tags, and what the different types of tags are.</p>
</div>
<div class="sect3">
<h4 id="_listing_your_tags">Listing Your Tags</h4>
<div class="paragraph">
<p>Listing the available tags in Git is straightforward.
Just type <code>git tag</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag
v0.1
v1.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command lists the tags in alphabetical order; the order in which they appear has no real importance.</p>
</div>
<div class="paragraph">
<p>You can also search for tags with a particular pattern.
The Git source repo, for instance, contains more than 500 tags.
If you&#8217;re only interested in looking at the 1.8.5 series, you can run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -l 'v1.8.5*'
v1.8.5
v1.8.5-rc0
v1.8.5-rc1
v1.8.5-rc2
v1.8.5-rc3
v1.8.5.1
v1.8.5.2
v1.8.5.3
v1.8.5.4
v1.8.5.5</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_tags">Creating Tags</h4>
<div class="paragraph">
<p>Git uses two main types of tags: lightweight and annotated.</p>
</div>
<div class="paragraph">
<p>A lightweight tag is very much like a branch that doesn&#8217;t change – it&#8217;s just a pointer to a specific commit.</p>
</div>
<div class="paragraph">
<p>Annotated tags, however, are stored as full objects in the Git database.
They&#8217;re checksummed; contain the tagger name, e-mail, and date; have a tagging message; and can be signed and verified with GNU Privacy Guard (GPG).
It&#8217;s generally recommended that you create annotated tags so you can have all this information; but if you want a temporary tag or for some reason don&#8217;t want to keep the other information, lightweight tags are available too.</p>
</div>
</div>
<div class="sect3">
<h4 id="_annotated_tags">Annotated Tags</h4>
<div class="paragraph">
<p>
Creating an annotated tag in Git is simple.
The easiest way is to specify <code>-a</code> when you run the <code>tag</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -a v1.4 -m 'my version 1.4'
$ git tag
v0.1
v1.3
v1.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-m</code> specifies a tagging message, which is stored with the tag.
If you don&#8217;t specify a message for an annotated tag, Git launches your editor so you can type it in.</p>
</div>
<div class="paragraph">
<p>You can see the tag data along with the commit that was tagged by using the <code>git show</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show v1.4
tag v1.4
Tagger: Ben Straub &lt;ben@straub.cc&gt;
Date:   Sat May 3 20:19:12 2014 -0700

my version 1.4

commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number</code></pre>
</div>
</div>
<div class="paragraph">
<p>That shows the tagger information, the date the commit was tagged, and the annotation message before showing the commit information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lightweight_tags">Lightweight Tags</h4>
<div class="paragraph">
<p>
Another way to tag commits is with a lightweight tag.
This is basically the commit checksum stored in a file – no other information is kept.
To create a lightweight tag, don&#8217;t supply the <code>-a</code>, <code>-s</code>, or <code>-m</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag v1.4-lw
$ git tag
v0.1
v1.3
v1.4
v1.4-lw
v1.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, if you run <code>git show</code> on the tag, you don&#8217;t see the extra tag information.
The command just shows the commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show v1.4-lw
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tagging_later">Tagging Later</h4>
<div class="paragraph">
<p>You can also tag commits after you&#8217;ve moved past them.
Suppose your commit history looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=oneline
15027957951b64cf874c3557a0f3547bd83b3ff6 Merge branch 'experiment'
a6b4c97498bd301d84096da251c98a07c7723e65 beginning write support
0d52aaab4479697da7686c15f77a3d64d9165190 one more thing
6d52a271eda8725415634dd79daabbc4d9b6008e Merge branch 'experiment'
0b7434d86859cc7b8c3d5e1dddfed66ff742fcbc added a commit function
4682c3261057305bdd616e23b64b0857d832627b added a todo file
166ae0c4d3f420721acbb115cc33848dfcc2121a started write support
9fceb02d0ae598e95dc970b74767f19372d61af8 updated rakefile
964f16d36dfccde844893cac5b347e7b3d44abbc commit the todo
8a5cbc430f1a9c3d00faaeffd07798508422908a updated readme</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, suppose you forgot to tag the project at v1.2, which was at the &#8220;updated rakefile&#8221; commit.
You can add it after the fact.
To tag that commit, you specify the commit checksum (or part of it) at the end of the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -a v1.2 9fceb02</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that you&#8217;ve tagged the commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag
v0.1
v1.2
v1.3
v1.4
v1.4-lw
v1.5

$ git show v1.2
tag v1.2
Tagger: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Feb 9 15:32:16 2009 -0800

version 1.2
commit 9fceb02d0ae598e95dc970b74767f19372d61af8
Author: Magnus Chacon &lt;mchacon@gee-mail.com&gt;
Date:   Sun Apr 27 20:43:35 2008 -0700

    updated rakefile
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sharing_tags">Sharing Tags</h4>
<div class="paragraph">
<p>By default, the <code>git push</code> command doesn&#8217;t transfer tags to remote servers.
You will have to explicitly push tags to a shared server after you have created them.
This process is just like sharing remote branches – you can run <code>git push origin [tagname]</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin v1.5
Counting objects: 14, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (12/12), done.
Writing objects: 100% (14/14), 2.05 KiB | 0 bytes/s, done.
Total 14 (delta 3), reused 0 (delta 0)
To git@github.com:schacon/simplegit.git
 * [new tag]         v1.5 -&gt; v1.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a lot of tags that you want to push up at once, you can also use the <code>--tags</code> option to the <code>git push</code> command.
This will transfer all of your tags to the remote server that are not already there.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin --tags
Counting objects: 1, done.
Writing objects: 100% (1/1), 160 bytes | 0 bytes/s, done.
Total 1 (delta 0), reused 0 (delta 0)
To git@github.com:schacon/simplegit.git
 * [new tag]         v1.4 -&gt; v1.4
 * [new tag]         v1.4-lw -&gt; v1.4-lw</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, when someone else clones or pulls from your repository, they will get all your tags as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_out_tags">Checking out Tags</h4>
<div class="paragraph">
<p>You can&#8217;t really check out a tag in Git, since they can&#8217;t be moved around.
If you want to put a version of your repository in your working directory that looks like a specific tag, you can create a new branch at a specific tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b version2 v2.0.0
Switched to a new branch 'version2'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course if you do this and do a commit, your <code>version2</code> branch will be slightly different than your <code>v2.0.0</code> tag since it will move forward with your new changes, so do be careful.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_aliases">Git Aliases</h3>
<div class="paragraph">
<p>
Before we finish this chapter on basic Git, there&#8217;s just one little tip that can make your Git experience simpler, easier, and more familiar: aliases.
We won&#8217;t refer to them or assume you&#8217;ve used them later in the book, but you should probably know how to use them.</p>
</div>
<div class="paragraph">
<p>Git doesn&#8217;t automatically infer your command if you type it in partially.
If you don&#8217;t want to type the entire text of each of the Git commands, you can easily set up an alias for each command using <code>git config</code>.
Here are a couple of examples you may want to set up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global alias.co checkout
$ git config --global alias.br branch
$ git config --global alias.ci commit
$ git config --global alias.st status</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that, for example, instead of typing <code>git commit</code>, you just need to type <code>git ci</code>.
As you go on using Git, you&#8217;ll probably use other commands frequently as well; don&#8217;t hesitate to create new aliases.</p>
</div>
<div class="paragraph">
<p>This technique can also be very useful in creating commands that you think should exist.
For example, to correct the usability problem you encountered with unstaging a file, you can add your own unstage alias to Git:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global alias.unstage 'reset HEAD --'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes the following two commands equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git unstage fileA
$ git reset HEAD fileA</code></pre>
</div>
</div>
<div class="paragraph">
<p>This seems a bit clearer.
It&#8217;s also common to add a <code>last</code> command, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global alias.last 'log -1 HEAD'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, you can see the last commit easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git last
commit 66938dae3329c7aebe598c2246a8e6af90d04646
Author: Josh Goebel &lt;dreamer3@example.com&gt;
Date:   Tue Aug 26 19:48:51 2008 +0800

    test for current head

    Signed-off-by: Scott Chacon &lt;schacon@example.com&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can tell, Git simply replaces the new command with whatever you alias it for.
However, maybe you want to run an external command, rather than a Git subcommand.
In that case, you start the command with a <code>!</code> character.
This is useful if you write your own tools that work with a Git repository.
We can demonstrate by aliasing <code>git visual</code> to run <code>gitk</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global alias.visual "!gitk"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_总结_2">总结</h3>
<div class="paragraph">
<p>现在，您可以完成所有基本的 Git 本地操作－创建或者克隆一个仓库、做更改、暂存并提交这些更改、浏览您的仓库从创建到现在的所有更改的历史。
下一步，本书将介绍 Git 的杀手级特性：分支模型。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_branching">Git 分支</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
几乎所有的版本控制系统都以某种形式支持分支。
使用分支意味着您可以把您的工作从开发主线上分离开来，以免影响开发主线。
在很多版本控制系统中，这是一个略微低效的过程——常常需要完全创建一个源代码目录的副本。对于大项目来说，这样的过程会耗费很多时间。</p>
</div>
<div class="paragraph">
<p>有人把 Git 的分支模型称为它的`&#8216;必杀技特性&#8217;'，也正因为这一特性，使得 Git 从众多版本控制系统中脱颖而出。
为何 Git 的分支模型如此出众呢？
Git 处理分支的方式可谓是难以置信的轻量，创建新分支这一操作几乎能在瞬间完成，并且在不同分支之间的切换操作也是一样便捷。
与许多其它版本控制系统不同，Git 鼓励在工作流程中频繁地使用分支与合并，哪怕一天之内进行许多次。
理解和精通这一特性，您便会意识到 Git 是如此的强大而又独特，并且从此真正改变您的开发方式。</p>
</div>
<div class="sect2">
<h3 id="_git_branches_overview">分支简介</h3>
<div class="paragraph">
<p>为了真正理解 Git 处理分支的方式，我们需要回顾一下 Git 是如何保存数据的。</p>
</div>
<div class="paragraph">
<p>或许您还记得 <a href="#_getting_started">起步</a> 的内容，Git 保存的不是文件的变化或者差异，而是一系列不同时刻的文件快照。</p>
</div>
<div class="paragraph">
<p>在进行提交操作时，Git 会保存一个提交对象（commit object）。知道了 Git 保存数据的方式，我们可以很自然的想到——该提交对象会包含一个指向暂存内容快照的指针。
但不仅仅是这样，该提交对象还包含了作者的姓名和邮箱、提交时输入的信息以及指向它的父对象的指针。首次提交产生的提交对象没有父对象，普通提交操作产生的提交对象有一个父对象，而由多个分支合并产生的提交对象有多个父对象，</p>
</div>
<div class="paragraph">
<p>为了说得更加形象，我们假设现在有一个工作目录，里面包含了三个将要被暂存和提交的文件。
暂存操作会为每一个文件计算校验和（使用我们在 <a href="#_getting_started">起步</a> 中提到的 SHA-1 哈希算法），然后会把当前版本的文件快照保存到 Git 仓库中（Git 使用 blob 对象来保存它们），最终将校验和加入到暂存区域等待提交：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add README test.rb LICENSE
$ git commit -m 'initial commit of my project'</code></pre>
</div>
</div>
<div class="paragraph">
<p>当使用 <code>git commit</code> 进行提交操作时，Git 会先计算每一个子目录（本例中只有项目根目录）的校验和，然后在 Git 仓库中这些校验和保存为树对象。
随后，Git 便会创建一个提交对象，它除了包含上面提到的那些信息外，还包含指向这个树对象（项目根目录）的指针。如此一来，Git 就可以在需要的时候重现此次保存的快照。</p>
</div>
<div class="paragraph">
<p>现在，Git 仓库中有五个对象：三个 blob 对象（保存着文件快照）、一个树对象（记录着目录结构和 blob 对象索引）以及一个提交对象（包含着指向前述树对象的指针和所有提交信息）。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/commit-and-tree.png" alt="首次提交对象及其树结构.">
</div>
<div class="title">Figure 9. 首次提交对象及其树结构</div>
</div>
<div class="paragraph">
<p>做些修改后再次提交，那么这次产生的提交对象会包含一个指向上次提交对象（父对象）的指针。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/commits-and-parents.png" alt="提交对象及其父对象.">
</div>
<div class="title">Figure 10. 提交对象及其父对象</div>
</div>
<div class="paragraph">
<p>说完了 Git 保存数据的方式，现在让我们谈回分支。
Git 的分支，其实本质上仅仅是指向提交对象的可变指针。
Git 的默认分支名字是 <code>master</code>。
在多次提交操作之后，您其实已经有一个指向最后那个提交对象的 master 分支。
它会在每次的提交操作中自动向前移动。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Git 的 &#8220;master&#8221; 分支并不是一个特殊分支。
它就跟其它分支完全没有区别。
之所以几乎每一个仓库都有 master 分支，是因为 <code>git init</code> 命令默认创建它，并且大多数人都懒得去改动它。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/branch-and-history.png" alt="分支及其提交历史.">
</div>
<div class="title">Figure 11. 分支及其提交历史</div>
</div>
<div class="sect3">
<h4 id="_create_new_branch">分支创建</h4>
<div class="paragraph">
<p>
Git 是怎么创建新分支的呢？
很简单，它只是为您创建了一个可以移动的新的指针。
比如，创建一个 testing 分支，需要使用 <code>git branch</code> 命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>这会在当前所在的提交对象上创建一个指针。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/two-branches.png" alt="两个指向相同提交历史的分支.">
</div>
<div class="title">Figure 12. 两个指向相同提交历史的分支</div>
</div>
<div class="paragraph">
<p>那么，Git 又是怎么知道当前在哪一个分支上呢？
也很简单，它有一个名为 <code>HEAD</code> 的特殊指针。
请注意它和许多其它版本控制系统（如 Subversion 或 CVS）里的 <code>HEAD</code> 概念完全不同。
在 Git 中，它是一个指针，指向当前所在的本地分支（译注：将 <code>HEAD</code> 想象为当前分支的别名）。
在本例中，您仍然在 master 分支上。
因为 <code>git branch</code> 命令仅仅_创建_一个新分支，并不会自动切换到新分支中去。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/head-to-master.png" alt="HEAD 指向当前所在的分支.">
</div>
<div class="title">Figure 13. HEAD 指向当前所在的分支</div>
</div>
<div class="paragraph">
<p>您可以简单地使用 <code>git log</code> 命令查看各个分支当前所指的对象。提供这一功能的参数是 <code>--decorate</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --decorate
f30ab (HEAD, master, testing) add feature #32 - ability to add new
34ac2 fixed bug #1328 - stack overflow under certain conditions
98ca9 initial commit of my project</code></pre>
</div>
</div>
<div class="paragraph">
<p>正如您所见，当前 &#8220;master&#8221; 和 &#8220;testing&#8221; 分支均指向校验和以 <code>f30ab</code> 开头的提交对象。</p>
</div>
</div>
<div class="sect3">
<h4 id="_switching_branches">分支切换</h4>
<div class="paragraph">
<p>
要切换到一个已存在的分支，您需要使用 <code>git checkout</code> 命令。
我们现在切换到新创建的 testing 分支去：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>这样 <code>HEAD</code> 就指向 <code>testing</code> 分支了。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/head-to-testing.png" alt="HEAD 指向当前所在的分支.">
</div>
<div class="title">Figure 14. HEAD 指向当前所在的分支</div>
</div>
<div class="paragraph">
<p>那么，这样的实现方式会给我们带来什么好处呢？
现在不妨再提交一次：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim test.rb
$ git commit -a -m 'made a change'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/advance-testing.png" alt="HEAD 分支随着提交操作自动向前移动.">
</div>
<div class="title">Figure 15. HEAD 分支随着提交操作自动向前移动</div>
</div>
<div class="paragraph">
<p>如图所示，您的 testing 分支向前移动了，但是 master 分支却没有，它仍然指向运行 <code>git checkout</code> 时所指的对象。
这就有意思了，现在我们切换回 master 分支看看：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/checkout-master.png" alt="检出时 HEAD 随之移动.">
</div>
<div class="title">Figure 16. 检出时 HEAD 随之移动</div>
</div>
<div class="paragraph">
<p>这条命令做了两件事。
一是使 HEAD 指回 master 分支，二是将工作目录恢复成 master 分支所指向的快照内容。
也就是说，您现在做修改的话，项目将始于一个较旧的版本。
本质上来讲，这就是忽略 testing 分支所做的修改，以便于向另一个方向进行开发。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">分支切换会改变您工作目录中的文件</div>
<div class="paragraph">
<p>在切换分支时，一定要注意您工作目录里的文件会被改变。
如果是切换到一个较旧的分支，您的工作目录会恢复到该分支最后一次提交时的样子。
如果 Git 不能干净利落地完成这个任务，它将禁止切换分支。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>我们不妨再稍微做些修改并提交：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim test.rb
$ git commit -a -m 'made other changes'</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在，这个项目的提交历史已经产生了分叉（参见 <a href="#divergent_history">项目分叉历史</a>）。
因为刚才您创建了一个新分支，并切换过去进行了一些工作，随后又切换回 master 分支进行了另外一些工作。
上述两次改动针对的是不同分支：您可以在不同分支间不断地来回切换和工作，并在时机成熟时将它们合并起来。
而所有这些工作，您需要的命令只有 <code>branch</code>、<code>checkout</code> 和 <code>commit</code>。</p>
</div>
<div id="divergent_history" class="imageblock">
<div class="content">
<img src="images/advance-master.png" alt="项目分叉历史.">
</div>
<div class="title">Figure 17. 项目分叉历史</div>
</div>
<div class="paragraph">
<p>您可以简单地使用 <code>git log</code> 命令查看分叉历史。
运行 <code>git log --oneline --decorate --graph --all</code> ，它会输出您的提交历史、各个分支的指向以及项目的分支分叉情况。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --decorate --graph --all
* c2b9e (HEAD, master) made other changes
| * 87ab2 (testing) made a change
|/
* f30ab add feature #32 - ability to add new formats to the
* 34ac2 fixed bug #1328 - stack overflow under certain conditions
* 98ca9 initial commit of my project</code></pre>
</div>
</div>
<div class="paragraph">
<p>由于 Git 的分支实质上仅是包含所指对象校验和（长度为 40 的 SHA-1 值字符串）的文件，所以它的创建和销毁都异常高效。
创建一个新分支就像是往一个文件中写入 41 个字节（40 个字符和 1 个换行符），如此的简单能不快吗？</p>
</div>
<div class="paragraph">
<p>这与过去大多数版本控制系统形成了鲜明的对比，它们在创建分支时，将所有的工程文件都复制一遍，并保存到一个特定的目录。
完成这样繁琐的过程通常需要好几秒钟，有时甚至需要好几分钟。所需时间的长短，完全取决于项目的规模。而在 Git 中，任何规模的项目都能在瞬间创建新分支。
同时，由于每次提交都会记录父对象，所以寻找恰当的合并基础（译注：即共同祖先）也是同样的简单和高效。
这些高效的特性使得 Git 鼓励开发人员频繁地创建和使用分支。</p>
</div>
<div class="paragraph">
<p>接下来，让我们看看为什么您应该这么做？</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_branching_and_merging">Basic Branching and Merging</h3>
<div class="paragraph">
<p>Let&#8217;s go through a simple example of branching and merging with a workflow that you might use in the real world.
You&#8217;ll follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Do work on a web site.</p>
</li>
<li>
<p>Create a branch for a new story you&#8217;re working on.</p>
</li>
<li>
<p>Do some work in that branch.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>At this stage, you&#8217;ll receive a call that another issue is critical and you need a hotfix.
You&#8217;ll do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Switch to your production branch.</p>
</li>
<li>
<p>Create a branch to add the hotfix.</p>
</li>
<li>
<p>After it&#8217;s tested, merge the hotfix branch, and push to production.</p>
</li>
<li>
<p>Switch back to your original story and continue working.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_basic_branching">Basic Branching</h4>
<div class="paragraph">
<p>
First, let&#8217;s say you&#8217;re working on your project and have a couple of commits already.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-branching-1.png" alt="A simple commit history.">
</div>
<div class="title">Figure 18. A simple commit history</div>
</div>
<div class="paragraph">
<p>You&#8217;ve decided that you&#8217;re going to work on issue #53 in whatever issue-tracking system your company uses.
To create a branch and switch to it at the same time, you can run the <code>git checkout</code> command with the <code>-b</code> switch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b iss53
Switched to a new branch "iss53"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is shorthand for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch iss53
$ git checkout iss53</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-branching-2.png" alt="Creating a new branch pointer.">
</div>
<div class="title">Figure 19. Creating a new branch pointer</div>
</div>
<div class="paragraph">
<p>You work on your web site and do some commits.
Doing so moves the <code>iss53</code> branch forward, because you have it checked out (that is, your <code>HEAD</code> is pointing to it):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim index.html
$ git commit -a -m 'added a new footer [issue 53]'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-branching-3.png" alt="The iss53 branch has moved forward with your work.">
</div>
<div class="title">Figure 20. The iss53 branch has moved forward with your work</div>
</div>
<div class="paragraph">
<p>Now you get the call that there is an issue with the web site, and you need to fix it immediately.
With Git, you don&#8217;t have to deploy your fix along with the <code>iss53</code> changes you&#8217;ve made, and you don&#8217;t have to put a lot of effort into reverting those changes before you can work on applying your fix to what is in production.
All you have to do is switch back to your <code>master</code> branch.</p>
</div>
<div class="paragraph">
<p>However, before you do that, note that if your working directory or staging area has uncommitted changes that conflict with the branch you&#8217;re checking out, Git won&#8217;t let you switch branches.
It&#8217;s best to have a clean working state when you switch branches.
There are ways to get around this (namely, stashing and commit amending) that we&#8217;ll cover later on, in <a href="#_git_stashing">Stashing and Cleaning</a>.
For now, let&#8217;s assume you&#8217;ve committed all your changes, so you can switch back to your master branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
Switched to branch 'master'</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, your project working directory is exactly the way it was before you started working on issue #53, and you can concentrate on your hotfix.
This is an important point to remember: when you switch branches, Git resets your working directory to look like it did the last time you committed on that branch.
It adds, removes, and modifies files automatically to make sure your working copy is what the branch looked like on your last commit to it.</p>
</div>
<div class="paragraph">
<p>Next, you have a hotfix to make.
Let&#8217;s create a hotfix branch on which to work until it&#8217;s completed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b hotfix
Switched to a new branch 'hotfix'
$ vim index.html
$ git commit -a -m 'fixed the broken email address'
[hotfix 1fb7853] fixed the broken email address
 1 file changed, 2 insertions(+)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-branching-4.png" alt="Hotfix branch based on `master`.">
</div>
<div class="title">Figure 21. Hotfix branch based on <code>master</code></div>
</div>
<div class="paragraph">
<p>You can run your tests, make sure the hotfix is what you want, and merge it back into your master branch to deploy to production.
You do this with the <code>git merge</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
$ git merge hotfix
Updating f42c576..3a0874c
Fast-forward
 index.html | 2 ++
 1 file changed, 2 insertions(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice the phrase &#8220;fast-forward&#8221; in that merge.
Because the commit pointed to by the branch you merged in was directly upstream of the commit you&#8217;re on, Git simply moves the pointer forward.
To phrase that another way, when you try to merge one commit with a commit that can be reached by following the first commit&#8217;s history, Git simplifies things by moving the pointer forward because there is no divergent work to merge together – this is called a &#8220;fast-forward.&#8221;</p>
</div>
<div class="paragraph">
<p>Your change is now in the snapshot of the commit pointed to by the <code>master</code> branch, and you can deploy the fix.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-branching-5.png" alt="`master` is fast-forwarded to `hotfix`.">
</div>
<div class="title">Figure 22. <code>master</code> is fast-forwarded to <code>hotfix</code></div>
</div>
<div class="paragraph">
<p>After your super-important fix is deployed, you&#8217;re ready to switch back to the work you were doing before you were interrupted.
However, first you&#8217;ll delete the <code>hotfix</code> branch, because you no longer need it – the <code>master</code> branch points at the same place.
You can delete it with the <code>-d</code> option to <code>git branch</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -d hotfix
Deleted branch hotfix (3a0874c).</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can switch back to your work-in-progress branch on issue #53 and continue working on it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout iss53
Switched to branch "iss53"
$ vim index.html
$ git commit -a -m 'finished the new footer [issue 53]'
[iss53 ad82d7a] finished the new footer [issue 53]
1 file changed, 1 insertion(+)</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-branching-6.png" alt="Work continues on `iss53`.">
</div>
<div class="title">Figure 23. Work continues on <code>iss53</code></div>
</div>
<div class="paragraph">
<p>It&#8217;s worth noting here that the work you did in your <code>hotfix</code> branch is not contained in the files in your <code>iss53</code> branch.
If you need to pull it in, you can merge your <code>master</code> branch into your <code>iss53</code> branch by running <code>git merge master</code>, or you can wait to integrate those changes until you decide to pull the <code>iss53</code> branch back into <code>master</code> later.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_merging">Basic Merging</h4>
<div class="paragraph">
<p>
Suppose you&#8217;ve decided that your issue #53 work is complete and ready to be merged into your <code>master</code> branch.
In order to do that, you&#8217;ll merge in your <code>iss53</code> branch, much like you merged in your <code>hotfix</code> branch earlier.
All you have to do is check out the branch you wish to merge into and then run the <code>git merge</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
Switched to branch 'master'
$ git merge iss53
Merge made by the 'recursive' strategy.
README |    1 +
1 file changed, 1 insertion(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This looks a bit different than the <code>hotfix</code> merge you did earlier.
In this case, your development history has diverged from some older point.
Because the commit on the branch you&#8217;re on isn&#8217;t a direct ancestor of the branch you&#8217;re merging in, Git has to do some work.
In this case, Git does a simple three-way merge, using the two snapshots pointed to by the branch tips and the common ancestor of the two.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-merging-1.png" alt="Three snapshots used in a typical merge.">
</div>
<div class="title">Figure 24. Three snapshots used in a typical merge</div>
</div>
<div class="paragraph">
<p>Instead of just moving the branch pointer forward, Git creates a new snapshot that results from this three-way merge and automatically creates a new commit that points to it.
This is referred to as a merge commit, and is special in that it has more than one parent.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-merging-2.png" alt="A merge commit.">
</div>
<div class="title">Figure 25. A merge commit</div>
</div>
<div class="paragraph">
<p>It&#8217;s worth pointing out that Git determines the best common ancestor to use for its merge base; this is different than older tools like CVS or Subversion (before version 1.5), where the developer doing the merge had to figure out the best merge base for themselves.
This makes merging a heck of a lot easier in Git than in these other systems.</p>
</div>
<div class="paragraph">
<p>Now that your work is merged in, you have no further need for the <code>iss53</code> branch.
You can close the ticket in your ticket-tracking system, and delete the branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -d iss53</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_basic_merge_conflicts">Basic Merge Conflicts</h4>
<div class="paragraph">
<p>
Occasionally, this process doesn&#8217;t go smoothly.
If you changed the same part of the same file differently in the two branches you&#8217;re merging together, Git won&#8217;t be able to merge them cleanly.
If your fix for issue #53 modified the same part of a file as the <code>hotfix</code>, you&#8217;ll get a merge conflict that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge iss53
Auto-merging index.html
CONFLICT (content): Merge conflict in index.html
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git hasn&#8217;t automatically created a new merge commit.
It has paused the process while you resolve the conflict.
If you want to see which files are unmerged at any point after a merge conflict, you can run <code>git status</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
You have unmerged paths.
  (fix conflicts and run "git commit")

Unmerged paths:
  (use "git add &lt;file&gt;..." to mark resolution)

    both modified:      index.html

no changes added to commit (use "git add" and/or "git commit -a")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Anything that has merge conflicts and hasn&#8217;t been resolved is listed as unmerged.
Git adds standard conflict-resolution markers to the files that have conflicts, so you can open them manually and resolve those conflicts.
Your file contains a section that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD:index.html
&lt;div id="footer"&gt;contact : email.support@github.com&lt;/div&gt;
=======
&lt;div id="footer"&gt;
 please contact us at support@github.com
&lt;/div&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; iss53:index.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means the version in <code>HEAD</code> (your <code>master</code> branch, because that was what you had checked out when you ran your merge command) is the top part of that block (everything above the <code>=======</code>), while the version in your <code>iss53</code> branch looks like everything in the bottom part.
In order to resolve the conflict, you have to either choose one side or the other or merge the contents yourself.
For instance, you might resolve this conflict by replacing the entire block with this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;div id="footer"&gt;
please contact us at email.support@github.com
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This resolution has a little of each section, and the <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code>, <code>=======</code>, and <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code> lines have been completely removed.
After you&#8217;ve resolved each of these sections in each conflicted file, run <code>git add</code> on each file to mark it as resolved.
Staging the file marks it as resolved in Git.</p>
</div>
<div class="paragraph">
<p>If you want to use a graphical tool to resolve these issues, you can run <code>git mergetool</code>, which fires up an appropriate visual merge tool and walks you through the conflicts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git mergetool

This message is displayed because 'merge.tool' is not configured.
See 'git mergetool --tool-help' or 'git help config' for more details.
'git mergetool' will now attempt to use one of the following tools:
opendiff kdiff3 tkdiff xxdiff meld tortoisemerge gvimdiff diffuse diffmerge ecmerge p4merge araxis bc3 codecompare vimdiff emerge
Merging:
index.html

Normal merge conflict for 'index.html':
  {local}: modified file
  {remote}: modified file
Hit return to start merge resolution tool (opendiff):</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use a merge tool other than the default (Git chose <code>opendiff</code> in this case because the command was run on a Mac), you can see all the supported tools listed at the top after &#8220;one of the following tools.&#8221;
Just type the name of the tool you&#8217;d rather use.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you need more advanced tools for resolving tricky merge conflicts, we cover more on merging in <a href="#_advanced_merging">Advanced Merging</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After you exit the merge tool, Git asks you if the merge was successful.
If you tell the script that it was, it stages the file to mark it as resolved for you.
You can run <code>git status</code> again to verify that all conflicts have been resolved:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
All conflicts fixed but you are still merging.
  (use "git commit" to conclude merge)

Changes to be committed:

    modified:   index.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re happy with that, and you verify that everything that had conflicts has been staged, you can type <code>git commit</code> to finalize the merge commit.
The commit message by default looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">Merge branch 'iss53'

Conflicts:
    index.html
#
# It looks like you may be committing a merge.
# If this is not correct, please remove the file
#	.git/MERGE_HEAD
# and try again.


# Please enter the commit message for your changes. Lines starting
# with '#' will be ignored, and an empty message aborts the commit.
# On branch master
# All conflicts fixed but you are still merging.
#
# Changes to be committed:
#	modified:   index.html
#</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can modify that message with details about how you resolved the merge if you think it would be helpful to others looking at this merge in the future – why you did what you did, if it&#8217;s not obvious.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_branch_management">Branch Management</h3>
<div class="paragraph">
<p>
Now that you&#8217;ve created, merged, and deleted some branches, let&#8217;s look at some branch-management tools that will come in handy when you begin using branches all the time.</p>
</div>
<div class="paragraph">
<p>The <code>git branch</code> command does more than just create and delete branches.
If you run it with no arguments, you get a simple listing of your current branches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch
  iss53
* master
  testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>*</code> character that prefixes the <code>master</code> branch: it indicates the branch that you currently have checked out (i.e., the branch that <code>HEAD</code> points to).
This means that if you commit at this point, the <code>master</code> branch will be moved forward with your new work.
To see the last commit on each branch, you can run <code>git branch -v</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -v
  iss53   93b412c fix javascript issue
* master  7a98805 Merge branch 'iss53'
  testing 782fd34 add scott to the author list in the readmes</code></pre>
</div>
</div>
<div class="paragraph">
<p>The useful <code>--merged</code> and <code>--no-merged</code> options can filter this list to branches that you have or have not yet merged into the branch you&#8217;re currently on.
To see which branches are already merged into the branch you&#8217;re on, you can run <code>git branch --merged</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch --merged
  iss53
* master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because you already merged in <code>iss53</code> earlier, you see it in your list.
Branches on this list without the <code>*</code> in front of them are generally fine to delete with <code>git branch -d</code>; you&#8217;ve already incorporated their work into another branch, so you&#8217;re not going to lose anything.</p>
</div>
<div class="paragraph">
<p>To see all the branches that contain work you haven&#8217;t yet merged in, you can run <code>git branch --no-merged</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch --no-merged
  testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows your other branch.
Because it contains work that isn&#8217;t merged in yet, trying to delete it with <code>git branch -d</code> will fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -d testing
error: The branch 'testing' is not fully merged.
If you are sure you want to delete it, run 'git branch -D testing'.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you really do want to delete the branch and lose that work, you can force it with <code>-D</code>, as the helpful message points out.</p>
</div>
</div>
<div class="sect2">
<h3 id="_branching_workflows">Branching Workflows</h3>
<div class="paragraph">
<p>Now that you have the basics of branching and merging down, what can or should you do with them?
In this section, we&#8217;ll cover some common workflows that this lightweight branching makes possible, so you can decide if you would like to incorporate it into your own development cycle.</p>
</div>
<div class="sect3">
<h4 id="_long_running_branches">Long-Running Branches</h4>
<div class="paragraph">
<p>
Because Git uses a simple three-way merge, merging from one branch into another multiple times over a long period is generally easy to do.
This means you can have several branches that are always open and that you use for different stages of your development cycle; you can merge regularly from some of them into others.</p>
</div>
<div class="paragraph">
<p>Many Git developers have a workflow that embraces this approach, such as having only code that is entirely stable in their <code>master</code> branch – possibly only code that has been or will be released.
They have another parallel branch named <code>develop</code> or <code>next</code> that they work from or use to test stability – it isn&#8217;t necessarily always stable, but whenever it gets to a stable state, it can be merged into <code>master</code>.
It&#8217;s used to pull in topic branches (short-lived branches, like your earlier <code>iss53</code> branch) when they&#8217;re ready, to make sure they pass all the tests and don&#8217;t introduce bugs.</p>
</div>
<div class="paragraph">
<p>In reality, we&#8217;re talking about pointers moving up the line of commits you&#8217;re making.
The stable branches are farther down the line in your commit history, and the bleeding-edge branches are farther up the history.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/lr-branches-1.png" alt="A linear view of progressive-stability branching.">
</div>
<div class="title">Figure 26. A linear view of progressive-stability branching</div>
</div>
<div class="paragraph">
<p>It&#8217;s generally easier to think about them as work silos, where sets of commits graduate to a more stable silo when they&#8217;re fully tested.</p>
</div>
<div id="lrbranch_b" class="imageblock">
<div class="content">
<img src="images/lr-branches-2.png" alt="A ``silo'' view of progressive-stability branching.">
</div>
<div class="title">Figure 27. A &#8220;silo&#8221; view of progressive-stability branching</div>
</div>
<div class="paragraph">
<p>You can keep doing this for several levels of stability.
Some larger projects also have a <code>proposed</code> or <code>pu</code> (proposed updates) branch that has integrated branches that may not be ready to go into the <code>next</code> or <code>master</code> branch.
The idea is that your branches are at various levels of stability; when they reach a more stable level, they&#8217;re merged into the branch above them.
Again, having multiple long-running branches isn&#8217;t necessary, but it&#8217;s often helpful, especially when you&#8217;re dealing with very large or complex projects.</p>
</div>
</div>
<div class="sect3">
<h4 id="_topic_branch">Topic Branches</h4>
<div class="paragraph">
<p>
Topic branches, however, are useful in projects of any size.
A topic branch is a short-lived branch that you create and use for a single particular feature or related work.
This is something you&#8217;ve likely never done with a VCS before because it&#8217;s generally too expensive to create and merge branches.
But in Git it&#8217;s common to create, work on, merge, and delete branches several times a day.</p>
</div>
<div class="paragraph">
<p>You saw this in the last section with the <code>iss53</code> and <code>hotfix</code> branches you created.
You did a few commits on them and deleted them directly after merging them into your main branch.
This technique allows you to context-switch quickly and completely – because your work is separated into silos where all the changes in that branch have to do with that topic, it&#8217;s easier to see what has happened during code review and such.
You can keep the changes there for minutes, days, or months, and merge them in when they&#8217;re ready, regardless of the order in which they were created or worked on.</p>
</div>
<div class="paragraph">
<p>Consider an example of doing some work (on <code>master</code>), branching off for an issue (<code>iss91</code>), working on it for a bit, branching off the second branch to try another way of handling the same thing (<code>iss91v2</code>), going back to your master branch and working there for a while, and then branching off there to do some work that you&#8217;re not sure is a good idea (<code>dumbidea</code> branch).
Your commit history will look something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/topic-branches-1.png" alt="Multiple topic branches.">
</div>
<div class="title">Figure 28. Multiple topic branches</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s say you decide you like the second solution to your issue best (<code>iss91v2</code>); and you showed the <code>dumbidea</code> branch to your coworkers, and it turns out to be genius.
You can throw away the original <code>iss91</code> branch (losing commits <code>C5</code> and <code>C6</code>) and merge in the other two.
Your history then looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/topic-branches-2.png" alt="History after merging `dumbidea` and `iss91v2`.">
</div>
<div class="title">Figure 29. History after merging <code>dumbidea</code> and <code>iss91v2</code></div>
</div>
<div class="paragraph">
<p>We will go into more detail about the various possible workflows for your Git project in <a href="#_distributed_git">Distributed Git</a>, so before you decide which branching scheme your next project will use, be sure to read that chapter.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to remember when you&#8217;re doing all this that these branches are completely local.
When you&#8217;re branching and merging, everything is being done only in your Git repository – no server communication is happening.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_remote_branches">Remote Branches</h3>
<div class="paragraph">
<p>
Remote branches are references (pointers) to the state of branches in your remote repositories.
They&#8217;re local branches that you can&#8217;t move; they&#8217;re moved automatically for you whenever you do any network communication.
Remote branches act as bookmarks to remind you where the branches on your remote repositories were the last time you connected to them.</p>
</div>
<div class="paragraph">
<p>They take the form <code>(remote)/(branch)</code>.
For instance, if you wanted to see what the <code>master</code> branch on your <code>origin</code> remote looked like as of the last time you communicated with it, you would check the <code>origin/master</code> branch.
If you were working on an issue with a partner and they pushed up an <code>iss53</code> branch, you might have your own local <code>iss53</code> branch; but the branch on the server would point to the commit at <code>origin/iss53</code>.</p>
</div>
<div class="paragraph">
<p>This may be a bit confusing, so let&#8217;s look at an example.
Let&#8217;s say you have a Git server on your network at <code>git.ourcompany.com</code>.
If you clone from this, Git&#8217;s <code>clone</code> command automatically names it <code>origin</code> for you, pulls down all its data, creates a pointer to where its <code>master</code> branch is, and names it <code>origin/master</code> locally.
Git also gives you your own local <code>master</code> branch starting at the same place as origin&#8217;s <code>master</code> branch, so you have something to work from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">&#8220;origin&#8221; is not special</div>
<div class="paragraph">
<p>Just like the branch name &#8220;master&#8221; does not have any special meaning in Git, neither does &#8220;origin&#8221;. While &#8220;master&#8221; is the default name for a starting branch when you run <code>git init</code> which is the only reason it&#8217;s widely used, &#8220;origin&#8221; is the default name for a remote when you run <code>git clone</code>. If you run <code>git clone -o booyah</code> instead, then you will have <code>booyah/master</code> as your default remote branch.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/remote-branches-1.png" alt="Server and local repositories after cloning.">
</div>
<div class="title">Figure 30. Server and local repositories after cloning</div>
</div>
<div class="paragraph">
<p>If you do some work on your local master branch, and, in the meantime, someone else pushes to <code>git.ourcompany.com</code> and updates its <code>master</code> branch, then your histories move forward differently.
Also, as long as you stay out of contact with your origin server, your <code>origin/master</code> pointer doesn&#8217;t move.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/remote-branches-2.png" alt="Local and remote work can diverge.">
</div>
<div class="title">Figure 31. Local and remote work can diverge</div>
</div>
<div class="paragraph">
<p>To synchronize your work, you run a <code>git fetch origin</code> command.
This command looks up which server &#8220;origin&#8221; is (in this case, it&#8217;s <code>git.ourcompany.com</code>), fetches any data from it that you don&#8217;t yet have, and updates your local database, moving your <code>origin/master</code> pointer to its new, more up-to-date position.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/remote-branches-3.png" alt="`git fetch` updates your remote references.">
</div>
<div class="title">Figure 32. <code>git fetch</code> updates your remote references</div>
</div>
<div class="paragraph">
<p>To demonstrate having multiple remote servers and what remote branches for those remote projects look like, let&#8217;s assume you have another internal Git server that is used only for development by one of your sprint teams.
This server is at <code>git.team1.ourcompany.com</code>.
You can add it as a new remote reference to the project you&#8217;re currently working on by running the <code>git remote add</code> command as we covered in <a href="#_git_basics_chapter">Git 基础</a>.
Name this remote <code>teamone</code>, which will be your shortname for that whole URL.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/remote-branches-4.png" alt="Adding another server as a remote.">
</div>
<div class="title">Figure 33. Adding another server as a remote</div>
</div>
<div class="paragraph">
<p>Now, you can run <code>git fetch teamone</code> to fetch everything the remote <code>teamone</code> server has that you don&#8217;t have yet.
Because that server has a subset of the data your <code>origin</code> server has right now, Git fetches no data but sets a remote branch called <code>teamone/master</code> to point to the commit that <code>teamone</code> has as its <code>master</code> branch.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/remote-branches-5.png" alt="Remote tracking branch for `teamone/master`.">
</div>
<div class="title">Figure 34. Remote tracking branch for <code>teamone/master</code></div>
</div>
<div class="sect3">
<h4 id="_pushing_branches">Pushing</h4>
<div class="paragraph">
<p>
When you want to share a branch with the world, you need to push it up to a remote that you have write access to.
Your local branches aren&#8217;t automatically synchronized to the remotes you write to – you have to explicitly push the branches you want to share.
That way, you can use private branches for work you don&#8217;t want to share, and push up only the topic branches you want to collaborate on.</p>
</div>
<div class="paragraph">
<p>If you have a branch named <code>serverfix</code> that you want to work on with others, you can push it up the same way you pushed your first branch.
Run <code>git push (remote) (branch)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin serverfix
Counting objects: 24, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (15/15), done.
Writing objects: 100% (24/24), 1.91 KiB | 0 bytes/s, done.
Total 24 (delta 2), reused 0 (delta 0)
To https://github.com/schacon/simplegit
 * [new branch]      serverfix -&gt; serverfix</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a bit of a shortcut.
Git automatically expands the <code>serverfix</code> branchname out to <code>refs/heads/serverfix:refs/heads/serverfix</code>, which means, &#8220;Take my serverfix local branch and push it to update the remote&#8217;s serverfix branch.&#8221;
We&#8217;ll go over the <code>refs/heads/</code> part in detail in <a href="#_git_internals">Git Internals</a>, but you can generally leave it off.
You can also do <code>git push origin serverfix:serverfix</code>, which does the same thing – it says, &#8220;Take my serverfix and make it the remote&#8217;s serverfix.&#8221;
You can use this format to push a local branch into a remote branch that is named differently.
If you didn&#8217;t want it to be called <code>serverfix</code> on the remote, you could instead run <code>git push origin serverfix:awesomebranch</code> to push your local <code>serverfix</code> branch to the <code>awesomebranch</code> branch on the remote project.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Don&#8217;t type your password every time</div>
<div class="paragraph">
<p>If you&#8217;re using an HTTPS URL to push over, the Git server will ask you for your username and password for authentication. By default it will prompt you on the terminal for this information so the server can tell if you&#8217;re allowed to push.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to type it every single time you push, you can set up a &#8220;credential cache&#8221;. The simplest is just to keep it in memory for a few mintues, which you can easily set up by running <code>git config --global credential.helper cache</code>.</p>
</div>
<div class="paragraph">
<p>For more information on the various credential caching options available, see <a href="#_credential_caching">凭证存储</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next time one of your collaborators fetches from the server, they will get a reference to where the server&#8217;s version of <code>serverfix</code> is under the remote branch <code>origin/serverfix</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch origin
remote: Counting objects: 7, done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 3 (delta 0), reused 3 (delta 0)
Unpacking objects: 100% (3/3), done.
From https://github.com/schacon/simplegit
 * [new branch]      serverfix    -&gt; origin/serverfix</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that when you do a fetch that brings down new remote branches, you don&#8217;t automatically have local, editable copies of them.
In other words, in this case, you don&#8217;t have a new <code>serverfix</code> branch – you only have an <code>origin/serverfix</code> pointer that you can&#8217;t modify.</p>
</div>
<div class="paragraph">
<p>To merge this work into your current working branch, you can run <code>git merge origin/serverfix</code>.
If you want your own <code>serverfix</code> branch that you can work on, you can base it off your remote branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b serverfix origin/serverfix
Branch serverfix set up to track remote branch serverfix from origin.
Switched to a new branch 'serverfix'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives you a local branch that you can work on that starts where <code>origin/serverfix</code> is.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tracking_branches">Tracking Branches</h4>
<div class="paragraph">
<p>
Checking out a local branch from a remote branch automatically creates what is called a &#8220;tracking branch&#8221; (or sometimes an &#8220;upstream branch&#8221;).
Tracking branches are local branches that have a direct relationship to a remote branch.
If you&#8217;re on a tracking branch and type <code>git pull</code>, Git automatically knows which server to fetch from and branch to merge into.</p>
</div>
<div class="paragraph">
<p>When you clone a repository, it generally automatically creates a <code>master</code> branch that tracks <code>origin/master</code>.
However, you can set up other tracking branches if you wish – ones that track branches on other remotes, or don&#8217;t track the <code>master</code> branch.
The simple case is the example you just saw, running <code>git checkout -b [branch] [remotename]/[branch]</code>.
This is a common enough operation that git provides the <code>--track</code> shorthand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout --track origin/serverfix
Branch serverfix set up to track remote branch serverfix from origin.
Switched to a new branch 'serverfix'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To set up a local branch with a different name than the remote branch, you can easily use the first version with a different local branch name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b sf origin/serverfix
Branch sf set up to track remote branch serverfix from origin.
Switched to a new branch 'sf'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, your local branch <code>sf</code> will automatically pull from <code>origin/serverfix</code>.</p>
</div>
<div class="paragraph">
<p>If you already have a local branch and want to set it to a remote branch you just pulled down, or want to change the upstream branch you&#8217;re tracking, you can use the <code>-u</code> or <code>--set-upstream-to</code> option to <code>git branch</code> to explicitly set it at any time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -u origin/serverfix
Branch serverfix set up to track remote branch serverfix from origin.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Upstream shorthand</div>
<div class="paragraph">
<p>When you have an tracking branch set up, you can reference it with the <code>@{upstream}</code> or <code>@{u}</code> shorthand. So if you&#8217;re on the <code>master</code> branch and it&#8217;s tracking <code>origin/master</code>, you can say something like <code>git merge @{u}</code> instead of <code>git merge origin/master</code> if you wish.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to see what tracking branches you have set up, you can use the <code>-vv</code> option to <code>git branch</code>. This will list out your local branches with more information including what each branch is tracking and if your local branch is ahead, behind or both.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -vv
  iss53     7e424c3 [origin/iss53: ahead 2] forgot the brackets
  master    1ae2a45 [origin/master] deploying index fix
* serverfix f8674d9 [teamone/server-fix-good: ahead 3, behind 1] this should do it
  testing   5ea463a trying something new</code></pre>
</div>
</div>
<div class="paragraph">
<p>So here we can see that our <code>iss53</code> branch is tracking <code>origin/iss53</code> and is &#8220;ahead&#8221; by two, meaning that we have two commits locally that are not pushed to the server. We can also see that our <code>master</code> branch is tracking <code>origin/master</code> and is up to date. Next we can see that our <code>serverfix</code> branch is tracking the <code>server-fix-good</code> branch on our <code>teamone</code> server and is ahead by three and behind by one, meaning that there is one commit on the server we haven&#8217;t merged in yet and three commits locally that we haven&#8217;t pushed. Finally we can see that our <code>testing</code> branch is not tracking any remote branch.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that these numbers are only since the last time you fetched from each server. This command does not reach out to the servers, it&#8217;s telling you about what it has cached from these servers locally. If you want totally up to date ahead and behind numbers, you&#8217;ll need to fetch from all your remotes right before running this. You could do that like this: <code>$ git fetch --all; git branch -vv</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_pulling">Pulling</h4>
<div class="paragraph">
<p>
While the <code>git fetch</code> command will fetch down all the changes on the server that you don&#8217;t have yet, it will not modify your working directory at all.
It will simply get the data for you and let you merge it yourself.
However, there is a command called <code>git pull</code> which is essentially a <code>git fetch</code> immediately followed by a <code>git merge</code> in most cases.
If you have a tracking branch set up as demonstrated in the last section, either by explicitly setting it or by having it created for you by the <code>clone</code> or <code>checkout</code> commands, <code>git pull</code> will look up what server and branch your current branch is tracking, fetch from that server and then try to merge in that remote branch.</p>
</div>
<div class="paragraph">
<p>Generally it&#8217;s better to simply use the <code>fetch</code> and <code>merge</code> commands explicitly as the magic of <code>git pull</code> can often be confusing.</p>
</div>
</div>
<div class="sect3">
<h4 id="_delete_branches">Deleting Remote Branches</h4>
<div class="paragraph">
<p>
Suppose you&#8217;re done with a remote branch – say you and your collaborators are finished with a feature and have merged it into your remote&#8217;s <code>master</code> branch (or whatever branch your stable codeline is in).
You can delete a remote branch using the <code>--delete</code> option to <code>git push</code>.
If you want to delete your <code>serverfix</code> branch from the server, you run the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin --delete serverfix
To https://github.com/schacon/simplegit
 - [deleted]         serverfix</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basically all this does is remove the pointer from the server. The Git server will generally keep the data there for a while until a garbage collection runs, so if it was accidentally deleted, it&#8217;s often easy to recover.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rebasing">衍合</h3>
<div class="paragraph">
<p>
在 Git 中整合来自不同分支的修改主要有两种方法：<code>merge</code> 以及 <code>rebase</code>。
在本节中我们将学习什么是“衍合”，怎样使用“衍合”，并将展示该操作的惊艳之处，以及指出在何种情况下您应避免使用它。</p>
</div>
<div class="sect3">
<h4 id="_衍合的基本操作">衍合的基本操作</h4>
<div class="paragraph">
<p>请回顾之前在 <a href="#_basic_merging">Basic Merging</a> 中的一个例子，您会看到开发任务分叉到两个不同分支，又各自提交了更新。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-rebase-1.png" alt="分叉的提交历史">
</div>
<div class="title">Figure 35. 分叉的提交历史</div>
</div>
<div class="paragraph">
<p>之前介绍过，整合分支最容易的方法是 <code>merge</code> 命令。
它会把两个分支的最新快照（<code>C3</code> 和 <code>C4</code>）以及二者最近的共同祖先（<code>C2</code>）进行三方合并，合并的结果是生成一个新的快照（并提交）。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-rebase-2.png" alt="通过合并操作来整合分叉了的历史">
</div>
<div class="title">Figure 36. 通过合并操作来整合分叉了的历史</div>
</div>
<div class="paragraph">
<p>其实，还有一种方法：您可以提取在 <code>C4</code> 中引入的补丁和修改，然后在 <code>C3</code> 的基础上再应用一次。
在 Git 中，这种操作就叫做 <em>衍合</em>。
您可以使用 <code>rebase</code> 命令将提交到某一分支上的所有修改都移至另一分支上，就好像“重新播放”一样。</p>
</div>
<div class="paragraph">
<p>在上面这个例子中，运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout experiment
$ git rebase master
First, rewinding head to replay your work on top of it...
Applying: added staged command</code></pre>
</div>
</div>
<div class="paragraph">
<p>它的原理是首先找到这两个分支（即当前分支 <code>experiment</code>、衍合操作的目标基底分支 <code>master</code>）的最近共同祖先 <code>C2</code>，然后对比当前分支相对于该祖先的历次提交，提取相应的修改并存为临时文件，然后将当前分支指向目标基底 <code>C3</code>, 最后以此将之前另存为临时文件的修改依序应用。（译注：写明了 commit id，以便理解，下同）</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-rebase-3.png" alt="将 `C4` 中的修改衍合到 `C3` 上">
</div>
<div class="title">Figure 37. 将 <code>C4</code> 中的修改衍合到 <code>C3</code> 上</div>
</div>
<div class="paragraph">
<p>现在回到 <code>master</code> 分支，进行一次快进合并。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
$ git merge experiment</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/basic-rebase-4.png" alt="master 分支的快进合并">
</div>
<div class="title">Figure 38. master 分支的快进合并</div>
</div>
<div class="paragraph">
<p>此时，<code>C4'</code> 指向的快照就和上面使用 <code>merge</code> 命令的例子中 <code>C5</code> 指向的快照一模一样了。
这两种整合方法的最终结果没有任何区别，但是衍合使得提交历史更加整洁。
您在查看一个经过衍合的分支的历史记录时会发现，尽管实际的开发工作是并行的，但它们看上去就像是先后串行的一样，提交历史是一条直线没有分叉。</p>
</div>
<div class="paragraph">
<p>一般我们这样做的目的是为了确保在向远程分支推送时能保持提交历史的整洁——例如向某个别人维护的项目贡献代码时。
在这种情况下，您首先在自己的分支里进行开发，当开发完成时您需要先将您的代码衍合到 <code>origin/master</code> 上，然后再向主项目提交修改。
这样的话，该项目的维护者就不再需要进行整合工作，只需要快进合并便可。</p>
</div>
<div class="paragraph">
<p>请注意，无论是通过衍合，还是通过三方合并，整合的最终结果所指向的快照始终是一样的，只不过提交历史不同罢了。
衍合是将一系列提交按照原有次序依次应用到另一分支上，而合并是把最终结果合在一起。</p>
</div>
</div>
<div class="sect3">
<h4 id="_更有趣的衍合例子">更有趣的衍合例子</h4>
<div class="paragraph">
<p>在对两个分支进行衍合时，所生成的“重演”并不一定要在目标分支上应用，您也可以指定另外的一个分支进行应用。
就像 <a href="#rbdiag_e">从一个特性分支里再分出一个特性分支的提交历史</a> 中的例子这样。
您创建了一个特性分支 <code>server</code>，为服务端添加了一些功能，提交了 <code>C3</code> 和 <code>C4</code>。
然后从 <code>C3</code> 上创建了特性分支 <code>client</code>，为客户端添加了一些功能，提交了 <code>C8</code> 和 <code>C9</code>。
最后，您回到 <code>server</code> 分支，又提交了 <code>C10</code>。</p>
</div>
<div id="rbdiag_e" class="imageblock">
<div class="content">
<img src="images/interesting-rebase-1.png" alt="从一个特性分支里再分出一个特性分支的提交历史">
</div>
<div class="title">Figure 39. 从一个特性分支里再分出一个特性分支的提交历史</div>
</div>
<div class="paragraph">
<p>假设您希望将 <code>client</code> 中的修改合并到主分支并发布，但暂时并不想合并 <code>server</code> 中的修改，因为它们还需要经过更全面的测试。
这时，您就可以使用 <code>git rebase</code> 命令的 <code>--onto</code> 选项，选中在 <code>client</code> 分支里但不在 <code>server</code> 分支里的修改（即 <code>C8</code> 和 <code>C9</code>），将它们在 <code>master</code> 分支上重演：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase --onto master server client</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上命令的意思是：“取出 <code>client</code> 分支，找出处于 <code>client</code> 分支和 <code>server</code> 分支的共同祖先之后的修改，然后把它们在 <code>master</code> 分支上重演一遍”。
这理解起来有一点复杂，不过效果非常酷。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/interesting-rebase-2.png" alt="截取特性分支上的另一个特性分支，然后衍合到其他分支">
</div>
<div class="title">Figure 40. 截取特性分支上的另一个特性分支，然后衍合到其他分支</div>
</div>
<div class="paragraph">
<p>现在可以快进合并 <code>master</code> 分支了。（如图 <a href="#rbdiag_g">快进合并 master 分支，使之包含来自 client 分支的修改</a>）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
$ git merge client</code></pre>
</div>
</div>
<div id="rbdiag_g" class="imageblock">
<div class="content">
<img src="images/interesting-rebase-3.png" alt="快进合并 master 分支，使之包含来自 client 分支的修改">
</div>
<div class="title">Figure 41. 快进合并 master 分支，使之包含来自 client 分支的修改</div>
</div>
<div class="paragraph">
<p>接下来您决定将 <code>server</code> 分支中的修改也整合进来。
使用 <code>git rebase [basebranch] [topicbranch]</code> 命令可以直接将特性分支（即本例中的 <code>server</code>）衍合到目标分支（即 <code>master</code>）上。这样做能省去您先切换到 <code>server</code> 分支，再对其执行衍合命令的多个步骤。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase master server</code></pre>
</div>
</div>
<div class="paragraph">
<p>如图 <a href="#rbdiag_h">将 server 中的修改衍合到 master 上</a> 所示，<code>server</code> 中的代码被“续”到了 <code>master</code> 后面。</p>
</div>
<div id="rbdiag_h" class="imageblock">
<div class="content">
<img src="images/interesting-rebase-4.png" alt="将 server 中的修改衍合到 master 上">
</div>
<div class="title">Figure 42. 将 server 中的修改衍合到 master 上</div>
</div>
<div class="paragraph">
<p>然后就可以快进合并主分支 master 了：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
$ git merge server</code></pre>
</div>
</div>
<div class="paragraph">
<p>至此，<code>client</code> 和 <code>server</code> 分支中的修改都已经整合到主分支里去了，您可以删除这两个分支，最终提交历史会变成图 <a href="#rbdiag_i">最终的提交历史</a> 中的样子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -d client
$ git branch -d server</code></pre>
</div>
</div>
<div id="rbdiag_i" class="imageblock">
<div class="content">
<img src="images/interesting-rebase-5.png" alt="最终的提交历史">
</div>
<div class="title">Figure 43. 最终的提交历史</div>
</div>
</div>
<div class="sect3">
<h4 id="_rebase_peril">衍合的风险</h4>
<div class="paragraph">
<p>
呃，奇妙的衍合也并非完美无缺，要用它得遵守一条准则：</p>
</div>
<div class="paragraph">
<p><strong>不要对在您的仓库外有副本的分支执行衍合。</strong></p>
</div>
<div class="paragraph">
<p>如果你遵循这条金科玉律，就不会出差错。
否则，人民群众会仇恨你，你的朋友和家人也会嘲笑你，唾弃你。</p>
</div>
<div class="paragraph">
<p>衍合操作的实质是丢弃一些现有的提交，然后相应地新建一些内容一样但实际上不同的提交。
如果您已经将提交推送至某个仓库，而其他人也已经从该仓库拉取提交并进行了后续工作，此时，如果您用 <code>git rebase</code> 命令重新整理了提交并再次推送，您的同伴因此将不得不再次将他们手头的工作与您的提交进行整合，如果接下来您还要拉取并整合他们修改过的提交，事情就会变得一团糟。</p>
</div>
<div class="paragraph">
<p>让我们来看一个在公开的仓库上执行衍合操作所带来的问题。
假设您从一个中央服务器克隆然后在它的基础上进行了一些开发。
您的提交历史如图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/perils-of-rebasing-1.png" alt="克隆一个仓库，然后在它的基础上进行了一些开发">
</div>
<div class="title">Figure 44. 克隆一个仓库，然后在它的基础上进行了一些开发</div>
</div>
<div class="paragraph">
<p>然后，某人又向中央服务器提交了一些修改，其中还包括一次合并。
您抓取了这些在远程分支上的修改，并将其合并到您本地的开发分支，然后您的提交历史就会变成这样：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/perils-of-rebasing-2.png" alt="抓取别人的提交，合并到自己的开发分支">
</div>
<div class="title">Figure 45. 抓取别人的提交，合并到自己的开发分支</div>
</div>
<div class="paragraph">
<p>接下来，这个人又决定把合并操作回滚，改用衍合；继而又用 <code>git push --force</code> 命令覆盖了服务器上的提交历史。
之后您从服务器抓取更新，会发现多出来一些新的提交。</p>
</div>
<div id="_pre_merge_rebase_work" class="imageblock">
<div class="content">
<img src="images/perils-of-rebasing-3.png" alt="有人推送了经过衍合的提交，并丢弃了您的本地开发所基于的一些提交">
</div>
<div class="title">Figure 46. 有人推送了经过衍合的提交，并丢弃了您的本地开发所基于的一些提交</div>
</div>
<div class="paragraph">
<p>结果就是你们两人的处境都十分尴尬。
如果您执行 <code>git pull</code> 命令，您将合并来自两条提交历史的内容，生成一个新的合并提交，最终仓库会如图所示：</p>
</div>
<div id="_merge_rebase_work" class="imageblock">
<div class="content">
<img src="images/perils-of-rebasing-4.png" alt="您将相同的内容又合并了一次，生成了一个新的提交">
</div>
<div class="title">Figure 47. 您将相同的内容又合并了一次，生成了一个新的提交</div>
</div>
<div class="paragraph">
<p>此时如果您执行 <code>git log</code> 命令，您会发现有两个提交的作者、日期、日志居然是一样的，这会令人感到混乱。
此外，如果您将这一堆又推送到服务器上，您实际上是将那些已经被衍合抛弃的提交又找了回来，这会令人感到更加混乱。
很明显对方并不想在提交历史中看到 <code>C4</code> 和 <code>C6</code>，因为之前就是她把这两个提交通过衍合丢弃的。</p>
</div>
</div>
<div class="sect3">
<h4 id="_rebase_rebase">用衍合解决衍合</h4>
<div class="paragraph">
<p>如果您*真的*遭遇了类似的处境，Git 还有一些高级魔法可以帮到您。如果团队中的某人强制推送并覆盖了一些您所基于的提交，您需要做的就是检查您做了哪些修改，以及他们覆盖了哪些修改。</p>
</div>
<div class="paragraph">
<p>实际上，Git 除了对整个提交计算 SHA 校验和以外，也对本次提交所引入的修改计算了校验和——即 &#8220;patch-id&#8221;。</p>
</div>
<div class="paragraph">
<p>如果您拉取被覆盖过的更新并将您手头的工作基于此进行衍合的话，一般情况下 Git 都能成功分辨出哪些是您的修改，并把它们应用到新分支上。</p>
</div>
<div class="paragraph">
<p>举个例子，如果遇到前面提到的 <a href="#_pre_merge_rebase_work">有人推送了经过衍合的提交，并丢弃了您的本地开发所基于的一些提交</a> 那种情境，如果我们不是执行合并，而是执行 <code>git rebase teamone/master</code>, Git 将会：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>检查哪些提交是我们的分支上独有的（C2，C3，C4，C6，C7）</p>
</li>
<li>
<p>检查其中哪些提交不是合并操作的结果（C2，C3，C4）</p>
</li>
<li>
<p>检查哪些提交在对方覆盖更新时并没有被纳入目标分支（只有 C2 和 C3，因为 C4 其实就是 C4'）</p>
</li>
<li>
<p>把查到的这些提交应用在 <code>teamone/master</code> 上面</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>从而我们将得到与 <a href="#_merge_rebase_work">您将相同的内容又合并了一次，生成了一个新的提交</a> 中不同的结果，如图 <a href="#_rebase_rebase_work">在一个被衍合然后强制推送的分支上再次执行衍合</a> 所示。</p>
</div>
<div id="_rebase_rebase_work" class="imageblock">
<div class="content">
<img src="images/perils-of-rebasing-5.png" alt="在一个被衍合然后强制推送的分支上再次执行衍合">
</div>
<div class="title">Figure 48. 在一个被衍合然后强制推送的分支上再次执行衍合</div>
</div>
<div class="paragraph">
<p>要想上述方案有效，还需要对方在衍合时确保 C4' 和 C4 是几乎一样的。否则衍合操作将无法识别，并新建另一个类似 C4 的补丁（而这个补丁很可能无法整洁的整合入历史，因为补丁中的修改已经存在于某个地方了）。</p>
</div>
<div class="paragraph">
<p>在本例中另一种简单的方法是使用 <code>git pull --rebase</code> 命令而不是直接 <code>git pull</code>。又或者您可以自己手动完成这个过程，先 <code>git fetch</code>，再 <code>git rebase teamone/master</code>。</p>
</div>
<div class="paragraph">
<p>如果您习惯使用 <code>git pull</code> ，同时又希望默认使用选项 <code>--rebase</code>，您可以执行这条语句 <code>git config --global pull.rebase true</code> 来更改 <code>pull.rebase</code> 的默认配置。</p>
</div>
<div class="paragraph">
<p>只要您把衍合命令当作是在推送前清理提交使之整洁的工具，并且只在从未推送至共用仓库的提交上执行衍合命令，您就不会有事。
假如您在那些已经被推送至共用仓库的提交上执行衍合命令，并因此丢弃了一些别人的开发所基于的提交，那您就有大麻烦了，您的同事也会因此鄙视您。</p>
</div>
<div class="paragraph">
<p>如果您或您的同事在某些情形下决意要这么做，请一定要通知每个人执行 <code>git pull --rebase</code> 命令，这样尽管不能避免伤痛，但能有所缓解。</p>
</div>
</div>
<div class="sect3">
<h4 id="_衍合_vs_合并">衍合 vs. 合并</h4>
<div class="paragraph">
<p>
至此，您已在实战中学习了衍合和合并的用法，您一定会想问，到底哪种方式更好。
在回答这个问题之前，让我们退后一步，想讨论一下提交历史到底意味着什么。</p>
</div>
<div class="paragraph">
<p>有一种观点认为，仓库的提交历史即是*记录实际发生过什么*。
它是针对历史的文档，本身就有价值，不能乱改。
从这个角度看来，改变提交历史是一种亵渎，您使用_谎言_掩盖了实际发生过的事情。
如果由合并产生的提交历史是一团糟怎么办？
既然事实就是如此，那么这些痕迹就应该被保留下来，让后人能够查阅。</p>
</div>
<div class="paragraph">
<p>另一种观点则正好相反，他们认为提交历史是*项目过程中发生的故事*。
没人会出版一本书的第一批草稿，软件维护手册也是需要反复修订才能方便使用。
持这一观点的人会使用 rebase 及 filter-branch 等工具来编写故事，怎么方便后来的读者就怎么写。</p>
</div>
<div class="paragraph">
<p>现在，让我们回到之前的问题上来，到底合并还是衍合好？希望您能明白，并没有一个简单的答案。
Git 是一个非常强大的工具，它允许您对提交历史做许多事情，但每个团队、每个项目对此的需求并不相同。
既然您已经分别学习了两者的用法，相信您能够根据实际情况作出明智的选择。</p>
</div>
<div class="paragraph">
<p>总的原则是，只对尚未推送或分享给别人的本地修改执行衍合操作清理历史，从不对已推送至别处的提交执行衍合操作，这样，您才能享受到两种方式带来的便利。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_总结_3">总结</h3>
<div class="paragraph">
<p>我们已经讲完了 Git 分支与合并的基础知识。
您现在应该能自如地创建并切换至新分支、在不同分支之间切换以及合并本地分支。
您现在应该也能通过推送您的分支至共享服务以分享它们、使用共享分支与他人协作以及在共享之前使用变基操作合并您的分支。
下一章，我们将要讲到，如果您想要运行自己的 Git 仓库托管服务器，您需要知道些什么。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_伺服器上的_git">伺服器上的 Git</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
到目前为止，您应该已经有办法使用 Git 来完成日常工作。
然而，为了使用 Git 协作功能，您还需要有远程的 Git 仓库。
尽管在技术上您可以从个人仓库进行推送（push）和拉取（pull）来修改内容，但不鼓励使用这种方法，因为一不留心就很容易弄混其他人的进度。
此外，您希望您的合作者们即使在您的电脑未联机时亦能存取仓库 — 拥有一个更可靠的公用仓库十分有用。
因此，与他人合作的最佳方法即是建立一个您与合作者们都有权利访问，且可从那里推送和拉取资料的共用仓库。</p>
</div>
<div class="paragraph">
<p>架设一台 Git 伺服器并不难。
首先，选择您希望伺服器使用的通讯协议。
在本章第一节将介绍可用的协议以及各自优缺点。
下面一节将解释使用那些协议的典型设置及如何在您的伺服器上运行。
最后，如果您不介意托管您的代码在其他人的伺服器，且不想经历设置与维护自己伺服器的麻烦，可以试试我们介绍的几个仓库托管服务。</p>
</div>
<div class="paragraph">
<p>如果您对架设自己的伺服器没兴趣，可以跳到本章最后一节去看看如何申请一个代码托管服务的帐户然后继续下一章，我们会在那里讨论分散式源码控制环境的林林总总。</p>
</div>
<div class="paragraph">
<p>一个远程仓库通常只是一个裸仓库（<em>bare repository</em>）— 即一个没有当前工作目录的仓库。
因为该仓库仅仅作为合作媒介，不需要从磁碟检查快照；存放的只有 Git 的资料。
简单的说，裸仓库就是您专案目录内的 <code>.git</code> 子目录内容，不包含其他资料。</p>
</div>
<div class="sect2">
<h3 id="_the_protocols">The Protocols</h3>
<div class="paragraph">
<p>Git can use four major protocols to transfer data: Local, HTTP, Secure Shell (SSH) and Git.
Here we&#8217;ll discuss what they are and in what basic circumstances you would want (or not want) to use them.</p>
</div>
<div class="sect3">
<h4 id="_local_protocol">Local Protocol</h4>
<div class="paragraph">
<p>
The most basic is the <em>Local protocol</em>, in which the remote repository is in another directory on disk.
This is often used if everyone on your team has access to a shared filesystem such as an NFS mount, or in the less likely case that everyone logs in to the same computer.
The latter wouldn&#8217;t be ideal, because all your code repository instances would reside on the same computer, making a catastrophic loss much more likely.</p>
</div>
<div class="paragraph">
<p>If you have a shared mounted filesystem, then you can clone, push to, and pull from a local file-based repository.
To clone a repository like this or to add one as a remote to an existing project, use the path to the repository as the URL.
For example, to clone a local repository, you can run something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone /opt/git/project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone file:///opt/git/project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git operates slightly differently if you explicitly specify <code>file://</code> at the beginning of the URL.
If you just specify the path, Git tries to use hardlinks or directly copy the files it needs.
If you specify <code>file://</code>, Git fires up the processes that it normally uses to transfer data over a network which is generally a lot less efficient method of transferring the data.
The main reason to specify the <code>file://</code> prefix is if you want a clean copy of the repository with extraneous references or objects left out – generally after an import from another version-control system or something similar (see <a href="#_git_internals">Git Internals</a> for maintenance tasks).
We&#8217;ll use the normal path here because doing so is almost always faster.</p>
</div>
<div class="paragraph">
<p>To add a local repository to an existing Git project, you can run something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add local_proj /opt/git/project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you can push to and pull from that remote as though you were doing so over a network.</p>
</div>
<div class="sect4">
<h5 id="_the_pros">The Pros</h5>
<div class="paragraph">
<p>The pros of file-based repositories are that they&#8217;re simple and they use existing file permissions and network access.
If you already have a shared filesystem to which your whole team has access, setting up a repository is very easy.
You stick the bare repository copy somewhere everyone has shared access to and set the read/write permissions as you would for any other shared directory.
We&#8217;ll discuss how to export a bare repository copy for this purpose in <a href="#_git_on_the_server">Getting Git on a Server</a>.</p>
</div>
<div class="paragraph">
<p>This is also a nice option for quickly grabbing work from someone else&#8217;s working repository.
If you and a co-worker are working on the same project and they want you to check something out, running a command like <code>git pull /home/john/project</code> is often easier than them pushing to a remote server and you pulling down.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_cons">The Cons</h5>
<div class="paragraph">
<p>The cons of this method are that shared access is generally more difficult to set up and reach from multiple locations than basic network access.
If you want to push from your laptop when you&#8217;re at home, you have to mount the remote disk, which can be difficult and slow compared to network-based access.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also important to mention that this isn&#8217;t necessarily the fastest option if you&#8217;re using a shared mount of some kind.
A local repository is fast only if you have fast access to the data.
A repository on NFS is often slower than the repository over SSH on the same server, allowing Git to run off local disks on each system.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_http_protocols">The HTTP Protocols</h4>
<div class="paragraph">
<p>Git can communicate over HTTP in two different modes.
Prior to Git 1.6.6 there was only one way it could do this which was very simple and generally read-only.
In version 1.6.6 a new, smarter protocol was introduced that involved Git being able to intelligently negotiate data transfer in a manner similar to how it does over SSH.
In the last few years, this new HTTP protocol has become very popular since it&#8217;s simpler for the user and smarter about how it communicates.
The newer version is often referred to as the &#8220;Smart&#8221; HTTP protocol and the older way as &#8220;Dumb&#8221; HTTP.
We&#8217;ll cover the newer &#8220;smart&#8221; HTTP protocol first.</p>
</div>
<div class="sect4">
<h5 id="_smart_http">Smart HTTP</h5>
<div class="paragraph">
<p>
The &#8220;smart&#8221; HTTP protocol operates very similarly to the SSH or Git protocols but runs over standard HTTP/S ports and can use various HTTP authentication mechanisms, meaning it&#8217;s often easier on the user than something like SSH, since you can use things like username/password basic authentication rather than having to set up SSH keys.</p>
</div>
<div class="paragraph">
<p>It has probably become the most popular way to use Git now, since it can be set up to both serve anonymously like the <code>git://</code> protocol, and can also be pushed over with authentication and encryption like the SSH protocol. Instead of having to set up different URLs for these things, you can now use a single URL for both. If you try to push and the repository requires authentication (which it normally should), the server can prompt for a username and password. The same goes for read access.</p>
</div>
<div class="paragraph">
<p>In fact, for services like GitHub, the URL you use to view the repository online (for example, &#8220;<a href="https://github.com/schacon/simplegit" class="bare">https://github.com/schacon/simplegit</a>&#8221;) is the same URL you can use to clone and, if you have access, push over.</p>
</div>
</div>
<div class="sect4">
<h5 id="_dumb_http">Dumb HTTP</h5>
<div class="paragraph">
<p>
If the server does not respond with a Git HTTP smart service, the Git client will try to fall back to the simpler &#8220;dumb&#8221; HTTP protocol.
The Dumb protocol expects the bare Git repository to be served like normal files from the web server.
The beauty of the Dumb HTTP protocol is the simplicity of setting it up.
Basically, all you have to do is put a bare Git repository under your HTTP document root and set up a specific <code>post-update</code> hook, and you&#8217;re done (See <a href="#_git_hooks">Git Hooks</a>).
At that point, anyone who can access the web server under which you put the repository can also clone your repository.
To allow read access to your repository over HTTP, do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd /var/www/htdocs/
$ git clone --bare /path/to/git_project gitproject.git
$ cd gitproject.git
$ mv hooks/post-update.sample hooks/post-update
$ chmod a+x hooks/post-update</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all.
The <code>post-update</code> hook that comes with Git by default runs the appropriate command (<code>git update-server-info</code>) to make HTTP fetching and cloning work properly.
This command is run when you push to this repository (over SSH perhaps); then, other people can clone via something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://example.com/gitproject.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this particular case, we&#8217;re using the <code>/var/www/htdocs</code> path that is common for Apache setups, but you can use any static web server – just put the bare repository in its path.
The Git data is served as basic static files (see <a href="#_git_internals">Git Internals</a> for details about exactly how it&#8217;s served).</p>
</div>
<div class="paragraph">
<p>Generally you would either choose to run a read/write Smart HTTP server or simply have the files accessible as read-only in the Dumb manner. It&#8217;s rare to run a mix of the two services.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_pros_2">The Pros</h5>
<div class="paragraph">
<p>We&#8217;ll concentrate on the pros of the Smart version of the HTTP protocol.</p>
</div>
<div class="paragraph">
<p>The simplicity of having a single URL for all types of access and having the server prompt only when authentication is needed makes things very easy for the end user.
Being able to authenticate with a username and password is also a big advantage over SSH, since users don&#8217;t have to generate SSH keys locally and upload their public key to the server before being able to interact with it.
For less sophisticated users, or users on systems where SSH is less common, this is a major advantage in usability.
It is also a very fast and efficient protocol, similar to the SSH one.</p>
</div>
<div class="paragraph">
<p>You can also serve your repositories read-only over HTTPS, which means you can encrypt the content transfer; or you can go so far as to make the clients use specific signed SSL certificates.</p>
</div>
<div class="paragraph">
<p>Another nice thing is that HTTP/S are such commonly used protocols that corporate firewalls are often set up to allow traffic through these ports.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_cons_2">The Cons</h5>
<div class="paragraph">
<p>Git over HTTP/S can be a little more tricky to set up compared to SSH on some servers.
Other than that, there is very little advantage that other protocols have over the &#8220;Smart&#8221; HTTP protocol for serving Git.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using HTTP for authenticated pushing, providing your credentials is sometimes more complicated than using keys over SSH. There are however several credential caching tools you can use, including Keychain access on OSX and Credential Manager on Windows, to make this pretty painless. Read <a href="#_credential_caching">凭证存储</a> to see how to set up secure HTTP password caching on your system.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_ssh_protocol">The SSH Protocol</h4>
<div class="paragraph">
<p>
A common transport protocol for Git when self-hosting is over SSH.
This is because SSH access to servers is already set up in most places – and if it isn&#8217;t, it&#8217;s easy to do.
SSH is also an authenticated network protocol; and because it&#8217;s ubiquitous, it&#8217;s generally easy to set up and use.</p>
</div>
<div class="paragraph">
<p>To clone a Git repository over SSH, you can specify ssh:// URL like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone ssh://user@server/project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can use the shorter scp-like syntax for the SSH protocol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone user@server:project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also not specify a user, and Git assumes the user you&#8217;re currently logged in as.</p>
</div>
<div class="sect4">
<h5 id="_the_pros_3">The Pros</h5>
<div class="paragraph">
<p>The pros of using SSH are many.
First, SSH is relatively easy to set up – SSH daemons are commonplace, many network admins have experience with them, and many OS distributions are set up with them or have tools to manage them.
Next, access over SSH is secure – all data transfer is encrypted and authenticated.
Last, like the HTTP/S, Git and Local protocols, SSH is efficient, making the data as compact as possible before transferring it.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_cons_3">The Cons</h5>
<div class="paragraph">
<p>The negative aspect of SSH is that you can&#8217;t serve anonymous access of your repository over it.
People must have access to your machine over SSH to access it, even in a read-only capacity, which doesn&#8217;t make SSH access conducive to open source projects.
If you&#8217;re using it only within your corporate network, SSH may be the only protocol you need to deal with.
If you want to allow anonymous read-only access to your projects and also want to use SSH, you’ll have to set up SSH for you to push over but something else for others to fetch over.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_git_protocol">The Git Protocol</h4>
<div class="paragraph">
<p>
Next is the Git protocol.
This is a special daemon that comes packaged with Git; it listens on a dedicated port (9418) that provides a service similar to the SSH protocol, but with absolutely no authentication.
In order for a repository to be served over the Git protocol, you must create the <code>git-daemon-export-ok</code> file – the daemon won&#8217;t serve a repository without that file in it – but other than that there is no security.
Either the Git repository is available for everyone to clone or it isn&#8217;t.
This means that there is generally no pushing over this protocol.
You can enable push access; but given the lack of authentication, if you turn on push access, anyone on the internet who finds your project&#8217;s URL could push to your project.
Suffice it to say that this is rare.</p>
</div>
<div class="sect4">
<h5 id="_the_pros_4">The Pros</h5>
<div class="paragraph">
<p>The Git protocol is often the fastest network transfer protocol available.
If you’re serving a lot of traffic for a public project or serving a very large project that doesn&#8217;t require user authentication for read access, it’s likely that you&#8217;ll want to set up a Git daemon to serve your project.
It uses the same data-transfer mechanism as the SSH protocol but without the encryption and authentication overhead.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_cons_4">The Cons</h5>
<div class="paragraph">
<p>The downside of the Git protocol is the lack of authentication.
It&#8217;s generally undesirable for the Git protocol to be the only access to your project.
Generally, you&#8217;ll pair it with SSH or HTTPS access for the few developers who have push (write) access and have everyone else use <code>git://</code> for read-only access.
It&#8217;s also probably the most difficult protocol to set up.
It must run its own daemon, which requires <code>xinetd</code> configuration or the like, which isn&#8217;t always a walk in the park.
It also requires firewall access to port 9418, which isn&#8217;t a standard port that corporate firewalls always allow.
Behind big corporate firewalls, this obscure port is commonly blocked.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_on_the_server">Getting Git on a Server</h3>
<div class="paragraph">
<p>Now we&#8217;ll cover setting up a Git service running these protocols on your own server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Here we&#8217;ll be demonstrating the commands and steps needed to do basic, simplified installations on a Linux based server, though it&#8217;s also possible to run these services on Mac or Windows servers too.
Actually setting up a production server within your infrastructure will certainly entail differences in security measures or operating system tools, but hopefully this will give you the general idea of what&#8217;s involved.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to initially set up any Git server, you have to export an existing repository into a new bare repository – a repository that doesn&#8217;t contain a working directory.
This is generally straightforward to do.
In order to clone your repository to create a new bare repository, you run the clone command with the <code>--bare</code> option.
By convention, bare repository directories end in <code>.git</code>, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone --bare my_project my_project.git
Cloning into bare repository 'my_project.git'...
done.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now have a copy of the Git directory data in your <code>my_project.git</code> directory.</p>
</div>
<div class="paragraph">
<p>This is roughly equivalent to something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cp -Rf my_project/.git my_project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple of minor differences in the configuration file; but for your purpose, this is close to the same thing.
It takes the Git repository by itself, without a working directory, and creates a directory specifically for it alone.</p>
</div>
<div class="sect3">
<h4 id="_bare_repo">Putting the Bare Repository on a Server</h4>
<div class="paragraph">
<p>Now that you have a bare copy of your repository, all you need to do is put it on a server and set up your protocols.
Let&#8217;s say you&#8217;ve set up a server called <code>git.example.com</code> that you have SSH access to, and you want to store all your Git repositories under the <code>/opt/git</code> directory.
Assuming that <code>/opt/git</code> exists on that server, you can set up your new repository by copying your bare repository over:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ scp -r my_project.git user@git.example.com:/opt/git</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, other users who have SSH access to the same server which has read-access to the <code>/opt/git</code> directory can clone your repository by running</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone user@git.example.com:/opt/git/my_project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a user SSHs into a server and has write access to the <code>/opt/git/my_project.git</code> directory, they will also automatically have push access.</p>
</div>
<div class="paragraph">
<p>Git will automatically add group write permissions to a repository properly if you run the <code>git init</code> command with the <code>--shared</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ssh user@git.example.com
$ cd /opt/git/my_project.git
$ git init --bare --shared</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see how easy it is to take a Git repository, create a bare version, and place it on a server to which you and your collaborators have SSH access.
Now you&#8217;re ready to collaborate on the same project.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that this is literally all you need to do to run a useful Git server to which several people have access – just add SSH-able accounts on a server, and stick a bare repository somewhere that all those users have read and write access to.
You&#8217;re ready to go – nothing else needed.</p>
</div>
<div class="paragraph">
<p>In the next few sections, you&#8217;ll see how to expand to more sophisticated setups.
This discussion will include not having to create user accounts for each user, adding public read access to repositories, setting up web UIs, using the Gitosis tool, and more.
However, keep in mind that to collaborate with a couple of people on a private project, all you <em>need</em> is an SSH server and a bare repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="_small_setups">Small Setups</h4>
<div class="paragraph">
<p>If you&#8217;re a small outfit or are just trying out Git in your organization and have only a few developers, things can be simple for you.
One of the most complicated aspects of setting up a Git server is user management.
If you want some repositories to be read-only to certain users and read/write to others, access and permissions can be a bit more difficult to arrange.</p>
</div>
<div class="sect4">
<h5 id="_ssh_access">SSH Access</h5>
<div class="paragraph">
<p>
If you have a server to which all your developers already have SSH access, it&#8217;s generally easiest to set up your first repository there, because you have to do almost no work (as we covered in the last section).
If you want more complex access control type permissions on your repositories, you can handle them with the normal filesystem permissions of the operating system your server runs.</p>
</div>
<div class="paragraph">
<p>If you want to place your repositories on a server that doesn&#8217;t have accounts for everyone on your team whom you want to have write access, then you must set up SSH access for them.
We assume that if you have a server with which to do this, you already have an SSH server installed, and that&#8217;s how you&#8217;re accessing the server.</p>
</div>
<div class="paragraph">
<p>There are a few ways you can give access to everyone on your team.
The first is to set up accounts for everybody, which is straightforward but can be cumbersome.
You may not want to run <code>adduser</code> and set temporary passwords for every user.</p>
</div>
<div class="paragraph">
<p>A second method is to create a single <em>git</em> user on the machine, ask every user who is to have write access to send you an SSH public key, and add that key to the <code>~/.ssh/authorized_keys</code> file of your new <em>git</em> user.
At that point, everyone will be able to access that machine via the <em>git</em> user.
This doesn&#8217;t affect the commit data in any way – the SSH user you connect as doesn&#8217;t affect the commits you&#8217;ve recorded.</p>
</div>
<div class="paragraph">
<p>Another way to do it is to have your SSH server authenticate from an LDAP server or some other centralized authentication source that you may already have set up.
As long as each user can get shell access on the machine, any SSH authentication mechanism you can think of should work.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generate_ssh_key">Generating Your SSH Public Key</h3>
<div class="paragraph">
<p>
That being said, many Git servers authenticate using SSH public keys.
In order to provide a public key, each user in your system must generate one if they don&#8217;t already have one.
This process is similar across all operating systems.
First, you should check to make sure you don&#8217;t already have a key.
By default, a user&#8217;s SSH keys are stored in that user&#8217;s <code>~/.ssh</code> directory.
You can easily check to see if you have a key already by going to that directory and listing the contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd ~/.ssh
$ ls
authorized_keys2  id_dsa       known_hosts
config            id_dsa.pub</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;re looking for a pair of files named something like <code>id_dsa</code> or <code>id_rsa</code> and a matching file with a <code>.pub</code> extension.
The <code>.pub</code> file is your public key, and the other file is your private key.
If you don&#8217;t have these files (or you don&#8217;t even have a <code>.ssh</code> directory), you can create them by running a program called <code>ssh-keygen</code>, which is provided with the SSH package on Linux/Mac systems and comes with the MSysGit package on Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/schacon/.ssh/id_rsa):
Created directory '/home/schacon/.ssh'.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/schacon/.ssh/id_rsa.
Your public key has been saved in /home/schacon/.ssh/id_rsa.pub.
The key fingerprint is:
d0:82:24:8e:d7:f1:bb:9b:33:53:96:93:49:da:9b:e3 schacon@mylaptop.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>First it confirms where you want to save the key (<code>.ssh/id_rsa</code>), and then it asks twice for a passphrase, which you can leave empty if you don&#8217;t want to type a password when you use the key.</p>
</div>
<div class="paragraph">
<p>Now, each user that does this has to send their public key to you or whoever is administrating the Git server (assuming you&#8217;re using an SSH server setup that requires public keys).
All they have to do is copy the contents of the <code>.pub</code> file and e-mail it.
The public keys look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAklOUpkDHrfHY17SbrmTIpNLTGK9Tjom/BWDSU
GPl+nafzlHDTYW7hdI4yZ5ew18JH4JW9jbhUFrviQzM7xlELEVf4h9lFX5QVkbPppSwg0cda3
Pbv7kOdJ/MTyBlWXFCR+HAo3FXRitBqxiX1nKhXpHAZsMciLq8V6RjsNAQwdsdMFvSlVK/7XA
t3FaoJoAsncM1Q9x5+3V0Ww68/eIFmb1zuUFljQJKprrX88XypNDvjYNby6vw/Pb0rwert/En
mZ+AW4OZPnTPI89ZPmVMLuayrD2cE86Z/il8b+gw3r3+1nKatmIkjn2so1d01QraTlMqVSsbx
NrRFi9wrf+M7Q== schacon@mylaptop.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a more in-depth tutorial on creating an SSH key on multiple operating systems, see the GitHub guide on SSH keys at <a href="https://help.github.com/articles/generating-ssh-keys" class="bare">https://help.github.com/articles/generating-ssh-keys</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_server">Setting Up the Server</h3>
<div class="paragraph">
<p>Let&#8217;s walk through setting up SSH access on the server side.
In this example, you&#8217;ll use the <code>authorized_keys</code> method for authenticating your users.
We also assume you&#8217;re running a standard Linux distribution like Ubuntu.
First, you create a <em>git</em> user and a <code>.ssh</code> directory for that user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo adduser git
$ su git
$ cd
$ mkdir .ssh &amp;&amp; chmod 700 .ssh
$ touch .ssh/authorized_keys &amp;&amp; chmod 600 .ssh/authorized_keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you need to add some developer SSH public keys to the <code>authorized_keys</code> file for the <code>git</code> user.
Let&#8217;s assume you have some trusted public keys and have saved them to temporary files.
Again, the public keys look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /tmp/id_rsa.john.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4L
ojG6rs6hPB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4k
Yjh6541NYsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9Ez
Sdfd8AcCIicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myiv
O7TCUSBdLQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPq
dAv8JggJICUvax2T9va5 gsg-keypair</code></pre>
</div>
</div>
<div class="paragraph">
<p>You just append them to the <code>git</code> user&#8217;s <code>authorized_keys</code> file in its <code>.ssh</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /tmp/id_rsa.john.pub &gt;&gt; ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.josie.pub &gt;&gt; ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.jessica.pub &gt;&gt; ~/.ssh/authorized_keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can set up an empty repository for them by running <code>git init</code> with the <code>--bare</code> option, which initializes the repository without a working directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd /opt/git
$ mkdir project.git
$ cd project.git
$ git init --bare
Initialized empty Git repository in /opt/git/project.git/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, John, Josie, or Jessica can push the first version of their project into that repository by adding it as a remote and pushing up a branch.
Note that someone must shell onto the machine and create a bare repository every time you want to add a project.
Let&#8217;s use <code>gitserver</code> as the hostname of the server on which you&#8217;ve set up your <em>git</em> user and repository.
If you&#8217;re running it internally, and you set up DNS for <code>gitserver</code> to point to that server, then you can use the commands pretty much as is (assuming that <code>myproject</code> is an existing project with files in it):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># on Johns computer
$ cd myproject
$ git init
$ git add .
$ git commit -m 'initial commit'
$ git remote add origin git@gitserver:/opt/git/project.git
$ git push origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the others can clone it down and push changes back up just as easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone git@gitserver:/opt/git/project.git
$ cd project
$ vim README
$ git commit -am 'fix for the README file'
$ git push origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this method, you can quickly get a read/write Git server up and running for a handful of developers.</p>
</div>
<div class="paragraph">
<p>You should note that currently all these users can also log into the server and get a shell as the &#8220;git&#8221; user. If you want to restrict that, you will have to change the shell to something else in the <code>passwd</code> file.</p>
</div>
<div class="paragraph">
<p>You can easily restrict the <em>git</em> user to only doing Git activities with a limited shell tool called <code>git-shell</code> that comes with Git.
If you set this as your <em>git</em> user&#8217;s login shell, then the <em>git</em> user can&#8217;t have normal shell access to your server.
To use this, specify <code>git-shell</code> instead of bash or csh for your user&#8217;s login shell.
To do so, you must first add <code>git-shell</code> to <code>/etc/shells</code> if it&#8217;s not already there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /etc/shells   # see if `git-shell` is already in there.  If not...
$ which git-shell   # make sure git-shell is installed on your system.
$ sudo vim /etc/shells  # and add the path to git-shell from last command</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can edit the shell for a user using <code>chsh &lt;username&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo chsh git  # and enter the path to git-shell, usually: /usr/bin/git-shell</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, the <em>git</em> user can only use the SSH connection to push and pull Git repositories and can&#8217;t shell onto the machine.
If you try, you&#8217;ll see a login rejection like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ssh git@gitserver
fatal: Interactive git shell is not enabled.
hint: ~/git-shell-commands should exist and have read and execute access.
Connection to gitserver closed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Git network commands will still work just fine but the users won&#8217;t be able to get a shell.
As the output states, you can also set up a directory in the &#8220;git&#8221; user&#8217;s home directory that customizes the <code>git-shell</code> command a bit.
For instance, you can restrict the Git commands that the server will accept or you can customize the message that users see if they try to SSH in like that.
Run <code>git help shell</code> for more information on customizing the shell.</p>
</div>
</div>
<div class="sect2">
<h3 id="_git_daemon">Git Daemon</h3>
<div class="paragraph">
<p>
Next we&#8217;ll set up a daemon serving repositories over the &#8220;Git&#8221; protocol. This is common choice for fast, unauthenticated access to your Git data. Remember that since it&#8217;s not an authenticated service, anything you serve over this protocol is public within it&#8217;s network.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re running this on a server outside your firewall, it should only be used for projects that are publicly visible to the world.
If the server you&#8217;re running it on is inside your firewall, you might use it for projects that a large number of people or computers (continuous integration or build servers) have read-only access to, when you don&#8217;t want to have to add an SSH key for each.</p>
</div>
<div class="paragraph">
<p>In any case, the Git protocol is relatively easy to set up.
Basically, you need to run this command in a daemonized manner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">git daemon --reuseaddr --base-path=/opt/git/ /opt/git/</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--reuseaddr</code> allows the server to restart without waiting for old connections to time out, the <code>--base-path</code> option allows people to clone projects without specifying the entire path, and the path at the end tells the Git daemon where to look for repositories to export.
If you&#8217;re running a firewall, you&#8217;ll also need to punch a hole in it at port 9418 on the box you&#8217;re setting this up on.</p>
</div>
<div class="paragraph">
<p>You can daemonize this process a number of ways, depending on the operating system you&#8217;re running.
On an Ubuntu machine, you can use an Upstart script.
So, in the following file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">/etc/event.d/local-git-daemon</code></pre>
</div>
</div>
<div class="paragraph">
<p>you put this script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">start on startup
stop on shutdown
exec /usr/bin/git daemon \
    --user=git --group=git \
    --reuseaddr \
    --base-path=/opt/git/ \
    /opt/git/
respawn</code></pre>
</div>
</div>
<div class="paragraph">
<p>For security reasons, it is strongly encouraged to have this daemon run as a user with read-only permissions to the repositories – you can easily do this by creating a new user <em>git-ro</em> and running the daemon as them.
For the sake of simplicity we&#8217;ll simply run it as the same <em>git</em> user that Gitosis is running as.</p>
</div>
<div class="paragraph">
<p>When you restart your machine, your Git daemon will start automatically and respawn if it goes down.
To get it running without having to reboot, you can run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">initctl start local-git-daemon</code></pre>
</div>
</div>
<div class="paragraph">
<p>On other systems, you may want to use <code>xinetd</code>, a script in your <code>sysvinit</code> system, or something else – as long as you get that command daemonized and watched somehow.</p>
</div>
<div class="paragraph">
<p>Next, you have to tell Git which repositories to allow unauthenticated Git server-based access to. You can do this in each repository by creating a file name <code>git-daemon-export-ok</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd /path/to/project.git
$ touch git-daemon-export-ok</code></pre>
</div>
</div>
<div class="paragraph">
<p>The presence of that file tells Git that it&#8217;s OK to serve this project without authentication.</p>
</div>
</div>
<div class="sect2">
<h3 id="_smart_http_2">Smart HTTP</h3>
<div class="paragraph">
<p>
We now have authenticated access though SSH and unauthenticated access through <code>git://</code>, but there is also a protocol that can do both at the same time.
Setting up Smart HTTP is basically just enabling a CGI script that is provided with Git called <code>git-http-backend</code> on the server.git commands, "http-backend"
This CGI will read the path and headers sent by a <code>git fetch</code> or <code>git push</code> to an HTTP URL and determine if the client can communicate over HTTP (which is true for any client since version 1.6.6).
If the CGI sees that the client is smart, it will communicate smartly with it, otherwise it will fall back to the dumb behavior (so it is backward compatible for reads with older clients).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk though a very basic setup. We&#8217;ll set this up with Apache as the CGI server. If you don&#8217;t have Apache setup, you can do so on a Linux box with something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo apt-get install apache2 apache2-utils
$ a2enmod cgi alias env</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also enables the <code>mod_cgi</code>, <code>mod_alias</code>, and <code>mod_env</code> modules, which are all needed for this to work properly.</p>
</div>
<div class="paragraph">
<p>Next we need to add some things to the Apache configuration to run the <code>git http-backend</code> as the handler for anything coming into the <code>/git</code> path of your web server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">SetEnv GIT_PROJECT_ROOT /opt/git
SetEnv GIT_HTTP_EXPORT_ALL
ScriptAlias /git/ /usr/libexec/git-core/git-http-backend/</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you leave out <code>GIT_HTTP_EXPORT_ALL</code> environment variable, then Git will only serve to unauthenticated clients the repositories with the <code>git-daemon-export-ok</code> file in them, just like the Git daemon did.</p>
</div>
<div class="paragraph">
<p>Then you&#8217;ll have to tell Apache to allow requests to that path with something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&lt;Directory "/usr/lib/git-core*"&gt;
   Options ExecCGI Indexes
   Order allow,deny
   Allow from all
   Require all granted
&lt;/Directory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally you&#8217;ll want to make writes be authenticated somehow, possibly with an Auth block like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&lt;LocationMatch "^/git/.*/git-receive-pack$"&gt;
    AuthType Basic
    AuthName "Git Access"
    AuthUserFile /opt/git/.htpasswd
    Require valid-user
&lt;/LocationMatch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will require you to create a <code>.htaccess</code> file containing the passwords of all the valid users. Here is an example of adding a &#8220;schacon&#8221; user to the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ htdigest -c /opt/git/.htpasswd "Git Access" schacon</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are tons of ways to have Apache authenticate users, you&#8217;ll have to choose and implement one of them. This is just the simplest example we could come up with. You&#8217;ll also almost certainly want to set this up over SSL so all this data is encrypted.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t want to go too far down the rabbit hole of Apache configuration specifics, since you could well be using a different server or have different authenication needs. The idea is that Git comes with a CGI called <code>git http-backend</code> that when invoked will do all the negotiation to send and receive data over HTTP. It does not implement any authentication itself, but that can easily be controlled at the layer of the web server that invokes it. You can do this with nearly any CGI-capable web server, so go with the one that you know best.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For more information on configuring authentication in Apache, check out the Apache docs here: <a href="http://httpd.apache.org/docs/current/howto/auth.html" class="bare">http://httpd.apache.org/docs/current/howto/auth.html</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_gitweb">GitWeb</h3>
<div class="paragraph">
<p>
Now that you have basic read/write and read-only access to your project, you may want to set up a simple web-based visualizer.
Git comes with a CGI script called GitWeb that is sometimes used for this.</p>
</div>
<div id="gitweb" class="imageblock">
<div class="content">
<img src="images/git-instaweb.png" alt="The GitWeb web-based user interface.">
</div>
<div class="title">Figure 49. The GitWeb web-based user interface.</div>
</div>
<div class="paragraph">
<p>If you want to check out what GitWeb would look like for your project, Git comes with a command to fire up a temporary instance if you have a lightweight server on your system like <code>lighttpd</code> or <code>webrick</code>.
On Linux machines, <code>lighttpd</code> is often installed, so you may be able to get it to run by typing <code>git instaweb</code> in your project directory.
If you&#8217;re running a Mac, Leopard comes preinstalled with Ruby, so <code>webrick</code> may be your best bet.
To start <code>instaweb</code> with a non-lighttpd handler, you can run it with the <code>--httpd</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git instaweb --httpd=webrick
[2009-02-21 10:02:21] INFO  WEBrick 1.3.1
[2009-02-21 10:02:21] INFO  ruby 1.8.6 (2008-03-03) [universal-darwin9.0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>That starts up an HTTPD server on port 1234 and then automatically starts a web browser that opens on that page.
It&#8217;s pretty easy on your part.
When you&#8217;re done and want to shut down the server, you can run the same command with the <code>--stop</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git instaweb --httpd=webrick --stop</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to run the web interface on a server all the time for your team or for an open source project you&#8217;re hosting, you&#8217;ll need to set up the CGI script to be served by your normal web server.
Some Linux distributions have a <code>gitweb</code> package that you may be able to install via <code>apt</code> or <code>yum</code>, so you may want to try that first.
We&#8217;ll walk though installing GitWeb manually very quickly.
First, you need to get the Git source code, which GitWeb comes with, and generate the custom CGI script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone git://git.kernel.org/pub/scm/git/git.git
$ cd git/
$ make GITWEB_PROJECTROOT="/opt/git" prefix=/usr gitweb
    SUBDIR gitweb
    SUBDIR ../
make[2]: `GIT-VERSION-FILE' is up to date.
    GEN gitweb.cgi
    GEN static/gitweb.js
$ sudo cp -Rf gitweb /var/www/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that you have to tell the command where to find your Git repositories with the <code>GITWEB_PROJECTROOT</code> variable.
Now, you need to make Apache use CGI for that script, for which you can add a VirtualHost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&lt;VirtualHost *:80&gt;
    ServerName gitserver
    DocumentRoot /var/www/gitweb
    &lt;Directory /var/www/gitweb&gt;
        Options ExecCGI +FollowSymLinks +SymLinksIfOwnerMatch
        AllowOverride All
        order allow,deny
        Allow from all
        AddHandler cgi-script cgi
        DirectoryIndex gitweb.cgi
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, GitWeb can be served with any CGI or Perl capable web server; if you prefer to use something else, it shouldn&#8217;t be difficult to set up.
At this point, you should be able to visit <code>http://gitserver/</code> to view your repositories online.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gitlab">GitLab</h3>
<div class="paragraph">
<p>
GitWeb is pretty simplistic though.
If you&#8217;re looking for a more modern, fully featured Git server, there are some several open source solutions out there that you can install instead.
As GitLab is one of the more popular ones, we&#8217;ll cover installing and using it as an example.
This is a bit more complex than the GitWeb option and likely requires more maintenance, but it is a much more fully featured option.</p>
</div>
<div class="sect3">
<h4 id="_installation">Installation</h4>
<div class="paragraph">
<p>GitLab is a database-backed web application, so its installation is a bit more involved than some other git servers.
Fortunately, this process is very well-documented and supported.</p>
</div>
<div class="paragraph">
<p>There are a few methods you can pursue to install GitLab.
To get something up and running quickly, you can download a virtual machine image or a one-click installer from <a href="https://bitnami.com/stack/gitlab" class="bare">https://bitnami.com/stack/gitlab</a>, and tweak the configuration to match your particular environment.
One nice touch Bitnami has included is the login screen (accessed by typing alt-&rarr;); it tells you the IP address and default username and password for the installed GitLab.</p>
</div>
<div id="bitnami" class="imageblock">
<div class="content">
<img src="images/bitnami.png" alt="The Bitnami GitLab virtual machine login screen.">
</div>
<div class="title">Figure 50. The Bitnami GitLab virtual machine login screen.</div>
</div>
<div class="paragraph">
<p>For anything else, follow the guidance in the GitLab Community Edition readme, which can be found at <a href="https://gitlab.com/gitlab-org/gitlab-ce/tree/master" class="bare">https://gitlab.com/gitlab-org/gitlab-ce/tree/master</a>.
There you&#8217;ll find assistance for installing GitLab using Chef recipes, a virtual machine on Digital Ocean, and RPM and DEB packages (which, as of this writing, are in beta).
There&#8217;s also &#8220;unofficial&#8221; guidance on getting GitLab running with non-standard operating systems and databases, a fully-manual installation script, and many other topics.</p>
</div>
</div>
<div class="sect3">
<h4 id="_administration">Administration</h4>
<div class="paragraph">
<p>GitLab&#8217;s administration interface is accessed over the web.
Simply point your browser to the hostname or IP address where GitLab is installed, and log in as an admin user.
The default username is <code>admin@local.host</code>, and the default password is <code>5iveL!fe</code> (which you will be prompted to change as soon as you enter it).
Once logged in, click the &#8220;Admin area&#8221; icon in the menu at the top right.</p>
</div>
<div id="gitlab_menu" class="imageblock">
<div class="content">
<img src="images/gitlab-menu.png" alt="The ``Admin area'' item in the GitLab menu.">
</div>
<div class="title">Figure 51. The &#8220;Admin area&#8221; item in the GitLab menu.</div>
</div>
<div class="sect4">
<h5 id="_users">Users</h5>
<div class="paragraph">
<p>Users in GitLab are accounts that correspond to people.
User accounts don&#8217;t have a lot of complexity; mainly it&#8217;s a collection of personal information attached to login data.
Each user account comes with a <strong>namespace</strong>, which is a logical grouping of projects that belong to that user.
If the user <code>jane</code> had a project named <code>project</code>, that project&#8217;s url would be <a href="http://server/jane/project" class="bare">http://server/jane/project</a>.</p>
</div>
<div id="gitlab_users" class="imageblock">
<div class="content">
<img src="images/gitlab-users.png" alt="The GitLab user administration screen.">
</div>
<div class="title">Figure 52. The GitLab user administration screen.</div>
</div>
<div class="paragraph">
<p>Removing a user can be done in two ways.
&#8220;Blocking&#8221; a user prevents them from logging into the GitLab instance, but all of the data under that user&#8217;s namespace will be preserved, and commits signed with that user&#8217;s email address will still link back to their profile.</p>
</div>
<div class="paragraph">
<p>&#8220;Destroying&#8221; a user, on the other hand, completely removes them from the database and filesystem.
All projects and data in their namespace is removed, and any groups they own will also be removed.
This is obviously a much more permanent and destructive action, and its uses are rare.</p>
</div>
</div>
<div class="sect4">
<h5 id="_gitlab_groups_section">Groups</h5>
<div class="paragraph">
<p>A GitLab group is an assemblage of projects, along with data about how users can access those projects.
Each group has a project namespace (the same way that users do), so if the group <code>training</code> has a project <code>materials</code>, its url would be <a href="http://server/training/materials" class="bare">http://server/training/materials</a>.</p>
</div>
<div id="gitlab_groups" class="imageblock">
<div class="content">
<img src="images/gitlab-groups.png" alt="The GitLab group administration screen.">
</div>
<div class="title">Figure 53. The GitLab group administration screen.</div>
</div>
<div class="paragraph">
<p>Each group is associated with a number of users, each of which has a level of permissions for the group&#8217;s projects and the group itself.
These range from &#8220;Guest&#8221; (issues and chat only) to &#8220;Owner&#8221; (full control of the group, its members, and its projects).
The types of permissions are too numerous to list here, but GitLab has a helpful link on the administration screen.</p>
</div>
</div>
<div class="sect4">
<h5 id="_projects">Projects</h5>
<div class="paragraph">
<p>A GitLab project roughly corresponds to a single git repository.
Every project belongs to a single namespace, either a user or a group.
If the project belongs to a user, the owner of the project has direct control over who has access to the project; if the project belongs to a group, the group&#8217;s user-level permissions will also take effect.</p>
</div>
<div class="paragraph">
<p>Every project also has a visibility level, which controls who has read access to that project&#8217;s pages and repository.
If a project is <em>Private</em>, the project&#8217;s owner must explicitly grant access to specific users.
An <em>Internal</em> project is visible to any logged-in user, and a <em>Public</em> project is visible to anyone.
Note that this controls both git &#8220;fetch&#8221; access as well as access to the web UI for that project.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hooks">Hooks</h5>
<div class="paragraph">
<p>GitLab includes support for hooks, both at a project or system level.
For either of these, the GitLab server will perform an HTTP POST with some descriptive JSON whenever relevant events occur.
This is a great way to connect your git repositories and GitLab instance to the rest of your development automation, such as CI servers, chat rooms, or deployment tools.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_basic_usage">Basic Usage</h4>
<div class="paragraph">
<p>The first thing you&#8217;ll want to do with GitLab is create a new project.
This is accomplished by clicking the &#8220;+&#8221; icon on the toolbar.
You&#8217;ll be asked for the project&#8217;s name, which namespace it should belong to, and what its visibility level should be.
Most of what you specify here isn&#8217;t permanent, and can be re-adjusted later through the settings interface.
Click &#8220;Create Project&#8221;, and you&#8217;re done.</p>
</div>
<div class="paragraph">
<p>Once the project exists, you&#8217;ll probably want to connect it with a local Git repository.
Each project is accessible over HTTPS or SSH, either of which can be used to configure a Git remote.
The URLs are visible at the top of the project&#8217;s home page.
For an existing local repository, this command will create a remote named <code>gitlab</code> to the hosted location:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add gitlab https://server/namespace/project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t have a local copy of the repository, you can simply do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://server/namespace/project.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>The web UI provides access to several useful views of the repository itself.
Each project&#8217;s home page shows recent activity, and links along the top will lead you to views of the project&#8217;s files and commit log.</p>
</div>
</div>
<div class="sect3">
<h4 id="_working_together">Working Together</h4>
<div class="paragraph">
<p>The simplest way of working together on a GitLab project is by giving another user direct push access to the git repository.
You can add a user to a project by going to the &#8220;Members&#8221; section of that project&#8217;s settings, and associating the new user with an access level (the different access levels are discussed a bit in <a href="#_gitlab_groups_section">Groups</a>).
By giving a user an access level of &#8220;Developer&#8221; or above, that user can push commits and branches directly to the repository with impunity.</p>
</div>
<div class="paragraph">
<p>Another, more decoupled way of collaboration is by using merge requests.
This feature enables any user that can see a project to contribute to it in a controlled way.
Users with direct access can simply create a branch, push commits to it, and open a merge request from their branch back into <code>master</code> or any other branch.
Users who don&#8217;t have push permissions for a repository can &#8220;fork&#8221; it (create their own copy), push commits to <em>that</em> copy, and open a merge request from their fork back to the main project.
This model allows the owner to be in full control of what goes into the repository and when, while allowing contributions from untrusted users.</p>
</div>
<div class="paragraph">
<p>Merge requests and issues are the main units of long-lived discussion in GitLab.
Each merge request allows a line-by-line discussion of the proposed change (which supports a lightweight kind of code review), as well as a general overall discussion thread.
Both can be assigned to users, or organized into milestones.</p>
</div>
<div class="paragraph">
<p>This section has focused mainly on the Git-related parts of GitLab, but it&#8217;s a fairly mature system, and provides many other features that can help your team work together.
These include project wikis, discussion &#8220;walls&#8221;, and system maintenance tools.
One benefit to GitLab is that, once the server is set up and running, you&#8217;ll rarely need to tweak a configuration file or access the server via SSH; most administration and general usage can be accomplished through the in-browser interface.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_third_party_hosted_options">Third Party Hosted Options</h3>
<div class="paragraph">
<p>If you don&#8217;t want to go through all of the work involved in setting up your own Git server, you have several options for hosting your Git projects on an external dedicated hosting site.
Doing so offers a number of advantages: a hosting site is generally quick to set up and easy to start projects on, and no server maintenance or monitoring is involved.
Even if you set up and run your own server internally, you may still want to use a public hosting site for your open source code – it&#8217;s generally easier for the open source community to find and help you with.</p>
</div>
<div class="paragraph">
<p>These days, you have a huge number of hosting options to choose from, each with different advantages and disadvantages.
To see an up-to-date list, check out the GitHosting page on the main Git wiki at <a href="https://git.wiki.kernel.org/index.php/GitHosting" class="bare">https://git.wiki.kernel.org/index.php/GitHosting</a></p>
</div>
<div class="paragraph">
<p>We&#8217;ll cover using GitHub in detail in <a href="#_github">GitHub</a>, as it is the largest Git host out there and you may need to interact with projects hosted on it in any case, but there are dozens more to choose from should you not want to set up your own Git server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_总结_4">总结</h3>
<div class="paragraph">
<p>您有多种远程存取 Git 仓库的选择便于与其他人合作或是分享您的工作。</p>
</div>
<div class="paragraph">
<p>运行您自己的伺服器将有许多权限且允许您运行该服务于您自己的防火墙内，但如此通常需要耗费您大量的时间去设置与维护伺服器。
如果您放置您的资料于托管伺服器内，可轻易的设置与维护；无论如何，您必须能够保存您的代码在其他伺服器，且某些组织不允许此作法。
这将直接了当的决定哪个作法或组合的方式较适合您或您的组织。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_distributed_git">Distributed Git</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
Now that you have a remote Git repository set up as a point for all the developers to share their code, and you&#8217;re familiar with basic Git commands in a local workflow, you&#8217;ll look at how to utilize some of the distributed workflows that Git affords you.</p>
</div>
<div class="paragraph">
<p>In this chapter, you&#8217;ll see how to work with Git in a distributed environment as a contributor and an integrator.
That is, you&#8217;ll learn how to contribute code successfully to a project and make it as easy on you and the project maintainer as possible, and also how to maintain a project successfully with a number of developers contributing.</p>
</div>
<div class="sect2">
<h3 id="_distributed_workflows">Distributed Workflows</h3>
<div class="paragraph">
<p>
Unlike Centralized Version Control Systems (CVCSs), the distributed nature of Git allows you to be far more flexible in how developers collaborate on projects.
In centralized systems, every developer is a node working more or less equally on a central hub.
In Git, however, every developer is potentially both a node and a hub – that is, every developer can both contribute code to other repositories and maintain a public repository on which others can base their work and which they can contribute to.
This opens a vast range of workflow possibilities for your project and/or your team, so we&#8217;ll cover a few common paradigms that take advantage of this flexibility.
We&#8217;ll go over the strengths and possible weaknesses of each design; you can choose a single one to use, or you can mix and match features from each.</p>
</div>
<div class="sect3">
<h4 id="_centralized_workflow">Centralized Workflow</h4>
<div class="paragraph">
<p>
In centralized systems, there is generally a single collaboration model–the centralized workflow.
One central hub, or repository, can accept code, and everyone synchronizes their work to it.
A number of developers are nodes – consumers of that hub – and synchronize to that one place.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/centralized.png" alt="Centralized workflow.">
</div>
<div class="title">Figure 54. Centralized workflow.</div>
</div>
<div class="paragraph">
<p>This means that if two developers clone from the hub and both make changes, the first developer to push their changes back up can do so with no problems.
The second developer must merge in the first one&#8217;s work before pushing changes up, so as not to overwrite the first developer&#8217;s changes.
This concept is as true in Git as it is in Subversion (or any CVCS), and this model works perfectly well in Git.</p>
</div>
<div class="paragraph">
<p>If you are already comfortable with a centralized workflow in your company or team, you can easily continue using that workflow with Git.
Simply set up a single repository, and give everyone on your team push access; Git won&#8217;t let users overwrite each other.
Say John and Jessica both start working at the same time.
John finishes his change and pushes it to the server.
Then Jessica tries to push her changes, but the server rejects them.
She is told that she&#8217;s trying to push non-fast-forward changes and that she won&#8217;t be able to do so until she fetches and merges.
This workflow is attractive to a lot of people because it&#8217;s a paradigm that many are familiar and comfortable with.</p>
</div>
<div class="paragraph">
<p>This is also not limited to small teams. With Git&#8217;s branching model, it&#8217;s possible for hundreds of developers to successfully work on a single project through dozens of branches simultaneously.</p>
</div>
</div>
<div class="sect3">
<h4 id="_integration_manager">Integration-Manager Workflow</h4>
<div class="paragraph">
<p>
Because Git allows you to have multiple remote repositories, it&#8217;s possible to have a workflow where each developer has write access to their own public repository and read access to everyone else&#8217;s.
This scenario often includes a canonical repository that represents the &#8220;official&#8221; project.
To contribute to that project, you create your own public clone of the project and push your changes to it.
Then, you can send a request to the maintainer of the main project to pull in your changes.
The maintainer can then add your repository as a remote, test your changes locally, merge them into their branch, and push back to their repository.
The process works as follows (see <a href="#wfdiag_b">Integration-manager workflow.</a>):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The project maintainer pushes to their public repository.</p>
</li>
<li>
<p>A contributor clones that repository and makes changes.</p>
</li>
<li>
<p>The contributor pushes to their own public copy.</p>
</li>
<li>
<p>The contributor sends the maintainer an e-mail asking them to pull changes.</p>
</li>
<li>
<p>The maintainer adds the contributor&#8217;s repo as a remote and merges locally.</p>
</li>
<li>
<p>The maintainer pushes merged changes to the main repository.</p>
</li>
</ol>
</div>
<div id="wfdiag_b" class="imageblock">
<div class="content">
<img src="images/integration-manager.png" alt="Integration-manager workflow.">
</div>
<div class="title">Figure 55. Integration-manager workflow.</div>
</div>
<div class="paragraph">
<p>
This is a very common workflow with hub-based tools like GitHub or GitLab, where it&#8217;s easy to fork a project and push your changes into your fork for everyone to see.
One of the main advantages of this approach is that you can continue to work, and the maintainer of the main repository can pull in your changes at any time.
Contributors don&#8217;t have to wait for the project to incorporate their changes – each party can work at their own pace.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dictator_and_lieutenants_workflow">Dictator and Lieutenants Workflow</h4>
<div class="paragraph">
<p>
This is a variant of a multiple-repository workflow.
It&#8217;s generally used by huge projects with hundreds of collaborators; one famous example is the Linux kernel.
Various integration managers are in charge of certain parts of the repository; they&#8217;re called lieutenants.
All the lieutenants have one integration manager known as the benevolent dictator.
The benevolent dictator&#8217;s repository serves as the reference repository from which all the collaborators need to pull.
The process works like this (see <a href="#wfdiag_c">Benevolent dictator workflow.</a>):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Regular developers work on their topic branch and rebase their work on top of <code>master</code>.
The <code>master</code> branch is that of the dictator.</p>
</li>
<li>
<p>Lieutenants merge the developers' topic branches into their <code>master</code> branch.</p>
</li>
<li>
<p>The dictator merges the lieutenants' <code>master</code> branches into the dictator&#8217;s <code>master</code> branch.</p>
</li>
<li>
<p>The dictator pushes their <code>master</code> to the reference repository so the other developers can rebase on it.</p>
</li>
</ol>
</div>
<div id="wfdiag_c" class="imageblock">
<div class="content">
<img src="images/benevolent-dictator.png" alt="Benevolent dictator workflow.">
</div>
<div class="title">Figure 56. Benevolent dictator workflow.</div>
</div>
<div class="paragraph">
<p>This kind of workflow isn&#8217;t common, but can be useful in very big projects, or in highly hierarchical environments.
It allows the project leader (the dictator) to delegate much of the work and collect large subsets of code at multiple points before integrating them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_workflows_summary">Workflows Summary</h4>
<div class="paragraph">
<p>These are some commonly used workflows that are possible with a distributed system like Git, but you can see that many variations are possible to suit your particular real-world workflow.
Now that you can (hopefully) determine which workflow combination may work for you, we&#8217;ll cover some more specific examples of how to accomplish the main roles that make up the different flows.
In the next section, you&#8217;ll learn about a few common patterns for contributing to a project.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contributing_project">Contributing to a Project</h3>
<div class="paragraph">
<p>
The main difficulty with describing how to contribute to a project is that there are a huge number of variations on how it&#8217;s done.
Because Git is very flexible, people can and do work together in many ways, and it&#8217;s problematic to describe how you should contribute – every project is a bit different.
Some of the variables involved are active contributor count, chosen workflow, your commit access, and possibly the external contribution method.</p>
</div>
<div class="paragraph">
<p>The first variable is active contributor count – how many users are actively contributing code to this project, and how often?
In many instances, you&#8217;ll have two or three developers with a few commits a day, or possibly less for somewhat dormant projects.
For larger companies or projects, the number of developers could be in the thousands, with hundreds or thousands of commits coming in each day.
This is important because with more and more developers, you run into more issues with making sure your code applies cleanly or can be easily merged.
Changes you submit may be rendered obsolete or severely broken by work that is merged in while you were working or while your changes were waiting to be approved or applied.
How can you keep your code consistently up to date and your commits valid?</p>
</div>
<div class="paragraph">
<p>The next variable is the workflow in use for the project.
Is it centralized, with each developer having equal write access to the main codeline?
Does the project have a maintainer or integration manager who checks all the patches?
Are all the patches peer-reviewed and approved?
Are you involved in that process?
Is a lieutenant system in place, and do you have to submit your work to them first?</p>
</div>
<div class="paragraph">
<p>The next issue is your commit access.
The workflow required in order to contribute to a project is much different if you have write access to the project than if you don&#8217;t.
If you don&#8217;t have write access, how does the project prefer to accept contributed work?
Does it even have a policy?
How much work are you contributing at a time?
How often do you contribute?</p>
</div>
<div class="paragraph">
<p>All these questions can affect how you contribute effectively to a project and what workflows are preferred or available to you.
We&#8217;ll cover aspects of each of these in a series of use cases, moving from simple to more complex; you should be able to construct the specific workflows you need in practice from these examples.</p>
</div>
<div class="sect3">
<h4 id="_commit_guidelines">Commit Guidelines</h4>
<div class="paragraph">
<p>Before we start looking at the specific use cases, here&#8217;s a quick note about commit messages.
Having a good guideline for creating commits and sticking to it makes working with Git and collaborating with others a lot easier.
The Git project provides a document that lays out a number of good tips for creating commits from which to submit patches – you can read it in the Git source code in the <code>Documentation/SubmittingPatches</code> file.</p>
</div>
<div class="paragraph">
<p>
First, you don&#8217;t want to submit any whitespace errors.
Git provides an easy way to check for this – before you commit, run <code>git diff --check</code>, which identifies possible whitespace errors and lists them for you.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-diff-check.png" alt="Output of `git diff -check`.">
</div>
<div class="title">Figure 57. Output of <code>git diff -check</code>.</div>
</div>
<div class="paragraph">
<p>If you run that command before committing, you can tell if you&#8217;re about to commit whitespace issues that may annoy other developers.</p>
</div>
<div class="paragraph">
<p>Next, try to make each commit a logically separate changeset.
If you can, try to make your changes digestible – don&#8217;t code for a whole weekend on five different issues and then submit them all as one massive commit on Monday.
Even if you don&#8217;t commit during the weekend, use the staging area on Monday to split your work into at least one commit per issue, with a useful message per commit.
If some of the changes modify the same file, try to use <code>git add --patch</code> to partially stage files (covered in detail in <a href="#_interactive_staging">Interactive Staging</a>).
The project snapshot at the tip of the branch is identical whether you do one commit or five, as long as all the changes are added at some point, so try to make things easier on your fellow developers when they have to review your changes.
This approach also makes it easier to pull out or revert one of the changesets if you need to later.
<a href="#_rewriting_history">Rewriting History</a> describes a number of useful Git tricks for rewriting history and interactively staging files – use these tools to help craft a clean and understandable history before sending the work to someone else.</p>
</div>
<div class="paragraph">
<p>The last thing to keep in mind is the commit message.
Getting in the habit of creating quality commit messages makes using and collaborating with Git a lot easier.
As a general rule, your messages should start with a single line that&#8217;s no more than about 50 characters and that describes the changeset concisely, followed by a blank line, followed by a more detailed explanation.
The Git project requires that the more detailed explanation include your motivation for the change and contrast its implementation with previous behavior – this is a good guideline to follow.
It&#8217;s also a good idea to use the imperative present tense in these messages.
In other words, use commands.
Instead of &#8220;I added tests for&#8221; or &#8220;Adding tests for,&#8221; use &#8220;Add tests for.&#8221;
Here is a template originally written by Tim Pope:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">Short (50 chars or less) summary of changes

More detailed explanatory text, if necessary.  Wrap it to
about 72 characters or so.  In some contexts, the first
line is treated as the subject of an email and the rest of
the text as the body.  The blank line separating the
summary from the body is critical (unless you omit the body
entirely); tools like rebase can get confused if you run
the two together.

Further paragraphs come after blank lines.

  - Bullet points are okay, too

  - Typically a hyphen or asterisk is used for the bullet,
    preceded by a single space, with blank lines in
    between, but conventions vary here</code></pre>
</div>
</div>
<div class="paragraph">
<p>If all your commit messages look like this, things will be a lot easier for you and the developers you work with.
The Git project has well-formatted commit messages – try running <code>git log --no-merges</code> there to see what a nicely formatted project-commit history looks like.</p>
</div>
<div class="paragraph">
<p>In the following examples, and throughout most of this book, for the sake of brevity this book doesn&#8217;t have nicely-formatted messages like this; instead, we use the <code>-m</code> option to <code>git commit</code>.
Do as we say, not as we do.</p>
</div>
</div>
<div class="sect3">
<h4 id="_private_team">Private Small Team</h4>
<div class="paragraph">
<p>
The simplest setup you&#8217;re likely to encounter is a private project with one or two other developers.
&#8220;Private,&#8221; in this context, means closed-source – not accessible to the outside world.
You and the other developers all have push access to the repository.</p>
</div>
<div class="paragraph">
<p>In this environment, you can follow a workflow similar to what you might do when using Subversion or another centralized system.
You still get the advantages of things like offline committing and vastly simpler branching and merging, but the workflow can be very similar; the main difference is that merges happen client-side rather than on the server at commit time.
Let&#8217;s see what it might look like when two developers start to work together with a shared repository.
The first developer, John, clones the repository, makes a change, and commits locally.
(The protocol messages have been replaced with <code>...</code> in these examples to shorten them somewhat.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># John's Machine
$ git clone john@githost:simplegit.git
Initialized empty Git repository in /home/john/simplegit/.git/
...
$ cd simplegit/
$ vim lib/simplegit.rb
$ git commit -am 'removed invalid default value'
[master 738ee87] removed invalid default value
 1 files changed, 1 insertions(+), 1 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second developer, Jessica, does the same thing – clones the repository and commits a change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># Jessica's Machine
$ git clone jessica@githost:simplegit.git
Initialized empty Git repository in /home/jessica/simplegit/.git/
...
$ cd simplegit/
$ vim TODO
$ git commit -am 'add reset task'
[master fbff5bc] add reset task
 1 files changed, 1 insertions(+), 0 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, Jessica pushes her work up to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># Jessica's Machine
$ git push origin master
...
To jessica@githost:simplegit.git
   1edee6b..fbff5bc  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>John tries to push his change up, too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># John's Machine
$ git push origin master
To john@githost:simplegit.git
 ! [rejected]        master -&gt; master (non-fast forward)
error: failed to push some refs to 'john@githost:simplegit.git'</code></pre>
</div>
</div>
<div class="paragraph">
<p>John isn&#8217;t allowed to push because Jessica has pushed in the meantime.
This is especially important to understand if you&#8217;re used to Subversion, because you&#8217;ll notice that the two developers didn&#8217;t edit the same file.
Although Subversion automatically does such a merge on the server if different files are edited, in Git you must merge the commits locally.
John has to fetch Jessica&#8217;s changes and merge them in before he will be allowed to push:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch origin
...
From john@githost:simplegit
 + 049d078...fbff5bc master     -&gt; origin/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, John&#8217;s local repository looks something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-1.png" alt="John's divergent history.">
</div>
<div class="title">Figure 58. John&#8217;s divergent history.</div>
</div>
<div class="paragraph">
<p>John has a reference to the changes Jessica pushed up, but he has to merge them into his own work before he is allowed to push:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge origin/master
Merge made by recursive.
 TODO |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The merge goes smoothly – John&#8217;s commit history now looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-2.png" alt="John's repository after merging `origin/master`.">
</div>
<div class="title">Figure 59. John&#8217;s repository after merging <code>origin/master</code>.</div>
</div>
<div class="paragraph">
<p>Now, John can test his code to make sure it still works properly, and then he can push his new merged work up to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin master
...
To john@githost:simplegit.git
   fbff5bc..72bbc59  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, John&#8217;s commit history looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-3.png" alt="John's history after pushing to the `origin` server.">
</div>
<div class="title">Figure 60. John&#8217;s history after pushing to the <code>origin</code> server.</div>
</div>
<div class="paragraph">
<p>In the meantime, Jessica has been working on a topic branch.
She&#8217;s created a topic branch called <code>issue54</code> and done three commits on that branch.
She hasn&#8217;t fetched John&#8217;s changes yet, so her commit history looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-4.png" alt="Jessica's topic branch.">
</div>
<div class="title">Figure 61. Jessica&#8217;s topic branch.</div>
</div>
<div class="paragraph">
<p>Jessica wants to sync up with John, so she fetches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># Jessica's Machine
$ git fetch origin
...
From jessica@githost:simplegit
   fbff5bc..72bbc59  master     -&gt; origin/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>That pulls down the work John has pushed up in the meantime.
Jessica&#8217;s history now looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-5.png" alt="Jessica's history after fetching John's changes.">
</div>
<div class="title">Figure 62. Jessica&#8217;s history after fetching John&#8217;s changes.</div>
</div>
<div class="paragraph">
<p>Jessica thinks her topic branch is ready, but she wants to know what she has to merge into her work so that she can push.
She runs <code>git log</code> to find out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --no-merges issue54..origin/master
commit 738ee872852dfaa9d6634e0dea7a324040193016
Author: John Smith &lt;jsmith@example.com&gt;
Date:   Fri May 29 16:01:27 2009 -0700

   removed invalid default value</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>issue54..origin/master</code> syntax is a log filter that asks Git to only show the list of commits that are on the latter branch (in this case <code>origin/master</code>) that are not on the first branch (in this case <code>issue54</code>). We&#8217;ll go over this syntax in detail in <a href="#_commit_ranges">提交区间</a>.</p>
</div>
<div class="paragraph">
<p>For now, we can see from the output that there is a single commit that John has made that Jessica has not merged in. If she merges <code>origin/master</code>, that is the single commit that will modify her local work.</p>
</div>
<div class="paragraph">
<p>Now, Jessica can merge her topic work into her master branch, merge John&#8217;s work (<code>origin/master</code>) into her <code>master</code> branch, and then push back to the server again.
First, she switches back to her master branch to integrate all this work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
Switched to branch 'master'
Your branch is behind 'origin/master' by 2 commits, and can be fast-forwarded.</code></pre>
</div>
</div>
<div class="paragraph">
<p>She can merge either <code>origin/master</code> or <code>issue54</code> first – they&#8217;re both upstream, so the order doesn&#8217;t matter.
The end snapshot should be identical no matter which order she chooses; only the history will be slightly different.
She chooses to merge in <code>issue54</code> first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge issue54
Updating fbff5bc..4af4298
Fast forward
 README           |    1 +
 lib/simplegit.rb |    6 +++++-
 2 files changed, 6 insertions(+), 1 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>No problems occur; as you can see it was a simple fast-forward.
Now Jessica merges in John&#8217;s work (<code>origin/master</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge origin/master
Auto-merging lib/simplegit.rb
Merge made by recursive.
 lib/simplegit.rb |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything merges cleanly, and Jessica&#8217;s history looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-6.png" alt="Jessica's history after merging John's changes.">
</div>
<div class="title">Figure 63. Jessica&#8217;s history after merging John&#8217;s changes.</div>
</div>
<div class="paragraph">
<p>Now <code>origin/master</code> is reachable from Jessica&#8217;s <code>master</code> branch, so she should be able to successfully push (assuming John hasn&#8217;t pushed again in the meantime):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin master
...
To jessica@githost:simplegit.git
   72bbc59..8059c15  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each developer has committed a few times and merged each other&#8217;s work successfully.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-7.png" alt="Jessica's history after pushing all changes back to the server.">
</div>
<div class="title">Figure 64. Jessica&#8217;s history after pushing all changes back to the server.</div>
</div>
<div class="paragraph">
<p>That is one of the simplest workflows.
You work for a while, generally in a topic branch, and merge into your master branch when it&#8217;s ready to be integrated.
When you want to share that work, you merge it into your own master branch, then fetch and merge <code>origin/master</code> if it has changed, and finally push to the <code>master</code> branch on the server.
The general sequence is something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/small-team-flow.png" alt="General sequence of events for a simple multiple-developer Git workflow.">
</div>
<div class="title">Figure 65. General sequence of events for a simple multiple-developer Git workflow.</div>
</div>
</div>
<div class="sect3">
<h4 id="_private_managed_team">Private Managed Team</h4>
<div class="paragraph">
<p>
In this next scenario, you&#8217;ll look at contributor roles in a larger private group.
You&#8217;ll learn how to work in an environment where small groups collaborate on features and then those team-based contributions are integrated by another party.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say that John and Jessica are working together on one feature, while Jessica and Josie are working on a second.
In this case, the company is using a type of integration-manager workflow where the work of the individual groups is integrated only by certain engineers, and the <code>master</code> branch of the main repo can be updated only by those engineers.
In this scenario, all work is done in team-based branches and pulled together by the integrators later.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s follow Jessica&#8217;s workflow as she works on her two features, collaborating in parallel with two different developers in this environment.
Assuming she already has her repository cloned, she decides to work on <code>featureA</code> first.
She creates a new branch for the feature and does some work on it there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># Jessica's Machine
$ git checkout -b featureA
Switched to a new branch 'featureA'
$ vim lib/simplegit.rb
$ git commit -am 'add limit to log function'
[featureA 3300904] add limit to log function
 1 files changed, 1 insertions(+), 1 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, she needs to share her work with John, so she pushes her <code>featureA</code> branch commits up to the server.
Jessica doesn&#8217;t have push access to the <code>master</code> branch – only the integrators do – so she has to push to another branch in order to collaborate with John:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push -u origin featureA
...
To jessica@githost:simplegit.git
 * [new branch]      featureA -&gt; featureA</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jessica e-mails John to tell him that she&#8217;s pushed some work into a branch named <code>featureA</code> and he can look at it now.
While she waits for feedback from John, Jessica decides to start working on <code>featureB</code> with Josie.
To begin, she starts a new feature branch, basing it off the server&#8217;s <code>master</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># Jessica's Machine
$ git fetch origin
$ git checkout -b featureB origin/master
Switched to a new branch 'featureB'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, Jessica makes a couple of commits on the <code>featureB</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim lib/simplegit.rb
$ git commit -am 'made the ls-tree function recursive'
[featureB e5b0fdc] made the ls-tree function recursive
 1 files changed, 1 insertions(+), 1 deletions(-)
$ vim lib/simplegit.rb
$ git commit -am 'add ls-files'
[featureB 8512791] add ls-files
 1 files changed, 5 insertions(+), 0 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jessica&#8217;s repository looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/managed-team-1.png" alt="Jessica's initial commit history.">
</div>
<div class="title">Figure 66. Jessica&#8217;s initial commit history.</div>
</div>
<div class="paragraph">
<p>She&#8217;s ready to push up her work, but gets an e-mail from Josie that a branch with some initial work on it was already pushed to the server as <code>featureBee</code>.
Jessica first needs to merge those changes in with her own before she can push to the server.
She can then fetch Josie&#8217;s changes down with <code>git fetch</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch origin
...
From jessica@githost:simplegit
 * [new branch]      featureBee -&gt; origin/featureBee</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jessica can now merge this into the work she did with <code>git merge</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge origin/featureBee
Auto-merging lib/simplegit.rb
Merge made by recursive.
 lib/simplegit.rb |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a bit of a problem – she needs to push the merged work in her <code>featureB</code> branch to the <code>featureBee</code> branch on the server.
She can do so by specifying the local branch followed by a colon (:) followed by the remote branch to the <code>git push</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push -u origin featureB:featureBee
...
To jessica@githost:simplegit.git
   fba9af8..cd685d1  featureB -&gt; featureBee</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is called a <em>refspec</em>.
See <a href="#_refspec">The Refspec</a> for a more detailed discussion of Git refspecs and different things you can do with them.
Also notice the <code>-u</code> flag; this is short for <code>--set-upstream</code>, which configures the branches for easier pushing and pulling later.</p>
</div>
<div class="paragraph">
<p>Next, John e-mails Jessica to say he&#8217;s pushed some changes to the <code>featureA</code> branch and ask her to verify them.
She runs a <code>git fetch</code> to pull down those changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch origin
...
From jessica@githost:simplegit
   3300904..aad881d  featureA   -&gt; origin/featureA</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, she can see what has been changed with <code>git log</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log featureA..origin/featureA
commit aad881d154acdaeb2b6b18ea0e827ed8a6d671e6
Author: John Smith &lt;jsmith@example.com&gt;
Date:   Fri May 29 19:57:33 2009 -0700

    changed log output to 30 from 25</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, she merges John&#8217;s work into her own <code>featureA</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout featureA
Switched to branch 'featureA'
$ git merge origin/featureA
Updating 3300904..aad881d
Fast forward
 lib/simplegit.rb |   10 +++++++++-
1 files changed, 9 insertions(+), 1 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jessica wants to tweak something, so she commits again and then pushes this back up to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -am 'small tweak'
[featureA 774b3ed] small tweak
 1 files changed, 1 insertions(+), 1 deletions(-)
$ git push
...
To jessica@githost:simplegit.git
   3300904..774b3ed  featureA -&gt; featureA</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jessica&#8217;s commit history now looks something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/managed-team-2.png" alt="Jessica's history after committing on a feature branch.">
</div>
<div class="title">Figure 67. Jessica&#8217;s history after committing on a feature branch.</div>
</div>
<div class="paragraph">
<p>Jessica, Josie, and John inform the integrators that the <code>featureA</code> and <code>featureBee</code> branches on the server are ready for integration into the mainline.
After the integrators merge these branches into the mainline, a fetch will bring down the new merge commit, making the history look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/managed-team-3.png" alt="Jessica's history after merging both her topic branches.">
</div>
<div class="title">Figure 68. Jessica&#8217;s history after merging both her topic branches.</div>
</div>
<div class="paragraph">
<p>Many groups switch to Git because of this ability to have multiple teams working in parallel, merging the different lines of work late in the process.
The ability of smaller subgroups of a team to collaborate via remote branches without necessarily having to involve or impede the entire team is a huge benefit of Git.
The sequence for the workflow you saw here is something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/managed-team-flow.png" alt="Basic sequence of this managed-team workflow.">
</div>
<div class="title">Figure 69. Basic sequence of this managed-team workflow.</div>
</div>
</div>
<div class="sect3">
<h4 id="_public_project">Forked Public Project</h4>
<div class="paragraph">
<p>
Contributing to public projects is a bit different.
Because you don&#8217;t have the permissions to directly update branches on the project, you have to get the work to the maintainers some other way.
This first example describes contributing via forking on Git hosts that support easy forking.
Many hosting sites support this (including GitHub, BitBucket, Google Code, repo.or.cz, and others), and many project maintainers expect this style of contribution.
The next section deals with projects that prefer to accept contributed patches via e-mail.</p>
</div>
<div class="paragraph">
<p>First, you&#8217;ll probably want to clone the main repository, create a topic branch for the patch or patch series you&#8217;re planning to contribute, and do your work there.
The sequence looks basically like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone (url)
$ cd project
$ git checkout -b featureA
# (work)
$ git commit
# (work)
$ git commit</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You may want to use <code>rebase -i</code> to squash your work down to a single commit, or rearrange the work in the commits to make the patch easier for the maintainer to review – see <a href="#_rewriting_history">Rewriting History</a> for more information about interactive rebasing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When your branch work is finished and you&#8217;re ready to contribute it back to the maintainers, go to the original project page and click the &#8220;Fork&#8221; button, creating your own writable fork of the project.
You then need to add in this new repository URL as a second remote, in this case named <code>myfork</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add myfork (url)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need to push your work up to it.
It&#8217;s easiest to push the topic branch you&#8217;re working on up to your repository, rather than merging into your master branch and pushing that up.
The reason is that if the work isn&#8217;t accepted or is cherry picked, you don&#8217;t have to rewind your master branch.
If the maintainers merge, rebase, or cherry-pick your work, you&#8217;ll eventually get it back via pulling from their repository anyhow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push -u myfork featureA</code></pre>
</div>
</div>
<div class="paragraph">
<p>
When your work has been pushed up to your fork, you need to notify the maintainer.
This is often called a pull request, and you can either generate it via the website – GitHub has it&#8217;s own Pull Request mechanism that we&#8217;ll go over in <a href="#_github">GitHub</a> – or you can run the <code>git request-pull</code> command and e-mail the output to the project maintainer manually.</p>
</div>
<div class="paragraph">
<p>The <code>request-pull</code> command takes the base branch into which you want your topic branch pulled and the Git repository URL you want them to pull from, and outputs a summary of all the changes you&#8217;re asking to be pulled in.
For instance, if Jessica wants to send John a pull request, and she&#8217;s done two commits on the topic branch she just pushed up, she can run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git request-pull origin/master myfork
The following changes since commit 1edee6b1d61823a2de3b09c160d7080b8d1b3a40:
  John Smith (1):
        added a new function

are available in the git repository at:

  git://githost/simplegit.git featureA

Jessica Smith (2):
      add limit to log function
      change log output to 30 from 25

 lib/simplegit.rb |   10 +++++++++-
 1 files changed, 9 insertions(+), 1 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output can be sent to the maintainer–it tells them where the work was branched from, summarizes the commits, and tells where to pull this work from.</p>
</div>
<div class="paragraph">
<p>On a project for which you&#8217;re not the maintainer, it&#8217;s generally easier to have a branch like <code>master</code> always track <code>origin/master</code> and to do your work in topic branches that you can easily discard if they&#8217;re rejected.
Having work themes isolated into topic branches also makes it easier for you to rebase your work if the tip of the main repository has moved in the meantime and your commits no longer apply cleanly.
For example, if you want to submit a second topic of work to the project, don&#8217;t continue working on the topic branch you just pushed up – start over from the main repository&#8217;s <code>master</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b featureB origin/master
# (work)
$ git commit
$ git push myfork featureB
# (email maintainer)
$ git fetch origin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, each of your topics is contained within a silo – similar to a patch queue – that you can rewrite, rebase, and modify without the topics interfering or interdepending on each other, like so:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/public-small-1.png" alt="Initial commit history with `featureB` work.">
</div>
<div class="title">Figure 70. Initial commit history with <code>featureB</code> work.</div>
</div>
<div class="paragraph">
<p>Let&#8217;s say the project maintainer has pulled in a bunch of other patches and tried your first branch, but it no longer cleanly merges.
In this case, you can try to rebase that branch on top of <code>origin/master</code>, resolve the conflicts for the maintainer, and then resubmit your changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout featureA
$ git rebase origin/master
$ git push -f myfork featureA</code></pre>
</div>
</div>
<div class="paragraph">
<p>This rewrites your history to now look like <a href="#psp_b">Commit history after <code>featureA</code> work.</a>.</p>
</div>
<div id="psp_b" class="imageblock">
<div class="content">
<img src="images/public-small-2.png" alt="Commit history after `featureA` work.">
</div>
<div class="title">Figure 71. Commit history after <code>featureA</code> work.</div>
</div>
<div class="paragraph">
<p>Because you rebased the branch, you have to specify the <code>-f</code> to your push command in order to be able to replace the <code>featureA</code> branch on the server with a commit that isn&#8217;t a descendant of it.
An alternative would be to push this new work to a different branch on the server (perhaps called <code>featureAv2</code>).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at one more possible scenario: the maintainer has looked at work in your second branch and likes the concept but would like you to change an implementation detail.
You&#8217;ll also take this opportunity to move the work to be based off the project&#8217;s current <code>master</code> branch.
You start a new branch based off the current <code>origin/master</code> branch, squash the <code>featureB</code> changes there, resolve any conflicts, make the implementation change, and then push that up as a new branch:</p>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b featureBv2 origin/master
$ git merge --no-commit --squash featureB
# (change implementation)
$ git commit
$ git push myfork featureBv2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--squash</code> option takes all the work on the merged branch and squashes it into one non-merge commit on top of the branch you&#8217;re on.
The <code>--no-commit</code> option tells Git not to automatically record a commit.
This allows you to introduce all the changes from another branch and then make more changes before recording the new commit.</p>
</div>
<div class="paragraph">
<p>Now you can send the maintainer a message that you&#8217;ve made the requested changes and they can find those changes in your <code>featureBv2</code> branch.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/public-small-3.png" alt="Commit history after `featureBv2` work.">
</div>
<div class="title">Figure 72. Commit history after <code>featureBv2</code> work.</div>
</div>
</div>
<div class="sect3">
<h4 id="_project_over_email">Public Project over E-Mail</h4>
<div class="paragraph">
<p>
Many projects have established procedures for accepting patches – you&#8217;ll need to check the specific rules for each project, because they will differ.
Since there are several older, larger projects which accept patches via a developer mailing list, we&#8217;ll go over an example of that now.</p>
</div>
<div class="paragraph">
<p>The workflow is similar to the previous use case – you create topic branches for each patch series you work on.
The difference is how you submit them to the project.
Instead of forking the project and pushing to your own writable version, you generate e-mail versions of each commit series and e-mail them to the developer mailing list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b topicA
# (work)
$ git commit
# (work)
$ git commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>
Now you have two commits that you want to send to the mailing list.
You use <code>git format-patch</code> to generate the mbox-formatted files that you can e-mail to the list – it turns each commit into an e-mail message with the first line of the commit message as the subject and the rest of the message plus the patch that the commit introduces as the body.
The nice thing about this is that applying a patch from an e-mail generated with <code>format-patch</code> preserves all the commit information properly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git format-patch -M origin/master
0001-add-limit-to-log-function.patch
0002-changed-log-output-to-30-from-25.patch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>format-patch</code> command prints out the names of the patch files it creates.
The <code>-M</code> switch tells Git to look for renames.
The files end up looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat 0001-add-limit-to-log-function.patch
From 330090432754092d704da8e76ca5c05c198e71a8 Mon Sep 17 00:00:00 2001
From: Jessica Smith &lt;jessica@example.com&gt;
Date: Sun, 6 Apr 2008 10:17:23 -0700
Subject: [PATCH 1/2] add limit to log function

Limit log functionality to the first 20

---
 lib/simplegit.rb |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/lib/simplegit.rb b/lib/simplegit.rb
index 76f47bc..f9815f1 100644
--- a/lib/simplegit.rb
+++ b/lib/simplegit.rb
@@ -14,7 +14,7 @@ class SimpleGit
   end

   def log(treeish = 'master')
-    command("git log #{treeish}")
+    command("git log -n 20 #{treeish}")
   end

   def ls_tree(treeish = 'master')
--
2.1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also edit these patch files to add more information for the e-mail list that you don&#8217;t want to show up in the commit message.
If you add text between the <code>---</code> line and the beginning of the patch (the <code>diff --git</code> line), then developers can read it; but applying the patch excludes it.</p>
</div>
<div class="paragraph">
<p>To e-mail this to a mailing list, you can either paste the file into your e-mail program or send it via a command-line program.
Pasting the text often causes formatting issues, especially with &#8220;smarter&#8221; clients that don&#8217;t preserve newlines and other whitespace appropriately.
Luckily, Git provides a tool to help you send properly formatted patches via IMAP, which may be easier for you.
We&#8217;ll demonstrate how to send a patch via Gmail, which happens to be the e-mail agent we know best; you can read detailed instructions for a number of mail programs at the end of the aforementioned <code>Documentation/SubmittingPatches</code> file in the Git source code.</p>
</div>
<div class="paragraph">
<p>
First, you need to set up the imap section in your <code>~/.gitconfig</code> file.
You can set each value separately with a series of <code>git config</code> commands, or you can add them manually, but in the end your config file should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[imap]
  folder = "[Gmail]/Drafts"
  host = imaps://imap.gmail.com
  user = user@gmail.com
  pass = p4ssw0rd
  port = 993
  sslverify = false</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your IMAP server doesn&#8217;t use SSL, the last two lines probably aren&#8217;t necessary, and the host value will be <code>imap://</code> instead of <code>imaps://</code>.
When that is set up, you can use <code>git send-email</code> to place the patch series in the Drafts folder of the specified IMAP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git send-email *.patch
0001-added-limit-to-log-function.patch
0002-changed-log-output-to-30-from-25.patch
Who should the emails appear to be from? [Jessica Smith &lt;jessica@example.com&gt;]
Emails will be sent from: Jessica Smith &lt;jessica@example.com&gt;
Who should the emails be sent to? jessica@example.com
Message-ID to be used as In-Reply-To for the first email? y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, Git spits out a bunch of log information looking something like this for each patch you&#8217;re sending:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">(mbox) Adding cc: Jessica Smith &lt;jessica@example.com&gt; from
  \line 'From: Jessica Smith &lt;jessica@example.com&gt;'
OK. Log says:
Sendmail: /usr/sbin/sendmail -i jessica@example.com
From: Jessica Smith &lt;jessica@example.com&gt;
To: jessica@example.com
Subject: [PATCH 1/2] added limit to log function
Date: Sat, 30 May 2009 13:29:15 -0700
Message-Id: &lt;1243715356-61726-1-git-send-email-jessica@example.com&gt;
X-Mailer: git-send-email 1.6.2.rc1.20.g8c5b.dirty
In-Reply-To: &lt;y&gt;
References: &lt;y&gt;

Result: OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, you should be able to go to your Drafts folder, change the To field to the mailing list you&#8217;re sending the patch to, possibly CC the maintainer or person responsible for that section, and send it off.</p>
</div>
</div>
<div class="sect3">
<h4 id="_summary">Summary</h4>
<div class="paragraph">
<p>This section has covered a number of common workflows for dealing with several very different types of Git projects you&#8217;re likely to encounter, and introduced a couple of new tools to help you manage this process.
Next, you&#8217;ll see how to work the other side of the coin: maintaining a Git project.
You&#8217;ll learn how to be a benevolent dictator or integration manager.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maintaining_a_project">Maintaining a Project</h3>
<div class="paragraph">
<p>
In addition to knowing how to effectively contribute to a project, you&#8217;ll likely need to know how to maintain one.
This can consist of accepting and applying patches generated via <code>format-patch</code> and e-mailed to you, or integrating changes in remote branches for repositories you&#8217;ve added as remotes to your project.
Whether you maintain a canonical repository or want to help by verifying or approving patches, you need to know how to accept work in a way that is clearest for other contributors and sustainable by you over the long run.</p>
</div>
<div class="sect3">
<h4 id="_working_in_topic_branches">Working in Topic Branches</h4>
<div class="paragraph">
<p>
When you&#8217;re thinking of integrating new work, it&#8217;s generally a good idea to try it out in a topic branch – a temporary branch specifically made to try out that new work.
This way, it&#8217;s easy to tweak a patch individually and leave it if it&#8217;s not working until you have time to come back to it.
If you create a simple branch name based on the theme of the work you&#8217;re going to try, such as <code>ruby_client</code> or something similarly descriptive, you can easily remember it if you have to abandon it for a while and come back later.
The maintainer of the Git project tends to namespace these branches as well – such as <code>sc/ruby_client</code>, where <code>sc</code> is short for the person who contributed the work.
As you&#8217;ll remember, you can create the branch based off your master branch like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch sc/ruby_client master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you want to also switch to it immediately, you can use the <code>checkout -b</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b sc/ruby_client master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you&#8217;re ready to add your contributed work into this topic branch and determine if you want to merge it into your longer-term branches.</p>
</div>
</div>
<div class="sect3">
<h4 id="_patches_from_email">Applying Patches from E-mail</h4>
<div class="paragraph">
<p>
If you receive a patch over e-mail that you need to integrate into your project, you need to apply the patch in your topic branch to evaluate it.
There are two ways to apply an e-mailed patch: with <code>git apply</code> or with <code>git am</code>.</p>
</div>
<div class="sect4">
<h5 id="_applying_a_patch_with_apply">Applying a Patch with apply</h5>
<div class="paragraph">
<p>
If you received the patch from someone who generated it with the <code>git diff</code> or a Unix <code>diff</code> command (which is not recommended; see the next section), you can apply it with the <code>git apply</code> command.
Assuming you saved the patch at <code>/tmp/patch-ruby-client.patch</code>, you can apply the patch like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git apply /tmp/patch-ruby-client.patch</code></pre>
</div>
</div>
<div class="paragraph">
<p>This modifies the files in your working directory.
It&#8217;s almost identical to running a <code>patch -p1</code> command to apply the patch, although it&#8217;s more paranoid and accepts fewer fuzzy matches than patch.
It also handles file adds, deletes, and renames if they&#8217;re described in the <code>git diff</code> format, which <code>patch</code> won&#8217;t do.
Finally, <code>git apply</code> is an &#8220;apply all or abort all&#8221; model where either everything is applied or nothing is, whereas <code>patch</code> can partially apply patchfiles, leaving your working directory in a weird state.
<code>git apply</code> is overall much more conservative than <code>patch</code>.
It won&#8217;t create a commit for you – after running it, you must stage and commit the changes introduced manually.</p>
</div>
<div class="paragraph">
<p>You can also use git apply to see if a patch applies cleanly before you try actually applying it – you can run <code>git apply --check</code> with the patch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git apply --check 0001-seeing-if-this-helps-the-gem.patch
error: patch failed: ticgit.gemspec:1
error: ticgit.gemspec: patch does not apply</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is no output, then the patch should apply cleanly.
This command also exits with a non-zero status if the check fails, so you can use it in scripts if you want.</p>
</div>
</div>
<div class="sect4">
<h5 id="_git_am">Applying a Patch with <code>am</code></h5>
<div class="paragraph">
<p>
If the contributor is a Git user and was good enough to use the <code>format-patch</code> command to generate their patch, then your job is easier because the patch contains author information and a commit message for you.
If you can, encourage your contributors to use <code>format-patch</code> instead of <code>diff</code> to generate patches for you.
You should only have to use <code>git apply</code> for legacy patches and things like that.</p>
</div>
<div class="paragraph">
<p>To apply a patch generated by <code>format-patch</code>, you use <code>git am</code>.
Technically, <code>git am</code> is built to read an mbox file, which is a simple, plain-text format for storing one or more e-mail messages in one text file.
It looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">From 330090432754092d704da8e76ca5c05c198e71a8 Mon Sep 17 00:00:00 2001
From: Jessica Smith &lt;jessica@example.com&gt;
Date: Sun, 6 Apr 2008 10:17:23 -0700
Subject: [PATCH 1/2] add limit to log function

Limit log functionality to the first 20</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the beginning of the output of the format-patch command that you saw in the previous section.
This is also a valid mbox e-mail format.
If someone has e-mailed you the patch properly using git send-email, and you download that into an mbox format, then you can point git am to that mbox file, and it will start applying all the patches it sees.
If you run a mail client that can save several e-mails out in mbox format, you can save entire patch series into a file and then use git am to apply them one at a time.</p>
</div>
<div class="paragraph">
<p>However, if someone uploaded a patch file generated via <code>format-patch</code> to a ticketing system or something similar, you can save the file locally and then pass that file saved on your disk to <code>git am</code> to apply it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git am 0001-limit-log-function.patch
Applying: add limit to log function</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that it applied cleanly and automatically created the new commit for you.
The author information is taken from the e-mail&#8217;s <code>From</code> and <code>Date</code> headers, and the message of the commit is taken from the <code>Subject</code> and body (before the patch) of the e-mail.
For example, if this patch was applied from the mbox example above, the commit generated would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git log --pretty=fuller -1
commit 6c5e70b984a60b3cecd395edd5b48a7575bf58e0
Author:     Jessica Smith &lt;jessica@example.com&gt;
AuthorDate: Sun Apr 6 10:17:23 2008 -0700
Commit:     Scott Chacon &lt;schacon@gmail.com&gt;
CommitDate: Thu Apr 9 09:19:06 2009 -0700

   add limit to log function

   Limit log functionality to the first 20</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Commit</code> information indicates the person who applied the patch and the time it was applied.
The <code>Author</code> information is the individual who originally created the patch and when it was originally created.</p>
</div>
<div class="paragraph">
<p>But it&#8217;s possible that the patch won&#8217;t apply cleanly.
Perhaps your main branch has diverged too far from the branch the patch was built from, or the patch depends on another patch you haven&#8217;t applied yet.
In that case, the <code>git am</code> process will fail and ask you what you want to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git am 0001-seeing-if-this-helps-the-gem.patch
Applying: seeing if this helps the gem
error: patch failed: ticgit.gemspec:1
error: ticgit.gemspec: patch does not apply
Patch failed at 0001.
When you have resolved this problem run "git am --resolved".
If you would prefer to skip this patch, instead run "git am --skip".
To restore the original branch and stop patching run "git am --abort".</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command puts conflict markers in any files it has issues with, much like a conflicted merge or rebase operation.
You solve this issue much the same way – edit the file to resolve the conflict, stage the new file, and then run <code>git am --resolved</code> to continue to the next patch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ (fix the file)
$ git add ticgit.gemspec
$ git am --resolved
Applying: seeing if this helps the gem</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want Git to try a bit more intelligently to resolve the conflict, you can pass a <code>-3</code> option to it, which makes Git attempt a three-way merge.
This option isn&#8217;t on by default because it doesn&#8217;t work if the commit the patch says it was based on isn&#8217;t in your repository.
If you do have that commit – if the patch was based on a public commit – then the <code>-3</code> option is generally much smarter about applying a conflicting patch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git am -3 0001-seeing-if-this-helps-the-gem.patch
Applying: seeing if this helps the gem
error: patch failed: ticgit.gemspec:1
error: ticgit.gemspec: patch does not apply
Using index info to reconstruct a base tree...
Falling back to patching base and 3-way merge...
No changes -- Patch already applied.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, this patch had already been applied.
Without the <code>-3</code> option, it looks like a conflict.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re applying a number of patches from an mbox, you can also run the <code>am</code> command in interactive mode, which stops at each patch it finds and asks if you want to apply it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git am -3 -i mbox
Commit Body is:
--------------------------
seeing if this helps the gem
--------------------------
Apply? [y]es/[n]o/[e]dit/[v]iew patch/[a]ccept all</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is nice if you have a number of patches saved, because you can view the patch first if you don&#8217;t remember what it is, or not apply the patch if you&#8217;ve already done so.</p>
</div>
<div class="paragraph">
<p>When all the patches for your topic are applied and committed into your branch, you can choose whether and how to integrate them into a longer-running branch.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_checking_out_remotes">Checking Out Remote Branches</h4>
<div class="paragraph">
<p>
If your contribution came from a Git user who set up their own repository, pushed a number of changes into it, and then sent you the URL to the repository and the name of the remote branch the changes are in, you can add them as a remote and do merges locally.</p>
</div>
<div class="paragraph">
<p>For instance, if Jessica sends you an e-mail saying that she has a great new feature in the <code>ruby-client</code> branch of her repository, you can test it by adding the remote and checking out that branch locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add jessica git://github.com/jessica/myproject.git
$ git fetch jessica
$ git checkout -b rubyclient jessica/ruby-client</code></pre>
</div>
</div>
<div class="paragraph">
<p>If she e-mails you again later with another branch containing another great feature, you can fetch and check out because you already have the remote setup.</p>
</div>
<div class="paragraph">
<p>This is most useful if you&#8217;re working with a person consistently.
If someone only has a single patch to contribute once in a while, then accepting it over e-mail may be less time consuming than requiring everyone to run their own server and having to continually add and remove remotes to get a few patches.
You&#8217;re also unlikely to want to have hundreds of remotes, each for someone who contributes only a patch or two.
However, scripts and hosted services may make this easier – it depends largely on how you develop and how your contributors develop.</p>
</div>
<div class="paragraph">
<p>The other advantage of this approach is that you get the history of the commits as well.
Although you may have legitimate merge issues, you know where in your history their work is based; a proper three-way merge is the default rather than having to supply a <code>-3</code> and hope the patch was generated off a public commit to which you have access.</p>
</div>
<div class="paragraph">
<p>If you aren&#8217;t working with a person consistently but still want to pull from them in this way, you can provide the URL of the remote repository to the <code>git pull</code> command.
This does a one-time pull and doesn&#8217;t save the URL as a remote reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git pull https://github.com/onetimeguy/project
From https://github.com/onetimeguy/project
 * branch            HEAD       -&gt; FETCH_HEAD
Merge made by recursive.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_is_introduced">Determining What Is Introduced</h4>
<div class="paragraph">
<p>
Now you have a topic branch that contains contributed work.
At this point, you can determine what you&#8217;d like to do with it.
This section revisits a couple of commands so you can see how you can use them to review exactly what you&#8217;ll be introducing if you merge this into your main branch.</p>
</div>
<div class="paragraph">
<p>It&#8217;s often helpful to get a review of all the commits that are in this branch but that aren&#8217;t in your master branch.
You can exclude commits in the master branch by adding the <code>--not</code> option before the branch name.
This does the same thing as the <code>master..contrib</code> format that we used earlier.
For example, if your contributor sends you two patches and you create a branch called <code>contrib</code> and applied those patches there, you can run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log contrib --not master
commit 5b6235bd297351589efc4d73316f0a68d484f118
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri Oct 24 09:53:59 2008 -0700

    seeing if this helps the gem

commit 7482e0d16d04bea79d0dba8988cc78df655f16a0
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Mon Oct 22 19:38:36 2008 -0700

    updated the gemspec to hopefully work better</code></pre>
</div>
</div>
<div class="paragraph">
<p>To see what changes each commit introduces, remember that you can pass the <code>-p</code> option to <code>git log</code> and it will append the diff introduced to each commit.</p>
</div>
<div class="paragraph">
<p>To see a full diff of what would happen if you were to merge this topic branch with another branch, you may have to use a weird trick to get the correct results.
You may think to run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff master</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command gives you a diff, but it may be misleading.
If your <code>master</code> branch has moved forward since you created the topic branch from it, then you&#8217;ll get seemingly strange results.
This happens because Git directly compares the snapshots of the last commit of the topic branch you&#8217;re on and the snapshot of the last commit on the <code>master</code> branch.
For example, if you&#8217;ve added a line in a file on the <code>master</code> branch, a direct comparison of the snapshots will look like the topic branch is going to remove that line.</p>
</div>
<div class="paragraph">
<p>If <code>master</code> is a direct ancestor of your topic branch, this isn&#8217;t a problem; but if the two histories have diverged, the diff will look like you&#8217;re adding all the new stuff in your topic branch and removing everything unique to the <code>master</code> branch.</p>
</div>
<div class="paragraph">
<p>What you really want to see are the changes added to the topic branch – the work you&#8217;ll introduce if you merge this branch with master.
You do that by having Git compare the last commit on your topic branch with the first common ancestor it has with the master branch.</p>
</div>
<div class="paragraph">
<p>Technically, you can do that by explicitly figuring out the common ancestor and then running your diff on it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge-base contrib master
36c7dba2c95e6bbb78dfa822519ecfec6e1ca649
$ git diff 36c7db</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, that isn&#8217;t convenient, so Git provides another shorthand for doing the same thing: the triple-dot syntax.
In the context of the <code>diff</code> command, you can put three periods after another branch to do a <code>diff</code> between the last commit of the branch you&#8217;re on and its common ancestor with another branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff master...contrib</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command shows you only the work your current topic branch has introduced since its common ancestor with master.
That is a very useful syntax to remember.</p>
</div>
</div>
<div class="sect3">
<h4 id="_integrating_contributed_work">Integrating Contributed Work</h4>
<div class="paragraph">
<p>
When all the work in your topic branch is ready to be integrated into a more mainline branch, the question is how to do it.
Furthermore, what overall workflow do you want to use to maintain your project?
You have a number of choices, so we&#8217;ll cover a few of them.</p>
</div>
<div class="sect4">
<h5 id="_merging_workflows">Merging Workflows</h5>
<div class="paragraph">
<p>
One simple workflow merges your work into your <code>master</code> branch.
In this scenario, you have a <code>master</code> branch that contains basically stable code.
When you have work in a topic branch that you&#8217;ve done or that someone has contributed and you&#8217;ve verified, you merge it into your master branch, delete the topic branch, and then continue the process.
If we have a repository with work in two branches named <code>ruby_client</code> and <code>php_client</code> that looks like <a href="#merwf_a">History with several topic branches.</a> and merge <code>ruby_client</code> first and then <code>php_client</code> next, then your history will end up looking like <a href="#merwf_b">After a topic branch merge.</a>.</p>
</div>
<div id="merwf_a" class="imageblock">
<div class="content">
<img src="images/merging-workflows-1.png" alt="History with several topic branches.">
</div>
<div class="title">Figure 73. History with several topic branches.</div>
</div>
<div id="merwf_b" class="imageblock">
<div class="content">
<img src="images/merging-workflows-2.png" alt="After a topic branch merge.">
</div>
<div class="title">Figure 74. After a topic branch merge.</div>
</div>
<div class="paragraph">
<p>That is probably the simplest workflow, but it can possibly be problematic if you&#8217;re dealing with larger or more stable projects where you want to be really careful about what you introduce.</p>
</div>
<div class="paragraph">
<p>If you have a more important project, you might want to use a two-phase merge cycle.
In this scenario, you have two long-running branches, <code>master</code> and <code>develop</code>, in which you determine that <code>master</code> is updated only when a very stable release is cut and all new code is integrated into the <code>develop</code> branch.
You regularly push both of these branches to the public repository.
Each time you have a new topic branch to merge in (<a href="#merwf_c">Before a topic branch merge.</a>), you merge it into <code>develop</code> (<a href="#merwf_d">After a topic branch merge.</a>); then, when you tag a release, you fast-forward <code>master</code> to wherever the now-stable <code>develop</code> branch is (<a href="#merwf_e">After a project release.</a>).</p>
</div>
<div id="merwf_c" class="imageblock">
<div class="content">
<img src="images/merging-workflows-3.png" alt="Before a topic branch merge.">
</div>
<div class="title">Figure 75. Before a topic branch merge.</div>
</div>
<div id="merwf_d" class="imageblock">
<div class="content">
<img src="images/merging-workflows-4.png" alt="After a topic branch merge.">
</div>
<div class="title">Figure 76. After a topic branch merge.</div>
</div>
<div id="merwf_e" class="imageblock">
<div class="content">
<img src="images/merging-workflows-5.png" alt="After a topic branch release.">
</div>
<div class="title">Figure 77. After a project release.</div>
</div>
<div class="paragraph">
<p>This way, when people clone your project&#8217;s repository, they can either check out master to build the latest stable version and keep up to date on that easily, or they can check out develop, which is the more cutting-edge stuff.
You can also continue this concept, having an integrate branch where all the work is merged together.
Then, when the codebase on that branch is stable and passes tests, you merge it into a develop branch; and when that has proven itself stable for a while, you fast-forward your master branch.</p>
</div>
</div>
<div class="sect4">
<h5 id="_large_merging_workflows">Large-Merging Workflows</h5>
<div class="paragraph">
<p>
The Git project has four long-running branches: <code>master</code>, <code>next</code>, and <code>pu</code> (proposed updates) for new work, and <code>maint</code> for maintenance backports.
When new work is introduced by contributors, it&#8217;s collected into topic branches in the maintainer&#8217;s repository in a manner similar to what we&#8217;ve described (see <a href="#merwf_f">Managing a complex series of parallel contributed topic branches.</a>).
At this point, the topics are evaluated to determine whether they&#8217;re safe and ready for consumption or whether they need more work.
If they&#8217;re safe, they&#8217;re merged into <code>next</code>, and that branch is pushed up so everyone can try the topics integrated together.</p>
</div>
<div id="merwf_f" class="imageblock">
<div class="content">
<img src="images/large-merges-1.png" alt="Managing a complex series of parallel contributed topic branches.">
</div>
<div class="title">Figure 78. Managing a complex series of parallel contributed topic branches.</div>
</div>
<div class="paragraph">
<p>If the topics still need work, they&#8217;re merged into <code>pu</code> instead.
When it&#8217;s determined that they&#8217;re totally stable, the topics are re-merged into <code>master</code> and are then rebuilt from the topics that were in <code>next</code> but didn&#8217;t yet graduate to <code>master</code>.
This means <code>master</code> almost always moves forward, <code>next</code> is rebased occasionally, and <code>pu</code> is rebased even more often:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/large-merges-2.png" alt="Merging contributed topic branches into long-term integration branches.">
</div>
<div class="title">Figure 79. Merging contributed topic branches into long-term integration branches.</div>
</div>
<div class="paragraph">
<p>When a topic branch has finally been merged into <code>master</code>, it&#8217;s removed from the repository.
The Git project also has a <code>maint</code> branch that is forked off from the last release to provide backported patches in case a maintenance release is required.
Thus, when you clone the Git repository, you have four branches that you can check out to evaluate the project in different stages of development, depending on how cutting edge you want to be or how you want to contribute; and the maintainer has a structured workflow to help them vet new contributions.</p>
</div>
</div>
<div class="sect4">
<h5 id="_rebase_cherry_pick">Rebasing and Cherry Picking Workflows</h5>
<div class="paragraph">
<p>
Other maintainers prefer to rebase or cherry-pick contributed work on top of their master branch, rather than merging it in, to keep a mostly linear history.
When you have work in a topic branch and have determined that you want to integrate it, you move to that branch and run the rebase command to rebuild the changes on top of your current master (or <code>develop</code>, and so on) branch.
If that works well, you can fast-forward your <code>master</code> branch, and you&#8217;ll end up with a linear project history.</p>
</div>
<div class="paragraph">
<p>
The other way to move introduced work from one branch to another is to cherry-pick it.
A cherry-pick in Git is like a rebase for a single commit.
It takes the patch that was introduced in a commit and tries to reapply it on the branch you&#8217;re currently on.
This is useful if you have a number of commits on a topic branch and you want to integrate only one of them, or if you only have one commit on a topic branch and you&#8217;d prefer to cherry-pick it rather than run rebase.
For example, suppose you have a project that looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rebasing-1.png" alt="Example history before a cherry-pick.">
</div>
<div class="title">Figure 80. Example history before a cherry-pick.</div>
</div>
<div class="paragraph">
<p>If you want to pull commit <code>e43a6</code> into your master branch, you can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cherry-pick e43a6fd3e94888d76779ad79fb568ed180e5fcdf
Finished one cherry-pick.
[master]: created a0a41a9: "More friendly message when locking the index fails."
 3 files changed, 17 insertions(+), 3 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pulls the same change introduced in <code>e43a6</code>, but you get a new commit SHA-1 value, because the date applied is different.
Now your history looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rebasing-2.png" alt="History after cherry-picking a commit on a topic branch.">
</div>
<div class="title">Figure 81. History after cherry-picking a commit on a topic branch.</div>
</div>
<div class="paragraph">
<p>Now you can remove your topic branch and drop the commits you didn&#8217;t want to pull in.</p>
</div>
</div>
<div class="sect4">
<h5 id="_rerere">Rerere</h5>
<div class="paragraph">
<p>
If you&#8217;re doing lots of merging and rebasing, or you&#8217;re maintaining a long-lived topic branch, Git has a feature called &#8220;rerere&#8221; that can help.</p>
</div>
<div class="paragraph">
<p>Rerere stands for &#8220;reuse recorded resolution&#8221; – it&#8217;s a way of shortcutting manual conflict resolution.
When rerere is enabled, Git will keep a set of pre- and post-images from successful merges, and if it notices that there&#8217;s a conflict that looks exactly like one you&#8217;ve already fixed, it&#8217;ll just use the fix from last time, without bothering you with it.</p>
</div>
<div class="paragraph">
<p>This feature comes in two parts: a configuration setting and a command.
The configuration setting is <code>rerere.enabled</code>, and it&#8217;s handy enough to put in your global config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global rerere.enabled true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, whenever you do a merge that resolves conflicts, the resolution will be recorded in the cache in case you need it in the future.</p>
</div>
<div class="paragraph">
<p>If you need to, you can interact with the rerere cache using the <code>git rerere</code> command.
When it&#8217;s invoked alone, Git checks its database of resolutions and tries to find a match with any current merge conflicts and resolve them (although this is done automatically if <code>rerere.enabled</code> is set to <code>true</code>).
There are also subcommands to see what will be recorded, to erase specific resolution from the cache, and to clear the entire cache. We will cover rerere in more detail in <a href="#_rerere">Rerere</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tagging_releases">Tagging Your Releases</h4>
<div class="paragraph">
<p>
When you&#8217;ve decided to cut a release, you&#8217;ll probably want to drop a tag so you can re-create that release at any point going forward.
You can create a new tag as discussed in <a href="#_git_basics_chapter">Git 基础</a>.
If you decide to sign the tag as the maintainer, the tagging may look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -s v1.5 -m 'my signed 1.5 tag'
You need a passphrase to unlock the secret key for
user: "Scott Chacon &lt;schacon@gmail.com&gt;"
1024-bit DSA key, ID F721C45A, created 2009-02-09</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do sign your tags, you may have the problem of distributing the public PGP key used to sign your tags.
The maintainer of the Git project has solved this issue by including their public key as a blob in the repository and then adding a tag that points directly to that content.
To do this, you can figure out which key you want by running <code>gpg --list-keys</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ gpg --list-keys
/Users/schacon/.gnupg/pubring.gpg
---------------------------------
pub   1024D/F721C45A 2009-02-09 [expires: 2010-02-09]
uid                  Scott Chacon &lt;schacon@gmail.com&gt;
sub   2048g/45D02282 2009-02-09 [expires: 2010-02-09]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you can directly import the key into the Git database by exporting it and piping that through <code>git hash-object</code>, which writes a new blob with those contents into Git and gives you back the SHA-1 of the blob:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ gpg -a --export F721C45A | git hash-object -w --stdin
659ef797d181633c87ec71ac3f9ba29fe5775b92</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you have the contents of your key in Git, you can create a tag that points directly to it by specifying the new SHA-1 value that the <code>hash-object</code> command gave you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -a maintainer-pgp-pub 659ef797d181633c87ec71ac3f9ba29fe5775b92</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run <code>git push --tags</code>, the <code>maintainer-pgp-pub</code> tag will be shared with everyone.
If anyone wants to verify a tag, they can directly import your PGP key by pulling the blob directly out of the database and importing it into GPG:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show maintainer-pgp-pub | gpg --import</code></pre>
</div>
</div>
<div class="paragraph">
<p>They can use that key to verify all your signed tags.
Also, if you include instructions in the tag message, running <code>git show &lt;tag&gt;</code> will let you give the end user more specific instructions about tag verification.</p>
</div>
</div>
<div class="sect3">
<h4 id="_build_number">Generating a Build Number</h4>
<div class="paragraph">
<p>
Because Git doesn&#8217;t have monotonically increasing numbers like <em>v123</em> or the equivalent to go with each commit, if you want to have a human-readable name to go with a commit, you can run <code>git describe</code> on that commit.
Git gives you the name of the nearest tag with the number of commits on top of that tag and a partial SHA-1 value of the commit you&#8217;re describing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git describe master
v1.6.2-rc1-20-g8c5b85c</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, you can export a snapshot or build and name it something understandable to people.
In fact, if you build Git from source code cloned from the Git repository, <code>git --version</code> gives you something that looks like this.
If you&#8217;re describing a commit that you have directly tagged, it gives you the tag name.</p>
</div>
<div class="paragraph">
<p>The <code>git describe</code> command favors annotated tags (tags created with the <code>-a</code> or <code>-s</code> flag), so release tags should be created this way if you&#8217;re using <code>git describe</code>, to ensure the commit is named properly when described.
You can also use this string as the target of a checkout or show command, although it relies on the abbreviated SHA-1 value at the end, so it may not be valid forever.
For instance, the Linux kernel recently jumped from 8 to 10 characters to ensure SHA-1 object uniqueness, so older <code>git describe</code> output names were invalidated.</p>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_release">Preparing a Release</h4>
<div class="paragraph">
<p>
Now you want to release a build.
One of the things you&#8217;ll want to do is create an archive of the latest snapshot of your code for those poor souls who don&#8217;t use Git.
The command to do this is <code>git archive</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git archive master --prefix='project/' | gzip &gt; `git describe master`.tar.gz
$ ls *.tar.gz
v1.6.2-rc1-20-g8c5b85c.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>If someone opens that tarball, they get the latest snapshot of your project under a project directory.
You can also create a zip archive in much the same way, but by passing the <code>--format=zip</code> option to <code>git archive</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git archive master --prefix='project/' --format=zip &gt; `git describe master`.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>You now have a nice tarball and a zip archive of your project release that you can upload to your website or e-mail to people.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_shortlog">The Shortlog</h4>
<div class="paragraph">
<p>
It&#8217;s time to e-mail your mailing list of people who want to know what&#8217;s happening in your project.
A nice way of quickly getting a sort of changelog of what has been added to your project since your last release or e-mail is to use the <code>git shortlog</code> command.
It summarizes all the commits in the range you give it; for example, the following gives you a summary of all the commits since your last release, if your last release was named v1.0.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git shortlog --no-merges master --not v1.0.1
Chris Wanstrath (8):
      Add support for annotated tags to Grit::Tag
      Add packed-refs annotated tag support.
      Add Grit::Commit#to_patch
      Update version and History.txt
      Remove stray `puts`
      Make ls_tree ignore nils

Tom Preston-Werner (4):
      fix dates in history
      dynamic version method
      Version bump to 1.0.2
      Regenerated gemspec for version 1.0.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>You get a clean summary of all the commits since v1.0.1, grouped by author, that you can e-mail to your list.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_2">Summary</h3>
<div class="paragraph">
<p>You should feel fairly comfortable contributing to a project in Git as well as maintaining your own project or integrating other users' contributions.
Congratulations on being an effective Git developer!
In the next chapter, you&#8217;ll learn about how to use the largest and most popular Git hosting service, GitHub.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_github">GitHub</h2>
<div class="sectionbody">
<div class="paragraph">
<p>
GitHub is the single largest host for Git repositories, and is the central point of collaboration for millions of developers and projects.
A large percentage of all Git repositories are hosted on GitHub, and many open-source projects use it for Git hosting, issue tracking, code review, and other things.
So while it&#8217;s not a direct part of the Git open source project, there&#8217;s a good chance that you&#8217;ll want or need to interact with GitHub at some point while using Git professionally.</p>
</div>
<div class="paragraph">
<p>This chapter is about using GitHub effectively.
We&#8217;ll cover signing up for and managing an account, creating and using Git repositories, common workflows to contribute to projects and to accept contributions to yours, GitHub&#8217;s programmatic interface and lots of little tips to make your life easier in general.</p>
</div>
<div class="paragraph">
<p>If you are not interested in using GitHub to host your own projects or to collaborate with other projects that are hosted on GitHub, you can safely skip to <a href="#_git_tools">Git 工具</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">Interfaces Change</div>
<div class="paragraph">
<p>It&#8217;s important to note that like many active websites, the UI elements in these screenshots are bound to change over time. Hopefully the general idea of what we&#8217;re trying to accomplish here will still be there, but if you want more up to date versions of these screens, the online versions of this book may have newer screenshots.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_account_setup_and_configuration">Account Setup and Configuration</h3>
<div class="paragraph">
<p>
The first thing you need to do is set up a free user account.
Simply visit <a href="https://github.com" class="bare">https://github.com</a>, choose a user name that isn&#8217;t already taken, provide an email address and a password, and click the big green &#8220;Sign up for GitHub&#8221; button.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/signup.png" alt="The GitHub sign-up form.">
</div>
<div class="title">Figure 82. The GitHub sign-up form.</div>
</div>
<div class="paragraph">
<p>The next thing you&#8217;ll see is the pricing page for upgraded plans, but it&#8217;s safe to ignore this for now.
GitHub will send you an email to verify the address you provided.
Go ahead and do this, it&#8217;s pretty important (as we&#8217;ll see later).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>GitHub provides all of its functionality with free accounts, with the limitation that all of your projects are fully public (everyone has read access).
GitHub&#8217;s paid plans include a set number of private projects, but we won&#8217;t be covering those in this book.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Clicking the Octocat logo at the top-left of the screen will take you to your dashboard page.
You&#8217;re now ready to use GitHub.</p>
</div>
<div class="sect3">
<h4 id="_ssh_access_2">SSH Access</h4>
<div class="paragraph">
<p>
As of right now, you&#8217;re fully able to connect with Git repositories using the <code>https://</code> protocol, authenticating with the username and password you just set up.
However, to simply clone public projects, you don&#8217;t even need to sign up - the account we just created comes into play when we fork projects and push to our forks a bit later.</p>
</div>
<div class="paragraph">
<p>If you&#8217;d like to use SSH remotes, you&#8217;ll need to configure a public key.
(If you don&#8217;t already have one, see <a href="#_generate_ssh_key">Generating Your SSH Public Key</a>.)
Open up your account settings using the link at the top-right of the window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/account-settings.png" alt="The ``Account settings'' link.">
</div>
<div class="title">Figure 83. The &#8220;Account settings&#8221; link.</div>
</div>
<div class="paragraph">
<p>Then select the &#8220;SSH keys&#8221; section along the left-hand side.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ssh-keys.png" alt="The ``SSH keys'' link.">
</div>
<div class="title">Figure 84. The &#8220;SSH keys&#8221; link.</div>
</div>
<div class="paragraph">
<p>From there, click the "<code>Add an SSH key</code>" button, give your key a name, paste the contents of your <code>~/.ssh/id_rsa.pub</code> (or whatever you named it) public-key file into the text area, and click &#8220;Add key&#8221;.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Be sure to name your SSH key something you can remember. You can name each of your keys (eg, "My Laptop" or "Work Account") so that if you need to revoke a key later, you can easily tell which one you&#8217;re looking for.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_personal_avatar">Your Avatar</h4>
<div class="paragraph">
<p>Next, if you wish, you can replace the avatar that is generated for you with an image of your choosing. First go to the &#8220;Profile&#8221; tab (above the SSH Keys tab) and click &#8220;Upload new picture&#8221;.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/your-profile.png" alt="The ``Profile'' link.">
</div>
<div class="title">Figure 85. The &#8220;Profile&#8221; link.</div>
</div>
<div class="paragraph">
<p>We&#8217;ll chose a copy of the Git logo that is on our hard drive and then we get a chance to crop it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/avatar-crop.png" alt="Crop your uploaded avatar.">
</div>
<div class="title">Figure 86. Crop your avatar</div>
</div>
<div class="paragraph">
<p>Now anywhere you interact on the site, people will see your avatar next to your username.</p>
</div>
<div class="paragraph">
<p>If you happen to have uploaded an avatar to the popular Gravatar service (often used for Wordpress accounts), that avatar will be used by default and you don&#8217;t need to do this step.</p>
</div>
</div>
<div class="sect3">
<h4 id="_your_email_addresses">Your Email Addresses</h4>
<div class="paragraph">
<p>The way that GitHub maps your Git commits to your user is by email address. If you use multiple email addresses in your commits and you want GitHub to link them up properly, you need to add all the email addresses you have used to the Emails section of the admin section.</p>
</div>
<div id="_add_email_addresses" class="imageblock">
<div class="content">
<img src="images/email-settings.png" alt="Add all your email addresses.">
</div>
<div class="title">Figure 87. Add email addresses</div>
</div>
<div class="paragraph">
<p>In <a href="#_add_email_addresses">Add email addresses</a> we can see some of the different states that are possible. The top address is verified and set as the primary address, meaning that is where you&#8217;ll get any notifications and receipts. The second address is verified and so can be set as the primary if you wish to switch them. The final address is unverified, meaning that you can&#8217;t make it your primary address. If GitHub sees any of these in commit messages in any repository on the site, it will be linked to your user now.</p>
</div>
</div>
<div class="sect3">
<h4 id="_two_factor_authentication">Two Factor Authentication</h4>
<div class="paragraph">
<p>Finally, for extra security, you should definitely set up Two-factor Authentication or &#8220;2FA&#8221;. Two-factor Authentication is an authentication mechanism that is becoming more and more popular recently to mitigate the risk of your account being compromised if your password is stolen somehow. Turning it on will make GitHub ask you for two different methods of authentication, so that if one of them is compromised, an attacker will not be able to access your account.</p>
</div>
<div class="paragraph">
<p>You can find the Two-factor Authentication setup under the Security tab of your Account settings.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/2fa-1.png" alt="2FA in the Security Tab">
</div>
<div class="title">Figure 88. 2FA in the Security Tab</div>
</div>
<div class="paragraph">
<p>If you click on the &#8220;Set up two-factor authentication&#8221; button, it will take you to a configuration page where you can choose to use a phone app to generate your secondary code (a &#8220;time based one-time password&#8221;), or you can have GitHub send you a code via SMS each time you need to log in.</p>
</div>
<div class="paragraph">
<p>After you choose which method you prefer and follow the instructions for setting up 2FA, your account will then be a little more secure and you will have to provide a code in addition to your password whenever you log into GitHub.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contributing_to_a_project">Contributing to a Project</h3>
<div class="paragraph">
<p>Now that our account is setup, let&#8217;s walk through some details that could be useful in helping you contribute to an existing project.</p>
</div>
<div class="sect3">
<h4 id="_forking_projects">Forking Projects</h4>
<div class="paragraph">
<p>
If you want to contribute to an existing project to which you don’t have push access, you can &#8220;fork&#8221; the project.
What this means is that GitHub will make a copy of the project that is entirely yours; it lives in your user&#8217;s namespace, and you can push to it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Historically, the term &#8220;fork&#8221; has been somewhat negative in context, meaning that someone took an open source project in a different direction, sometimes creating a competing project and splitting the contributors.
In GitHub, a &#8220;fork&#8221; is simply the same project in your own namespace, allowing you to make changes to a project publicly as a way to contribute in a more open manner.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This way, projects don’t have to worry about adding users as collaborators to give them push access.
People can fork a project, push to it, and contribute their changes back to the original repository by creating what&#8217;s called a Pull Request, which we&#8217;ll cover next.
This opens up a discussion thread with code review, and the owner and the contributor can then communicate about the change until the owner is happy with it, at which point the owner can merge it in.</p>
</div>
<div class="paragraph">
<p>To fork a project, visit the project page and click the &#8220;Fork&#8221; button at the top-right of the page.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/forkbutton.png" alt="The ``Fork'' button.">
</div>
<div class="title">Figure 89. The &#8220;Fork&#8221; button.</div>
</div>
<div class="paragraph">
<p>After a few seconds, you&#8217;ll be taken to your new project page, with your own writeable copy of the code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_github_flow">The GitHub Flow</h4>
<div class="paragraph">
<p>
GitHub is designed around a particular collaboration workflow, centered on Pull Requests.
This flow works whether you&#8217;re collaborating with a tightly-knit team in a single shared repository, or a globally-distributed company or network of strangers contributing to an project through dozens of forks.
It is centered on the <a href="#_topic_branch">Topic Branches</a> workflow covered  in <a href="#_git_branching">Git 分支</a>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how it generally works:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a topic branch from <code>master</code>.</p>
</li>
<li>
<p>Make some commits to improve the project.</p>
</li>
<li>
<p>Push this branch to your GitHub project.</p>
</li>
<li>
<p>Open a Pull Request on GitHub.</p>
</li>
<li>
<p>Discuss, and optionally continue committing.</p>
</li>
<li>
<p>The project owner merges or closes the Pull Request.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is basically the Integration Manager workflow covered in <a href="#_integration_manager">Integration-Manager Workflow</a>, but instead of using email to communicate and review changes, teams use GitHub&#8217;s web based tools.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through an example of proposing a change to an open source project hosted on GitHub using this flow.</p>
</div>
<div class="sect4">
<h5 id="_creating_a_pull_request">Creating a Pull Request</h5>
<div class="paragraph">
<p>Tony is looking for code to run on his Arduino programmable microcontroller and has found a great program file on GitHub at <a href="https://github.com/schacon/blink" class="bare">https://github.com/schacon/blink</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/blink-01-start.png" alt="The project we want to contribute to.">
</div>
<div class="title">Figure 90. The project we want to contribute to.</div>
</div>
<div class="paragraph">
<p>The only problem is that the blinking rate is too fast, we think it&#8217;s much nicer to wait 3 seconds instead of 1 in between each state change. So let&#8217;s improve the program and submit it back to the project as a proposed change.</p>
</div>
<div class="paragraph">
<p>First, we click the <em>Fork</em> button as mentioned earlier to get our own copy of the project. Our user name here is &#8220;tonychacon&#8221; so our copy of this project is at <code>https://github.com/tonychacon/blink</code> and that&#8217;s where we can edit it. We will clone it locally, create a topic branch, make the code change and finally push that change back up to GitHub.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ git clone https://github.com/tonychacon/blink <b class="conum">(1)</b>
Cloning into 'blink'...

$ cd blink
$ git checkout -b slow-blink <b class="conum">(2)</b>
Switched to a new branch 'slow-blink'

$ sed -i '' 's/1000/3000/' blink.ino <b class="conum">(3)</b>

$ git diff --word-diff <b class="conum">(4)</b>
diff --git a/blink.ino b/blink.ino
index 15b9911..a6cc5a5 100644
--- a/blink.ino
+++ b/blink.ino
@@ -18,7 +18,7 @@ void setup() {
// the loop routine runs over and over again forever:
void loop() {
  digitalWrite(led, HIGH);   // turn the LED on (HIGH is the voltage level)
  [-delay(1000);-]{+delay(3000);+}               // wait for a second
  digitalWrite(led, LOW);    // turn the LED off by making the voltage LOW
  [-delay(1000);-]{+delay(3000);+}               // wait for a second
}

$ git commit -a -m 'three seconds is better' <b class="conum">(5)</b>
[master 5ca509d] three seconds is better
 1 file changed, 2 insertions(+), 2 deletions(-)

$ git push origin slow-blink <b class="conum">(6)</b>
Username for 'https://github.com': tonychacon
Password for 'https://tonychacon@github.com':
Counting objects: 5, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 340 bytes | 0 bytes/s, done.
Total 3 (delta 1), reused 0 (delta 0)
To https://github.com/tonychacon/blink
 * [new branch]      slow-blink -&gt; slow-blink</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Clone our fork of the project locally</p>
</li>
<li>
<p>Create a descriptive topic branch</p>
</li>
<li>
<p>Make our change to the code</p>
</li>
<li>
<p>Check that the change is good</p>
</li>
<li>
<p>Commit our change to the topic branch</p>
</li>
<li>
<p>Push our new topic branch back up to our GitHub fork</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now if we go back to our fork on GitHub, we can see that GitHub noticed that we pushed a new topic branch up and present us with a big green button to check out our changes and open a Pull Request to the original project.</p>
</div>
<div class="paragraph">
<p>You can alternatively go to the &#8220;Branches&#8221; page at <code>https://github.com/&lt;user&gt;/&lt;project&gt;/branches</code> to locate your branch and open a new Pull Request from there.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/blink-02-pr.png" alt="Pull Request button">
</div>
<div class="title">Figure 91. Pull Request button</div>
</div>
<div class="paragraph">
<p>
If we click that green button, we&#8217;ll see a screen that allows us to create a title and description for the change we would like to request so the project owner has a good reason to consider it. It is generally a good idea to spend some effort making this description as useful as possible so the author knows why this is being suggested and why it would be a valuable change for them to accept.</p>
</div>
<div class="paragraph">
<p>We also see a list of the commits in our topic branch that are &#8220;ahead&#8221; of the <code>master</code> branch (in this case, just the one) and a unified diff of all the changes that will be made should this branch get merged by the project owner.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/blink-03-pull-request-open.png" alt="Pull Request creation">
</div>
<div class="title">Figure 92. Pull Request creation page</div>
</div>
<div class="paragraph">
<p>When you hit the <em>Create pull request</em> button on this screen, the owner of the project you forked will get a notification that someone is suggesting a change and will link to a page that has all of this information on it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Though Pull Requests are used commonly for public projects like this when the contributor has a complete change ready to be made, it&#8217;s also often used in internal projects <em>at the beginning</em> of the development cycle.  Since you can keep pushing to the topic branch even <strong>after</strong> the Pull Request is opened, it&#8217;s often opened early and used as a way to iterate on work as a team within a context, rather than opened at the very end of the process.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_iterating_on_a_pull_request">Iterating on a Pull Request</h5>
<div class="paragraph">
<p>At this point, the project owner can look at the suggested change and merge it, reject it or comment on it. Let&#8217;s say that he likes the idea, but would prefer a slightly longer time for the light to be off than on.</p>
</div>
<div class="paragraph">
<p>Where this conversation may take place over email in the workflows presented in <a href="#_distributed_git">Distributed Git</a>, on GitHub this happens online. The project owner can review the unified diff and leave a comment by clicking on any of the lines.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/blink-04-pr-comment.png" alt="PR line comment">
</div>
<div class="title">Figure 93. Comment on a specific line of code in a Pull Request</div>
</div>
<div class="paragraph">
<p>Once the maintainer makes this comment, the person who opened the Pull Request (and indeed, anyone else watching the repository) will get a notification. We&#8217;ll go over customizing this later, but if he had email notifications turned on, Tony would get an email like this:</p>
</div>
<div id="_email_notification" class="imageblock">
<div class="content">
<img src="images/blink-04-email.png" alt="Email notification">
</div>
<div class="title">Figure 94. Comments sent as email notifications</div>
</div>
<div class="paragraph">
<p>Anyone can also leave general comments on the Pull Request. In <a href="#_pr_discussion">Pull Request discussion page</a> we can see an example of the project owner both commenting on a line of code and then leaving a general comment in the discussion section. You can see that the code comments are brought into the conversation as well.</p>
</div>
<div id="_pr_discussion" class="imageblock">
<div class="content">
<img src="images/blink-05-general-comment.png" alt="PR discussion page">
</div>
<div class="title">Figure 95. Pull Request discussion page</div>
</div>
<div class="paragraph">
<p>Now the contributor can see what they need to do in order to get their change accepted. Luckily this is also a very simple thing to do. Where over email you may have to re-roll your series and resubmit it to the mailing list, with GitHub you simply commit to the topic branch again and push.</p>
</div>
<div class="paragraph">
<p>If the contributor does that then the project owner will get notified again and when they visit the page they will see that it&#8217;s been addressed. In fact, since a line of code changed that had a comment on it, GitHub notices that and collapses the outdated diff.</p>
</div>
<div id="_pr_final" class="imageblock">
<div class="content">
<img src="images/blink-06-final.png" alt="PR final">
</div>
<div class="title">Figure 96. Pull Request final</div>
</div>
<div class="paragraph">
<p>An interesting thing to notice is that if you click on the &#8220;Files Changed&#8221; tab on this Pull Request, you&#8217;ll get the &#8220;unified&#8221; diff&#8201;&#8212;&#8201;that is, the total aggregate difference that would be introduced to your main branch if this topic branch was merged in. In <code>git diff</code> terms, it basically automatically shows you <code>git diff master...&lt;branch&gt;</code> for the branch this Pull Request is based on. See <a href="#_what_is_introduced">Determining What Is Introduced</a> for more about this type of diff.</p>
</div>
<div class="paragraph">
<p>The other thing you&#8217;ll notice is that GitHub checks to see if the Pull Request merges cleanly and provides a button to do the merge for you on the server. This button only shows up if you have write access to the repository and a trivial merge is possible. If you click it GitHub will perform a &#8220;non-fast-forward&#8221; merge, meaning that even if the merge <strong>could</strong> be a fast-forward, it will still create a merge commit.</p>
</div>
<div class="paragraph">
<p>If you would prefer, you can simply pull the branch down and merge it locally. If you merge this branch into the <code>master</code> branch and push it to GitHub, the Pull Request will automatically be closed.</p>
</div>
<div class="paragraph">
<p>This is the basic workflow that most GitHub projects use. Topic branches are created, Pull Requests are opened on them, a discussion ensues, possibly more work is done on the branch and eventually the request is either closed or merged.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Not Only Forks</div>
<div class="paragraph">
<p>It&#8217;s important to note that you can also open a Pull Request between two branches in the same repository. If you&#8217;re working on a feature with someone and you both have write access to the project, you can push a topic branch to the repository and open a Pull Request on it to the <code>master</code> branch of that same project to initiate the code review and discussion process. No forking necessary.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_advanced_pull_requests">Advanced Pull Requests</h4>
<div class="paragraph">
<p>Now that we&#8217;ve covered the basics of contributing to a project on GitHub, let&#8217;s cover a few interesting tips and tricks about Pull Requests so you can be more effective in using them.</p>
</div>
<div class="sect4">
<h5 id="_pull_requests_as_patches">Pull Requests as Patches</h5>
<div class="paragraph">
<p>It&#8217;s important to understand that many projects don&#8217;t really think of Pull Requests as queues of perfect patches that should apply cleanly in order, as most mailing list-based projects think of patch series contributions. Most GitHub projects think about Pull Request branches as iterative conversations around a proposed change, culminating in a unified diff that is applied by merging.</p>
</div>
<div class="paragraph">
<p>This is an important distinction, because generally the change is suggested before the code is thought to be perfect, which is far more rare with mailing list based patch series contributions. This enables an earlier conversation with the maintainers so that arriving at the proper solution is more of a community effort. When code is proposed with a Pull Request and the maintainers or community suggest a change, the patch series is generally not re-rolled, but instead the difference is pushed as a new commit to the branch, moving the conversation forward with the context of the previous work intact.</p>
</div>
<div class="paragraph">
<p>For instance, if you go back and look again at <a href="#_pr_final">Pull Request final</a>, you&#8217;ll notice that the contributor did not rebase his commit and send another Pull Request. Instead they added new commits and pushed them to the existing branch. This way if you go back and look at this Pull Request in the future, you can easily find all of the context of why decisions were made. Pushing the &#8220;Merge&#8221; button on the site purposefully creates a merge commit that references the Pull Request so that it&#8217;s easy to go back and research the original conversation if necessary.</p>
</div>
</div>
<div class="sect4">
<h5 id="_keeping_up_with_upstream">Keeping up with Upstream</h5>
<div class="paragraph">
<p>If your Pull Request becomes out of date or otherwise doesn&#8217;t merge cleanly, you will want to fix it so the maintainer can easily merge it. GitHub will test this for you and let you know at the bottom of every Pull Request if the merge is trivial or not.</p>
</div>
<div id="_pr_fail" class="imageblock">
<div class="content">
<img src="images/pr-01-fail.png" alt="PR merge failure">
</div>
<div class="title">Figure 97. Pull Request does not merge cleanly</div>
</div>
<div class="paragraph">
<p>If you see something like <a href="#_pr_fail">Pull Request now merges cleanly</a>, you&#8217;ll want to fix your branch so that it turns green and the maintainer doesn&#8217;t have to do extra work.</p>
</div>
<div class="paragraph">
<p>You have two main options in order to do this. You can either rebase your branch on top of whatever the target branch is (normally the <code>master</code> branch of the repository you forked), or you can merge the target branch into your branch.</p>
</div>
<div class="paragraph">
<p>Most developers on GitHub will choose to do the latter, for the same reasons we just went over in the previous section. What matters is the history and the final merge, so rebasing isn&#8217;t getting you much other than a slightly cleaner history and in return is <strong>far</strong> more difficult and error prone.</p>
</div>
<div class="paragraph">
<p>If you want to merge in the target branch to make your Pull Request mergeable, you would add the original repository as a new remote, fetch from it, merge the main branch of that repository into your topic branch, fix any issues and finally push it back up to the same branch you opened the Pull Request on.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s say that in the &#8220;tonychacon&#8221; example we were using before, the original author made a change that would create a conflict in the Pull Request. Let&#8217;s go through those steps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ git remote add upstream https://github.com/schacon/blink <b class="conum">(1)</b>

$ git fetch upstream <b class="conum">(2)</b>
remote: Counting objects: 3, done.
remote: Compressing objects: 100% (3/3), done.
Unpacking objects: 100% (3/3), done.
remote: Total 3 (delta 0), reused 0 (delta 0)
From https://github.com/schacon/blink
 * [new branch]      master     -&gt; upstream/master

$ git merge upstream/master <b class="conum">(3)</b>
Auto-merging blink.ino
CONFLICT (content): Merge conflict in blink.ino
Automatic merge failed; fix conflicts and then commit the result.

$ vim blink.ino <b class="conum">(4)</b>
$ git add blink.ino
$ git commit
[slow-blink 3c8d735] Merge remote-tracking branch 'upstream/master' \
    into slower-blink

$ git push origin slow-blink <b class="conum">(5)</b>
Counting objects: 6, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (6/6), done.
Writing objects: 100% (6/6), 682 bytes | 0 bytes/s, done.
Total 6 (delta 2), reused 0 (delta 0)
To https://github.com/tonychacon/blink
   ef4725c..3c8d735  slower-blink -&gt; slow-blink</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Add the original repository as a remote named &#8220;upstream&#8221;</p>
</li>
<li>
<p>Fetch the newest work from that remote</p>
</li>
<li>
<p>Merge the main branch into your topic branch</p>
</li>
<li>
<p>Fix the conflict that occurred</p>
</li>
<li>
<p>Push back up to the same topic branch</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once you do that, the Pull Request will be automatically updated and re-checked to see if it merges cleanly.</p>
</div>
<div id="_pr_fail" class="imageblock">
<div class="content">
<img src="images/pr-02-merge-fix.png" alt="PR fixed">
</div>
<div class="title">Figure 98. Pull Request now merges cleanly</div>
</div>
<div class="paragraph">
<p>One of the great things about Git is that you can do that continuously. If you have a very long-running project, you can easily merge from the target branch over and over again and only have to deal with conflicts that have arisen since the last time that you merged, making the process very manageable.</p>
</div>
<div class="paragraph">
<p>If you absolutely wish to rebase the branch to clean it up, you can certainly do so, but it is highly encouraged to not force push over the branch that the Pull Request is already opened on. If other people have pulled it down and done more work on it, you run into all of the issues outlined in <a href="#_rebase_peril">衍合的风险</a>. Instead, push the rebased branch to a new branch on GitHub and open a brand new Pull Request referencing the old one, then close the original.</p>
</div>
</div>
<div class="sect4">
<h5 id="_references">References</h5>
<div class="paragraph">
<p>Your next question may be &#8220;How to I reference the old Pull Request?&#8221;. It turns out there are many, many ways to reference other things almost anywhere you can write in GitHub.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with how to cross-reference another Pull Request or an Issue. All Pull Requests and Issues are assigned numbers and they are unique within the project. For example, you can&#8217;t have Pull Request #3 <em>and</em> Issue #3. If you want to reference any Pull Request or Issue from any other one, you can simply put <code>#&lt;num&gt;</code> in any comment or description. You can also be more specific if the Issue or Pull request lives somewhere else; write <code>username#&lt;num&gt;</code> if you&#8217;re referring to an Issue or Pull Request in a fork of the repository you&#8217;re in, or <code>username/repo#&lt;num&gt;</code> to reference something in another repository.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at an example. Say we rebased the branch in the previous example, created a new pull request for it, and now we want to reference the old pull request from the new one. We also want to reference an issue in the fork of the repository and an issue in a completely different project. We can fill out the description just like <a href="#_pr_references">Cross references in a Pull Request.</a>.</p>
</div>
<div id="_pr_references" class="imageblock">
<div class="content">
<img src="images/mentions-01-syntax.png" alt="PR references">
</div>
<div class="title">Figure 99. Cross references in a Pull Request.</div>
</div>
<div class="paragraph">
<p>When we submit this pull request, we&#8217;ll see all of that rendered like <a href="#_pr_references_render">Cross references rendered in a Pull Request.</a>.</p>
</div>
<div id="_pr_references_render" class="imageblock">
<div class="content">
<img src="images/mentions-02-render.png" alt="PR references rendered">
</div>
<div class="title">Figure 100. Cross references rendered in a Pull Request.</div>
</div>
<div class="paragraph">
<p>Notice that the full GitHub URL we put in there was shortened to just the information needed.</p>
</div>
<div class="paragraph">
<p>Now if Tony goes back and closes out the original Pull Request, we can see that by mentioning it in the new one, GitHub has automatically created a trackback event in the Pull Request timeline. This means that anyone who visits this Pull Request and sees that it is closed can easily link back to the one that superceded it. The link will look something like <a href="#_pr_closed">Cross references rendered in a Pull Request.</a>.</p>
</div>
<div id="_pr_closed" class="imageblock">
<div class="content">
<img src="images/mentions-03-closed.png" alt="PR closed">
</div>
<div class="title">Figure 101. Cross references rendered in a Pull Request.</div>
</div>
<div class="paragraph">
<p>In addition to issue numbers, you can also reference a specific commit by SHA. You have to specify a full 40 character SHA, but if GitHub sees that in a comment, it will link directly to the commit. Again, you can reference commits in forks or other repositories in the same way you did with issues.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_markdown">Markdown</h4>
<div class="paragraph">
<p>Linking to other Issues is just the beginning of interesting things you can do with almost any text box on GitHub. In  Issue and Pull Request descriptions, comments, code comments and more, you can use what is called &#8220;GitHub Flavored Markdown&#8221;. Markdown is like writing in plain text but which is rendered richly.</p>
</div>
<div class="paragraph">
<p>See <a href="#_example_markdown">An example of Markdown as written and as rendered.</a> for an example of how comments or text can be written and then rendered using Markdown.</p>
</div>
<div id="_example_markdown" class="imageblock">
<div class="content">
<img src="images/markdown-01-example.png" alt="Example Markdown">
</div>
<div class="title">Figure 102. An example of Markdown as written and as rendered.</div>
</div>
<div class="sect4">
<h5 id="_github_flavored_markdown">GitHub Flavored Markdown</h5>
<div class="paragraph">
<p>The GitHub flavor of Markdown adds more things you can do beyond the basic Markdown syntax. These can all be really useful when creating useful Pull Request or Issue comments or descriptions.</p>
</div>
<div class="sect5">
<h6 id="_task_lists">Task Lists</h6>
<div class="paragraph">
<p>The first really useful GitHub specific Markdown feature, especially for use in Pull Requests, is the Task List. A task list is a list of checkboxes of things you want to get done. Putting them into an Issue or Pull Request normally indicates things that you want to get done before you consider the item complete.</p>
</div>
<div class="paragraph">
<p>You can create a task list like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>- [X] Write the code
- [ ] Write all the tests
- [ ] Document the code</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we include this in the description of our Pull Request or Issue, we&#8217;ll see it rendered like <a href="#_task_lists">Task lists rendered in a Markdown comment.</a></p>
</div>
<div id="_task_lists" class="imageblock">
<div class="content">
<img src="images/markdown-02-tasks.png" alt="Example Task List">
</div>
<div class="title">Figure 103. Task lists rendered in a Markdown comment.</div>
</div>
<div class="paragraph">
<p>This is often used in Pull Requests to indicate what all you would like to get done on the branch before the Pull Request will be ready to merge. The really cool part is that you can simply click the checkboxes to update the comment&#8201;&#8212;&#8201;you don&#8217;t have to edit the Markdown directly to check tasks off.</p>
</div>
<div class="paragraph">
<p>What&#8217;s more, GitHub will look for task lists in your Issues and Pull Requests and show them as metadata on the pages that list them out. For example, if you have a Pull Request with tasks and you look at the overview page of all Pull Requests, you can see how far done it is. This helps people break down Pull Requests into subtasks and helps other people track the progress of the branch. You can see an example of this in <a href="#_task_list_progress">Task list summary in the Pull Request list.</a>.</p>
</div>
<div id="_task_list_progress" class="imageblock">
<div class="content">
<img src="images/markdown-03-task-summary.png" alt="Example Task List">
</div>
<div class="title">Figure 104. Task list summary in the Pull Request list.</div>
</div>
<div class="paragraph">
<p>These are incredibly useful when you open a Pull Request early and use it to track your progress through the implementation of the feature.</p>
</div>
</div>
<div class="sect5">
<h6 id="_code_snippets">Code Snippets</h6>
<div class="paragraph">
<p>You can also add code snippets to comments. This is especially useful if you want to present something that you <em>could</em> try to do before actually implementing it as a commit on your branch. This is also often used to add example code of what is not working or what this Pull Request could implement.</p>
</div>
<div class="paragraph">
<p>To add a snippet of code you have to &#8220;fence&#8221; it in backticks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>```java
for(int i=0 ; i &lt; 5 ; i++)
{
   System.out.println("i is : " + i);
}
```</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you add a language name like we did there with <em>java</em>, GitHub will also try to syntax highlight the snippet. In the case of the above example, it would end up rendering like <a href="#_md_code">Rendered fenced code example.</a>.</p>
</div>
<div id="_md_code" class="imageblock">
<div class="content">
<img src="images/markdown-04-fenced-code.png" alt="Rendered fenced code">
</div>
<div class="title">Figure 105. Rendered fenced code example.</div>
</div>
</div>
<div class="sect5">
<h6 id="_quoting">Quoting</h6>
<div class="paragraph">
<p>If you&#8217;re responding to a small part of a long comment, you can selectively quote out of the other comment by preceding the lines with the <code>&gt;</code> character. In fact, this is so common and so useful that there is a keyboard shortcut for it. If you highlight text in a comment that you want to directly reply to and hit the <code>r</code> key, it will quote that text in the comment box for you.</p>
</div>
<div class="paragraph">
<p>The quotes look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&gt; Whether 'tis Nobler in the mind to suffer
&gt; The Slings and Arrows of outrageous Fortune,

How big are these slings and in particular, these arrows?</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once rendered, the comment will look like <a href="#_md_quote">Rendered quoting example.</a>.</p>
</div>
<div id="_md_quote" class="imageblock">
<div class="content">
<img src="images/markdown-05-quote.png" alt="Rendered quoting">
</div>
<div class="title">Figure 106. Rendered quoting example.</div>
</div>
</div>
<div class="sect5">
<h6 id="_emoji">Emoji</h6>
<div class="paragraph">
<p>Finally, you can also use emoji in your comments. This is actually used quite extensively in comments you see on many GitHub Issues and Pull Requests. There is even an emoji helper in GitHub. If you are typing a comment and you start with a <code>:</code> character, an autocompleter will help you find what you&#8217;re looking for.</p>
</div>
<div id="_md_emoji_auto" class="imageblock">
<div class="content">
<img src="images/markdown-06-emoji-complete.png" alt="Emoji autocompleter">
</div>
<div class="title">Figure 107. Emoji autocompleter in action.</div>
</div>
<div class="paragraph">
<p>Emojis take the form of <code>:&lt;name&gt;:</code> anywhere in the comment. For instance, you could write something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>I :eyes: that :bug: and I :cold_sweat:.

:trophy: for :microscope: it.

:+1: and :sparkles: on this :ship:, it's :fire::poop:!

:clap::tada::panda_face:</code></pre>
</div>
</div>
<div class="paragraph">
<p>When rendered, it would look something like <a href="#_md_emoji">Heavy emoji commenting.</a>.</p>
</div>
<div id="_md_emoji" class="imageblock">
<div class="content">
<img src="images/markdown-07-emoji.png" alt="Emoji">
</div>
<div class="title">Figure 108. Heavy emoji commenting.</div>
</div>
<div class="paragraph">
<p>Not that this is incredibly useful, but it does add an element of fun and emotion to a medium that is otherwise hard to convey emotion in.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>There are actually quite a number of web services that make use of emoji characters these days. A great cheat sheet to reference to find emoji that expresses what you want to say can be found at:</p>
</div>
<div class="paragraph">
<p><a href="http://www.emoji-cheat-sheet.com" class="bare">http://www.emoji-cheat-sheet.com</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_images">Images</h6>
<div class="paragraph">
<p>This isn&#8217;t technically GitHub Flavored Markdown, but it is incredibly useful. In addition to adding Markdown image links to comments, which can be difficult to find and embed URLs for, GitHub allows you to drag and drop images into text areas to embed them.</p>
</div>
<div id="_md_drag" class="imageblock">
<div class="content">
<img src="images/markdown-08-drag-drop.png" alt="Drag and drop images">
</div>
<div class="title">Figure 109. Drag and drop images to upload them and auto-embed them.</div>
</div>
<div class="paragraph">
<p>If you look back at <a href="#_pr_references">Cross references in a Pull Request.</a>, you can see a small &#8220;Parsed as Markdown&#8221; hint above the text area. Clicking on that will give you a full cheat sheet of everything you can do with Markdown on GitHub.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maintaining_gh_project">Maintaining a Project</h3>
<div class="paragraph">
<p>Now that we&#8217;re comfortable contributing to a project, let&#8217;s look at the other side: creating, maintaining and administering your own project.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_new_repository">Creating a New Repository</h4>
<div class="paragraph">
<p>Let&#8217;s create a new repository to share our project code with.
Start by clicking the &#8220;New repository&#8221; button on the right-hand side of the dashboard, or from the <code>+</code> button in the top toolbar next to your username as seen in <a href="#_new_repo_dropdown">The &#8220;New repository&#8221; dropdown.</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/newrepo.png" alt="The ``Your repositories'' area.">
</div>
<div class="title">Figure 110. The &#8220;Your repositories&#8221; area.</div>
</div>
<div id="_new_repo_dropdown" class="imageblock">
<div class="content">
<img src="images/new-repo.png" alt="The ``new repository'' dropdown.">
</div>
<div class="title">Figure 111. The &#8220;New repository&#8221; dropdown.</div>
</div>
<div class="paragraph">
<p>This takes you to the &#8220;new repository&#8221; form:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/newrepoform.png" alt="The ``new repository'' form.">
</div>
<div class="title">Figure 112. The &#8220;new repository&#8221; form.</div>
</div>
<div class="paragraph">
<p>All you really have to do here is provide a project name; the rest of the fields are completely optional.
For now, just click the &#8220;Create Repository&#8221; button, and boom – you have a new repository on GitHub, named <code>&lt;user&gt;/&lt;project_name&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Since you have no code there yet, GitHub will show you instructions for how create a brand-new Git repository, or connect an existing Git project.
We won&#8217;t belabor this here; if you need a refresher, check out <a href="#_git_basics_chapter">Git 基础</a>.</p>
</div>
<div class="paragraph">
<p>Now that your project is hosted on GitHub, you can give the URL to anyone you want to share your project with.
Every project on GitHub is accessible over HTTP as <code>https://github.com/&lt;user&gt;/&lt;project_name&gt;</code>, and over SSH as <code>git@github.com:&lt;user&gt;/&lt;project_name&gt;</code>.
Git can fetch from and push to both of these URLs, but they are access-controlled based on the credentials of the user connecting to them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>It is often preferable to share the HTTP based URL for a public project, since the user does not have to have a GitHub account to access it for cloning. Users will have to have an account and an uploaded SSH key to access your project if you give them the SSH URL. The HTTP one is also exactly the same URL they would paste into a browser to view the project there.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adding_collaborators">Adding Collaborators</h4>
<div class="paragraph">
<p>If you&#8217;re working with other people who you want to give commit access to, you need to add them as &#8220;collaborators&#8221;.
If Ben, Jeff, and Louise all sign up for accounts on GitHub, and you want to give them push access to your repository, you can add them to your project.
Doing so will give them &#8220;push&#8221; access, which means they have both read and write access to the project and Git repository.</p>
</div>
<div class="paragraph">
<p>Click the &#8220;Settings&#8221; link at the bottom of the right-hand sidebar.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reposettingslink.png" alt="The repository settings link.">
</div>
<div class="title">Figure 113. The repository settings link.</div>
</div>
<div class="paragraph">
<p>Then select &#8220;Collaborators&#8221; from the menu on the left-hand side.
Then, just type a username into the box, and click &#8220;Add collaborator.&#8221;
You can repeat this as many times as you like to grant access to everyone you like.
If you need to revoke access, just click the &#8220;X&#8221; on the right-hand side of their row.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/collaborators.png" alt="The repository collaborators box.">
</div>
<div class="title">Figure 114. Repository collaborators.</div>
</div>
</div>
<div class="sect3">
<h4 id="_managing_pull_requests">Managing Pull Requests</h4>
<div class="paragraph">
<p>Now that you have a project with some code in it and maybe even a few collaborators who also have push access, let&#8217;s go over what to do when you get a Pull Request yourself.</p>
</div>
<div class="paragraph">
<p>Pull Requests can either come from a branch in a fork of your repository or they can come from another branch in the same repository. The only difference is that the ones in a fork are often from people where you can&#8217;t push to their branch and they can&#8217;t push to yours, whereas with internal Pull Requests generally both parties can access the branch.</p>
</div>
<div class="paragraph">
<p>For these examples, let&#8217;s assume you are &#8220;tonychacon&#8221; and you&#8217;ve created a new Arudino code project named &#8220;fade&#8221;.</p>
</div>
<div class="sect4">
<h5 id="_email_notifications">Email Notifications</h5>
<div class="paragraph">
<p>Someone comes along and makes a change to your code and sends you a Pull Request. You should get an email notifying you about the new Pull Request and it should look something like <a href="#_email_pr">Email notification of a new Pull Request.</a>.</p>
</div>
<div id="_email_pr" class="imageblock">
<div class="content">
<img src="images/maint-01-email.png" alt="Pull Request email notification">
</div>
<div class="title">Figure 115. Email notification of a new Pull Request.</div>
</div>
<div class="paragraph">
<p>There are a few things to notice about this email. It will give you a small diffstat&#8201;&#8212;&#8201;a list of files that have changed in the Pull Request and by how much. It gives you a link to the Pull Request on GitHub. It also gives you a few URLs that you can use from the command line.</p>
</div>
<div class="paragraph">
<p>If you notice the line that says <code>git pull &lt;url&gt; patch-1</code>, this is a simple way to merge in a remote branch without having to add a remote. We went over this quickly in <a href="#_checking_out_remotes">Checking Out Remote Branches</a>. If you wish, you can create and switch to a topic branch and then run this command to merge in the Pull Request changes.</p>
</div>
<div class="paragraph">
<p>The other interesting URLs are the <code>.diff</code> and <code>.patch</code> URLs, which as you may guess, provide unified diff and patch versions of the Pull Request. You could technically merge in the Pull Request work with something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ curl http://github.com/tonychacon/fade/pull/1.patch | git am</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_collaborating_on_the_pull_request">Collaborating on the Pull Request</h5>
<div class="paragraph">
<p>As we covered in <a href="#_github_flow">The GitHub Flow</a>, you can now have a conversation with the person who opened the Pull Request. You can comment on specific lines of code, comment on whole commits or comment on the entire Pull Request itself, using GitHub Flavored Markdown everywhere.</p>
</div>
<div class="paragraph">
<p>Every time someone else comments on the Pull Request you will continue to get email notifications so you know there is activity happening. They will each have a link to the Pull Request where the activity is happening and you can also directly respond to the email to comment on the Pull Request thread.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/maint-03-email-resp.png" alt="Email response">
</div>
<div class="title">Figure 116. Responses to emails are included in the thread.</div>
</div>
<div class="paragraph">
<p>Once the code is in a place you like and want to merge it in, you can either pull the code down and merge it locally, either with the <code>git pull &lt;url&gt; &lt;branch&gt;</code> syntax we saw earlier, or by adding the fork as a remote and fetching and merging.</p>
</div>
<div class="paragraph">
<p>If the merge is trivial, you can also just hit the &#8220;Merge&#8221; buton on the GitHub site. This will do a &#8220;non-fast-forward&#8221; merge, creating a merge commit even if a fast-forward merge was possible. This means that no matter what, every time you hit the merge button, a merge commit is created. As you can see in <a href="#_merge_button">Merge button and instructions for merging a Pull Request manually.</a>, GitHub gives you all of this information if you click the hint link.</p>
</div>
<div id="_merge_button" class="imageblock">
<div class="content">
<img src="images/maint-02-merge.png" alt="Merge button">
</div>
<div class="title">Figure 117. Merge button and instructions for merging a Pull Request manually.</div>
</div>
<div class="paragraph">
<p>If you decide you don&#8217;t want to merge it, you can also just close the Pull Request and the person who opened it will be notified.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pr_refs">Pull Request Refs</h5>
<div class="paragraph">
<p>If you&#8217;re dealing with a <strong>lot</strong> of Pull Requests and don&#8217;t want to add a bunch of remotes or do one time pulls every time, there is a neat trick that GitHub allows you to do. This is a bit of an advanced trick and we&#8217;ll go over the details of this a bit more in <a href="#_refspec">The Refspec</a>, but it can be pretty useful.</p>
</div>
<div class="paragraph">
<p>GitHub actually advertises the Pull Request branches for a repository as sort of pseudo-branches on the server. By default you don&#8217;t get them when you clone, but they are there in an obscured way and you can access them pretty easily.</p>
</div>
<div class="paragraph">
<p>To demonstrate this, we&#8217;re going to use a low-level command (often referred to as a &#8220;plumbing&#8221; command, which we&#8217;ll read about more in <a href="#_plumbing_porcelain">Plumbing and Porcelain</a>) called <code>ls-remote</code>. This command is generally not used in day-to-day Git operations but it&#8217;s useful to show us what references are present on the server.</p>
</div>
<div class="paragraph">
<p>If we run this command against the &#8220;blink&#8221; repository we were using earlier, we will get a list of all the branches and tags and other references in the repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ git ls-remote https://github.com/schacon/blink
10d539600d86723087810ec636870a504f4fee4d	HEAD
10d539600d86723087810ec636870a504f4fee4d	refs/heads/master
6a83107c62950be9453aac297bb0193fd743cd6e	refs/pull/1/head
afe83c2d1a70674c9505cc1d8b7d380d5e076ed3	refs/pull/1/merge
3c8d735ee16296c242be7a9742ebfbc2665adec1	refs/pull/2/head
15c9f4f80973a2758462ab2066b6ad9fe8dcf03d	refs/pull/2/merge
a5a7751a33b7e86c5e9bb07b26001bb17d775d1a	refs/pull/4/head
31a45fc257e8433c8d8804e3e848cf61c9d3166c	refs/pull/4/merge</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, if you&#8217;re in your repository and you run <code>git ls-remote origin</code> or whatever remote you want to check, it will show you something similar to this.</p>
</div>
<div class="paragraph">
<p>If the repository is on GitHub and you have any Pull Requests that have been opened, you&#8217;ll get these references that are prefixed with <code>refs/pull/</code>. These are basically branches, but since they&#8217;re not under <code>refs/heads/</code> you don&#8217;t get them normally when you clone or fetch from the server&#8201;&#8212;&#8201;the process of fetching ignores them normally.</p>
</div>
<div class="paragraph">
<p>There are two references per Pull Request - the one that ends in <code>/head</code> points to exactly the same commit as the last commit in the Pull Request branch. So if someone opens a Pull Request in our repository and their branch is named <code>bug-fix</code> and it points to commit <code>a5a775</code>, then in <strong>our</strong> repository we will not have a <code>bug-fix</code> branch (since that&#8217;s in their fork), but we <em>will</em> have <code>pull/&lt;pr#&gt;/head</code> that points to <code>a5a775</code>. This means that we can pretty easily pull down every Pull Request branch in one go without having to add a bunch of remotes.</p>
</div>
<div class="paragraph">
<p>Now, you could do something like fetching the reference directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ git fetch origin refs/pull/958/head
From https://github.com/libgit2/libgit2
 * branch            refs/pull/958/head -&gt; FETCH_HEAD</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells Git, &#8220;Connect to the <code>origin</code> remote, and download the ref named <code>refs/pull/958/head</code>.&#8221;
Git happily obeys, and downloads everything you need to construct that ref, and puts a pointer to the commit you want under <code>.git/FETCH_HEAD</code>.
You can follow that up with <code>git merge FETCH_HEAD</code> into a branch you want to test it in, but that merge commit message looks a bit weird.
Also, if you&#8217;re reviewing a <strong>lot</strong> of pull requests, this gets tedious.</p>
</div>
<div class="paragraph">
<p>There&#8217;s also a way to fetch <em>all</em> of the pull requests, and keep them up to date whenever you connect to the remote.
Open up <code>.git/config</code> in your favorite editor, and look for the <code>origin</code> remote.
It should look a bit like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[remote "origin"]
    url = https://github.com/libgit2/libgit2
    fetch = +refs/heads/*:refs/remotes/origin/*</pre>
</div>
</div>
<div class="paragraph">
<p>That line that begins with <code>fetch =</code> is a &#8220;refspec.&#8221;
It&#8217;s a way of mapping names on the remote with names in your local <code>.git</code> directory.
This particular one tells Git, "the things on the remote that are under <code>refs/heads</code> should go in my local repository under <code>refs/remotes/origin</code>."
You can modify this section to add another refspec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[remote "origin"]
    url = https://github.com/libgit2/libgit2.git
    fetch = +refs/heads/*:refs/remotes/origin/*
    fetch = +refs/pull/*/head:refs/remotes/origin/pr/*</pre>
</div>
</div>
<div class="paragraph">
<p>That last line tells Git, &#8220;All the refs that look like <code>refs/pull/123/head</code> should be stored locally like <code>refs/remotes/origin/pr/123</code>.&#8221;
Now, if you save that file, and do a <code>git fetch</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ git fetch
# …
 * [new ref]         refs/pull/1/head -&gt; origin/pr/1
 * [new ref]         refs/pull/2/head -&gt; origin/pr/2
 * [new ref]         refs/pull/4/head -&gt; origin/pr/4
# …</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all of the remote pull requests are represented locally with refs that act much like tracking branches; they&#8217;re read-only, and they update when you do a fetch.
This makes it super easy to try the code from a pull request locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ git checkout pr/2
Checking out files: 100% (3769/3769), done.
Branch pr/2 set up to track remote branch pr/2 from origin.
Switched to a new branch 'pr/2'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The eagle-eyed among you would note the <code>head</code> on the end of the remote portion of the refspec.
There&#8217;s also a <code>refs/pull/#/merge</code> ref on the GitHub side, which represents the commit that would result if you push the &#8220;merge&#8221; button on the site. This can allow you to test the merge before even hitting the button.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pull_requests_on_pull_requests">Pull Requests on Pull Requests</h5>
<div class="paragraph">
<p>Not only can you open Pull Requests that target the main or <code>master</code> branch, you can actually open a Pull Request targeting any branch in the network. In fact, you can even target another Pull Request.</p>
</div>
<div class="paragraph">
<p>If you see a Pull Request that is moving in the right direction and you have an idea for a change that depends on it or you&#8217;re not sure is a good idea, or you just don&#8217;t have push access to the target branch, you can open a Pull Request directly to it.</p>
</div>
<div class="paragraph">
<p>When you go to open a Pull Request, there is a box at the top of the page that specifies which branch you&#8217;re requesting to pull to and which you&#8217;re requesting to pull from. If you hit the &#8220;Edit&#8221; button at the right of that box you can change not only the branches but also which fork.</p>
</div>
<div id="_pr_targets" class="imageblock">
<div class="content">
<img src="images/maint-04-target.png" alt="PR targets">
</div>
<div class="title">Figure 118. Manually change the Pull Request target fork and branch.</div>
</div>
<div class="paragraph">
<p>Here you can fairly easily specify to merge your new branch into another Pull Request or another fork of the project.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mentions_and_notifications">Mentions and Notifications</h4>
<div class="paragraph">
<p>GitHub also has a pretty nice notifications system built in that can come in handy when you have questions or need feedback from specific individuals or teams.</p>
</div>
<div class="paragraph">
<p>In any comment you can start typing a <code>@</code> character and it will begin to autocomplete with the names and usernames of people who are collaborators or contributors in the project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/maint-05-mentions.png" alt="Mentions">
</div>
<div class="title">Figure 119. Start typing @ to mention someone.</div>
</div>
<div class="paragraph">
<p>You can also mention a user who is not in that dropdown, but often the autocompleter can make it faster.</p>
</div>
<div class="paragraph">
<p>Once you post a comment with a user mention, that user will be notified. This means that this can be a really effective way of pulling people into conversations rather than making them poll. Very often in  Pull Requests on GitHub people will pull in other people on their teams or in their company to review an Issue or Pull Request.</p>
</div>
<div class="paragraph">
<p>If someone gets mentioned on a Pull Request or Issue, they will be &#8220;subscribed&#8221; to it and will continue getting notifications any time some activity occurs on it. You will also be subscribed to something if you opened it, if you&#8217;re watching the repository or if you comment on something. If you no longer wish to receive notifications, there is an &#8220;Unsubscribe&#8221; button on the page you can click to stop receiving updates on it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/maint-06-unsubscribe.png" alt="Unsubscribe">
</div>
<div class="title">Figure 120. Unsubscribe from an Issue or Pull Request.</div>
</div>
<div class="sect4">
<h5 id="_the_notifications_page">The Notifications Page</h5>
<div class="paragraph">
<p>When we mention &#8220;notifications&#8221; here with respect to GitHub, we mean a specific way that GitHub tries to get in touch with you when events happen and there are a few different ways you can configure them.
If you go to the &#8220;Notification center&#8221; tab from the settings page, you can see some of the options you have.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/maint-07-notifications.png" alt="Notification center">
</div>
<div class="title">Figure 121. Notification center options.</div>
</div>
<div class="paragraph">
<p>The two choices are to get notifications over &#8220;Email&#8221; and over &#8220;Web&#8221; and you can choose either, neither or both for when you actively participate in things and for activity on repositories you are watching.</p>
</div>
<div class="sect5">
<h6 id="_web_notifications">Web Notifications</h6>
<div class="paragraph">
<p>Web notifications only exist on GitHub and you can only check them on GitHub. If you have this option selected in your preferences and a notification is triggered for you, you will see a small blue dot over your notifications icon at the top of your screen as seen in <a href="#_not_center">Notification center.</a>.</p>
</div>
<div id="_not_center" class="imageblock">
<div class="content">
<img src="images/maint-08-notifications-page.png" alt="Notification center">
</div>
<div class="title">Figure 122. Notification center.</div>
</div>
<div class="paragraph">
<p>If you click on that, you will see a list of all the items you have been notified about, grouped by project. You can filter to the notifications of a specific project by clicking on it&#8217;s name in the left hand sidebar. You can also acknowledge the notification by clicking the checkmark icon next to any notification, or acknowledge <em>all</em> of the notifictions in a project by clicking the checkmark at the top of the group. There is also a mute button next to each checkmark that you can click to not receive any further notifications on that item.</p>
</div>
<div class="paragraph">
<p>All of these tools are very useful for handling large numbers of notifications. Many GitHub power users will simply turn off email notifications entirely and manage all of their notifications through this screen.</p>
</div>
</div>
<div class="sect5">
<h6 id="_email_notifications_2">Email Notifications</h6>
<div class="paragraph">
<p>Email notifications are the other way you can handle notifications through GitHub. If you have this turned on you will get emails for each notification. We saw examples of this in <a href="#_email_notification">Comments sent as email notifications</a> and <a href="#_email_pr">Email notification of a new Pull Request.</a>. The emails will also be threaded properly, which is nice if you&#8217;re using a threading email client.</p>
</div>
<div class="paragraph">
<p>There is also a fair amount of metadata embedded in the headers of the emails that GitHub sends you, which can be really helpful for setting up custom filters and rules.</p>
</div>
<div class="paragraph">
<p>For instance, if we look at the actual email headers sent to Tony in the email shown in <a href="#_email_pr">Email notification of a new Pull Request.</a>, we will see the following among the information sent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-mbox" data-lang="mbox">To: tonychacon/fade &lt;fade@noreply.github.com&gt;
Message-ID: &lt;tonychacon/fade/pull/1@github.com&gt;
Subject: [fade] Wait longer to see the dimming effect better (#1)
X-GitHub-Recipient: tonychacon
List-ID: tonychacon/fade &lt;fade.tonychacon.github.com&gt;
List-Archive: https://github.com/tonychacon/fade
List-Post: &lt;mailto:reply+i-4XXX@reply.github.com&gt;
List-Unsubscribe: &lt;mailto:unsub+i-XXX@reply.github.com&gt;,...
X-GitHub-Recipient-Address: tchacon@example.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple of interesting things here. If you want to highlight or re-route emails to this particular project or even Pull Request, the information in <code>Message-ID</code> gives you all the data in <code>&lt;user&gt;/&lt;project&gt;/&lt;type&gt;/&lt;id&gt;</code> format. If this were an issue, for example, the <code>&lt;type&gt;</code> field would have been &#8220;issues&#8221; rather than &#8220;pull&#8221;.</p>
</div>
<div class="paragraph">
<p>The <code>List-Post</code> and <code>List-Unsubscribe</code> fields mean that if you have a mail client that understands those, you can easily post to the list or &#8220;Unsubscribe&#8221; from the thread. That would be essentially the same as clicking the &#8220;mute&#8221; button on the web version of the notification or &#8220;Unsubscribe&#8221; on the Issue or Pull Request page itself.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also worth noting that if you have both email and web notifications enabled and you read the email version of the notification, the web version will be marked as read as well if you have images allowed in your mail client.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_special_files">Special Files</h4>
<div class="paragraph">
<p>There are a couple of special files that GitHub will notice if they are present in your repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="_readme">README</h4>
<div class="paragraph">
<p>The first is the <code>README</code> file, which can be of nearly any format that GitHub recognizes as prose. For example, it could be <code>README</code>, <code>README.md</code>, <code>README.asciidoc</code>, etc. If GitHub sees a README file in your source, it will render it on the landing page of the project.</p>
</div>
<div class="paragraph">
<p>Many teams use this file to hold all the relevant project information for someone who might be new to the repository or project. This generally includes things like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What the project is for</p>
</li>
<li>
<p>How to configure and install it</p>
</li>
<li>
<p>An example of how to use it or get it running</p>
</li>
<li>
<p>The license that the project is offered under</p>
</li>
<li>
<p>How to contribute to it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since GitHub will render this file, you can embed images or links in it for added ease of understanding.</p>
</div>
</div>
<div class="sect3">
<h4 id="_contributing">CONTRIBUTING</h4>
<div class="paragraph">
<p>The other special file that GitHub recognizes is the <code>CONTRIBUTING</code> file. If you have a file named <code>CONTRIBUTING</code> with any file extension, GitHub will show <a href="#_contrib_file">Opening a Pull Request when a CONTRIBUTING file exists.</a> when anyone starts opening a Pull Request.</p>
</div>
<div id="_contrib_file" class="imageblock">
<div class="content">
<img src="images/maint-09-contrib.png" alt="Contributing notice">
</div>
<div class="title">Figure 123. Opening a Pull Request when a CONTRIBUTING file exists.</div>
</div>
<div class="paragraph">
<p>The idea here is that you can specify specific things you want or don&#8217;t want in a Pull Request sent to your project. This way people may actually read the guidelines before opening the Pull Request.</p>
</div>
</div>
<div class="sect3">
<h4 id="_project_administration">Project Administration</h4>
<div class="paragraph">
<p>Generally there are not a lot of administrative things you can do with a single project, but there are a couple of items that might be of interest.</p>
</div>
<div class="sect4">
<h5 id="_changing_the_default_branch">Changing the Default Branch</h5>
<div class="paragraph">
<p>If you are using a branch other than &#8220;master&#8221; as your default branch that you want people to open Pull Requests on or see by default, you can change that in your repository&#8217;s settings page under the &#8220;Options&#8221; tab.</p>
</div>
<div id="_default_branch" class="imageblock">
<div class="content">
<img src="images/maint-10-default-branch.png" alt="Default branch">
</div>
<div class="title">Figure 124. Change the default branch for a project.</div>
</div>
<div class="paragraph">
<p>Simply change the default branch in the dropdown and that will be the default for all major operations from then on, including which branch is checked out by default when someone clones the repository.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transferring_a_project">Transferring a Project</h5>
<div class="paragraph">
<p>If you would like to transfer a project to another user or an organization in GitHub, there is a &#8220;Transfer ownership&#8221; option at the bottom of the same &#8220;Options&#8221; tab of your repository settings page that allows you to do this.</p>
</div>
<div id="_transfer_project" class="imageblock">
<div class="content">
<img src="images/maint-11-transfer.png" alt="Transfer">
</div>
<div class="title">Figure 125. Transfer a project to anther GitHub user or Organization.</div>
</div>
<div class="paragraph">
<p>This is helpful if you are abandoning a project and someone wants to take it over, or if your project is getting bigger and want to move it into an organization.</p>
</div>
<div class="paragraph">
<p>Not only does this move the repository along with all it&#8217;s watchers and stars to another place, it also sets up a redirect from your URL to the new place. It will also redirect clones and fetches from Git, not just web requests.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_github_orgs">Managing an organization</h3>
<div class="paragraph">
<p>
In addition to single-user accounts, GitHub has what are called Organizations.
Like personal accounts, Organizational accounts have a namespace where all their projects exist, but many other things are different.
These accounts represent a group of people with shared ownership of projects, and there are many tools to manage subgroups of those people.
Normally these accounts are used for Open Source groups (such as &#8220;perl&#8221; or &#8220;rails&#8221;) or companies (such as &#8220;google&#8221; or &#8220;twitter&#8221;).</p>
</div>
<div class="sect3">
<h4 id="_organization_basics">Organization Basics</h4>
<div class="paragraph">
<p>An organization is pretty easy to create; just click on the &#8220;+&#8221; icon at the top-right of any GitHub page, and select &#8220;New organization&#8221; from the menu.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/neworg.png" alt="The ``New organization'' menu item.">
</div>
<div class="title">Figure 126. The &#8220;New organization&#8221; menu item.</div>
</div>
<div class="paragraph">
<p>First you&#8217;ll need to name your organzation and provide an email address for a main point of contact for the group. Then you can invite other users to be co-owners of the account if you want to.</p>
</div>
<div class="paragraph">
<p>Follow these steps and you&#8217;ll soon be the owner of a brand-new organization.
Like personal accounts, organizations are free if everything you plan to store there will be open source.</p>
</div>
<div class="paragraph">
<p>As an owner in an organization, when you fork a repository, you&#8217;ll have the choice of forking it to your organization&#8217;s namespace. When you create new repositories you can create them either under your personal account or under any of the organizations that you are an owner in. You also automatically &#8220;watch&#8221; any new repository created under these organizations.</p>
</div>
<div class="paragraph">
<p>Just like in <a href="#_personal_avatar">Your Avatar</a>, you can upload an avatar for your organization to personalize it a bit. Also just like personal accounts, you have a landing page for the organization that lists all of your repositories and can be viewed by other people.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s cover some of the things that are a bit different with an organizational account.</p>
</div>
</div>
<div class="sect3">
<h4 id="_teams">Teams</h4>
<div class="paragraph">
<p>Organizations are associated with individual people by way of teams, which are simply a grouping of individual user accounts and repositories within the organization and what kind of access those people have in those repositories.</p>
</div>
<div class="paragraph">
<p>For example, say your company has three repositories: <code>frontend</code>, <code>backend</code>, and <code>deployscripts</code>.
You&#8217;d want your HTML/CSS/Javascript developers to have access to <code>frontend</code> and maybe <code>backend</code>, and your Operations people to have access to <code>backend</code> and <code>deployscripts</code>.
Teams make this easy, without having to manage the collaborators for every individual repository.</p>
</div>
<div class="paragraph">
<p>The Organization page shows you a simple dashboard of all the repositories, users and teams that are under this organziation.</p>
</div>
<div id="_org_page" class="imageblock">
<div class="content">
<img src="images/orgs-01-page.png" alt="orgs 01 page">
</div>
<div class="title">Figure 127. The Organization page.</div>
</div>
<div class="paragraph">
<p>To manage your Teams, you can click on the Teams sidebar on the right hand side of the page in <a href="#_org_page">The Organization page.</a>. This will bring you to a page you can use to add members to the team, add repositories to the team or manage the settings and access control levels for the team. Each team can have read only, read/write or administrative access to the repositories. You can change that level by clicking the &#8220;Settings&#8221; button in <a href="#_team_page">The Team page.</a>.</p>
</div>
<div id="_team_page" class="imageblock">
<div class="content">
<img src="images/orgs-02-teams.png" alt="orgs 02 teams">
</div>
<div class="title">Figure 128. The Team page.</div>
</div>
<div class="paragraph">
<p>When you invite someone to a team, they will get an email letting them know they&#8217;ve been invited.</p>
</div>
<div class="paragraph">
<p>Additionally, team <code>@mentions</code> (such as <code>@acmecorp/frontend</code>) work much the same as they do with individual users, except that <strong>all</strong> members of the team are then subscribed to the thread.
This is useful if you want the attention from someone on a team, but you don&#8217;t know exactly who to ask.</p>
</div>
<div class="paragraph">
<p>A user can belong to any number of teams, so don&#8217;t limit yourself to only access-control teams.
Special-interest teams like <code>ux</code>, <code>css</code>, or <code>refactoring</code> are useful for certain kinds of questions, and others like <code>legal</code> and <code>colorblind</code> for an entirely different kind.</p>
</div>
</div>
<div class="sect3">
<h4 id="_audit_log">Audit Log</h4>
<div class="paragraph">
<p>Organizations also give owners access to all the information about what went on under the organization. You can go to the <em>Audit Log</em> tab and see what events have happened at an organization level, who did them and where in the world they were done.</p>
</div>
<div id="_audit_log" class="imageblock">
<div class="content">
<img src="images/orgs-03-audit.png" alt="orgs 03 audit">
</div>
<div class="title">Figure 129. The Audit log.</div>
</div>
<div class="paragraph">
<p>You can also filter down to specific types of events, specific places or specific people.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scripting_github">Scripting GitHub</h3>
<div class="paragraph">
<p>So now we&#8217;ve covered all of the major features and workflows of GitHub, but any large group or project will have customizations they may want to make or external services they may want to integrate.</p>
</div>
<div class="paragraph">
<p>Luckily for us, GitHub is really quite hackable in many ways. In this section we&#8217;ll cover how to use the GitHub hooks system and it&#8217;s API to make GitHub work how we want it to.</p>
</div>
<div class="sect3">
<h4 id="_hooks_2">Hooks</h4>
<div class="paragraph">
<p>The Hooks and Services section of GitHub repository administration is the easiest way to have GitHub interact with external systems.</p>
</div>
<div class="sect4">
<h5 id="_services">Services</h5>
<div class="paragraph">
<p>First we&#8217;ll take a look at Services. Both the Hooks and Services integrations can be found in the Settings section of your repository, where we previously looked at adding Collaborators and changing the default branch of your project. Under the &#8220;Webhooks and Services&#8221; tab you will see something like <a href="#_services_hooks">Services and Hooks configuration section.</a>.</p>
</div>
<div id="_services_hooks" class="imageblock">
<div class="content">
<img src="images/scripting-01-services.png" alt="Services and hooks">
</div>
<div class="title">Figure 130. Services and Hooks configuration section.</div>
</div>
<div class="paragraph">
<p>There are dozens of services you can choose from, most of them integrations into other commercial and open source systems. Most of them are for Continuous Integration services, bug and issue trackers, chat room systems and documentation systems. We&#8217;ll walk through setting up a very simple one, the Email hook. If you choose &#8220;email&#8221; from the &#8220;Add Service&#8221; dropdown, you&#8217;ll get a configuration screen like <a href="#_service_config">Email service configuration.</a>.</p>
</div>
<div id="_service_config" class="imageblock">
<div class="content">
<img src="images/scripting-02-email-service.png" alt="Email service">
</div>
<div class="title">Figure 131. Email service configuration.</div>
</div>
<div class="paragraph">
<p>In this case, if we hit the &#8220;Add service&#8221; button, the email address we specified will get an email every time someone pushes to the repository. Services can listen for lots of different types of events, but most only listen for push events and then do something with that data.</p>
</div>
<div class="paragraph">
<p>If there is a system you are using that you would like to integrate with GitHub, you should check here to see if there is an existing service integration available. For example, if you&#8217;re using Jenkins to run tests on your codebase, you can enable the Jenkins builtin service integration to kick off a test run every time someone pushes to your repository.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hooks_3">Hooks</h5>
<div class="paragraph">
<p>If you need something more specific or you want to integrate with a service or site that is not included in this list, you can instead use the more generic hooks system. GitHub repository hooks are pretty simple. You specify a URL and GitHub will post an HTTP payload to that URL on any event you want.</p>
</div>
<div class="paragraph">
<p>Generally the way this works is you can setup a small web service to listen for a GitHub hook payload and then do something with the data when it is received.</p>
</div>
<div class="paragraph">
<p>To enable a hook, you click the &#8220;Add webhook&#8221; button in <a href="#_services_hooks">Services and Hooks configuration section.</a>. This will bring you to a page that looks like <a href="#_web_hook">Web hook configuration.</a>.</p>
</div>
<div id="_web_hook" class="imageblock">
<div class="content">
<img src="images/scripting-03-webhook.png" alt="Web hook">
</div>
<div class="title">Figure 132. Web hook configuration.</div>
</div>
<div class="paragraph">
<p>The configuration for a web hook is pretty simple. In most cases you simply enter a URL and a secret key and hit &#8220;Add webhook&#8221;. There are a few options for which events you want GitHub to send you a payload for&#8201;&#8212;&#8201;the default is to only get a payload for the <code>push</code> event, when someone pushes new code to any branch of your repository.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see a small example of a web service you may set up to handle a web hook. We&#8217;ll use the Ruby web framework Sinatra since it&#8217;s fairly concise and you should be able to easily see what we&#8217;re doing.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say we want to get an email if a specific person pushes to a specific branch of our project modifying a specific file. We could fairly easily do that with code like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">require 'sinatra'
require 'json'
require 'mail'

post '/payload' do
  push = JSON.parse(request.body.read) # parse the JSON

  # gather the data we're looking for
  pusher = push["pusher"]["name"]
  branch = push["ref"]

  # get a list of all the files touched
  files = push["commits"].map do |commit|
    commit['added'] + commit['modified'] + commit['removed']
  end
  files = files.flatten.uniq

  # check for our criteria
  if pusher == 'schacon' &amp;&amp;
     branch == 'ref/heads/special-branch' &amp;&amp;
     files.include?('special-file.txt')

    Mail.deliver do
      from     'tchacon@example.com'
      to       'tchacon@example.com'
      subject  'Scott Changed the File'
      body     "ALARM"
    end
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;re taking the JSON payload that GitHub delivers us and looking up who pushed it, what branch they pushed to and what files were touched in all the commits that were pushed. Then we check that against our criteria and send an email if it matches.</p>
</div>
<div class="paragraph">
<p>In order to develop and test something like this, you have a nice developer console in the same screen where you set the hook up. You can see the last few deliveries that GitHub has tried to make for that webhook. For each hook you can dig down into when it was delivered, if it was successful and the body and headers for both the request and the response. This makes it incredibly easy to test and debug your hooks.</p>
</div>
<div id="_web_hook_debug" class="imageblock">
<div class="content">
<img src="images/scripting-04-webhook-debug.png" alt="Webhook debug">
</div>
<div class="title">Figure 133. Web hook debugging information.</div>
</div>
<div class="paragraph">
<p>The other great feature of this is that you can redeliver any of the payloads to test your service easily.</p>
</div>
<div class="paragraph">
<p>For more information on how to write webhooks and all the different event types you can listen for, go to the GitHub Developer documentation at: <a href="https://developer.github.com/webhooks/" class="bare">https://developer.github.com/webhooks/</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_github_api">The GitHub API</h4>
<div class="paragraph">
<p>
Services and hooks give you a way to receive push notifications about events that happen on your repositories, but what if you need more information about these events? What if you need to automate something like adding collaborators or labeling issues?</p>
</div>
<div class="paragraph">
<p>This is where the GitHub API comes in handy. GitHub has tons of API endpoints for doing nearly anything you can do on the website in an automated fashion. In this section we&#8217;ll learn how to authenticate and connect to the API, how to comment on an issue and how to change the status of a Pull Request through the API.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_usage_2">Basic Usage</h4>
<div class="paragraph">
<p>The most basic thing you can do is a simple GET request on an endpoint that doesn&#8217;t require authentication. This could be a user or read-only information on an open source project. For example, if we want to know more about a user named &#8220;schacon&#8221;, we can run something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">$ curl https://api.github.com/users/schacon
{
  "login": "schacon",
  "id": 70,
  "avatar_url": "https://avatars.githubusercontent.com/u/70",
# …
  "name": "Scott Chacon",
  "company": "GitHub",
  "following": 19,
  "created_at": "2008-01-27T17:19:28Z",
  "updated_at": "2014-06-10T02:37:23Z"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are tons of endpoints like this to get information about organizations, projects, issues, commits&#8201;&#8212;&#8201;just about anything you can publicly see on GitHub. You can even use the API to render arbitrary Markdown or find a <code>.gitignore</code> template.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">$ curl https://api.github.com/gitignore/templates/Java
{
  "name": "Java",
  "source": "*.class

# Mobile Tools for Java (J2ME)
.mtj.tmp/

# Package Files #
*.jar
*.war
*.ear

# virtual machine crash logs, see http://www.java.com/en/download/help/error_hotspot.xml
hs_err_pid*
"
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_commenting_on_an_issue">Commenting on an Issue</h4>
<div class="paragraph">
<p>However, if you want to do an action on the website such as comment on an Issue or Pull Request or if you want to view or interact with private content, you&#8217;ll need to authenticate.</p>
</div>
<div class="paragraph">
<p>There are several ways to authenticate. You can use basic authentication with just your username and password, but generally it&#8217;s a better idea to use a personal access token.
You can generate this from the &#8220;Applications&#8221; tab of your settings page.</p>
</div>
<div id="_access_token" class="imageblock">
<div class="content">
<img src="images/scripting-05-access-token.png" alt="Access Token">
</div>
<div class="title">Figure 134. Generate your access token from the &#8220;Applications&#8221; tab of your settings page.</div>
</div>
<div class="paragraph">
<p>It will ask you which scopes you want for this token and a description. Make sure to use a good description so you feel comfortable removing the token when your script or application is no longer used.</p>
</div>
<div class="paragraph">
<p>GitHub will only show you the token once, so be sure to copy it. You can now use this to authenticate in your script instead of using a username and password. This is nice because you can limit the scope of what you want to do and the token is revokable.</p>
</div>
<div class="paragraph">
<p>This also has the added advantage of increasing your rate limit. Without authenticating, you will be limited to 60 requests per hour. If you authenticate you can make up to 5,000 requests per hour.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s use it to make a comment on one of our issues. Let&#8217;s say we want to leave a comment on a specific issue, Issue #6. To do so we have to do an HTTP POST request to <code>repos/&lt;user&gt;/&lt;repo&gt;/issues/&lt;num&gt;/comments</code> with the token we just generated as an Authorization header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">$ curl -H "Content-Type: application/json" \
       -H "Authorization: token TOKEN" \
       --data '{"body":"A new comment, :+1:"}' \
       https://api.github.com/repos/schacon/blink/issues/6/comments
{
  "id": 58322100,
  "html_url": "https://github.com/schacon/blink/issues/6#issuecomment-58322100",
  ...
  "user": {
    "login": "tonychacon",
    "id": 7874698,
    "avatar_url": "https://avatars.githubusercontent.com/u/7874698?v=2",
    "type": "User",
  },
  "created_at": "2014-10-08T07:48:19Z",
  "updated_at": "2014-10-08T07:48:19Z",
  "body": "A new comment, :+1:"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you go to that issue, you can see the comment that we just successfully posted as in <a href="#_api_comment">A comment posted from the GitHub API.</a>.</p>
</div>
<div id="_api_comment" class="imageblock">
<div class="content">
<img src="images/scripting-06-comment.png" alt="API Comment">
</div>
<div class="title">Figure 135. A comment posted from the GitHub API.</div>
</div>
<div class="paragraph">
<p>You can use the API to do just about anything you can do on the website&#8201;&#8212;&#8201;creating and setting milestones, assigning people to Issues and Pull Requests, creating and changing labels, accessing commit data, creating new commits and branches, opening, closing or merging Pull Requests, creating and editing teams, commenting on lines of code in a Pull Request, searching the site and on and on.</p>
</div>
</div>
<div class="sect3">
<h4 id="_changing_the_status_of_a_pull_request">Changing the Status of a Pull Request</h4>
<div class="paragraph">
<p>One final example we&#8217;ll look at since it&#8217;s really useful if you&#8217;re working with Pull Requests. Each commit can have one or more statuses associated with it and there is an API to add and query that status.</p>
</div>
<div class="paragraph">
<p>Most of the Continuous Integration and testing services make use of this API to react to pushes by testing the code that was pushed, and then report back if that commit has passed all the tests. You could also use this to check if the commit message is properly formatted, if the submitter followed all your contribution guidelines, if the commit was validly signed&#8201;&#8212;&#8201;any number of things.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say you set up a webhook on your repository that hits a small web service that checks for a <code>Signed-off-by</code> string in the commit message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">require 'httparty'
require 'sinatra'
require 'json'

post '/payload' do
  push = JSON.parse(request.body.read) # parse the JSON
  repo_name = push['repository']['full_name']

  # look through each commit message
  push["commits"].each do |commit|

    # look for a Signed-off-by string
    if /Signed-off-by/.match commit['message']
      state = 'success'
      description = 'Successfully signed off!'
    else
      state = 'failure'
      description = 'No signoff found.'
    end

    # post status to GitHub
    sha = commit["id"]
    status_url = "https://api.github.com/repos/#{repo_name}/statuses/#{sha}"

    status = {
      "state"       =&gt; state,
      "description" =&gt; description,
      "target_url"  =&gt; "http://example.com/how-to-signoff",
      "context"     =&gt; "validate/signoff"
    }
    HTTParty.post(status_url,
      :body =&gt; status.to_json,
      :headers =&gt; {
        'Content-Type'  =&gt; 'application/json',
        'User-Agent'    =&gt; 'tonychacon/signoff',
        'Authorization' =&gt; "token #{ENV['TOKEN']}" }
    )
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hopefully this is fairly simple to follow. In this web hook handler we look through each commit that was just pushed, we look for the string <em>Signed-off-by</em> in the commit message and finally we POST via HTTP to the <code>/repos/&lt;user&gt;/&lt;repo&gt;/statuses/&lt;commit_sha&gt;</code> API endpoint with the status.</p>
</div>
<div class="paragraph">
<p>In this case you can send a state (<em>success</em>, <em>failure</em>, <em>error</em>), a description of what happened, a target URL the user can go to for more information and a &#8220;context&#8221; in case there are multiple statuses for a single commit. For example, a testing service may provide a status and a validation service like this may also provide a status&#8201;&#8212;&#8201;the &#8220;context&#8221; field is how they&#8217;re differentiated.</p>
</div>
<div class="paragraph">
<p>If someone opens a new Pull Request on GitHub and this hook is setup, you may see something like <a href="#_commit_status">Commit status via the API.</a>.</p>
</div>
<div id="_commit_status" class="imageblock">
<div class="content">
<img src="images/scripting-07-status.png" alt="Commit status">
</div>
<div class="title">Figure 136. Commit status via the API.</div>
</div>
<div class="paragraph">
<p>You can now see a little green check mark next to the commit that has a &#8220;Signed-off-by&#8221; string in the message and a red cross through the one where the author forgot to sign off. You can also see that the Pull Request takes the status of the last commit on the branch and warns you if it is a failure. This is really useful if you&#8217;re using this API for test results so you don&#8217;t accidentally merge something where the last commit is failing tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="_octokit">Octokit</h4>
<div class="paragraph">
<p>Though we&#8217;ve been doing nearly everything through <code>curl</code> and simple HTTP requests in these examples, several open-source libraries exist that make this API available in a more idiomatic way.
At the time of this writing, the supported languages include Go, Objective-C, Ruby, and .NET.
Check out <a href="http://github.com/octokit" class="bare">http://github.com/octokit</a> for more information on these, as they handle much of the HTTP for you.</p>
</div>
<div class="paragraph">
<p>Hopefully these tools can help you customize and modify GitHub to work better for your specific workflows.
For complete documentation on the entire API as well as guides for common tasks, check out <a href="https://developer.github.com" class="bare">https://developer.github.com</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_3">Summary</h3>
<div class="paragraph">
<p>Now you&#8217;re a GitHub user.
You know how to create an account, manage an organization, create and push to repositories, contribute to other peoples projects and accept contributions from others.
In the next chapter, you&#8217;ll learn more powerful tools and tips for dealing with complex situations, which will truly make you a Git master.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_tools">Git 工具</h2>
<div class="sectionbody">
<div class="paragraph">
<p>现在，您已经学习了管理或者维护 Git 仓库、实现代码控制所需的大多数日常命令和工作流程。
您已经尝试了跟踪和提交文件的基本操作，并且发挥了暂存区和轻量级的分支及合并的威力。</p>
</div>
<div class="paragraph">
<p>接下来您将学习一些 Git 的强大功能，这些功能您可能并不会在日常操作中使用，但在某些时候您可能会需要。</p>
</div>
<div class="sect2">
<h3 id="_revision_selection">选择修订版本（Revision）</h3>
<div class="paragraph">
<p>Git 允许您通过几种方法来指明特定的或者一定范围内的提交。
了解它们并不是必需的，但是了解一下总没坏处。</p>
</div>
<div class="sect3">
<h4 id="_单个修订版本">单个修订版本</h4>
<div class="paragraph">
<p>您可以通过 Git 给出的 SHA-1 值来获取一次提交，不过还有很多更人性化的方式来做同样的事情。
本节将会介绍获取单个提交的多种方法。</p>
</div>
</div>
<div class="sect3">
<h4 id="_简短的_sha">简短的 SHA</h4>
<div class="paragraph">
<p>Git 十分智能，您只需要提供 SHA-1 的前几个字符就可以获得对应的那次提交，当然您提供的 SHA-1 字符数量不得少于 4 个，并且没有歧义——也就是说，当前仓库中只有一个对象以这段 SHA-1 开头。</p>
</div>
<div class="paragraph">
<p>例如查看一次指定的提交，假设您执行 <code>git log</code> 命令来查看之前新增一个功能的那次提交:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log
commit 734713bc047d87bf7eac9674765ae793478c50d3
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri Jan 2 18:32:33 2009 -0800

    fixed refs handling, added gc auto, updated tests

commit d921970aadf03b3cf0e71becdaab3147ba71cdef
Merge: 1c002dd... 35cfb2b...
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Thu Dec 11 15:08:43 2008 -0800

    Merge commit 'phedders/rdocs'

commit 1c002dd4b536e7479fe34593e72e6c6c1819e53b
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Thu Dec 11 14:58:32 2008 -0800

    added some blame and merge stuff</code></pre>
</div>
</div>
<div class="paragraph">
<p>假设这个提交是 <code>1c002dd....</code>，如果您想 <code>git show</code> 这个提交，下面的命令是等价的（假设简短的版本没有歧义）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show 1c002dd4b536e7479fe34593e72e6c6c1819e53b
$ git show 1c002dd4b536e7479f
$ git show 1c002d</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git 可以为 SHA-1 值生成出简短且唯一的缩写。
如果您在 <code>git log</code> 后加上 <code>--abbrev-commit</code> 参数，输出结果里就会显示简短且唯一的值；默认使用七个字符，不过有时为了避免 SHA-1 的歧义，会增加字符数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --abbrev-commit --pretty=oneline
ca82a6d changed the version number
085bb3b removed unnecessary test code
a11bef0 first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>通常 8 到 10 个字符就已经足够在一个项目中避免 SHA-1 的歧义。</p>
</div>
<div class="paragraph">
<p>比如 Linux 内核这个相当大的 Git 项目，目前有超过 45 万个提交，包含 360 万个对象，也只需要前 11 个字符就能保证唯一性。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">关于 SHA-1 的简短说明</div>
<div class="paragraph">
<p>许多人觉得他们的仓库里有可能出现两个 SHA-1 值相同的对象。
然后呢？</p>
</div>
<div class="paragraph">
<p>如果您真的向仓库里提交了一个跟之前的某个对象具有相同 SHA-1 值的对象，Git 发现仓库里已经存在了拥有相同 HASH 值的对象，就会认为这个新的提交是已经被写入仓库的。
如果之后您想检出那个对象时，您将得到先前那个对象的数据。</p>
</div>
<div class="paragraph">
<p>但是这种情况发生的概率十分渺小。SHA-1 摘要长度是 20 字节，也就是 160 位。2^80 个随机哈希对象才有 50% 的概率出现一次冲突
（计算冲突机率的公式是 <code>p = (n(n-1)/2) * (1/2^160))</code> ）。2^80
是 1.2 x 10^24
也就是一亿亿亿，那是地球上沙粒总数的 1200 倍。</p>
</div>
<div class="paragraph">
<p>举例说一下怎样才能产生一次 SHA-1 冲突。
如果地球上 65 亿个人类都在编程，每人每秒都在产生等价于整个 Linux 内核历史（360 万个 Git 对象）的代码，并将之提交到一个巨大的 Git 仓库里面，这样持续两年的时间才会产生足够的对象，使其拥有 50% 的概率产生一次 SHA-1 对象冲突。
这要比您编程团队的成员同一个晚上在互不相干的意外中被狼袭击并杀死的机率还要小。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_branch_references">分支引用</h4>
<div class="paragraph">
<p>指明一次提交最直接的方法是有一个指向它的分支引用。
这样您就可以在任意一个 Git 命令中使用这个分支名来代替对应的提交对象或者 SHA-1 值。
例如，您想要查看一个分支的最后一次提交的对象，假设 <code>topic1</code> 分支指向 <code>ca82a6d</code> ，那么以下的命令是等价的:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show ca82a6dff817ec66f44342007202690a93763949
$ git show topic1</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果您想知道某个分支指向哪个特定的 SHA ，或者想看任何一个例子中被简写的 SHA-1 ，您可以使用一个叫做 <code>rev-parse</code> 的 Git 探测工具。
您可以在 <a href="#_git_internals">Git Internals</a> 中查看更多关于探测工具的信息。简单来说，<code>rev-parse</code> 是为了底层操作而不是日常操作设计的。
不过，有时您想看 Git 现在到底处于什么状态时，它可能会很有用。
您可以在您的分支上执行 <code>rev-parse</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rev-parse topic1
ca82a6dff817ec66f44342007202690a93763949</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_reflog">引用日志</h4>
<div class="paragraph">
<p>当您在工作时， Git 会在后台保存一个引用日志(reflog)，引用日志记录了最近几个月您的 HEAD 和分支引用所指向的历史。</p>
</div>
<div class="paragraph">
<p>您可以使用 <code>git reflog</code> 来查看引用日志</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git reflog
734713b HEAD@{0}: commit: fixed refs handling, added gc auto, updated
d921970 HEAD@{1}: merge phedders/rdocs: Merge made by recursive.
1c002dd HEAD@{2}: commit: added some blame and merge stuff
1c36188 HEAD@{3}: rebase -i (squash): updating HEAD
95df984 HEAD@{4}: commit: # This is a combination of two commits.
1c36188 HEAD@{5}: rebase -i (squash): updating HEAD
7e05da5 HEAD@{6}: rebase -i (pick): updating HEAD</code></pre>
</div>
</div>
<div class="paragraph">
<p>每当您的 HEAD 所指向的位置发生了变化，Git 就会将这个信息存储到引用日志这个历史记录里。
通过这些数据，您可以很方便地获取之前的提交历史。
如果您想查看仓库中 HEAD 在五次前的所指向的提交，您可以使用 <code>@{n}</code> 来引用 reflog 中输出的提交记录。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show HEAD@{5}</code></pre>
</div>
</div>
<div class="paragraph">
<p>您同样可以使用这个语法来查看某个分支在一定时间前的位置。
例如，查看您的 <code>master</code> 分支在昨天的时候指向了哪个提交，您可以输入</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show master@{yesterday}</code></pre>
</div>
</div>
<div class="paragraph">
<p>就会显示昨天该分支的顶端指向了哪个提交。
这个方法只对还在你引用日志里的数据有用，所以不能用来查好几个月之前的提交。</p>
</div>
<div class="paragraph">
<p>可以运行 <code>git log -g</code> 来查看类似于 <code>git log</code> 输出格式的引用日志信息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -g master
commit 734713bc047d87bf7eac9674765ae793478c50d3
Reflog: master@{0} (Scott Chacon &lt;schacon@gmail.com&gt;)
Reflog message: commit: fixed refs handling, added gc auto, updated
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri Jan 2 18:32:33 2009 -0800

    fixed refs handling, added gc auto, updated tests

commit d921970aadf03b3cf0e71becdaab3147ba71cdef
Reflog: master@{1} (Scott Chacon &lt;schacon@gmail.com&gt;)
Reflog message: merge phedders/rdocs: Merge made by recursive.
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Thu Dec 11 15:08:43 2008 -0800

    Merge commit 'phedders/rdocs'</code></pre>
</div>
</div>
<div class="paragraph">
<p>值得注意的是，引用日志只存在于本地仓库，一个记录您在您自己的仓库里做过什么的日志。
其他人拷贝的仓库里的引用日志不会和您的相同；而您新克隆一个仓库的时候，引用日志是空的，因为您在仓库里还没有操作。
<code>git show HEAD@{2.months.ago}</code> 这条命令只有在您克隆了一个项目至少两个月时才会有用——如果您是五分钟前克隆的仓库，那么它将不会有结果返回。</p>
</div>
</div>
<div class="sect3">
<h4 id="_祖先引用">祖先引用</h4>
<div class="paragraph">
<p>祖先引用是另一种指明一个提交的方式。
如果您在引用的尾部加上一个 <code>^</code>， Git 会将其解析为该引用的上一个提交。
假设您的提交历史是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=format:'%h %s' --graph
* 734713b fixed refs handling, added gc auto, updated tests
*   d921970 Merge commit 'phedders/rdocs'
|\
| * 35cfb2b Some rdoc changes
* | 1c002dd added some blame and merge stuff
|/
* 1c36188 ignore *.gem
* 9b29157 add open3_detach to gemspec file list</code></pre>
</div>
</div>
<div class="paragraph">
<p>您可以使用 <code>HEAD^</code> 来查看上一个提交，也就是 &#8220;HEAD 的父提交&#8221;：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show HEAD^
commit d921970aadf03b3cf0e71becdaab3147ba71cdef
Merge: 1c002dd... 35cfb2b...
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Thu Dec 11 15:08:43 2008 -0800

    Merge commit 'phedders/rdocs'</code></pre>
</div>
</div>
<div class="paragraph">
<p>您也可以在 <code>^</code> 后面添加一个数字——例如 <code>d921970^2</code> 代表 &#8220;d921970 的第二父提交&#8221;
这个语法只适用于合并(merge)的提交，因为合并提交会有多个父提交。
第一父提交是您合并时所在分支，而第二父提交是您所合并的分支：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show d921970^
commit 1c002dd4b536e7479fe34593e72e6c6c1819e53b
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Thu Dec 11 14:58:32 2008 -0800

    added some blame and merge stuff

$ git show d921970^2
commit 35cfb2b795a55793d7cc56a6cc2060b4bb732548
Author: Paul Hedderly &lt;paul+git@mjr.org&gt;
Date:   Wed Dec 10 22:22:03 2008 +0000

    Some rdoc changes</code></pre>
</div>
</div>
<div class="paragraph">
<p>另一种指明祖先提交的方法是 <code>~</code>。
同样是指向第一父提交，因此 <code>HEAD~</code> 和 <code>HEAD^</code> 是等价的。
而区别在于您在后面加数字的时候。
<code>HEAD~2</code> 代表 &#8220;第一父提交的第一父提交&#8221;，也就是 &#8220;祖父提交&#8221; —— Git 会根据您指定的次数获取对应的第一父提交。
例如，在之前的列出的提交历史中，<code>HEAD~3</code> 就是</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show HEAD~3
commit 1c3618887afb5fbcbea25b7c013f4e2114448b8d
Author: Tom Preston-Werner &lt;tom@mojombo.com&gt;
Date:   Fri Nov 7 13:47:59 2008 -0500

    ignore *.gem</code></pre>
</div>
</div>
<div class="paragraph">
<p>也可以写成 <code>HEAD^^^</code>，也是第一父提交的第一父提交的第一父提交：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show HEAD^^^
commit 1c3618887afb5fbcbea25b7c013f4e2114448b8d
Author: Tom Preston-Werner &lt;tom@mojombo.com&gt;
Date:   Fri Nov 7 13:47:59 2008 -0500

    ignore *.gem</code></pre>
</div>
</div>
<div class="paragraph">
<p>您也可以组合使用这两个语法 —— 您可以通过 <code>HEAD~3^2</code> 来取得之前引用的第二父提交（假设它是一个合并提交）。</p>
</div>
</div>
<div class="sect3">
<h4 id="_commit_ranges">提交区间</h4>
<div class="paragraph">
<p>您已经学会如何单次的提交，现在来看看如何指明一定区间的提交。
当您有很多分支时，这对管理您的分支时十分有用，您可以用提交区间来解决 &#8220;这个分支还有哪些提交尚未合并到主分支？&#8221; 的问题</p>
</div>
<div class="sect4">
<h5 id="_双点">双点</h5>
<div class="paragraph">
<p>最常用的指名提交区间语法是双点。
这种语法可以让 Git 选出在一个分支中而不在另一个分支中的提交。
例如，您有如下的提交历史 <a href="#double_dot">Example history for range selection.</a></p>
</div>
<div id="double_dot" class="imageblock">
<div class="content">
<img src="images/double-dot.png" alt="Example history for range selection.">
</div>
<div class="title">Figure 137. Example history for range selection.</div>
</div>
<div class="paragraph">
<p>您想要查看 experiment 分支中还有哪些提交尚未被合并入 master 分支。
您可以使用 <code>master..experiment</code> 来让 Git 显示这些提交。也就是 &#8220;在 experiment 分支中而不在 master 分支中的提交&#8221;。
为了使例子简单明了，我使用了示意图中提交对象的字母来代替真实日志的输出，所以会显示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log master..experiment
D
C</code></pre>
</div>
</div>
<div class="paragraph">
<p>反过来，如果您想查看在 <code>master</code> 分支中而不在 <code>experiment</code> 分支中的提交，您只要交换分支名即可。
<code>experiment..master</code> 会显示在 <code>master</code> 分支中而不在 <code>experiment</code> 分支中的提交：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log experiment..master
F
E</code></pre>
</div>
</div>
<div class="paragraph">
<p>这可以让您保持 <code>experiment</code> 分支跟随最新的进度以及查看您即将合并的内容。
另一个常用的场景是查看您即将推送到远端的内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log origin/master..HEAD</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个命令会输出在您当前分支中而不在远程 <code>origin</code> 中的提交。
如果您执行了 <code>git push</code> 并且您的当前分支正在跟踪 <code>origin/master</code>，<code>git log origin/master..HEAD</code> 所输出的提交将会被传输到远端服务器。
如果您留空了其中的一边， Git 会默认为 HEAD。
例如， <code>git log origin/master..</code> 将会输出与之前例子相同的结果 —— Git 使用 HEAD 来代替留空的一边。</p>
</div>
</div>
<div class="sect4">
<h5 id="_多点">多点</h5>
<div class="paragraph">
<p>双点语法很好用，但有时候您可能需要两个以上的分支才能确定您所需要的修订，比如查看哪些提交是被包含在某些分支中的一个，但是不在你当前的分支上。
Git 允许您在任意引用前加上 <code>^</code> 字符或者 <code>--not</code> 来指明您不希望提交被包含其中的分支。
因此下列3个命令是等价的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log refA..refB
$ git log ^refA refB
$ git log refB --not refA</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个语法很好用，因为您可以在查询中指定超过两个的引用，这是双点语法无法实现的。
比如，您想查看所有被 <code>refA</code> 或 <code>refB</code> 包含的但是不被 <code>refC</code> 包含的提交，你可以输入下面中的任意一个命令</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log refA refB ^refC
$ git log refA refB --not refC</code></pre>
</div>
</div>
<div class="paragraph">
<p>这就构成了一个十分强大的修订查询系统，您可以通过它来查看您的分支里包含了哪些东西。</p>
</div>
</div>
<div class="sect4">
<h5 id="_triple_dot">三点</h5>
<div class="paragraph">
<p>最后一种主要的区间选择语法是三点，这个语法可以选择出被两个引用中的一个包含但又不被两者同时包含的提交。
再看看之前双点例子中的提交历史。
如果您想看 <code>master</code> 或者 <code>experiment</code> 中包含的但不是两者共有的提交，您可以执行</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log master...experiment
F
E
D
C</code></pre>
</div>
</div>
<div class="paragraph">
<p>这和通常 <code>log</code> 按日期排序的输出一样，仅仅给出了4个提交的信息。</p>
</div>
<div class="paragraph">
<p>这种情形下，<code>log</code> 命令的一个常用参数是 <code>--left-right</code>，它会显示每个提交到底处于哪一侧的分支。
这会让输出数据更加清晰。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --left-right master...experiment
&lt; F
&lt; E
&gt; D
&gt; C</code></pre>
</div>
</div>
<div class="paragraph">
<p>有了这些工具，您就可以十分方便地查看您 Git 仓库中的提交。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interactive_staging">Interactive Staging</h3>
<div class="paragraph">
<p>Git comes with a couple of scripts that make some command-line tasks easier.
Here, you’ll look at a few interactive commands that can help you easily craft your commits to include only certain combinations and parts of files.
These tools are very helpful if you modify a bunch of files and then decide that you want those changes to be in several focused commits rather than one big messy commit.
This way, you can make sure your commits are logically separate changesets and can be easily reviewed by the developers working with you.
If you run <code>git add</code> with the <code>-i</code> or <code>--interactive</code> option, Git goes into an interactive shell mode, displaying something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add -i
           staged     unstaged path
  1:    unchanged        +0/-1 TODO
  2:    unchanged        +1/-1 index.html
  3:    unchanged        +5/-1 lib/simplegit.rb

*** Commands ***
  1: status     2: update      3: revert     4: add untracked
  5: patch      6: diff        7: quit       8: help
What now&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that this command shows you a much different view of your staging area – basically the same information you get with <code>git status</code> but a bit more succinct and informative.
It lists the changes you’ve staged on the left and unstaged changes on the right.</p>
</div>
<div class="paragraph">
<p>After this comes a Commands section.
Here you can do a number of things, including staging files, unstaging files, staging parts of files, adding untracked files, and seeing diffs of what has been staged.</p>
</div>
<div class="sect3">
<h4 id="_staging_and_unstaging_files">Staging and Unstaging Files</h4>
<div class="paragraph">
<p>If you type <code>2</code> or <code>u</code> at the <code>What now&gt;</code> prompt, the script prompts you for which files you want to stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">What now&gt; 2
           staged     unstaged path
  1:    unchanged        +0/-1 TODO
  2:    unchanged        +1/-1 index.html
  3:    unchanged        +5/-1 lib/simplegit.rb
Update&gt;&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To stage the TODO and index.html files, you can type the numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">Update&gt;&gt; 1,2
           staged     unstaged path
* 1:    unchanged        +0/-1 TODO
* 2:    unchanged        +1/-1 index.html
  3:    unchanged        +5/-1 lib/simplegit.rb
Update&gt;&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>*</code> next to each file means the file is selected to be staged.
If you press Enter after typing nothing at the <code>Update&gt;&gt;</code> prompt, Git takes anything selected and stages it for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">Update&gt;&gt;
updated 2 paths

*** Commands ***
  1: status     2: update      3: revert     4: add untracked
  5: patch      6: diff        7: quit       8: help
What now&gt; 1
           staged     unstaged path
  1:        +0/-1      nothing TODO
  2:        +1/-1      nothing index.html
  3:    unchanged        +5/-1 lib/simplegit.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can see that the TODO and index.html files are staged and the simplegit.rb file is still unstaged.
If you want to unstage the TODO file at this point, you use the <code>3</code> or <code>r</code> (for revert) option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">*** Commands ***
  1: status     2: update      3: revert     4: add untracked
  5: patch      6: diff        7: quit       8: help
What now&gt; 3
           staged     unstaged path
  1:        +0/-1      nothing TODO
  2:        +1/-1      nothing index.html
  3:    unchanged        +5/-1 lib/simplegit.rb
Revert&gt;&gt; 1
           staged     unstaged path
* 1:        +0/-1      nothing TODO
  2:        +1/-1      nothing index.html
  3:    unchanged        +5/-1 lib/simplegit.rb
Revert&gt;&gt; [enter]
reverted one path</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at your Git status again, you can see that you’ve unstaged the TODO file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">*** Commands ***
  1: status     2: update      3: revert     4: add untracked
  5: patch      6: diff        7: quit       8: help
What now&gt; 1
           staged     unstaged path
  1:    unchanged        +0/-1 TODO
  2:        +1/-1      nothing index.html
  3:    unchanged        +5/-1 lib/simplegit.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>To see the diff of what you’ve staged, you can use the <code>6</code> or <code>d</code> (for diff) command.
It shows you a list of your staged files, and you can select the ones for which you would like to see the staged diff.
This is much like specifying <code>git diff --cached</code> on the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">*** Commands ***
  1: status     2: update      3: revert     4: add untracked
  5: patch      6: diff        7: quit       8: help
What now&gt; 6
           staged     unstaged path
  1:        +1/-1      nothing index.html
Review diff&gt;&gt; 1
diff --git a/index.html b/index.html
index 4d07108..4335f49 100644
--- a/index.html
+++ b/index.html
@@ -16,7 +16,7 @@ Date Finder

 &lt;p id="out"&gt;...&lt;/p&gt;

-&lt;div id="footer"&gt;contact : support@github.com&lt;/div&gt;
+&lt;div id="footer"&gt;contact : email.support@github.com&lt;/div&gt;

 &lt;script type="text/javascript"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these basic commands, you can use the interactive add mode to deal with your staging area a little more easily.</p>
</div>
</div>
<div class="sect3">
<h4 id="_staging_patches">Staging Patches</h4>
<div class="paragraph">
<p>It’s also possible for Git to stage certain parts of files and not the rest.
For example, if you make two changes to your simplegit.rb file and want to stage one of them and not the other, doing so is very easy in Git.
From the interactive prompt, type <code>5</code> or <code>p</code> (for patch).
Git will ask you which files you would like to partially stage; then, for each section of the selected files, it will display hunks of the file diff and ask if you would like to stage them, one by one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">diff --git a/lib/simplegit.rb b/lib/simplegit.rb
index dd5ecc4..57399e0 100644
--- a/lib/simplegit.rb
+++ b/lib/simplegit.rb
@@ -22,7 +22,7 @@ class SimpleGit
   end

   def log(treeish = 'master')
-    command("git log -n 25 #{treeish}")
+    command("git log -n 30 #{treeish}")
   end

   def blame(path)
Stage this hunk [y,n,a,d,/,j,J,g,e,?]?</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have a lot of options at this point.
Typing <code>?</code> shows a list of what you can do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">Stage this hunk [y,n,a,d,/,j,J,g,e,?]? ?
y - stage this hunk
n - do not stage this hunk
a - stage this and all the remaining hunks in the file
d - do not stage this hunk nor any of the remaining hunks in the file
g - select a hunk to go to
/ - search for a hunk matching the given regex
j - leave this hunk undecided, see next undecided hunk
J - leave this hunk undecided, see next hunk
k - leave this hunk undecided, see previous undecided hunk
K - leave this hunk undecided, see previous hunk
s - split the current hunk into smaller hunks
e - manually edit the current hunk
? - print help</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generally, you’ll type <code>y</code> or <code>n</code> if you want to stage each hunk, but staging all of them in certain files or skipping a hunk decision until later can be helpful too.
If you stage one part of the file and leave another part unstaged, your status output will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">What now&gt; 1
           staged     unstaged path
  1:    unchanged        +0/-1 TODO
  2:        +1/-1      nothing index.html
  3:        +1/-1        +4/-0 lib/simplegit.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>The status of the simplegit.rb file is interesting.
It shows you that a couple of lines are staged and a couple are unstaged.
You’ve partially staged this file.
At this point, you can exit the interactive adding script and run <code>git commit</code> to commit the partially staged files.</p>
</div>
<div class="paragraph">
<p>You also don’t need to be in interactive add mode to do the partial-file staging – you can start the same script by using <code>git add -p</code> or <code>git add --patch</code> on the command line.</p>
</div>
<div class="paragraph">
<p>Furthermore, you can use patch mode for partially resetting files with the <code>reset --patch</code> command, for checking out parts of files with the <code>checkout --patch</code> command and for stashing parts of files with the <code>stash save --patch</code> command. We&#8217;ll go into more details on each of these as we get to more advanced usages of these commands.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_stashing">Stashing and Cleaning</h3>
<div class="paragraph">
<p>Often, when you’ve been working on part of your project, things are in a messy state and you want to switch branches for a bit to work on something else.
The problem is, you don’t want to do a commit of half-done work just so you can get back to this point later.
The answer to this issue is the <code>git stash</code> command.</p>
</div>
<div class="paragraph">
<p>Stashing takes the dirty state of your working directory – that is, your modified tracked files and staged changes – and saves it on a stack of unfinished changes that you can reapply at any time.</p>
</div>
<div class="sect3">
<h4 id="_stashing_your_work">Stashing Your Work</h4>
<div class="paragraph">
<p>To demonstrate, you’ll go into your project and start working on a couple of files and possibly stage one of the changes.
If you run <code>git status</code>, you can see your dirty state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

	modified:   index.html

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

	modified:   lib/simplegit.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you want to switch branches, but you don’t want to commit what you’ve been working on yet; so you’ll stash the changes.
To push a new stash onto your stack, run <code>git stash</code> or <code>git stash save</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash
Saved working directory and index state \
  "WIP on master: 049d078 added the index file"
HEAD is now at 049d078 added the index file
(To restore them type "git stash apply")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your working directory is clean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
# On branch master
nothing to commit, working directory clean</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, you can easily switch branches and do work elsewhere; your changes are stored on your stack.
To see which stashes you’ve stored, you can use <code>git stash list</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash list
stash@{0}: WIP on master: 049d078 added the index file
stash@{1}: WIP on master: c264051 Revert "added file_size"
stash@{2}: WIP on master: 21d80a5 added number to log</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, two stashes were done previously, so you have access to three different stashed works.
You can reapply the one you just stashed by using the command shown in the help output of the original stash command: <code>git stash apply</code>.
If you want to apply one of the older stashes, you can specify it by naming it, like this: <code>git stash apply stash@{2}</code>.
If you don’t specify a stash, Git assumes the most recent stash and tries to apply it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash apply
# On branch master
# Changed but not updated:
#   (use "git add &lt;file&gt;..." to update what will be committed)
#
#      modified:   index.html
#      modified:   lib/simplegit.rb
#</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that Git re-modifies the files you reverted when you saved the stash.
In this case, you had a clean working directory when you tried to apply the stash, and you tried to apply it on the same branch you saved it from; but having a clean working directory and applying it on the same branch aren’t necessary to successfully apply a stash.
You can save a stash on one branch, switch to another branch later, and try to reapply the changes.
You can also have modified and uncommitted files in your working directory when you apply a stash – Git gives you merge conflicts if anything no longer applies cleanly.</p>
</div>
<div class="paragraph">
<p>The changes to your files were reapplied, but the file you staged before wasn’t restaged.
To do that, you must run the <code>git stash apply</code> command with a <code>--index</code> option to tell the command to try to reapply the staged changes.
If you had run that instead, you’d have gotten back to your original position:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash apply --index
# On branch master
# Changes to be committed:
#   (use "git reset HEAD &lt;file&gt;..." to unstage)
#
#      modified:   index.html
#
# Changed but not updated:
#   (use "git add &lt;file&gt;..." to update what will be committed)
#
#      modified:   lib/simplegit.rb
#</code></pre>
</div>
</div>
<div class="paragraph">
<p>The apply option only tries to apply the stashed work – you continue to have it on your stack.
To remove it, you can run <code>git stash drop</code> with the name of the stash to remove:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash list
stash@{0}: WIP on master: 049d078 added the index file
stash@{1}: WIP on master: c264051 Revert "added file_size"
stash@{2}: WIP on master: 21d80a5 added number to log
$ git stash drop stash@{0}
Dropped stash@{0} (364e91f3f268f0900bc3ee613f9f733e82aaed43)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run <code>git stash pop</code> to apply the stash and then immediately drop it from your stack.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creative_stashing">Creative Stashing</h4>
<div class="paragraph">
<p>There are a few stash variants that may also be helpful. The first option that is quite popular is the <code>--keep-index</code> option to the <code>stash save</code> command. This tells Git to not stash anything that you&#8217;ve already staged with the <code>git add</code> command.</p>
</div>
<div class="paragraph">
<p>This can be really helpful if you&#8217;ve made a number of changes but want to only commit some of them and then come back to the rest of the changes at a later time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status -s
M  index.html
 M lib/simplegit.rb

$ git stash --keep-index
Saved working directory and index state WIP on master: 1b65b17 added the index file
HEAD is now at 1b65b17 added the index file

$ git status -s
M  index.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another common thing you may want to do with stash is to stash the untracked files as well as the tracked ones. By default, <code>git stash</code> will only store files that are already in the index. If you specify <code>--include-untracked</code> or <code>-u</code>, Git will also stash any untracked files you have created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status -s
M  index.html
 M lib/simplegit.rb
?? new-file.txt

$ git stash -u
Saved working directory and index state WIP on master: 1b65b17 added the index file
HEAD is now at 1b65b17 added the index file

$ git status -s
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, if you specify the <code>--patch</code> flag, Git will not stash everything that is modified but will instead prompt you interactively which of the changes you would like to stash and which you would like to keep in your working directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash --patch
diff --git a/lib/simplegit.rb b/lib/simplegit.rb
index 66d332e..8bb5674 100644
--- a/lib/simplegit.rb
+++ b/lib/simplegit.rb
@@ -16,6 +16,10 @@ class SimpleGit
         return `#{git_cmd} 2&gt;&amp;1`.chomp
       end
     end
+
+    def show(treeish = 'master')
+      command("git show #{treeish}")
+    end

 end
 test
Stash this hunk [y,n,q,a,d,/,e,?]? y

Saved working directory and index state WIP on master: 1b65b17 added the index file</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_branch_from_a_stash">Creating a Branch from a Stash</h4>
<div class="paragraph">
<p>If you stash some work, leave it there for a while, and continue on the branch from which you stashed the work, you may have a problem reapplying the work.
If the apply tries to modify a file that you’ve since modified, you’ll get a merge conflict and will have to try to resolve it.
If you want an easier way to test the stashed changes again, you can run <code>git stash branch</code>, which creates a new branch for you, checks out the commit you were on when you stashed your work, reapplies your work there, and then drops the stash if it applies successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git stash branch testchanges
Switched to a new branch "testchanges"
# On branch testchanges
# Changes to be committed:
#   (use "git reset HEAD &lt;file&gt;..." to unstage)
#
#      modified:   index.html
#
# Changed but not updated:
#   (use "git add &lt;file&gt;..." to update what will be committed)
#
#      modified:   lib/simplegit.rb
#
Dropped refs/stash@{0} (f0dfc4d5dc332d1cee34a634182e168c4efc3359)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a nice shortcut to recover stashed work easily and work on it in a new branch.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_clean">Cleaning your Working Directory</h4>
<div class="paragraph">
<p>Finally, you may not want to stash some work or files in your working directory, but simply get rid of them. The <code>git clean</code> command will do this for you.</p>
</div>
<div class="paragraph">
<p>Some common reasons for this might be to remove cruft that has been generated by merges or external tools or to remove build artifacts in order to run a clean build.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll want to be pretty careful with this command, since it&#8217;s designed to remove files from your working directory that are not tracked. If you change your mind, there is often no retrieving the content of those files. A safer option is to run <code>git stash --all</code> to remove everything but save it in a stash.</p>
</div>
<div class="paragraph">
<p>Assuming you do want to remove cruft files or clean your working directory, you can do so with <code>git clean</code>. To remove all the untracked files in your working directory, you can run <code>git clean -f -d</code>, which removes any files and also any subdirectories that become empty as a result. The <code>-f</code> means <em>force</em> or "really do this".</p>
</div>
<div class="paragraph">
<p>If you ever want to see what it would do, you can run the command with the <code>-n</code> option, which means &#8220;do a dry run and tell me what you <em>would</em> have removed&#8221;.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clean -d -n
Would remove test.o
Would remove tmp/</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>git clean</code> command will only remove untracked files that are not ignored.  Any file that matches a pattern in your <code>.gitignore</code> or other ignore files will not be removed. If you want to remove those files too, such as to remove all <code>.o</code> files generated from a build so you can do a fully clean build, you can add a <code>-x</code> to the clean command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status -s
 M lib/simplegit.rb
?? build.TMP
?? tmp/

$ git clean -n -d
Would remove build.TMP
Would remove tmp/

$ git clean -n -d -x
Would remove build.TMP
Would remove test.o
Would remove tmp/</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t know what the <code>git clean</code> command is going to do, always run it with a <code>-n</code> first to double check before changing the <code>-n</code> to a <code>-f</code> and doing it for real. The other way you can be careful about the process is to run it with the <code>-i</code> or &#8220;interactive&#8221; flag.</p>
</div>
<div class="paragraph">
<p>This will run the clean command in an interactive mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clean -x -i
Would remove the following items:
  build.TMP  test.o
*** Commands ***
    1: clean                2: filter by pattern    3: select by numbers    4: ask each             5: quit
    6: help
What now&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way you can step through each file individually or specify patterns for deletion interactively.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_signing">Signing Your Work</h3>
<div class="paragraph">
<p>Git is cryptographically secure, but it&#8217;s not foolproof. If you&#8217;re taking work from others on the internet and want to verify that commits are actually from a trusted source, Git has a few ways to sign and verify work using GPG.</p>
</div>
<div class="sect3">
<h4 id="_gpg_introduction">GPG Introduction</h4>
<div class="paragraph">
<p>First of all, if you want to sign anything you need to get GPG configured and your personal key installed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ gpg --list-keys
/Users/schacon/.gnupg/pubring.gpg
---------------------------------
pub   2048R/0A46826A 2014-06-04
uid                  Scott Chacon (Git signing key) &lt;schacon@gmail.com&gt;
sub   2048R/874529A9 2014-06-04</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t have a key installed, you can generate one with <code>gpg --gen-key</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">gpg --gen-key</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have a private key to sign with, you can configure Git to use it for signing things by setting the <code>user.signingkey</code> config setting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">git config --global user.signingkey 0A46826A</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Git will use your key by default to sign tags and commits if you want.</p>
</div>
</div>
<div class="sect3">
<h4 id="_signing_tags">Signing Tags</h4>
<div class="paragraph">
<p>If you have a GPG private key setup, you can now use it to sign new tags.
All you have to do is use <code>-s</code> instead of <code>-a</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -s v1.5 -m 'my signed 1.5 tag'

You need a passphrase to unlock the secret key for
user: "Ben Straub &lt;ben@straub.cc&gt;"
2048-bit RSA key, ID 800430EB, created 2014-05-04</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run <code>git show</code> on that tag, you can see your GPG signature attached to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show v1.5
tag v1.5
Tagger: Ben Straub &lt;ben@straub.cc&gt;
Date:   Sat May 3 20:29:41 2014 -0700

my signed 1.5 tag
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQEcBAABAgAGBQJTZbQlAAoJEF0+sviABDDrZbQH/09PfE51KPVPlanr6q1v4/Ut
LQxfojUWiLQdg2ESJItkcuweYg+kc3HCyFejeDIBw9dpXt00rY26p05qrpnG+85b
hM1/PswpPLuBSr+oCIDj5GMC2r2iEKsfv2fJbNW8iWAXVLoWZRF8B0MfqX/YTMbm
ecorc4iXzQu7tupRihslbNkfvfciMnSDeSvzCpWAHl7h8Wj6hhqePmLm9lAYqnKp
8S5B/1SSQuEAjRZgI4IexpZoeKGVDptPHxLLS38fozsyi0QyDyzEgJxcJQVMXxVi
RUysgqjcpT8+iQM1PblGfHR4XAhuOqN5Fx06PSaFZhqvWFezJ28/CLyX5q+oIVk=
=EFTF
-----END PGP SIGNATURE-----

commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_verifying_tags">Verifying Tags</h4>
<div class="paragraph">
<p>To verify a signed tag, you use <code>git tag -v [tag-name]</code>.
This command uses GPG to verify the signature.
You need the signer’s public key in your keyring for this to work properly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -v v1.4.2.1
object 883653babd8ee7ea23e6a5c392bb739348b1eb61
type commit
tag v1.4.2.1
tagger Junio C Hamano &lt;junkio@cox.net&gt; 1158138501 -0700

GIT 1.4.2.1

Minor fixes since 1.4.2, including git-mv and git-http with alternates.
gpg: Signature made Wed Sep 13 02:08:25 2006 PDT using DSA key ID F3119B9A
gpg: Good signature from "Junio C Hamano &lt;junkio@cox.net&gt;"
gpg:                 aka "[jpeg image of size 1513]"
Primary key fingerprint: 3565 2A26 2040 E066 C9A7  4A7D C0C6 D9A4 F311 9B9A</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don’t have the signer’s public key, you get something like this instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">gpg: Signature made Wed Sep 13 02:08:25 2006 PDT using DSA key ID F3119B9A
gpg: Can't check signature: public key not found
error: could not verify the tag 'v1.4.2.1'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_signing_commits">Signing Commits</h4>
<div class="paragraph">
<p>In more recent versions of Git (v1.7.9 and above), you can now also sign individual commits.
If you&#8217;re interested in signing commits directly instead of just the tags, all you need to do is add a <code>-S</code> to your <code>git commit</code> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -a -S -m 'signed commit'

You need a passphrase to unlock the secret key for
user: "Scott Chacon (Git signing key) &lt;schacon@gmail.com&gt;"
2048-bit RSA key, ID 0A46826A, created 2014-06-04

[master 5c3386c] signed commit
 4 files changed, 4 insertions(+), 24 deletions(-)
 rewrite Rakefile (100%)
 create mode 100644 lib/git.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>To see and verify these signatures, there is also a <code>--show-signature</code> option to <code>git log</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --show-signature -1
commit 5c3386cf54bba0a33a32da706aa52bc0155503c2
gpg: Signature made Wed Jun  4 19:49:17 2014 PDT using RSA key ID 0A46826A
gpg: Good signature from "Scott Chacon (Git signing key) &lt;schacon@gmail.com&gt;"
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Wed Jun 4 19:49:17 2014 -0700

    signed commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, you can configure <code>git log</code> to check any signatures it finds and list them in it&#8217;s output with the <code>%G?</code> format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty="format:%h %G? %aN  %s"

5c3386c G Scott Chacon  signed commit
ca82a6d N Scott Chacon  changed the version number
085bb3b N Scott Chacon  removed unnecessary test code
a11bef0 N Scott Chacon  first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see that only the latest commit is signed and valid and the previous commits are not.</p>
</div>
<div class="paragraph">
<p>In Git 1.8.3 and later, "git merge" and "git pull" can  be told to inspect and reject when merging a commit that does not carry a trusted GPG signature with the <code>--verify-signatures</code> command.</p>
</div>
<div class="paragraph">
<p>If you use this option when merging a branch and it contains commits that are not signed and valid, the merge will not work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge --verify-signatures non-verify
fatal: Commit ab06180 does not have a GPG signature.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the merge contains only valid signed commits, the merge command will show you all the signatures it has checked and then move forward with the merge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge --verify-signatures signed-branch
Commit 13ad65e has a good GPG signature by Scott Chacon (Git signing key) &lt;schacon@gmail.com&gt;
Updating 5c3386c..13ad65e
Fast-forward
 README | 2 ++
 1 file changed, 2 insertions(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>-S</code> option with the <code>git merge</code> command itself to sign the resulting merge commit itself. The following example both verifies that every commit in the branch to be merged is signed and furthermore signs the resulting merge commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge --verify-signatures -S  signed-branch
Commit 13ad65e has a good GPG signature by Scott Chacon (Git signing key) &lt;schacon@gmail.com&gt;

You need a passphrase to unlock the secret key for
user: "Scott Chacon (Git signing key) &lt;schacon@gmail.com&gt;"
2048-bit RSA key, ID 0A46826A, created 2014-06-04

Merge made by the 'recursive' strategy.
 README | 2 ++
 1 file changed, 2 insertions(+)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_everyone_must_sign">Everyone Must Sign</h4>
<div class="paragraph">
<p>Signing tags and commits is great, but if you decide to use this in your normal workflow, you&#8217;ll have to make sure that everyone on your team understands how to do so. If you don&#8217;t, you&#8217;ll end up spending a lot of time helping people figure out how to rewrite their commits with signed versions. Make sure you understand GPG and the benefits of signing things before adopting this as part of your standard workflow.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_searching">搜索</h3>
<div class="paragraph">
<p>无论仓库里的代码量有多少，您经常需要查找一个函数是在哪里调用或者定义的，或者一个方法的变更历史。Git 提供了两个有用的工具来快速地从它的数据库中浏览代码和提交。我们来简单的看一下。</p>
</div>
<div class="sect3">
<h4 id="_git_grep">Git Grep</h4>
<div class="paragraph">
<p>Git 提供了一个 <code>grep</code> 命令，您可以很方便地从提交历史或者工作目录中查找一个字符串或者正则表达式。我们用 Git 本身源代码的查找作为例子。</p>
</div>
<div class="paragraph">
<p>默认情况下 Git 会查找您工作目录的文件。您可以传入 <code>-n</code> 参数来输出 Git 所找到的匹配行行号。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git grep -n gmtime_r
compat/gmtime.c:3:#undef gmtime_r
compat/gmtime.c:8:      return git_gmtime_r(timep, &amp;result);
compat/gmtime.c:11:struct tm *git_gmtime_r(const time_t *timep, struct tm *result)
compat/gmtime.c:16:     ret = gmtime_r(timep, result);
compat/mingw.c:606:struct tm *gmtime_r(const time_t *timep, struct tm *result)
compat/mingw.h:162:struct tm *gmtime_r(const time_t *timep, struct tm *result);
date.c:429:             if (gmtime_r(&amp;now, &amp;now_tm))
date.c:492:             if (gmtime_r(&amp;time, tm)) {
git-compat-util.h:721:struct tm *git_gmtime_r(const time_t *, struct tm *);
git-compat-util.h:723:#define gmtime_r git_gmtime_r</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>grep</code> 命令有一些有趣的选项。</p>
</div>
<div class="paragraph">
<p>例如，您可以使用 <code>--count</code> 选项来使 Git 输出概述的信息，仅仅包括哪些文件包含匹配以及每个文件包含了多少个匹配。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git grep --count gmtime_r
compat/gmtime.c:4
compat/mingw.c:1
compat/mingw.h:1
date.c:2
git-compat-util.h:2</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果您想看匹配的行是属于哪一个方法或者函数，您可以传入 <code>-p</code> 选项：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git grep -p gmtime_r *.c
date.c=static int match_multi_number(unsigned long num, char c, const char *date, char *end, struct tm *tm)
date.c:         if (gmtime_r(&amp;now, &amp;now_tm))
date.c=static int match_digit(const char *date, struct tm *tm, int *offset, int *tm_gmt)
date.c:         if (gmtime_r(&amp;time, tm)) {</code></pre>
</div>
</div>
<div class="paragraph">
<p>在这里我们可以看到在 date.c 文件中有 <code>match_multi_number</code> 和 <code>match_digit</code> 两个函数调用了 <code>gmtime_r</code>。</p>
</div>
<div class="paragraph">
<p>您还可以使用 <code>--and</code> 标志来查看复杂的字符串组合，也就是在同一行同时包含多个匹配。比如，我们要查看在旧版本 1.8.0 的 Git 代码库中定义了常量名包含 &#8220;LINK&#8221; 或者 &#8220;BUF_MAX&#8221; 这两个字符串所在的行。</p>
</div>
<div class="paragraph">
<p>这里我们也用到了 <code>--break</code> 和 <code>--heading</code> 选项来使输出更加容易阅读。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git grep --break --heading \
    -n -e '#define' --and \( -e LINK -e BUF_MAX \) v1.8.0
v1.8.0:builtin/index-pack.c
62:#define FLAG_LINK (1u&lt;&lt;20)

v1.8.0:cache.h
73:#define S_IFGITLINK  0160000
74:#define S_ISGITLINK(m)       (((m) &amp; S_IFMT) == S_IFGITLINK)

v1.8.0:environment.c
54:#define OBJECT_CREATION_MODE OBJECT_CREATION_USES_HARDLINKS

v1.8.0:strbuf.c
326:#define STRBUF_MAXLINK (2*PATH_MAX)

v1.8.0:symlinks.c
53:#define FL_SYMLINK  (1 &lt;&lt; 2)

v1.8.0:zlib.c
30:/* #define ZLIB_BUF_MAX ((uInt)-1) */
31:#define ZLIB_BUF_MAX ((uInt) 1024 * 1024 * 1024) /* 1GB */</code></pre>
</div>
</div>
<div class="paragraph">
<p>相比于一些常用的搜索命令比如 <code>grep</code> 和 <code>ack</code>，<code>git grep</code> 命令有一些的优点。第一就是速度非常快，第二是您不仅仅可以可以搜索工作目录，还可以搜索任意的 Git 树。在上一个例子中，我们在一个旧版本的 Git 源代码中查找，而不是当前检出的版本。</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_日志搜索">Git 日志搜索</h4>
<div class="paragraph">
<p>或许您不想知道某一项在 <strong>哪里</strong> ，而是想知道是什么 <strong>时候</strong> 存在或者引入的。<code>git log</code> 命令有许多强大的工具可以通过提交信息甚至是 diff 的内容来找到某个特定的提交。</p>
</div>
<div class="paragraph">
<p>例如，如果我们想找到 <code>ZLIB_BUF_MAX</code> 常量是什么时候引入的，我们可以使用 <code>-S</code> 选项来显示新增和删除该字符串的提交。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -SZLIB_BUF_MAX --oneline
e01503b zlib: allow feeding more than 4GB in one go
ef49a7a zlib: zlib can only process 4GB at a time</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果我们查看这些提交的 diff，我们可以看到在 <code>ef49a7a</code> 这个提交引入了常量，并且在 <code>e01503b</code> 这个提交中被修改了。</p>
</div>
<div class="paragraph">
<p>如果您希望得到更精确的结果，您可以使用 <code>-G</code> 选项来使用正则表达式搜索。</p>
</div>
<div class="sect4">
<h5 id="_行日志搜索">行日志搜索</h5>
<div class="paragraph">
<p>行日志搜索是另一个相当高级并且有用的日志搜索功能。这是一个最近新增的不太知名的功能，但却是十分有用。在 <code>git log</code> 后加上 <code>-L</code> 选项即可调用，它可以展示代码中一行或者一个函数的历史。</p>
</div>
<div class="paragraph">
<p>例如，假设我们想查看 <code>zlib.c</code> 文件中`git_deflate_bound` 函数的每一次变更，我们可以执行 <code>git log -L :git_deflate_bound:zlib.c</code>。Git 会尝试找出这个函数的范围，然后查找历史记录，并且显示从函数创建之后一系列变更对应的补丁。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -L :git_deflate_bound:zlib.c
commit ef49a7a0126d64359c974b4b3b71d7ad42ee3bca
Author: Junio C Hamano &lt;gitster@pobox.com&gt;
Date:   Fri Jun 10 11:52:15 2011 -0700

    zlib: zlib can only process 4GB at a time

diff --git a/zlib.c b/zlib.c
--- a/zlib.c
+++ b/zlib.c
@@ -85,5 +130,5 @@
-unsigned long git_deflate_bound(z_streamp strm, unsigned long size)
+unsigned long git_deflate_bound(git_zstream *strm, unsigned long size)
 {
-       return deflateBound(strm, size);
+       return deflateBound(&amp;strm-&gt;z, size);
 }


commit 225a6f1068f71723a910e8565db4e252b3ca21fa
Author: Junio C Hamano &lt;gitster@pobox.com&gt;
Date:   Fri Jun 10 11:18:17 2011 -0700

    zlib: wrap deflateBound() too

diff --git a/zlib.c b/zlib.c
--- a/zlib.c
+++ b/zlib.c
@@ -81,0 +85,5 @@
+unsigned long git_deflate_bound(z_streamp strm, unsigned long size)
+{
+       return deflateBound(strm, size);
+}
+</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果 Git 无法计算出如何匹配您代码中的函数或者方法，您可以提供一个正则表达式。例如，这个命令和上面的是等同的：<code>git log -L '/unsigned long git_deflate_bound/',/^}/:zlib.c</code>。您也可以提供单行或者一个范围的行号来获得相同的输出。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rewriting_history">Rewriting History</h3>
<div class="paragraph">
<p>Many times, when working with Git, you may want to revise your commit history for some reason.
One of the great things about Git is that it allows you to make decisions at the last possible moment.
You can decide what files go into which commits right before you commit with the staging area, you can decide that you didn’t mean to be working on something yet with the stash command, and you can rewrite commits that already happened so they look like they happened in a different way.
This can involve changing the order of the commits, changing messages or modifying files in a commit, squashing together or splitting apart commits, or removing commits entirely – all before you share your work with others.</p>
</div>
<div class="paragraph">
<p>In this section, you’ll cover how to accomplish these very useful tasks so that you can make your commit history look the way you want before you share it with others.</p>
</div>
<div class="sect3">
<h4 id="_git_amend">Changing the Last Commit</h4>
<div class="paragraph">
<p>Changing your last commit is probably the most common rewriting of history that you’ll do.
You’ll often want to do two basic things to your last commit: change the commit message, or change the snapshot you just recorded by adding, changing and removing files.</p>
</div>
<div class="paragraph">
<p>If you only want to modify your last commit message, it’s very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit --amend</code></pre>
</div>
</div>
<div class="paragraph">
<p>That drops you into your text editor, which has your last commit message in it, ready for you to modify the message.
When you save and close the editor, the editor writes a new commit containing that message and makes it your new last commit.</p>
</div>
<div class="paragraph">
<p>If you’ve committed and then you want to change the snapshot you committed by adding or changing files, possibly because you forgot to add a newly created file when you originally committed, the process works basically the same way.
You stage the changes you want by editing a file and running <code>git add</code> on it or <code>git rm</code> to a tracked file, and the subsequent <code>git commit --amend</code> takes your current staging area and makes it the snapshot for the new commit.</p>
</div>
<div class="paragraph">
<p>You need to be careful with this technique because amending changes the SHA-1 of the commit.
It’s like a very small rebase – don’t amend your last commit if you’ve already pushed it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_changing_multiple">Changing Multiple Commit Messages</h4>
<div class="paragraph">
<p>To modify a commit that is farther back in your history, you must move to more complex tools.
Git doesn’t have a modify-history tool, but you can use the rebase tool to rebase a series of commits onto the HEAD they were originally based on instead of moving them to another one.
With the interactive rebase tool, you can then stop after each commit you want to modify and change the message, add files, or do whatever you wish.
You can run rebase interactively by adding the <code>-i</code> option to <code>git rebase</code>.
You must indicate how far back you want to rewrite commits by telling the command which commit to rebase onto.</p>
</div>
<div class="paragraph">
<p>For example, if you want to change the last three commit messages, or any of the commit messages in that group, you supply as an argument to <code>git rebase -i</code> the parent of the last commit you want to edit, which is <code>HEAD~2^</code> or <code>HEAD~3</code>.
It may be easier to remember the <code>~3</code> because you’re trying to edit the last three commits; but keep in mind that you’re actually designating four commits ago, the parent of the last commit you want to edit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase -i HEAD~3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember again that this is a rebasing command – every commit included in the range <code>HEAD~3..HEAD</code> will be rewritten, whether you change the message or not.
Don’t include any commit you’ve already pushed to a central server – doing so will confuse other developers by providing an alternate version of the same change.</p>
</div>
<div class="paragraph">
<p>Running this command gives you a list of commits in your text editor that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">pick f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file

# Rebase 710f0f8..a5f4a0d onto 710f0f8
#
# Commands:
#  p, pick = use commit
#  r, reword = use commit, but edit the commit message
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#  f, fixup = like "squash", but discard this commit's log message
#  x, exec = run command (the rest of the line) using shell
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out</code></pre>
</div>
</div>
<div class="paragraph">
<p>It’s important to note that these commits are listed in the opposite order than you normally see them using the <code>log</code> command.
If you run a <code>log</code>, you see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=format:"%h %s" HEAD~3..HEAD
a5f4a0d added cat-file
310154e updated README formatting and added blame
f7f3f6d changed my name a bit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the reverse order.
The interactive rebase gives you a script that it’s going to run.
It will start at the commit you specify on the command line (<code>HEAD~3</code>) and replay the changes introduced in each of these commits from top to bottom.
It lists the oldest at the top, rather than the newest, because that’s the first one it will replay.</p>
</div>
<div class="paragraph">
<p>You need to edit the script so that it stops at the commit you want to edit.
To do so, change the word &#8216;pick&#8217; to the word &#8216;edit&#8217; for each of the commits you want the script to stop after.
For example, to modify only the third commit message, you change the file to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">edit f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you save and exit the editor, Git rewinds you back to the last commit in that list and drops you on the command line with the following message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase -i HEAD~3
Stopped at f7f3f6d... changed my name a bit
You can amend the commit now, with

       git commit --amend

Once you’re satisfied with your changes, run

       git rebase --continue</code></pre>
</div>
</div>
<div class="paragraph">
<p>These instructions tell you exactly what to do.
Type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit --amend</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the commit message, and exit the editor.
Then, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase --continue</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will apply the other two commits automatically, and then you’re done.
If you change pick to edit on more lines, you can repeat these steps for each commit you change to edit.
Each time, Git will stop, let you amend the commit, and continue when you’re finished.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reordering_commits">Reordering Commits</h4>
<div class="paragraph">
<p>You can also use interactive rebases to reorder or remove commits entirely.
If you want to remove the &#8220;added cat-file&#8221; commit and change the order in which the other two commits are introduced, you can change the rebase script from this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">pick f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file</code></pre>
</div>
</div>
<div class="paragraph">
<p>to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">pick 310154e updated README formatting and added blame
pick f7f3f6d changed my name a bit</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you save and exit the editor, Git rewinds your branch to the parent of these commits, applies <code>310154e</code> and then <code>f7f3f6d</code>, and then stops.
You effectively change the order of those commits and remove the &#8220;added cat-file&#8221; commit completely.</p>
</div>
</div>
<div class="sect3">
<h4 id="_squashing">Squashing Commits</h4>
<div class="paragraph">
<p>It’s also possible to take a series of commits and squash them down into a single commit with the interactive rebasing tool.
The script puts helpful instructions in the rebase message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">#
# Commands:
#  p, pick = use commit
#  r, reword = use commit, but edit the commit message
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#  f, fixup = like "squash", but discard this commit's log message
#  x, exec = run command (the rest of the line) using shell
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out</code></pre>
</div>
</div>
<div class="paragraph">
<p>If, instead of &#8220;pick&#8221; or &#8220;edit&#8221;, you specify &#8220;squash&#8221;, Git applies both that change and the change directly before it and makes you merge the commit messages together.
So, if you want to make a single commit from these three commits, you make the script look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">pick f7f3f6d changed my name a bit
squash 310154e updated README formatting and added blame
squash a5f4a0d added cat-file</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you save and exit the editor, Git applies all three changes and then puts you back into the editor to merge the three commit messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># This is a combination of 3 commits.
# The first commit's message is:
changed my name a bit

# This is the 2nd commit message:

updated README formatting and added blame

# This is the 3rd commit message:

added cat-file</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you save that, you have a single commit that introduces the changes of all three previous commits.</p>
</div>
</div>
<div class="sect3">
<h4 id="_splitting_a_commit">Splitting a Commit</h4>
<div class="paragraph">
<p>Splitting a commit undoes a commit and then partially stages and commits as many times as commits you want to end up with.
For example, suppose you want to split the middle commit of your three commits.
Instead of &#8220;updated README formatting and added blame&#8221;, you want to split it into two commits: &#8220;updated README formatting&#8221; for the first, and &#8220;added blame&#8221; for the second.
You can do that in the <code>rebase -i</code> script by changing the instruction on the commit you want to split to &#8220;edit&#8221;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">pick f7f3f6d changed my name a bit
edit 310154e updated README formatting and added blame
pick a5f4a0d added cat-file</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, when the script drops you to the command line, you reset that commit, take the changes that have been reset, and create multiple commits out of them.
When you save and exit the editor, Git rewinds to the parent of the first commit in your list, applies the first commit (<code>f7f3f6d</code>), applies the second (<code>310154e</code>), and drops you to the console.
There, you can do a mixed reset of that commit with <code>git reset HEAD^</code>, which effectively undoes that commit and leaves the modified files unstaged.
Now you can stage and commit files until you have several commits, and run <code>git rebase --continue</code> when you’re done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git reset HEAD^
$ git add README
$ git commit -m 'updated README formatting'
$ git add lib/simplegit.rb
$ git commit -m 'added blame'
$ git rebase --continue</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git applies the last commit (<code>a5f4a0d</code>) in the script, and your history looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -4 --pretty=format:"%h %s"
1c002dd added cat-file
9b29157 added blame
35cfb2b updated README formatting
f3cc40e changed my name a bit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, this changes the SHAs of all the commits in your list, so make sure no commit shows up in that list that you’ve already pushed to a shared repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_nuclear_option_filter_branch">The Nuclear Option: filter-branch</h4>
<div class="paragraph">
<p>There is another history-rewriting option that you can use if you need to rewrite a larger number of commits in some scriptable way – for instance, changing your e-mail address globally or removing a file from every commit.
The command is <code>filter-branch</code>, and it can rewrite huge swaths of your history, so you probably shouldn’t use it unless your project isn’t yet public and other people haven’t based work off the commits you’re about to rewrite.
However, it can be very useful.
You’ll learn a few of the common uses so you can get an idea of some of the things it’s capable of.</p>
</div>
<div class="sect4">
<h5 id="_removing_file_every_commit">Removing a File from Every Commit</h5>
<div class="paragraph">
<p>This occurs fairly commonly.
Someone accidentally commits a huge binary file with a thoughtless <code>git add .</code>, and you want to remove it everywhere.
Perhaps you accidentally committed a file that contained a password, and you want to make your project open source.
<code>filter-branch</code> is the tool you probably want to use to scrub your entire history.
To remove a file named passwords.txt from your entire history, you can use the <code>--tree-filter</code> option to <code>filter-branch</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git filter-branch --tree-filter 'rm -f passwords.txt' HEAD
Rewrite 6b9b3cf04e7c5686a9cb838c3f36a8cb6a0fc2bd (21/21)
Ref 'refs/heads/master' was rewritten</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--tree-filter</code> option runs the specified command after each checkout of the project and then recommits the results.
In this case, you remove a file called passwords.txt from every snapshot, whether it exists or not.
If you want to remove all accidentally committed editor backup files, you can run something like <code>git filter-branch --tree-filter 'rm -f *~' HEAD</code>.</p>
</div>
<div class="paragraph">
<p>You’ll be able to watch Git rewriting trees and commits and then move the branch pointer at the end.
It’s generally a good idea to do this in a testing branch and then hard-reset your master branch after you’ve determined the outcome is what you really want.
To run <code>filter-branch</code> on all your branches, you can pass <code>--all</code> to the command.</p>
</div>
</div>
<div class="sect4">
<h5 id="_making_a_subdirectory_the_new_root">Making a Subdirectory the New Root</h5>
<div class="paragraph">
<p>Suppose you’ve done an import from another source control system and have subdirectories that make no sense (trunk, tags, and so on).
If you want to make the <code>trunk</code> subdirectory be the new project root for every commit, <code>filter-branch</code> can help you do that, too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git filter-branch --subdirectory-filter trunk HEAD
Rewrite 856f0bf61e41a27326cdae8f09fe708d679f596f (12/12)
Ref 'refs/heads/master' was rewritten</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now your new project root is what was in the <code>trunk</code> subdirectory each time.
Git will also automatically remove commits that did not affect the subdirectory.</p>
</div>
</div>
<div class="sect4">
<h5 id="_changing_e_mail_addresses_globally">Changing E-Mail Addresses Globally</h5>
<div class="paragraph">
<p>Another common case is that you forgot to run <code>git config</code> to set your name and e-mail address before you started working, or perhaps you want to open-source a project at work and change all your work e-mail addresses to your personal address.
In any case, you can change e-mail addresses in multiple commits in a batch with <code>filter-branch</code> as well.
You need to be careful to change only the e-mail addresses that are yours, so you use <code>--commit-filter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git filter-branch --commit-filter '
        if [ "$GIT_AUTHOR_EMAIL" = "schacon@localhost" ];
        then
                GIT_AUTHOR_NAME="Scott Chacon";
                GIT_AUTHOR_EMAIL="schacon@example.com";
                git commit-tree "$@";
        else
                git commit-tree "$@";
        fi' HEAD</code></pre>
</div>
</div>
<div class="paragraph">
<p>This goes through and rewrites every commit to have your new address.
Because commits contain the SHA-1 values of their parents, this command changes every commit SHA in your history, not just those that have the matching e-mail address.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_reset">Reset Demystified</h3>
<div class="paragraph">
<p>Before moving on to more specialized tools, let&#8217;s talk about <code>reset</code> and <code>checkout</code>.
These commands are two of the most confusing parts of Git when you first encounter them.
They do so many things, that it seems hopeless to actually understand them and employ them properly.
For this, we recommend a simple metaphor.</p>
</div>
<div class="sect3">
<h4 id="_the_three_trees">The Three Trees</h4>
<div class="paragraph">
<p>An easier way to think about <code>reset</code> and <code>checkout</code> is through the mental frame of Git being a content manager of three different trees.
By &#8220;tree&#8221; here we really mean &#8220;collection of files&#8221;, not specifically the data structure.
(There are a few cases where the index doesn&#8217;t exactly act like a tree, but for our purposes it is easier to think about it this way for now.)</p>
</div>
<div class="paragraph">
<p>Git as a system manages and manipulates three trees in its normal operation:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33%;">
<col style="width: 66%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Tree</th>
<th class="tableblock halign-left valign-top">Role</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HEAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last commit snapshot, next parent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proposed next commit snapshot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Working Directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sandbox</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_the_head">The HEAD</h5>
<div class="paragraph">
<p>HEAD is the pointer to the current branch reference, which is in turn a pointer to the last commit made on that branch.
That means HEAD will be the parent of the next commit that is created.
It&#8217;s generally simplest to think of HEAD as the snapshot of <strong>your last commit</strong>.</p>
</div>
<div class="paragraph">
<p>In fact, it&#8217;s pretty easy to see what that snapshot looks like.
Here is an example of getting the actual directory listing and SHA checksums for each file in the HEAD snapshot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p HEAD
tree cfda3bf379e4f8dba8717dee55aab78aef7f4daf
author Scott Chacon  1301511835 -0700
committer Scott Chacon  1301511835 -0700

initial commit

$ git ls-tree -r HEAD
100644 blob a906cb2a4a904a152...   README
100644 blob 8f94139338f9404f2...   Rakefile
040000 tree 99f1a6d12cb4b6f19...   lib</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>cat-file</code> and <code>ls-tree</code> commands are &#8220;plumbing&#8221; commands that are used for lower level things and not really used in day-to-day work, but they help us see what&#8217;s going on here.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_index">The Index</h5>
<div class="paragraph">
<p>The Index is your <strong>proposed next commit</strong>. We&#8217;ve also been referring to this concept as Git&#8217;s &#8220;Staging Area&#8221; as this is what Git looks at when you run <code>git commit</code>.</p>
</div>
<div class="paragraph">
<p>Git populates this index with a list of all the file contents that were last checked out into your working directory and what they looked like when they were originally checked out.
You then replace some of those files with new versions of them, and <code>git commit</code> converts that into the tree for a new commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git ls-files -s
100644 a906cb2a4a904a152e80877d4088654daad0c859 0	README
100644 8f94139338f9404f26296befa88755fc2598c289 0	Rakefile
100644 47c6340d6459e05787f644c2447d2595f5d3a54b 0	lib/simplegit.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, here we&#8217;re using <code>ls-files</code>, which is more of a behind the scenes command that shows you what your index currently looks like.</p>
</div>
<div class="paragraph">
<p>The index is not technically a tree structure – it&#8217;s actually implemented as a flattened manifest – but for our purposes it&#8217;s close enough.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_working_directory">The Working Directory</h5>
<div class="paragraph">
<p>Finally, you have your working directory.
The other two trees store their content in an efficient but inconvenient manner, inside the <code>.git</code> folder.
The Working Directory unpacks them into actual files, which makes it much easier for you to edit them.
Think of the Working Directory as a <strong>sandbox</strong>, where you can try changes out before committing them to your staging area (index) and then to history.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ tree
.
├── README
├── Rakefile
└── lib
    └── simplegit.rb

1 directory, 3 files</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_workflow">The Workflow</h4>
<div class="paragraph">
<p>Git&#8217;s main purpose is to record snapshots of your project in successively better states, by manipulating these three trees.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-workflow.png" alt="reset workflow">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s visualize this process: say you go into a new directory with a single file in it.
We&#8217;ll call this <strong>v1</strong> of the file, and we&#8217;ll indicate it in blue.
Now we run <code>git init</code>, which will create a Git repository with a HEAD reference which points to an unborn branch (<code>master</code> doesn&#8217;t exist yet).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-ex1.png" alt="reset ex1">
</div>
</div>
<div class="paragraph">
<p>At this point, only the Working Directory tree has any content.</p>
</div>
<div class="paragraph">
<p>Now we want to commit this file, so we use <code>git add</code> to take content in the Working Directory and copy it to the Index.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-ex2.png" alt="reset ex2">
</div>
</div>
<div class="paragraph">
<p>Then we run <code>git commit</code>, which takes the contents of the Index and saves it as a permanent snapshot, creates a commit object which points to that snapshot, and updates <code>master</code> to point to that commit.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-ex3.png" alt="reset ex3">
</div>
</div>
<div class="paragraph">
<p>If we run <code>git status</code>, we&#8217;ll see no changes, because all three trees are the same.</p>
</div>
<div class="paragraph">
<p>Now we want to make a change to that file and commit it.
We&#8217;ll go through the same process; first we change the file in our working directory.
Let&#8217;s call this <strong>v2</strong> of the file, and indicate it in red.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-ex4.png" alt="reset ex4">
</div>
</div>
<div class="paragraph">
<p>If we run <code>git status</code> right now, we&#8217;ll see the file in red as &#8220;Changes not staged for commit,&#8221; because that entry differs between the Index and the Working Directory.
Next we run <code>git add</code> on it to stage it into our Index.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-ex5.png" alt="reset ex5">
</div>
</div>
<div class="paragraph">
<p>At this point if we run <code>git status</code> we will see the file in green
under &#8220;Changes to be committed&#8221; because the Index and HEAD differ – that is, our proposed next commit is now different from our last commit.
Finally, we run <code>git commit</code> to finalize the commit.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-ex6.png" alt="reset ex6">
</div>
</div>
<div class="paragraph">
<p>Now <code>git status</code> will give us no output, because all three trees are the same again.</p>
</div>
<div class="paragraph">
<p>Switching branches or cloning goes through a similar process.
When you checkout a branch, it changes <strong>HEAD</strong> to point to the new branch ref, populates your <strong>Index</strong> with the snapshot of that commit, then copies the contents of the <strong>Index</strong> into your <strong>Working Directory</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_role_of_reset">The Role of Reset</h4>
<div class="paragraph">
<p>The <code>reset</code> command makes more sense when viewed in this context.</p>
</div>
<div class="paragraph">
<p>For the purposes of these examples, let&#8217;s say that we&#8217;ve modified <code>file.txt</code> again and committed it a third time. So now our history looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-start.png" alt="reset start">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now walk through exactly what <code>reset</code> does when you call it. It directly manipulates these three trees in a simple and predictable way.
It does up to three basic operations.</p>
</div>
<div class="sect4">
<h5 id="_step_1_move_head">Step 1: Move HEAD</h5>
<div class="paragraph">
<p>The first thing <code>reset</code> will do is move what HEAD points to.
This isn&#8217;t the same as changing HEAD itself (which is what <code>checkout</code> does); <code>reset</code> moves the branch that HEAD is pointing to.
This means if HEAD is set to the <code>master</code> branch (ie, you&#8217;re currently on the <code>master</code> branch), running <code>git reset 9e5e64a</code> will start by making <code>master</code> point to <code>9e5e64a</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-soft.png" alt="reset soft">
</div>
</div>
<div class="paragraph">
<p>No matter what form of <code>reset</code> with a commit you invoke, this is the first thing it will always try to do.
With <code>reset --soft</code>, it will simply stop there.</p>
</div>
<div class="paragraph">
<p>Now take a second to look at that diagram and realize what happened: it essentially undid the last <code>git commit</code> command.
When you run <code>git commit</code>, Git creates a new commit and moves the branch that HEAD points to up to it.
When you <code>reset</code> back to <code>HEAD~</code> (the parent of HEAD), you are moving the branch back to where it was, without changing the Index or Working Directory.
You could now update the Index and run <code>git commit</code> again to accomplish what <code>git commit --amend</code> would have done (see <a href="#_git_amend">Changing the Last Commit</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_step_2_updating_the_index_mixed">Step 2: Updating the Index (--mixed)</h5>
<div class="paragraph">
<p>Note that if you run <code>git status</code> now you&#8217;ll see in green the difference between the Index and what the new HEAD is.</p>
</div>
<div class="paragraph">
<p>The next thing <code>reset</code> will do is to update the Index with the contents of whatever snapshot HEAD now points to.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-mixed.png" alt="reset mixed">
</div>
</div>
<div class="paragraph">
<p>If you specify the <code>--mixed</code> option, <code>reset</code> will stop at this point.
This is also the default, so if you specify no option at all (just <code>git reset HEAD~</code> in this case), this is where the command will stop.</p>
</div>
<div class="paragraph">
<p>Now take another second to look at that diagram and realize what happened: it still undid your last <code>commit</code>, but also <em>unstaged</em> everything.
You rolled back to before you ran all your <code>git add</code> and <code>git commit</code> commands.</p>
</div>
</div>
<div class="sect4">
<h5 id="_step_3_updating_the_working_directory_hard">Step 3: Updating the Working Directory (--hard)</h5>
<div class="paragraph">
<p>The third thing that <code>reset</code> will do is to make the Working Directory look like the Index.
If you use the <code>--hard</code> option, it will continue to this stage.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-hard.png" alt="reset hard">
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s think about what just happened.
You undid your last commit, the <code>git add</code> and <code>git commit</code> commands, <strong>and</strong> all the work you did in your working directory.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that this flag (<code>--hard</code>) is the only way to make the <code>reset</code> command dangerous, and one of the very few cases where Git will actually destroy data.
Any other invocation of <code>reset</code> can be pretty easily undone, but the <code>--hard</code> option cannot, since it forcibly overwrites files in the Working Directory.
In this particular case, we still have the <strong>v3</strong> version of our file in a commit in our Git DB, and we could get it back by looking at our <code>reflog</code>, but if we had not committed it, Git still would have overwritten the file and it would be unrecoverable.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recap">Recap</h5>
<div class="paragraph">
<p>The <code>reset</code> command overwrites these three trees in a specific order, stopping when you tell it to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Move the branch HEAD points to <em>(stop here if <code>--soft</code>)</em></p>
</li>
<li>
<p>Make the Index look like HEAD <em>(stop here unless <code>--hard</code>)</em></p>
</li>
<li>
<p>Make the Working Directory look like the Index</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_reset_with_a_path">Reset With a Path</h4>
<div class="paragraph">
<p>That covers the behavior of <code>reset</code> in its basic form, but you can also provide it with a path to act upon.
If you specify a path, <code>reset</code> will skip step 1, and limit the remainder of its actions to a specific file or set of files.
This actually sort of makes sense – HEAD is just a pointer, and you can&#8217;t point to part of one commit and part of another.
But the Index and Working directory <em>can</em> be partially updated, so reset proceeds with steps 2 and 3.</p>
</div>
<div class="paragraph">
<p>So, assume we run <code>git reset file.txt</code>.
This form (since you did not specify a commit SHA or branch, and you didn&#8217;t specify <code>--soft</code> or <code>--hard</code>) is shorthand for <code>git reset --mixed HEAD file.txt</code>, which will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Move the branch HEAD points to <em>(skipped)</em></p>
</li>
<li>
<p>Make the Index look like HEAD <em>(stop here)</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So it essentially just copies <code>file.txt</code> from HEAD to the Index.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-path1.png" alt="reset path1">
</div>
</div>
<div class="paragraph">
<p>This has the practical effect of <em>unstaging</em> the file.
If we look at the diagram for that command and think about what <code>git add</code> does, they are exact opposites.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-path2.png" alt="reset path2">
</div>
</div>
<div class="paragraph">
<p>This is why the output of the <code>git status</code> command suggests that you run this to unstage a file.
(See <a href="#_unstaging">Unstaging a Staged File</a> for more on this.)</p>
</div>
<div class="paragraph">
<p>We could just as easily not let Git assume we meant &#8220;pull the data from HEAD&#8221; by specifying a specific commit to pull that file version from.
We would just run something like <code>git reset eb43bf file.txt</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-path3.png" alt="reset path3">
</div>
</div>
<div class="paragraph">
<p>This effectively does the same thing as if we had reverted the content of the file to <strong>v1</strong> in the Working Directory, ran <code>git add</code> on it, then reverted it back to <strong>v3</strong> again (without actually going through all those steps).
If we run <code>git commit</code> now, it will record a change that reverts that file back to <strong>v1</strong>, even though we never actually had it in our Working Directory again.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also interesting to note that like <code>git add</code>, the <code>reset</code> command will accept a <code>--patch</code> option to unstage content on a hunk-by-hunk basis.
So you can selectively unstage or revert content.</p>
</div>
</div>
<div class="sect3">
<h4 id="_squashing_2">Squashing</h4>
<div class="paragraph">
<p>Let&#8217;s look at how to do something interesting with this newfound power – squashing commits.</p>
</div>
<div class="paragraph">
<p>Say you have a series of commits with messages like &#8220;oops.&#8221;, &#8220;WIP&#8221; and &#8220;forgot this file&#8221;.
You can use <code>reset</code> to quickly and easily squash them into a single commit that makes you look really smart.
(<a href="#_squashing">Squashing Commits</a> shows another way to do this, but in this example it&#8217;s simpler to use <code>reset</code>.)</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say you have a project where the first commit has one file, the second commit added a new file and changed the first, and the third commit changed the first file again.
The second commit was a work in progress and you want to squash it down.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-squash-r1.png" alt="reset squash r1">
</div>
</div>
<div class="paragraph">
<p>You can run <code>git reset --soft HEAD~2</code> to move the HEAD branch back to an older commit (the first commit you want to keep):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-squash-r2.png" alt="reset squash r2">
</div>
</div>
<div class="paragraph">
<p>And then simply run <code>git commit</code> again:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-squash-r3.png" alt="reset squash r3">
</div>
</div>
<div class="paragraph">
<p>Now you can see that your reachable history, the history you would push, now looks like you had one commit with <code>file-a.txt</code> v1, then a second that both modified <code>file-a.txt</code> to v3 and added <code>file-b.txt</code>. The commit with the v2 version of the file is no longer in the history.</p>
</div>
</div>
<div class="sect3">
<h4 id="_check_it_out">Check It Out</h4>
<div class="paragraph">
<p>Finally, you may wonder what the difference between <code>checkout</code> and <code>reset</code> is.
Like <code>reset</code>, <code>checkout</code> manipulates the three trees, and it is a bit different depending on whether you give the command a file path or not.</p>
</div>
<div class="sect4">
<h5 id="_without_paths">Without Paths</h5>
<div class="paragraph">
<p>Running <code>git checkout [branch]</code> is pretty similar to running <code>git reset --hard [branch]</code> in that it updates all three trees for you to look like <code>[branch]</code>, but there are two important differences.</p>
</div>
<div class="paragraph">
<p>First, unlike <code>reset --hard</code>, <code>checkout</code> is working-directory safe; it will check to make sure it&#8217;s not blowing away files that have changes to them.
Actually, it&#8217;s a bit smarter than that – it tries to do a trivial merge in the Working Directory, so all of the files you <em>haven&#8217;t</em> changed in  will be updated.
<code>reset --hard</code>, on the other hand, will simply replace everything across the board without checking.</p>
</div>
<div class="paragraph">
<p>The second important difference is how it updates HEAD.
Where <code>reset</code> will move the branch that HEAD points to, <code>checkout</code> will move HEAD itself to point to another branch.</p>
</div>
<div class="paragraph">
<p>For instance, say we have <code>master</code> and <code>develop</code> branches which point at different commits, and we&#8217;re currently on <code>develop</code> (so HEAD points to it).
If we run <code>git reset master</code>, <code>develop</code> itself will now point to the same commit that <code>master</code> does.
If we instead run <code>git checkout master</code>, <code>develop</code> does not move, HEAD itself does.
HEAD will now point to <code>master</code>.</p>
</div>
<div class="paragraph">
<p>So, in both cases we&#8217;re moving HEAD to point to commit A, but <em>how</em> we do so is very different.
<code>reset</code> will move the branch HEAD points to, <code>checkout</code> moves HEAD itself.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/reset-checkout.png" alt="reset checkout">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_with_paths">With Paths</h5>
<div class="paragraph">
<p>The other way to run <code>checkout</code> is with a file path, which, like <code>reset</code>, does not move HEAD.
It is just like <code>git reset [branch] file</code> in that it updates the index with that file at that commit, but it also overwrites the file in the working directory.
It would be exactly like <code>git reset --hard [branch] file</code> (if <code>reset</code> would let you run that) – it&#8217;s not working-directory safe, and it does not move HEAD.</p>
</div>
<div class="paragraph">
<p>Also, like <code>git reset</code> and <code>git add</code>, <code>checkout</code> will accept a <code>--patch</code> option to allow you to selectively revert file contents on a hunk-by-hunk basis.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_summary_4">Summary</h4>
<div class="paragraph">
<p>Hopefully now you understand and feel more comfortable with the <code>reset</code> command, but are probably still a little confused about how exactly it differs from <code>checkout</code> and could not possibly remember all the rules of the different invocations.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a cheat-sheet for which commands affect which trees.
The &#8220;HEAD&#8221; column reads &#8220;REF&#8221; if that command moves the reference (branch) that HEAD points to, and &#8220;HEAD&#8221; if it moves HEAD itself.
Pay especial attention to the <em>WD Safe?</em> column – if it says <strong>NO</strong>, take a second to think before running that command.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 42%;">
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">HEAD</th>
<th class="tableblock halign-left valign-top">Index</th>
<th class="tableblock halign-left valign-top">Workdir</th>
<th class="tableblock halign-left valign-top">WD Safe?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Commit Level</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reset --soft [commit]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reset [commit]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reset --hard [commit]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>NO</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>checkout [commit]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HEAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>File Level</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reset (commit) [file]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>checkout (commit) [file]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>NO</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_merging">Advanced Merging</h3>
<div class="paragraph">
<p>Merging in Git is typically fairly easy. Since Git makes it easy to merge another branch multiple times, it means that you can have a very long lived branch but you can keep it up to date as you go, solving small conflicts often, rather than be surprised by one enormous conflict at the end of the series.</p>
</div>
<div class="paragraph">
<p>However, sometimes tricky conflicts do occur. Unlike some other version control systems, Git does not try to be overly clever about merge conflict resolution. Git&#8217;s philosophy is to be smart about determining when a merge resolution is unambiguous, but if there is a conflict, it does not try to be clever about automatically resolving it. Therefore, if you wait too long to merge two branches that diverge quickly, you can run into some issues.</p>
</div>
<div class="paragraph">
<p>In this section, we&#8217;ll go over what some of those issues might be and what tools Git gives you to help handle these more tricky situations. We&#8217;ll also cover some of the different, non-standard types of merges you can do, as well as see how to back out of merges that you&#8217;ve done.</p>
</div>
<div class="sect3">
<h4 id="_merge_conflicts">Merge Conflicts</h4>
<div class="paragraph">
<p>While we covered some basics on resolving merge conflicts in <a href="#_basic_merge_conflicts">Basic Merge Conflicts</a>, for more complex conflicts, Git provides a few tools to help you figure out what&#8217;s going on and how to better deal with the conflict.</p>
</div>
<div class="paragraph">
<p>First of all, if at all possible, try to make sure your working directory is clean before doing a merge that may have conflicts. If you have work in progress, either commit it to a temporary branch or stash it. This makes it so that you can undo <strong>anything</strong> you try here. If you have unsaved changes in your working directory when you try a merge, some of these tips may help you lose that work.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through a very simple example. We have a super simple Ruby file that prints <em>hello world</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#! /usr/bin/env ruby

def hello
  puts 'hello world'
end

hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our repository, we create a new branch named <code>whitespace</code> and proceed to change all the Unix line endings to DOS line endings, essentially changing every line of the file, but just with whitespace. Then we change the line &#8220;hello world&#8221; to &#8220;hello mundo&#8221;.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b whitespace
Switched to a new branch 'whitespace'

$ unix2dos hello.rb
unix2dos: converting file hello.rb to DOS format ...
$ git commit -am 'converted hello.rb to DOS'
[whitespace 3270f76] converted hello.rb to DOS
 1 file changed, 7 insertions(+), 7 deletions(-)

$ vim hello.rb
$ git diff -w
diff --git a/hello.rb b/hello.rb
index ac51efd..e85207e 100755
--- a/hello.rb
+++ b/hello.rb
@@ -1,7 +1,7 @@
 #! /usr/bin/env ruby

 def hello
-  puts 'hello world'
+  puts 'hello mundo'^M
 end

 hello()

$ git commit -am 'hello mundo change'
[whitespace 6d338d2] hello mundo change
 1 file changed, 1 insertion(+), 1 deletion(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we switch back to our <code>master</code> branch and add some documentation for the function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
Switched to branch 'master'

$ vim hello.rb
$ git diff
diff --git a/hello.rb b/hello.rb
index ac51efd..36c06c8 100755
--- a/hello.rb
+++ b/hello.rb
@@ -1,5 +1,6 @@
 #! /usr/bin/env ruby

+# prints out a greeting
 def hello
   puts 'hello world'
 end

$ git commit -am 'document the function'
[master bec6336] document the function
 1 file changed, 1 insertion(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we try to merge in our <code>whitespace</code> branch and we&#8217;ll get conflicts because of the whitespace changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge whitespace
Auto-merging hello.rb
CONFLICT (content): Merge conflict in hello.rb
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_abort_merge">Aborting a Merge</h5>
<div class="paragraph">
<p>We now have a few options. First, let&#8217;s cover how to get out of this situation. If you perhaps weren&#8217;t expecting conflicts and don&#8217;t want to quite deal with the situation yet, you can simply back out of the merge with <code>git merge --abort</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status -sb
## master
UU hello.rb

$ git merge --abort

$ git status -sb
## master</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>git merge --abort</code> option tries to revert back to your state before you ran the merge. The only cases where it may not be able to do this perfectly would be if you had unstashed, uncommitted changes in your working directory when you ran it, otherwise it should work fine.</p>
</div>
<div class="paragraph">
<p>If for some reason you find yourself in a horrible state and just want to start over, you can also run <code>git reset --hard HEAD</code> or wherever you want to get back to. Remember again that this will blow away your working directory, so make sure you don&#8217;t want any changes there.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ignoring_whitespace">Ignoring Whitespace</h5>
<div class="paragraph">
<p>In this specific case, the conflicts are whitespace related. We know this because the case is simple, but it&#8217;s also pretty easy to tell in real cases when looking at the conflict because every line is removed on one side and added again on the other. By default, Git sees all of these lines as being changed, so it can&#8217;t merge the files.</p>
</div>
<div class="paragraph">
<p>The default merge strategy can take arguments though, and a few of them are about properly ignoring whitespace changes. If you see that you have a lot of whitespace issues in a merge, you can simply abort it and do it again, this time with <code>-Xignore-all-space</code> or <code>-Xignore-space-change</code>. The first option ignores changes in any <strong>amount</strong> of existing whitespace, the second ignores all whitespace changes altogether.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge -Xignore-all-space whitespace
Auto-merging hello.rb
Merge made by the 'recursive' strategy.
 hello.rb | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since in this case, the actual file changes were not conflicting, once we ignore the whitespace changes, everything merges just fine.</p>
</div>
<div class="paragraph">
<p>This is a lifesaver if you have someone on your team who likes to occasionally reformat everything from spaces to tabs or vice-versa.</p>
</div>
</div>
<div class="sect4">
<h5 id="_manual_remerge">Manual File Re-merging</h5>
<div class="paragraph">
<p>Though Git handles whitespace pre-processing pretty well, there are other types of changes that perhaps Git can&#8217;t handle automatically, but are scriptable fixes. As an example, let&#8217;s pretend that Git could not handle the whitespace change and we needed to do it by hand.</p>
</div>
<div class="paragraph">
<p>What we really need to do is run the file we&#8217;re trying to merge in through a <code>dos2unix</code> program before trying the actual file merge. So how would we do that?</p>
</div>
<div class="paragraph">
<p>First, we get into the merge conflict state. Then we want to get copies of my version of the file, their version (from the branch we&#8217;re merging in) and the common version (from where both sides branched off). Then we want to fix up either their side or our side and re-try the merge again  for just this single file.</p>
</div>
<div class="paragraph">
<p>Getting the three file versions is actually pretty easy. Git stores all of these versions in the index under &#8220;stages&#8221; which each have numbers associated with them. Stage 1 is the common anecestor, stage 2 is your version and stage 3 is from the <code>MERGE_HEAD</code>, the version you&#8217;re merging in (&#8220;theirs&#8221;).</p>
</div>
<div class="paragraph">
<p>You can extract a copy of each of these versions of the conflicted file with the <code>git show</code> command and a special syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show :1:hello.rb &gt; hello.common.rb
$ git show :2:hello.rb &gt; hello.ours.rb
$ git show :3:hello.rb &gt; hello.theirs.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to get a little more hard core, you can also use the <code>ls-files -u</code> plumbing command to get the actual SHAs of the Git blobs for each of these files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git ls-files -u
100755 ac51efdc3df4f4fd328d1a02ad05331d8e2c9111 1	hello.rb
100755 36c06c8752c78d2aff89571132f3bf7841a7b5c3 2	hello.rb
100755 e85207e04dfdd5eb0a1e9febbc67fd837c44a1cd 3	hello.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:1:hello.rb</code> is just a shorthand for looking up that blob SHA.</p>
</div>
<div class="paragraph">
<p>Now that we have the content of all three stages in our working directory, we can manually fix up theirs to fix the whitespace issue and re-merge the file with the little-known <code>git merge-file</code> command which does just that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ dos2unix hello.theirs.rb
dos2unix: converting file hello.theirs.rb to Unix format ...

$ git merge-file -p \
    hello.ours.rb hello.common.rb hello.theirs.rb &gt; hello.rb

$ git diff -w
diff --cc hello.rb
index 36c06c8,e85207e..0000000
--- a/hello.rb
+++ b/hello.rb
@@@ -1,8 -1,7 +1,8 @@@
  #! /usr/bin/env ruby

 +# prints out a greeting
  def hello
-   puts 'hello world'
+   puts 'hello mundo'
  end

  hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point we have nicely merged the file. In fact, this actually works better than the <code>ignore-all-space</code> option because this actually fixes the whitespace changes before merge instead of simply ignoring them. In the <code>ignore-all-space</code> merge, we actually ended up with a few lines with DOS line endings, making things mixed.</p>
</div>
<div class="paragraph">
<p>If you want to get an idea before finalizing this commit about what was actually changed between one side or the other, you can ask <code>git diff</code> to compare what is in your working directory that you&#8217;re about to commit as the result of the merge to any of these stages. Let&#8217;s go through them all.</p>
</div>
<div class="paragraph">
<p>To compare your result to what you had in your branch before the merge, in other words, to see what the merge introduced, you can run <code>git diff --ours</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --ours
* Unmerged path hello.rb
diff --git a/hello.rb b/hello.rb
index 36c06c8..44d0a25 100755
--- a/hello.rb
+++ b/hello.rb
@@ -2,7 +2,7 @@

 # prints out a greeting
 def hello
-  puts 'hello world'
+  puts 'hello mundo'
 end

 hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>So here we can easily see that what happened in our branch, what we&#8217;re actually introducing to this file with this merge, is changing that single line.</p>
</div>
<div class="paragraph">
<p>If we want to see how the result of the merge differed from what was on their side, you can run <code>git diff --theirs</code>. In this and the following example, we have to use <code>-w</code> to strip out the whitespace because we&#8217;re comparing it to what is in Git, not our cleaned up <code>hello.theirs.rb</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --theirs -w
* Unmerged path hello.rb
diff --git a/hello.rb b/hello.rb
index e85207e..44d0a25 100755
--- a/hello.rb
+++ b/hello.rb
@@ -1,5 +1,6 @@
 #! /usr/bin/env ruby

+# prints out a greeting
 def hello
   puts 'hello mundo'
 end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you can see how the file has changed from both sides with <code>git diff --base</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --base -w
* Unmerged path hello.rb
diff --git a/hello.rb b/hello.rb
index ac51efd..44d0a25 100755
--- a/hello.rb
+++ b/hello.rb
@@ -1,7 +1,8 @@
 #! /usr/bin/env ruby

+# prints out a greeting
 def hello
-  puts 'hello world'
+  puts 'hello mundo'
 end

 hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point we can use the <code>git clean</code> command to clear out the extra files we created to do the manual merge but no longer need.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clean -f
Removing hello.common.rb
Removing hello.ours.rb
Removing hello.theirs.rb</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_checking_out_conflicts">Checking Out Conflicts</h5>
<div class="paragraph">
<p>Perhaps we&#8217;re not happy with the resolution at this point for some reason, or maybe manually editing one or both sides still didn&#8217;t work well and we need more context.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s change up the example a little. For this example, we have two longer lived branches that each have a few commits in them but create a legitimate content conflict when merged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --graph --oneline --decorate --all
* f1270f7 (HEAD, master) update README
* 9af9d3b add a README
* 694971d update phrase to hola world
| * e3eb223 (mundo) add more tests
| * 7cff591 add testing script
| * c3ffff1 changed text to hello mundo
|/
* b7dcc89 initial hello world code</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now have three unique commits that live only on the <code>master</code> branch and three others that live on the <code>mundo</code> branch. If we try to merge the <code>mundo</code> branch in, we get a conflict.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge mundo
Auto-merging hello.rb
CONFLICT (content): Merge conflict in hello.rb
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to see what the merge conflict is. If we open up the file, we&#8217;ll see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#! /usr/bin/env ruby

def hello
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
  puts 'hola world'
=======
  puts 'hello mundo'
&gt;&gt;&gt;&gt;&gt;&gt;&gt; mundo
end

hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both sides of the merge added content to this file, but some of the commits modified the file in the same place that caused this conflict.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s explore a couple of tools that you now have at your disposal to determine how this conflict came to be. Perhaps it&#8217;s not obvious how exactly you should fix this conflict. You need more context.</p>
</div>
<div class="paragraph">
<p>One helpful tool is <code>git checkout</code> with the &#8216;--conflict&#8217; option. This will re-checkout the file again and replace the merge conflict markers. This can be useful if you want to reset the markers and try to resolve them again.</p>
</div>
<div class="paragraph">
<p>You can pass <code>--conflict</code> either <code>diff3</code> or <code>merge</code> (which is the default). If you pass it <code>diff3</code>, Git will use a slightly different version of conflict markers, not only giving you the &#8220;ours&#8221; and &#8220;theirs&#8221; versions, but also the &#8220;base&#8221; version inline to give you more context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout --conflict=diff3 hello.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we run that, the file will look like this instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#! /usr/bin/env ruby

def hello
&lt;&lt;&lt;&lt;&lt;&lt;&lt; ours
  puts 'hola world'
||||||| base
  puts 'hello world'
=======
  puts 'hello mundo'
&gt;&gt;&gt;&gt;&gt;&gt;&gt; theirs
end

hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you like this format, you can set it as the default for future merge conflicts by setting the <code>merge.conflictstyle</code> setting to <code>diff3</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global merge.conflictstyle diff3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>git checkout</code> command can also take <code>--ours</code> and <code>--theirs</code> options, which can be a really fast way of just choosing either one side or the other without merging things at all.</p>
</div>
<div class="paragraph">
<p>This can be particularly useful for conflicts of binary files where you can simply choose one side, or where you only want to merge certain files in from another branch - you can do the merge and then checkout certain files from one side or the other before committing.</p>
</div>
</div>
<div class="sect4">
<h5 id="_merge_log">Merge Log</h5>
<div class="paragraph">
<p>Another useful tool when resolving merge conflicts is <code>git log</code>. This can help you get context on what may have contributed to the conflicts. Reviewing a little bit of history to remember why two lines of development were touching the same area of code can be really helpful sometimes.</p>
</div>
<div class="paragraph">
<p>To get a full list of all of the unique commits that were included in either branch involved in this merge, we can use the &#8220;triple dot&#8221; syntax that we learned in <a href="#_triple_dot">三点</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --left-right HEAD...MERGE_HEAD
&lt; f1270f7 update README
&lt; 9af9d3b add a README
&lt; 694971d update phrase to hola world
&gt; e3eb223 add more tests
&gt; 7cff591 add testing script
&gt; c3ffff1 changed text to hello mundo</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a nice list of the six total commits involved, as well as which line of development each commit was on.</p>
</div>
<div class="paragraph">
<p>We can further simplify this though to give us much more specific context. If we add the <code>--merge</code> option to <code>git log</code>, it will only show the commits in either side of the  merge that touch a file that&#8217;s currently conflicted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --left-right --merge
&lt; 694971d update phrase to hola world
&gt; c3ffff1 changed text to hello mundo</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run that with the <code>-p</code> option instead, you get just the diffs to the file that ended up in conflict. This can be <strong>really</strong> helpful in quickly giving you the context you need to help understand why something conflicts and how to more intelligently resolve it.</p>
</div>
</div>
<div class="sect4">
<h5 id="_combined_diff_format">Combined Diff Format</h5>
<div class="paragraph">
<p>Since Git stages any merge results that are successful, when you run <code>git diff</code> while in a conflicted merge state, you only get what is currently still in conflict. This can be helpful to see what you still have to resolve.</p>
</div>
<div class="paragraph">
<p>When you run <code>git diff</code> directly after a merge conflict, it will give you information in a rather unique diff output format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --cc hello.rb
index 0399cd5,59727f0..0000000
--- a/hello.rb
+++ b/hello.rb
@@@ -1,7 -1,7 +1,11 @@@
  #! /usr/bin/env ruby

  def hello
++&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
 +  puts 'hola world'
++=======
+   puts 'hello mundo'
++&gt;&gt;&gt;&gt;&gt;&gt;&gt; mundo
  end

  hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The format is called &#8220;Combined Diff&#8221; and gives you two columns of data next to each line. The first column shows you if that line is different (added or removed) between the &#8220;ours&#8221; branch and the file in your working directory and the second column does the same between the &#8220;theirs&#8221; branch and your working directory copy.</p>
</div>
<div class="paragraph">
<p>So in that example you can see that the <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> and <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code> lines are in the working copy but were not in either side of the merge. This makes sense because the merge tool stuck them in there for our context, but we&#8217;re expected to remove them.</p>
</div>
<div class="paragraph">
<p>If we resolve the conflict and run <code>git diff</code> again, we&#8217;ll see the same thing, but it&#8217;s a little more useful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim hello.rb
$ git diff
diff --cc hello.rb
index 0399cd5,59727f0..0000000
--- a/hello.rb
+++ b/hello.rb
@@@ -1,7 -1,7 +1,7 @@@
  #! /usr/bin/env ruby

  def hello
-   puts 'hola world'
 -  puts 'hello mundo'
++  puts 'hola mundo'
  end

  hello()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows us that &#8220;hola world&#8221; was in our side but not in the working copy, that &#8220;hello mundo&#8221; was in their side but not in the working copy and finally that &#8220;hola mundo&#8221; was not in either side but is now in the working copy. This can be useful to review before committing the resolution.</p>
</div>
<div class="paragraph">
<p>You can also get this from the <code>git log</code> for any merge after the fact to see how something was resolved after the fact. Git will output this format if you run <code>git show</code> on a merge commit, or if you add a <code>--cc</code> option to a <code>git log -p</code> (which by default only shows patches for non-merge commits).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --cc -p -1
commit 14f41939956d80b9e17bb8721354c33f8d5b5a79
Merge: f1270f7 e3eb223
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri Sep 19 18:14:49 2014 +0200

    Merge branch 'mundo'

    Conflicts:
        hello.rb

diff --cc hello.rb
index 0399cd5,59727f0..e1d0799
--- a/hello.rb
+++ b/hello.rb
@@@ -1,7 -1,7 +1,7 @@@
  #! /usr/bin/env ruby

  def hello
-   puts 'hola world'
 -  puts 'hello mundo'
++  puts 'hola mundo'
  end

  hello()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_undoing_merges">Undoing Merges</h4>
<div class="paragraph">
<p>Now that you know how to create a merge commit, you&#8217;ll probably make some by mistake.
One of the great things about working with Git is that it&#8217;s okay to make mistakes, because it&#8217;s possible (and in many cases easy) to fix them.</p>
</div>
<div class="paragraph">
<p>Merge commits are no different.
Let&#8217;s say you started work on a topic branch, accidentally merged it into <code>master</code>, and now your commit history looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/undomerge-start.png" alt="Accidental merge commit.">
</div>
<div class="title">Figure 138. Accidental merge commit</div>
</div>
<div class="paragraph">
<p>There are two ways to approach this problem, depending on what your desired outcome is.</p>
</div>
<div class="sect4">
<h5 id="_fix_the_references">Fix the references</h5>
<div class="paragraph">
<p>If the unwanted merge commit only exists on your local repository, the easiest and best solution is to move the branches so that they point where you want them to.
In most cases, if you follow the errant <code>git merge</code> with <code>git reset --hard HEAD~</code>, this will reset the branch pointers so they look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/undomerge-reset.png" alt="History after `git reset --hard HEAD~`.">
</div>
<div class="title">Figure 139. History after <code>git reset --hard HEAD~</code></div>
</div>
<div class="paragraph">
<p>We covered <code>reset</code> back in <a href="#_git_reset">Reset Demystified</a>, so it shouldn&#8217;t be too hard to figure out what&#8217;s going on here.
Here&#8217;s a quick refresher: <code>reset --hard</code> usually goes through three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Move the branch HEAD points to.
In this case, we want to move <code>master</code> to where it was before the merge commit (<code>C6</code>).</p>
</li>
<li>
<p>Make the index look like HEAD.</p>
</li>
<li>
<p>Make the working directory look like the index.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The downside of this approach is that it&#8217;s rewriting history, which can be problematic with a shared repository.
Check out <a href="#_rebase_peril">衍合的风险</a> for more on what can happen; the short version is that if other people have the commits you&#8217;re rewriting, you should probably avoid <code>reset</code>.
This approach also won&#8217;t work if any other commits have been created since the merge; moving the refs would effectively lose those changes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_reverse_commit">Reverse the commit</h5>
<div class="paragraph">
<p>If moving the branch pointers around isn&#8217;t going to work for you, Git gives you the option of making a new commit which undoes all the changes from an existing one.
Git calls this operation a &#8220;revert&#8221;, and in this particular scenario, you&#8217;d invoke it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git revert -m 1 HEAD
[master b1d8379] Revert "Merge branch 'topic'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-m 1</code> flag indicates which parent is the &#8220;mainline&#8221; and should be kept.
When you invoke a merge into <code>HEAD</code> (<code>git merge topic</code>), the new commit has two parents: the first one is <code>HEAD</code> (<code>C6</code>), and the second is the tip of the branch being merged in (<code>C4</code>).
In this case, we want to undo all the changes introduced by merging in parent #2 (<code>C4</code>), while keeping all the content from parent #1 (<code>C6</code>).</p>
</div>
<div class="paragraph">
<p>The history with the revert commit looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/undomerge-revert.png" alt="History after `git revert -m 1`.">
</div>
<div class="title">Figure 140. History after <code>git revert -m 1</code></div>
</div>
<div class="paragraph">
<p>The new commit <code>^M</code> has exactly the same contents as <code>C6</code>, so starting from here it&#8217;s as if the merge never happened, except that the now-unmerged commits are still in <code>HEAD</code>'s history.
Git will get confused if you try to merge <code>topic</code> into <code>master</code> again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge topic
Already up-to-date.</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s nothing in <code>topic</code> that isn&#8217;t already reachable from <code>master</code>.
What&#8217;s worse, if you add work to <code>topic</code> and merge again, Git will only bring in the changes <em>since</em> the reverted merge:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/undomerge-revert2.png" alt="History with a bad merge.">
</div>
<div class="title">Figure 141. History with a bad merge</div>
</div>
<div class="paragraph">
<p>The best way around this is to un-revert the original merge, since now you want to bring in the changes that were reverted out, <strong>then</strong> create a new merge commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git revert ^M
[master 09f0126] Revert "Revert "Merge branch 'topic'""
$ git merge topic</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/undomerge-revert3.png" alt="History after re-merging a reverted merge.">
</div>
<div class="title">Figure 142. History after re-merging a reverted merge</div>
</div>
<div class="paragraph">
<p>In this example, <code>M</code> and <code>^M</code> cancel out.
<code>^^M</code> effectively merges in the changes from <code>C3</code> and <code>C4</code>, and <code>C8</code> merges in the changes from <code>C7</code>, so now <code>topic</code> is fully merged.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_types_of_merges">Other Types of Merges</h4>
<div class="paragraph">
<p>So far we&#8217;ve covered the normal merge of two branches, normally handled with what is called the &#8220;recursive&#8221; strategy of merging. There are other ways to merge branches together however. Let&#8217;s cover a few of them quickly.</p>
</div>
<div class="sect4">
<h5 id="_our_or_theirs_preference">Our or Theirs Preference</h5>
<div class="paragraph">
<p>First of all, there is another useful thing we can do with the normal &#8220;recursive&#8221; mode of merging. We&#8217;ve already seen the <code>ignore-all-space</code> and <code>ignore-space-change</code> options which are passed with a <code>-X</code> but we can also tell Git to favor one side or the other when it sees a conflict.</p>
</div>
<div class="paragraph">
<p>By default, when Git sees a conflict between two branches being merged, it will add merge conflict markers into your code and mark the file as conflicted and let you resolve it. If you would prefer for Git to simply choose a specific side and ignore the other side instead of letting you manually merge the conflict, you can pass the <code>merge</code> command either a <code>-Xours</code> or <code>-Xtheirs</code>.</p>
</div>
<div class="paragraph">
<p>If Git sees this, it will not add conflict markers. Any differences that are mergable, it will merge. Any differences that conflict, it will simply choose the side you specify in whole, including binary files.</p>
</div>
<div class="paragraph">
<p>If we go back to the &#8220;hello world&#8221; example we were using before, we can see that merging in our branch causes conflicts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge mundo
Auto-merging hello.rb
CONFLICT (content): Merge conflict in hello.rb
Resolved 'hello.rb' using previous resolution.
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>However if we run it with <code>-Xours</code> or <code>-Xtheirs</code> it does not.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge -Xours mundo
Auto-merging hello.rb
Merge made by the 'recursive' strategy.
 hello.rb | 2 +-
 test.sh  | 2 ++
 2 files changed, 3 insertions(+), 1 deletion(-)
 create mode 100644 test.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, instead of getting conflict markers in the file with &#8220;hello mundo&#8221; on one side and &#8220;hola world&#8221; on the other, it will simply pick &#8220;hola world&#8221;. However, all the other non-conflicting changes on that branch are merged successfully in.</p>
</div>
<div class="paragraph">
<p>This option can also be passed to the <code>git merge-file</code> command we saw earlier by running something like <code>git merge-file --ours</code> for individual file merges.</p>
</div>
<div class="paragraph">
<p>If you want to do something like this but not have Git even try to merge changes from the other side in, there is a more draconian option, which is the &#8220;ours&#8221; merge <em>strategy</em>. This is different from the &#8220;ours&#8221; recursive merge <em>option</em>.</p>
</div>
<div class="paragraph">
<p>This will basically do a fake merge. It will record a new merge commit with both branches as parents, but it will not even look at the branch you&#8217;re merging in. It will simply record as the result of the merge the exact code in your current branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge -s ours mundo
Merge made by the 'ours' strategy.
$ git diff HEAD HEAD~
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that there is no difference between the branch we were on and the result of the merge.</p>
</div>
<div class="paragraph">
<p>This can often be useful to basically trick Git into thinking that a branch is already merged when doing a merge later on. For example, say you branched off a &#8220;release&#8221; branch and have done some work on it that you will want to merge back into your &#8220;master&#8221; branch at some point. In the meantime some bugfix on &#8220;master&#8221; needs to be backported into your <code>release</code> branch. You can merge the bugfix branch into the <code>release</code> branch and also <code>merge -s ours</code> the same branch into your <code>master</code> branch (even though the fix is already there) so when you later merge the <code>release</code> branch again, there are no conflicts from the bugfix.</p>
</div>
</div>
<div class="sect4">
<h5 id="_subtree_merge">子树合并</h5>
<div class="paragraph">
<p>子树合并的思想是您有两个项目，并且其中一个映射到另一个项目的一个子目录，或者反过来也行。
当您执行一个子树合并时，Git 通常可以自动计算出其中一个是另外一个的子树从而实现正确的合并。</p>
</div>
<div class="paragraph">
<p>我们来看一个例子如何将一个项目加入到一个已存在的项目中，然后将第二个项目的代码合并到第一个项目的子目录中。</p>
</div>
<div class="paragraph">
<p>首先，我们将 Rack 应用添加到您的项目里。
我们把 Rack 项目作为一个远程的引用添加到我们的项目里，然后检出到它自己的分支。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add rack_remote https://github.com/rack/rack
$ git fetch rack_remote
warning: no common commits
remote: Counting objects: 3184, done.
remote: Compressing objects: 100% (1465/1465), done.
remote: Total 3184 (delta 1952), reused 2770 (delta 1675)
Receiving objects: 100% (3184/3184), 677.42 KiB | 4 KiB/s, done.
Resolving deltas: 100% (1952/1952), done.
From https://github.com/rack/rack
 * [new branch]      build      -&gt; rack_remote/build
 * [new branch]      master     -&gt; rack_remote/master
 * [new branch]      rack-0.4   -&gt; rack_remote/rack-0.4
 * [new branch]      rack-0.9   -&gt; rack_remote/rack-0.9
$ git checkout -b rack_branch rack_remote/master
Branch rack_branch set up to track remote branch refs/remotes/rack_remote/master.
Switched to a new branch "rack_branch"</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在在我们的 <code>rack_branch</code> 分支里就有 Rack 项目的根目录，而我们的项目则在 <code>master</code> 分支里。
如果您从一个分支切换到另一个分支，您可以看到它们的项目根目录是不同的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ls
AUTHORS         KNOWN-ISSUES   Rakefile      contrib         lib
COPYING         README         bin           example         test
$ git checkout master
Switched to branch "master"
$ ls
README</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个是一个比较奇怪的概念。并不是仓库中的所有分支都是必须属于同一个项目的分支，这并不常见，因为没啥用，但是却是在不同分支里包含两条完全不同提交历史的最简单的方法。</p>
</div>
<div class="paragraph">
<p>在这个例子中，我们希望将 Rack 项目拉到 <code>master</code> 项目中作为一个子目录。
我们可以在 Git 中执行 <code>git read-tree</code> 来实现。
您可以在 <a href="#_git_internals">Git Internals</a> 中查看更多 <code>read-tree</code> 的相关信息，现在您只需要知道它会读取一个分支的根目录树到当前的暂存区和工作目录里。
先切回您的 <code>master</code> 分支，将 <code>rack</code> 分支拉取到我们项目的 <code>master</code> 分支中的 <code>rack</code> 子目录。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git read-tree --prefix=rack/ -u rack_branch</code></pre>
</div>
</div>
<div class="paragraph">
<p>当我们提交时，那个子目录中拥有所有 Rack 项目的文件 —— 就像我们直接从压缩包里复制出来的一样。
有趣的是您可以很容易地将一个分支的变更合并到另一个分支里。
所以，当 Rack 项目有更新时，我们可以切换到那个分支来拉取上游的变更。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout rack_branch
$ git pull</code></pre>
</div>
</div>
<div class="paragraph">
<p>接着，我们可以将这些变更合并回我们的 <code>master</code> 分支。
使用 <code>git merge -s subtree</code> 不会有问题；但是 Git 也会将历史记录合并起来，这可能不是我们想要的。
在 <code>-s subtree</code> 选项后面加上 <code>--squash</code> 和 <code>--no-commit</code> 选项就可以拉取变更并且预填充提交信息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
$ git merge --squash -s subtree --no-commit rack_branch
Squash commit -- not updating HEAD
Automatic merge went well; stopped before committing as requested</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the changes from the Rack project are merged in and ready to be committed locally.
You can also do the opposite – make changes in the <code>rack</code> subdirectory of your master branch and then merge them into your <code>rack_branch</code> branch later to submit them to the maintainers or push them upstream.</p>
</div>
<div class="paragraph">
<p>This gives us a way to have a workflow somewhat similar to the submodule workflow without using submodules (which we will cover in <a href="#_git_submodules">Submodules</a>). We can keep branches with other related projects in our repository and subtree merge them into our project occasionally. It is nice in some ways, for example all the code is committed to a single place. However, it has other drawbacks in that it&#8217;s a bit more complex and easier to make mistakes in reintegrating changes or accidentally pushing a branch into an unrelated repository.</p>
</div>
<div class="paragraph">
<p>Another slightly weird thing is that to get a diff between what you have in your <code>rack</code> subdirectory and the code in your <code>rack_branch</code> branch – to see if you need to merge them – you can’t use the normal <code>diff</code> command.
Instead, you must run <code>git diff-tree</code> with the branch you want to compare to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff-tree -p rack_branch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, to compare what is in your <code>rack</code> subdirectory with what the <code>master</code> branch on the server was the last time you fetched, you can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff-tree -p rack_remote/master</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rerere">Rerere</h3>
<div class="paragraph">
<p>The <code>git rerere</code> functionality is a bit of a hidden feature.  The name stands for &#8220;reuse recorded resolution&#8221; and as the name implies, it allows you to ask Git to remember how you&#8217;ve resolved a hunk conflict so that the next time it sees the same conflict, Git can automatically resolve it for you.</p>
</div>
<div class="paragraph">
<p>There are a number of scenarios in which this functionality might be really handy. One of the examples that is mentioned in the documentation is if you want to make sure a long lived topic branch will merge cleanly but don&#8217;t want to have a bunch of intermediate merge commits. With <code>rerere</code> turned on you can merge occasionally, resolve the conflicts, then back out the merge. If you do this continuously, then the final merge should be easy because <code>rerere</code> can just do everything for you automatically.</p>
</div>
<div class="paragraph">
<p>This same tactic can be used if you want to keep a branch rebased so you don&#8217;t have to deal with the same rebasing conflicts each time you do it.  Or if you want to take a branch that you merged and fixed a bunch of conflicts and then decide to rebase it instead - you likely won&#8217;t have to do all the same conflicts again.</p>
</div>
<div class="paragraph">
<p>Another situation is where you merge a bunch of evolving topic branches together into a testable head occasionally, as the Git project itself often does. If the tests fail, you can rewind the merges and re-do them without the topic branch that made the tests fail without having to re-resolve the conflicts again.</p>
</div>
<div class="paragraph">
<p>To enable the <code>rerere</code> functionality, you simply have to run this config setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global rerere.enabled true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also turn it on by creating the <code>.git/rr-cache</code> directory in a specific repository, but the config setting is clearer and it can be done globally.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s see a simple example, similar to our previous one. Let&#8217;s say we have a file that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">#! /usr/bin/env ruby

def hello
  puts 'hello world'
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In one branch we change the word &#8220;hello&#8221; to &#8220;hola&#8221;, then in another branch we change the &#8220;world&#8221; to &#8220;mundo&#8221;, just like before.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rerere1.png" alt="rerere1">
</div>
</div>
<div class="paragraph">
<p>When we merge the two branches together, we&#8217;ll get a merge conflict:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge i18n-world
Auto-merging hello.rb
CONFLICT (content): Merge conflict in hello.rb
Recorded preimage for 'hello.rb'
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should notice the new line <code>Recorded preimage for FILE</code> in there. Otherwise it should look exactly like a normal merge conflict. At this point, <code>rerere</code> can tell us a few things. Normally, you might run <code>git status</code> at this point to see what all conflicted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
# On branch master
# Unmerged paths:
#   (use "git reset HEAD &lt;file&gt;..." to unstage)
#   (use "git add &lt;file&gt;..." to mark resolution)
#
#	both modified:      hello.rb
#</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, <code>git rerere</code> will also tell you what it has recorded the pre-merge state for with <code>git rerere status</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rerere status
hello.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>And <code>git rerere diff</code> will show the current state of the resolution - what you started with to resolve and what you&#8217;ve resolved it to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rerere diff
--- a/hello.rb
+++ b/hello.rb
@@ -1,11 +1,11 @@
 #! /usr/bin/env ruby

 def hello
-&lt;&lt;&lt;&lt;&lt;&lt;&lt;
-  puts 'hello mundo'
-=======
+&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
   puts 'hola world'
-&gt;&gt;&gt;&gt;&gt;&gt;&gt;
+=======
+  puts 'hello mundo'
+&gt;&gt;&gt;&gt;&gt;&gt;&gt; i18n-world
 end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also (and this isn&#8217;t really related to <code>rerere</code>), you can use <code>ls-files -u</code> to see the conflicted files and the before, left and right versions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git ls-files -u
100644 39804c942a9c1f2c03dc7c5ebcd7f3e3a6b97519 1	hello.rb
100644 a440db6e8d1fd76ad438a49025a9ad9ce746f581 2	hello.rb
100644 54336ba847c3758ab604876419607e9443848474 3	hello.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can resolve it to just be <code>puts 'hola mundo'</code> and you can run the <code>rerere diff</code> command again to see what rerere will remember:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rerere diff
--- a/hello.rb
+++ b/hello.rb
@@ -1,11 +1,7 @@
 #! /usr/bin/env ruby

 def hello
-&lt;&lt;&lt;&lt;&lt;&lt;&lt;
-  puts 'hello mundo'
-=======
-  puts 'hola world'
-&gt;&gt;&gt;&gt;&gt;&gt;&gt;
+  puts 'hola mundo'
 end</code></pre>
</div>
</div>
<div class="paragraph">
<p>So that basically says, when Git sees a hunk conflict in a <code>hello.rb</code> file that has &#8220;hello mundo&#8221; on one side and &#8220;hola world&#8221; on the other, it will resolve it to &#8220;hola mundo&#8221;.</p>
</div>
<div class="paragraph">
<p>Now we can mark it as resolved and commit it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add hello.rb
$ git commit
Recorded resolution for 'hello.rb'.
[master 68e16e5] Merge branch 'i18n'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that it "Recorded resolution for FILE".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rerere2.png" alt="rerere2">
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s undo that merge and then rebase it on top of our master branch instead. We can move our branch back by using <code>reset</code> as we saw in <a href="#_git_reset">Reset Demystified</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git reset --hard HEAD^
HEAD is now at ad63f15 i18n the hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our merge is undone. Now let&#8217;s rebase the topic branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout i18n-world
Switched to branch 'i18n-world'

$ git rebase master
First, rewinding head to replay your work on top of it...
Applying: i18n one word
Using index info to reconstruct a base tree...
Falling back to patching base and 3-way merge...
Auto-merging hello.rb
CONFLICT (content): Merge conflict in hello.rb
Resolved 'hello.rb' using previous resolution.
Failed to merge in the changes.
Patch failed at 0001 i18n one word</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we got the same merge conflict like we expected, but take a look at the <code>Resolved FILE using previous resolution</code> line. If we look at the file, we&#8217;ll see that it&#8217;s already been resolved, there are no merge conflict markers in it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat hello.rb
#! /usr/bin/env ruby

def hello
  puts 'hola mundo'
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, <code>git diff</code> will show you how it was automatically re-resolved:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --cc hello.rb
index a440db6,54336ba..0000000
--- a/hello.rb
+++ b/hello.rb
@@@ -1,7 -1,7 +1,7 @@@
  #! /usr/bin/env ruby

  def hello
-   puts 'hola world'
 -  puts 'hello mundo'
++  puts 'hola mundo'
  end</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/rerere3.png" alt="rerere3">
</div>
</div>
<div class="paragraph">
<p>You can also recreate the conflicted file state with the <code>checkout</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout --conflict=merge hello.rb
$ cat hello.rb
#! /usr/bin/env ruby

def hello
&lt;&lt;&lt;&lt;&lt;&lt;&lt; ours
  puts 'hola world'
=======
  puts 'hello mundo'
&gt;&gt;&gt;&gt;&gt;&gt;&gt; theirs
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>We saw an example of this in <a href="#_advanced_merging">Advanced Merging</a>.
For now though, let&#8217;s re-resolve it by just running <code>rerere</code> again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rerere
Resolved 'hello.rb' using previous resolution.
$ cat hello.rb
#! /usr/bin/env ruby

def hello
  puts 'hola mundo'
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have re-resolved the file automatically using the <code>rerere</code> cached resolution. You can now add and continue the rebase to complete it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add hello.rb
$ git rebase --continue
Applying: i18n one word</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, if you do a lot of re-merges, or want to keep a topic branch up to date with your master branch without a ton of merges, or you rebase often, you can turn on <code>rerere</code> to help your life out a bit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用_git_调试">使用 Git 调试</h3>
<div class="paragraph">
<p>Git 也提供了两个工具来辅助您调试项目中的问题。
由于 Git 被设计成适用于几乎所有类型的项目，这些工具是比较通用的，但它们可以在出现问题的时候帮助您找到 bug 或者错误。</p>
</div>
<div class="sect3">
<h4 id="_file_annotation">文件标注</h4>
<div class="paragraph">
<p>如果您在追踪代码中的一个 bug，并且想知道是什么时候以及为何会引入，文件标注通常是最好用的工具。
它展示了文件中每一行最后一次修改的提交。
所以，如果您在代码中看到一个有问题的方法，您可以使用 <code>git blame</code> 标注这个文件，查看这个方法每一行的最后修改时间以及是被谁修改的。
这个例子使用 <code>-L</code> 选项来限制输出范围在第12至22行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git blame -L 12,22 simplegit.rb
^4832fe2 (Scott Chacon  2008-03-15 10:31:28 -0700 12)  def show(tree = 'master')
^4832fe2 (Scott Chacon  2008-03-15 10:31:28 -0700 13)   command("git show #{tree}")
^4832fe2 (Scott Chacon  2008-03-15 10:31:28 -0700 14)  end
^4832fe2 (Scott Chacon  2008-03-15 10:31:28 -0700 15)
9f6560e4 (Scott Chacon  2008-03-17 21:52:20 -0700 16)  def log(tree = 'master')
79eaf55d (Scott Chacon  2008-04-06 10:15:08 -0700 17)   command("git log #{tree}")
9f6560e4 (Scott Chacon  2008-03-17 21:52:20 -0700 18)  end
9f6560e4 (Scott Chacon  2008-03-17 21:52:20 -0700 19)
42cf2861 (Magnus Chacon 2008-04-13 10:45:01 -0700 20)  def blame(path)
42cf2861 (Magnus Chacon 2008-04-13 10:45:01 -0700 21)   command("git blame #{path}")
42cf2861 (Magnus Chacon 2008-04-13 10:45:01 -0700 22)  end</code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意，第一个字段是最后一次修改该行的提交的部分 SHA-1 值。
接下来两个字段的值是从提交中提取出来的——作者的名字以及提交的时间——所以您就可以很轻易地找到是谁在什么时候修改了那一行。
接下来就是行号和文件内容。
注意一下 <code>^4832fe2</code> 这个提交的那些行，这些指的是这个文件第一次提交的那些行。
这个提交是这个文件第一次加入到这个项目时的提交，并且这些行从未被修改过。
这会带来小小的困惑，因为您已经至少看到三种 Git 使用 <code>^</code> 来修饰一个提交的 SHA 值的不同含义，但这里确实就是这个意思。</p>
</div>
<div class="paragraph">
<p>另一件比较酷的事情是 Git 不会显式地记录文件的重命名。
它会记录快照，然后在事后尝试计算出重命名的动作。
这其中有一个很有意思的特性就是您可以让 Git 找出所有的代码移动。
如果您在 <code>git blame</code> 后面加上一个 <code>-C</code>，Git 会分析您正在标注的文件，并且尝试找出文件中从别的地方复制过来的代码片段的原始出处。
比如，您将 <code>GITServerHandler.m</code> 这个文件拆分为数个文件，其中一个文件是 <code>GITPackUpload.m</code>。
对 <code>GITPackUpload.m</code> 执行带 <code>-C</code> 参数的blame命令，您就可以看到代码块的原始出处：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git blame -C -L 141,153 GITPackUpload.m
f344f58d GITServerHandler.m (Scott 2009-01-04 141)
f344f58d GITServerHandler.m (Scott 2009-01-04 142) - (void) gatherObjectShasFromC
f344f58d GITServerHandler.m (Scott 2009-01-04 143) {
70befddd GITServerHandler.m (Scott 2009-03-22 144)         //NSLog(@"GATHER COMMI
ad11ac80 GITPackUpload.m    (Scott 2009-03-24 145)
ad11ac80 GITPackUpload.m    (Scott 2009-03-24 146)         NSString *parentSha;
ad11ac80 GITPackUpload.m    (Scott 2009-03-24 147)         GITCommit *commit = [g
ad11ac80 GITPackUpload.m    (Scott 2009-03-24 148)
ad11ac80 GITPackUpload.m    (Scott 2009-03-24 149)         //NSLog(@"GATHER COMMI
ad11ac80 GITPackUpload.m    (Scott 2009-03-24 150)
56ef2caf GITServerHandler.m (Scott 2009-01-05 151)         if(commit) {
56ef2caf GITServerHandler.m (Scott 2009-01-05 152)                 [refDict setOb
56ef2caf GITServerHandler.m (Scott 2009-01-05 153)</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个功能很有用。
通常来说，您会认为复制代码过来的那个提交是最原始的提交，因为那是您第一次在这个文件中修改了这几行。
但 Git 会告诉您，您第一次写这几行代码的那个提交才是原始提交，即使这是在另外一个文件里写的。</p>
</div>
</div>
<div class="sect3">
<h4 id="_binary_search">二分查找</h4>
<div class="paragraph">
<p>当您知道问题是在哪里引入的情况下文件标注可以帮助您查找问题。
如果您不知道哪里出了问题，并且自从上次可以正常运行到现在已经有数十个或者上百个提交，这个时候您可以使用 <code>git bisect</code> 来帮助查找。
<code>bisect</code> 命令会对您的提交历史进行二分查找来帮助您尽快找到是哪一个提交引入了问题。</p>
</div>
<div class="paragraph">
<p>假设您刚刚在线上环境部署了您的代码，接着收到一些 bug 反馈，但这些 bug 在您之前的开发环境里没有出现过，这让您百思不得其解。
您重新查看了您的代码，发现这个问题是可以被重现的，但是您不知道哪里出了问题。
您可以用二分法来找到这个问题。
首先执行 <code>git bisect start</code> 来启动，接着执行 <code>git bisect bad</code> 来告诉系统当前你所在的提交是有问题的。
然后您必须告诉 bisect 已知的最后一次正常状态是哪次提交，使用 <code>git bisect good [good_commit]</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bisect start
$ git bisect bad
$ git bisect good v1.0
Bisecting: 6 revisions left to test after this
[ecb6e1bc347ccecc5f9350d878ce677feb13d3b2] error handling on repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git 发现在您标记为正常的提交(v1.0)和当前的错误版本之间有大约12次提交，于是 Git 检出中间的那个提交。
现在您可以执行测试，看看在这个提交下问题是不是还是存在。
如果还存在，说明问题是在这个提交之前引入的；如果问题不存在，说明问题是在这个提交之后引入的。
假设测试结果是没有问题的，您可以通过 <code>git bisect good</code> 来告诉 Git，然后继续寻找。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bisect good
Bisecting: 3 revisions left to test after this
[b047b02ea83310a70fd603dc8cd7a6cd13d15c04] secure this thing</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在您在另一个提交上了，这个提交是刚刚那个测试通过的提交和有问题的提交的中点。
您再一次执行测试，发现这个提交下是有问题的，因此您可以通过 <code>git bisect bad</code> 告诉 Git：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bisect bad
Bisecting: 1 revisions left to test after this
[f71ce38690acf49c1f3c9bea38e09d82a5ce6014] drop exceptions table</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个提交是正常的，现在 Git 拥有的信息已经可以确定引入问题的位置在哪里。
它会告诉您第一个错误提交的 SHA-1 值并显示一些提交说明，以及哪些文件在那次提交里修改过，这样您可以找出引入 bug 的根源：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bisect good
b047b02ea83310a70fd603dc8cd7a6cd13d15c04 is first bad commit
commit b047b02ea83310a70fd603dc8cd7a6cd13d15c04
Author: PJ Hyett &lt;pjhyett@example.com&gt;
Date:   Tue Jan 27 14:48:32 2009 -0800

    secure this thing

:040000 040000 40ee3e7821b895e52c1695092db9bdc4c61d1730
f24d3c6ebcfc639b1a3814550e62d60b8e68a8e4 M  config</code></pre>
</div>
</div>
<div class="paragraph">
<p>当您完成这些操作之后，您应该执行 <code>git bisect reset</code> 重置您的 HEAD 指针到最开始的位置，否则您会停留在一个很奇怪的状态：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bisect reset</code></pre>
</div>
</div>
<div class="paragraph">
<p>这是一个可以帮助您在几分钟内从数百个提交中找到 bug 的强大工具。
事实上，如果您有一个脚本在项目是正常的情况下返回 0，在不正常的情况下返回非 0，您可以使 <code>git bisect</code> 自动化这些操作。
首先，您设定好项目正常以及不正常所在提交的二分查找范围。
您可以通过 <code>bisect start</code> 命令的参数来设定这两个提交，第一个参数是项目不正常的提交，第二个参数是项目正常的提交：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bisect start HEAD v1.0
$ git bisect run test-error.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git 会自动在每个被检出的提交里执行 <code>test-error.sh</code> 直到找到第一个项目不正常的提交。
您也可以执行 <code>make</code> 或者 <code>make tests</code> 或者其他东西来进行自动化测试。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_submodules">Submodules</h3>
<div class="paragraph">
<p>It often happens that while working on one project, you need to use another project from within it.
Perhaps it’s a library that a third party developed or that you’re developing separately and using in multiple parent projects.
A common issue arises in these scenarios: you want to be able to treat the two projects as separate yet still be able to use one from within the other.</p>
</div>
<div class="paragraph">
<p>Here’s an example.
Suppose you’re developing a web site and creating Atom feeds.
Instead of writing your own Atom-generating code, you decide to use a library.
You’re likely to have to either include this code from a shared library like a CPAN install or Ruby gem, or copy the source code into your own project tree.
The issue with including the library is that it’s difficult to customize the library in any way and often more difficult to deploy it, because you need to make sure every client has that library available.
The issue with vendoring the code into your own project is that any custom changes you make are difficult to merge when upstream changes become available.</p>
</div>
<div class="paragraph">
<p>Git addresses this issue using submodules.
Submodules allow you to keep a Git repository as a subdirectory of another Git repository.
This lets you clone another repository into your project and keep your commits separate.</p>
</div>
<div class="sect3">
<h4 id="_starting_submodules">Starting with Submodules</h4>
<div class="paragraph">
<p>We&#8217;ll walk through developing a simple project that has been split up into a main project and a few sub-projects.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by adding an existing Git repository as a submodule of the repository that we&#8217;re working on. To add a new submodule you use the <code>git submodule add</code> command with the URL of the project you would like to start tracking. In this example, we&#8217;ll add a library called &#8220;DbConnector&#8221;.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule add https://github.com/chaconinc/DbConnector
Cloning into 'DbConnector'...
remote: Counting objects: 11, done.
remote: Compressing objects: 100% (10/10), done.
remote: Total 11 (delta 0), reused 11 (delta 0)
Unpacking objects: 100% (11/11), done.
Checking connectivity... done.</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, submodules will add the subproject into a directory named the same as the repository, in this case &#8220;DbConnector&#8221;. You can add a different path at the end of the command if you want it to go elsewhere.</p>
</div>
<div class="paragraph">
<p>If you run <code>git status</code> at this point, you&#8217;ll notice a few things.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
Your branch is up-to-date with 'origin/master'.

Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

	new file:   .gitmodules
	new file:   DbConnector</code></pre>
</div>
</div>
<div class="paragraph">
<p>First you should notice the new <code>.gitmodules</code> file.
This is a configuration file that stores the mapping between the project’s URL and the local subdirectory you’ve pulled it into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .gitmodules
[submodule "DbConnector"]
	path = DbConnector
	url = https://github.com/chaconinc/DbConnector</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have multiple submodules, you’ll have multiple entries in this file.
It’s important to note that this file is version-controlled with your other files, like your <code>.gitignore</code> file.
It’s pushed and pulled with the rest of your project.
This is how other people who clone this project know where to get the submodule projects from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Since the URL in the .gitmodules file is what other people will first try to clone/fetch from, make sure to use a URL that they can access if possible. For example, if you use a different URL to push to than others would to pull from, use the one that others have access to. You can overwrite this value locally with <code>git config submodule.DbConnector.url PRIVATE_URL</code> for your own use.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other listing in the <code>git status</code> output is the project folder entry.
If you run <code>git diff</code> on that, you see something interesting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --cached DbConnector
diff --git a/DbConnector b/DbConnector
new file mode 160000
index 0000000..c3f01dc
--- /dev/null
+++ b/DbConnector
@@ -0,0 +1 @@
+Subproject commit c3f01dc8862123d317dd46284b05b6892c7b29bc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although <code>DbConnector</code> is a subdirectory in your working directory, Git sees it as a submodule and doesn’t track its contents when you’re not in that directory.
Instead, Git sees it as a particular commit from that repository.</p>
</div>
<div class="paragraph">
<p>If you want a little nicer diff output, you can pass the <code>--submodule</code> option to <code>git diff</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff --cached --submodule
diff --git a/.gitmodules b/.gitmodules
new file mode 100644
index 0000000..71fc376
--- /dev/null
+++ b/.gitmodules
@@ -0,0 +1,3 @@
+[submodule "DbConnector"]
+       path = DbConnector
+       url = https://github.com/chaconinc/DbConnector
Submodule DbConnector 0000000...c3f01dc (new submodule)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you commit, you see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -am 'added DbConnector module'
[master fb9093c] added DbConnector module
 2 files changed, 4 insertions(+)
 create mode 100644 .gitmodules
 create mode 160000 DbConnector</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>160000</code> mode for the rack entry.
That is a special mode in Git that basically means you’re recording a commit as a directory entry rather than a subdirectory or a file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cloning_submodules">Cloning a Project with Submodules</h4>
<div class="paragraph">
<p>Here we’ll clone a project with a submodule in it.
When you clone such a project, by default you get the directories that contain submodules, but none of the files within them yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://github.com/chaconinc/MainProject
Cloning into 'MainProject'...
remote: Counting objects: 14, done.
remote: Compressing objects: 100% (13/13), done.
remote: Total 14 (delta 1), reused 13 (delta 0)
Unpacking objects: 100% (14/14), done.
Checking connectivity... done.
$ cd MainProject
$ ls -la
total 16
drwxr-xr-x   9 schacon  staff  306 Sep 17 15:21 .
drwxr-xr-x   7 schacon  staff  238 Sep 17 15:21 ..
drwxr-xr-x  13 schacon  staff  442 Sep 17 15:21 .git
-rw-r--r--   1 schacon  staff   92 Sep 17 15:21 .gitmodules
drwxr-xr-x   2 schacon  staff   68 Sep 17 15:21 DbConnector
-rw-r--r--   1 schacon  staff  756 Sep 17 15:21 Makefile
drwxr-xr-x   3 schacon  staff  102 Sep 17 15:21 includes
drwxr-xr-x   4 schacon  staff  136 Sep 17 15:21 scripts
drwxr-xr-x   4 schacon  staff  136 Sep 17 15:21 src
$ cd DbConnector/
$ ls
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DbConnector</code> directory is there, but empty.
You must run two commands: <code>git submodule init</code> to initialize your local configuration file, and <code>git submodule update</code> to fetch all the data from that project and check out the appropriate commit listed in your superproject:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule init
Submodule 'DbConnector' (https://github.com/chaconinc/DbConnector) registered for path 'DbConnector'
$ git submodule update
Cloning into 'DbConnector'...
remote: Counting objects: 11, done.
remote: Compressing objects: 100% (10/10), done.
remote: Total 11 (delta 0), reused 11 (delta 0)
Unpacking objects: 100% (11/11), done.
Checking connectivity... done.
Submodule path 'DbConnector': checked out 'c3f01dc8862123d317dd46284b05b6892c7b29bc'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now your <code>DbConnector</code> subdirectory is at the exact state it was in when you committed earlier.</p>
</div>
<div class="paragraph">
<p>There is another way to do this which is a little simpler, however. If you pass <code>--recursive</code> to the <code>git clone</code> command, it will automatically initialize and update each submodule in the repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone --recursive https://github.com/chaconinc/MainProject
Cloning into 'MainProject'...
remote: Counting objects: 14, done.
remote: Compressing objects: 100% (13/13), done.
remote: Total 14 (delta 1), reused 13 (delta 0)
Unpacking objects: 100% (14/14), done.
Checking connectivity... done.
Submodule 'DbConnector' (https://github.com/chaconinc/DbConnector) registered for path 'DbConnector'
Cloning into 'DbConnector'...
remote: Counting objects: 11, done.
remote: Compressing objects: 100% (10/10), done.
remote: Total 11 (delta 0), reused 11 (delta 0)
Unpacking objects: 100% (11/11), done.
Checking connectivity... done.
Submodule path 'DbConnector': checked out 'c3f01dc8862123d317dd46284b05b6892c7b29bc'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_working_on_a_project_with_submodules">Working on a Project with Submodules</h4>
<div class="paragraph">
<p>Now we have a copy of a project with submodules in it and will collaborate with our teammates on both the main project and the submodule project.</p>
</div>
<div class="sect4">
<h5 id="_pulling_in_upstream_changes">Pulling in Upstream Changes</h5>
<div class="paragraph">
<p>The simplest model of using submodules in a project would be if you were simply consuming a subproject and wanted to get updates from it from time to time but were not actually modifying anything in your checkout. Let&#8217;s walk though a simple example there.</p>
</div>
<div class="paragraph">
<p>If you want to check for new work in a submodule, you can go into the directory and run <code>git fetch</code> and <code>git merge</code> the upstream branch to update the local code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch
From https://github.com/chaconinc/DbConnector
   c3f01dc..d0354fc  master     -&gt; origin/master
Scotts-MacBook-Pro-3:DbConnector schacon$ git merge origin/master
Updating c3f01dc..d0354fc
Fast-forward
 scripts/connect.sh | 1 +
 src/db.c           | 1 +
 2 files changed, 2 insertions(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you go back into the main project and run <code>git diff --submodule</code> you can see that the submodule was updated and get a list of commits that were added to it. If you don&#8217;t want to type <code>--submodule</code> every time you run <code>git diff</code>, you can set it as the default format by setting the <code>diff.submodule</code> config value to &#8220;log&#8221;.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global diff.submodule log
$ git diff
Submodule DbConnector c3f01dc..d0354fc:
  &gt; more efficient db routine
  &gt; better connection routine</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you commit at this point then you will lock the submodule into having the new code when other people update.</p>
</div>
<div class="paragraph">
<p>There is an easier way to do this as well, if you prefer to not manually fetch and merge in the subdirectory. If you run <code>git submodule update --remote</code>, Git will go into your submodules and fetch and update for you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule update --remote DbConnector
remote: Counting objects: 4, done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 4 (delta 2), reused 4 (delta 2)
Unpacking objects: 100% (4/4), done.
From https://github.com/chaconinc/DbConnector
   3f19983..d0354fc  master     -&gt; origin/master
Submodule path 'DbConnector': checked out 'd0354fc054692d3906c85c3af05ddce39a1c0644'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will by default assume that you want to update the checkout to the <code>master</code> branch of the submodule repository. You can, however, set this to something different if you want. For example, if you want to have the DbConnector submodule track that repository&#8217;s &#8220;stable&#8221; branch, you can set it in either your <code>.gitmodules</code> file (so everyone else also tracks it), or just in your local <code>.git/config</code> file.  Let&#8217;s set it in the <code>.gitmodules</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config -f .gitmodules submodule.DbConnector.branch stable

$ git submodule update --remote
remote: Counting objects: 4, done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 4 (delta 2), reused 4 (delta 2)
Unpacking objects: 100% (4/4), done.
From https://github.com/chaconinc/DbConnector
   27cf5d3..c87d55d  stable -&gt; origin/stable
Submodule path 'DbConnector': checked out 'c87d55d4c6d4b05ee34fbc8cb6f7bf4585ae6687'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you leave off the <code>-f .gitmodules</code> it will only make the change for you, but it probably makes more sense to track that information with the repository so everyone else does as well.</p>
</div>
<div class="paragraph">
<p>When we run <code>git status</code> at this point, Git will show us that we have &#8220;new commits&#8221; on the submodule.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git status
On branch master
Your branch is up-to-date with 'origin/master'.

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

  modified:   .gitmodules
  modified:   DbConnector (new commits)

no changes added to commit (use "git add" and/or "git commit -a")</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you set the configuration setting <code>status.submodulesummary</code>, Git will also show you a short summary of changes to your submodules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config status.submodulesummary 1

$ git status
On branch master
Your branch is up-to-date with 'origin/master'.

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

	modified:   .gitmodules
	modified:   DbConnector (new commits)

Submodules changed but not updated:

* DbConnector c3f01dc...c87d55d (4):
  &gt; catch non-null terminated lines</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point if you run <code>git diff</code> we can see both that we have modified our <code>.gitmodules</code> file and also that there are a number of commits that we&#8217;ve pulled down and are ready to commit to our submodule project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --git a/.gitmodules b/.gitmodules
index 6fc0b3d..fd1cc29 100644
--- a/.gitmodules
+++ b/.gitmodules
@@ -1,3 +1,4 @@
 [submodule "DbConnector"]
        path = DbConnector
        url = https://github.com/chaconinc/DbConnector
+       branch = stable
 Submodule DbConnector c3f01dc..c87d55d:
  &gt; catch non-null terminated lines
  &gt; more robust error handling
  &gt; more efficient db routine
  &gt; better connection routine</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is pretty cool as we can actually see the log of commits that we&#8217;re about to commit to in our submodule. Once committed, you can see this information after the fact as well when you run <code>git log -p</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -p --submodule
commit 0a24cfc121a8a3c118e0105ae4ae4c00281cf7ae
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Wed Sep 17 16:37:02 2014 +0200

    updating DbConnector for bug fixes

diff --git a/.gitmodules b/.gitmodules
index 6fc0b3d..fd1cc29 100644
--- a/.gitmodules
+++ b/.gitmodules
@@ -1,3 +1,4 @@
 [submodule "DbConnector"]
        path = DbConnector
        url = https://github.com/chaconinc/DbConnector
+       branch = stable
Submodule DbConnector c3f01dc..c87d55d:
  &gt; catch non-null terminated lines
  &gt; more robust error handling
  &gt; more efficient db routine
  &gt; better connection routine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git will by default try to update <strong>all</strong> of your submodules when you run <code>git submodule update --remote</code> so if you have a lot of them, you may want to pass the name of just the submodule you want to try to update.</p>
</div>
</div>
<div class="sect4">
<h5 id="_working_on_a_submodule">Working on a Submodule</h5>
<div class="paragraph">
<p>It&#8217;s quite likely that if you&#8217;re using submodules, you&#8217;re doing so because you really want to work on the code in the submodule at the same time as you&#8217;re working on the code in the main project (or across several submodules). Otherwise you would probably instead be using a simpler dependency managment system (such as Maven or Rubygems).</p>
</div>
<div class="paragraph">
<p>So now let&#8217;s go through an example of making changes to the submodule at the same time as the main project and committing and publishing those changes at the same time.</p>
</div>
<div class="paragraph">
<p>So far, when we&#8217;ve run the <code>git submodule update</code> command to fetch changes from the submodule repositories, Git would get the changes and update the files in the subdirectory but will leave the sub-repository in what&#8217;s called a &#8220;detached HEAD&#8221; state. This means that there is no local working branch (like &#8220;master&#8221;, for example) tracking changes. So any changes you make aren&#8217;t being tracked well.</p>
</div>
<div class="paragraph">
<p>In order to set up your submodule to be easier to go in and hack on, you need do two things. You need to go into each submodule and check out a branch to work on. Then you need to tell Git what to do if you have made changes and then <code>git submodule update --remote</code> pulls in new work from upstream. The options are that you can merge them into your local work, or you can try to rebase your local work on top of the new changes.</p>
</div>
<div class="paragraph">
<p>First of all, let&#8217;s go into our submodule directory and check out a branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout stable
Switched to branch 'stable'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it with the &#8220;merge&#8221; option. To specify it manually, we can just add the <code>--merge</code> option to our <code>update</code> call. Here we&#8217;ll see that there was a change on the server for this submodule and it gets merged in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule update --remote --merge
remote: Counting objects: 4, done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 4 (delta 2), reused 4 (delta 2)
Unpacking objects: 100% (4/4), done.
From https://github.com/chaconinc/DbConnector
   c87d55d..92c7337  stable     -&gt; origin/stable
Updating c87d55d..92c7337
Fast-forward
 src/main.c | 1 +
 1 file changed, 1 insertion(+)
Submodule path 'DbConnector': merged in '92c7337b30ef9e0893e758dac2459d07362ab5ea'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we go into the DbConnector directory, we have the new changes already merged into our local <code>stable</code> branch. Now let&#8217;s see what happens when we make our own local change to the library and someone else pushes another change upstream at the same time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd DbConnector/
$ vim src/db.c
$ git commit -am 'unicode support'
[stable f906e16] unicode support
 1 file changed, 1 insertion(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we update our submodule we can see what happens when we have made a local change and upstream also has a change we need to incorporate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule update --remote --rebase
First, rewinding head to replay your work on top of it...
Applying: unicode support
Submodule path 'DbConnector': rebased into '5d60ef9bbebf5a0c1c1050f242ceeb54ad58da94'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you forget the <code>--rebase</code> or <code>--merge</code>, Git will just update the submodule to whatever is on the server and reset your project to a detached HEAD state.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule update --remote
Submodule path 'DbConnector': checked out '5d60ef9bbebf5a0c1c1050f242ceeb54ad58da94'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this happens, don&#8217;t worry, you can simply go back into the directory and check out your branch again (which will still contain your work) and merge or rebase <code>origin/stable</code> (or whatever remote branch you want) manually.</p>
</div>
<div class="paragraph">
<p>If you haven&#8217;t committed your changes in your submodule and you run a submodule update that would cause issues, Git will fetch the changes but not overwrite unsaved work in your submodule directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule update --remote
remote: Counting objects: 4, done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 4 (delta 0), reused 4 (delta 0)
Unpacking objects: 100% (4/4), done.
From https://github.com/chaconinc/DbConnector
   5d60ef9..c75e92a  stable     -&gt; origin/stable
error: Your local changes to the following files would be overwritten by checkout:
	scripts/setup.sh
Please, commit your changes or stash them before you can switch branches.
Aborting
Unable to checkout 'c75e92a2b3855c9e5b66f915308390d9db204aca' in submodule path 'DbConnector'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you made changes that conflict with something changed upstream, Git will let you know when you run the update.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule update --remote --merge
Auto-merging scripts/setup.sh
CONFLICT (content): Merge conflict in scripts/setup.sh
Recorded preimage for 'scripts/setup.sh'
Automatic merge failed; fix conflicts and then commit the result.
Unable to merge 'c75e92a2b3855c9e5b66f915308390d9db204aca' in submodule path 'DbConnector'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can go into the submodule directory and fix the conflict just as you normally would.</p>
</div>
</div>
<div class="sect4">
<h5 id="_publishing_submodules">Publishing Submodule Changes</h5>
<div class="paragraph">
<p>Now we have some changes in our submodule directory. Some of these were brought in from upstream by our updates and others were made locally and aren&#8217;t available to anyone else yet as we haven&#8217;t pushed them yet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
Submodule DbConnector c87d55d..82d2ad3:
  &gt; Merge from origin/stable
  &gt; updated setup script
  &gt; unicode support
  &gt; remove unnecessary method
  &gt; add new option for conn pooling</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we commit in the main project and push it up without pushing the submodule changes up as well, other people who try to check out our changes are going to be in trouble since they will have no way to get the submodule changes that are depended on. Those changes will only exist on our local copy.</p>
</div>
<div class="paragraph">
<p>In order to make sure this doesn&#8217;t happen, you can ask Git to check that all your submodules have been pushed properly before pushing the main project. The <code>git push</code> command takes the <code>--recurse-submodules</code> argument which can be set to either &#8220;check&#8221; or &#8220;on-demand&#8221;. The &#8220;check&#8221; option will make <code>push</code> simply fail if any of the committed submodule changes haven&#8217;t been pushed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push --recurse-submodules=check
The following submodule paths contain changes that can
not be found on any remote:
  DbConnector

Please try

	git push --recurse-submodules=on-demand

or cd to the path and use

	git push

to push them to a remote.</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it also gives us some helpful advice on what we might want to do next. The simple option is to go into each submodule and manually push to the remotes to make sure they&#8217;re externally available and then try this push again.</p>
</div>
<div class="paragraph">
<p>The other option is to use the &#8220;on-demand&#8221; value, which will try to do this for you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push --recurse-submodules=on-demand
Pushing submodule 'DbConnector'
Counting objects: 9, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (8/8), done.
Writing objects: 100% (9/9), 917 bytes | 0 bytes/s, done.
Total 9 (delta 3), reused 0 (delta 0)
To https://github.com/chaconinc/DbConnector
   c75e92a..82d2ad3  stable -&gt; stable
Counting objects: 2, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (2/2), done.
Writing objects: 100% (2/2), 266 bytes | 0 bytes/s, done.
Total 2 (delta 1), reused 0 (delta 0)
To https://github.com/chaconinc/MainProject
   3d6d338..9a377d1  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see there, Git went into the DbConnector module and pushed it before pushing the main project. If that submodule push fails for some reason, the main project push will also fail.</p>
</div>
</div>
<div class="sect4">
<h5 id="_merging_submodule_changes">Merging Submodule Changes</h5>
<div class="paragraph">
<p>If you change a submodule reference at the same time as someone else, you may run into some problems. That is, if the submodule histories have diverged and are committed to diverging branches in a superproject, it may take a bit of work for you to fix.</p>
</div>
<div class="paragraph">
<p>If one of the commits is a direct ancestor of the other (a fast-forward merge), then Git will simply choose the latter for the merge, so that works fine.</p>
</div>
<div class="paragraph">
<p>Git will not attempt even a trivial merge for you, however. If the submodule commits diverge and need to be merged, you will get something that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git pull
remote: Counting objects: 2, done.
remote: Compressing objects: 100% (1/1), done.
remote: Total 2 (delta 1), reused 2 (delta 1)
Unpacking objects: 100% (2/2), done.
From https://github.com/chaconinc/MainProject
   9a377d1..eb974f8  master     -&gt; origin/master
Fetching submodule DbConnector
warning: Failed to merge submodule DbConnector (merge following commits not found)
Auto-merging DbConnector
CONFLICT (submodule): Merge conflict in DbConnector
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>So basically what has happened here is that Git has figured out that the two branches record points in the submodule&#8217;s history that are divergent and need to be merged. It explains it as &#8220;merge following commits not found&#8221;, which is confusing but we&#8217;ll explain why that is in a bit.</p>
</div>
<div class="paragraph">
<p>To solve the problem, you need to figure out what state the submodule should be in. Strangely, Git doesn&#8217;t really give you much information to help out here, not even the SHAs of the commits of both sides of the history. Fortunately, it&#8217;s simple to figure out.  If you run <code>git diff</code> you can get the SHAs of the commits recorded in both branches you were trying to merge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --cc DbConnector
index eb41d76,c771610..0000000
--- a/DbConnector
+++ b/DbConnector</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, in this case, <code>eb41d76</code> is the commit in our submodule that <strong>we</strong> had and <code>c771610</code> is the commit that upstream had. If we go into our submodule directory, it should already be on <code>eb41d76</code> as the merge would not have touched it. If for whatever reason it&#8217;s not, you can simply create and checkout a branch pointing to it.</p>
</div>
<div class="paragraph">
<p>What is important is the SHA of the commit from the other side. This is what you&#8217;ll have to merge in and resolve. You can either just try the merge with the SHA directly, or you can create a branch for it and then try to merge that in. We would suggest the latter, even if only to make a nicer merge commit message.</p>
</div>
<div class="paragraph">
<p>So, we will go into our submodule directory, create a branch based on that second SHA from <code>git diff</code> and manually merge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd DbConnector

$ git rev-parse HEAD
eb41d764bccf88be77aced643c13a7fa86714135

$ git branch try-merge c771610
(DbConnector) $ git merge try-merge
Auto-merging src/main.c
CONFLICT (content): Merge conflict in src/main.c
Recorded preimage for 'src/main.c'
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We got an actual merge conflict here, so if we resolve that and commit it, then we can simply update the main project with the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ vim src/main.c <b class="conum">(1)</b>
$ git add src/main.c
$ git commit -am 'merged our changes'
Recorded resolution for 'src/main.c'.
[master 9fd905e] merged our changes

$ cd .. <b class="conum">(2)</b>
$ git diff <b class="conum">(3)</b>
diff --cc DbConnector
index eb41d76,c771610..0000000
--- a/DbConnector
+++ b/DbConnector
@@@ -1,1 -1,1 +1,1 @@@
- Subproject commit eb41d764bccf88be77aced643c13a7fa86714135
 -Subproject commit c77161012afbbe1f58b5053316ead08f4b7e6d1d
++Subproject commit 9fd905e5d7f45a0d4cbc43d1ee550f16a30e825a
$ git add DbConnector <b class="conum">(4)</b>

$ git commit -m "Merge Tom's Changes" <b class="conum">(5)</b>
[master 10d2c60] Merge Tom's Changes</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>First we resolve the conflict</p>
</li>
<li>
<p>Then we go back to the main project directory</p>
</li>
<li>
<p>We can check the SHAs again</p>
</li>
<li>
<p>Resolve the conflicted submodule entry</p>
</li>
<li>
<p>Commit our merge</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It can be a bit confusing, but it&#8217;s really not very hard.</p>
</div>
<div class="paragraph">
<p>Interestingly, there is another case that Git handles.
If a merge commit exists in the submodule directory that contains <strong>both</strong> commits in it&#8217;s history, Git will suggest it to you as a possible solution. It sees that at some point in the submodule project, someone merged branches containing these two commits, so maybe you&#8217;ll want that one.</p>
</div>
<div class="paragraph">
<p>This is why the error message from before was &#8220;merge following commits not found&#8221;, because it could not do <strong>this</strong>. It&#8217;s confusing because who would expect it to <strong>try</strong> to do this?</p>
</div>
<div class="paragraph">
<p>If it does find a single acceptable merge commit, you&#8217;ll see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge origin/master
warning: Failed to merge submodule DbConnector (not fast-forward)
Found a possible merge resolution for the submodule:
 9fd905e5d7f45a0d4cbc43d1ee550f16a30e825a: &gt; merged our changes
If this is correct simply add it to the index for example
by using:

  git update-index --cacheinfo 160000 9fd905e5d7f45a0d4cbc43d1ee550f16a30e825a "DbConnector"

which will accept this suggestion.
Auto-merging DbConnector
CONFLICT (submodule): Merge conflict in DbConnector
Automatic merge failed; fix conflicts and then commit the result.</code></pre>
</div>
</div>
<div class="paragraph">
<p>What it&#8217;s suggesting that you do is to update the index like you had run <code>git add</code>, which clears the conflict, then commit. You probably shouldn&#8217;t do this though. You can just as easily go into the submodule directory, see what the difference is, fast-forward to this commit, test it properly, and then commit it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd DbConnector/
$ git merge 9fd905e
Updating eb41d76..9fd905e
Fast-forward

$ cd ..
$ git add DbConnector
$ git commit -am 'Fast forwarded to a common submodule child'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This accomplishes the same thing, but at least this way you can verify that it works and you have the code in your submodule directory when you&#8217;re done.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_submodule_tips">Submodule Tips</h4>
<div class="paragraph">
<p>There are a few things you can do to make working with submodules a little easier.</p>
</div>
<div class="sect4">
<h5 id="_submodule_foreach">Submodule Foreach</h5>
<div class="paragraph">
<p>There is a <code>foreach</code> submodule command to run some arbitrary command in each submodule. This can be really helpful if you have a number of submodules in the same project.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s say we want to start a new feature or do a bugfix and we have work going on in several submodules. We can easily stash all the work in all our submodules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule foreach 'git stash'
Entering 'CryptoLibrary'
No local changes to save
Entering 'DbConnector'
Saved working directory and index state WIP on stable: 82d2ad3 Merge from origin/stable
HEAD is now at 82d2ad3 Merge from origin/stable</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can create a new branch and switch to it in all our submodules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git submodule foreach 'git checkout -b featureA'
Entering 'CryptoLibrary'
Switched to a new branch 'featureA'
Entering 'DbConnector'
Switched to a new branch 'featureA'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You get the idea. One really useful thing you can do is produce a nice unified diff of what is changed in your main project and all your subprojects as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff; git submodule foreach 'git diff'
Submodule DbConnector contains modified content
diff --git a/src/main.c b/src/main.c
index 210f1ae..1f0acdc 100644
--- a/src/main.c
+++ b/src/main.c
@@ -245,6 +245,8 @@ static int handle_alias(int *argcp, const char ***argv)

      commit_pager_choice();

+     url = url_decode(url_orig);
+
      /* build alias_argv */
      alias_argv = xmalloc(sizeof(*alias_argv) * (argc + 1));
      alias_argv[0] = alias_string + 1;
Entering 'DbConnector'
diff --git a/src/db.c b/src/db.c
index 1aaefb6..5297645 100644
--- a/src/db.c
+++ b/src/db.c
@@ -93,6 +93,11 @@ char *url_decode_mem(const char *url, int len)
        return url_decode_internal(&amp;url, len, NULL, &amp;out, 0);
 }

+char *url_decode(const char *url)
+{
+       return url_decode_mem(url, strlen(url));
+}
+
 char *url_decode_parameter_name(const char **query)
 {
        struct strbuf out = STRBUF_INIT;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see that we&#8217;re defining a function in a submodule and calling it in the main project. This is obviously a simplified example, but hopefully it gives you an idea of how this may be useful.</p>
</div>
</div>
<div class="sect4">
<h5 id="_useful_aliases">Useful Aliases</h5>
<div class="paragraph">
<p>You may want to set up some aliases for some of these commands as they can be quite long and you can&#8217;t set configuration options for most of them to make them defaults. We covered setting up Git aliases in <a id="_git_aliases"></a>, but here is an example of what you may want to set up if you plan on working with submodules in Git a lot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config alias.sdiff '!'"git diff &amp;&amp; git submodule foreach 'git diff'"
$ git config alias.spush 'push --recurse-submodules=on-demand'
$ git config alias.supdate 'submodule update --remote --merge'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way you can simply run <code>git supdate</code> when you want to update your submodules, or <code>git spush</code> to push with submodule dependency checking.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_issues_with_submodules">Issues with Submodules</h4>
<div class="paragraph">
<p>Using submodules isn’t without hiccups, however.</p>
</div>
<div class="paragraph">
<p>For instance switching branches with submodules in them can also be tricky.
If you create a new branch, add a submodule there, and then switch back to a branch without that submodule, you still have the submodule directory as an untracked directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b add-crypto
Switched to a new branch 'add-crypto'

$ git submodule add https://github.com/chaconinc/CryptoLibrary
Cloning into 'CryptoLibrary'...
...

$ git commit -am 'adding crypto library'
[add-crypto 4445836] adding crypto library
 2 files changed, 4 insertions(+)
 create mode 160000 CryptoLibrary

$ git checkout master
warning: unable to rmdir CryptoLibrary: Directory not empty
Switched to branch 'master'
Your branch is up-to-date with 'origin/master'.

$ git status
On branch master
Your branch is up-to-date with 'origin/master'.

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	CryptoLibrary/

nothing added to commit but untracked files present (use "git add" to track)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Removing the directory isn&#8217;t difficult, but it can be a bit confusing to have that in there. If you do remove it and then switch back to the branch that has that submodule, you will need to run <code>submodule update --init</code> to repopulate it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clean -ffdx
Removing CryptoLibrary/

$ git checkout add-crypto
Switched to branch 'add-crypto'

$ ls CryptoLibrary/

$ git submodule update --init
Submodule path 'CryptoLibrary': checked out 'b8dda6aa182ea4464f3f3264b11e0268545172af'

$ ls CryptoLibrary/
Makefile	includes	scripts		src</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, not really very difficult, but it can be a little confusing.</p>
</div>
<div class="paragraph">
<p>The other main caveat that many people run into involves switching from subdirectories to submodules.
If you’ve been tracking files in your project and you want to move them out into a submodule, you must be careful or Git will get angry at you.
Assume that you have files in a subdirectory of your project, and you want to switch it to a submodule.
If you delete the subdirectory and then run <code>submodule add</code>, Git yells at you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ rm -Rf CryptoLibrary/
$ git submodule add https://github.com/chaconinc/CryptoLibrary
'CryptoLibrary' already exists in the index</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have to unstage the <code>CryptoLibrary</code> directory first.
Then you can add the submodule:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rm -r CryptoLibrary
$ git submodule add https://github.com/chaconinc/CryptoLibrary
Cloning into 'CryptoLibrary'...
remote: Counting objects: 11, done.
remote: Compressing objects: 100% (10/10), done.
remote: Total 11 (delta 0), reused 11 (delta 0)
Unpacking objects: 100% (11/11), done.
Checking connectivity... done.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now suppose you did that in a branch.
If you try to switch back to a branch where those files are still in the actual tree rather than a submodule – you get this error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout master
error: The following untracked working tree files would be overwritten by checkout:
  CryptoLibrary/Makefile
  CryptoLibrary/includes/crypto.h
  ...
Please move or remove them before you can switch branches.
Aborting</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can force it to switch with <code>checkout -f</code>, but be careful that you don&#8217;t have unsaved changes in there as they could be overwritten with that command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -f master
warning: unable to rmdir CryptoLibrary: Directory not empty
Switched to branch 'master'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, when you switch back, you get an empty <code>CryptoLibrary</code> directory for some reason and <code>git submodule update</code> may not fix it either. You may need to go into your submodule directory and run a <code>git checkout .</code> to get all your files back. You could run this in a <code>submodule foreach</code> script to run it for multiple submodules.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that submodules these days keep all their Git data in the top project&#8217;s <code>.git</code> directory, so unlike much older versions of Git, destroying a submodule directory won&#8217;t lose any commits or branches that you had.</p>
</div>
<div class="paragraph">
<p>With these tools, submodules can be a fairly simple and effective method for developing on several related but still separate projects simultaneously.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bundling">打包</h3>
<div class="paragraph">
<p>虽然我们已经了解了网络传输 Git 数据的常用方法（如 HTTP，SSH 等），但还有另外一种不太常见却又十分有用的方式。</p>
</div>
<div class="paragraph">
<p>Git 可以将它的数据 &#8220;打包&#8221; 到一个文件中。这在许多场景中都很有用。有可能您的网络中断了，但您又希望将您的提交传给您的合作者们。可能您不在办公网中并且出于安全考虑没有给您接入内网的权限。可能您的无线、有线网卡坏掉了。可能您现在没有共享服务器的权限，您又希望通过邮件将更新发送给别人，却不希望通过 <code>format-patch</code> 的方式传输 40 个提交。</p>
</div>
<div class="paragraph">
<p>这些情况下 <code>git bundle</code> 就会很有用。<code>bundle</code> 命令会将 <code>git push</code> 命令所传输的所有内容打包成一个二进制文件，您可以将这个文件通过邮件或者闪存传给其他人，然后解包到其他的仓库中。</p>
</div>
<div class="paragraph">
<p>来看看一个简单的例子。假设您有一个包含两个提交的仓库：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log
commit 9a466c572fe88b195efd356c3f2bbeccdb504102
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Wed Mar 10 07:34:10 2010 -0800

    second commit

commit b1ec3248f39900d2a406049d762aa68e9641be25
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Wed Mar 10 07:34:01 2010 -0800

    first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果您想把这个仓库发送给其他人但您没有其他仓库的权限，或者就是懒得新建一个仓库，您就可以用 <code>git bundle create</code> 命令来打包。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bundle create repo.bundle HEAD master
Counting objects: 6, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (2/2), done.
Writing objects: 100% (6/6), 441 bytes, done.
Total 6 (delta 0), reused 0 (delta 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>然后您就会有一个名为 <code>repo.bundle</code> 的文件，该文件包含了所有重建该仓库 <code>master</code> 分支所需的数据。在使用 <code>bundle</code> 命令时，您需要列出所有您希望打包的引用或者提交的区间。如果您希望这个仓库可以在别处被克隆，您应该像例子中那样增加一个 HEAD 引用。</p>
</div>
<div class="paragraph">
<p>您可以将这个 <code>repo.bundle</code> 文件通过邮件或者U盘传给别人。</p>
</div>
<div class="paragraph">
<p>另一方面，假设别人传给您一个 <code>repo.bundle</code> 文件并希望您在这个项目上工作。您可以从这个二进制文件中克隆出一个目录，就像从一个 URL 克隆一样。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone repo.bundle repo
Initialized empty Git repository in /private/tmp/bundle/repo/.git/
$ cd repo
$ git log --oneline
9a466c5 second commit
b1ec324 first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果您在打包时没有包含 HEAD 引用，您还需要在命令后指定一个 <code>-b master</code> 或者其他被引入的分支，否则 Git 不知道应该检出哪一个分支。</p>
</div>
<div class="paragraph">
<p>现在假设您提交了 3 个修订，并且要用邮件或者U盘将新的提交放在一个包里传回去。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline
71b84da last commit - second repo
c99cf5b fourth commit - second repo
7011d3d third commit - second repo
9a466c5 second commit
b1ec324 first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>首先我们需要确认我们希望被打包的提交区间。和网络协议不太一样，网络协议会自动计算出所需传输的最小数据集，而我们需要手动计算。当然您可以像上面那样将整个仓库打包，但最好仅仅打包变更的部分 —— 就是我们刚刚在本地做的 3 个提交。</p>
</div>
<div class="paragraph">
<p>为了实现这个目标，您需要计算出差别。就像我们在 <a href="#_commit_ranges">提交区间</a> 介绍的，您有很多种方式去指明一个提交区间。我们可以使用 <code>origin/master..master</code> 或者 <code>master ^origin/master</code> 之类的方法来获取那 3 个在我们的 master 分支而不在原始仓库中的提交。您可以用 <code>log</code> 命令来测试。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline master ^origin/master
71b84da last commit - second repo
c99cf5b fourth commit - second repo
7011d3d third commit - second repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>这样就获取到我们希望被打包的提交列表，让我们将这些提交打包。我们可以用 <code>git bundle create</code> 命令，加上我们想用的文件名，以及要打包的提交区间。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bundle create commits.bundle master ^9a466c5
Counting objects: 11, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (9/9), 775 bytes, done.
Total 9 (delta 0), reused 0 (delta 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在在我们的目录下会有一个 <code>commits.bundle</code> 文件。如果我们把这个文件发送给我们的合作者，她可以将这个文件导入到原始的仓库中，即使在这期间已经有其他的工作提交到这个仓库中。</p>
</div>
<div class="paragraph">
<p>当她拿到这个包时，她可以在导入到仓库之前查看这个包里包含了什么内容。<code>bundle verify</code> 命令可以检查这个文件是否是一个合法的 Git 包，是否拥有共同的祖先来导入。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bundle verify ../commits.bundle
The bundle contains 1 ref
71b84daaf49abed142a373b6e5c59a22dc6560dc refs/heads/master
The bundle requires these 1 ref
9a466c572fe88b195efd356c3f2bbeccdb504102 second commit
../commits.bundle is okay</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果打包工具仅仅把最后两个提交打包，而不是三个，原始的仓库是无法导入这个包的，因为这个包缺失了必要的提交记录。这时候 <code>verify</code> 的输出类似：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bundle verify ../commits-bad.bundle
error: Repository lacks these prerequisite commits:
error: 7011d3d8fc200abe0ad561c011c3852a4b7bbe95 third commit - second repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>而我们的第一个包是合法的，所以我们可以从这个包里提取出提交。如果您想查看这边包里可以导入哪些分支，同样有一个命令可以列出这些顶端：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git bundle list-heads ../commits.bundle
71b84daaf49abed142a373b6e5c59a22dc6560dc refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>verify</code> 子命令同样可以告诉您有哪些顶端。该功能的目的是查看哪些是可以被拉入的，所以您可以使用 <code>fetch</code> 或者 <code>pull</code> 命令从包中导入提交。这里我们要从包中取出 <code>master</code> 分支到我们仓库中的 <em>other-master</em> 分支：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch ../commits.bundle master:other-master
From ../commits.bundle
 * [new branch]      master     -&gt; other-master</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看到我们已经将提交导入到 <em>other-master</em> 分支，以及在这期间我们自己在 <em>master</em> 分支上的提交。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --decorate --graph --all
* 8255d41 (HEAD, master) third commit - first repo
| * 71b84da (other-master) last commit - second repo
| * c99cf5b fourth commit - second repo
| * 7011d3d third commit - second repo
|/
* 9a466c5 second commit
* b1ec324 first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>因此，当您在没有合适的网络或者可共享仓库的情况下，<code>git bundle</code> 很适合用于共享或者网络类型的操作。</p>
</div>
</div>
<div class="sect2">
<h3 id="_replace">Replace</h3>
<div class="paragraph">
<p>Git&#8217;s objects are unchangable, but it does provide an interesting way to pretend to replace objects in it&#8217;s database with other objects.</p>
</div>
<div class="paragraph">
<p>The <code>replace</code> command lets you specify an object in Git and say "every time you see this, pretend it&#8217;s this other thing". This is most commonly useful for replacing one commit in your history with another one.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s say you have a huge code history and want to split your repository into one short history for new developers and one much longer and larger history for people interested in data mining.  You can graft one history onto the other by `replace`ing the earliest commit in the new line with the latest commit on the older one.  This is nice because it means that you don&#8217;t actually have to rewrite every commit in the new history, as you would normally have to do to join them together (because the parentage effects the SHAs).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try this out.  Let&#8217;s take an existing repository, split it into two repositories, one recent and one historical, and then we&#8217;ll see how we can recombine them without modifying the recent repositories SHA values via <code>replace</code>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll use a simple repository with five simple commits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline
ef989d8 fifth commit
c6e1e95 fourth commit
9c68fdc third commit
945704c second commit
c1822cf first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to break this up into two lines of history.  One line goes from commit one to commit four - that will be the historical one.  The second line will just be commits four and five - that will be the recent history.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/replace1.png" alt="replace1">
</div>
</div>
<div class="paragraph">
<p>Well, creating the historical history is easy, we can just put a branch in the history and then push that branch to the master branch of a new remote repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch history c6e1e95
$ git log --oneline --decorate
ef989d8 (HEAD, master) fifth commit
c6e1e95 (history) fourth commit
9c68fdc third commit
945704c second commit
c1822cf first commit</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/replace2.png" alt="replace2">
</div>
</div>
<div class="paragraph">
<p>Now we can push the new <code>history</code> branch to the <code>master</code> branch of our new repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add project-history https://github.com/schacon/project-history
$ git push project-history history:master
Counting objects: 12, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (4/4), done.
Writing objects: 100% (12/12), 907 bytes, done.
Total 12 (delta 0), reused 0 (delta 0)
Unpacking objects: 100% (12/12), done.
To git@github.com:schacon/project-history.git
 * [new branch]      history -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, so our history is published.  Now the harder part is truncating our recent history down so it&#8217;s smaller. We need an overlap so we can replace a commit in one with an equivalent commit in the other, so we&#8217;re going to truncate this to just commits four and five (so commit four overlaps).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --decorate
ef989d8 (HEAD, master) fifth commit
c6e1e95 (history) fourth commit
9c68fdc third commit
945704c second commit
c1822cf first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s useful in this case to create a base commit that has instructions on how to expand the history, so other developers know what to do if they hit the first commit in the truncated history and need more. So, what we&#8217;re going to do is create an initial commit object as our base point with instructions, then rebase the remaining commits (four and five) on top of it.</p>
</div>
<div class="paragraph">
<p>To do that, we need to choose a point to split at, which for us is the third commit, which is <code>9c68fdc</code> in SHA-speak. So, our base commit will be based off of that tree. We can create our base commit using the <code>commit-tree</code> command, which just takes a tree and will give us a brand new, parentless commit object SHA back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'get history from blah blah blah' | git commit-tree 9c68fdc^{tree}
622e88e9cbfbacfb75b5279245b9fb38dfea10cf</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>commit-tree</code> command is one of a set of commands that are commonly referred to as <em>plumbing</em> commands. These are commands that are not generally meant to be used directly, but instead are used by <strong>other</strong> Git commands to do smaller jobs. On occasions when we&#8217;re doing weirder things like this, they allow us to do really low-level things but are not meant for daily use. You can read more about plumbing commands in <a href="#_plumbing_porcelain">Plumbing and Porcelain</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/replace3.png" alt="replace3">
</div>
</div>
<div class="paragraph">
<p>OK, so now that we have a base commit, we can rebase the rest of our history on top of that with <code>git rebase --onto</code>.  The <code>--onto</code> argument will be the SHA we just got back from <code>commit-tree</code> and the rebase point will be the third commit (the parent of the first commit we want to keep, <code>9c68fdc</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase --onto 622e88 9c68fdc
First, rewinding head to replay your work on top of it...
Applying: fourth commit
Applying: fifth commit</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/replace4.png" alt="replace4">
</div>
</div>
<div class="paragraph">
<p>OK, so now we&#8217;ve re-written our recent history on top of a throw away base commit that now has instructions in it on how to reconstitute the entire history if we wanted to. We can push that new history to a new project and now when people clone that repository, they will only see the most recent two commits and then a base commit with instructions.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now switch roles to someone cloning the project for the first time who wants the entire history.
To get the history data after cloning this truncated repository, one would have to add a second remote for the historical repository and fetch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://github.com/schacon/project
$ cd project

$ git log --oneline master
e146b5f fifth commit
81a708d fourth commit
622e88e get history from blah blah blah

$ git remote add project-history https://github.com/schacon/project-history
$ git fetch project-history
From https://github.com/schacon/project-history
 * [new branch]      master     -&gt; project-history/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the collaborator would have their recent commits in the <code>master</code> branch and the historical commits in the <code>project-history/master</code> branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline master
e146b5f fifth commit
81a708d fourth commit
622e88e get history from blah blah blah

$ git log --oneline project-history/master
c6e1e95 fourth commit
9c68fdc third commit
945704c second commit
c1822cf first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>To combine them, you can simply call <code>git replace</code> with the commit you want to replace and then the commit you want to replace it with.  So we want to replace the "fourth" commit in the master branch with the "fourth" commit in the <code>project-history/master</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git replace 81a708d c6e1e95</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if you look at the history of the <code>master</code> branch, it appears to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline master
e146b5f fifth commit
81a708d fourth commit
9c68fdc third commit
945704c second commit
c1822cf first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cool, right?  Without having to change all the SHAs upstream, we were able to replace one commit in our history with an entirely different commit and all the normal tools (<code>bisect</code>, <code>blame</code>, etc) will work how we would expect them to.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/replace5.png" alt="replace5">
</div>
</div>
<div class="paragraph">
<p>Interestingly, it still shows <code>81a708d</code> as the SHA, even though it&#8217;s actually using the <code>c6e1e95</code> commit data that we replaced it with.  Even if you run a command like <code>cat-file</code>, it will show you the replaced data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p 81a708d
tree 7bc544cf438903b65ca9104a1e30345eee6c083d
parent 9c68fdceee073230f19ebb8b5e7fc71b479c0252
author Scott Chacon &lt;schacon@gmail.com&gt; 1268712581 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1268712581 -0700

fourth commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that the actual parent of <code>81a708d</code> was our placeholder commit (<code>622e88e</code>), not <code>9c68fdce</code> as it states here.</p>
</div>
<div class="paragraph">
<p>Another interesting thing is that this data is kept in our references:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git for-each-ref
e146b5f14e79d4935160c0e83fb9ebe526b8da0d commit	refs/heads/master
c6e1e95051d41771a649f3145423f8809d1a74d4 commit	refs/remotes/history/master
e146b5f14e79d4935160c0e83fb9ebe526b8da0d commit	refs/remotes/origin/HEAD
e146b5f14e79d4935160c0e83fb9ebe526b8da0d commit	refs/remotes/origin/master
c6e1e95051d41771a649f3145423f8809d1a74d4 commit	refs/replace/81a708dd0e167a3f691541c7a6463343bc457040</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that it&#8217;s easy to share our replacement with others, because we can push this to our server and other people can easily download it.  This is not that helpful in the history grafting scenario we&#8217;ve gone over here (since everyone would be downloading both histories anyhow, so why separate them?) but it can be useful in other circumstances.</p>
</div>
</div>
<div class="sect2">
<h3 id="_credential_caching">凭证存储</h3>
<div class="paragraph">
<p>

如果您使用的是 SSH 方式连接远端，并且设置了一个没有口令的密钥，这样就可以在不输入用户名和密码的情况下安全地传输数据。
然而，这对 HTTP 协议来说是不可能的 —— 每一个连接都是需要用户名和密码的。
这在使用双重认证的情况下会更麻烦，因为您需要输入一个随机生成并且毫无规律的 token 作为密码。</p>
</div>
<div class="paragraph">
<p>幸运的是，Git 拥有一个凭证系统来处理这个事情。
下面有一些 Git 的选项：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>默认所有都不缓存。
每一次连接都会询问您的用户名和密码。</p>
</li>
<li>
<p>&#8220;cache&#8221; 模式会将凭证存放在内存中一段时间。
密码永远不会被存储在磁盘中，并且在15分钟后从内存中清除。</p>
</li>
<li>
<p>&#8220;store&#8221; 模式会将凭证用明文的形式存放在磁盘中，并且永不过期。
这意味着除非您修改了您在 Git 服务器上的密码，否则您永远不需要再次输入您的凭证信息。
这种方式的缺点是您的密码是用明文的方式存放在您的 home 目录下。</p>
</li>
<li>
<p>如果您使用的是 Mac，Git 还有一种 &#8220;osxkeychain&#8221; 模式，它会将凭证缓存到您系统用户的钥匙串中。
这种方式将凭证存放在磁盘中，并且永不过期，但是是被加密的，这种加密方式与存放 HTTPS 凭证以及 Safari 的自动填写是相同的。</p>
</li>
<li>
<p>如果您使用的是 Windows，您可以安装一个叫做 &#8220;winstore&#8221; 的辅助工具。
这和上面说的 &#8220;osxkeychain&#8221; 十分类似，但是是使用 Windows Credential Store 来控制敏感信息。
可以在 <a href="https://gitcredentialstore.codeplex.com" class="bare">https://gitcredentialstore.codeplex.com</a> 下载。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>您可以设置 Git 的配置来选择上述的一种方式</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global credential.helper cache</code></pre>
</div>
</div>
<div class="paragraph">
<p>部分辅助工具有一些选项。
&#8220;store&#8221; 模式可以接受一个 <code>--file &lt;path&gt;</code> 参数，可以自定义存放密码的文件路径（默认是`~/.git-credentials`）。
&#8220;cache&#8221; 模式有 <code>--timeout &lt;seconds&gt;</code> 参数，可以设置后台进程的存活时间（默认是 &#8220;900&#8221;，也就是 15 分钟）。
下面是一个配置 &#8220;store&#8221; 模式自定义路径的例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global credential.helper store --file ~/.my-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git 甚至允许您配置多个辅助工具。
当查找特定服务器的凭证时，Git 会按顺序查询，并且在找到第一个回答时停止查询。
当保存凭证时，Git 会将用户名和密码发送给 <strong>所有</strong> 配置列表中的辅助工具，它们会按自己的方式处理用户名和密码。
如果您在闪存上有一个凭证文件，但又希望在该闪存被拔出的情况下使用内存缓存来保存用户名密码，<code>.gitconfig</code> 配置文件如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[credential]
    helper = store --file /mnt/thumbdrive/.git-credentials
    helper = cache --timeout 30000</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_底层实现">底层实现</h4>
<div class="paragraph">
<p>这些是如何实现的呢？
Git 凭证辅助工具系统的命令是 <code>git credential</code>，这个命令接收一个参数，并通过标准输入获取更多的参数。</p>
</div>
<div class="paragraph">
<p>举一个例子更容易理解。
我们假设已经配置好一个凭证辅助工具，这个辅助工具保存了 <code>mygithost</code> 的凭证信息。
下面是一个使用 &#8220;fill&#8221; 命令的会话，当 Git 尝试寻找一个服务器的凭证时就会被调用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git credential fill <b class="conum">(1)</b>
protocol=https <b class="conum">(2)</b>
host=mygithost
<b class="conum">(3)</b>
protocol=https <b class="conum">(4)</b>
host=mygithost
username=bob
password=s3cre7
$ git credential fill <b class="conum">(5)</b>
protocol=https
host=unknownhost

Username for 'https://unknownhost': bob
Password for 'https://bob@unknownhost':
protocol=https
host=unknownhost
username=bob
password=s3cre7</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>这是开始交互的命令。</p>
</li>
<li>
<p>Git-credential 接下来会等待标准输入。
我们提供我们所知道的信息：协议和主机名。</p>
</li>
<li>
<p>一个空行代表输入已经完成，凭证系统应该输出它所知道的信息。</p>
</li>
<li>
<p>接下来由 Git-credential 接管，并且将找到的信息打印到标准输出。</p>
</li>
<li>
<p>如果没有找到对应的凭证，Git 会询问用户的用户名和密码，我们将这些信息输入到在标准输出的地方（这个例子中是同一个控制台）。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>凭证系统实际调用的程序和 Git 本身是分开的；具体是哪一个以及如何调用与 <code>credential.helper</code> 配置的值有关。
这个配置有多种格式：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">配置值</th>
<th class="tableblock halign-left valign-top">行为</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">执行 <code>git-credential-foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo -a --opt=bcd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">执行 <code>git-credential-foo -a --opt=bcd</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/absolute/path/foo -xyz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">执行 <code>/absolute/path/foo -xyz</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>!f() { echo "password=s3cre7"; }; f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>!</code> 后面的代码会在shell执行</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>上面描述的辅助工具可以被称做 <code>git-credential-cache</code>、<code>git-credential-store</code> 之类，我们可以配置它们来接受命令行参数。
通常的格式是 &#8220;git-credential-foo [args] &lt;action&gt;.&#8221;
标准输入/输出协议和 git-credential 一样，但它们使用的是一套稍微不太一样的行为：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>get</code> 是请求输入一对用户名和密码。</p>
</li>
<li>
<p><code>store</code> 是请求保存一个凭证到辅助工具的内存。</p>
</li>
<li>
<p><code>erase</code> 会将给定的证书从辅助工具内存中清除。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>对于 <code>store</code> 和 <code>erase</code> 两个行为是不需要返回数据的（Git 也会忽略掉）。
然而对于 <code>get</code>，Git 对辅助工具的返回信息十分感兴趣。</p>
</div>
<div class="paragraph">
<p>如果辅助工具没有任何有用的信息，它可以直接退出而不需要输出任何东西，但如果它有这些信息，它在提供的信息后面增加它所拥有的信息。
这些输出会被视为一系列的赋值语句；每一个提供的数据都会将 Git 已有的数据替换掉。</p>
</div>
<div class="paragraph">
<p>这有一个和上面一样的例子，但是跳过了 git-credential 这一步，直接到 git-credential-store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git credential-store --file ~/git.store store <b class="conum">(1)</b>
protocol=https
host=mygithost
username=bob
password=s3cre7
$ git credential-store --file ~/git.store get <b class="conum">(2)</b>
protocol=https
host=mygithost

username=bob <b class="conum">(3)</b>
password=s3cre7</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>我们告诉 <code>git-credential-store</code> 去保存凭证：当访问 <code>https://mygithost</code> 时使用用户名 &#8220;bob&#8221;，密码是 &#8220;s3cre7&#8221;。</p>
</li>
<li>
<p>现在我们取出这个凭证。
我们提供连接这部分的信息（<code>https://mygithost</code>）以及一个空行。</p>
</li>
<li>
<p><code>git-credential-store</code> 输出我们之前保存的用户名和密码。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>~/git.store</code> 文件的内容类似：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>https://bob:s3cre7@mygithost</code></pre>
</div>
</div>
<div class="paragraph">
<p>仅仅是一系列包含凭证信息URL组成的行。
<code>osxkeychain</code> 和 <code>winstore</code> 辅助工具使用它们后端存储的原生格式，而 <code>cache</code> 使用它的内存格式（其他进程无法读取）。</p>
</div>
</div>
<div class="sect3">
<h4 id="_自定义凭证缓存">自定义凭证缓存</h4>
<div class="paragraph">
<p>已经知道 <code>git-credential-store</code> 之类的是和 Git 是相互独立的程序，就不难理解 Git 凭证辅助工具可以是 <em>任意</em> 程序。
虽然 Git 提供的辅助工具覆盖了大多数常见的使用场景，但并不能满足所有情况。
比如，假设您的整个团队共享一些凭证，也许是在部署时使用。
这些凭证是保存在一个共享目录里，由于这些凭证经常变更，所以您不想把它们复制到您自己的凭证仓库中。
现有的辅助工具无法满足这种情况；来看看我们如何自己实现一个。
这个程序应该拥有几个核心功能：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>我们唯一需要关注的行为是 <code>get</code>；<code>store</code> 和 <code>erase</code> 是写操作，所以当接受到这两个请求时我们直接退出即可。</p>
</li>
<li>
<p>共享的凭证文件格式和 <code>git-credential-store</code> 使用的格式相同。</p>
</li>
<li>
<p>凭证文件的路径一般是固定的，但我们应该允许用户传入一个自定义路径以防万一。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>我们再一次使用 Ruby 来编写这个扩展，但只要 Git 能够执行最终的程序，任何语言都是可以的。
这是我们的凭证辅助工具的完整代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

require 'optparse'

path = File.expand_path '~/.git-credentials' <b class="conum">(1)</b>
OptionParser.new do |opts|
    opts.banner = 'USAGE: git-credential-read-only [options] &lt;action&gt;'
    opts.on('-f', '--file PATH', 'Specify path for backing store') do |argpath|
        path = File.expand_path argpath
    end
end.parse!

exit(0) unless ARGV[0].downcase == 'get' <b class="conum">(2)</b>
exit(0) unless File.exists? path

known = {} <b class="conum">(3)</b>
while line = STDIN.gets
    break if line.strip == ''
    k,v = line.strip.split '=', 2
    known[k] = v
end

File.readlines(path).each do |fileline| <b class="conum">(4)</b>
    prot,user,pass,host = fileline.scan(/^(.*?):\/\/(.*?):(.*?)@(.*)$/).first
    if prot == known['protocol'] and host == known['host'] then
        puts "protocol=#{prot}"
        puts "host=#{host}"
        puts "username=#{user}"
        puts "password=#{pass}"
        exit(0)
    end
end</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>我们在这里解析命令行参数，允许用户指定输入文件，默认是 <code>~/.git-credentials</code>.</p>
</li>
<li>
<p>这个程序只有在接受到 <code>get</code> 行为的请求并且后端存储的文件存在时才会有输出。</p>
</li>
<li>
<p>这个循环从标准输入读取数据，直到读取到第一个空行。
输入的数据被保存到 <code>known</code> 哈希表中，之后需要用到。</p>
</li>
<li>
<p>这个循环读取存储文件中的内容，寻找匹配的行。
如果 <code>known</code> 中的协议和主机名与该行相匹配，这个程序输出结果并退出。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>我们把这个辅助工具保存为 <code>git-credential-read-only</code>，放到我们的 <code>PATH</code> 路径下并且给予执行权限。
一个交互式会话类似：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git credential-read-only --file=/mnt/shared/creds get
protocol=https
host=mygithost

protocol=https
host=mygithost
username=bob
password=s3cre7</code></pre>
</div>
</div>
<div class="paragraph">
<p>由于这个的名字是 &#8220;git-&#8221; 开头，所以我们可以在配置值中使用简便的语法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global credential.helper read-only --file /mnt/shared/creds</code></pre>
</div>
</div>
<div class="paragraph">
<p>正如你看到的，扩展这个系统是相当简单的，并且可以为您和您的团队解决一些常见问题。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_总结_5">总结</h3>
<div class="paragraph">
<p>您已经接触了很多能够精确地操控提交和暂存区的高级工具。
当您碰到问题时，您应该可以很容易找出是哪个分支在什么时候由谁引入了它们。
如果您想在项目中使用子项目，您也已经知道如何来满足这些需求。
到此，您应该能毫无压力地在命令行中使用 Git 来完成日常中的大部分事情。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_git">Customizing Git</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, we&#8217;ve covered the basics of how Git works and how to use it, and we&#8217;ve introduced a number of tools that Git provides to help you use it easily and efficiently.
In this chapter, we&#8217;ll see how you can make Git operate in a more customized fashion, by introducing several important configuration settings and the hooks system.
With these tools, it&#8217;s easy to get Git to work exactly the way you, your company, or your group needs it to.</p>
</div>
<div class="sect2">
<h3 id="_git_config">Git Configuration</h3>
<div class="paragraph">
<p>
As you briefly saw in <a href="#_getting_started">起步</a>, you can specify Git configuration settings with the <code>git config</code> command.
One of the first things you did was set up your name and e-mail address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global user.name "John Doe"
$ git config --global user.email johndoe@example.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you&#8217;ll learn a few of the more interesting options that you can set in this manner to customize your Git usage.</p>
</div>
<div class="paragraph">
<p>First, a quick review: Git uses a series of configuration files to determine non-default behavior that you may want.
The first place Git looks for these values is in an <code>/etc/gitconfig</code> file, which contains values for every user on the system and all of their repositories.
If you pass the option <code>--system</code> to <code>git config</code>, it reads and writes from this file specifically.</p>
</div>
<div class="paragraph">
<p>The next place Git looks is the <code>~/.gitconfig</code> (or <code>~/.config/git/config</code>) file, which is specific to each user.
You can make Git read and write to this file by passing the <code>--global</code> option.</p>
</div>
<div class="paragraph">
<p>Finally, Git looks for configuration values in the configuration file in the Git directory (<code>.git/config</code>) of whatever repository you&#8217;re currently using.
These values are specific to that single repository.</p>
</div>
<div class="paragraph">
<p>Each of these &#8220;levels&#8221; (system, global, local) overwrites values in the previous level, so values in <code>.git/config</code> trump those in <code>/etc/gitconfig</code>, for instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Git&#8217;s configuration files are plain-text, so you can also set these values by manually editing the file and inserting the correct syntax.
It&#8217;s generally easier to run the <code>git config</code> command, though.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_basic_client_configuration">Basic Client Configuration</h4>
<div class="paragraph">
<p>The configuration options recognized by Git fall into two categories: client-side and server-side.
The majority of the options are client-side – configuring your personal working preferences.
Many, <em>many</em> configuration options are supported, but a large fraction of them are only useful in certain edge cases.
We&#8217;ll only be covering the most common and most useful here.
If you want to see a list of all the options your version of Git recognizes, you can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ man git-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command lists all the available options in quite a bit of detail.
You can also find this reference material at <a href="http://git-scm.com/docs/git-config.html" class="bare">http://git-scm.com/docs/git-config.html</a>.</p>
</div>
<div class="sect4">
<h5 id="__code_core_editor_code"><code>core.editor</code></h5>
<div class="paragraph">
<p>
By default, Git uses whatever you&#8217;ve set as your default text editor (<code>$VISUAL</code> or <code>$EDITOR</code>) or else falls back to the <code>vi</code> editor to create and edit your commit and tag messages.
To change that default to something else, you can use the <code>core.editor</code> setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.editor emacs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, no matter what is set as your default shell editor, Git will fire up Emacs to edit messages.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_commit_template_code"><code>commit.template</code></h5>
<div class="paragraph">
<p>
If you set this to the path of a file on your system, Git will use that file as the default message when you commit.
For instance, suppose you create a template file at <code>~/.gitmessage.txt</code> that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subject line

what happened

[ticket: X]</code></pre>
</div>
</div>
<div class="paragraph">
<p>To tell Git to use it as the default message that appears in your editor when you run <code>git commit</code>, set the <code>commit.template</code> configuration value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global commit.template ~/.gitmessage.txt
$ git commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, your editor will open to something like this for your placeholder commit message when you commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subject line

what happened

[ticket: X]
# Please enter the commit message for your changes. Lines starting
# with '#' will be ignored, and an empty message aborts the commit.
# On branch master
# Changes to be committed:
#   (use "git reset HEAD &lt;file&gt;..." to unstage)
#
# modified:   lib/test.rb
#
~
~
".git/COMMIT_EDITMSG" 14L, 297C</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your team has a commit-message policy, then putting a template for that policy on your system and configuring Git to use it by default can help increase the chance of that policy being followed regularly.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_core_pager_code"><code>core.pager</code></h5>
<div class="paragraph">
<p>
This setting determines which pager is used when Git pages output such as <code>log</code> and <code>diff</code>.
You can set it to <code>more</code> or to your favorite pager (by default, it&#8217;s <code>less</code>), or you can turn it off by setting it to a blank string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.pager ''</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run that, Git will page the entire output of all commands, no matter how long they are.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_user_signingkey_code"><code>user.signingkey</code></h5>
<div class="paragraph">
<p>
If you&#8217;re making signed annotated tags (as discussed in <a href="#_signing">Signing Your Work</a>), setting your GPG signing key as a configuration setting makes things easier.
Set your key ID like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global user.signingkey &lt;gpg-key-id&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can sign tags without having to specify your key every time with the <code>git tag</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -s &lt;tag-name&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="__code_core_excludesfile_code"><code>core.excludesfile</code></h5>
<div class="paragraph">
<p>
You can put patterns in your project&#8217;s <code>.gitignore</code> file to have Git not see them as untracked files or try to stage them when you run <code>git add</code> on them, as discussed in <a href="#_ignoring">忽略文件</a>.</p>
</div>
<div class="paragraph">
<p>But sometimes you want to ignore certain files for all repositories that you work with.
If your computer is running Mac OS X, you&#8217;re probably familiar with <code>.DS_Store</code> files.
If your preferred editor is Emacs or Vim, you know about files that end with a <code>~</code>.</p>
</div>
<div class="paragraph">
<p>This setting lets you write a kind of global <code>.gitignore</code> file.
If you create a <code>~/.gitignore_global</code> file with these contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>*~
.DS_Store</code></pre>
</div>
</div>
<div class="paragraph">
<p>…and you run <code>git config --global core.excludesfile ~/.gitignore_global</code>, Git will never again bother you about those files.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_help_autocorrect_code"><code>help.autocorrect</code></h5>
<div class="paragraph">
<p>
If you mistype a command, it shows you something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git chekcout master
git: 'chekcout' is not a git command. See 'git --help'.

Did you mean this?
    checkout</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git helpfully tries to figure out what you meant, but it still refuses to do it.
If you set <code>help.autocorrect</code> to 1, Git will actually run this command for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git chekcout master
WARNING: You called a Git command named 'chekcout', which does not exist.
Continuing under the assumption that you meant 'checkout'
in 0.1 seconds automatically...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that &#8220;0.1 seconds&#8221; business. <code>help.autocorrect</code> is actually an integer which represents tenths of a second.
So if you set it to 50, Git will give you 5 seconds to change your mind before executing the autocorrected command.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_colors_in_git">Colors in Git</h4>
<div class="paragraph">
<p>
Git fully supports colored terminal output, which greatly aids in visually parsing command output quickly and easily.
A number of options can help you set the coloring to your preference.</p>
</div>
<div class="sect4">
<h5 id="__code_color_ui_code"><code>color.ui</code></h5>
<div class="paragraph">
<p>Git automatically colors most of its output, but there&#8217;s a master switch if you don&#8217;t like this behavior.
To turn off all Git&#8217;s colored terminal output, do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global color.ui false</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default setting is <code>auto</code>, which colors output when it&#8217;s going straight to a terminal, but omits the color-control codes when the output is redirected to a pipe or a file.</p>
</div>
<div class="paragraph">
<p>You can also set it to <code>always</code> to ignore the difference between terminals and pipes.
You&#8217;ll rarely want this; in most scenarios, if you want color codes in your redirected output, you can instead pass a <code>--color</code> flag to the Git command to force it to use color codes.
The default setting is almost always what you&#8217;ll want.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_color_code"><code>color.*</code></h5>
<div class="paragraph">
<p>If you want to be more specific about which commands are colored and how, Git provides verb-specific coloring settings.
Each of these can be set to <code>true</code>, <code>false</code>, or <code>always</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>color.branch
color.diff
color.interactive
color.status</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, each of these has subsettings you can use to set specific colors for parts of the output, if you want to override each color.
For example, to set the meta information in your diff output to blue foreground, black background, and bold text, you can run</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git config --global color.diff.meta "blue black bold"</pre>
</div>
</div>
<div class="paragraph">
<p>You can set the color to any of the following values: <code>normal</code>, <code>black</code>, <code>red</code>, <code>green</code>, <code>yellow</code>, <code>blue</code>, <code>magenta</code>, <code>cyan</code>, or <code>white</code>.
If you want an attribute like bold in the previous example, you can choose from <code>bold</code>, <code>dim</code>, <code>ul</code> (underline), <code>blink</code>, and <code>reverse</code> (swap foreground and background).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_external_merge_tools">External Merge and Diff Tools</h4>
<div class="paragraph">
<p>
Although Git has an internal implementation of diff, which is what we&#8217;ve been showing in this book, you can set up an external tool instead.
You can also set up a graphical merge-conflict-resolution tool instead of having to resolve conflicts manually.
We&#8217;ll demonstrate setting up the Perforce Visual Merge Tool (P4Merge) to do your diffs and merge resolutions, because it&#8217;s a nice graphical tool and it&#8217;s free.</p>
</div>
<div class="paragraph">
<p>If you want to try this out, P4Merge works on all major platforms, so you should be able to do so.
I&#8217;ll use path names in the examples that work on Mac and Linux systems; for Windows, you&#8217;ll have to change <code>/usr/local/bin</code> to an executable path in your environment.</p>
</div>
<div class="paragraph">
<p>To begin, download P4Merge from <a href="http://www.perforce.com/downloads/Perforce/" class="bare">http://www.perforce.com/downloads/Perforce/</a>.
Next, you&#8217;ll set up external wrapper scripts to run your commands.
I&#8217;ll use the Mac path for the executable; in other systems, it will be where your <code>p4merge</code> binary is installed.
Set up a merge wrapper script named <code>extMerge</code> that calls your binary with all the arguments provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /usr/local/bin/extMerge
#!/bin/sh
/Applications/p4merge.app/Contents/MacOS/p4merge $*</code></pre>
</div>
</div>
<div class="paragraph">
<p>The diff wrapper checks to make sure seven arguments are provided and passes two of them to your merge script.
By default, Git passes the following arguments to the diff program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>path old-file old-hex old-mode new-file new-hex new-mode</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because you only want the <code>old-file</code> and <code>new-file</code> arguments, you use the wrapper script to pass the ones you need.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /usr/local/bin/extDiff
#!/bin/sh
[ $# -eq 7 ] &amp;&amp; /usr/local/bin/extMerge "$2" "$5"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need to make sure these tools are executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ sudo chmod +x /usr/local/bin/extMerge
$ sudo chmod +x /usr/local/bin/extDiff</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can set up your config file to use your custom merge resolution and diff tools.
This takes a number of custom settings: <code>merge.tool</code> to tell Git what strategy to use, <code>mergetool.&lt;tool&gt;.cmd</code> to specify how to run the command, <code>mergetool.&lt;tool&gt;.trustExitCode</code> to tell Git if the exit code of that program indicates a successful merge resolution or not, and <code>diff.external</code> to tell Git what command to run for diffs.
So, you can either run four config commands</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global merge.tool extMerge
$ git config --global mergetool.extMerge.cmd \
  'extMerge \"$BASE\" \"$LOCAL\" \"$REMOTE\" \"$MERGED\"'
$ git config --global mergetool.extMerge.trustExitCode false
$ git config --global diff.external extDiff</code></pre>
</div>
</div>
<div class="paragraph">
<p>or you can edit your <code>~/.gitconfig</code> file to add these lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[merge]
  tool = extMerge
[mergetool "extMerge"]
  cmd = extMerge "$BASE" "$LOCAL" "$REMOTE" "$MERGED"
  trustExitCode = false
[diff]
  external = extDiff</code></pre>
</div>
</div>
<div class="paragraph">
<p>After all this is set, if you run diff commands such as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff 32d1776b1^ 32d1776b1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of getting the diff output on the command line, Git fires up P4Merge, which looks something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/p4merge.png" alt="P4Merge.">
</div>
<div class="title">Figure 143. P4Merge.</div>
</div>
<div class="paragraph">
<p>If you try to merge two branches and subsequently have merge conflicts, you can run the command <code>git mergetool</code>; it starts P4Merge to let you resolve the conflicts through that GUI tool.</p>
</div>
<div class="paragraph">
<p>The nice thing about this wrapper setup is that you can change your diff and merge tools easily.
For example, to change your <code>extDiff</code> and <code>extMerge</code> tools to run the KDiff3 tool instead, all you have to do is edit your <code>extMerge</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /usr/local/bin/extMerge
#!/bin/sh
/Applications/kdiff3.app/Contents/MacOS/kdiff3 $*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, Git will use the KDiff3 tool for diff viewing and merge conflict resolution.</p>
</div>
<div class="paragraph">
<p>Git comes preset to use a number of other merge-resolution tools without your having to set up the cmd configuration.
To see a list of the tools it supports, try this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git mergetool --tool-help
'git mergetool --tool=&lt;tool&gt;' may be set to one of the following:
        emerge
        gvimdiff
        gvimdiff2
        opendiff
        p4merge
        vimdiff
        vimdiff2

The following tools are valid, but not currently available:
        araxis
        bc3
        codecompare
        deltawalker
        diffmerge
        diffuse
        ecmerge
        kdiff3
        meld
        tkdiff
        tortoisemerge
        xxdiff

Some of the tools listed above only work in a windowed
environment. If run in a terminal-only session, they will fail.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re not interested in using KDiff3 for diff but rather want to use it just for merge resolution, and the kdiff3 command is in your path, then you can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global merge.tool kdiff3</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run this instead of setting up the <code>extMerge</code> and <code>extDiff</code> files, Git will use KDiff3 for merge resolution and the normal Git diff tool for diffs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_formatting_and_whitespace">Formatting and Whitespace</h4>
<div class="paragraph">
<p>
Formatting and whitespace issues are some of the more frustrating and subtle problems that many developers encounter when collaborating, especially cross-platform.
It&#8217;s very easy for patches or other collaborated work to introduce subtle whitespace changes because editors silently introduce them, and if your files ever touch a Windows system, their line endings might be replaced.
Git has a few configuration options to help with these issues.</p>
</div>
<div class="sect4">
<h5 id="__code_core_autocrlf_code"><code>core.autocrlf</code></h5>
<div class="paragraph">
<p>
If you&#8217;re programming on Windows and working with people who are not (or vice-versa), you&#8217;ll probably run into line-ending issues at some point.
This is because Windows uses both a carriage-return character and a linefeed character for newlines in its files, whereas Mac and Linux systems use only the linefeed character.
This is a subtle but incredibly annoying fact of cross-platform work; many editors on Windows silently replace existing LF-style line endings with CRLF, or insert both line-ending characters when the user hits the enter key.</p>
</div>
<div class="paragraph">
<p>Git can handle this by auto-converting CRLF line endings into LF when you add a file to the index, and vice versa when it checks out code onto your filesystem.
You can turn on this functionality with the <code>core.autocrlf</code> setting.
If you&#8217;re on a Windows machine, set it to <code>true</code> – this converts LF endings into CRLF when you check out code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.autocrlf true</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re on a Linux or Mac system that uses LF line endings, then you don&#8217;t want Git to automatically convert them when you check out files; however, if a file with CRLF endings accidentally gets introduced, then you may want Git to fix it.
You can tell Git to convert CRLF to LF on commit but not the other way around by setting <code>core.autocrlf</code> to input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.autocrlf input</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup should leave you with CRLF endings in Windows checkouts, but LF endings on Mac and Linux systems and in the repository.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re a Windows programmer doing a Windows-only project, then you can turn off this functionality, recording the carriage returns in the repository by setting the config value to <code>false</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.autocrlf false</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="__code_core_whitespace_code"><code>core.whitespace</code></h5>
<div class="paragraph">
<p>Git comes preset to detect and fix some whitespace issues.
It can look for six primary whitespace issues – three are enabled by default and can be turned off, and three are disabled by default but can be activated.</p>
</div>
<div class="paragraph">
<p>The ones that are turned on by default are <code>blank-at-eol</code>, which looks for spaces at the end of a line; <code>blank-at-eof</code>, which notices blank lines at the end of a file; and <code>space-before-tab</code>, which looks for spaces before tabs at the beginning of a line.</p>
</div>
<div class="paragraph">
<p>The three that are disabled by default but can be turned on are <code>indent-with-non-tab</code>, which looks for lines that begin with spaces instead of tabs (and is controlled by the <code>tabwidth</code> option); <code>tab-in-indent</code>, which watches for tabs in the indentation portion of a line; and <code>cr-at-eol</code>, which tells Git that carriage returns at the end of lines are OK.</p>
</div>
<div class="paragraph">
<p>You can tell Git which of these you want enabled by setting <code>core.whitespace</code> to the values you want on or off, separated by commas.
You can disable settings by either leaving them out of the setting string or prepending a <code>-</code> in front of the value.
For example, if you want all but <code>cr-at-eol</code> to be set, you can do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global core.whitespace \
    trailing-space,space-before-tab,indent-with-non-tab</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git will detect these issues when you run a <code>git diff</code> command and try to color them so you can possibly fix them before you commit.
It will also use these values to help you when you apply patches with <code>git apply</code>.
When you&#8217;re applying patches, you can ask Git to warn you if it&#8217;s applying patches with the specified whitespace issues:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git apply --whitespace=warn &lt;patch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can have Git try to automatically fix the issue before applying the patch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git apply --whitespace=fix &lt;patch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These options apply to the <code>git rebase</code> command as well.
If you&#8217;ve committed whitespace issues but haven&#8217;t yet pushed upstream, you can run <code>git rebase --whitespace=fix</code> to have Git automatically fix whitespace issues as it&#8217;s rewriting the patches.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_configuration">Server Configuration</h4>
<div class="paragraph">
<p>Not nearly as many configuration options are available for the server side of Git, but there are a few interesting ones you may want to take note of.</p>
</div>
<div class="sect4">
<h5 id="__code_receive_fsckobjects_code"><code>receive.fsckObjects</code></h5>
<div class="paragraph">
<p>Git is capable of making sure every object received during a push still matches its SHA-1 checksum and points to valid objects.
However, it doesn&#8217;t do this by default; it&#8217;s a fairly expensive operation, and might slow down the operation, especially on large repositories or pushes.
If you want Git to check object consistency on every push, you can force it to do so by setting <code>receive.fsckObjects</code> to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --system receive.fsckObjects true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, Git will check the integrity of your repository before each push is accepted to make sure faulty (or malicious) clients aren&#8217;t introducing corrupt data.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_receive_denynonfastforwards_code"><code>receive.denyNonFastForwards</code></h5>
<div class="paragraph">
<p>If you rebase commits that you&#8217;ve already pushed and then try to push again, or otherwise try to push a commit to a remote branch that doesn&#8217;t contain the commit that the remote branch currently points to, you&#8217;ll be denied.
This is generally good policy; but in the case of the rebase, you may determine that you know what you&#8217;re doing and can force-update the remote branch with a <code>-f</code> flag to your push command.</p>
</div>
<div class="paragraph">
<p>To tell Git to refuse force-pushes, set <code>receive.denyNonFastForwards</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --system receive.denyNonFastForwards true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other way you can do this is via server-side receive hooks, which we&#8217;ll cover in a bit.
That approach lets you do more complex things like deny non-fast-forwards to a certain subset of users.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_receive_denydeletes_code"><code>receive.denyDeletes</code></h5>
<div class="paragraph">
<p>One of the workarounds to the <code>denyNonFastForwards</code> policy is for the user to delete the branch and then push it back up with the new reference.
To avoid this, set <code>receive.denyDeletes</code> to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --system receive.denyDeletes true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This denies any deletion of branches or tags – no user can do it.
To remove remote branches, you must remove the ref files from the server manually.
There are also more interesting ways to do this on a per-user basis via ACLs, as you&#8217;ll learn in <a href="#_an_example_git_enforced_policy">An Example Git-Enforced Policy</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_attributes">Git Attributes</h3>
<div class="paragraph">
<p>
Some of these settings can also be specified for a path, so that Git applies those settings only for a subdirectory or subset of files.
These path-specific settings are called Git attributes and are set either in a <code>.gitattributes</code> file in one of your directories (normally the root of your project) or in the <code>.git/info/attributes</code> file if you don&#8217;t want the attributes file committed with your project.</p>
</div>
<div class="paragraph">
<p>Using attributes, you can do things like specify separate merge strategies for individual files or directories in your project, tell Git how to diff non-text files, or have Git filter content before you check it into or out of Git.
In this section, you&#8217;ll learn about some of the attributes you can set on your paths in your Git project and see a few examples of using this feature in practice.</p>
</div>
<div class="sect3">
<h4 id="_binary_files">Binary Files</h4>
<div class="paragraph">
<p>
One cool trick for which you can use Git attributes is telling Git which files are binary (in cases it otherwise may not be able to figure out) and giving Git special instructions about how to handle those files.
For instance, some text files may be machine generated and not diffable, whereas some binary files can be diffed.
You&#8217;ll see how to tell Git which is which.</p>
</div>
<div class="sect4">
<h5 id="_identifying_binary_files">Identifying Binary Files</h5>
<div class="paragraph">
<p>Some files look like text files but for all intents and purposes are to be treated as binary data.
For instance, Xcode projects on the Mac contain a file that ends in <code>.pbxproj</code>, which is basically a JSON (plain-text Javascript data format) dataset written out to disk by the IDE, which records your build settings and so on.
Although it&#8217;s technically a text file (because it&#8217;s all UTF-8), you don&#8217;t want to treat it as such because it&#8217;s really a lightweight database – you can&#8217;t merge the contents if two people change it, and diffs generally aren&#8217;t helpful.
The file is meant to be consumed by a machine.
In essence, you want to treat it like a binary file.</p>
</div>
<div class="paragraph">
<p>To tell Git to treat all <code>pbxproj</code> files as binary data, add the following line to your <code>.gitattributes</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>*.pbxproj binary</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, Git won&#8217;t try to convert or fix CRLF issues; nor will it try to compute or print a diff for changes in this file when you run <code>git show</code> or <code>git diff</code> on your project.</p>
</div>
</div>
<div class="sect4">
<h5 id="_diffing_binary_files">Diffing Binary Files</h5>
<div class="paragraph">
<p>You can also use the Git attributes functionality to effectively diff binary files.
You do this by telling Git how to convert your binary data to a text format that can be compared via the normal diff.</p>
</div>
<div class="paragraph">
<p>First, you&#8217;ll use this technique to solve one of the most annoying problems known to humanity: version-controlling Microsoft Word documents.
Everyone knows that Word is the most horrific editor around, but oddly, everyone still uses it.
If you want to version-control Word documents, you can stick them in a Git repository and commit every once in a while; but what good does that do?
If you run <code>git diff</code> normally, you only see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --git a/chapter1.docx b/chapter1.docx
index 88839c4..4afcb7c 100644
Binary files a/chapter1.docx and b/chapter1.docx differ</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can&#8217;t directly compare two versions unless you check them out and scan them manually, right?
It turns out you can do this fairly well using Git attributes.
Put the following line in your <code>.gitattributes</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>*.docx diff=word</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells Git that any file that matches this pattern (<code>.docx</code>) should use the &#8220;word&#8221; filter when you try to view a diff that contains changes.
What is the &#8220;word&#8221; filter?
You have to set it up.
Here you&#8217;ll configure Git to use the <code>docx2txt</code> program to convert Word documents into readable text files, which it will then diff properly.</p>
</div>
<div class="paragraph">
<p>First, you&#8217;ll need to install <code>docx2txt</code>; you can download it from <a href="http://docx2txt.sourceforge.net" class="bare">http://docx2txt.sourceforge.net</a>. Follow the instructions in the <code>INSTALL</code> file to put it somewhere your shell can find it.
Next, you&#8217;ll write a wrapper script to convert output to the format Git expects.
Create a file that&#8217;s somewhere in your path called <code>docx2txt</code>, and add these contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">#!/bin/bash
docx2txt.pl $1 -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to <code>chmod a+x</code> that file.
Finally, you can configure Git to use this script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config diff.word.textconv docx2txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Git knows that if it tries to do a diff between two snapshots, and any of the files end in <code>.docx</code>, it should run those files through the &#8220;word&#8221; filter, which is defined as the <code>docx2txt</code> program.
This effectively makes nice text-based versions of your Word files before attempting to diff them.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example: Chapter 1 of this book was converted to Word format and commited in a Git repository.
Then a new paragraph was added.
Here&#8217;s what <code>git diff</code> shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git diff
diff --git a/chapter1.docx b/chapter1.docx
index 0b013ca..ba25db5 100644
--- a/chapter1.docx
+++ b/chapter1.docx
@@ -2,6 +2,7 @@
 This chapter will be about getting started with Git. We will begin at the beginning by explaining some background on version control tools, then move on to how to get Git running on your system and finally how to get it setup to start working with. At the end of this chapter you should understand why Git is around, why you should use it and you should be all setup to do so.
 1.1. About Version Control
 What is "version control", and why should you care? Version control is a system that records changes to a file or set of files over time so that you can recall specific versions later. For the examples in this book you will use software source code as the files being version controlled, though in reality you can do this with nearly any type of file on a computer.
+Testing: 1, 2, 3.
 If you are a graphic or web designer and want to keep every version of an image or layout (which you would most certainly want to), a Version Control System (VCS) is a very wise thing to use. It allows you to revert files back to a previous state, revert the entire project back to a previous state, compare changes over time, see who last modified something that might be causing a problem, who introduced an issue and when, and more. Using a VCS also generally means that if you screw things up or lose files, you can easily recover. In addition, you get all this for very little overhead.
 1.1.1. Local Version Control Systems
 Many people's version-control method of choice is to copy files into another directory (perhaps a time-stamped directory, if they're clever). This approach is very common because it is so simple, but it is also incredibly error prone. It is easy to forget which directory you're in and accidentally write to the wrong file or copy over files you don't mean to.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git successfully and succinctly tells me that I added the string &#8220;Testing: 1, 2, 3.&#8221;, which is correct.
It&#8217;s not perfect – formatting changes wouldn&#8217;t show up here – but it certainly works.</p>
</div>
<div class="paragraph">
<p>Another interesting problem you can solve this way involves diffing image files.
One way to do this is to run image files through a filter that extracts their EXIF information – metadata that is recorded with most image formats.
If you download and install the <code>exiftool</code> program, you can use it to convert your images into text about the metadata, so at least the diff will show you a textual representation of any changes that happened:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo '*.png diff=exif' &gt;&gt; .gitattributes
$ git config diff.exif.textconv exiftool</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you replace an image in your project and run <code>git diff</code>, you see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>diff --git a/image.png b/image.png
index 88839c4..4afcb7c 100644
--- a/image.png
+++ b/image.png
@@ -1,12 +1,12 @@
 ExifTool Version Number         : 7.74
-File Size                       : 70 kB
-File Modification Date/Time     : 2009:04:21 07:02:45-07:00
+File Size                       : 94 kB
+File Modification Date/Time     : 2009:04:21 07:02:43-07:00
 File Type                       : PNG
 MIME Type                       : image/png
-Image Width                     : 1058
-Image Height                    : 889
+Image Width                     : 1056
+Image Height                    : 827
 Bit Depth                       : 8
 Color Type                      : RGB with Alpha</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can easily see that the file size and image dimensions have both changed.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_keyword_expansion">Keyword Expansion</h4>
<div class="paragraph">
<p>
SVN- or CVS-style keyword expansion is often requested by developers used to those systems.
The main problem with this in Git is that you can&#8217;t modify a file with information about the commit after you&#8217;ve committed, because Git checksums the file first.
However, you can inject text into a file when it&#8217;s checked out and remove it again before it&#8217;s added to a commit.
Git attributes offers you two ways to do this.</p>
</div>
<div class="paragraph">
<p>First, you can inject the SHA-1 checksum of a blob into an <code>$Id$</code> field in the file automatically.
If you set this attribute on a file or set of files, then the next time you check out that branch, Git will replace that field with the SHA-1 of the blob.
It&#8217;s important to notice that it isn&#8217;t the SHA of the commit, but of the blob itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo '*.txt ident' &gt;&gt; .gitattributes
$ echo '$Id$' &gt; test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next time you check out this file, Git injects the SHA of the blob:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ rm test.txt
$ git checkout -- test.txt
$ cat test.txt
$Id: 42812b7653c7b88933f8a9d6cad0ca16714b9bb3 $</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, that result is of limited use.
If you&#8217;ve used keyword substitution in CVS or Subversion, you can include a datestamp – the SHA isn&#8217;t all that helpful, because it&#8217;s fairly random and you can&#8217;t tell if one SHA is older or newer than another just by looking at them.</p>
</div>
<div class="paragraph">
<p>It turns out that you can write your own filters for doing substitutions in files on commit/checkout.
These are called &#8220;clean&#8221; and &#8220;smudge&#8221; filters.
In the <code>.gitattributes</code> file, you can set a filter for particular paths and then set up scripts that will process files just before they&#8217;re checked out (&#8220;smudge&#8221;, see <a href="#filters_a">The &#8220;smudge&#8221; filter is run on checkout.</a>) and just before they&#8217;re staged (&#8220;clean&#8221;, see <a href="#filters_b">The &#8220;clean&#8221; filter is run when files are staged.</a>).
These filters can be set to do all sorts of fun things.</p>
</div>
<div id="filters_a" class="imageblock">
<div class="content">
<img src="images/smudge.png" alt="The ``smudge'' filter is run on checkout.">
</div>
<div class="title">Figure 144. The &#8220;smudge&#8221; filter is run on checkout.</div>
</div>
<div id="filters_b" class="imageblock">
<div class="content">
<img src="images/clean.png" alt="The ``clean'' filter is run when files are staged.">
</div>
<div class="title">Figure 145. The &#8220;clean&#8221; filter is run when files are staged.</div>
</div>
<div class="paragraph">
<p>The original commit message for this feature gives a simple example of running all your C source code through the <code>indent</code> program before committing.
You can set it up by setting the filter attribute in your <code>.gitattributes</code> file to filter <code>*.c</code> files with the &#8220;indent&#8221; filter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>*.c filter=indent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, tell Git what the &#8220;indent&#8221; filter does on smudge and clean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config --global filter.indent.clean indent
$ git config --global filter.indent.smudge cat</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, when you commit files that match <code>*.c</code>, Git will run them through the indent program before it stages them and then run them through the <code>cat</code> program before it checks them back out onto disk.
The <code>cat</code> program does essentially nothing: it spits out the same data that it comes in.
This combination effectively filters all C source code files through <code>indent</code> before committing.</p>
</div>
<div class="paragraph">
<p>Another interesting example gets <code>$Date$</code> keyword expansion, RCS style.
To do this properly, you need a small script that takes a filename, figures out the last commit date for this project, and inserts the date into the file.
Here is a small Ruby script that does that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#! /usr/bin/env ruby
data = STDIN.read
last_date = `git log --pretty=format:"%ad" -1`
puts data.gsub('$Date$', '$Date: ' + last_date.to_s + '$')</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the script does is get the latest commit date from the <code>git log</code> command, stick that into any <code>$Date$</code> strings it sees in stdin, and print the results – it should be simple to do in whatever language you&#8217;re most comfortable in.
You can name this file <code>expand_date</code> and put it in your path.
Now, you need to set up a filter in Git (call it <code>dater</code>) and tell it to use your <code>expand_date</code> filter to smudge the files on checkout.
You&#8217;ll use a Perl expression to clean that up on commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config filter.dater.smudge expand_date
$ git config filter.dater.clean 'perl -pe "s/\\\$Date[^\\\$]*\\\$/\\\$Date\\\$/"'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This Perl snippet strips out anything it sees in a <code>$Date$</code> string, to get back to where you started.
Now that your filter is ready, you can test it by setting up a file with your <code>$Date$</code> keyword and then setting up a Git attribute for that file that engages the new filter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo '# $Date$' &gt; date_test.txt
$ echo 'date*.txt filter=dater' &gt;&gt; .gitattributes</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you commit those changes and check out the file again, you see the keyword properly substituted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git add date_test.txt .gitattributes
$ git commit -m "Testing date expansion in Git"
$ rm date_test.txt
$ git checkout date_test.txt
$ cat date_test.txt
# $Date: Tue Apr 21 07:26:52 2009 -0700$</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see how powerful this technique can be for customized applications.
You have to be careful, though, because the <code>.gitattributes</code> file is committed and passed around with the project, but the driver (in this case, <code>dater</code>) isn&#8217;t, so it won&#8217;t work everywhere.
When you design these filters, they should be able to fail gracefully and have the project still work properly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exporting_your_repository">Exporting Your Repository</h4>
<div class="paragraph">
<p>
Git attribute data also allows you to do some interesting things when exporting an archive of your project.</p>
</div>
<div class="sect4">
<h5 id="__code_export_ignore_code"><code>export-ignore</code></h5>
<div class="paragraph">
<p>You can tell Git not to export certain files or directories when generating an archive.
If there is a subdirectory or file that you don&#8217;t want to include in your archive file but that you do want checked into your project, you can determine those files via the <code>export-ignore</code> attribute.</p>
</div>
<div class="paragraph">
<p>For example, say you have some test files in a <code>test/</code> subdirectory, and it doesn&#8217;t make sense to include them in the tarball export of your project.
You can add the following line to your Git attributes file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>test/ export-ignore</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, when you run git archive to create a tarball of your project, that directory won&#8217;t be included in the archive.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_export_subst_code"><code>export-subst</code></h5>
<div class="paragraph">
<p>Another thing you can do for your archives is some simple keyword substitution.
Git lets you put the string <code>$Format:$</code> in any file with any of the <code>--pretty=format</code> formatting shortcodes, many of which you saw in Chapter 2.
For instance, if you want to include a file named <code>LAST_COMMIT</code> in your project, and the last commit date was automatically injected into it when <code>git archive</code> ran, you can set up the file like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'Last commit date: $Format:%cd$' &gt; LAST_COMMIT
$ echo "LAST_COMMIT export-subst" &gt;&gt; .gitattributes
$ git add LAST_COMMIT .gitattributes
$ git commit -am 'adding LAST_COMMIT file for archives'</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run <code>git archive</code>, the contents of that file when people open the archive file will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat LAST_COMMIT
Last commit date: $Format:Tue Apr 21 08:38:48 2009 -0700$</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_merge_strategies">Merge Strategies</h4>
<div class="paragraph">
<p>
You can also use Git attributes to tell Git to use different merge strategies for specific files in your project.
One very useful option is to tell Git to not try to merge specific files when they have conflicts, but rather to use your side of the merge over someone else&#8217;s.</p>
</div>
<div class="paragraph">
<p>This is helpful if a branch in your project has diverged or is specialized, but you want to be able to merge changes back in from it, and you want to ignore certain files.
Say you have a database settings file called <code>database.xml</code> that is different in two branches, and you want to merge in your other branch without messing up the database file.
You can set up an attribute like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>database.xml merge=ours</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">And then define a dummy `ours` merge strategy with:</code></pre>
</div>
</div>
<div class="paragraph">
<p>$ git config --global merge.ours.driver true</p>
</div>
<div class="paragraph">
<p>If you merge in the other branch, instead of having merge conflicts with the <code>database.xml</code> file, you see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge topic
Auto-merging database.xml
Merge made by recursive.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, <code>database.xml</code> stays at whatever version you originally had.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_hooks">Git Hooks</h3>
<div class="paragraph">
<p>
Like many other Version Control Systems, Git has a way to fire off custom scripts when certain important actions occur.
There are two groups of these hooks: client-side and server-side.
Client-side hooks are triggered by operations such as committing and merging, while server-side hooks run on network operations such as receiving pushed commits.
You can use these hooks for all sorts of reasons</p>
</div>
<div class="sect3">
<h4 id="_installing_a_hook">Installing a Hook</h4>
<div class="paragraph">
<p>The hooks are all stored in the <code>hooks</code> subdirectory of the Git directory.
In most projects, that&#8217;s <code>.git/hooks</code>.
When you initialize a new repository with <code>git init</code>, Git populates the hooks directory with a bunch of example scripts, many of which are useful by themselves; but they also document the input values of each script.
All the examples are written as shell scripts, with some Perl thrown in, but any properly named executable scripts will work fine – you can write them in Ruby or Python or what have you.
If you want to use the bundled hook scripts, you&#8217;ll have to rename them; their file names all end with <code>.sample</code>.</p>
</div>
<div class="paragraph">
<p>To enable a hook script, put a file in the <code>hooks</code> subdirectory of your Git directory that is named appropriately and is executable.
From that point forward, it should be called.
I&#8217;ll cover most of the major hook filenames here.</p>
</div>
</div>
<div class="sect3">
<h4 id="_client_side_hooks">Client-Side Hooks</h4>
<div class="paragraph">
<p>There are a lot of client-side hooks.
This section splits them into committing-workflow hooks, e-mail-workflow scripts, and everything else.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s important to note that client-side hooks are <strong>not</strong> copied when you clone a repository.
If your intent with these scripts is to enforce a policy, you&#8217;ll probably want to do that on the server side; see the example in <a href="#_an_example_git_enforced_policy">An Example Git-Enforced Policy</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_committing_workflow_hooks">Committing-Workflow Hooks</h5>
<div class="paragraph">
<p>The first four hooks have to do with the committing process.</p>
</div>
<div class="paragraph">
<p>The <code>pre-commit</code> hook is run first, before you even type in a commit message.
It&#8217;s used to inspect the snapshot that&#8217;s about to be committed, to see if you&#8217;ve forgotten something, to make sure tests run, or to examine whatever you need to inspect in the code.
Exiting non-zero from this hook aborts the commit, although you can bypass it with <code>git commit --no-verify</code>.
You can do things like check for code style (run <code>lint</code> or something equivalent), check for trailing whitespace (the default hook does exactly this), or check for appropriate documentation on new methods.</p>
</div>
<div class="paragraph">
<p>The <code>prepare-commit-msg</code> hook is run before the commit message editor is fired up but after the default message is created.
It lets you edit the default message before the commit author sees it.
This hook takes a few parameters: the path to the file that holds the commit message so far, the type of commit, and the commit SHA-1 if this is an amended commit.
This hook generally isn&#8217;t useful for normal commits; rather, it&#8217;s good for commits where the default message is auto-generated, such as templated commit messages, merge commits, squashed commits, and amended commits.
You may use it in conjunction with a commit template to programmatically insert information.</p>
</div>
<div class="paragraph">
<p>The <code>commit-msg</code> hook takes one parameter, which again is the path to a temporary file that contains the commit message written by the developer.
If this script exits non-zero, Git aborts the commit process, so you can use it to validate your project state or commit message before allowing a commit to go through.
In the last section of this chapter, I&#8217;ll demonstrate using this hook to check that your commit message is conformant to a required pattern.</p>
</div>
<div class="paragraph">
<p>After the entire commit process is completed, the <code>post-commit</code> hook runs.
It doesn&#8217;t take any parameters, but you can easily get the last commit by running <code>git log -1 HEAD</code>.
Generally, this script is used for notification or something similar.</p>
</div>
</div>
<div class="sect4">
<h5 id="_email_hooks">E-mail Workflow Hooks</h5>
<div class="paragraph">
<p>You can set up three client-side hooks for an e-mail-based workflow.
They&#8217;re all invoked by the <code>git am</code> command, so if you aren&#8217;t using that command in your workflow, you can safely skip to the next section.
If you&#8217;re taking patches over e-mail prepared by <code>git format-patch</code>, then some of these may be helpful to you.</p>
</div>
<div class="paragraph">
<p>The first hook that is run is <code>applypatch-msg</code>.
It takes a single argument: the name of the temporary file that contains the proposed commit message.
Git aborts the patch if this script exits non-zero.
You can use this to make sure a commit message is properly formatted, or to normalize the message by having the script edit it in place.</p>
</div>
<div class="paragraph">
<p>The next hook to run when applying patches via <code>git am</code> is <code>pre-applypatch</code>.
Somewhat confusingly, it is run <em>after</em> the patch is applied but before a commit is made, so you can use it to inspect the snapshot before making the commit.
You can run tests or otherwise inspect the working tree with this script.
If something is missing or the tests don&#8217;t pass, exiting non-zero aborts the <code>git am</code> script without committing the patch.</p>
</div>
<div class="paragraph">
<p>The last hook to run during a <code>git am</code> operation is <code>post-applypatch</code>, which runs after the commit is made.
You can use it to notify a group or the author of the patch you pulled in that you&#8217;ve done so.
You can&#8217;t stop the patching process with this script.</p>
</div>
</div>
<div class="sect4">
<h5 id="_other_client_hooks">Other Client Hooks</h5>
<div class="paragraph">
<p>The <code>pre-rebase</code> hook runs before you rebase anything and can halt the process by exiting non-zero.
You can use this hook to disallow rebasing any commits that have already been pushed.
The example <code>pre-rebase</code> hook that Git installs does this, although it makes some assumptions that may not match with your workflow.</p>
</div>
<div class="paragraph">
<p>The <code>post-rewrite</code> hook is run by commands that replace commits, such as <code>git commit --amend</code> and <code>git rebase</code> (though not by <code>git filter-branch</code>).
Its single argument is which command triggered the rewrite, and it receives a list of rewrites on <code>stdin</code>.
This hook has many of the same uses as the <code>post-checkout</code> and <code>post-merge</code> hooks.</p>
</div>
<div class="paragraph">
<p>After you run a successful <code>git checkout</code>, the <code>post-checkout</code> hook runs; you can use it to set up your working directory properly for your project environment.
This may mean moving in large binary files that you don&#8217;t want source controlled, auto-generating documentation, or something along those lines.</p>
</div>
<div class="paragraph">
<p>The <code>post-merge</code> hook runs after a successful <code>merge</code> command.
You can use it to restore data in the working tree that Git can&#8217;t track, such as permissions data.
This hook can likewise validate the presence of files external to Git control that you may want copied in when the working tree changes.</p>
</div>
<div class="paragraph">
<p>The <code>pre-push</code> hook runs during <code>git push</code>, after the remote refs have been updated but before any objects have been transferred.
It receives the name and location of the remote as parameters, and a list of to-be-updated refs through <code>stdin</code>.
You can use it to validate a set of ref updates before a push occurs (a non-zero exit code will abort the push).</p>
</div>
<div class="paragraph">
<p>Git occasionally does garbage collection as part of its normal operation, by invoking <code>git gc --auto</code>.
The <code>pre-auto-gc</code> hook is invoked just before the garbage collection takes place, and can be used to notify you that this is happening, or to abort the collection if now isn&#8217;t a good time.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_side_hooks">Server-Side Hooks</h4>
<div class="paragraph">
<p>In addition to the client-side hooks, you can use a couple of important server-side hooks as a system administrator to enforce nearly any kind of policy for your project.
These scripts run before and after pushes to the server.
The pre hooks can exit non-zero at any time to reject the push as well as print an error message back to the client; you can set up a push policy that&#8217;s as complex as you wish.</p>
</div>
<div class="sect4">
<h5 id="__code_pre_receive_code"><code>pre-receive</code></h5>
<div class="paragraph">
<p>The first script to run when handling a push from a client is <code>pre-receive</code>.
It takes a list of references that are being pushed from stdin; if it exits non-zero, none of them are accepted.
You can use this hook to do things like make sure none of the updated references are non-fast-forwards, or to do access control for all the refs and files they&#8217;re modifying with the push.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_update_code"><code>update</code></h5>
<div class="paragraph">
<p>The <code>update</code> script is very similar to the <code>pre-receive</code> script, except that it&#8217;s run once for each branch the pusher is trying to update.
If the pusher is trying to push to multiple branches, <code>pre-receive</code> runs only once, whereas update runs once per branch they&#8217;re pushing to.
Instead of reading from stdin, this script takes three arguments: the name of the reference (branch), the SHA-1 that reference pointed to before the push, and the SHA-1 the user is trying to push.
If the update script exits non-zero, only that reference is rejected; other references can still be updated.</p>
</div>
</div>
<div class="sect4">
<h5 id="__code_post_receive_code"><code>post-receive</code></h5>
<div class="paragraph">
<p>The <code>post-receive</code> hook runs after the entire process is completed and can be used to update other services or notify users.
It takes the same stdin data as the <code>pre-receive</code> hook.
Examples include e-mailing a list, notifying a continuous integration server, or updating a ticket-tracking system – you can even parse the commit messages to see if any tickets need to be opened, modified, or closed.
This script can&#8217;t stop the push process, but the client doesn&#8217;t disconnect until it has completed, so be careful if you try to do anything that may take a long time.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_example_git_enforced_policy">An Example Git-Enforced Policy</h3>
<div class="paragraph">
<p>
In this section, you&#8217;ll use what you&#8217;ve learned to establish a Git workflow that checks for a custom commit message format, and allows only certain users to modify certain subdirectories in a project.
You&#8217;ll build client scripts that help the developer know if their push will be rejected and server scripts that actually enforce the policies.</p>
</div>
<div class="paragraph">
<p>The scripts we&#8217;ll show are written in Ruby; partly because of our intellectual inertia, but also because Ruby is easy to read, even if you can&#8217;t necessarily write it.
However, any language will work – all the sample hook scripts distributed with Git are in either Perl or Bash, so you can also see plenty of examples of hooks in those languages by looking at the samples.</p>
</div>
<div class="sect3">
<h4 id="_server_side_hook">Server-Side Hook</h4>
<div class="paragraph">
<p>All the server-side work will go into the <code>update</code> file in your <code>hooks</code> directory.
The <code>update</code> hook runs once per branch being pushed and takes three arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The name of the reference being pushed to</p>
</li>
<li>
<p>The old revision where that branch was</p>
</li>
<li>
<p>The new revision being pushed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You also have access to the user doing the pushing if the push is being run over SSH.
If you&#8217;ve allowed everyone to connect with a single user (like &#8220;git&#8221;) via public-key authentication, you may have to give that user a shell wrapper that determines which user is connecting based on the public key, and set an environment variable accordingly.
Here we&#8217;ll assume the connecting user is in the <code>$USER</code> environment variable, so your update script begins by gathering all the information you need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

$refname = ARGV[0]
$oldrev  = ARGV[1]
$newrev  = ARGV[2]
$user    = ENV['USER']

puts "Enforcing Policies..."
puts "(#{$refname}) (#{$oldrev[0,6]}) (#{$newrev[0,6]})"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yes, those are global variables.
Don&#8217;t judge – it&#8217;s easier to demonstrate this way.</p>
</div>
<div class="sect4">
<h5 id="_enforcing_commit_message_format">Enforcing a Specific Commit-Message Format</h5>
<div class="paragraph">
<p>Your first challenge is to enforce that each commit message adheres to a particular format.
Just to have a target, assume that each message has to include a string that looks like &#8220;ref: 1234&#8221; because you want each commit to link to a work item in your ticketing system.
You must look at each commit being pushed up, see if that string is in the commit message, and, if the string is absent from any of the commits, exit non-zero so the push is rejected.</p>
</div>
<div class="paragraph">
<p>You can get a list of the SHA-1 values of all the commits that are being pushed by taking the <code>$newrev</code> and <code>$oldrev</code> values and passing them to a Git plumbing command called <code>git rev-list</code>.
This is basically the <code>git log</code> command, but by default it prints out only the SHA-1 values and no other information.
So, to get a list of all the commit SHAs introduced between one commit SHA and another, you can run something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rev-list 538c33..d14fc7
d14fc7c847ab946ec39590d87783c69b031bdfb7
9f585da4401b0a3999e84113824d15245c13f0be
234071a1be950e2a8d078e6141f5cd20c1e61ad3
dfa04c9ef3d5197182f13fb5b9b1fb7717d2222a
17716ec0f1ff5c77eff40b7fe912f9f6cfd0e475</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can take that output, loop through each of those commit SHAs, grab the message for it, and test that message against a regular expression that looks for a pattern.</p>
</div>
<div class="paragraph">
<p>You have to figure out how to get the commit message from each of these commits to test.
To get the raw commit data, you can use another plumbing command called <code>git cat-file</code>.
We&#8217;ll go over all these plumbing commands in detail in <a href="#_git_internals">Git Internals</a>; but for now, here&#8217;s what that command gives you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file commit ca82a6
tree cfda3bf379e4f8dba8717dee55aab78aef7f4daf
parent 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
author Scott Chacon &lt;schacon@gmail.com&gt; 1205815931 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1240030591 -0700

changed the version number</code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple way to get the commit message from a commit when you have the SHA-1 value is to go to the first blank line and take everything after that.
You can do so with the <code>sed</code> command on Unix systems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file commit ca82a6 | sed '1,/^$/d'
changed the version number</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use that incantation to grab the commit message from each commit that is trying to be pushed and exit if you see anything that doesn&#8217;t match.
To exit the script and reject the push, exit non-zero.
The whole method looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">$regex = /\[ref: (\d+)\]/

# enforced custom commit message format
def check_message_format
  missed_revs = `git rev-list #{$oldrev}..#{$newrev}`.split("\n")
  missed_revs.each do |rev|
    message = `git cat-file commit #{rev} | sed '1,/^$/d'`
    if !$regex.match(message)
      puts "[POLICY] Your message is not formatted correctly"
      exit 1
    end
  end
end
check_message_format</code></pre>
</div>
</div>
<div class="paragraph">
<p>Putting that in your <code>update</code> script will reject updates that contain commits that have messages that don&#8217;t adhere to your rule.</p>
</div>
</div>
<div class="sect4">
<h5 id="_enforcing_a_user_based_acl_system">Enforcing a User-Based ACL System</h5>
<div class="paragraph">
<p>Suppose you want to add a mechanism that uses an access control list (ACL) that specifies which users are allowed to push changes to which parts of your projects.
Some people have full access, and others can only push changes to certain subdirectories or specific files.
To enforce this, you&#8217;ll write those rules to a file named <code>acl</code> that lives in your bare Git repository on the server.
You&#8217;ll have the <code>update</code> hook look at those rules, see what files are being introduced for all the commits being pushed, and determine whether the user doing the push has access to update all those files.</p>
</div>
<div class="paragraph">
<p>The first thing you&#8217;ll do is write your ACL.
Here you&#8217;ll use a format very much like the CVS ACL mechanism: it uses a series of lines, where the first field is <code>avail</code> or <code>unavail</code>, the next field is a comma-delimited list of the users to which the rule applies, and the last field is the path to which the rule applies (blank meaning open access).
All of these fields are delimited by a pipe (<code>|</code>) character.</p>
</div>
<div class="paragraph">
<p>In this case, you have a couple of administrators, some documentation writers with access to the <code>doc</code> directory, and one developer who only has access to the <code>lib</code> and <code>tests</code> directories, and your ACL file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>avail|nickh,pjhyett,defunkt,tpw
avail|usinclair,cdickens,ebronte|doc
avail|schacon|lib
avail|schacon|tests</code></pre>
</div>
</div>
<div class="paragraph">
<p>You begin by reading this data into a structure that you can use.
In this case, to keep the example simple, you&#8217;ll only enforce the <code>avail</code> directives.
Here is a method that gives you an associative array where the key is the user name and the value is an array of paths to which the user has write access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def get_acl_access_data(acl_file)
  # read in ACL data
  acl_file = File.read(acl_file).split("\n").reject { |line| line == '' }
  access = {}
  acl_file.each do |line|
    avail, users, path = line.split('|')
    next unless avail == 'avail'
    users.split(',').each do |user|
      access[user] ||= []
      access[user] &lt;&lt; path
    end
  end
  access
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the ACL file you looked at earlier, this <code>get_acl_access_data</code> method returns a data structure that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">{"defunkt"=&gt;[nil],
 "tpw"=&gt;[nil],
 "nickh"=&gt;[nil],
 "pjhyett"=&gt;[nil],
 "schacon"=&gt;["lib", "tests"],
 "cdickens"=&gt;["doc"],
 "usinclair"=&gt;["doc"],
 "ebronte"=&gt;["doc"]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you have the permissions sorted out, you need to determine what paths the commits being pushed have modified, so you can make sure the user who&#8217;s pushing has access to all of them.</p>
</div>
<div class="paragraph">
<p>You can pretty easily see what files have been modified in a single commit with the <code>--name-only</code> option to the <code>git log</code> command (mentioned briefly in Chapter 2):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -1 --name-only --pretty=format:'' 9f585d

README
lib/test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use the ACL structure returned from the <code>get_acl_access_data</code> method and check it against the listed files in each of the commits, you can determine whether the user has access to push all of their commits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># only allows certain users to modify certain subdirectories in a project
def check_directory_perms
  access = get_acl_access_data('acl')

  # see if anyone is trying to push something they can't
  new_commits = `git rev-list #{$oldrev}..#{$newrev}`.split("\n")
  new_commits.each do |rev|
    files_modified = `git log -1 --name-only --pretty=format:'' #{rev}`.split("\n")
    files_modified.each do |path|
      next if path.size == 0
      has_file_access = false
      access[$user].each do |access_path|
        if !access_path  # user has access to everything
           || (path.start_with? access_path) # access to this path
          has_file_access = true
        end
      end
      if !has_file_access
        puts "[POLICY] You do not have access to push to #{path}"
        exit 1
      end
    end
  end
end

check_directory_perms</code></pre>
</div>
</div>
<div class="paragraph">
<p>You get a list of new commits being pushed to your server with <code>git rev-list</code>.
Then, for each of those commits, you find which files are modified and make sure the user who&#8217;s pushing has access to all the paths being modified.</p>
</div>
<div class="paragraph">
<p>Now your users can&#8217;t push any commits with badly formed messages or with modified files outside of their designated paths.</p>
</div>
</div>
<div class="sect4">
<h5 id="_testing_it_out">Testing It Out</h5>
<div class="paragraph">
<p>If you run <code>chmod u+x .git/hooks/update</code>, which is the file into which you should have put all this code, and then try to push a commit with a non-compliant message, you get something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push -f origin master
Counting objects: 5, done.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 323 bytes, done.
Total 3 (delta 1), reused 0 (delta 0)
Unpacking objects: 100% (3/3), done.
Enforcing Policies...
(refs/heads/master) (8338c5) (c5b616)
[POLICY] Your message is not formatted correctly
error: hooks/update exited with error code 1
error: hook declined to update refs/heads/master
To git@gitserver:project.git
 ! [remote rejected] master -&gt; master (hook declined)
error: failed to push some refs to 'git@gitserver:project.git'</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple of interesting things here.
First, you see this where the hook starts running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Enforcing Policies...
(refs/heads/master) (fb8c72) (c56860)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you printed that out at the very beginning of your update script.
Anything your script echoes to <code>stdout</code> will be transferred to the client.</p>
</div>
<div class="paragraph">
<p>The next thing you&#8217;ll notice is the error message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[POLICY] Your message is not formatted correctly
error: hooks/update exited with error code 1
error: hook declined to update refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line was printed out by you, the other two were Git telling you that the update script exited non-zero and that is what is declining your push.
Lastly, you have this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>To git@gitserver:project.git
 ! [remote rejected] master -&gt; master (hook declined)
error: failed to push some refs to 'git@gitserver:project.git'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see a remote rejected message for each reference that your hook declined, and it tells you that it was declined specifically because of a hook failure.</p>
</div>
<div class="paragraph">
<p>Furthermore, if someone tries to edit a file they don&#8217;t have access to and push a commit containing it, they will see something similar.
For instance, if a documentation author tries to push a commit modifying something in the <code>lib</code> directory, they see</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[POLICY] You do not have access to push to lib/test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>From now on, as long as that <code>update</code> script is there and executable, your repository will never have a commit message without your pattern in it, and your users will be sandboxed.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_client_side_hooks_2">Client-Side Hooks</h4>
<div class="paragraph">
<p>The downside to this approach is the whining that will inevitably result when your users' commit pushes are rejected.
Having their carefully crafted work rejected at the last minute can be extremely frustrating and confusing; and furthermore, they will have to edit their history to correct it, which isn&#8217;t always for the faint of heart.</p>
</div>
<div class="paragraph">
<p>The answer to this dilemma is to provide some client-side hooks that users can run to notify them when they&#8217;re doing something that the server is likely to reject.
That way, they can correct any problems before committing and before those issues become more difficult to fix.
Because hooks aren&#8217;t transferred with a clone of a project, you must distribute these scripts some other way and then have your users copy them to their <code>.git/hooks</code> directory and make them executable.
You can distribute these hooks within the project or in a separate project, but Git won&#8217;t set them up automatically.</p>
</div>
<div class="paragraph">
<p>To begin, you should check your commit message just before each commit is recorded, so you know the server won&#8217;t reject your changes due to badly formatted commit messages.
To do this, you can add the <code>commit-msg</code> hook.
If you have it read the message from the file passed as the first argument and compare that to the pattern, you can force Git to abort the commit if there is no match:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby
message_file = ARGV[0]
message = File.read(message_file)

$regex = /\[ref: (\d+)\]/

if !$regex.match(message)
  puts "[POLICY] Your message is not formatted correctly"
  exit 1
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>If that script is in place (in <code>.git/hooks/commit-msg</code>) and executable, and you commit with a message that isn&#8217;t properly formatted, you see this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -am 'test'
[POLICY] Your message is not formatted correctly</code></pre>
</div>
</div>
<div class="paragraph">
<p>No commit was completed in that instance.
However, if your message contains the proper pattern, Git allows you to commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -am 'test [ref: 132]'
[master e05c914] test [ref: 132]
 1 file changed, 1 insertions(+), 0 deletions(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you want to make sure you aren&#8217;t modifying files that are outside your ACL scope.
If your project&#8217;s <code>.git</code> directory contains a copy of the ACL file you used previously, then the following <code>pre-commit</code> script will enforce those constraints for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

$user    = ENV['USER']

# [ insert acl_access_data method from above ]

# only allows certain users to modify certain subdirectories in a project
def check_directory_perms
  access = get_acl_access_data('.git/acl')

  files_modified = `git diff-index --cached --name-only HEAD`.split("\n")
  files_modified.each do |path|
    next if path.size == 0
    has_file_access = false
    access[$user].each do |access_path|
    if !access_path || (path.index(access_path) == 0)
      has_file_access = true
    end
    if !has_file_access
      puts "[POLICY] You do not have access to push to #{path}"
      exit 1
    end
  end
end

check_directory_perms</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is roughly the same script as the server-side part, but with two important differences.
First, the ACL file is in a different place, because this script runs from your working directory, not from your <code>.git</code> directory.
You have to change the path to the ACL file from this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">access = get_acl_access_data('acl')</code></pre>
</div>
</div>
<div class="paragraph">
<p>to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">access = get_acl_access_data('.git/acl')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other important difference is the way you get a listing of the files that have been changed.
Because the server-side method looks at the log of commits, and, at this point, the commit hasn&#8217;t been recorded yet, you must get your file listing from the staging area instead.
Instead of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">files_modified = `git log -1 --name-only --pretty=format:'' #{ref}`</code></pre>
</div>
</div>
<div class="paragraph">
<p>you have to use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">files_modified = `git diff-index --cached --name-only HEAD`</code></pre>
</div>
</div>
<div class="paragraph">
<p>But those are the only two differences – otherwise, the script works the same way.
One caveat is that it expects you to be running locally as the same user you push as to the remote machine.
If that is different, you must set the <code>$user</code> variable manually.</p>
</div>
<div class="paragraph">
<p>One other thing we can do here is make sure the user doesn&#8217;t push non-fast-forwarded references.
To get a reference that isn&#8217;t a fast-forward, you either have to rebase past a commit you&#8217;ve already pushed up or try pushing a different local branch up to the same remote branch.</p>
</div>
<div class="paragraph">
<p>Presumably, the server is already configured with <code>receive.denyDeletes</code> and <code>receive.denyNonFastForwards</code> to enforce this policy, so the only accidental thing you can try to catch is rebasing commits that have already been pushed.</p>
</div>
<div class="paragraph">
<p>Here is an example pre-rebase script that checks for that.
It gets a list of all the commits you&#8217;re about to rewrite and checks whether they exist in any of your remote references.
If it sees one that is reachable from one of your remote references, it aborts the rebase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

base_branch = ARGV[0]
if ARGV[1]
  topic_branch = ARGV[1]
else
  topic_branch = "HEAD"
end

target_shas = `git rev-list #{base_branch}..#{topic_branch}`.split("\n")
remote_refs = `git branch -r`.split("\n").map { |r| r.strip }

target_shas.each do |sha|
  remote_refs.each do |remote_ref|
    shas_pushed = `git rev-list ^#{sha}^@ refs/remotes/#{remote_ref}`
    if shas_pushed.split("\n").include?(sha)
      puts "[POLICY] Commit #{sha} has already been pushed to #{remote_ref}"
      exit 1
    end
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script uses a syntax that wasn&#8217;t covered in the Revision Selection section of Chapter 6. You get a list of commits that have already been pushed up by running this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">`git rev-list ^#{sha}^@ refs/remotes/#{remote_ref}`
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>SHA^@</code> syntax resolves to all the parents of that commit.
You&#8217;re looking for any commit that is reachable from the last commit on the remote and that isn&#8217;t reachable from any parent of any of the SHAs you&#8217;re trying to push up – meaning it&#8217;s a fast-forward.</p>
</div>
<div class="paragraph">
<p>The main drawback to this approach is that it can be very slow and is often unnecessary – if you don&#8217;t try to force the push with <code>-f</code>, the server will warn you and not accept the push.
However, it&#8217;s an interesting exercise and can in theory help you avoid a rebase that you might later have to go back and fix.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_5">Summary</h3>
<div class="paragraph">
<p>We&#8217;ve covered most of the major ways that you can customize your Git client and server to best fit your workflow and projects.
You&#8217;ve learned about all sorts of configuration settings, file-based attributes, and event hooks, and you&#8217;ve built an example policy-enforcing server.
You should now be able to make Git fit nearly any workflow you can dream up.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_and_other_systems">Git and Other Systems</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The world isn&#8217;t perfect.
Usually, you can&#8217;t immediately switch every project you come in contact with to Git.
Sometimes you&#8217;re stuck on a project using another VCS, and wish it was Git.
We&#8217;ll spend the first part of this chapter learning about ways to use Git as a client when the project you&#8217;re working on is hosted in a different system.</p>
</div>
<div class="paragraph">
<p>At some point, you may want to convert your existing project to Git.
The second part of this chapter covers how to migrate your project into Git from several specific systems, as well as a method that will work if no pre-built import tool exists.</p>
</div>
<div class="sect2">
<h3 id="_git_as_a_client">Git as a Client</h3>
<div class="paragraph">
<p>
Git provides such a nice experience for developers that many people have figured out how to use it on their workstation, even if the rest of their team is using an entirely different VCS.
There are a number of these adapters, called &#8220;bridges,&#8221; available.
Here we&#8217;ll cover the ones you&#8217;re most likely to run into in the wild.</p>
</div>
<div class="sect3">
<h4 id="_git_svn">Git and Subversion</h4>
<div class="paragraph">
<p>
A large fraction of open source development projects and a good number of corporate projects use Subversion to manage their source code.
It&#8217;s been around for more than a decade, and for most of that time was the <em>de facto</em> VCS choice for open-source projects.
It&#8217;s also very similar in many ways to CVS, which was the big boy of the source-control world before that.</p>
</div>
<div class="paragraph">
<p>
One of Git&#8217;s great features is a bidirectional bridge to Subversion called <code>git svn</code>.
This tool allows you to use Git as a valid client to a Subversion server, so you can use all the local features of Git and then push to a Subversion server as if you were using Subversion locally.
This means you can do local branching and merging, use the staging area, use rebasing and cherry-picking, and so on, while your collaborators continue to work in their dark and ancient ways.
It&#8217;s a good way to sneak Git into the corporate environment and help your fellow developers become more efficient while you lobby to get the infrastructure changed to support Git fully.
The Subversion bridge is the gateway drug to the DVCS world.</p>
</div>
<div class="sect4">
<h5 id="__code_git_svn_code"><code>git svn</code></h5>
<div class="paragraph">
<p>The base command in Git for all the Subversion bridging commands is <code>git svn</code>.
It takes quite a few commands, so we&#8217;ll show the most common while going through a few simple workflows.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that when you&#8217;re using <code>git svn</code>, you&#8217;re interacting with Subversion, which is a system that works very differently from Git.
Although you <strong>can</strong> do local branching and merging, it&#8217;s generally best to keep your history as linear as possible by rebasing your work, and avoiding doing things like simultaneously interacting with a Git remote repository.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t rewrite your history and try to push again, and don&#8217;t push to a parallel Git repository to collaborate with fellow Git developers at the same time.
Subversion can have only a single linear history, and confusing it is very easy.
If you&#8217;re working with a team, and some are using SVN and others are using Git, make sure everyone is using the SVN server to collaborate – doing so will make your life easier.</p>
</div>
</div>
<div class="sect4">
<h5 id="_setting_up">Setting Up</h5>
<div class="paragraph">
<p>To demonstrate this functionality, you need a typical SVN repository that you have write access to.
If you want to copy these examples, you&#8217;ll have to make a writeable copy of my test repository.
In order to do that easily, you can use a tool called <code>svnsync</code> that comes with Subversion.
For these tests, we created a new Subversion repository on Google Code that was a partial copy of the <code>protobuf</code> project, which is a tool that encodes structured data for network transmission.</p>
</div>
<div class="paragraph">
<p>To follow along, you first need to create a new local Subversion repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ mkdir /tmp/test-svn
$ svnadmin create /tmp/test-svn</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, enable all users to change revprops – the easy way is to add a <code>pre-revprop-change</code> script that always exits 0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat /tmp/test-svn/hooks/pre-revprop-change
#!/bin/sh
exit 0;
$ chmod +x /tmp/test-svn/hooks/pre-revprop-change</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now sync this project to your local machine by calling <code>svnsync init</code> with the to and from repositories.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ svnsync init file:///tmp/test-svn http://progit-example.googlecode.com/svn/</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets up the properties to run the sync.
You can then clone the code by running</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ svnsync sync file:///tmp/test-svn
Committed revision 1.
Copied properties for revision 1.
Transmitting file data .............................[...]
Committed revision 2.
Copied properties for revision 2.
[…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this operation may take only a few minutes, if you try to copy the original repository to another remote repository instead of a local one, the process will take nearly an hour, even though there are fewer than 100 commits.
Subversion has to clone one revision at a time and then push it back into another repository – it&#8217;s ridiculously inefficient, but it&#8217;s the only easy way to do this.</p>
</div>
</div>
<div class="sect4">
<h5 id="_getting_started_2">Getting Started</h5>
<div class="paragraph">
<p>Now that you have a Subversion repository to which you have write access, you can go through a typical workflow.
You&#8217;ll start with the <code>git svn clone</code> command, which imports an entire Subversion repository into a local Git repository.
Remember that if you&#8217;re importing from a real hosted Subversion repository, you should replace the <code>file:///tmp/test-svn</code> here with the URL of your Subversion repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn clone file:///tmp/test-svn -T trunk -b branches -t tags
Initialized empty Git repository in /private/tmp/progit/test-svn/.git/
r1 = dcbfb5891860124cc2e8cc616cded42624897125 (refs/remotes/origin/trunk)
    A	m4/acx_pthread.m4
    A	m4/stl_hash.m4
    A	java/src/test/java/com/google/protobuf/UnknownFieldSetTest.java
    A	java/src/test/java/com/google/protobuf/WireFormatTest.java
…
r75 = 556a3e1e7ad1fde0a32823fc7e4d046bcfd86dae (refs/remotes/origin/trunk)
Found possible branch point: file:///tmp/test-svn/trunk =&gt; file:///tmp/test-svn/branches/my-calc-branch, 75
Found branch parent: (refs/remotes/origin/my-calc-branch) 556a3e1e7ad1fde0a32823fc7e4d046bcfd86dae
Following parent with do_switch
Successfully followed parent
r76 = 0fb585761df569eaecd8146c71e58d70147460a2 (refs/remotes/origin/my-calc-branch)
Checked out HEAD:
  file:///tmp/test-svn/trunk r75</code></pre>
</div>
</div>
<div class="paragraph">
<p>This runs the equivalent of two commands – <code>git svn init</code> followed by <code>git svn fetch</code> – on the URL you provide.
This can take a while.
The test project has only about 75 commits and the codebase isn&#8217;t that big, but Git has to check out each version, one at a time, and commit it individually.
For a project with hundreds or thousands of commits, this can literally take hours or even days to finish.</p>
</div>
<div class="paragraph">
<p>The <code>-T trunk -b branches -t tags</code> part tells Git that this Subversion repository follows the basic branching and tagging conventions.
If you name your trunk, branches, or tags differently, you can change these options.
Because this is so common, you can replace this entire part with <code>-s</code>, which means standard layout and implies all those options.
The following command is equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn clone file:///tmp/test-svn -s</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, you should have a valid Git repository that has imported your branches and tags:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -a
* master
  remotes/origin/my-calc-branch
  remotes/origin/tags/2.0.2
  remotes/origin/tags/release-2.0.1
  remotes/origin/tags/release-2.0.2
  remotes/origin/tags/release-2.0.2rc1
  remotes/origin/trunk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how this tool manages Subversion tags as remote refs.

Let&#8217;s take a closer look with the Git plumbing command <code>show-ref</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show-ref
556a3e1e7ad1fde0a32823fc7e4d046bcfd86dae refs/heads/master
0fb585761df569eaecd8146c71e58d70147460a2 refs/remotes/origin/my-calc-branch
bfd2d79303166789fc73af4046651a4b35c12f0b refs/remotes/origin/tags/2.0.2
285c2b2e36e467dd4d91c8e3c0c0e1750b3fe8ca refs/remotes/origin/tags/release-2.0.1
cbda99cb45d9abcb9793db1d4f70ae562a969f1e refs/remotes/origin/tags/release-2.0.2
a9f074aa89e826d6f9d30808ce5ae3ffe711feda refs/remotes/origin/tags/release-2.0.2rc1
556a3e1e7ad1fde0a32823fc7e4d046bcfd86dae refs/remotes/origin/trunk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git doesn&#8217;t do this when it clones from a Git server; here&#8217;s what a repository with tags looks like after a fresh clone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git show-ref
c3dcbe8488c6240392e8a5d7553bbffcb0f94ef0 refs/remotes/origin/master
32ef1d1c7cc8c603ab78416262cc421b80a8c2df refs/remotes/origin/branch-1
75f703a3580a9b81ead89fe1138e6da858c5ba18 refs/remotes/origin/branch-2
23f8588dde934e8f33c263c6d8359b2ae095f863 refs/tags/v0.1.0
7064938bd5e7ef47bfd79a685a62c1e2649e2ce7 refs/tags/v0.2.0
6dcb09b5b57875f334f61aebed695e2e4193db5e refs/tags/v1.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git fetches the tags directly into <code>refs/tags</code>, rather than treating them remote branches.</p>
</div>
</div>
<div class="sect4">
<h5 id="_committing_back_to_subversion">Committing Back to Subversion</h5>
<div class="paragraph">
<p>Now that you have a working repository, you can do some work on the project and push your commits back upstream, using Git effectively as a SVN client.
If you edit one of the files and commit it, you have a commit that exists in Git locally that doesn&#8217;t exist on the Subversion server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git commit -am 'Adding git-svn instructions to the README'
[master 4af61fd] Adding git-svn instructions to the README
 1 file changed, 5 insertions(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you need to push your change upstream.
Notice how this changes the way you work with Subversion – you can do several commits offline and then push them all at once to the Subversion server.
To push to a Subversion server, you run the <code>git svn dcommit</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn dcommit
Committing to file:///tmp/test-svn/trunk ...
    M	README.txt
Committed r77
    M	README.txt
r77 = 95e0222ba6399739834380eb10afcd73e0670bc5 (refs/remotes/origin/trunk)
No changes between 4af61fd05045e07598c553167e0f31c84fd6ffe1 and refs/remotes/origin/trunk
Resetting to the latest refs/remotes/origin/trunk</code></pre>
</div>
</div>
<div class="paragraph">
<p>This takes all the commits you&#8217;ve made on top of the Subversion server code, does a Subversion commit for each, and then rewrites your local Git commit to include a unique identifier.
This is important because it means that all the SHA-1 checksums for your commits change.
Partly for this reason, working with Git-based remote versions of your projects concurrently with a Subversion server isn&#8217;t a good idea.
If you look at the last commit, you can see the new <code>git-svn-id</code> that was added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -1
commit 95e0222ba6399739834380eb10afcd73e0670bc5
Author: ben &lt;ben@0b684db3-b064-4277-89d1-21af03df0a68&gt;
Date:   Thu Jul 24 03:08:36 2014 +0000

    Adding git-svn instructions to the README

    git-svn-id: file:///tmp/test-svn/trunk@77 0b684db3-b064-4277-89d1-21af03df0a68</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the SHA checksum that originally started with <code>4af61fd</code> when you committed now begins with <code>95e0222</code>.
If you want to push to both a Git server and a Subversion server, you have to push (<code>dcommit</code>) to the Subversion server first, because that action changes your commit data.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pulling_in_new_changes">Pulling in New Changes</h5>
<div class="paragraph">
<p>If you&#8217;re working with other developers, then at some point one of you will push, and then the other one will try to push a change that conflicts.
That change will be rejected until you merge in their work.
In <code>git svn</code>, it looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn dcommit
Committing to file:///tmp/test-svn/trunk ...

ERROR from SVN:
Transaction is out of date: File '/trunk/README.txt' is out of date
W: d5837c4b461b7c0e018b49d12398769d2bfc240a and refs/remotes/origin/trunk differ, using rebase:
:100644 100644 f414c433af0fd6734428cf9d2a9fd8ba00ada145 c80b6127dd04f5fcda218730ddf3a2da4eb39138 M	README.txt
Current branch master is up to date.
ERROR: Not all changes have been committed into SVN, however the committed
ones (if any) seem to be successfully integrated into the working tree.
Please see the above messages for details.</code></pre>
</div>
</div>
<div class="paragraph">
<p>To resolve this situation, you can run <code>git svn rebase</code>, which pulls down any changes on the server that you don&#8217;t have yet and rebases any work you have on top of what is on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn rebase
Committing to file:///tmp/test-svn/trunk ...

ERROR from SVN:
Transaction is out of date: File '/trunk/README.txt' is out of date
W: eaa029d99f87c5c822c5c29039d19111ff32ef46 and refs/remotes/origin/trunk differ, using rebase:
:100644 100644 65536c6e30d263495c17d781962cfff12422693a b34372b25ccf4945fe5658fa381b075045e7702a M	README.txt
First, rewinding head to replay your work on top of it...
Applying: update foo
Using index info to reconstruct a base tree...
M	README.txt
Falling back to patching base and 3-way merge...
Auto-merging README.txt
ERROR: Not all changes have been committed into SVN, however the committed
ones (if any) seem to be successfully integrated into the working tree.
Please see the above messages for details.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, all your work is on top of what is on the Subversion server, so you can successfully <code>dcommit</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn dcommit
Committing to file:///tmp/test-svn/trunk ...
    M	README.txt
Committed r85
    M	README.txt
r85 = 9c29704cc0bbbed7bd58160cfb66cb9191835cd8 (refs/remotes/origin/trunk)
No changes between 5762f56732a958d6cfda681b661d2a239cc53ef5 and refs/remotes/origin/trunk
Resetting to the latest refs/remotes/origin/trunk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that unlike Git, which requires you to merge upstream work you don&#8217;t yet have locally before you can push, <code>git svn</code> makes you do that only if the changes conflict (much like how Subversion works).
If someone else pushes a change to one file and then you push a change to another file, your <code>dcommit</code> will work fine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn dcommit
Committing to file:///tmp/test-svn/trunk ...
    M	configure.ac
Committed r87
    M	autogen.sh
r86 = d8450bab8a77228a644b7dc0e95977ffc61adff7 (refs/remotes/origin/trunk)
    M	configure.ac
r87 = f3653ea40cb4e26b6281cec102e35dcba1fe17c4 (refs/remotes/origin/trunk)
W: a0253d06732169107aa020390d9fefd2b1d92806 and refs/remotes/origin/trunk differ, using rebase:
:100755 100755 efa5a59965fbbb5b2b0a12890f1b351bb5493c18 e757b59a9439312d80d5d43bb65d4a7d0389ed6d M	autogen.sh
First, rewinding head to replay your work on top of it...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is important to remember, because the outcome is a project state that didn&#8217;t exist on either of your computers when you pushed.
If the changes are incompatible but don&#8217;t conflict, you may get issues that are difficult to diagnose.
This is different than using a Git server – in Git, you can fully test the state on your client system before publishing it, whereas in SVN, you can&#8217;t ever be certain that the states immediately before commit and after commit are identical.</p>
</div>
<div class="paragraph">
<p>You should also run this command to pull in changes from the Subversion server, even if you&#8217;re not ready to commit yourself.
You can run <code>git svn fetch</code> to grab the new data, but <code>git svn rebase</code> does the fetch and then updates your local commits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn rebase
    M	autogen.sh
r88 = c9c5f83c64bd755368784b444bc7a0216cc1e17b (refs/remotes/origin/trunk)
First, rewinding head to replay your work on top of it...
Fast-forwarded master to refs/remotes/origin/trunk.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running <code>git svn rebase</code> every once in a while makes sure your code is always up to date.
You need to be sure your working directory is clean when you run this, though.
If you have local changes, you must either stash your work or temporarily commit it before running <code>git svn rebase</code> – otherwise, the command will stop if it sees that the rebase will result in a merge conflict.</p>
</div>
</div>
<div class="sect4">
<h5 id="_git_branching_issues">Git Branching Issues</h5>
<div class="paragraph">
<p>When you&#8217;ve become comfortable with a Git workflow, you&#8217;ll likely create topic branches, do work on them, and then merge them in.
If you&#8217;re pushing to a Subversion server via <code>git svn</code>, you may want to rebase your work onto a single branch each time instead of merging branches together.
The reason to prefer rebasing is that Subversion has a linear history and doesn&#8217;t deal with merges like Git does, so <code>git svn</code> follows only the first parent when converting the snapshots into Subversion commits.</p>
</div>
<div class="paragraph">
<p>Suppose your history looks like the following: you created an <code>experiment</code> branch, did two commits, and then merged them back into <code>master</code>.
When you <code>dcommit</code>, you see output like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn dcommit
Committing to file:///tmp/test-svn/trunk ...
    M	CHANGES.txt
Committed r89
    M	CHANGES.txt
r89 = 89d492c884ea7c834353563d5d913c6adf933981 (refs/remotes/origin/trunk)
    M	COPYING.txt
    M	INSTALL.txt
Committed r90
    M	INSTALL.txt
    M	COPYING.txt
r90 = cb522197870e61467473391799148f6721bcf9a0 (refs/remotes/origin/trunk)
No changes between 71af502c214ba13123992338569f4669877f55fd and refs/remotes/origin/trunk
Resetting to the latest refs/remotes/origin/trunk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running <code>dcommit</code> on a branch with merged history works fine, except that when you look at your Git project history, it hasn&#8217;t rewritten either of the commits you made on the <code>experiment</code> branch – instead, all those changes appear in the SVN version of the single merge commit.</p>
</div>
<div class="paragraph">
<p>When someone else clones that work, all they see is the merge commit with all the work squashed into it, as though you ran <code>git merge --squash</code>; they don&#8217;t see the commit data about where it came from or when it was committed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_subversion_branching">Subversion Branching</h5>
<div class="paragraph">
<p>Branching in Subversion isn&#8217;t the same as branching in Git; if you can avoid using it much, that&#8217;s probably best.
However, you can create and commit to branches in Subversion using git svn.</p>
</div>
</div>
<div class="sect4">
<h5 id="_creating_a_new_svn_branch">Creating a New SVN Branch</h5>
<div class="paragraph">
<p>To create a new branch in Subversion, you run <code>git svn branch [branchname]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn branch opera
Copying file:///tmp/test-svn/trunk at r90 to file:///tmp/test-svn/branches/opera...
Found possible branch point: file:///tmp/test-svn/trunk =&gt; file:///tmp/test-svn/branches/opera, 90
Found branch parent: (refs/remotes/origin/opera) cb522197870e61467473391799148f6721bcf9a0
Following parent with do_switch
Successfully followed parent
r91 = f1b64a3855d3c8dd84ee0ef10fa89d27f1584302 (refs/remotes/origin/opera)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This does the equivalent of the <code>svn copy trunk branches/opera</code> command in Subversion and operates on the Subversion server.
It&#8217;s important to note that it doesn&#8217;t check you out into that branch; if you commit at this point, that commit will go to <code>trunk</code> on the server, not <code>opera</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_switching_active_branches">Switching Active Branches</h5>
<div class="paragraph">
<p>Git figures out what branch your dcommits go to by looking for the tip of any of your Subversion branches in your history – you should have only one, and it should be the last one with a <code>git-svn-id</code> in your current branch history.</p>
</div>
<div class="paragraph">
<p>If you want to work on more than one branch simultaneously, you can set up local branches to <code>dcommit</code> to specific Subversion branches by starting them at the imported Subversion commit for that branch.
If you want an <code>opera</code> branch that you can work on separately, you can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch opera remotes/origin/opera</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if you want to merge your <code>opera</code> branch into <code>trunk</code> (your <code>master</code> branch), you can do so with a normal <code>git merge</code>.
But you need to provide a descriptive commit message (via <code>-m</code>), or the merge will say &#8220;Merge branch opera&#8221; instead of something useful.</p>
</div>
<div class="paragraph">
<p>Remember that although you&#8217;re using <code>git merge</code> to do this operation, and the merge likely will be much easier than it would be in Subversion (because Git will automatically detect the appropriate merge base for you), this isn&#8217;t a normal Git merge commit.
You have to push this data back to a Subversion server that can&#8217;t handle a commit that tracks more than one parent; so, after you push it up, it will look like a single commit that squashed in all the work of another branch under a single commit.
After you merge one branch into another, you can&#8217;t easily go back and continue working on that branch, as you normally can in Git.
The <code>dcommit</code> command that you run erases any information that says what branch was merged in, so subsequent merge-base calculations will be wrong – the dcommit makes your <code>git merge</code> result look like you ran <code>git merge --squash</code>.
Unfortunately, there&#8217;s no good way to avoid this situation – Subversion can&#8217;t store this information, so you&#8217;ll always be crippled by its limitations while you&#8217;re using it as your server.
To avoid issues, you should delete the local branch (in this case, <code>opera</code>) after you merge it into trunk.</p>
</div>
</div>
<div class="sect4">
<h5 id="_subversion_commands">Subversion Commands</h5>
<div class="paragraph">
<p>The <code>git svn</code> toolset provides a number of commands to help ease the transition to Git by providing some functionality that&#8217;s similar to what you had in Subversion.
Here are a few commands that give you what Subversion used to.</p>
</div>
<div class="sect5">
<h6 id="_svn_style_history">SVN Style History</h6>
<div class="paragraph">
<p>If you&#8217;re used to Subversion and want to see your history in SVN output style, you can run <code>git svn log</code> to view your commit history in SVN formatting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn log
------------------------------------------------------------------------
r87 | schacon | 2014-05-02 16:07:37 -0700 (Sat, 02 May 2014) | 2 lines

autogen change

------------------------------------------------------------------------
r86 | schacon | 2014-05-02 16:00:21 -0700 (Sat, 02 May 2014) | 2 lines

Merge branch 'experiment'

------------------------------------------------------------------------
r85 | schacon | 2014-05-02 16:00:09 -0700 (Sat, 02 May 2014) | 2 lines

updated the changelog</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should know two important things about <code>git svn log</code>.
First, it works offline, unlike the real <code>svn log</code> command, which asks the Subversion server for the data.
Second, it only shows you commits that have been committed up to the Subversion server.
Local Git commits that you haven&#8217;t dcommited don&#8217;t show up; neither do commits that people have made to the Subversion server in the meantime.
It&#8217;s more like the last known state of the commits on the Subversion server.</p>
</div>
</div>
<div class="sect5">
<h6 id="_svn_annotation">SVN Annotation</h6>
<div class="paragraph">
<p>Much as the <code>git svn log</code> command simulates the <code>svn log</code> command offline, you can get the equivalent of <code>svn annotate</code> by running <code>git svn blame [FILE]</code>.
The output looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn blame README.txt
 2   temporal Protocol Buffers - Google's data interchange format
 2   temporal Copyright 2008 Google Inc.
 2   temporal http://code.google.com/apis/protocolbuffers/
 2   temporal
22   temporal C++ Installation - Unix
22   temporal =======================
 2   temporal
79    schacon Committing in git-svn.
78    schacon
 2   temporal To build and install the C++ Protocol Buffer runtime and the Protocol
 2   temporal Buffer compiler (protoc) execute the following:
 2   temporal</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, it doesn&#8217;t show commits that you did locally in Git or that have been pushed to Subversion in the meantime.</p>
</div>
</div>
<div class="sect5">
<h6 id="_svn_server_information">SVN Server Information</h6>
<div class="paragraph">
<p>You can also get the same sort of information that <code>svn info</code> gives you by running <code>git svn info</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn info
Path: .
URL: https://schacon-test.googlecode.com/svn/trunk
Repository Root: https://schacon-test.googlecode.com/svn
Repository UUID: 4c93b258-373f-11de-be05-5f7a86268029
Revision: 87
Node Kind: directory
Schedule: normal
Last Changed Author: schacon
Last Changed Rev: 87
Last Changed Date: 2009-05-02 16:07:37 -0700 (Sat, 02 May 2009)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is like <code>blame</code> and <code>log</code> in that it runs offline and is up to date only as of the last time you communicated with the Subversion server.</p>
</div>
</div>
<div class="sect5">
<h6 id="_ignoring_what_subversion_ignores">Ignoring What Subversion Ignores</h6>
<div class="paragraph">
<p>If you clone a Subversion repository that has <code>svn:ignore</code> properties set anywhere, you&#8217;ll likely want to set corresponding <code>.gitignore</code> files so you don&#8217;t accidentally commit files that you shouldn&#8217;t.
<code>git svn</code> has two commands to help with this issue.
The first is <code>git svn create-ignore</code>, which automatically creates corresponding <code>.gitignore</code> files for you so your next commit can include them.</p>
</div>
<div class="paragraph">
<p>The second command is <code>git svn show-ignore</code>, which prints to stdout the lines you need to put in a <code>.gitignore</code> file so you can redirect the output into your project exclude file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn show-ignore &gt; .git/info/exclude</code></pre>
</div>
</div>
<div class="paragraph">
<p>That way, you don&#8217;t litter the project with <code>.gitignore</code> files.
This is a good option if you&#8217;re the only Git user on a Subversion team, and your teammates don&#8217;t want <code>.gitignore</code> files in the project.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_git_svn_summary">Git-Svn Summary</h5>
<div class="paragraph">
<p>The <code>git svn</code> tools are useful if you&#8217;re stuck with a Subversion server, or are otherwise in a development environment that necessitates running a Subversion server.
You should consider it crippled Git, however, or you&#8217;ll hit issues in translation that may confuse you and your collaborators.
To stay out of trouble, try to follow these guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep a linear Git history that doesn&#8217;t contain merge commits made by <code>git merge</code>.
Rebase any work you do outside of your mainline branch back onto it; don&#8217;t merge it in.</p>
</li>
<li>
<p>Don&#8217;t set up and collaborate on a separate Git server.
Possibly have one to speed up clones for new developers, but don&#8217;t push anything to it that doesn&#8217;t have a <code>git-svn-id</code> entry.
You may even want to add a <code>pre-receive</code> hook that checks each commit message for a <code>git-svn-id</code> and rejects pushes that contain commits without it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you follow those guidelines, working with a Subversion server can be more bearable.
However, if it&#8217;s possible to move to a real Git server, doing so can gain your team a lot more.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_and_mercurial">Git and Mercurial</h4>
<div class="paragraph">
<p>

The DVCS universe is larger than just Git.
In fact, there are many other systems in this space, each with their own angle on how to do distributed version control correctly.
Apart from Git, the most popular is Mercurial, and the two are very similar in many respects.</p>
</div>
<div class="paragraph">
<p>The good news, if you prefer Git&#8217;s client-side behavior but are working with a project whose source code is controlled with Mercurial, is that there&#8217;s a way to use Git as a client for a Mercurial-hosted repository.
Since the way Git talks to server repositories is through remotes, it should come as no surprise that this bridge is implemented as a remote helper.
The project&#8217;s name is git-remote-hg, and it can be found at <a href="https://github.com/felipec/git-remote-hg" class="bare">https://github.com/felipec/git-remote-hg</a>.</p>
</div>
<div class="sect4">
<h5 id="_git_remote_hg">git-remote-hg</h5>
<div class="paragraph">
<p>First, you need to install git-remote-hg.
This basically entails dropping its file somewhere in your path, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ curl -o ~/bin/git-remote-hg \
  https://raw.githubusercontent.com/felipec/git-remote-hg/master/git-remote-hg
$ chmod +x ~/bin/git-remote-hg</code></pre>
</div>
</div>
<div class="paragraph">
<p>…assuming <code>~/bin</code> is in your <code>$PATH</code>.
Git-remote-hg has one other dependency: the <code>mercurial</code> library for Python.
If you have Python installed, this is as simple as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ pip install mercurial</code></pre>
</div>
</div>
<div class="paragraph">
<p>(If you don&#8217;t have Python installed, visit <a href="https://www.python.org/" class="bare">https://www.python.org/</a> and get it first.)</p>
</div>
<div class="paragraph">
<p>The last thing you&#8217;ll need is the Mercurial client.
Go to <a href="http://mercurial.selenic.com/" class="bare">http://mercurial.selenic.com/</a> and install it if you haven&#8217;t already.</p>
</div>
<div class="paragraph">
<p>Now you&#8217;re ready to rock.
All you need is a Mercurial repository you can push to.
Fortunately, every Mercurial repository can act this way, so we&#8217;ll just use the "hello world" repository everyone uses to learn Mercurial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg clone http://selenic.com/repo/hello /tmp/hello</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_getting_started_3">Getting Started</h5>
<div class="paragraph">
<p>Now that we have a suitable &#8220;server-side&#8221; repository, we can go through a typical workflow.
As you&#8217;ll see, these two systems are similar enough that there isn&#8217;t much friction.</p>
</div>
<div class="paragraph">
<p>As always with Git, first we clone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone hg::/tmp/hello /tmp/hello-git
$ cd /tmp/hello-git
$ git log --oneline --graph --decorate
* ac7955c (HEAD, origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master, master) Create a makefile
* 65bb417 Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice that working with a Mercurial repository uses the standard <code>git clone</code> command.
That&#8217;s because git-remote-hg is working at a fairly low level, using a similar mechanism to how Git&#8217;s HTTP/S protocol is implemented (remote helpers).
Since Git and Mercurial are both designed for every client to have a full copy of the repository history, this command makes a full clone, including all the project&#8217;s history, and does it fairly quickly.</p>
</div>
<div class="paragraph">
<p>The log command shows two commits, the latest of which is pointed to by a whole slew of refs.
It turns out some of these aren&#8217;t actually there.
Let&#8217;s take a look at what&#8217;s actually in the <code>.git</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ tree .git/refs
.git/refs
├── heads
│   └── master
├── hg
│   └── origin
│       ├── bookmarks
│       │   └── master
│       └── branches
│           └── default
├── notes
│   └── hg
├── remotes
│   └── origin
│       └── HEAD
└── tags

9 directories, 5 files</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git-remote-hg is trying to make things more idiomatically Git-esque, but under the hood it&#8217;s managing the conceptual mapping between two slightly different systems.
The <code>refs/hg</code> directory is where the actual remote refs are stored.
For example, the <code>refs/hg/origin/branches/default</code> is a Git ref file that contains the SHA starting with &#8220;ac7955c&#8221;, which is the commit that <code>master</code> points to.
So the <code>refs/hg</code> directory is kind of like a fake <code>refs/remotes/origin</code>, but it has the added distinction between bookmarks and branches.</p>
</div>
<div class="paragraph">
<p>The <code>notes/hg</code> file is the starting point for how git-remote-hg maps Git commit hashes to Mercurial changeset IDs.
Let&#8217;s explore a bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat notes/hg
d4c10386...

$ git cat-file -p d4c10386...
tree 1781c96...
author remote-hg &lt;&gt; 1408066400 -0800
committer remote-hg &lt;&gt; 1408066400 -0800

Notes for master

$ git ls-tree 1781c96...
100644 blob ac9117f...	65bb417...
100644 blob 485e178...	ac7955c...

$ git cat-file -p ac9117f
0a04b987be5ae354b710cefeba0e2d9de7ad41a9</code></pre>
</div>
</div>
<div class="paragraph">
<p>So <code>refs/notes/hg</code> points to a tree, which in the Git object database is a list of other objects with names.
<code>git ls-tree</code> outputs the mode, type, object hash, and filename for items inside a tree.
Once we dig down to one of the tree items, we find that inside it is a blob named &#8220;ac9117f&#8221; (the SHA-1 hash of the commit pointed to by <code>master</code>), with contents &#8220;0a04b98&#8221; (which is the ID of the Mercurial changeset at the tip of the <code>default</code> branch).</p>
</div>
<div class="paragraph">
<p>The good news is that we mostly don&#8217;t have to worry about all of this.
The typical workflow won&#8217;t be very different from working with a Git remote.</p>
</div>
<div class="paragraph">
<p>There&#8217;s one more thing we should attend to before we continue: ignores.
Mercurial and Git use a very similar mechanism for this, but it&#8217;s likely you don&#8217;t want to actually commit a <code>.gitignore</code> file into a Mercurial repository.
Fortunately, Git has a way to ignore files that&#8217;s local to an on-disk repository, and the Mercurial format is compatible with Git, so you just have to copy it over:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cp .hgignore .git/info/exclude</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>.git/info/exclude</code> file acts just like a <code>.gitignore</code>, but isn&#8217;t included in commits.</p>
</div>
</div>
<div class="sect4">
<h5 id="_workflow">Workflow</h5>
<div class="paragraph">
<p>Let&#8217;s assume we&#8217;ve done some work and made some commits on the <code>master</code> branch, and you&#8217;re ready to push it to the remote repository.
Here&#8217;s what our repository looks like right now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --graph --decorate
* ba04a2a (HEAD, master) Update makefile
* d25d16f Goodbye
* ac7955c (origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master) Create a makefile
* 65bb417 Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our <code>master</code> branch is two commits ahead of <code>origin/master</code>, but those two commits exist only on our local machine.
Let&#8217;s see if anyone else has been doing important work at the same time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch
From hg::/tmp/hello
   ac7955c..df85e87  master     -&gt; origin/master
   ac7955c..df85e87  branches/default -&gt; origin/branches/default
$ git log --oneline --graph --decorate --all
* 7b07969 (refs/notes/hg) Notes for default
* d4c1038 Notes for master
* df85e87 (origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master) Add some documentation
| * ba04a2a (HEAD, master) Update makefile
| * d25d16f Goodbye
|/
* ac7955c Create a makefile
* 65bb417 Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we used the <code>--all</code> flag, we see the &#8220;notes&#8221; refs that are used internally by git-remote-hg, but we can ignore them.
The rest is what we expected; <code>origin/master</code> has advanced by one commit, and our history has now diverged.
Unlike the other systems we work with in this chapter, Mercurial is capable of handling merges, so we&#8217;re not going to do anything fancy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge origin/master
Auto-merging hello.c
Merge made by the 'recursive' strategy.
 hello.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
$ git log --oneline --graph --decorate
*   0c64627 (HEAD, master) Merge remote-tracking branch 'origin/master'
|\
| * df85e87 (origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master) Add some documentation
* | ba04a2a Update makefile
* | d25d16f Goodbye
|/
* ac7955c Create a makefile
* 65bb417 Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect.
We run the tests and everything passes, so we&#8217;re ready to share our work with the rest of the team:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push
To hg::/tmp/hello
   df85e87..0c64627  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it!
If you take a look at the Mercurial repository, you&#8217;ll see that this did what we&#8217;d expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg log -G --style compact
o    5[tip]:4,2   dc8fa4f932b8   2014-08-14 19:33 -0700   ben
|\     Merge remote-tracking branch 'origin/master'
| |
| o  4   64f27bcefc35   2014-08-14 19:27 -0700   ben
| |    Update makefile
| |
| o  3:1   4256fc29598f   2014-08-14 19:27 -0700   ben
| |    Goodbye
| |
@ |  2   7db0b4848b3c   2014-08-14 19:30 -0700   ben
|/     Add some documentation
|
o  1   82e55d328c8c   2005-08-26 01:21 -0700   mpm
|    Create a makefile
|
o  0   0a04b987be5a   2005-08-26 01:20 -0700   mpm
     Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>The changeset numbered <em>2</em> was made by Mercurial, and the changesets numbered <em>3</em> and <em>4</em> were made by git-remote-hg, by pushing commits made with Git.</p>
</div>
</div>
<div class="sect4">
<h5 id="_branches_and_bookmarks">Branches and Bookmarks</h5>
<div class="paragraph">
<p>Git has only one kind of branch: a reference that moves when commits are made.
In Mercurial, this kind of a reference is called a &#8220;bookmark,&#8221; and it behaves in much the same way as a Git branch.</p>
</div>
<div class="paragraph">
<p>Mercurial&#8217;s concept of a &#8220;branch&#8221; is more heavyweight.
The branch that a changeset is made on is recorded <em>with the changeset</em>, which means it will always be in the repository history.
Here&#8217;s an example of a commit that was made on the <code>develop</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg log -l 1
changeset:   6:8f65e5e02793
branch:      develop
tag:         tip
user:        Ben Straub &lt;ben@straub.cc&gt;
date:        Thu Aug 14 20:06:38 2014 -0700
summary:     More documentation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the line that begins with &#8220;branch&#8221;.
Git can&#8217;t really replicate this (and doesn&#8217;t need to; both types of branch can be represented as a Git ref), but git-remote-hg needs to understand the difference, because Mercurial cares.</p>
</div>
<div class="paragraph">
<p>Creating Mercurial bookmarks is as easy as creating Git branches.
On the Git side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b featureA
Switched to a new branch 'featureA'
$ git push origin featureA
To hg::/tmp/hello
 * [new branch]      featureA -&gt; featureA</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all there is to it.
On the Mercurial side, it looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg bookmarks
   featureA                  5:bd5ac26f11f9
$ hg log --style compact -G
@  6[tip]   8f65e5e02793   2014-08-14 20:06 -0700   ben
|    More documentation
|
o    5[featureA]:4,2   bd5ac26f11f9   2014-08-14 20:02 -0700   ben
|\     Merge remote-tracking branch 'origin/master'
| |
| o  4   0434aaa6b91f   2014-08-14 20:01 -0700   ben
| |    update makefile
| |
| o  3:1   318914536c86   2014-08-14 20:00 -0700   ben
| |    goodbye
| |
o |  2   f098c7f45c4f   2014-08-14 20:01 -0700   ben
|/     Add some documentation
|
o  1   82e55d328c8c   2005-08-26 01:21 -0700   mpm
|    Create a makefile
|
o  0   0a04b987be5a   2005-08-26 01:20 -0700   mpm
     Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the new <code>[featureA]</code> tag on revision 5.
These act exactly like Git branches on the Git side, with one exception: you can&#8217;t delete a bookmark from the Git side (this is a limitation of remote helpers).</p>
</div>
<div class="paragraph">
<p>You can work on a &#8220;heavyweight&#8221; Mercurial branch also: just put a branch in the <code>branches</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git checkout -b branches/permanent
Switched to a new branch 'branches/permanent'
$ vi Makefile
$ git commit -am 'A permanent change'
$ git push origin branches/permanent
To hg::/tmp/hello
 * [new branch]      branches/permanent -&gt; branches/permanent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what that looks like on the Mercurial side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg branches
permanent                      7:a4529d07aad4
develop                        6:8f65e5e02793
default                        5:bd5ac26f11f9 (inactive)
$ hg log -G
o  changeset:   7:a4529d07aad4
|  branch:      permanent
|  tag:         tip
|  parent:      5:bd5ac26f11f9
|  user:        Ben Straub &lt;ben@straub.cc&gt;
|  date:        Thu Aug 14 20:21:09 2014 -0700
|  summary:     A permanent change
|
| @  changeset:   6:8f65e5e02793
|/   branch:      develop
|    user:        Ben Straub &lt;ben@straub.cc&gt;
|    date:        Thu Aug 14 20:06:38 2014 -0700
|    summary:     More documentation
|
o    changeset:   5:bd5ac26f11f9
|\   bookmark:    featureA
| |  parent:      4:0434aaa6b91f
| |  parent:      2:f098c7f45c4f
| |  user:        Ben Straub &lt;ben@straub.cc&gt;
| |  date:        Thu Aug 14 20:02:21 2014 -0700
| |  summary:     Merge remote-tracking branch 'origin/master'
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The branch name &#8220;permanent&#8221; was recorded with the changeset marked <em>7</em>.</p>
</div>
<div class="paragraph">
<p>From the Git side, working with either of these branch styles is the same: just checkout, commit, fetch, merge, pull, and push as you normally would.
One thing you should know is that Mercurial doesn&#8217;t support rewriting history, only adding to it.
Here&#8217;s what our Mercurial repository looks like after an interactive rebase and a force-push:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg log --style compact -G
o  10[tip]   99611176cbc9   2014-08-14 20:21 -0700   ben
|    A permanent change
|
o  9   f23e12f939c3   2014-08-14 20:01 -0700   ben
|    Add some documentation
|
o  8:1   c16971d33922   2014-08-14 20:00 -0700   ben
|    goodbye
|
| o  7:5   a4529d07aad4   2014-08-14 20:21 -0700   ben
| |    A permanent change
| |
| | @  6   8f65e5e02793   2014-08-14 20:06 -0700   ben
| |/     More documentation
| |
| o    5[featureA]:4,2   bd5ac26f11f9   2014-08-14 20:02 -0700   ben
| |\     Merge remote-tracking branch 'origin/master'
| | |
| | o  4   0434aaa6b91f   2014-08-14 20:01 -0700   ben
| | |    update makefile
| | |
+---o  3:1   318914536c86   2014-08-14 20:00 -0700   ben
| |      goodbye
| |
| o  2   f098c7f45c4f   2014-08-14 20:01 -0700   ben
|/     Add some documentation
|
o  1   82e55d328c8c   2005-08-26 01:21 -0700   mpm
|    Create a makefile
|
o  0   0a04b987be5a   2005-08-26 01:20 -0700   mpm
     Create a standard "hello, world" program</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changesets <em>8</em>, <em>9</em>, and <em>10</em> have been created and belong to the <code>permanent</code> branch, but the old changesets are still there.
This can be <strong>very</strong> confusing for your teammates who are using Mercurial, so try to avoid it.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mercurial_summary">Mercurial Summary</h5>
<div class="paragraph">
<p>Git and Mercurial are similar enough that working across the boundary is fairly painless.
If you avoid changing history that&#8217;s left your machine (as is generally recommended), you may not even be aware that the other end is Mercurial.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_and_perforce">Git and Perforce</h4>
<div class="paragraph">
<p>

Perforce is a very popular version-control system in corporate environments.
It&#8217;s been around since 1995, which makes it the oldest system covered in this chapter.
As such, it&#8217;s designed with the constraints of its day; it assumes you&#8217;re always connected to a single central server, and only one version is kept on the local disk.
To be sure, its features and constraints are well-suited to several specific problems, but there are lots of projects using Perforce where Git would actually work better.</p>
</div>
<div class="paragraph">
<p>There are two options if you&#8217;d like to mix your use of Perforce and Git.
The first one we&#8217;ll cover is the &#8220;Git Fusion&#8221; bridge from the makers of Perforce, which lets you expose subtrees of your Perforce depot as read-write Git repositories.
The second is git-p4, a client-side bridge that lets you use Git as a Perforce client, without requiring any reconfiguration of the Perforce server.</p>
</div>
<div class="sect4">
<h5 id="_p4_git_fusion">Git Fusion</h5>
<div class="paragraph">
<p>
Perforce provides a product called Git Fusion (available at <a href="http://www.perforce.com/git-fusion" class="bare">http://www.perforce.com/git-fusion</a>), which synchronizes a Perforce server with Git repositories on the server side.</p>
</div>
<div class="sect5">
<h6 id="_setting_up_2">Setting Up</h6>
<div class="paragraph">
<p>For our examples, we&#8217;ll be using the easiest installation method for Git Fusion, which is downloading a virtual machine that runs the Perforce daemon and Git Fusion.
You can get the virtual machine image from <a href="http://www.perforce.com/downloads/Perforce/20-User" class="bare">http://www.perforce.com/downloads/Perforce/20-User</a>, and once it&#8217;s finished downloading, import it into your favorite virtualization software (we&#8217;ll use VirtualBox).</p>
</div>
<div class="paragraph">
<p>Upon first starting the machine, it asks you to customize the password for three Linux users (<code>root</code>, <code>perforce</code>, and <code>git</code>), and provide an instance name, which can be used to distinguish this installation from others on the same network. When that has all completed, you&#8217;ll see this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-fusion-boot.png" alt="The Git Fusion virtual machine boot screen.">
</div>
<div class="title">Figure 146. The Git Fusion virtual machine boot screen.</div>
</div>
<div class="paragraph">
<p>You should take note of the IP address that&#8217;s shown here, we&#8217;ll be using it later on.
Next, we&#8217;ll create a Perforce user.
Select the &#8220;Login&#8221; option at the bottom and press enter (or SSH to the machine), and log in as <code>root</code>.
Then use these commands to create a user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ p4 -p localhost:1666 -u super user -f john
$ p4 -p localhost:1666 -u john passwd
$ exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first one will open a VI editor to customize the user, but you can accept the defaults by typing <code>:wq</code> and hitting enter.
The second one will prompt you to enter a password twice.
That&#8217;s all we need to do with a shell prompt, so exit out of the session.</p>
</div>
<div class="paragraph">
<p>The next thing you&#8217;ll need to do to follow along is to tell Git not to verify SSL certificates.
The Git Fusion image comes with a certificate, but it&#8217;s for a domain that won&#8217;t match your virtual machine&#8217;s IP address, so Git will reject the HTTPS connection.
If this is going to be a permanent installation, consult the Perforce Git Fusion manual to install a different certificate; for our example purposes, this will suffice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ export GIT_SSL_NO_VERIFY=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can test that everything is working.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://10.0.1.254/Talkhouse
Cloning into 'Talkhouse'...
Username for 'https://10.0.1.254': john
Password for 'https://john@10.0.1.254':
remote: Counting objects: 630, done.
remote: Compressing objects: 100% (581/581), done.
remote: Total 630 (delta 172), reused 0 (delta 0)
Receiving objects: 100% (630/630), 1.22 MiB | 0 bytes/s, done.
Resolving deltas: 100% (172/172), done.
Checking connectivity... done.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The virtual-machine image comes equipped with a sample project that you can clone.
Here we&#8217;re cloning over HTTPS, with the <code>john</code> user that we created above; Git asks for credentials for this connection, but the credential cache will allow us to skip this step for any subsequent requests.</p>
</div>
</div>
<div class="sect5">
<h6 id="_fusion_configuration">Fusion Configuration</h6>
<div class="paragraph">
<p>Once you&#8217;ve got Git Fusion installed, you&#8217;ll want to tweak the configuration.
This is actually fairly easy to do using your favorite Perforce client; just map the <code>//.git-fusion</code> directory on the Perforce server into your workspace.
The file structure looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ tree
.
├── objects
│   ├── repos
│   │   └── [...]
│   └── trees
│       └── [...]
│
├── p4gf_config
├── repos
│   └── Talkhouse
│       └── p4gf_config
└── users
    └── p4gf_usermap

498 directories, 287 files</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>objects</code> directory is used internally by Git Fusion to map Perforce objects to Git and vice versa, you won&#8217;t have to mess with anything in there.
There&#8217;s a global <code>p4gf_config</code> file in this directory, as well as one for each repository – these are the configuration files that determine how Git Fusion behaves.
Let&#8217;s take a look at the file in the root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[repo-creation]
charset = utf8

[git-to-perforce]
change-owner = author
enable-git-branch-creation = yes
enable-swarm-reviews = yes
enable-git-merge-commits = yes
enable-git-submodules = yes
preflight-commit = none
ignore-author-permissions = no
read-permission-check = none
git-merge-avoidance-after-change-num = 12107

[perforce-to-git]
http-url = none
ssh-url = none

[@features]
imports = False
chunked-push = False
matrix2 = False
parallel-push = False

[authentication]
email-case-sensitivity = no</code></pre>
</div>
</div>
<div class="paragraph">
<p>We won&#8217;t go into the meanings of these flags here, but note that this is just an INI-formatted text file, much like Git uses for configuration.
This file specifies the global options, which can then be overridden by repository-specific configuration files, like <code>repos/Talkhouse/p4gf_config</code>.
If you open this file, you&#8217;ll see a <code>[@repo]</code> section with some settings that are different from the global defaults.
You&#8217;ll also see sections that look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[Talkhouse-master]
git-branch-name = master
view = //depot/Talkhouse/main-dev/... ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a mapping between a Perforce branch and a Git branch.
The section can be named whatever you like, so long as the name is unique.
<code>git-branch-name</code> lets you convert a depot path that would be cumbersome under Git to a more friendly name.
The <code>view</code> setting controls how Perforce files are mapped into the Git repository, using the standard view mapping syntax.
More than one mapping can be specified, like in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[multi-project-mapping]
git-branch-name = master
view = //depot/project1/main/... project1/...
       //depot/project2/mainline/... project2/...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, if your normal workspace mapping includes changes in the structure of the directories, you can replicate that with a Git repository.</p>
</div>
<div class="paragraph">
<p>The last file we&#8217;ll discuss is <code>users/p4gf_usermap</code>, which maps Perforce users to Git users, and which you may not even need.
When converting from a Perforce changeset to a Git commit, Git Fusion&#8217;s default behavior is to look up the Perforce user, and use the email address and full name stored there for the author/committer field in Git.
When converting the other way, the default is to look up the Perforce user with the email address stored in the Git commit&#8217;s author field, and submit the changeset as that user (with permissions applying).
In most cases, this behavior will do just fine, but consider the following mapping file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>john john@example.com "John Doe"
john johnny@appleseed.net "John Doe"
bob employeeX@example.com "Anon X. Mouse"
joe employeeY@example.com "Anon Y. Mouse"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each line is of the format <code>&lt;user&gt; &lt;email&gt; "&lt;full name&gt;"</code>, and creates a single user mapping.
The first two lines map two distinct email addresses to the same Perforce user account.
This is useful if you&#8217;ve created Git commits under several different email addresses (or change email addresses), but want them to be mapped to the same Perforce user.
When creating a Git commit from a Perforce changeset, the first line matching the Perforce user is used for Git authorship information.</p>
</div>
<div class="paragraph">
<p>The last two lines mask Bob and Joe&#8217;s actual names and email addresses from the Git commits that are created.
This is nice if you want to open-source an internal project, but don&#8217;t want to publish your employee directory to the entire world.
Note that the email addresses and full names should be unique, unless you want all the Git commits to be attributed to a single fictional author.</p>
</div>
</div>
<div class="sect5">
<h6 id="_workflow_2">Workflow</h6>
<div class="paragraph">
<p>Perforce Git Fusion is a two-way bridge between Perforce and Git version control.
Let&#8217;s have a look at how it feels to work from the Git side.
We&#8217;ll assume we&#8217;ve mapped in the &#8220;Jam&#8221; project using a configuration file as shown above, which we can clone like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone https://10.0.1.254/Jam
Cloning into 'Jam'...
Username for 'https://10.0.1.254': john
Password for 'https://ben@10.0.1.254':
remote: Counting objects: 2070, done.
remote: Compressing objects: 100% (1704/1704), done.
Receiving objects: 100% (2070/2070), 1.21 MiB | 0 bytes/s, done.
remote: Total 2070 (delta 1242), reused 0 (delta 0)
Resolving deltas: 100% (1242/1242), done.
Checking connectivity... done.
$ git branch -a
* master
  remotes/origin/HEAD -&gt; origin/master
  remotes/origin/master
  remotes/origin/rel2.1
$ git log --oneline --decorate --graph --all
* 0a38c33 (origin/rel2.1) Create Jam 2.1 release branch.
| * d254865 (HEAD, origin/master, origin/HEAD, master) Upgrade to latest metrowerks on Beos -- the Intel one.
| * bd2f54a Put in fix for jam's NT handle leak.
| * c0f29e7 Fix URL in a jam doc
| * cc644ac Radstone's lynx port.
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first time you do this, it may take some time.
What&#8217;s happening is that Git Fusion is converting all the applicable changesets in the Perforce history into Git commits.
This happens locally on the server, so it&#8217;s relatively fast, but if you have a lot of history, it can still take some time.
Subsequent fetches do incremental conversion, so it&#8217;ll feel more like Git&#8217;s native speed.</p>
</div>
<div class="paragraph">
<p>As you can see, our repository looks exactly like any other Git repository you might work with.
There are three branches, and Git has helpfully created a local <code>master</code> branch that tracks <code>origin/master</code>.
Let&#8217;s do a bit of work, and create a couple of new commits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># ...
$ git log --oneline --decorate --graph --all
* cfd46ab (HEAD, master) Add documentation for new feature
* a730d77 Whitespace
* d254865 (origin/master, origin/HEAD) Upgrade to latest metrowerks on Beos -- the Intel one.
* bd2f54a Put in fix for jam's NT handle leak.
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have two new commits.
Now let&#8217;s check if anyone else has been working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch
remote: Counting objects: 5, done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 3 (delta 2), reused 0 (delta 0)
Unpacking objects: 100% (3/3), done.
From https://10.0.1.254/Jam
   d254865..6afeb15  master     -&gt; origin/master
$ git log --oneline --decorate --graph --all
* 6afeb15 (origin/master, origin/HEAD) Update copyright
| * cfd46ab (HEAD, master) Add documentation for new feature
| * a730d77 Whitespace
|/
* d254865 Upgrade to latest metrowerks on Beos -- the Intel one.
* bd2f54a Put in fix for jam's NT handle leak.
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks like someone was!
You wouldn&#8217;t know it from this view, but the <code>6afeb15</code> commit was actually created using a Perforce client.
It just looks like another commit from Git&#8217;s point of view, which is exactly the point.
Let&#8217;s see how the Perforce server deals with a merge commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git merge origin/master
Auto-merging README
Merge made by the 'recursive' strategy.
 README | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
$ git push
Counting objects: 9, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (9/9), done.
Writing objects: 100% (9/9), 917 bytes | 0 bytes/s, done.
Total 9 (delta 6), reused 0 (delta 0)
remote: Perforce: 100% (3/3) Loading commit tree into memory...
remote: Perforce: 100% (5/5) Finding child commits...
remote: Perforce: Running git fast-export...
remote: Perforce: 100% (3/3) Checking commits...
remote: Processing will continue even if connection is closed.
remote: Perforce: 100% (3/3) Copying changelists...
remote: Perforce: Submitting new Git commit objects to Perforce: 4
To https://10.0.1.254/Jam
   6afeb15..89cba2b  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git thinks it worked.
Let&#8217;s take a look at the history of the <code>README</code> file from Perforce&#8217;s point of view, using the revision graph feature of <code>p4v</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-fusion-perforce-graph.png" alt="Perforce revision graph resulting from Git push.">
</div>
<div class="title">Figure 147. Perforce revision graph resulting from Git push.</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve never seen this view before, it may seem confusing, but it shows the same concepts as a graphical viewer for Git history.
We&#8217;re looking at the history of the <code>README</code> file, so the directory tree at top left only shows that file as it surfaces in various branches.
At top right, we have a visual graph of how different revisions of the file are related, and the big-picture view of this graph is at bottom right.
The rest of the view is given to the details view for the selected revision (<code>2</code> in this case).</p>
</div>
<div class="paragraph">
<p>One thing to notice is that the graph looks exactly like the one in Git&#8217;s history.
Perforce didn&#8217;t have a named branch to store the <code>1</code> and <code>2</code> commits, so it made an &#8220;anonymous&#8221; branch in the <code>.git-fusion</code> directory to hold it.
This will also happen for named Git branches that don&#8217;t correspond to a named Perforce branch (and you can later map them to a Perforce branch using the configuration file).</p>
</div>
<div class="paragraph">
<p>Most of this happens behind the scenes, but the end result is that one person on a team can be using Git, another can be using Perforce, and neither of them will know about the other&#8217;s choice.</p>
</div>
</div>
<div class="sect5">
<h6 id="_git_fusion_summary">Git-Fusion Summary</h6>
<div class="paragraph">
<p>If you have (or can get) access to your Perforce server, Git Fusion is a great way to make Git and Perforce talk to each other.
There&#8217;s a bit of configuration involved, but the learning curve isn&#8217;t very steep.
This is one of the few sections in this chapter where cautions about using Git&#8217;s full power will not appear.
That&#8217;s not to say that Perforce will be happy with everything you throw at it – if you try to rewrite history that&#8217;s already been pushed, Git Fusion will reject it – but Git Fusion tries very hard to feel native.
You can even use Git submodules (though they&#8217;ll look strange to Perforce users), and merge branches (this will be recorded as an integration on the Perforce side).</p>
</div>
<div class="paragraph">
<p>If you can&#8217;t convince the administrator of your server to set up Git Fusion, there is still a way to use these tools together.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_git_p4">Git-p4</h5>
<div class="paragraph">
<p>
Git-p4 is a two-way bridge between Git and Perforce.
It runs entirely inside your Git repository, so you won&#8217;t need any kind of access to the Perforce server (other than user credentials, of course).
Git-p4 isn&#8217;t as flexible or complete a solution as Git Fusion, but it does allow you to do most of what you&#8217;d want to do without being invasive to the server environment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You&#8217;ll need the <code>p4</code> tool somewhere in your <code>PATH</code> to work with git-p4.
As of this writing, it is freely available at <a href="http://www.perforce.com/downloads/Perforce/20-User" class="bare">http://www.perforce.com/downloads/Perforce/20-User</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_setting_up_3">Setting Up</h6>
<div class="paragraph">
<p>For example purposes, we&#8217;ll be running the Perforce server from the Git Fusion OVA as shown above, but we&#8217;ll bypass the Git Fusion server and go directly to the Perforce version control.</p>
</div>
<div class="paragraph">
<p>In order to use the <code>p4</code> command-line client (which git-p4 depends on), you&#8217;ll need to set a couple of environment variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ export P4PORT=10.0.1.254:1666
$ export P4USER=john</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_getting_started_4">Getting Started</h6>
<div class="paragraph">
<p>As with anything in Git, the first command is to clone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 clone //depot/www/live www-shallow
Importing from //depot/www/live into www-shallow
Initialized empty Git repository in /private/tmp/www-shallow/.git/
Doing initial import of //depot/www/live/ from revision #head into refs/remotes/p4/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates what in Git terms is a &#8220;shallow&#8221; clone; only the very latest Perforce revision is imported into Git; remember, Perforce isn&#8217;t designed to give every revision to every user.
This is enough to use Git as a Perforce client, but for other purposes it&#8217;s not enough.</p>
</div>
<div class="paragraph">
<p>Once it&#8217;s finished, we have a fully-functional Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd myproject
$ git log --oneline --all --graph --decorate
* 70eaf78 (HEAD, p4/master, p4/HEAD, master) Initial import of //depot/www/live/ from the state at revision #head</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how there&#8217;s a &#8220;p4&#8221; remote for the Perforce server, but everything else looks like a standard clone.
Actually, that&#8217;s a bit misleading; there isn&#8217;t actually a remote there.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>No remotes exist in this repository at all.
Git-p4 has created some refs to represent the state of the server, and they look like remote refs to <code>git log</code>, but they&#8217;re not managed by Git itself, and you can&#8217;t push to them.</p>
</div>
</div>
<div class="sect5">
<h6 id="_workflow_3">Workflow</h6>
<div class="paragraph">
<p>Okay, let&#8217;s do some work.
Let&#8217;s assume you&#8217;ve made some progress on a very important feature, and you&#8217;re ready to show it to the rest of your team.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --all --graph --decorate
* 018467c (HEAD, master) Change page title
* c0fb617 Update link
* 70eaf78 (p4/master, p4/HEAD) Initial import of //depot/www/live/ from the state at revision #head</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve made two new commits that we&#8217;re ready to submit to the Perforce server.
Let&#8217;s check if anyone else was working today:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 sync
git p4 sync
Performing incremental import into refs/remotes/p4/master git branch
Depot paths: //depot/www/live/
Import destination: refs/remotes/p4/master
Importing revision 12142 (100%)
$ git log --oneline --all --graph --decorate
* 75cd059 (p4/master, p4/HEAD) Update copyright
| * 018467c (HEAD, master) Change page title
| * c0fb617 Update link
|/
* 70eaf78 Initial import of //depot/www/live/ from the state at revision #head</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looks like they were, and <code>master</code> and <code>p4/master</code> have diverged.
Perforce&#8217;s branching system is <em>nothing</em> like Git&#8217;s, so submitting merge commits doesn&#8217;t make any sense.
Git-p4 recommends that you rebase your commits, and even comes with a shortcut to do so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 rebase
Performing incremental import into refs/remotes/p4/master git branch
Depot paths: //depot/www/live/
No changes to import!
Rebasing the current branch onto remotes/p4/master
First, rewinding head to replay your work on top of it...
Applying: Update link
Applying: Change page title
 index.html | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can probably tell from the output, but <code>git p4 rebase</code> is a shortcut for <code>git p4 sync</code> followed by <code>git rebase p4/master</code>.
It&#8217;s a bit smarter than that, especially when working with multiple branches, but this is a good approximation.</p>
</div>
<div class="paragraph">
<p>Now our history is linear again, and we&#8217;re ready to contribute our changes back to Perforce.
The <code>git p4 submit</code> command will try to create a new Perforce revision for every Git commit between <code>p4/master</code> and <code>master</code>.
Running it drops us into our favorite editor, and the contents of the file look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console"># A Perforce Change Specification.
#
#  Change:      The change number. 'new' on a new changelist.
#  Date:        The date this specification was last modified.
#  Client:      The client on which the changelist was created.  Read-only.
#  User:        The user who created the changelist.
#  Status:      Either 'pending' or 'submitted'. Read-only.
#  Type:        Either 'public' or 'restricted'. Default is 'public'.
#  Description: Comments about the changelist.  Required.
#  Jobs:        What opened jobs are to be closed by this changelist.
#               You may delete jobs from this list.  (New changelists only.)
#  Files:       What opened files from the default changelist are to be added
#               to this changelist.  You may delete files from this list.
#               (New changelists only.)

Change:  new

Client:  john_bens-mbp_8487

User: john

Status:  new

Description:
   Update link

Files:
   //depot/www/live/index.html   # edit


######## git author ben@straub.cc does not match your p4 account.
######## Use option --preserve-user to modify authorship.
######## Variable git-p4.skipUserNameCheck hides this message.
######## everything below this line is just the diff #######
--- //depot/www/live/index.html  2014-08-31 18:26:05.000000000 0000
+++ /Users/ben/john_bens-mbp_8487/john_bens-mbp_8487/depot/www/live/index.html   2014-08-31 18:26:05.000000000 0000
@@ -60,7 +60,7 @@
 &lt;/td&gt;
 &lt;td valign=top&gt;
 Source and documentation for
-&lt;a href="http://www.perforce.com/jam/jam.html"&gt;
+&lt;a href="jam.html"&gt;
 Jam/MR&lt;/a&gt;,
 a software build tool.
 &lt;/td&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is mostly the same content you&#8217;d see by running <code>p4 submit</code>, except the stuff at the end which git-p4 has helpfully included.
Git-p4 tries to honor your Git and Perforce settings individually when it has to provide a name for a commit or changeset, but in some cases you want to override it.
For example, if the Git commit you&#8217;re importing was written by a contributor who doesn&#8217;t have a Perforce user account, you may still want the resulting changeset to look like they write it (and not you).</p>
</div>
<div class="paragraph">
<p>Git-p4 has helpfully imported the message from the Git commit as the content for this Perforce changeset, so all we have to do is save and quit, twice (once for each commit).
The resulting shell output will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 submit
Perforce checkout for depot path //depot/www/live/ located at /Users/ben/john_bens-mbp_8487/john_bens-mbp_8487/depot/www/live/
Synchronizing p4 checkout...
... - file(s) up-to-date.
Applying dbac45b Update link
//depot/www/live/index.html#4 - opened for edit
Change 12143 created with 1 open file(s).
Submitting change 12143.
Locking 1 files ...
edit //depot/www/live/index.html#5
Change 12143 submitted.
Applying 905ec6a Change page title
//depot/www/live/index.html#5 - opened for edit
Change 12144 created with 1 open file(s).
Submitting change 12144.
Locking 1 files ...
edit //depot/www/live/index.html#6
Change 12144 submitted.
All commits applied!
Performing incremental import into refs/remotes/p4/master git branch
Depot paths: //depot/www/live/
Import destination: refs/remotes/p4/master
Importing revision 12144 (100%)
Rebasing the current branch onto remotes/p4/master
First, rewinding head to replay your work on top of it...
$ git log --oneline --all --graph --decorate
* 775a46f (HEAD, p4/master, p4/HEAD, master) Change page title
* 05f1ade Update link
* 75cd059 Update copyright
* 70eaf78 Initial import of //depot/www/live/ from the state at revision #head</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result is as though we just did a <code>git push</code>, which is the closest analogy to what actually did happen.</p>
</div>
<div class="paragraph">
<p>Note that during this process every Git commit is turned into a Perforce changeset; if you want to squash them down into a single changeset, you can do that with an interactive rebase before running <code>git p4 submit</code>.
Also note that the SHA hashes of all the commits that were submitted as changesets have changed; this is because git-p4 adds a line to the end of each commit it converts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -1
commit 775a46f630d8b46535fc9983cf3ebe6b9aa53145
Author: John Doe &lt;john@example.com&gt;
Date:   Sun Aug 31 10:31:44 2014 -0800

    Change page title

    [git-p4: depot-paths = "//depot/www/live/": change = 12144]</code></pre>
</div>
</div>
<div class="paragraph">
<p>What happens if you try to submit a merge commit?
Let&#8217;s give it a try.
Here&#8217;s the situation we&#8217;ve gotten ourselves into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --all --graph --decorate
* 3be6fd8 (HEAD, master) Correct email address
*   1dcbf21 Merge remote-tracking branch 'p4/master'
|\
| * c4689fc (p4/master, p4/HEAD) Grammar fix
* | cbacd0a Table borders: yes please
* | b4959b6 Trademark
|/
* 775a46f Change page title
* 05f1ade Update link
* 75cd059 Update copyright
* 70eaf78 Initial import of //depot/www/live/ from the state at revision #head</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Git and Perforce history diverge after 775a46f.
The Git side has two commits, then a merge commit with the Perforce head, then another commit.
We&#8217;re going to try to submit these on top of a single changeset on the Perforce side.
Let&#8217;s see what would happen if we tried to submit now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 submit -n
Perforce checkout for depot path //depot/www/live/ located at /Users/ben/john_bens-mbp_8487/john_bens-mbp_8487/depot/www/live/
Would synchronize p4 checkout in /Users/ben/john_bens-mbp_8487/john_bens-mbp_8487/depot/www/live/
Would apply
  b4959b6 Trademark
  cbacd0a Table borders: yes please
  3be6fd8 Correct email address</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-n</code> flag is short for <code>--dry-run</code>, which tries to report what would happen if the submit command were run for real.
In this case, it looks like we&#8217;d be creating three Perforce changesets, which correspond to the three non-merge commits that don&#8217;t yet exist on the Perforce server.
That sounds like exactly what we want, let&#8217;s see how it turns out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 submit
[…]
$ git log --oneline --all --graph --decorate
* dadbd89 (HEAD, p4/master, p4/HEAD, master) Correct email address
* 1b79a80 Table borders: yes please
* 0097235 Trademark
* c4689fc Grammar fix
* 775a46f Change page title
* 05f1ade Update link
* 75cd059 Update copyright
* 70eaf78 Initial import of //depot/www/live/ from the state at revision #head</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our history became linear, just as though we had rebased before submitting (which is in fact exactly what happened).
This means you can be free to create, work on, throw away, and merge branches on the Git side without fear that your history will somehow become incompatible with Perforce.
If you can rebase it, you can contribute it to a Perforce server.</p>
</div>
</div>
<div class="sect5">
<h6 id="_git_p4_branches">Branching</h6>
<div class="paragraph">
<p>If your Perforce project has multiple branches, you&#8217;re not out of luck; git-p4 can handle that in a way that makes it feel like Git.
Let&#8217;s say your Perforce depot is laid out like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>//depot
  └── project
      ├── main
      └── dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s say you have a <code>dev</code> branch, which has a view spec that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>//depot/project/main/... //depot/project/dev/...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git-p4 can automatically detect that situation and do the right thing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git p4 clone --detect-branches //depot/project@all
Importing from //depot/project@all into project
Initialized empty Git repository in /private/tmp/project/.git/
Importing revision 20 (50%)
    Importing new branch project/dev

    Resuming with change 20
Importing revision 22 (100%)
Updated branches: main dev
$ cd project; git log --oneline --all --graph --decorate
* eae77ae (HEAD, p4/master, p4/HEAD, master) main
| * 10d55fb (p4/project/dev) dev
| * a43cfae Populate //depot/project/main/... //depot/project/dev/....
|/
* 2b83451 Project init</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the &#8220;@all&#8221; specifier in the depot path; that tells git-p4 to clone not just the latest changeset for that subtree, but all changesets that have ever touched those paths.
This is closer to Git&#8217;s concept of a clone, but if you&#8217;re working on a project with a long history, it could take a while.</p>
</div>
<div class="paragraph">
<p>The <code>--detect-branches</code> flag tells git-p4 to use Perforce&#8217;s branch specs to map the branches to Git refs.
If these mappings aren&#8217;t present on the Perforce server (which is a perfectly valid way to use Perforce), you can tell git-p4 what the branch mappings are, and you get the same result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git init project
Initialized empty Git repository in /tmp/project/.git/
$ cd project
$ git config git-p4.branchList main:dev
$ git clone --detect-branches //depot/project@all .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Setting the <code>git-p4.branchList</code> configuration variable to <code>main:dev</code> tells git-p4 that &#8220;main&#8221; and &#8220;dev&#8221; are both branches, and the second one is a child of the first one.</p>
</div>
<div class="paragraph">
<p>If we now <code>git checkout -b dev p4/project/dev</code> and make some commits, git-p4 is smart enough to target the right branch when we do <code>git p4 submit</code>.
Unfortunately, git-p4 can&#8217;t mix shallow clones and multiple branches; if you have a huge project and want to work on more than one branch, you&#8217;ll have to <code>git p4 clone</code> once for each branch you want to submit to.</p>
</div>
<div class="paragraph">
<p>For creating or integrating branches, you&#8217;ll have to use a Perforce client.
Git-p4 can only sync and submit to existing branches, and it can only do it one linear changeset at a time.
If you merge two branches in Git and try to submit the new changeset, all that will be recorded is a bunch of file changes; the metadata about which branches are involved in the integration will be lost.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_git_and_perforce_summary">Git and Perforce Summary</h5>
<div class="paragraph">
<p>Git-p4 makes it possible to use a Git workflow with a Perforce server, and it&#8217;s pretty good at it.
However, it&#8217;s important to remember that Perforce is in charge of the source, and you&#8217;re only using Git to work locally.
Just be really careful about sharing Git commits; if you have a remote that other people use, don&#8217;t push any commits that haven&#8217;t already been submitted to the Perforce server.</p>
</div>
<div class="paragraph">
<p>If you want to freely mix the use of Perforce and Git as clients for source control, and you can convince the server administrator to install it, Git Fusion makes using Git a first-class version-control client for a Perforce server.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_and_tfs">Git and TFS</h4>
<div class="paragraph">
<p>

Git is becoming popular with Windows developers, and if you&#8217;re writing code on Windows, there&#8217;s a good chance you&#8217;re using Microsoft&#8217;s Team Foundation Server (TFS).
TFS is a collaboration suite that includes defect and work-item tracking, process support for Scrum and others, code review, and version control.
There&#8217;s a bit of confusion ahead: <strong>TFS</strong> is the server, which supports controlling source code using both Git and their own custom VCS, which they&#8217;ve dubbed <strong>TFVC</strong> (Team Foundation Version Control).
Git support is a somewhat new feature for TFS (shipping with the 2013 version), so all of the tools that predate that refer to the version-control portion as &#8220;TFS&#8221;, even though they&#8217;re mostly working with TFVC.</p>
</div>
<div class="paragraph">
<p>If you find yourself on a team that&#8217;s using TFVC but you&#8217;d rather use Git as your version-control client, there&#8217;s a project for you.</p>
</div>
<div class="sect4">
<h5 id="_which_tool">Which Tool</h5>
<div class="paragraph">
<p>
In fact, there are two: git-tf and git-tfs.</p>
</div>
<div class="paragraph">
<p>Git-tfs (found at <a href="https://github.com/git-tfs/git-tfs" class="bare">https://github.com/git-tfs/git-tfs</a>) is a .NET project, and (as of this writing) it only runs on Windows.
To work with Git repositories, it uses the .NET bindings for libgit2, a library-oriented implementation of Git which is highly performant and allows a lot of flexibility with the guts of a Git repository.
Libgit2 is not a complete implementation of Git, so to cover the difference git-tfs will actually call the command-line Git client for some operations, so there are no artificial limits on what it can do with Git repositories.
Its support of TFVC features is very mature, since it uses the Visual Studio assemblies for operations with servers.
This does mean you&#8217;ll need access to those assemblies, which means you need to install a recent version of Visual Studio (any edition since version 2010, including Express since version 2012), or the Visual Studio SDK.</p>
</div>
<div class="paragraph">
<p>Git-tf (whose home is at <a href="https://gittf.codeplex.com" class="bare">https://gittf.codeplex.com</a>) is a Java project, and as such runs on any computer with a Java runtime environment.
It interfaces with Git repositories through JGit (a JVM implementation of Git), which means it has virtually no limitations in terms of Git functions.
However, its support for TFVC is limited as compared to git-tfs – it does not support branches, for instance.</p>
</div>
<div class="paragraph">
<p>So each tool has pros and cons, and there are plenty of situations that favor one over the other.
We&#8217;ll cover the basic usage of both of them in this book.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You&#8217;ll need access to a TFVC-based repository to follow along with these instructions.
These aren&#8217;t as plentiful in the wild as Git or Subversion repositories, so you may need to create one of your own.
Codeplex (<a href="https://www.codeplex.com" class="bare">https://www.codeplex.com</a>) or Visual Studio Online (<a href="http://www.visualstudio.com" class="bare">http://www.visualstudio.com</a>) are both good choices for this.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_getting_started_code_git_tf_code">Getting Started: <code>git-tf</code></h5>
<div class="paragraph">
<p>The first thing you do, just as with any Git project, is clone.
Here&#8217;s what that looks like with <code>git-tf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tf clone https://tfs.codeplex.com:443/tfs/TFS13 $/myproject/Main project_git</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument is the URL of a TFVC collection, the second is of the form <code>$/project/branch</code>, and the third is the path to the local Git repository that is to be created (this last one is optional).
Git-tf can only work with one branch at a time; if you want to make checkins on a different TFVC branch, you&#8217;ll have to make a new clone from that branch.</p>
</div>
<div class="paragraph">
<p>This creates a fully functional Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd project_git
$ git log --all --oneline --decorate
512e75a (HEAD, tag: TFS_C35190, origin_tfs/tfs, master) Checkin message</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is called a <em>shallow</em> clone, meaning that only the latest changeset has been downloaded.
TFVC isn&#8217;t designed for each client to have a full copy of the history, so git-tf defaults to only getting the latest version, which is much faster.</p>
</div>
<div class="paragraph">
<p>If you have some time, it&#8217;s probably worth it to clone the entire project history, using the <code>--deep</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tf clone https://tfs.codeplex.com:443/tfs/TFS13 $/myproject/Main \
  project_git --deep
Username: domain\user
Password:
Connecting to TFS...
Cloning $/myproject into /tmp/project_git: 100%, done.
Cloned 4 changesets. Cloned last changeset 35190 as d44b17a
$ cd project_git
$ git log --all --oneline --decorate
d44b17a (HEAD, tag: TFS_C35190, origin_tfs/tfs, master) Goodbye
126aa7b (tag: TFS_C35189)
8f77431 (tag: TFS_C35178) FIRST
0745a25 (tag: TFS_C35177) Created team project folder $/tfvctest via the \
        Team Project Creation Wizard</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the tags with names like <code>TFS_C35189</code>; this is a feature that helps you know which Git commits are associated with TFVC changesets.
This is a nice way to represent it, since you can see with a simple log command which of your commits is associated with a snapshot that also exists in TFVC.
They aren&#8217;t necessary (and in fact you can turn them off with <code>git config git-tf.tag false</code>) – git-tf keeps the real commit-changeset mappings in the <code>.git/git-tf</code> file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_getting_started_code_git_tfs_code">Getting Started: <code>git-tfs</code></h5>
<div class="paragraph">
<p>Git-tfs cloning behaves a bit differently.
Observe:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git tfs clone --with-branches \
    https://username.visualstudio.com/DefaultCollection \
    $/project/Trunk project_git
Initialized empty Git repository in C:/Users/ben/project_git/.git/
C15 = b75da1aba1ffb359d00e85c52acb261e4586b0c9
C16 = c403405f4989d73a2c3c119e79021cb2104ce44a
Tfs branches found:
- $/tfvc-test/featureA
The name of the local branch will be : featureA
C17 = d202b53f67bde32171d5078968c644e562f1c439
C18 = 44cd729d8df868a8be20438fdeeefb961958b674</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>--with-branches</code> flag.
Git-tfs is capable of mapping TFVC branches to Git branches, and this flag tells it to set up a local Git branch for every TFVC branch.
This is highly recommended if you&#8217;ve ever branched or merged in TFS, but it won&#8217;t work with a server older than TFS 2010 – before that release, &#8220;branches&#8221; were just folders, so git-tfs can&#8217;t tell them from regular folders.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the resulting Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git log --oneline --graph --decorate --all
* 44cd729 (tfs/featureA, featureA) Goodbye
* d202b53 Branched from $/tfvc-test/Trunk
* c403405 (HEAD, tfs/default, master) Hello
* b75da1a New project
PS&gt; git log -1
commit c403405f4989d73a2c3c119e79021cb2104ce44a
Author: Ben Straub &lt;ben@straub.cc&gt;
Date:   Fri Aug 1 03:41:59 2014 +0000

    Hello

    git-tfs-id: [https://username.visualstudio.com/DefaultCollection]$/myproject/Trunk;C16</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two local branches, <code>master</code> and <code>featureA</code>, which represent the initial starting point of the clone (<code>Trunk</code> in TFVC) and a child branch (<code>featureA</code> in TFVC).
You can also see that the <code>tfs</code> &#8220;remote&#8221; has a couple of refs too: <code>default</code> and <code>featureA</code>, which represent TFVC branches.
Git-tfs maps the branch you cloned from to <code>tfs/default</code>, and others get their own names.</p>
</div>
<div class="paragraph">
<p>Another thing to notice is the <code>git-tfs-id:</code> lines in the commit messages.
Instead of tags, git-tfs uses these markers to relate TFVC changesets to Git commits.
This has the implication that your Git commits will have a different SHA-1 hash before and after they has been pushed to TFVC.</p>
</div>
</div>
<div class="sect4">
<h5 id="_git_tf_s_workflow">Git-tf[s] Workflow</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Regardless of which tool you&#8217;re using, you should set a couple of Git configuration values to avoid running into issues.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git config set --local core.ignorecase=true
$ git config set --local core.autocrlf=false</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The obvious next thing you&#8217;re going to want to do is work on the project.
TFVC and TFS have several features that may add complexity to your workflow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Feature branches that aren&#8217;t represented in TFVC add a bit of complexity.
This has to do with the <strong>very</strong> different ways that TFVC and Git represent branches.</p>
</li>
<li>
<p>Be aware that TFVC allows users to &#8220;checkout&#8221; files from the server, locking them so nobody else can edit them.
This obviously won&#8217;t stop you from editing them in your local repository, but it could get in the way when it comes time to push your changes up to the TFVC server.</p>
</li>
<li>
<p>TFS has the concept of &#8220;gated&#8221; checkins, where a TFS build-test cycle has to complete successfully before the checkin is allowed.
This uses the &#8220;shelve&#8221; function in TFVC, which we don&#8217;t cover in detail here.
  You can fake this in a manual fashion with git-tf, and git-tfs provides the <code>checkintool</code> command which is gate-aware.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the interest of brevity, what we&#8217;ll cover here is the happy path, which sidesteps or avoids most of these issues.</p>
</div>
</div>
<div class="sect4">
<h5 id="_workflow_code_git_tf_code">Workflow: <code>git-tf</code></h5>
<div class="paragraph">
<p>Let&#8217;s say you&#8217;ve done some work, made a couple of Git commits on <code>master</code>, and you&#8217;re ready to share your progress on the TFVC server.
Here&#8217;s our Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --graph --decorate --all
* 4178a82 (HEAD, master) update code
* 9df2ae3 update readme
* d44b17a (tag: TFS_C35190, origin_tfs/tfs) Goodbye
* 126aa7b (tag: TFS_C35189)
* 8f77431 (tag: TFS_C35178) FIRST
* 0745a25 (tag: TFS_C35177) Created team project folder $/tfvctest via the \
          Team Project Creation Wizard</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to take the snapshot that&#8217;s in the <code>4178a82</code> commit and push it up to the TFVC server.
First things first: let&#8217;s see if any of our teammates did anything since we last connected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tf fetch
Username: domain\user
Password:
Connecting to TFS...
Fetching $/myproject at latest changeset: 100%, done.
Downloaded changeset 35320 as commit 8ef06a8. Updated FETCH_HEAD.
$ git log --oneline --graph --decorate --all
* 8ef06a8 (tag: TFS_C35320, origin_tfs/tfs) just some text
| * 4178a82 (HEAD, master) update code
| * 9df2ae3 update readme
|/
* d44b17a (tag: TFS_C35190) Goodbye
* 126aa7b (tag: TFS_C35189)
* 8f77431 (tag: TFS_C35178) FIRST
* 0745a25 (tag: TFS_C35177) Created team project folder $/tfvctest via the \
          Team Project Creation Wizard</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looks like someone else is working, too, and now we have divergent history.
This is where Git shines, but we have two choices of how to proceed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Making a merge commit feels natural as a Git user (after all, that&#8217;s what <code>git pull</code> does), and git-tf can do this for you with a simple <code>git tf pull</code>.
Be aware, however, that TFVC doesn&#8217;t think this way, and if you push merge commits your history will start to look different on both sides, which can be confusing.
However, if you plan on submitting all of your changes as one changeset, this is probably the easiest choice.</p>
</li>
<li>
<p>Rebasing makes our commit history linear, which means we have the option of converting each of our Git commits into a TFVC changeset.
Since this leaves the most options open, we recommend you do it this way; git-tf even makes it easy for you with <code>git tf pull --rebase</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The choice is yours.
For this example, we&#8217;ll be rebasing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rebase FETCH_HEAD
First, rewinding head to replay your work on top of it...
Applying: update readme
Applying: update code
$ git log --oneline --graph --decorate --all
* 5a0e25e (HEAD, master) update code
* 6eb3eb5 update readme
* 8ef06a8 (tag: TFS_C35320, origin_tfs/tfs) just some text
* d44b17a (tag: TFS_C35190) Goodbye
* 126aa7b (tag: TFS_C35189)
* 8f77431 (tag: TFS_C35178) FIRST
* 0745a25 (tag: TFS_C35177) Created team project folder $/tfvctest via the \
          Team Project Creation Wizard</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re ready to make a checkin to the TFVC server.
Git-tf gives you the choice of making a single changeset that represents all the changes since the last one (<code>--shallow</code>, which is the default) and creating a new changeset for each Git commit (<code>--deep</code>).
For this example, we&#8217;ll just create one changeset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tf checkin -m 'Updating readme and code'
Username: domain\user
Password:
Connecting to TFS...
Checking in to $/myproject: 100%, done.
Checked commit 5a0e25e in as changeset 35348
$ git log --oneline --graph --decorate --all
* 5a0e25e (HEAD, tag: TFS_C35348, origin_tfs/tfs, master) update code
* 6eb3eb5 update readme
* 8ef06a8 (tag: TFS_C35320) just some text
* d44b17a (tag: TFS_C35190) Goodbye
* 126aa7b (tag: TFS_C35189)
* 8f77431 (tag: TFS_C35178) FIRST
* 0745a25 (tag: TFS_C35177) Created team project folder $/tfvctest via the \
          Team Project Creation Wizard</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s a new <code>TFS_C35348</code> tag, indicating that TFVC is storing the exact same snapshot as the <code>5a0e25e</code> commit.
It&#8217;s important to note that not every Git commit needs to have an exact counterpart in TFVC; the <code>6eb3eb5</code> commit, for example, doesn&#8217;t exist anywhere on the server.</p>
</div>
<div class="paragraph">
<p>That&#8217;s the main workflow.
There are a couple other considerations you&#8217;ll want to keep in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is no branching.
Git-tf can only create Git repositories from one TFVC branch at a time.</p>
</li>
<li>
<p>Collaborate using either TFVC or Git, but not both.
Different git-tf clones of the same TFVC repository may have different commit SHA hashes, which will cause no end of headaches.</p>
</li>
<li>
<p>If your team&#8217;s workflow includes collaborating in Git and syncing periodically with TFVC, only connect to TFVC with one of the Git repositories.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_workflow_code_git_tfs_code">Workflow: <code>git-tfs</code></h5>
<div class="paragraph">
<p>Let&#8217;s walk through the same scenario using git-tfs.
Here are the new commits we&#8217;ve made to the <code>master</code> branch in our Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git log --oneline --graph --all --decorate
* c3bd3ae (HEAD, master) update code
* d85e5a2 update readme
| * 44cd729 (tfs/featureA, featureA) Goodbye
| * d202b53 Branched from $/tfvc-test/Trunk
|/
* c403405 (tfs/default) Hello
* b75da1a New project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if anyone else has done work while we were hacking away:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git tfs fetch
C19 = aea74a0313de0a391940c999e51c5c15c381d91d
PS&gt; git log --all --oneline --graph --decorate
* aea74a0 (tfs/default) update documentation
| * c3bd3ae (HEAD, master) update code
| * d85e5a2 update readme
|/
| * 44cd729 (tfs/featureA, featureA) Goodbye
| * d202b53 Branched from $/tfvc-test/Trunk
|/
* c403405 Hello
* b75da1a New project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yes, it turns out our coworker has added a new TFVC changeset, which shows up as the new <code>aea74a0</code> commit, and the <code>tfs/default</code> remote branch has moved.</p>
</div>
<div class="paragraph">
<p>As with git-tf, we have two fundamental options for how to resolve this divergent history:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Rebase to preserve a linear history.</p>
</li>
<li>
<p>Merge to preserve what actually happened.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In this case, we&#8217;re going to do a &#8220;deep&#8221; checkin, where every Git commit becomes a TFVC changeset, so we want to rebase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git rebase tfs/default
First, rewinding head to replay your work on top of it...
Applying: update readme
Applying: update code
PS&gt; git log --all --oneline --graph --decorate
* 10a75ac (HEAD, master) update code
* 5cec4ab update readme
* aea74a0 (tfs/default) update documentation
| * 44cd729 (tfs/featureA, featureA) Goodbye
| * d202b53 Branched from $/tfvc-test/Trunk
|/
* c403405 Hello
* b75da1a New project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re ready to complete our contribution by checking in our code to the TFVC server.
We&#8217;ll use the <code>rcheckin</code> command here to create a TFVC changeset for each Git commit in the path from HEAD to the first <code>tfs</code> remote branch found (the <code>checkin</code> command would only create one changeset, sort of like squashing Git commits).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git tfs rcheckin
Working with tfs remote: default
Fetching changes from TFS to minimize possibility of late conflict...
Starting checkin of 5cec4ab4 'update readme'
 add README.md
C20 = 71a5ddce274c19f8fdc322b4f165d93d89121017
Done with 5cec4ab4b213c354341f66c80cd650ab98dcf1ed, rebasing tail onto new TFS-commit...
Rebase done successfully.
Starting checkin of b1bf0f99 'update code'
 edit .git\tfs\default\workspace\ConsoleApplication1/ConsoleApplication1/Program.cs
C21 = ff04e7c35dfbe6a8f94e782bf5e0031cee8d103b
Done with b1bf0f9977b2d48bad611ed4a03d3738df05ea5d, rebasing tail onto new TFS-commit...
Rebase done successfully.
No more to rcheckin.
PS&gt; git log --all --oneline --graph --decorate
* ff04e7c (HEAD, tfs/default, master) update code
* 71a5ddc update readme
* aea74a0 update documentation
| * 44cd729 (tfs/featureA, featureA) Goodbye
| * d202b53 Branched from $/tfvc-test/Trunk
|/
* c403405 Hello
* b75da1a New project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how after every successful checkin to the TFVC server, git-tfs is rebasing the remaining work onto what it just did.
That&#8217;s because it&#8217;s adding the <code>git-tfs-id</code> field to the bottom of the commit messages, which changes the SHA-1 hashes.
This is exactly as designed, and there&#8217;s nothing to worry about, but you should be aware that it&#8217;s happening, especially if you&#8217;re sharing Git commits with others.</p>
</div>
<div class="paragraph">
<p>TFS has many features that integrate with its version control system, such as work items, designated reviewers, gated checkins, and so on.
It can be cumbersome to work with these features using only a command-line tool, but fortunately git-tfs lets you launch a graphical checkin tool very easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git tfs checkintool
PS&gt; git tfs ct</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks a bit like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-tfs-ct.png" alt="The git-tfs checkin tool.">
</div>
<div class="title">Figure 148. The git-tfs checkin tool.</div>
</div>
<div class="paragraph">
<p>This will look familiar to TFS users, as it&#8217;s the same dialog that&#8217;s launched from within Visual Studio.</p>
</div>
<div class="paragraph">
<p>Git-tfs also lets you control TFVC branches from your Git repository.
As an example, let&#8217;s create one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git tfs branch $/tfvc-test/featureBee
The name of the local branch will be : featureBee
C26 = 1d54865c397608c004a2cadce7296f5edc22a7e5
PS&gt; git lga
* 1d54865 (tfs/featureBee) Creation branch $/myproject/featureBee
* ff04e7c (HEAD, tfs/default, master) update code
* 71a5ddc update readme
* aea74a0 update documentation
| * 44cd729 (tfs/featureA, featureA) Goodbye
| * d202b53 Branched from $/tfvc-test/Trunk
|/
* c403405 Hello
* b75da1a New project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creating a branch in TFVC means adding a changeset where that branch now exists, and this is projected as a Git commit.
Note also that git-tfs <strong>created</strong> the <code>tfs/featureBee</code> remote branch, but <code>HEAD</code> is still pointing to <code>master</code>.
If you want to work on the newly-minted branch, you&#8217;ll want to base your new commits on the <code>1d54865</code> commit, perhaps by creating a topic branch from that commit.</p>
</div>
</div>
<div class="sect4">
<h5 id="_git_and_tfs_summary">Git and TFS Summary</h5>
<div class="paragraph">
<p>Git-tf and Git-tfs are both great tools for interfacing with a TFVC server.
They allow you to use the power of Git locally, avoid constantly having to round-trip to the central TFVC server, and make your life as a developer much easier, without forcing your entire team to migrate to Git.
If you&#8217;re working on Windows (which is likely if your team is using TFS), you&#8217;ll probably want to use git-tfs, since it&#8217;s feature set is more complete, but if you&#8217;re working on another platform, you&#8217;ll be using git-tf, which is more limited.
As with most of the tools in this chapter, you should choose one of these version-control systems to be canonical, and use the other one in a subordinate fashion – either Git or TFVC should be the center of collaboration, but not both.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_migrating">Migrating to Git</h3>
<div class="paragraph">
<p>
If you have an existing codebase in another VCS but you&#8217;ve decided to start using Git, you must migrate your project one way or another.
This section goes over some importers for common systems, and then demonstrates how to develop your own custom importer.
You&#8217;ll learn how to import data from several of the bigger professionally used SCM systems, because they make up the majority of users who are switching, and because high-quality tools for them are easy to come by.</p>
</div>
<div class="sect3">
<h4 id="_subversion">Subversion</h4>
<div class="paragraph">
<p>

If you read the previous section about using <code>git svn</code>, you can easily use those instructions to <code>git svn clone</code> a repository; then, stop using the Subversion server, push to a new Git server, and start using that.
If you want the history, you can accomplish that as quickly as you can pull the data out of the Subversion server (which may take a while).</p>
</div>
<div class="paragraph">
<p>However, the import isn&#8217;t perfect; and because it will take so long, you may as well do it right.
The first problem is the author information.
In Subversion, each person committing has a user on the system who is recorded in the commit information.
The examples in the previous section show <code>schacon</code> in some places, such as the <code>blame</code> output and the <code>git svn log</code>.
If you want to map this to better Git author data, you need a mapping from the Subversion users to the Git authors.
Create a file called <code>users.txt</code> that has this mapping in a format like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>schacon = Scott Chacon &lt;schacon@geemail.com&gt;
selse = Someo Nelse &lt;selse@geemail.com&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To get a list of the author names that SVN uses, you can run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ svn log --xml | grep author | sort -u | \
  perl -pe 's/.*&gt;(.*?)&lt;.*/$1 = /'</code></pre>
</div>
</div>
<div class="paragraph">
<p>That generates the log output in XML format, then keeps only the lines with author information, discards duplicates, strips out the XML tags.
(Obviously this only works on a machine with <code>grep</code>, <code>sort</code>, and <code>perl</code> installed.)
Then, redirect that output into your users.txt file so you can add the equivalent Git user data next to each entry.</p>
</div>
<div class="paragraph">
<p>You can provide this file to <code>git svn</code> to help it map the author data more accurately.
You can also tell <code>git svn</code> not to include the metadata that Subversion normally imports, by passing <code>--no-metadata</code> to the <code>clone</code> or <code>init</code> command.
This makes your <code>import</code> command look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git svn clone http://my-project.googlecode.com/svn/ \
      --authors-file=users.txt --no-metadata -s my_project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you should have a nicer Subversion import in your <code>my_project</code> directory.
Instead of commits that look like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>commit 37efa680e8473b615de980fa935944215428a35a
Author: schacon &lt;schacon@4c93b258-373f-11de-be05-5f7a86268029&gt;
Date:   Sun May 3 00:12:22 2009 +0000

    fixed install - go to trunk

    git-svn-id: https://my-project.googlecode.com/svn/trunk@94 4c93b258-373f-11de-
    be05-5f7a86268029</code></pre>
</div>
</div>
<div class="paragraph">
<p>they look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>commit 03a8785f44c8ea5cdb0e8834b7c8e6c469be2ff2
Author: Scott Chacon &lt;schacon@geemail.com&gt;
Date:   Sun May 3 00:12:22 2009 +0000

    fixed install - go to trunk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not only does the Author field look a lot better, but the <code>git-svn-id</code> is no longer there, either.</p>
</div>
<div class="paragraph">
<p>You should also do a bit of post-import cleanup.
For one thing, you should clean up the weird references that <code>git svn</code> set up.
First you&#8217;ll move the tags so they&#8217;re actual tags rather than strange remote branches, and then you&#8217;ll move the rest of the branches so they&#8217;re local.</p>
</div>
<div class="paragraph">
<p>To move the tags to be proper Git tags, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cp -Rf .git/refs/remotes/origin/tags/* .git/refs/tags/
$ rm -Rf .git/refs/remotes/origin/tags</code></pre>
</div>
</div>
<div class="paragraph">
<p>This takes the references that were remote branches that started with <code>remotes/origin/tags/</code> and makes them real (lightweight) tags.</p>
</div>
<div class="paragraph">
<p>Next, move the rest of the references under <code>refs/remotes</code> to be local branches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cp -Rf .git/refs/remotes/* .git/refs/heads/
$ rm -Rf .git/refs/remotes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all the old branches are real Git branches and all the old tags are real Git tags.
The last thing to do is add your new Git server as a remote and push to it.
Here is an example of adding your server as a remote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add origin git@my-git-server:myrepository.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because you want all your branches and tags to go up, you can now run this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin --all</code></pre>
</div>
</div>
<div class="paragraph">
<p>All your branches and tags should be on your new Git server in a nice, clean import.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mercurial">Mercurial</h4>
<div class="paragraph">
<p>
Since Mercurial and Git have fairly similar models for representing versions, and since Git is a bit more flexible, converting a repository from Mercurial to Git is fairly straightforward, using a tool called "hg-fast-export", which you&#8217;ll need a copy of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone http://repo.or.cz/r/fast-export.git /tmp/fast-export</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first step in the conversion is to get a full clone of the Mercurial repository you want to convert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ hg clone &lt;remote repo URL&gt; /tmp/hg-repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create an author mapping file.
Mercurial is a bit more forgiving than Git for what it will put in the author field for changesets, so this is a good time to clean house.
Generating this is a one-line command in a <code>bash</code> shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cd /tmp/hg-repo
$ hg log | grep user: | sort | uniq | sed 's/user: *//' &gt; ../authors</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will take a few seconds, depending on how long your project&#8217;s history is, and afterwards the <code>/tmp/authors</code> file will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bob
bob@localhost
bob &lt;bob@company.com&gt;
bob jones &lt;bob &lt;AT&gt; company &lt;DOT&gt; com&gt;
Bob Jones &lt;bob@company.com&gt;
Joe Smith &lt;joe@company.com&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the same person (Bob) has created changesets under four different names, one of which actually looks correct, and one of which would be completely invalid for a Git commit.
Hg-fast-export lets us fix this by adding <code>={new name and email address}</code> at the end of every line we want to change, and removing the lines for any usernames that we want to leave alone.
If all the usernames look fine, we won&#8217;t need this file at all.
In this example, we want our file to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bob=Bob Jones &lt;bob@company.com&gt;
bob@localhost=Bob Jones &lt;bob@company.com&gt;
bob jones &lt;bob &lt;AT&gt; company &lt;DOT&gt; com&gt;=Bob Jones &lt;bob@company.com&gt;
bob &lt;bob@company.com&gt;=Bob Jones &lt;bob@company.com&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create our new Git repository, and run the export script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git init /tmp/converted
$ cd /tmp/converted
$ /tmp/fast-export/hg-fast-export.sh -r /tmp/hg-repo -A /tmp/authors</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-r</code> flag tells hg-fast-export where to find the Mercurial repository we want to convert, and the <code>-A</code> flag tells it where to find the author-mapping file.
The script parses Mercurial changesets and converts them into a script for Git&#8217;s "fast-import" feature (which we&#8217;ll discuss in detail a bit later on).
This takes a bit (though it&#8217;s <em>much</em> faster than it would be over the network), and the output is fairly verbose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ /tmp/fast-export/hg-fast-export.sh -r /tmp/hg-repo -A /tmp/authors
Loaded 4 authors
master: Exporting full revision 1/22208 with 13/0/0 added/changed/removed files
master: Exporting simple delta revision 2/22208 with 1/1/0 added/changed/removed files
master: Exporting simple delta revision 3/22208 with 0/1/0 added/changed/removed files
[…]
master: Exporting simple delta revision 22206/22208 with 0/4/0 added/changed/removed files
master: Exporting simple delta revision 22207/22208 with 0/2/0 added/changed/removed files
master: Exporting thorough delta revision 22208/22208 with 3/213/0 added/changed/removed files
Exporting tag [0.4c] at [hg r9] [git :10]
Exporting tag [0.4d] at [hg r16] [git :17]
[…]
Exporting tag [3.1-rc] at [hg r21926] [git :21927]
Exporting tag [3.1] at [hg r21973] [git :21974]
Issued 22315 commands
git-fast-import statistics:
---------------------------------------------------------------------
Alloc'd objects:     120000
Total objects:       115032 (    208171 duplicates                  )
      blobs  :        40504 (    205320 duplicates      26117 deltas of      39602 attempts)
      trees  :        52320 (      2851 duplicates      47467 deltas of      47599 attempts)
      commits:        22208 (         0 duplicates          0 deltas of          0 attempts)
      tags   :            0 (         0 duplicates          0 deltas of          0 attempts)
Total branches:         109 (         2 loads     )
      marks:        1048576 (     22208 unique    )
      atoms:           1952
Memory total:          7860 KiB
       pools:          2235 KiB
     objects:          5625 KiB
---------------------------------------------------------------------
pack_report: getpagesize()            =       4096
pack_report: core.packedGitWindowSize = 1073741824
pack_report: core.packedGitLimit      = 8589934592
pack_report: pack_used_ctr            =      90430
pack_report: pack_mmap_calls          =      46771
pack_report: pack_open_windows        =          1 /          1
pack_report: pack_mapped              =  340852700 /  340852700
---------------------------------------------------------------------

$ git shortlog -sn
   369  Bob Jones
   365  Joe Smith</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s pretty much all there is to it.
All of the Mercurial tags have been converted to Git tags, and Mercurial branches and bookmarks have been converted to Git branches.
Now you&#8217;re ready to push the repository up to its new server-side home:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add origin git@my-git-server:myrepository.git
$ git push origin --all</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_perforce_import">Perforce</h4>
<div class="paragraph">
<p>
The next system you&#8217;ll look at importing from is Perforce.
As we discussed above, there are two ways to let Git and Perforce talk to each other: git-p4 and Perforce Git Fusion.</p>
</div>
<div class="sect4">
<h5 id="_perforce_git_fusion">Perforce Git Fusion</h5>
<div class="paragraph">
<p>Git Fusion makes this process fairly painless.
Just configure your project settings, user mappings, and branches using a configuration file (as discussed in <a href="#_p4_git_fusion">Git Fusion</a>), and clone the repository.
Git Fusion leaves you with what looks like a native Git repository, which is then ready to push to a native Git host if you desire.
You could even use Perforce as your Git host if you like.</p>
</div>
</div>
<div class="sect4">
<h5 id="_git_p4">Git-p4</h5>
<div class="paragraph">
<p>Git-p4 can also act as an import tool.
As an example, we&#8217;ll import the Jam project from the Perforce Public Depot.
To set up your client, you must export the P4PORT environment variable to point to the Perforce depot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ export P4PORT=public.perforce.com:1666</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In order to follow along, you&#8217;ll need a Perforce depot to connect with.
We&#8217;ll be using the public depot at public.perforce.com for our examples, but you can use any depot you have access to.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
Run the <code>git p4 clone</code> command to import the Jam project from the Perforce server, supplying the depot and project path and the path into which you want to import the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git-p4 clone //guest/perforce_software/jam@all p4import
Importing from //guest/perforce_software/jam@all into p4import
Initialized empty Git repository in /private/tmp/p4import/.git/
Import destination: refs/remotes/p4/master
Importing revision 9957 (100%)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This particular project has only one branch, but if you have branches that are configured with branch views (or just a set of directories), you can use the <code>--detect-branches</code> flag to <code>git p4 clone</code> to import all the project&#8217;s branches as well.
See <a href="#_git_p4_branches">Branching</a> for a bit more detail on this.</p>
</div>
<div class="paragraph">
<p>At this point you&#8217;re almost done.
If you go to the <code>p4import</code> directory and run <code>git log</code>, you can see your imported work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -2
commit e5da1c909e5db3036475419f6379f2c73710c4e6
Author: giles &lt;giles@giles@perforce.com&gt;
Date:   Wed Feb 8 03:13:27 2012 -0800

    Correction to line 355; change &lt;/UL&gt; to &lt;/OL&gt;.

    [git-p4: depot-paths = "//public/jam/src/": change = 8068]

commit aa21359a0a135dda85c50a7f7cf249e4f7b8fd98
Author: kwirth &lt;kwirth@perforce.com&gt;
Date:   Tue Jul 7 01:35:51 2009 -0800

    Fix spelling error on Jam doc page (cummulative -&gt; cumulative).

    [git-p4: depot-paths = "//public/jam/src/": change = 7304]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that <code>git-p4</code> has left an identifier in each commit message.
It&#8217;s fine to keep that identifier there, in case you need to reference the Perforce change number later.
However, if you&#8217;d like to remove the identifier, now is the time to do so – before you start doing work on the new repository.

You can use <code>git filter-branch</code> to remove the identifier strings en masse:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git filter-branch --msg-filter 'sed -e "/^\[git-p4:/d"'
Rewrite e5da1c909e5db3036475419f6379f2c73710c4e6 (125/125)
Ref 'refs/heads/master' was rewritten</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run <code>git log</code>, you can see that all the SHA-1 checksums for the commits have changed, but the <code>git-p4</code> strings are no longer in the commit messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -2
commit b17341801ed838d97f7800a54a6f9b95750839b7
Author: giles &lt;giles@giles@perforce.com&gt;
Date:   Wed Feb 8 03:13:27 2012 -0800

    Correction to line 355; change &lt;/UL&gt; to &lt;/OL&gt;.

commit 3e68c2e26cd89cb983eb52c024ecdfba1d6b3fff
Author: kwirth &lt;kwirth@perforce.com&gt;
Date:   Tue Jul 7 01:35:51 2009 -0800

    Fix spelling error on Jam doc page (cummulative -&gt; cumulative).</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your import is ready to push up to your new Git server.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_tfs">TFS</h4>
<div class="paragraph">
<p>
If your team is converting their source control from TFVC to Git, you&#8217;ll want the highest-fidelity conversion you can get.
This means that, while we covered both git-tfs and git-tf for the interop section, we&#8217;ll only be covering git-tfs for this part, because git-tfs supports branches, and this is prohibitively difficult using git-tf.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This is a one-way conversion.
The resulting Git repository won&#8217;t be able to connect with the original TFVC project.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first thing to do is map usernames.
TFVC is fairly liberal with what goes into the author field for changesets, but Git wants a human-readable name and email address.
You can get this information from the <code>tf</code> command-line client, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; tf history $/myproject -recursive &gt; AUTHORS_TMP</code></pre>
</div>
</div>
<div class="paragraph">
<p>This grabs all of the changesets in the history of the project and put it in the AUTHORS_TMP file that we will process to extract the data of the <em>User</em> column (the 2nd one).
Open the file and find at which characters start and end the column and replace, in the following command-line, the parameters <code>11-20</code> of the <code>cut</code> command with the ones found:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; cat AUTHORS_TMP | cut -b 11-20 | tail -n+3 | uniq | sort &gt; AUTHORS</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>cut</code> command keeps only the characters between 11 and 20 from each line.
The <code>tail</code> command skips the first two lines, which are field headers and ASCII-art underlines.
The result of all of this is piped to <code>uniq</code> to eliminate duplicates, and saved to a file named <code>AUTHORS</code>.
The next step is manual; in order for git-tfs to make effective use of this file, each line must be in this format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">DOMAIN\username = User Name &lt;email@address.com&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The portion on the left is the &#8220;User&#8221; field from TFVC, and the portion on the right side of the equals sign is the user name that will be used for Git commits.</p>
</div>
<div class="paragraph">
<p>Once you have this file, the next thing to do is make a full clone of the TFVC project you&#8217;re interested in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git tfs clone --with-branches --authors=AUTHORS https://username.visualstudio.com/DefaultCollection $/project/Trunk project_git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you&#8217;ll want to clean the <code>git-tfs-id</code> sections from the bottom of the commit messages.
The following command will do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">PS&gt; git filter-branch -f --msg-filter 'sed "s/^git-tfs-id:.*$//g"' -- --all</code></pre>
</div>
</div>
<div class="paragraph">
<p>That uses the <code>sed</code> command from the Git-bash environment to replace any line starting with &#8220;git-tfs-id:&#8221; with emptiness, which Git will then ignore.</p>
</div>
<div class="paragraph">
<p>Once that&#8217;s all done, you&#8217;re ready to add a new remote, push all your branches up, and have your team start working from Git.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_importer">A Custom Importer</h4>
<div class="paragraph">
<p>

If your system isn&#8217;t one of the above, you should look for an importer online – quality importers are available for many other systems, including CVS, Clear Case, Visual Source Safe, even a directory of archives.
If none of these tools works for you, you have a more obscure tool, or you otherwise need a more custom importing process, you should use <code>git fast-import</code>.
This command reads simple instructions from stdin to write specific Git data.
It&#8217;s much easier to create Git objects this way than to run the raw Git commands or try to write the raw objects (see <a href="#_git_internals">Git Internals</a> for more information).
This way, you can write an import script that reads the necessary information out of the system you&#8217;re importing from and prints straightforward instructions to stdout.
You can then run this program and pipe its output through <code>git fast-import</code>.</p>
</div>
<div class="paragraph">
<p>To quickly demonstrate, you&#8217;ll write a simple importer.
Suppose you work in <code>current</code>, you back up your project by occasionally copying the directory into a time-stamped <code>back_YYYY_MM_DD</code> backup directory, and you want to import this into Git.
Your directory structure looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ls /opt/import_from
back_2014_01_02
back_2014_01_04
back_2014_01_14
back_2014_02_03
current</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to import a Git directory, you need to review how Git stores its data.
As you may remember, Git is fundamentally a linked list of commit objects that point to a snapshot of content.
All you have to do is tell <code>fast-import</code> what the content snapshots are, what commit data points to them, and the order they go in.
Your strategy will be to go through the snapshots one at a time and create commits with the contents of each directory, linking each commit back to the previous one.</p>
</div>
<div class="paragraph">
<p>As we did in <a href="#_an_example_git_enforced_policy">An Example Git-Enforced Policy</a>, we&#8217;ll write this in Ruby, because it&#8217;s what we generally work with and it tends to be easy to read.
You can write this example pretty easily in anything you&#8217;re familiar with – it just needs to print the appropriate information to <code>stdout</code>.
And, if you are running on Windows, this means you&#8217;ll need to take special care to not introduce carriage returns at the end your lines – git fast-import is very particular about just wanting line feeds (LF) not the carriage return line feeds (CRLF) that Windows uses.</p>
</div>
<div class="paragraph">
<p>To begin, you&#8217;ll change into the target directory and identify every subdirectory, each of which is a snapshot that you want to import as a commit.
You&#8217;ll change into each subdirectory and print the commands necessary to export it.
Your basic main loop looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">last_mark = nil

# loop through the directories
Dir.chdir(ARGV[0]) do
  Dir.glob("*").each do |dir|
    next if File.file?(dir)

    # move into the target directory
    Dir.chdir(dir) do
      last_mark = print_export(dir, last_mark)
    end
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>You run <code>print_export</code> inside each directory, which takes the manifest and mark of the previous snapshot and returns the manifest and mark of this one; that way, you can link them properly.
&#8220;Mark&#8221; is the <code>fast-import</code> term for an identifier you give to a commit; as you create commits, you give each one a mark that you can use to link to it from other commits.
So, the first thing to do in your <code>print_export</code> method is generate a mark from the directory name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">mark = convert_dir_to_mark(dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll do this by creating an array of directories and using the index value as the mark, because a mark must be an integer.
Your method looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">$marks = []
def convert_dir_to_mark(dir)
  if !$marks.include?(dir)
    $marks &lt;&lt; dir
  end
  ($marks.index(dir) + 1).to_s
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you have an integer representation of your commit, you need a date for the commit metadata.
Because the date is expressed in the name of the directory, you&#8217;ll parse it out.
The next line in your <code>print_export</code> file is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">date = convert_dir_to_date(dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>convert_dir_to_date</code> is defined as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def convert_dir_to_date(dir)
  if dir == 'current'
    return Time.now().to_i
  else
    dir = dir.gsub('back_', '')
    (year, month, day) = dir.split('_')
    return Time.local(year, month, day).to_i
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>That returns an integer value for the date of each directory.
The last piece of meta-information you need for each commit is the committer data, which you hardcode in a global variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">$author = 'John Doe &lt;john@example.com&gt;'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you&#8217;re ready to begin printing out the commit data for your importer.
The initial information states that you&#8217;re defining a commit object and what branch it&#8217;s on, followed by the mark you&#8217;ve generated, the committer information and commit message, and then the previous commit, if any.
The code looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># print the import information
puts 'commit refs/heads/master'
puts 'mark :' + mark
puts "committer #{$author} #{date} -0700"
export_data('imported from ' + dir)
puts 'from :' + last_mark if last_mark</code></pre>
</div>
</div>
<div class="paragraph">
<p>You hardcode the time zone (-0700) because doing so is easy.
If you&#8217;re importing from another system, you must specify the time zone as an offset.
The commit message must be expressed in a special format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>data (size)\n(contents)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The format consists of the word data, the size of the data to be read, a newline, and finally the data.
Because you need to use the same format to specify the file contents later, you create a helper method, <code>export_data</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def export_data(string)
  print "data #{string.size}\n#{string}"
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>All that&#8217;s left is to specify the file contents for each snapshot.
This is easy, because you have each one in a directory – you can print out the <code>deleteall</code> command followed by the contents of each file in the directory.
Git will then record each snapshot appropriately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">puts 'deleteall'
Dir.glob("**/*").each do |file|
  next if !File.file?(file)
  inline_data(file)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note:  Because many systems think of their revisions as changes from one commit to another, fast-import can also take commands with each commit to specify which files have been added, removed, or modified and what the new contents are.
You could calculate the differences between snapshots and provide only this data, but doing so is more complex – you may as well give Git all the data and let it figure it out.
If this is better suited to your data, check the <code>fast-import</code> man page for details about how to provide your data in this manner.</p>
</div>
<div class="paragraph">
<p>The format for listing the new file contents or specifying a modified file with the new contents is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>M 644 inline path/to/file
data (size)
(file contents)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, 644 is the mode (if you have executable files, you need to detect and specify 755 instead), and inline says you&#8217;ll list the contents immediately after this line.
Your <code>inline_data</code> method looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def inline_data(file, code = 'M', mode = '644')
  content = File.read(file)
  puts "#{code} #{mode} inline #{file}"
  export_data(content)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>You reuse the <code>export_data</code> method you defined earlier, because it&#8217;s the same as the way you specified your commit message data.</p>
</div>
<div class="paragraph">
<p>The last thing you need to do is to return the current mark so it can be passed to the next iteration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">return mark</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you are running on Windows you&#8217;ll need to make sure that you add one extra step.
As mentioned before, Windows uses CRLF for new line characters while git fast-import expects only LF.
To get around this problem and make git fast-import happy, you need to tell ruby to use LF instead of CRLF:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">$stdout.binmode</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s it.
Here&#8217;s the script in its entirety:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

$stdout.binmode
$author = "John Doe &lt;john@example.com&gt;"

$marks = []
def convert_dir_to_mark(dir)
    if !$marks.include?(dir)
        $marks &lt;&lt; dir
    end
    ($marks.index(dir)+1).to_s
end


def convert_dir_to_date(dir)
    if dir == 'current'
        return Time.now().to_i
    else
        dir = dir.gsub('back_', '')
        (year, month, day) = dir.split('_')
        return Time.local(year, month, day).to_i
    end
end

def export_data(string)
    print "data #{string.size}\n#{string}"
end

def inline_data(file, code='M', mode='644')
    content = File.read(file)
    puts "#{code} #{mode} inline #{file}"
    export_data(content)
end

def print_export(dir, last_mark)
    date = convert_dir_to_date(dir)
    mark = convert_dir_to_mark(dir)

    puts 'commit refs/heads/master'
    puts "mark :#{mark}"
    puts "committer #{$author} #{date} -0700"
    export_data("imported from #{dir}")
    puts "from :#{last_mark}" if last_mark

    puts 'deleteall'
    Dir.glob("**/*").each do |file|
        next if !File.file?(file)
        inline_data(file)
    end
    mark
end


# Loop through the directories
last_mark = nil
Dir.chdir(ARGV[0]) do
    Dir.glob("*").each do |dir|
        next if File.file?(dir)

        # move into the target directory
        Dir.chdir(dir) do
            last_mark = print_export(dir, last_mark)
        end
    end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run this script, you&#8217;ll get content that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ruby import.rb /opt/import_from
commit refs/heads/master
mark :1
committer John Doe &lt;john@example.com&gt; 1388649600 -0700
data 29
imported from back_2014_01_02deleteall
M 644 inline README.md
data 28
# Hello

This is my readme.
commit refs/heads/master
mark :2
committer John Doe &lt;john@example.com&gt; 1388822400 -0700
data 29
imported from back_2014_01_04from :1
deleteall
M 644 inline main.rb
data 34
#!/bin/env ruby

puts "Hey there"
M 644 inline README.md
(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run the importer, pipe this output through <code>git fast-import</code> while in the Git directory you want to import into.
You can create a new directory and then run <code>git init</code> in it for a starting point, and then run your script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git init
Initialized empty Git repository in /opt/import_to/.git/
$ ruby import.rb /opt/import_from | git fast-import
git-fast-import statistics:
---------------------------------------------------------------------
Alloc'd objects:       5000
Total objects:           13 (         6 duplicates                  )
      blobs  :            5 (         4 duplicates          3 deltas of          5 attempts)
      trees  :            4 (         1 duplicates          0 deltas of          4 attempts)
      commits:            4 (         1 duplicates          0 deltas of          0 attempts)
      tags   :            0 (         0 duplicates          0 deltas of          0 attempts)
Total branches:           1 (         1 loads     )
      marks:           1024 (         5 unique    )
      atoms:              2
Memory total:          2344 KiB
       pools:          2110 KiB
     objects:           234 KiB
---------------------------------------------------------------------
pack_report: getpagesize()            =       4096
pack_report: core.packedGitWindowSize = 1073741824
pack_report: core.packedGitLimit      = 8589934592
pack_report: pack_used_ctr            =         10
pack_report: pack_mmap_calls          =          5
pack_report: pack_open_windows        =          2 /          2
pack_report: pack_mapped              =       1457 /       1457
---------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, when it completes successfully, it gives you a bunch of statistics about what it accomplished.
In this case, you imported 13 objects total for 4 commits into 1 branch.
Now, you can run <code>git log</code> to see your new history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -2
commit 3caa046d4aac682a55867132ccdfbe0d3fdee498
Author: John Doe &lt;john@example.com&gt;
Date:   Tue Jul 29 19:39:04 2014 -0700

    imported from current

commit 4afc2b945d0d3c8cd00556fbe2e8224569dc9def
Author: John Doe &lt;john@example.com&gt;
Date:   Mon Feb 3 01:00:00 2014 -0700

    imported from back_2014_02_03</code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go – a nice, clean Git repository.
It&#8217;s important to note that nothing is checked out – you don&#8217;t have any files in your working directory at first.
To get them, you must reset your branch to where <code>master</code> is now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ls
$ git reset --hard master
HEAD is now at 3caa046 imported from current
$ ls
README.md main.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can do a lot more with the <code>fast-import</code> tool – handle different modes, binary data, multiple branches and merging, tags, progress indicators, and more.
A number of examples of more complex scenarios are available in the <code>contrib/fast-import</code> directory of the Git source code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_6">Summary</h3>
<div class="paragraph">
<p>You should feel comfortable using Git as a client for other version-control systems, or importing nearly any existing repository into Git without losing data.
In the next chapter, we&#8217;ll cover the raw internals of Git so you can craft every single byte, if need be.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_internals">Git Internals</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may have skipped to this chapter from a previous chapter, or you may have gotten here after reading the rest of the book – in either case, this is where we&#8217;ll go over the inner workings and implementation of Git.
We found that learning this information was fundamentally important to understanding how useful and powerful Git is, but others have argued to us that it can be confusing and unnecessarily complex for beginners.
Thus, we&#8217;ve made this discussion the last chapter in the book so you could read it early or later in your learning process.
We leave it up to you to decide.</p>
</div>
<div class="paragraph">
<p>Now that you&#8217;re here, let&#8217;s get started.
First, if it isn&#8217;t yet clear, Git is fundamentally a content-addressable filesystem with a VCS user interface written on top of it.
You&#8217;ll learn more about what this means in a bit.</p>
</div>
<div class="paragraph">
<p>In the early days of Git (mostly pre 1.5), the user interface was much more complex because it emphasized this filesystem rather than a polished VCS.
In the last few years, the UI has been refined until it&#8217;s as clean and easy to use as any system out there; but often, the stereotype lingers about the early Git UI that was complex and difficult to learn.</p>
</div>
<div class="paragraph">
<p>The content-addressable filesystem layer is amazingly cool, so I&#8217;ll cover that first in this chapter; then, you&#8217;ll learn about the transport mechanisms and the repository maintenance tasks that you may eventually have to deal with.</p>
</div>
<div class="sect2">
<h3 id="_plumbing_porcelain">Plumbing and Porcelain</h3>
<div class="paragraph">
<p>This book covers how to use Git with 30 or so verbs such as <code>checkout</code>, <code>branch</code>, <code>remote</code>, and so on.
But because Git was initially a toolkit for a VCS rather than a full user-friendly VCS, it has a bunch of verbs that do low-level work and were designed to be chained together UNIX style or called from scripts.
These commands are generally referred to as &#8220;plumbing&#8221; commands, and the more user-friendly commands are called &#8220;porcelain&#8221; commands.</p>
</div>
<div class="paragraph">
<p>The book&#8217;s first nine chapters deal almost exclusively with porcelain commands.
But in this chapter, you&#8217;ll be dealing mostly with the lower-level plumbing commands, because they give you access to the inner workings of Git, and help demonstrate how and why Git does what it does.
Many of these commands aren&#8217;t meant to be used manually on the command line, but rather to be used as building blocks for new tools and custom scripts.</p>
</div>
<div class="paragraph">
<p>When you run <code>git init</code> in a new or existing directory, Git creates the <code>.git</code> directory, which is where almost everything that Git stores and manipulates is located.
If you want to back up or clone your repository, copying this single directory elsewhere gives you nearly everything you need.
This entire chapter basically deals with the stuff in this directory.
Here&#8217;s what it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ls -F1
HEAD
config*
description
hooks/
info/
objects/
refs/</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may see some other files in there, but this is a fresh <code>git init</code> repository – it&#8217;s what you see by default.
The <code>description</code> file is only used by the GitWeb program, so don&#8217;t worry about it.
The <code>config</code> file contains your project-specific configuration options, and the <code>info</code> directory keeps a global exclude file  for ignored patterns that you don&#8217;t want to track in a .gitignore file.
The <code>hooks</code> directory contains your client- or server-side hook scripts, which are discussed in detail in <a href="#_git_hooks">Git Hooks</a>.</p>
</div>
<div class="paragraph">
<p>This leaves four important entries: the <code>HEAD</code> and (yet to be created) <code>index</code> files, and the <code>objects</code> and <code>refs</code> directories.
These are the core parts of Git.
The <code>objects</code> directory stores all the content for your database, the <code>refs</code> directory stores pointers into commit objects in that data (branches), the <code>HEAD</code> file points to the branch you currently have checked out, and the <code>index</code> file is where Git stores your staging area information.
You&#8217;ll now look at each of these sections in detail to see how Git operates.</p>
</div>
</div>
<div class="sect2">
<h3 id="_objects">Git Objects</h3>
<div class="paragraph">
<p>Git is a content-addressable filesystem.
Great.
What does that mean?
It means that at the core of Git is a simple key-value data store.
You can insert any kind of content into it, and it will give you back a key that you can use to retrieve the content again at any time.
To demonstrate, you can use the plumbing command <code>hash-object</code>, which takes some data, stores it in your <code>.git</code> directory, and gives you back the key the data is stored as.
First, you initialize a new Git repository and verify that there is nothing in the <code>objects</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git init test
Initialized empty Git repository in /tmp/test/.git/
$ cd test
$ find .git/objects
.git/objects
.git/objects/info
.git/objects/pack
$ find .git/objects -type f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git has initialized the <code>objects</code> directory and created <code>pack</code> and <code>info</code> subdirectories in it, but there are no regular files.
Now, store some text in your Git database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'test content' | git hash-object -w --stdin
d670460b4b4aece5915caf5c68d12f560a9fe3e4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-w</code> tells <code>hash-object</code> to store the object; otherwise, the command simply tells you what the key would be.
<code>--stdin</code> tells the command to read the content from stdin; if you don&#8217;t specify this, <code>hash-object</code> expects a file path at the end.
The output from the command is a 40-character checksum hash.
This is the SHA-1 hash – a checksum of the content you&#8217;re storing plus a header, which you&#8217;ll learn about in a bit.
Now you can see how Git has stored your data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/objects -type f
.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see a file in the <code>objects</code> directory.
This is how Git stores the content initially – as a single file per piece of content, named with the SHA-1 checksum of the content and its header.
The subdirectory is named with the first 2 characters of the SHA, and the filename is the remaining 38 characters.</p>
</div>
<div class="paragraph">
<p>You can pull the content back out of Git with the <code>cat-file</code> command.
This command is sort of a Swiss army knife for inspecting Git objects.
Passing <code>-p</code> to it instructs the <code>cat-file</code> command to figure out the type of content and display it nicely for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4
test content</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can add content to Git and pull it back out again.
You can also do this with content in files.
For example, you can do some simple version control on a file.
First, create a new file and save its contents in your database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'version 1' &gt; test.txt
$ git hash-object -w test.txt
83baae61804e65cc73a7201a7252750c76066a30</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, write some new content to the file, and save it again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'version 2' &gt; test.txt
$ git hash-object -w test.txt
1f7a7a472abf3dd9643fd615f6da379c4acb3e3a</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your database contains the two new versions of the file as well as the first content you stored there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/objects -type f
.git/objects/1f/7a7a472abf3dd9643fd615f6da379c4acb3e3a
.git/objects/83/baae61804e65cc73a7201a7252750c76066a30
.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can revert the file back to the first version</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p 83baae61804e65cc73a7201a7252750c76066a30 &gt; test.txt
$ cat test.txt
version 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>or the second version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a &gt; test.txt
$ cat test.txt
version 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>But remembering the SHA-1 key for each version of your file isn&#8217;t practical; plus, you aren&#8217;t storing the filename in your system – just the content.
This object type is called a blob.
You can have Git tell you the object type of any object in Git, given its SHA-1 key, with <code>cat-file -t</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -t 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a
blob</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_tree_objects">Tree Objects</h4>
<div class="paragraph">
<p>The next type we&#8217;ll look at is the tree, which solves the problem of storing the filename and also allows you to store a group of files together.
Git stores content in a manner similar to a UNIX filesystem, but a bit simplified.
All the content is stored as tree and blob objects, with trees corresponding to UNIX directory entries and blobs corresponding more or less to inodes or file contents.
A single tree object contains one or more tree entries, each of which contains a SHA-1 pointer to a blob or subtree with its associated mode, type, and filename.
For example, the most recent tree in a project may look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p master^{tree}
100644 blob a906cb2a4a904a152e80877d4088654daad0c859      README
100644 blob 8f94139338f9404f26296befa88755fc2598c289      Rakefile
040000 tree 99f1a6d12cb4b6f19c8655fca46c3ecf317074e0      lib</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>master^{tree}</code> syntax specifies the tree object that is pointed to by the last commit on your <code>master</code> branch.
Notice that the <code>lib</code> subdirectory isn&#8217;t a blob but a pointer to another tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p 99f1a6d12cb4b6f19c8655fca46c3ecf317074e0
100644 blob 47c6340d6459e05787f644c2447d2595f5d3a54b      simplegit.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Conceptually, the data that Git is storing is something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/data-model-1.png" alt="Simple version of the Git data model.">
</div>
<div class="title">Figure 149. Simple version of the Git data model.</div>
</div>
<div class="paragraph">
<p>You can fairly easily create your own tree.
Git normally creates a tree by taking the state of your staging area or index and writing a series of tree objects from it.
So, to create a tree object, you first have to set up an index by staging some files.
To create an index with a single entry – the first version of your test.txt file – you can use the plumbing command <code>update-index</code>.
You use this command to artificially add the earlier version of the test.txt file to a new staging area.
You must pass it the <code>--add</code> option because the file doesn&#8217;t yet exist in your staging area (you don&#8217;t even have a staging area set up yet) and <code>--cacheinfo</code> because the file you&#8217;re adding isn&#8217;t in your directory but is in your database.
Then, you specify the mode, SHA-1, and filename:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git update-index --add --cacheinfo 100644 \
  83baae61804e65cc73a7201a7252750c76066a30 test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, you&#8217;re specifying a mode of <code>100644</code>, which means it&#8217;s a normal file.
Other options are <code>100755</code>, which means it&#8217;s an executable file; and <code>120000</code>, which specifies a symbolic link.
The mode is taken from normal UNIX modes but is much less flexible – these three modes are the only ones that are valid for files (blobs) in Git (although other modes are used for directories and submodules).</p>
</div>
<div class="paragraph">
<p>Now, you can use the <code>write-tree</code> command to write the staging area out to a tree object.
No <code>-w</code> option is needed – calling <code>write-tree</code> automatically creates a tree object from the state of the index if that tree doesn&#8217;t yet exist:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git write-tree
d8329fc1cc938780ffdd9f94e0d364e0ea74f579
$ git cat-file -p d8329fc1cc938780ffdd9f94e0d364e0ea74f579
100644 blob 83baae61804e65cc73a7201a7252750c76066a30      test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also verify that this is a tree object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -t d8329fc1cc938780ffdd9f94e0d364e0ea74f579
tree</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll now create a new tree with the second version of test.txt and a new file as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'new file' &gt; new.txt
$ git update-index test.txt
$ git update-index --add new.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your staging area now has the new version of test.txt as well as the new file new.txt.
Write out that tree (recording the state of the staging area or index to a tree object) and see what it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git write-tree
0155eb4229851634a0f03eb265b69f5a2d56f341
$ git cat-file -p 0155eb4229851634a0f03eb265b69f5a2d56f341
100644 blob fa49b077972391ad58037050f2a75f74e3671e92      new.txt
100644 blob 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a      test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that this tree has both file entries and also that the test.txt SHA is the &#8220;version 2&#8221; SHA from earlier (<code>1f7a7a</code>).
Just for fun, you&#8217;ll add the first tree as a subdirectory into this one.
You can read trees into your staging area by calling <code>read-tree</code>.
In this case, you can read an existing tree into your staging area as a subtree by using the <code>--prefix</code> option to <code>read-tree</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git read-tree --prefix=bak d8329fc1cc938780ffdd9f94e0d364e0ea74f579
$ git write-tree
3c4e9cd789d88d8d89c1073707c3585e41b0e614
$ git cat-file -p 3c4e9cd789d88d8d89c1073707c3585e41b0e614
040000 tree d8329fc1cc938780ffdd9f94e0d364e0ea74f579      bak
100644 blob fa49b077972391ad58037050f2a75f74e3671e92      new.txt
100644 blob 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a      test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you created a working directory from the new tree you just wrote, you would get the two files in the top level of the working directory and a subdirectory named <code>bak</code> that contained the first version of the test.txt file.
You can think of the data that Git contains for these structures as being like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/data-model-2.png" alt="The content structure of your current Git data.">
</div>
<div class="title">Figure 150. The content structure of your current Git data.</div>
</div>
</div>
<div class="sect3">
<h4 id="_git_commit_objects">Commit Objects</h4>
<div class="paragraph">
<p>You have three trees that specify the different snapshots of your project that you want to track, but the earlier problem remains: you must remember all three SHA-1 values in order to recall the snapshots.
You also don&#8217;t have any information about who saved the snapshots, when they were saved, or why they were saved.
This is the basic information that the commit object stores for you.</p>
</div>
<div class="paragraph">
<p>To create a commit object, you call <code>commit-tree</code> and specify a single tree SHA-1 and which commit objects, if any, directly preceded it.
Start with the first tree you wrote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'first commit' | git commit-tree d8329f
fdf4fc3344e67ab068f836878b6c4951e3b15f3d</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can look at your new commit object with <code>cat-file</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p fdf4fc3
tree d8329fc1cc938780ffdd9f94e0d364e0ea74f579
author Scott Chacon &lt;schacon@gmail.com&gt; 1243040974 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1243040974 -0700

first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The format for a commit object is simple: it specifies the top-level tree for the snapshot of the project at that point; the author/committer information (which uses your <code>user.name</code> and <code>user.email</code> configuration settings and a timestamp); a blank line, and then the commit message.</p>
</div>
<div class="paragraph">
<p>Next, you&#8217;ll write the other two commit objects, each referencing the commit that came directly before it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo 'second commit' | git commit-tree 0155eb -p fdf4fc3
cac0cab538b970a37ea1e769cbbde608743bc96d
$ echo 'third commit'  | git commit-tree 3c4e9c -p cac0cab
1a410efbd13591db07496601ebc7a059dd55cfe9</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the three commit objects points to one of the three snapshot trees you created.
Oddly enough, you have a real Git history now that you can view with the <code>git log</code> command, if you run it on the last commit SHA-1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --stat 1a410e
commit 1a410efbd13591db07496601ebc7a059dd55cfe9
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri May 22 18:15:24 2009 -0700

	third commit

 bak/test.txt | 1 +
 1 file changed, 1 insertion(+)

commit cac0cab538b970a37ea1e769cbbde608743bc96d
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri May 22 18:14:29 2009 -0700

	second commit

 new.txt  | 1 +
 test.txt | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

commit fdf4fc3344e67ab068f836878b6c4951e3b15f3d
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri May 22 18:09:34 2009 -0700

    first commit

 test.txt | 1 +
 1 file changed, 1 insertion(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Amazing.
You&#8217;ve just done the low-level operations to build up a Git history without using any of the front end commands.
This is essentially what Git does when you run the <code>git add</code> and <code>git commit</code> commands – it stores blobs for the files that have changed, updates the index, writes out trees, and writes commit objects that reference the top-level trees and the commits that came immediately before them.
These three main Git objects – the blob, the tree, and the commit – are initially stored as separate files in your <code>.git/objects</code> directory.
Here are all the objects in the example directory now, commented with what they store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/objects -type f
.git/objects/01/55eb4229851634a0f03eb265b69f5a2d56f341 # tree 2
.git/objects/1a/410efbd13591db07496601ebc7a059dd55cfe9 # commit 3
.git/objects/1f/7a7a472abf3dd9643fd615f6da379c4acb3e3a # test.txt v2
.git/objects/3c/4e9cd789d88d8d89c1073707c3585e41b0e614 # tree 3
.git/objects/83/baae61804e65cc73a7201a7252750c76066a30 # test.txt v1
.git/objects/ca/c0cab538b970a37ea1e769cbbde608743bc96d # commit 2
.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4 # 'test content'
.git/objects/d8/329fc1cc938780ffdd9f94e0d364e0ea74f579 # tree 1
.git/objects/fa/49b077972391ad58037050f2a75f74e3671e92 # new.txt
.git/objects/fd/f4fc3344e67ab068f836878b6c4951e3b15f3d # commit 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you follow all the internal pointers, you get an object graph something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/data-model-3.png" alt="All the objects in your Git directory.">
</div>
<div class="title">Figure 151. All the objects in your Git directory.</div>
</div>
</div>
<div class="sect3">
<h4 id="_object_storage">Object Storage</h4>
<div class="paragraph">
<p>We mentioned earlier that a header is stored with the content.
Let&#8217;s take a minute to look at how Git stores its objects.
You&#8217;ll see how to store a blob object – in this case, the string &#8220;what is up, doc?&#8221; – interactively in the Ruby scripting language.</p>
</div>
<div class="paragraph">
<p>You can start up interactive Ruby mode with the <code>irb</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ irb
&gt;&gt; content = "what is up, doc?"
=&gt; "what is up, doc?"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git constructs a header that starts with the type of the object, in this case a blob.
Then, it adds a space followed by the size of the content and finally a null byte:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt;&gt; header = "blob #{content.length}\0"
=&gt; "blob 16\u0000"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git concatenates the header and the original content and then calculates the SHA-1 checksum of that new content.
You can calculate the SHA-1 value of a string in Ruby by including the SHA1 digest library with the <code>require</code> command and then calling <code>Digest::SHA1.hexdigest()</code> with the string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt;&gt; store = header + content
=&gt; "blob 16\u0000what is up, doc?"
&gt;&gt; require 'digest/sha1'
=&gt; true
&gt;&gt; sha1 = Digest::SHA1.hexdigest(store)
=&gt; "bd9dbf5aae1a3862dd1526723246b20206e5fc37"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git compresses the new content with zlib, which you can do in Ruby with the zlib library.
First, you need to require the library and then run <code>Zlib::Deflate.deflate()</code> on the content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt;&gt; require 'zlib'
=&gt; true
&gt;&gt; zlib_content = Zlib::Deflate.deflate(store)
=&gt; "x\x9CK\xCA\xC9OR04c(\xCFH,Q\xC8,V(-\xD0QH\xC9O\xB6\a\x00_\x1C\a\x9D"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you&#8217;ll write your zlib-deflated content to an object on disk.
You&#8217;ll determine the path of the object you want to write out (the first two characters of the SHA-1 value being the subdirectory name, and the last 38 characters being the filename within that directory).
In Ruby, you can use the <code>FileUtils.mkdir_p()</code> function to create the subdirectory if it doesn&#8217;t exist.
Then, open the file with <code>File.open()</code> and write out the previously zlib-compressed content to the file with a <code>write()</code> call on the resulting file handle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">&gt;&gt; path = '.git/objects/' + sha1[0,2] + '/' + sha1[2,38]
=&gt; ".git/objects/bd/9dbf5aae1a3862dd1526723246b20206e5fc37"
&gt;&gt; require 'fileutils'
=&gt; true
&gt;&gt; FileUtils.mkdir_p(File.dirname(path))
=&gt; ".git/objects/bd"
&gt;&gt; File.open(path, 'w') { |f| f.write zlib_content }
=&gt; 32</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it – you&#8217;ve created a valid Git blob object.
All Git objects are stored the same way, just with different types – instead of the string blob, the header will begin with commit or tree.
Also, although the blob content can be nearly anything, the commit and tree content are very specifically formatted.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_refs">Git References</h3>
<div class="paragraph">
<p>You can run something like <code>git log 1a410e</code> to look through your whole history, but you still have to remember that <code>1a410e</code> is the last commit in order to walk that history to find all those objects.
You need a file in which you can store the SHA-1 value under a simple name so you can use that pointer rather than the raw SHA-1 value.</p>
</div>
<div class="paragraph">
<p>In Git, these are called &#8220;references&#8221; or &#8220;refs;&#8221; you can find the files that contain the SHA-1 values in the <code>.git/refs</code> directory.
In the current project, this directory contains no files, but it does contain a simple structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/refs
.git/refs
.git/refs/heads
.git/refs/tags
$ find .git/refs -type f</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a new reference that will help you remember where your latest commit is, you can technically do something as simple as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo "1a410efbd13591db07496601ebc7a059dd55cfe9" &gt; .git/refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can use the head reference you just created instead of the SHA-1 value in your Git commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=oneline  master
1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
cac0cab538b970a37ea1e769cbbde608743bc96d second commit
fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>You aren&#8217;t encouraged to directly edit the reference files.
Git provides a safer command to do this if you want to update a reference called <code>update-ref</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git update-ref refs/heads/master 1a410efbd13591db07496601ebc7a059dd55cfe9</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s basically what a branch in Git is: a simple pointer or reference to the head of a line of work.
To create a branch back at the second commit, you can do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git update-ref refs/heads/test cac0ca</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your branch will contain only work from that commit down:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=oneline test
cac0cab538b970a37ea1e769cbbde608743bc96d second commit
fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, your Git database conceptually looks something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/data-model-4.png" alt="Git directory objects with branch head references included.">
</div>
<div class="title">Figure 152. Git directory objects with branch head references included.</div>
</div>
<div class="paragraph">
<p>When you run commands like <code>git branch (branchname)</code>, Git basically runs that <code>update-ref</code> command to add the SHA-1 of the last commit of the branch you&#8217;re on into whatever new reference you want to create.</p>
</div>
<div class="sect3">
<h4 id="_the_head">The HEAD</h4>
<div class="paragraph">
<p>The question now is, when you run <code>git branch (branchname)</code>, how does Git know the SHA-1 of the last commit?
The answer is the HEAD file.</p>
</div>
<div class="paragraph">
<p>The HEAD file is a symbolic reference to the branch you&#8217;re currently on.
By symbolic reference, we mean that unlike a normal reference, it doesn’t generally contain a SHA-1 value but rather a pointer to another reference.
If you look at the file, you&#8217;ll normally see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .git/HEAD
ref: refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run <code>git checkout test</code>, Git updates the file to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .git/HEAD
ref: refs/heads/test</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run <code>git commit</code>, it creates the commit object, specifying the parent of that commit object to be whatever SHA-1 value the reference in HEAD points to.</p>
</div>
<div class="paragraph">
<p>You can also manually edit this file, but again a safer command exists to do so: <code>symbolic-ref</code>.
You can read the value of your HEAD via this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git symbolic-ref HEAD
refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also set the value of HEAD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git symbolic-ref HEAD refs/heads/test
$ cat .git/HEAD
ref: refs/heads/test</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can&#8217;t set a symbolic reference outside of the refs style:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git symbolic-ref HEAD test
fatal: Refusing to point HEAD outside of refs/</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tags">Tags</h4>
<div class="paragraph">
<p>We just finished discussing Git&#8217;s three main object types, but there is a fourth.
The tag object is very much like a commit object – it contains a tagger, a date, a message, and a pointer.
The main difference is that a tag object generally points to a commit rather than a tree.
It&#8217;s like a branch reference, but it never moves – it always points to the same commit but gives it a friendlier name.</p>
</div>
<div class="paragraph">
<p>As discussed in <a href="#_git_basics_chapter">Git 基础</a>, there are two types of tags: annotated and lightweight.
You can make a lightweight tag by running something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git update-ref refs/tags/v1.0 cac0cab538b970a37ea1e769cbbde608743bc96d</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is all a lightweight tag is – a reference that never moves.
An annotated tag is more complex, however.
If you create an annotated tag, Git creates a tag object and then writes a reference to point to it rather than directly to the commit.
You can see this by creating an annotated tag (<code>-a</code> specifies that it&#8217;s an annotated tag):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git tag -a v1.1 1a410efbd13591db07496601ebc7a059dd55cfe9 -m 'test tag'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the object SHA-1 value it created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .git/refs/tags/v1.1
9585191f37f7b0fb9444f35a9bf50de191beadc2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, run the <code>cat-file</code> command on that SHA-1 value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p 9585191f37f7b0fb9444f35a9bf50de191beadc2
object 1a410efbd13591db07496601ebc7a059dd55cfe9
type commit
tag v1.1
tagger Scott Chacon &lt;schacon@gmail.com&gt; Sat May 23 16:48:58 2009 -0700

test tag</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the object entry points to the commit SHA-1 value that you tagged.
Also notice that it doesn&#8217;t need to point to a commit; you can tag any Git object.
In the Git source code, for example, the maintainer has added their GPG public key as a blob object and then tagged it.
You can view the public key by running this in a clone of the Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file blob junio-gpg-pub</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Linux kernel repository also has a non-commit-pointing tag object – the first tag created points to the initial tree of the import of the source code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_remotes">Remotes</h4>
<div class="paragraph">
<p>The third type of reference that you&#8217;ll see is a remote reference.
If you add a remote and push to it, Git stores the value you last pushed to that remote for each branch in the <code>refs/remotes</code> directory.
For instance, you can add a remote called <code>origin</code> and push your <code>master</code> branch to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add origin git@github.com:schacon/simplegit-progit.git
$ git push origin master
Counting objects: 11, done.
Compressing objects: 100% (5/5), done.
Writing objects: 100% (7/7), 716 bytes, done.
Total 7 (delta 2), reused 4 (delta 1)
To git@github.com:schacon/simplegit-progit.git
  a11bef0..ca82a6d  master -&gt; master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you can see what the <code>master</code> branch on the <code>origin</code> remote was the last time you communicated with the server, by checking the <code>refs/remotes/origin/master</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .git/refs/remotes/origin/master
ca82a6dff817ec66f44342007202690a93763949</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remote references differ from branches (<code>refs/heads</code> references) mainly in that they&#8217;re considered read-only.
You can <code>git checkout</code> to one, but Git won&#8217;t point HEAD at one, so you&#8217;ll never update it with a <code>commit</code> command.
Git manages them as bookmarks to the last known state of where those branches were on those servers.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_packfiles">Packfiles</h3>
<div class="paragraph">
<p>Let&#8217;s go back to the objects database for your test Git repository.
At this point, you have 11 objects – 4 blobs, 3 trees, 3 commits, and 1 tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/objects -type f
.git/objects/01/55eb4229851634a0f03eb265b69f5a2d56f341 # tree 2
.git/objects/1a/410efbd13591db07496601ebc7a059dd55cfe9 # commit 3
.git/objects/1f/7a7a472abf3dd9643fd615f6da379c4acb3e3a # test.txt v2
.git/objects/3c/4e9cd789d88d8d89c1073707c3585e41b0e614 # tree 3
.git/objects/83/baae61804e65cc73a7201a7252750c76066a30 # test.txt v1
.git/objects/95/85191f37f7b0fb9444f35a9bf50de191beadc2 # tag
.git/objects/ca/c0cab538b970a37ea1e769cbbde608743bc96d # commit 2
.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4 # 'test content'
.git/objects/d8/329fc1cc938780ffdd9f94e0d364e0ea74f579 # tree 1
.git/objects/fa/49b077972391ad58037050f2a75f74e3671e92 # new.txt
.git/objects/fd/f4fc3344e67ab068f836878b6c4951e3b15f3d # commit 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git compresses the contents of these files with zlib, and you&#8217;re not storing much, so all these files collectively take up only 925 bytes.
You&#8217;ll add some larger content to the repository to demonstrate an interesting feature of Git.
To demonstrate, we&#8217;ll add the <code>repo.rb</code> file from the Grit library – this is about a 22K source code file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ curl https://raw.githubusercontent.com/mojombo/grit/master/lib/grit/repo.rb &gt; repo.rb
$ git add repo.rb
$ git commit -m 'added repo.rb'
[master 484a592] added repo.rb
 3 files changed, 709 insertions(+), 2 deletions(-)
 delete mode 100644 bak/test.txt
 create mode 100644 repo.rb
 rewrite test.txt (100%)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look at the resulting tree, you can see the SHA-1 value your repo.rb file got for the blob object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p master^{tree}
100644 blob fa49b077972391ad58037050f2a75f74e3671e92      new.txt
100644 blob 033b4468fa6b2a9547a70d88d1bbe8bf3f9ed0d5      repo.rb
100644 blob e3f094f522629ae358806b17daf78246c27c007b      test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then use <code>git cat-file</code> to see how big that object is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -s 033b4468fa6b2a9547a70d88d1bbe8bf3f9ed0d5
22044</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, modify that file a little, and see what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ echo '# testing' &gt;&gt; repo.rb
$ git commit -am 'modified repo a bit'
[master 2431da6] modified repo.rb a bit
 1 file changed, 1 insertion(+)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the tree created by that commit, and you see something interesting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p master^{tree}
100644 blob fa49b077972391ad58037050f2a75f74e3671e92      new.txt
100644 blob b042a60ef7dff760008df33cee372b945b6e884e      repo.rb
100644 blob e3f094f522629ae358806b17daf78246c27c007b      test.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>The blob is now a different blob, which means that although you added only a single line to the end of a 400-line file, Git stored that new content as a completely new object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -s b042a60ef7dff760008df33cee372b945b6e884e
22054</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have two nearly identical 22K objects on your disk.
Wouldn&#8217;t it be nice if Git could store one of them in full but then the second object only as the delta between it and the first?</p>
</div>
<div class="paragraph">
<p>It turns out that it can.
The initial format in which Git saves objects on disk is called a &#8220;loose&#8221; object format.
However, occasionally Git packs up several of these objects into a single binary file called a &#8220;packfile&#8221; in order to save space and be more efficient.
Git does this if you have too many loose objects around, if you run the <code>git gc</code> command manually, or if you push to a remote server.
To see what happens, you can manually ask Git to pack up the objects by calling the <code>git gc</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git gc
Counting objects: 18, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (14/14), done.
Writing objects: 100% (18/18), done.
Total 18 (delta 3), reused 0 (delta 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look in your objects directory, you&#8217;ll find that most of your objects are gone, and a new pair of files has appeared:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/objects -type f
.git/objects/bd/9dbf5aae1a3862dd1526723246b20206e5fc37
.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4
.git/objects/info/packs
.git/objects/pack/pack-978e03944f5c581011e6998cd0e9e30000905586.idx
.git/objects/pack/pack-978e03944f5c581011e6998cd0e9e30000905586.pack</code></pre>
</div>
</div>
<div class="paragraph">
<p>The objects that remain are the blobs that aren&#8217;t pointed to by any commit – in this case, the &#8220;what is up, doc?&#8221;
example and the &#8220;test content&#8221; example blobs you created earlier.
Because you never added them to any commits, they&#8217;re considered dangling and aren&#8217;t packed up in your new packfile.</p>
</div>
<div class="paragraph">
<p>The other files are your new packfile and an index.
The packfile is a single file containing the contents of all the objects that were removed from your filesystem.
The index is a file that contains offsets into that packfile so you can quickly seek to a specific object.
What is cool is that although the objects on disk before you ran the <code>gc</code> were collectively about 22K in size, the new packfile is only 7K.
You&#8217;ve cut your disk usage by ⅔ by packing your objects.</p>
</div>
<div class="paragraph">
<p>How does Git do this?
When Git packs objects, it looks for files that are named and sized similarly, and stores just the deltas from one version of the file to the next.
You can look into the packfile and see what Git did to save space.
The <code>git verify-pack</code> plumbing command allows you to see what was packed up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git verify-pack -v .git/objects/pack/pack-978e03944f5c581011e6998cd0e9e30000905586.idx
2431da676938450a4d72e260db3bf7b0f587bbc1 commit 223 155 12
69bcdaff5328278ab1c0812ce0e07fa7d26a96d7 commit 214 152 167
80d02664cb23ed55b226516648c7ad5d0a3deb90 commit 214 145 319
43168a18b7613d1281e5560855a83eb8fde3d687 commit 213 146 464
092917823486a802e94d727c820a9024e14a1fc2 commit 214 146 610
702470739ce72005e2edff522fde85d52a65df9b commit 165 118 756
d368d0ac0678cbe6cce505be58126d3526706e54 tag    130 122 874
fe879577cb8cffcdf25441725141e310dd7d239b tree   136 136 996
d8329fc1cc938780ffdd9f94e0d364e0ea74f579 tree   36 46 1132
deef2e1b793907545e50a2ea2ddb5ba6c58c4506 tree   136 136 1178
d982c7cb2c2a972ee391a85da481fc1f9127a01d tree   6 17 1314 1 \
  deef2e1b793907545e50a2ea2ddb5ba6c58c4506
3c4e9cd789d88d8d89c1073707c3585e41b0e614 tree   8 19 1331 1 \
  deef2e1b793907545e50a2ea2ddb5ba6c58c4506
0155eb4229851634a0f03eb265b69f5a2d56f341 tree   71 76 1350
83baae61804e65cc73a7201a7252750c76066a30 blob   10 19 1426
fa49b077972391ad58037050f2a75f74e3671e92 blob   9 18 1445
b042a60ef7dff760008df33cee372b945b6e884e blob   22054 5799 1463
033b4468fa6b2a9547a70d88d1bbe8bf3f9ed0d5 blob   9 20 7262 1 \
  b042a60ef7dff760008df33cee372b945b6e884e
1f7a7a472abf3dd9643fd615f6da379c4acb3e3a blob   10 19 7282
non delta: 15 objects
chain length = 1: 3 objects
.git/objects/pack/pack-978e03944f5c581011e6998cd0e9e30000905586.pack: ok</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>033b4</code> blob, which if you remember was the first version of your repo.rb file, is referencing the <code>b042a</code> blob, which was the second version of the file.
The third column in the output is the size of the object in the pack, so you can see that <code>b042a</code> takes up 22K of the file, but that <code>033b4</code> only takes up 9 bytes.
What is also interesting is that the second version of the file is the one that is stored intact, whereas the original version is stored as a delta – this is because you&#8217;re most likely to need faster access to the most recent version of the file.</p>
</div>
<div class="paragraph">
<p>The really nice thing about this is that it can be repacked at any time.
Git will occasionally repack your database automatically, always trying to save more space, but you can also manually repack at any time by running <code>git gc</code> by hand.</p>
</div>
</div>
<div class="sect2">
<h3 id="_refspec">The Refspec</h3>
<div class="paragraph">
<p>Throughout this book, we&#8217;ve used simple mappings from remote branches to local references, but they can be more complex.
Suppose you add a remote like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git remote add origin https://github.com/schacon/simplegit-progit</code></pre>
</div>
</div>
<div class="paragraph">
<p>It adds a section to your <code>.git/config</code> file, specifying the name of the remote (<code>origin</code>), the URL of the remote repository, and the refspec for fetching:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[remote "origin"]
	url = https://github.com/schacon/simplegit-progit
	fetch = +refs/heads/*:refs/remotes/origin/*</code></pre>
</div>
</div>
<div class="paragraph">
<p>The format of the refspec is an optional <code>+</code>, followed by <code>&lt;src&gt;:&lt;dst&gt;</code>, where <code>&lt;src&gt;</code> is the pattern for references on the remote side and <code>&lt;dst&gt;</code> is where those references will be written locally.
The <code>+</code> tells Git to update the reference even if it isn&#8217;t a fast-forward.</p>
</div>
<div class="paragraph">
<p>In the default case that is automatically written by a <code>git remote add</code> command, Git fetches all the references under <code>refs/heads/</code> on the server and writes them to <code>refs/remotes/origin/</code> locally.
So, if there is a <code>master</code> branch on the server, you can access the log of that branch locally via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log origin/master
$ git log remotes/origin/master
$ git log refs/remotes/origin/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>They&#8217;re all equivalent, because Git expands each of them to <code>refs/remotes/origin/master</code>.</p>
</div>
<div class="paragraph">
<p>If you want Git instead to pull down only the <code>master</code> branch each time, and not every other branch on the remote server, you can change the fetch line to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>fetch = +refs/heads/master:refs/remotes/origin/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is just the default refspec for <code>git fetch</code> for that remote.
If you want to do something one time, you can specify the refspec on the command line, too.
To pull the <code>master</code> branch on the remote down to <code>origin/mymaster</code> locally, you can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch origin master:refs/remotes/origin/mymaster</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify multiple refspecs.
On the command line, you can pull down several branches like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fetch origin master:refs/remotes/origin/mymaster \
	 topic:refs/remotes/origin/topic
From git@github.com:schacon/simplegit
 ! [rejected]        master     -&gt; origin/mymaster  (non fast forward)
 * [new branch]      topic      -&gt; origin/topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the  master branch pull was rejected because it wasn&#8217;t a fast-forward reference.
You can override that by specifying the <code>+</code> in front of the refspec.</p>
</div>
<div class="paragraph">
<p>You can also specify multiple refspecs for fetching in your configuration file.
If you want to always fetch the master and experiment branches, add two lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[remote "origin"]
	url = https://github.com/schacon/simplegit-progit
	fetch = +refs/heads/master:refs/remotes/origin/master
	fetch = +refs/heads/experiment:refs/remotes/origin/experiment</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can&#8217;t use partial globs in the pattern, so this would be invalid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>fetch = +refs/heads/qa*:refs/remotes/origin/qa*</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, you can use namespaces (or directories) to accomplish something like that.
If you have a QA team that pushes a series of branches, and you want to get the master branch and any of the QA team&#8217;s branches but nothing else, you can use a config section like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[remote "origin"]
	url = https://github.com/schacon/simplegit-progit
	fetch = +refs/heads/master:refs/remotes/origin/master
	fetch = +refs/heads/qa/*:refs/remotes/origin/qa/*</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have a complex workflow process that has a QA team pushing branches, developers pushing branches, and integration teams pushing and collaborating on remote branches, you can namespace them easily this way.</p>
</div>
<div class="sect3">
<h4 id="_pushing_refspecs">Pushing Refspecs</h4>
<div class="paragraph">
<p>It&#8217;s nice that you can fetch namespaced references that way, but how does the QA team get their branches into a <code>qa/</code> namespace in the first place?
You accomplish that by using refspecs to push.</p>
</div>
<div class="paragraph">
<p>If the QA team wants to push their <code>master</code> branch to <code>qa/master</code> on the remote server, they can run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin master:refs/heads/qa/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>If they want Git to do that automatically each time they run <code>git push origin</code>, they can add a <code>push</code> value to their config file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[remote "origin"]
	url = https://github.com/schacon/simplegit-progit
	fetch = +refs/heads/*:refs/remotes/origin/*
	push = refs/heads/master:refs/heads/qa/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, this will cause a <code>git push origin</code> to push the local <code>master</code> branch to the remote <code>qa/master</code> branch by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deleting_references">Deleting References</h4>
<div class="paragraph">
<p>You can also use the refspec to delete references from the remote server by running something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git push origin :topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the refspec is <code>&lt;src&gt;:&lt;dst&gt;</code>, by leaving off the <code>&lt;src&gt;</code> part, this basically says to make the topic branch on the remote nothing, which deletes it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transfer_protocols">Transfer Protocols</h3>
<div class="paragraph">
<p>Git can transfer data between two repositories in two major ways: the &#8220;dumb&#8221; protocol and the &#8220;smart&#8221; protocol.
This section will quickly cover how these two main protocols operate.</p>
</div>
<div class="sect3">
<h4 id="_the_dumb_protocol">The Dumb Protocol</h4>
<div class="paragraph">
<p>If you&#8217;re setting up a repository to be served read-only over HTTP, the dumb protocol is likely what will be used.
This protocol is called &#8220;dumb&#8221; because it requires no Git-specific code on the server side during the transport process; the fetch process is a series of HTTP <code>GET</code> requests, where the client can assume the layout of the Git repository on the server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The dumb protocol is fairly rarely used these days.
It&#8217;s difficult to secure or make private, so most Git hosts (both cloud-based and on-premises) will refuse to use it.
It&#8217;s generally advised to use the smart protocol, which we describe a bit further on.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s follow the <code>http-fetch</code> process for the simplegit library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git clone http://server/simplegit-progit.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first thing this command does is pull down the <code>info/refs</code> file.
This file is written by the <code>update-server-info</code> command, which is why you need to enable that as a <code>post-receive</code> hook in order for the HTTP transport to work properly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET info/refs
ca82a6dff817ec66f44342007202690a93763949     refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you have a list of the remote references and SHAs.
Next, you look for what the HEAD reference is so you know what to check out when you&#8217;re finished:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET HEAD
ref: refs/heads/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to check out the <code>master</code> branch when you&#8217;ve completed the process.
At this point, you&#8217;re ready to start the walking process.
Because your starting point is the <code>ca82a6</code> commit object you saw in the <code>info/refs</code> file, you start by fetching that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/ca/82a6dff817ec66f44342007202690a93763949
(179 bytes of binary data)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You get an object back – that object is in loose format on the server, and you fetched it over a static HTTP GET request.
You can zlib-uncompress it, strip off the header, and look at the commit content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git cat-file -p ca82a6dff817ec66f44342007202690a93763949
tree cfda3bf379e4f8dba8717dee55aab78aef7f4daf
parent 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
author Scott Chacon &lt;schacon@gmail.com&gt; 1205815931 -0700
committer Scott Chacon &lt;schacon@gmail.com&gt; 1240030591 -0700

changed the version number</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you have two more objects to retrieve – <code>cfda3b</code>, which is the tree of content that the commit we just retrieved points to; and <code>085bb3</code>, which is the parent commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/08/5bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
(179 bytes of data)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That gives you your next commit object.
Grab the tree object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/cf/da3bf379e4f8dba8717dee55aab78aef7f4daf
(404 - Not Found)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Oops – it looks like that tree object isn&#8217;t in loose format on the server, so you get a 404 response back.
There are a couple of reasons for this – the object could be in an alternate repository, or it could be in a packfile in this repository.
Git checks for any listed alternates first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/info/http-alternates
(empty file)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this comes back with a list of alternate URLs, Git checks for loose files and packfiles there – this is a nice mechanism for projects that are forks of one another to share objects on disk.
However, because no alternates are listed in this case, your object must be in a packfile.
To see what packfiles are available on this server, you need to get the <code>objects/info/packs</code> file, which contains a listing of them (also generated by <code>update-server-info</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/info/packs
P pack-816a9b2334da9953e530f27bcac22082a9f5b835.pack</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is only one packfile on the server, so your object is obviously in there, but you&#8217;ll check the index file to make sure.
This is also useful if you have multiple packfiles on the server, so you can see which packfile contains the object you need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/pack/pack-816a9b2334da9953e530f27bcac22082a9f5b835.idx
(4k of binary data)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you have the packfile index, you can see if your object is in it – because the index lists the SHAs of the objects contained in the packfile and the offsets to those objects.
Your object is there, so go ahead and get the whole packfile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET objects/pack/pack-816a9b2334da9953e530f27bcac22082a9f5b835.pack
(13k of binary data)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have your tree object, so you continue walking your commits.
They&#8217;re all also within the packfile you just downloaded, so you don&#8217;t have to do any more requests to your server.
Git checks out a working copy of the <code>master</code> branch that was pointed to by the HEAD reference you downloaded at the beginning.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_smart_protocol">The Smart Protocol</h4>
<div class="paragraph">
<p>The dumb protocol is simple but a bit inefficient, and it can&#8217;t handle writing of data from the client to the server.
The smart protocol is a more common method of transferring data, but it requires a process on the remote end that is intelligent about Git – it can read local data, figure out what the client has and needs, and generate a custom packfile for it.
There are two sets of processes for transferring data: a pair for uploading data and a pair for downloading data.</p>
</div>
<div class="sect4">
<h5 id="_uploading_data">Uploading Data</h5>
<div class="paragraph">
<p>
To upload data to a remote process, Git uses the <code>send-pack</code> and <code>receive-pack</code> processes.
The <code>send-pack</code> process runs on the client and connects to a <code>receive-pack</code> process on the remote side.</p>
</div>
<div class="sect5">
<h6 id="_ssh">SSH</h6>
<div class="paragraph">
<p>For example, say you run <code>git push origin master</code> in your project, and <code>origin</code> is defined as a URL that uses the SSH protocol.
Git fires up the <code>send-pack</code> process, which initiates a connection over SSH to your server.
It tries to run a command on the remote server via an SSH call that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ssh -x git@server "git-receive-pack 'simplegit-progit.git'"
005bca82a6dff817ec66f4437202690a93763949 refs/heads/master report-status \
	delete-refs side-band-64k quiet ofs-delta \
	agent=git/2:2.1.1+github-607-gfba4028 delete-refs
003e085bb3bcb608e1e84b2432f8ecbe6306e7e7 refs/heads/topic
0000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>git-receive-pack</code> command immediately responds with one line for each reference it currently has – in this case, just the <code>master</code> branch and its SHA.
The first line also has a list of the server&#8217;s capabilities (here, <code>report-status</code>, <code>delete-refs</code>, and some others, including the client identifier).</p>
</div>
<div class="paragraph">
<p>Each line starts with a 4-character hex value specifying how long the rest of the line is.
Your first line starts with 005b, which is 91 in hex, meaning that 91 bytes remain on that line.
The next line starts with 003e, which is 62, so you read the remaining 62 bytes.
The next line is 0000, meaning the server is done with its references listing.</p>
</div>
<div class="paragraph">
<p>Now that it knows the server&#8217;s state, your <code>send-pack</code> process determines what commits it has that the server doesn&#8217;t.
For each reference that this push will update, the <code>send-pack</code> process tells the <code>receive-pack</code> process that information.
For instance, if you&#8217;re updating the <code>master</code> branch and adding an <code>experiment</code> branch, the <code>send-pack</code> response may look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>0085ca82a6dff817ec66f44342007202690a93763949  15027957951b64cf874c3557a0f3547bd83b3ff6 \
	refs/heads/master report-status
00670000000000000000000000000000000000000000 cdfdb42577e2506715f8cfeacdbabc092bf63e8d \
	refs/heads/experiment
0000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Git sends a line for each reference you&#8217;re updating with the line&#8217;s length, the old SHA, the new SHA, and the reference that is being updated.
The first line also has the client&#8217;s capabilities.
The SHA-1 value of all '0&#8217;s means that nothing was there before – because you&#8217;re adding the experiment reference.
If you were deleting a reference, you would see the opposite: all '0&#8217;s on the right side.</p>
</div>
<div class="paragraph">
<p>Next, the client sends a packfile of all the objects the server doesn&#8217;t have yet.
Finally, the server responds with a success (or failure) indication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>000Aunpack ok</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_http_s">HTTP(S)</h6>
<div class="paragraph">
<p>This process is mostly the same over HTTP, though the handshaking is a bit different.
The connection is initiated with this request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET http://server/simplegit-progit.git/info/refs?service=git-receive-pack
001f# service=git-receive-pack
000000ab6c5f0e45abd7832bf23074a333f739977c9e8188 refs/heads/master \
	report-status delete-refs side-band-64k quiet ofs-delta \
	agent=git/2:2.1.1~vmg-bitmaps-bugaloo-608-g116744e
0000</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the end of the first client-server exchange.
The client then makes another request, this time a <code>POST</code>, with the data that <code>git-upload-pack</code> provides.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; POST http://server/simplegit-progit.git/git-receive/pack</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>POST</code> request includes the <code>send-pack</code> output and the packfile as its payload.
The server then indicates success or failure with its HTTP response.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_downloading_data">Downloading Data</h5>
<div class="paragraph">
<p>
When you download data, the <code>fetch-pack</code> and <code>upload-pack</code> processes are involved.
The client initiates a <code>fetch-pack</code> process that connects to an <code>upload-pack</code> process on the remote side to negotiate what data will be transferred down.</p>
</div>
<div class="sect5">
<h6 id="_ssh_2">SSH</h6>
<div class="paragraph">
<p>If you&#8217;re doing the fetch over SSH, <code>fetch-pack</code> instead runs something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ ssh -x git@server "git-upload-pack 'simplegit-progit.git'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>After <code>fetch-pack</code> connects, <code>upload-pack</code> sends back something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>00dfca82a6dff817ec66f44342007202690a93763949 HEADmulti_ack thin-pack \
	side-band side-band-64k ofs-delta shallow no-progress include-tag \
	multi_ack_detailed symref=HEAD:refs/heads/master \
	agent=git/2:2.1.1+github-607-gfba4028
003fca82a6dff817ec66f44342007202690a93763949 refs/heads/master
0000</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is very similar to what <code>receive-pack</code> responds with, but the capabilities are different.
In addition, it sends back what HEAD points to (<code>symref=HEAD:refs/heads/master</code>) so the client knows what to check out if this is a clone.</p>
</div>
<div class="paragraph">
<p>At this point, the <code>fetch-pack</code> process looks at what objects it has and responds with the objects that it needs by sending &#8220;want&#8221; and then the SHA it wants.
It sends all the objects it already has with &#8220;have&#8221; and then the SHA.
At the end of this list, it writes &#8220;done&#8221; to initiate the <code>upload-pack</code> process to begin sending the packfile of the data it needs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>0054want ca82a6dff817ec66f44342007202690a93763949 ofs-delta
0032have 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
0000
0009done</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_http_s_2">HTTP(S)</h6>
<div class="paragraph">
<p>The handshake for a fetch operation takes two HTTP requests.
The first is a <code>GET</code> to the same endpoint used in the dumb protocol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; GET $GIT_URL/info/refs?service=git-upload-pack
001e# service=git-upload-pack
000000e7ca82a6dff817ec66f44342007202690a93763949 HEADmulti_ack thin-pack \
	side-band side-band-64k ofs-delta shallow no-progress include-tag \
	multi_ack_detailed no-done symref=HEAD:refs/heads/master \
	agent=git/2:2.1.1+github-607-gfba4028
003fca82a6dff817ec66f44342007202690a93763949 refs/heads/master
0000</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is very similar to invoking <code>git-upload-pack</code> over an SSH connection, but the second exchange is performed as a separate request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>=&gt; POST $GIT_URL/git-upload-pack HTTP/1.0
0032want 0a53e9ddeaddad63ad106860237bbf53411d11a7
0032have 441b40d833fdfa93eb2908e52742248faf0ee993
0000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, this is the same format as above.
The response to this request indicates success or failure, and includes the packfile.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_protocols_summary">Protocols Summary</h4>
<div class="paragraph">
<p>This section contains a very basic overview of the transfer protocols.
The protocol includes many other features, such as <code>multi_ack</code> or <code>side-band</code> capabilities, but covering them is outside the scope of this book.
We&#8217;ve tried to give you a sense of the general back-and-forth between client and server; if you need more knowledge than this, you&#8217;ll probably want to take a look at the Git source code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_maintenance_and_data_recovery">Maintenance and Data Recovery</h3>
<div class="paragraph">
<p>Occasionally, you may have to do some cleanup – make a repository more compact, clean up an imported repository, or recover lost work.
This section will cover some of these scenarios.</p>
</div>
<div class="sect3">
<h4 id="_git_gc">Maintenance</h4>
<div class="paragraph">
<p>Occasionally, Git automatically runs a command called &#8220;auto gc&#8221;.
Most of the time, this command does nothing.
However, if there are too many loose objects (objects not in a packfile) or too many packfiles, Git launches a full-fledged <code>git gc</code> command.
The &#8220;gc&#8221; stands for garbage collect, and the command does a number of things: it gathers up all the loose objects and places them in packfiles, it consolidates packfiles into one big packfile, and it removes objects that aren&#8217;t reachable from any commit and are a few months old.</p>
</div>
<div class="paragraph">
<p>You can run auto gc manually as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git gc --auto</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, this generally does nothing.
You must have around 7,000 loose objects or more than 50 packfiles for Git to fire up a real gc command.
You can modify these limits with the <code>gc.auto</code> and <code>gc.autopacklimit</code> config settings, respectively.</p>
</div>
<div class="paragraph">
<p>The other thing <code>gc</code> will do is pack up your references into a single file.
Suppose your repository contains the following branches and tags:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ find .git/refs -type f
.git/refs/heads/experiment
.git/refs/heads/master
.git/refs/tags/v1.0
.git/refs/tags/v1.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run <code>git gc</code>, you&#8217;ll no longer have these files in the <code>refs</code> directory.
Git will move them for the sake of efficiency into a file named <code>.git/packed-refs</code> that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ cat .git/packed-refs
# pack-refs with: peeled fully-peeled
cac0cab538b970a37ea1e769cbbde608743bc96d refs/heads/experiment
ab1afef80fac8e34258ff41fc1b867c702daa24b refs/heads/master
cac0cab538b970a37ea1e769cbbde608743bc96d refs/tags/v1.0
9585191f37f7b0fb9444f35a9bf50de191beadc2 refs/tags/v1.1
^1a410efbd13591db07496601ebc7a059dd55cfe9</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you update a reference, Git doesn&#8217;t edit this file but instead writes a new file to <code>refs/heads</code>.
To get the appropriate SHA for a given reference, Git checks for that reference in the <code>refs</code> directory and then checks the <code>packed-refs</code> file as a fallback.
However, if you can&#8217;t find a reference in the <code>refs</code> directory, it&#8217;s probably in your <code>packed-refs</code> file.</p>
</div>
<div class="paragraph">
<p>Notice the last line of the file, which begins with a <code>^</code>.
This means the tag directly above is an annotated tag and that line is the commit that the annotated tag points to.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_recovery">Data Recovery</h4>
<div class="paragraph">
<p>At some point in your Git journey, you may accidentally lose a commit.
Generally, this happens because you force-delete a branch that had work on it, and it turns out you wanted the branch after all; or you hard-reset a branch, thus abandoning commits that you wanted something from.
Assuming this happens, how can you get your commits back?</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that hard-resets the master branch in your test repository to an older commit and then recovers the lost commits.
First, let&#8217;s review where your repository is at this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --pretty=oneline
ab1afef80fac8e34258ff41fc1b867c702daa24b modified repo a bit
484a59275031909e19aadb7c92262719cfcdf19a added repo.rb
1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
cac0cab538b970a37ea1e769cbbde608743bc96d second commit
fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, move the <code>master</code> branch back to the middle commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git reset --hard 1a410efbd13591db07496601ebc7a059dd55cfe9
HEAD is now at 1a410ef third commit
$ git log --pretty=oneline
1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
cac0cab538b970a37ea1e769cbbde608743bc96d second commit
fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ve effectively lost the top two commits – you have no branch from which those commits are reachable.
You need to find the latest commit SHA and then add a branch that points to it.
The trick is finding that latest commit SHA – it&#8217;s not like you&#8217;ve memorized it, right?</p>
</div>
<div class="paragraph">
<p>Often, the quickest way is to use a tool called <code>git reflog</code>.
As you&#8217;re working, Git silently records what your HEAD is every time you change it.
Each time you commit or change branches, the reflog is updated.
The reflog is also updated by the <code>git update-ref</code> command, which is another reason to use it instead of just writing the SHA value to your ref files, as we covered in <a href="#_git_refs">Git References</a>.
You can see where you&#8217;ve been at any time by running <code>git reflog</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git reflog
1a410ef HEAD@{0}: reset: moving to 1a410ef
ab1afef HEAD@{1}: commit: modified repo.rb a bit
484a592 HEAD@{2}: commit: added repo.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see the two commits that we have had checked out, however there is not much information here.
To see the same information in a much more useful way, we can run <code>git log -g</code>, which will give you a normal log output for your reflog.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log -g
commit 1a410efbd13591db07496601ebc7a059dd55cfe9
Reflog: HEAD@{0} (Scott Chacon &lt;schacon@gmail.com&gt;)
Reflog message: updating HEAD
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri May 22 18:22:37 2009 -0700

		third commit

commit ab1afef80fac8e34258ff41fc1b867c702daa24b
Reflog: HEAD@{1} (Scott Chacon &lt;schacon@gmail.com&gt;)
Reflog message: updating HEAD
Author: Scott Chacon &lt;schacon@gmail.com&gt;
Date:   Fri May 22 18:15:24 2009 -0700

       modified repo.rb a bit</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks like the bottom commit is the one you lost, so you can recover it by creating a new branch at that commit.
For example, you can start a branch named <code>recover-branch</code> at that commit (ab1afef):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch recover-branch ab1afef
$ git log --pretty=oneline recover-branch
ab1afef80fac8e34258ff41fc1b867c702daa24b modified repo a bit
484a59275031909e19aadb7c92262719cfcdf19a added repo.rb
1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
cac0cab538b970a37ea1e769cbbde608743bc96d second commit
fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cool – now you have a branch named <code>recover-branch</code> that is where your <code>master</code> branch used to be, making the first two commits reachable again.
Next, suppose your loss was for some reason not in the reflog – you can simulate that by removing <code>recover-branch</code> and deleting the reflog.
Now the first two commits aren&#8217;t reachable by anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git branch -D recover-branch
$ rm -Rf .git/logs/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the reflog data is kept in the <code>.git/logs/</code> directory, you effectively have no reflog.
How can you recover that commit at this point?
One way is to use the <code>git fsck</code> utility, which checks your database for integrity.
If you run it with the <code>--full</code> option, it shows you all objects that aren&#8217;t pointed to by another object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git fsck --full
Checking object directories: 100% (256/256), done.
Checking objects: 100% (18/18), done.
dangling blob d670460b4b4aece5915caf5c68d12f560a9fe3e4
dangling commit ab1afef80fac8e34258ff41fc1b867c702daa24b
dangling tree aea790b9a58f6cf6f2804eeac9f0abbe9631e4c9
dangling blob 7108f7ecb345ee9d0084193f147cdad4d2998293</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, you can see your missing commit after the string &#8220;dangling commit&#8221;.
You can recover it the same way, by adding a branch that points to that SHA.</p>
</div>
</div>
<div class="sect3">
<h4 id="_removing_objects">Removing Objects</h4>
<div class="paragraph">
<p>There are a lot of great things about Git, but one feature that can cause issues is the fact that a <code>git clone</code> downloads the entire history of the project, including every version of every file.
This is fine if the whole thing is source code, because Git is highly optimized to compress that data efficiently.
However, if someone at any point in the history of your project added a single huge file, every clone for all time will be forced to download that large file, even if it was removed from the project in the very next commit.
Because it&#8217;s reachable from the history, it will always be there.</p>
</div>
<div class="paragraph">
<p>This can be a huge problem when you&#8217;re converting Subversion or Perforce repositories into Git.
Because you don&#8217;t download the whole history in those systems, this type of addition carries few consequences.
If you did an import from another system or otherwise find that your repository is much larger than it should be, here is how you can find and remove large objects.</p>
</div>
<div class="paragraph">
<p><strong>Be warned: this technique is destructive to your commit history.</strong>
It rewrites every commit object since the earliest tree you have to modify to remove a large file reference.
If you do this immediately after an import, before anyone has started to base work on the commit, you&#8217;re fine – otherwise, you have to notify all contributors that they must rebase their work onto your new commits.</p>
</div>
<div class="paragraph">
<p>To demonstrate, you&#8217;ll add a large file into your test repository, remove it in the next commit, find it, and remove it permanently from the repository.
First, add a large object to your history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ curl https://www.kernel.org/pub/software/scm/git/git-2.1.0.tar.gz &gt; git.tgz
$ git add git.tgz
$ git commit -m 'add git tarball'
[master 7b30847] add git tarball
 1 file changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 git.tgz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Oops – you didn&#8217;t want to add a huge tarball to your project.
Better get rid of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rm git.tgz
rm 'git.tgz'
$ git commit -m 'oops - removed large tarball'
[master dadf725] oops - removed large tarball
 1 file changed, 0 insertions(+), 0 deletions(-)
 delete mode 100644 git.tgz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, <code>gc</code> your database and see how much space you&#8217;re using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git gc
Counting objects: 17, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (13/13), done.
Writing objects: 100% (17/17), done.
Total 17 (delta 1), reused 10 (delta 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run the <code>count-objects</code> command to quickly see how much space you&#8217;re using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git count-objects -v
count: 7
size: 32
in-pack: 17
packs: 1
size-pack: 4868
prune-packable: 0
garbage: 0
size-garbage: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>size-pack</code> entry is the size of your packfiles in kilobytes, so you&#8217;re using almost 5MB.
Before the last commit, you were using closer to 2K – clearly, removing the file from the previous commit didn&#8217;t remove it from your history.
Every time anyone clones this repository, they will have to clone all 5MB just to get this tiny project, because you accidentally added a big file.
Let&#8217;s get rid of it.</p>
</div>
<div class="paragraph">
<p>First you have to find it.
In this case, you already know what file it is.
But suppose you didn&#8217;t; how would you identify what file or files were taking up so much space?
If you run <code>git gc</code>, all the objects are in a packfile; you can identify the big objects by running another plumbing command called <code>git verify-pack</code> and sorting on the third field in the output, which is file size.
You can also pipe it through the <code>tail</code> command because you&#8217;re only interested in the last few largest files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git verify-pack -v .git/objects/pack/pack-29…69.idx \
  | sort -k 3 -n \
  | tail -3
dadf7258d699da2c8d89b09ef6670edb7d5f91b4 commit 229 159 12
033b4468fa6b2a9547a70d88d1bbe8bf3f9ed0d5 blob   22044 5792 4977696
82c99a3e86bb1267b236a4b6eff7868d97489af1 blob   4975916 4976258 1438</code></pre>
</div>
</div>
<div class="paragraph">
<p>The big object is at the bottom: 5MB.
To find out what file it is, you&#8217;ll use the <code>rev-list</code> command, which you used briefly in <a href="#_enforcing_commit_message_format">Enforcing a Specific Commit-Message Format</a>.
If you pass <code>--objects</code> to <code>rev-list</code>, it lists all the commit SHAs and also the blob SHAs with the file paths associated with them.
You can use this to find your blob&#8217;s name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git rev-list --objects --all | grep 82c99a3
82c99a3e86bb1267b236a4b6eff7868d97489af1 git.tgz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you need to remove this file from all trees in your past.
You can easily see what commits modified this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git log --oneline --branches -- git.tgz
dadf725 oops - removed large tarball
7b30847 add git tarball</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must rewrite all the commits downstream from <code>7b30847</code> to fully remove this file from your Git history.
To do so, you use <code>filter-branch</code>, which you used in <a href="#_rewriting_history">Rewriting History</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git filter-branch --index-filter \
  'git rm --cached --ignore-unmatch git.tgz' -- 7b30847^..
Rewrite 7b30847d080183a1ab7d18fb202473b3096e9f34 (1/2)rm 'git.tgz'
Rewrite dadf7258d699da2c8d89b09ef6670edb7d5f91b4 (2/2)
Ref 'refs/heads/master' was rewritten</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--index-filter</code> option is similar to the <code>--tree-filter</code> option used in <a href="#_rewriting_history">Rewriting History</a>, except that instead of passing a command that modifies files checked out on disk, you&#8217;re modifying your staging area or index each time.</p>
</div>
<div class="paragraph">
<p>Rather than remove a specific file with something like <code>rm file</code>, you have to remove it with <code>git rm --cached</code> – you must remove it from the index, not from disk.
The reason to do it this way is speed – because Git doesn&#8217;t have to check out each revision to disk before running your filter, the process can be much, much faster.
You can accomplish the same task with <code>--tree-filter</code> if you want.
The <code>--ignore-unmatch</code> option to <code>git rm</code> tells it not to error out if the pattern you&#8217;re trying to remove isn&#8217;t there.
Finally, you ask <code>filter-branch</code> to rewrite your history only from the <code>6df7640</code> commit up, because you know that is where this problem started.
Otherwise, it will start from the beginning and will unnecessarily take longer.</p>
</div>
<div class="paragraph">
<p>Your history no longer contains a reference to that file.
However, your reflog and a new set of refs that Git added when you did the <code>filter-branch</code> under <code>.git/refs/original</code> still do, so you have to remove them and then repack the database.
You need to get rid of anything that has a pointer to those old commits before you repack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ rm -Rf .git/refs/original
$ rm -Rf .git/logs/
$ git gc
Counting objects: 15, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (11/11), done.
Writing objects: 100% (15/15), done.
Total 15 (delta 1), reused 12 (delta 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see how much space you saved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git count-objects -v
count: 11
size: 4904
in-pack: 15
packs: 1
size-pack: 8
prune-packable: 0
garbage: 0
size-garbage: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The packed repository size is down to 8K, which is much better than 5MB.
You can see from the size value that the big object is still in your loose objects, so it&#8217;s not gone; but it won&#8217;t be transferred on a push or subsequent clone, which is what is important.
If you really wanted to, you could remove the object completely by running <code>git prune</code> with the <code>--expire</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git prune --expire now
$ git count-objects -v
count: 0
size: 0
in-pack: 15
packs: 1
size-pack: 8
prune-packable: 0
garbage: 0
size-garbage: 0</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_environment_variables">Environment Variables</h3>
<div class="paragraph">
<p>Git always runs inside a <code>bash</code> shell, and uses a number of shell environment variables to determine how it behaves.
Occasionally, it comes in handy to know what these are, and how they can be used to make Git behave the way you want it to.
This isn&#8217;t an exhaustive list of all the environment variables Git pays attention to, but we&#8217;ll cover the most useful.</p>
</div>
<div class="sect3">
<h4 id="_global_behavior">Global Behavior</h4>
<div class="paragraph">
<p>Some of Git&#8217;s general behavior as a computer program depends on environment variables.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_EXEC_PATH</code></strong> determines where Git looks for its sub-programs (like <code>git-commit</code>, <code>git-diff</code>, and others).
  You can check the current setting by running <code>git --exec-path</code>.</p>
</div>
<div class="paragraph">
<p><strong><code>HOME</code></strong> isn&#8217;t usually considered customizable (too many other things depend on it), but it&#8217;s where Git looks for the global configuration file.
  If you want a truly portable Git installation, complete with global configuration, you can override <code>HOME</code> in the portable Git&#8217;s shell profile.</p>
</div>
<div class="paragraph">
<p><strong><code>PREFIX</code></strong> is similar, but for the system-wide configuration.
  Git looks for this file at <code>$PREFIX/etc/gitconfig</code>.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_CONFIG_NOSYSTEM</code></strong>, if set, disables the use of the system-wide configuration file.
  This is useful if your system config is interfering with your commands, but you don&#8217;t have access to change or remove it.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_PAGER</code></strong> controls the program used to display multi-page output on the command line.
If this is unset, <code>PAGER</code> will be used as a fallback.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_EDITOR</code></strong> is the editor Git will launch when the user needs to edit some text (a commit message, for example).
If unset, <code>EDITOR</code> will be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_repository_locations">Repository Locations</h4>
<div class="paragraph">
<p>Git uses several environment variables to determine how it interfaces with the current repository.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_DIR</code></strong> is the location of the <code>.git</code> folder.
If this isn&#8217;t specified, Git walks up the directory tree until it gets to <code>~</code> or <code>/</code>, looking for a <code>.git</code> directory at every step.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_CEILING_DIRECTORIES</code></strong> controls the behavior of searching for a <code>.git</code> directory.
If you access directories that are slow to load (such as those on a tape drive, or across a slow network connection), you may want to have Git stop trying earlier than it might otherwise, especially if Git is invoked when building your shell prompt.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_WORK_TREE</code></strong> is the location of the root of the working directory for a non-bare repository.
If not specified, the parent directory of <code>$GIT_DIR</code> is used.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_INDEX_FILE</code></strong> is the path to the index file (non-bare repositories only).</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_OBJECT_DIRECTORY</code></strong> can be used to specify the location of the directory that usually resides at <code>.git/objects</code>.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_ALTERNATE_OBJECT_DIRECTORIES</code></strong> is a colon-separated list (formatted like <code>/dir/one:/dir/two:…</code>) which tells Git where to check for objects if they aren&#8217;t in <code>GIT_OBJECT_DIRECTORY</code>.
If you happen to have a lot of projects with large files that have the exact same contents, this can be used to avoid storing too many copies of them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pathspecs">Pathspecs</h4>
<div class="paragraph">
<p>A &#8220;pathspec&#8221; refers to how you specify paths to things in Git, including the use of wildcards.
These are used in the <code>.gitignore</code> file, but also on the command-line (<code>git add *.c</code>).</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_GLOB_PATHSPECS</code> and <code>GIT_NOGLOB_PATHSPECS</code></strong> control the default behavior of wildcards in pathspecs.
If <code>GIT_GLOB_PATHSPECS</code> is set to 1, wildcard characters act as wildcards (which is the default); if <code>GIT_NOGLOB_PATHSPECS</code> is set to 1, wildcard characters only match themselves, meaning something like <code>*.c</code> would only match a file <em>named</em> &#8220;*.c&#8221;, rather than any file whose name ends with <code>.c</code>.
You can override this in individual cases by starting the pathspec with <code>:(glob)</code> or <code>:(literal)</code>, as in <code>:(glob)*.c</code>.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_LITERAL_PATHSPECS</code></strong> disables both of the above behaviors; no wildcard characters will work, and the override prefixes are disabled as well.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_ICASE_PATHSPECS</code></strong> sets all pathspecs to work in a case-insensitive manner.</p>
</div>
</div>
<div class="sect3">
<h4 id="_commiting">Commiting</h4>
<div class="paragraph">
<p>The final creation of a Git commit object is usually done by <code>git-commit-tree</code>, which uses these environment variables as its primary source of information, falling back to configuration values only if these aren&#8217;t present.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_AUTHOR_NAME</code></strong> is the human-readable name in the &#8220;author&#8221; field.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_AUTHOR_EMAIL</code></strong> is the email for the &#8220;author&#8221; field.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_AUTHOR_DATE</code></strong> is the timestamp used for the &#8220;author&#8221; field.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_COMMITTER_NAME</code></strong> sets the human name for the &#8220;committer&#8221; field.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_COMMITTER_EMAIL</code></strong> is the email address for the &#8220;committer&#8221; field.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_COMMITTER_DATE</code></strong> is used for the timestamp in the &#8220;committer&#8221; field.</p>
</div>
<div class="paragraph">
<p><strong><code>EMAIL</code></strong> is the fallback email address in case the <code>user.email</code> configuration value isn&#8217;t set.
If <em>this</em> isn&#8217;t set, Git falls back to the system user and host names.</p>
</div>
</div>
<div class="sect3">
<h4 id="_networking">Networking</h4>
<div class="paragraph">
<p>Git uses the <code>curl</code> library to do network operations over HTTP, so <strong><code>GIT_CURL_VERBOSE</code></strong> tells Git to emit all the messages generated by that library.
This is similar to doing <code>curl -v</code> on the command line.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_SSL_NO_VERIFY</code></strong> tells Git not to verify SSL certificates.
This can sometimes be necessary if you&#8217;re using a self-signed certificate to serve Git repositories over HTTPS, or you&#8217;re in the middle of setting up a Git server but haven&#8217;t installed a full certificate yet.</p>
</div>
<div class="paragraph">
<p>If the data rate of an HTTP operation is lower than <strong><code>GIT_HTTP_LOW_SPEED_LIMIT</code></strong> bytes per second for longer than <strong><code>GIT_HTTP_LOW_SPEED_TIME</code></strong> seconds, Git will abort that operation.
These values override the <code>http.lowSpeedLimit</code> and <code>http.lowSpeedTime</code> configuration values.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_HTTP_USER_AGENT</code></strong> sets the user-agent string used by Git when communicating over HTTP.
The default is a value like <code>git/2.0.0</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_diffing_and_merging">Diffing and Merging</h4>
<div class="paragraph">
<p><strong><code>GIT_DIFF_OPTS</code></strong> is a bit of a misnomer.
The only valid values are <code>-u&lt;n&gt;</code> or <code>--unified=&lt;n&gt;</code>, which controls the number of context lines shown in a <code>git diff</code> command.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_EXTERNAL_DIFF</code></strong> is used as an override for the <code>diff.external</code> configuration value.
If it&#8217;s set, Git will invoke this program when <code>git diff</code> is invoked.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_DIFF_PATH_COUNTER</code></strong> and <strong><code>GIT_DIFF_PATH_TOTAL</code></strong> are useful from inside the program specified by <code>GIT_EXTERNAL_DIFF</code> or <code>diff.external</code>.
The former represents which file in a series is being diffed (starting with 1), and the latter is the total number of files in the batch.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_MERGE_VERBOSITY</code></strong> controls the output for the recursive merge strategy.
The allowed values are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0 outputs nothing, except possibly a single error message.</p>
</li>
<li>
<p>1 shows only conflicts.</p>
</li>
<li>
<p>2 also shows file changes.</p>
</li>
<li>
<p>3 shows when files are skipped because they haven&#8217;t changed.</p>
</li>
<li>
<p>4 shows all paths as they are processed.</p>
</li>
<li>
<p>5 and above show detailed debugging information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default value is 2.</p>
</div>
</div>
<div class="sect3">
<h4 id="_debugging">Debugging</h4>
<div class="paragraph">
<p>Want to <em>really</em> know what Git is up to?
Git has a fairly complete set of traces embedded, and all you need to do is turn them on.
The possible values of these variables are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&#8220;true&#8221;, &#8220;1&#8221;, or &#8220;2&#8221; – the trace category is written to stderr.</p>
</li>
<li>
<p>An absolute path starting with <code>/</code> – the trace output will be written to that file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><code>GIT_TRACE</code></strong> controls general traces, which don&#8217;t fit into any specific category.
This includes the expansion of aliases, and delegation to other sub-programs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ GIT_TRACE=true git lga
20:12:49.877982 git.c:554               trace: exec: 'git-lga'
20:12:49.878369 run-command.c:341       trace: run_command: 'git-lga'
20:12:49.879529 git.c:282               trace: alias expansion: lga =&gt; 'log' '--graph' '--pretty=oneline' '--abbrev-commit' '--decorate' '--all'
20:12:49.879885 git.c:349               trace: built-in: git 'log' '--graph' '--pretty=oneline' '--abbrev-commit' '--decorate' '--all'
20:12:49.899217 run-command.c:341       trace: run_command: 'less'
20:12:49.899675 run-command.c:192       trace: exec: 'less'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>GIT_TRACE_PACK_ACCESS</code></strong> controls tracing of packfile access.
The first field is the packfile being accessed, the second is the offset within that file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ GIT_TRACE_PACK_ACCESS=true git status
20:10:12.081397 sha1_file.c:2088        .git/objects/pack/pack-c3fa...291e.pack 12
20:10:12.081886 sha1_file.c:2088        .git/objects/pack/pack-c3fa...291e.pack 34662
20:10:12.082115 sha1_file.c:2088        .git/objects/pack/pack-c3fa...291e.pack 35175
# […]
20:10:12.087398 sha1_file.c:2088        .git/objects/pack/pack-e80e...e3d2.pack 56914983
20:10:12.087419 sha1_file.c:2088        .git/objects/pack/pack-e80e...e3d2.pack 14303666
On branch master
Your branch is up-to-date with 'origin/master'.
nothing to commit, working directory clean</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>GIT_TRACE_PACKET</code></strong> enables packet-level tracing for network operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ GIT_TRACE_PACKET=true git ls-remote origin
20:15:14.867043 pkt-line.c:46           packet:          git&lt; # service=git-upload-pack
20:15:14.867071 pkt-line.c:46           packet:          git&lt; 0000
20:15:14.867079 pkt-line.c:46           packet:          git&lt; 97b8860c071898d9e162678ea1035a8ced2f8b1f HEAD\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow no-progress include-tag multi_ack_detailed no-done symref=HEAD:refs/heads/master agent=git/2.0.4
20:15:14.867088 pkt-line.c:46           packet:          git&lt; 0f20ae29889d61f2e93ae00fd34f1cdb53285702 refs/heads/ab/add-interactive-show-diff-func-name
20:15:14.867094 pkt-line.c:46           packet:          git&lt; 36dc827bc9d17f80ed4f326de21247a5d1341fbc refs/heads/ah/doc-gitk-config
# […]</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>GIT_TRACE_PERFORMANCE</code></strong> controls logging of performance data.
The output shows how long each particular git invocation takes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ GIT_TRACE_PERFORMANCE=true git gc
20:18:19.499676 trace.c:414             performance: 0.374835000 s: git command: 'git' 'pack-refs' '--all' '--prune'
20:18:19.845585 trace.c:414             performance: 0.343020000 s: git command: 'git' 'reflog' 'expire' '--all'
Counting objects: 170994, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (43413/43413), done.
Writing objects: 100% (170994/170994), done.
Total 170994 (delta 126176), reused 170524 (delta 125706)
20:18:23.567927 trace.c:414             performance: 3.715349000 s: git command: 'git' 'pack-objects' '--keep-true-parents' '--honor-pack-keep' '--non-empty' '--all' '--reflog' '--unpack-unreachable=2.weeks.ago' '--local' '--delta-base-offset' '.git/objects/pack/.tmp-49190-pack'
20:18:23.584728 trace.c:414             performance: 0.000910000 s: git command: 'git' 'prune-packed'
20:18:23.605218 trace.c:414             performance: 0.017972000 s: git command: 'git' 'update-server-info'
20:18:23.606342 trace.c:414             performance: 3.756312000 s: git command: 'git' 'repack' '-d' '-l' '-A' '--unpack-unreachable=2.weeks.ago'
Checking connectivity: 170994, done.
20:18:25.225424 trace.c:414             performance: 1.616423000 s: git command: 'git' 'prune' '--expire' '2.weeks.ago'
20:18:25.232403 trace.c:414             performance: 0.001051000 s: git command: 'git' 'rerere' 'gc'
20:18:25.233159 trace.c:414             performance: 6.112217000 s: git command: 'git' 'gc'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>GIT_TRACE_SETUP</code></strong> shows information about what Git is discovering about the repository and environment it&#8217;s interacting with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ GIT_TRACE_SETUP=true git status
20:19:47.086765 trace.c:315             setup: git_dir: .git
20:19:47.087184 trace.c:316             setup: worktree: /Users/ben/src/git
20:19:47.087191 trace.c:317             setup: cwd: /Users/ben/src/git
20:19:47.087194 trace.c:318             setup: prefix: (null)
On branch master
Your branch is up-to-date with 'origin/master'.
nothing to commit, working directory clean</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_miscellaneous">Miscellaneous</h4>
<div class="paragraph">
<p><strong><code>GIT_SSH</code></strong>, if specified, is a program that is invoked instead of <code>ssh</code> when Git tries to connect to an SSH host.
It is invoked like <code>$GIT_SSH [username@]host [-p &lt;port&gt;] &lt;command&gt;</code>.
Note that this isn&#8217;t the easiest way to customize how <code>ssh</code> is invoked; it won&#8217;t support extra command-line parameters, so you&#8217;d have to write a wrapper script and set <code>GIT_SSH</code> to point to it.
It&#8217;s probably easier just to use the <code>~/.ssh/config</code> file for that.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_ASKPASS</code></strong> is an override for the <code>core.askpass</code> configuration value.
This is the program invoked whenever Git needs to ask the user for credentials, which can expect a text prompt as a command-line argument, and should return the answer on <code>stdout</code>.
(See <a href="#_credential_caching">凭证存储</a> for more on this subsystem.)</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_NAMESPACE</code></strong> controls access to namespaced refs, and is equivalent to the <code>--namespace</code> flag.
This is mostly useful on the server side, where you may want to store multiple forks of a single repository in one repository, only keeping the refs separate.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_FLUSH</code></strong> can be used to force Git to use non-buffered I/O when writing incrementally to stdout.
A value of 1 causes Git to flush more often, a value of 0 causes all output to be buffered.
The default value (if this variable is not set) is to choose an appropriate buffering scheme depending on the activity and the output mode.</p>
</div>
<div class="paragraph">
<p><strong><code>GIT_REFLOG_ACTION</code></strong> lets you specify the descriptive text written to the reflog.
Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ GIT_REFLOG_ACTION="my action" git commit --allow-empty -m 'my message'
[master 9e3d55a] my message
$ git reflog -1
9e3d55a HEAD@{0}: my action: my message</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_7">Summary</h3>
<div class="paragraph">
<p>You should have a pretty good understanding of what Git does in the background and, to some degree, how it&#8217;s implemented.
This chapter has covered a number of plumbing commands – commands that are lower level and simpler than the porcelain commands you&#8217;ve learned about in the rest of the book.
Understanding how Git works at a lower level should make it easier to understand why it&#8217;s doing what it&#8217;s doing and also to write your own tools and helping scripts to make your specific workflow work for you.</p>
</div>
<div class="paragraph">
<p>Git as a content-addressable filesystem is a very powerful tool that you can easily use as more than just a VCS.
We hope you can use your newfound knowledge of Git internals to implement your own cool application of this technology and feel more comfortable using Git in more advanced ways.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_in_other_environments">Appendix A: Git in Other Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you read through the whole book, you&#8217;ve learned a lot about how to use Git at the command line.
You can work with local files, connect your repository to others over a network, and work effectively with others.
But the story doesn&#8217;t end there; Git is usually used as part of a larger ecosystem, and the terminal isn&#8217;t always the best way to work with it.
Now we&#8217;ll take a look at some of the other kinds of environments where Git can be useful, and how other applications (including yours) work alongside Git.</p>
</div>
<div class="sect2">
<h3 id="_graphical_interfaces">Graphical Interfaces</h3>
<div class="paragraph">
<p>
Git&#8217;s native environment is in the terminal.
New features show up there first, and only at the command line is the full power of Git completely at your disposal.
But plain text isn&#8217;t the best choice for all tasks; sometimes a visual representation is what you need, and some users are much more comfortable with a point-and-click interface.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that different interfaces are tailored for different workflows.
Some clients only expose only a carefully curated subset of Git functionality, in order to support a specific way of working that the author considers effective.
When viewed in this light, none of these tools can be called &#8220;better&#8221; than any of the others, they&#8217;re simply more fit for their intended purpose.
Also note that there&#8217;s nothing these graphical clients can do that the command-line client can&#8217;t; the command-line is still where you&#8217;ll have the most power and control when working with your repositories.</p>
</div>
<div class="sect3">
<h4 id="__code_gitk_code_and_code_git_gui_code"><code>gitk</code> and <code>git-gui</code></h4>
<div class="paragraph">
<p>
When you install Git, you also get its visual tools, <code>gitk</code> and <code>git-gui</code>.</p>
</div>
<div class="paragraph">
<p><code>gitk</code> is a graphical history viewer.
Think of it like a powerful GUI shell over <code>git log</code> and <code>git grep</code>.
This is the tool to use when you&#8217;re trying to find something that happened in the past, or visualize your project&#8217;s history.</p>
</div>
<div class="paragraph">
<p>Gitk is easiest to invoke from the command-line.
Just <code>cd</code> into a Git repository, and type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ gitk [git log options]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gitk accepts many command-line options, most of which are passed through to the underlying <code>git log</code> action.
Probably one of the most useful is the <code>--all</code> flag, which tells gitk to show commits reachable from <em>any</em> ref, not just HEAD.
Gitk&#8217;s interface looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/gitk.png" alt="The `gitk` history viewer.">
</div>
<div class="title">Figure 153. The <code>gitk</code> history viewer.</div>
</div>
<div class="paragraph">
<p>On the top is something that looks a bit like the output of <code>git log --graph</code>; each dot represents a commit, the lines represent parent relationships, and refs are shown as colored boxes.
The yellow dot represents HEAD, and the red dot represents changes that are yet to become a commit.
At the bottom is a view of the selected commit; the comments and patch on the left, and a summary view on the right.
In between is a collection of controls used for searching history.</p>
</div>
<div class="paragraph">
<p><code>git-gui</code>, on the other hand, is primarily a tool for crafting commits.
It, too, is easiest to invoke from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git gui</code></pre>
</div>
</div>
<div class="paragraph">
<p>And it looks something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-gui.png" alt="The `git-gui` commit tool.">
</div>
<div class="title">Figure 154. The <code>git-gui</code> commit tool.</div>
</div>
<div class="paragraph">
<p>On the left is the index; unstaged changes are on top, staged changes on the bottom.
You can move entire files between the two states by clicking on their icons, or you can select a file for viewing by clicking on its name.</p>
</div>
<div class="paragraph">
<p>At top right is the diff view, which shows the changes for the currently-selected file.
You can stage individual hunks (or individual lines) by right-clicking in this area.</p>
</div>
<div class="paragraph">
<p>At the bottom right is the message and action area. Type your message into the text box and click &#8220;Commit&#8221; to do something similar to <code>git commit</code>.
You can also choose to amend the last commit by choosing the &#8220;Amend&#8221; radio button, which will update the &#8220;Staged Changes&#8221; area with the contents of the last commit.
Then you can simply stage or unstage some changes, alter the commit message, and click &#8220;Commit&#8221; again to replace the old commit with a new one.</p>
</div>
<div class="paragraph">
<p><code>gitk</code> and <code>git-gui</code> are examples of task-oriented tools.
Each of them is tailored for a specific purpose (viewing history and creating commits, respectively), and omit the features not necessary for that task.</p>
</div>
</div>
<div class="sect3">
<h4 id="_github_for_mac_and_windows">GitHub for Mac and Windows</h4>
<div class="paragraph">
<p>
GitHub has created two workflow-oriented Git clients: one for Windows, and one for Mac.
These clients are a good example of workflow-oriented tools – rathern than expose <em>all</em> of Git&#8217;s functionality, they instead focus on a curated set of commonly-used features that work well together.
They look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/github_mac.png" alt="GitHub for Mac.">
</div>
<div class="title">Figure 155. GitHub for Mac.</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/github_win.png" alt="GitHub for Windows.">
</div>
<div class="title">Figure 156. GitHub for Windows.</div>
</div>
<div class="paragraph">
<p>They are designed to look and work very much alike, so we&#8217;ll treat them like a single product in this chapter.
We won&#8217;t be doing a detailed rundown of these tools (they have their own documentation), but a quick tour of the &#8220;changes&#8221; view (which is where you&#8217;ll spend most of your time) is in order.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the left is the list of repositories the client is tracking; you can add a repository (either by cloning or attaching locally) by clicking the &#8220;+&#8221; icon at the top of this area.</p>
</li>
<li>
<p>In the center is a commit-input area, which lets you input a commit message, and select which files should be included.
(On Windows, the commit history is displayed directly below this; on Mac, it&#8217;s on a separate tab.)</p>
</li>
<li>
<p>On the right is a diff view, which shows what&#8217;s changed in your working directory, or which changes were included in the selected commit.</p>
</li>
<li>
<p>The last thing to notice is the &#8220;Sync&#8221; button at the top-right, which is the primary way you interact over the network.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You don&#8217;t need a GitHub account to use these tools.
While they&#8217;re designed to highlight GitHub&#8217;s service and recommended workflow, they will happily work with any repository, and do network operations with any Git host.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_installation_2">Installation</h5>
<div class="paragraph">
<p>GitHub for Windows can be downloaded from <a href="https://windows.github.com" class="bare">https://windows.github.com</a>, and GitHub for Mac from <a href="https://mac.github.com" class="bare">https://mac.github.com</a>.
When the applications are first run, they walk you through all the first-time Git setup, such as configuring your name and email address, and both set up sane defaults for many common configuration options, such as credential caches and CRLF behavior.</p>
</div>
<div class="paragraph">
<p>Both are &#8220;evergreen&#8221; – updates are downloaded and installed in the background while the applications are open.
This helpfully includes a bundled version of Git, which means you probably won&#8217;t have to worry about manually updating it again.
On Windows, the client includes a shortcut to launch Powershell with Posh-git, which we&#8217;ll talk more about later in this chapter.</p>
</div>
<div class="paragraph">
<p>The next step is to give the tool some repositories to work with.
The client shows you a list of the repositories you have access to on GitHub, and can clone them in one step.
If you already have a local repository, just drag its directory from the Finder or Windows Explorer into the GitHub client window, and it will be included in the list of repositories on the left.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recommended_workflow">Recommended Workflow</h5>
<div class="paragraph">
<p>Once it&#8217;s installed and configured, you can use the GitHub client for many common Git tasks.
The intended workflow for this tool is sometimes called the &#8220;GitHub Flow.&#8221;
We cover this in more detail in <a href="#_github_flow">The GitHub Flow</a>, but the general gist is that (a) you&#8217;ll be committing to a branch, and (b) you&#8217;ll be syncing up with a remote repository fairly regularly.</p>
</div>
<div class="paragraph">
<p>Branch management is one of the areas where the two tools diverge.
On Mac, there&#8217;s a button at the top of the window for creating a new branch:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/branch_widget_mac.png" alt="``Create Branch'' button on Mac.">
</div>
<div class="title">Figure 157. &#8220;Create Branch&#8221; button on Mac.</div>
</div>
<div class="paragraph">
<p>On Windows, this is done by typing the new branch&#8217;s name in the branch-switching widget:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/branch_widget_win.png" alt="Creating a branch on Windows.">
</div>
<div class="title">Figure 158. Creating a branch on Windows.</div>
</div>
<div class="paragraph">
<p>Once your branch is created, making new commits is fairly straightforward.
Make some changes in your working directory, and when you switch to the GitHub client window, it will show you which files changed.
Enter a commit message, select the files you&#8217;d like to include, and click the &#8220;Commit&#8221; button (ctrl-enter or ⌘-enter).</p>
</div>
<div class="paragraph">
<p>The main way you interact with other repositories over the network is through the &#8220;Sync&#8221; feature.
Git internally has separate operations for pushing, fetching, merging, and rebasing, but the GitHub clients collapse all of these into one multi-step feature.
Here&#8217;s what happens when you click the Sync button:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>git pull --rebase</code>.
If this fails because of a merge conflict, fall back to <code>git pull --no-rebase</code>.</p>
</li>
<li>
<p><code>git push</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is the most common sequence of network commands when working in this style, so squashing them into one command saves a lot of time.</p>
</div>
</div>
<div class="sect4">
<h5 id="_summary_8">Summary</h5>
<div class="paragraph">
<p>These tools are very well-suited for the workflow they&#8217;re designed for.
Developers and non-developers alike can be collaborating on a project within minutes, and many of the best practices for this kind of workflow are baked into the tools.
However, if your workflow is different, or you want more control over how and when network operations are done, we recommend you use another client or the command line.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_guis">Other GUIs</h4>
<div class="paragraph">
<p>There are a number of other graphical Git clients, and they run the gamut from specialized, single-purpose tools all the way to apps that try to expose everything Git can do.
The official Git website has a curated list of the most popular clients at <a href="http://git-scm.com/downloads/guis" class="bare">http://git-scm.com/downloads/guis</a>.
A more comprehensive list is available on the Git wiki site, at <a href="https://git.wiki.kernel.org/index.php/Interfaces,_frontends,_and_tools#Graphical_Interfaces" class="bare">https://git.wiki.kernel.org/index.php/Interfaces,_frontends,_and_tools#Graphical_Interfaces</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_in_visual_studio">Git in Visual Studio</h3>
<div class="paragraph">
<p>
Starting with Visual Studio 2013 Update 1, Visual Studio users have a Git client built directly into their IDE.
Visual Studio has had source-control integration features for quite some time, but they were oriented towards centralized, file-locking systems, and Git was not a good match for this workflow.
Visual Studio 2013&#8217;s Git support has been separated from this older feature, and the result is a much better fit between Studio and Git.</p>
</div>
<div class="paragraph">
<p>To locate the feature, open a project that&#8217;s controlled by Git (or just <code>git init</code> an existing project), and select View &gt; Team Explorer from the menu.
You&#8217;ll see the "Connect" view, which looks a bit like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/vs-1.png" alt="Connecting to a Git repository from Team Explorer.">
</div>
<div class="title">Figure 159. Connecting to a Git repository from Team Explorer.</div>
</div>
<div class="paragraph">
<p>Visual Studio remembers all of the projects you&#8217;ve opened that are Git-controlled, and they&#8217;re available in the list at the bottom.
If you don&#8217;t see the one you want there, click the "Add" link and type in the path to the working directory.
Double clicking on one of the local Git repositories leads you to the Home view, which looks like <a href="#vs_home">The "Home" view for a Git repository in Visual Studio.</a>.
This is a hub for performing Git actions; when you&#8217;re <em>writing</em> code, you&#8217;ll probably spend most of your time in the "Changes" view, but when it comes time to pull down changes made by your teammates, you&#8217;ll use the "Unsynced Commits" and "Branches" views.</p>
</div>
<div id="vs_home" class="imageblock">
<div class="content">
<img src="images/vs-2.png" alt="The Home view for a Git repository in Visual Studio.">
</div>
<div class="title">Figure 160. The "Home" view for a Git repository in Visual Studio.</div>
</div>
<div class="paragraph">
<p>Visual Studio now has a powerful task-focused UI for Git.
It includes a linear history view, a diff viewer, remote commands, and many other capabilities.
For complete documentation of this feature (which doesn&#8217;t fit here), go to <a href="http://msdn.microsoft.com/en-us/library/hh850437.aspx" class="bare">http://msdn.microsoft.com/en-us/library/hh850437.aspx</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_git_in_eclipse">Git in Eclipse</h3>
<div class="paragraph">
<p>
Eclipse ships with a plugin called Egit, which provides a fairly-complete interface to Git operations.
It&#8217;s accessed by switching to the Git Perspective (Window &gt; Open Perspective &gt; Other…, and select "Git").</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/egit.png" alt="Eclipse's EGit environment.">
</div>
<div class="title">Figure 161. Eclipse&#8217;s EGit environment.</div>
</div>
<div class="paragraph">
<p>EGit comes with plenty of great documentation, which you can find by going to Help &gt; Help Contents, and choosing the "EGit Documentation" node from the contents listing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_git_in_bash">Git in Bash</h3>
<div class="paragraph">
<p>
If you&#8217;re a Bash user, you can tap into some of your shell&#8217;s features to make your experience with Git a lot friendlier.
Git actually ships with plugins for several shells, but it&#8217;s not turned on by default.</p>
</div>
<div class="paragraph">
<p>First, you need to get a copy of the <code>contrib/completion/git-completion.bash</code> file out of the Git source code.
Copy it somewhere handy, like your home directory, and add this to your <code>.bashrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">. ~/git-completion.bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once that&#8217;s done, change your directory to a git repository, and type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git chec&lt;tab&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>…and Bash will auto-complete to <code>git checkout</code>.
This works with all of Git&#8217;s subcommands, command-line parameters, and remotes and ref names where appropriate.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also useful to customize your prompt to show information about the current directory&#8217;s Git repository.
This can be as simple or complex as you want, but there are generally a few key pieces of information that most people want, like the current branch, and the status of the working directory.
To add these to your prompt, just copy the <code>contrib/completion/git-prompt.sh</code> file from Git&#8217;s source repository to your home directory, add something like this to your <code>.bashrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">. ~/git-prompt.sh
export GIT_PS1_SHOWDIRTYSTATE=1
export PS1='\w$(__git_ps1 " (%s)")\$ '</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>\w</code> means print the current working directory, the <code>\$</code> prints the <code>$</code> part of the prompt, and <code>__git_ps1 " (%s)"</code> calls the function provided by <code>git-prompt.sh</code> with a formatting argument.
Now your bash prompt will look like this when you&#8217;re anywhere inside a Git-controlled project:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/git-bash.png" alt="Customized `bash` prompt.">
</div>
<div class="title">Figure 162. Customized <code>bash</code> prompt.</div>
</div>
<div class="paragraph">
<p>Both of these scripts come with helpful documentation; take a look at the contents of <code>git-completion.bash</code> and <code>git-prompt.sh</code> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_git_in_zsh">Git in Zsh</h3>
<div class="paragraph">
<p>
Git also ships with a tab-completion library for Zsh.
Just copy <code>contrib/completion/git-completion.zsh</code> to your home directory and source it from your <code>.zshrc</code>.
Zsh&#8217;s interface is a bit more powerful than Bash&#8217;s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">$ git che&lt;tab&gt;
check-attr        -- display gitattributes information
check-ref-format  -- ensure that a reference name is well formed
checkout          -- checkout branch or paths to working tree
checkout-index    -- copy files from index to working directory
cherry            -- find commits not merged upstream
cherry-pick       -- apply changes introduced by some existing commits</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ambiguous tab-completions aren&#8217;t just listed; they have helpful descriptions, and you can graphically navigate the list by repeatedly hitting tab.
This works with Git commands, their arguments, and names of things inside the repository (like refs and remotes), as well filenames and all the other things Zsh knows how to tab-complete.</p>
</div>
<div class="paragraph">
<p>Zsh happens to be fairly compatible with Bash when it comes to prompt customization, but it allows you to have a right-side prompt as well.
To include the branch name on the right side, add these lines to your <code>~/.zshrc</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">setopt prompt_subst
. ~/git-prompt.sh
export RPROMPT=$'$(__git_ps1 "%s")'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in a display of the current branch on the right-hand side of the terminal window, whenever your shell is inside a Git repository. It looks a bit like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/zsh-prompt.png" alt="Customized `zsh` prompt.">
</div>
<div class="title">Figure 163. Customized <code>zsh</code> prompt.</div>
</div>
<div class="paragraph">
<p>Zsh is powerful enough that there are entire frameworks dedicated to making it better.
One of them is called "oh-my-zsh", and it can be found at <a href="https://github.com/robbyrussell/oh-my-zsh" class="bare">https://github.com/robbyrussell/oh-my-zsh</a>.
oh-my-zsh&#8217;s plugin system comes with powerful git tab-completion, and it has a variety of prompt "themes", many of which display version-control data.
<a href="#oh_my_zsh_git">An example of an oh-my-zsh theme.</a> is just one example of what can be done with this system.</p>
</div>
<div id="oh_my_zsh_git" class="imageblock">
<div class="content">
<img src="images/zsh-oh-my.png" alt="An example of an oh-my-zsh theme.">
</div>
<div class="title">Figure 164. An example of an oh-my-zsh theme.</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_powershell">Git in Powershell</h3>
<div class="paragraph">
<p>

The standard command-line terminal on Windows (<code>cmd.exe</code>) isn&#8217;t really capable of a customized Git experience, but if you&#8217;re using Powershell, you&#8217;re in luck.
A package called Posh-Git (<a href="https://github.com/dahlbyk/posh-git" class="bare">https://github.com/dahlbyk/posh-git</a>) provides powerful tab-completion facilities, as well as an enhanced prompt to help you stay on top of your repository status. It looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/posh-git.png" alt="Powershell with Posh-git.">
</div>
<div class="title">Figure 165. Powershell with Posh-git.</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve installed GitHub for Windows, Posh-Git is included by default, and all you have to do is add these lines to your <code>profile.ps1</code> (which is usually located in <code>C:\Users\&lt;username&gt;\Documents\WindowsPowerShell</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">. (Resolve-Path "$env:LOCALAPPDATA\GitHub\shell.ps1")
. $env:github_posh_git\profile.example.ps1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re not a GitHub for Windows user, just download a Posh-Git release from (<a href="https://github.com/dahlbyk/posh-git" class="bare">https://github.com/dahlbyk/posh-git</a>), and uncompress it to the <code>WindowsPowershell</code> directory.
Then open a Powershell prompt as the administrator, and do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">&gt; Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Confirm
&gt; cd ~\Documents\WindowsPowerShell\posh-git
&gt; .\install.ps1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will add the proper line to your <code>profile.ps1</code> file, and posh-git will be active the next time you open your prompt.</p>
</div>
</div>
<div class="sect2">
<h3 id="_summary_9">Summary</h3>
<div class="paragraph">
<p>You&#8217;ve learned how to harness Git&#8217;s power from inside the tools that you use during your everyday work, and also how to access Git repositories from your own programs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_embedding_git_in_your_applications">Appendix B: Embedding Git in your Applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If your application is for developers, chances are good that it could benefit from integration with source control.
Even non-developer applications, such as document editors, could potentially benefit from version-control features, and Git&#8217;s model works very well for many different scenarios.</p>
</div>
<div class="paragraph">
<p>If you need to integrate Git with your application, you have essentially three choices: spawning a shell and using the Git command-line tool; Libgit2; and JGit.</p>
</div>
<div class="sect2">
<h3 id="_command_line_git">Command-line Git</h3>
<div class="paragraph">
<p>One option is to spawn a shell process and use the Git command-line tool to do the work.
This has the benefit of being canonical, and all of Git&#8217;s features are supported.
This also happens to be fairly easy, as most runtime environments have a relatively simple facility for invoking a process with command-line arguments.
However, this approach does have some downsides.</p>
</div>
<div class="paragraph">
<p>One is that all the output is in plain text.
This means that you&#8217;ll have to parse Git&#8217;s occasionally-changing output format to read progress and result information, which can be inefficient and error-prone.</p>
</div>
<div class="paragraph">
<p>Another is the lack of error recovery.
If a repository is corrupted somehow, or the user has a malformed configuration value, Git will simply refuse to perform many operations.</p>
</div>
<div class="paragraph">
<p>Yet another is process management.
Git requires you to maintain a shell environment on a separate process, which can add unwanted complexity.
Trying to coordinate many of these processes (especially when potentially accessing the same repository from several processes) can be quite a challenge.</p>
</div>
</div>
<div class="sect2">
<h3 id="_libgit2">Libgit2</h3>
<div class="paragraph">
<p>&#169;
Another option at your disposal is to use Libgit2.
Libgit2 is a dependency-free implementation of Git, with a focus on having a nice API for use within other programs.
You can find it at <a href="http://libgit2.github.com" class="bare">http://libgit2.github.com</a>.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s take a look at what the C API looks like.
Here&#8217;s a whirlwind tour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Open a repository
git_repository *repo;
int error = git_repository_open(&amp;repo, "/path/to/repository");

// Dereference HEAD to a commit
git_object *head_commit;
error = git_revparse_single(&amp;head_commit, repo, "HEAD^{commit}");
git_commit *commit = (git_commit*)head_commit;

// Print some of the commit's properties
printf("%s", git_commit_message(commit));
const git_signature *author = git_commit_author(commit);
printf("%s &lt;%s&gt;\n", author-&gt;name, author-&gt;email);
const git_oid *tree_id = git_commit_tree_id(commit);

// Cleanup
git_commit_free(commit);
git_repository_free(repo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first couple of lines open a Git repository.
The <code>git_repository</code> type represents a handle to a repository with a cache in memory.
This is the simplest method, for when you know the exact path to a repository&#8217;s working directory or <code>.git</code> folder.
There&#8217;s also the <code>git_repository_open_ext</code> which includes options for searching, <code>git_clone</code> and friends for making a local clone of a remote repository, and <code>git_repository_init</code> for creating an entirely new repository.</p>
</div>
<div class="paragraph">
<p>The second chunk of code uses rev-parse syntax (see <a href="#_branch_references">分支引用</a> for more on this) to get the commit that HEAD eventually points to.
The type returned is a <code>git_object</code> pointer, which represents something that exists in the Git object database for a repository.
<code>git_object</code> is actually a &#8220;parent&#8221; type for several different kinds of objects; the memory layout for each of the &#8220;child&#8221; types is the same as for <code>git_object</code>, so you can safely cast to the right one.
In this case, <code>git_object_type(commit)</code> would return <code>GIT_OBJ_COMMIT</code>, so it&#8217;s safe to cast to a <code>git_commit</code> pointer.</p>
</div>
<div class="paragraph">
<p>The next chunk shows how to access the commit&#8217;s properties.
The last line here uses a <code>git_oid</code> type; this is Libgit2&#8217;s representation for a SHA-1 hash.</p>
</div>
<div class="paragraph">
<p>From this sample, a couple of patterns have started to emerge:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you declare a pointer and pass a reference to it into a Libgit2 call, that call will probably return an integer error code.
A <code>0</code> value indicates success; anything less is an error.</p>
</li>
<li>
<p>If Libgit2 populates a pointer for you, you&#8217;re responsible for freeing it.</p>
</li>
<li>
<p>If Libgit2 returns a <code>const</code> pointer from a call, you don&#8217;t have to free it, but it will become invalid when the object it belongs to is freed.</p>
</li>
<li>
<p>Writing C is a bit painful.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>
That last one means it isn&#8217;t very probable that you&#8217;ll be writing C when using Libgit2.
Fortunately, there are a number of language-specific bindings available that make it fairly easy to work with Git repositories from your specific language and environment.
Let&#8217;s take a look at the above example written using the Ruby bindings for Libgit2, which are named Rugged, and can be found at <a href="https://github.com/libgit2/rugged" class="bare">https://github.com/libgit2/rugged</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">repo = Rugged::Repository.new('path/to/repository')
commit = repo.head.target
puts commit.message
puts "#{commit.author[:name]} &lt;#{commit.author[:email]}&gt;"
tree = commit.tree</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the code is much less cluttered.
Firstly, Rugged uses exceptions; it can raise things like <code>ConfigError</code> or <code>ObjectError</code>  to signal error conditions.
Secondly, there&#8217;s no explicit freeing of resources, since Ruby is garbage-collected.
Let&#8217;s take a look at a slightly more complicated example: crafting a commit from scratch</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">blob_id = repo.write("Blob contents", :blob) <b class="conum">(1)</b>

index = repo.index
index.read_tree(repo.head.target.tree)
index.add(:path =&gt; 'newfile.txt', :oid =&gt; blob_id) <b class="conum">(2)</b>

sig = {
    :email =&gt; "bob@example.com",
    :name =&gt; "Bob User",
    :time =&gt; Time.now,
}

commit_id = Rugged::Commit.create(repo,
    :tree =&gt; index.write_tree(repo), <b class="conum">(3)</b>
    :author =&gt; sig,
    :committer =&gt; sig, <b class="conum">(4)</b>
    :message =&gt; "Add newfile.txt", <b class="conum">(5)</b>
    :parents =&gt; repo.empty? ? [] : [ repo.head.target ].compact, <b class="conum">(6)</b>
    :update_ref =&gt; 'HEAD', <b class="conum">(7)</b>
)
commit = repo.lookup(commit_id) <b class="conum">(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create a new blob, which contains the contents of a new file.</p>
</li>
<li>
<p>Populate the index with the head commit&#8217;s tree, and add the new file at the path <code>newfile.txt</code>.</p>
</li>
<li>
<p>This creates a new tree in the ODB, and uses it for the new commit.</p>
</li>
<li>
<p>We use the same signature for both the author and committer fields.</p>
</li>
<li>
<p>The commit message.</p>
</li>
<li>
<p>When creating a commit, you have to specify the new commit&#8217;s parents.
This uses the tip of HEAD for the single parent.</p>
</li>
<li>
<p>Rugged (and Libgit2) can optionally update a reference when making a commit.</p>
</li>
<li>
<p>The return value is the SHA-1 hash of a new commit object, which you can then use to get a <code>Commit</code> object.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Ruby code is nice and clean, but since Libgit2 is doing the heavy lifting, this code will run pretty fast, too.
If you&#8217;re not a rubyist, we touch on some other bindings in <a href="#_libgit2_bindings">Other Bindings</a>.</p>
</div>
<div class="sect3">
<h4 id="_advanced_functionality">Advanced Functionality</h4>
<div class="paragraph">
<p>Libgit2 has a couple of capabilities that are outside the scope of core Git.
One example is pluggability: Libgit2 allows you to provide custom &#8220;backends&#8221; for several types of operation, so you can store things in a different way than stock Git does.
Libgit2 allows custom backends for configuration, ref storage, and the object database, among other things.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at how this works.
The code below is borrowed from the set of backend examples provided by the Libgit2 team (which can be found at <a href="https://github.com/libgit2/libgit2-backends" class="bare">https://github.com/libgit2/libgit2-backends</a>).
Here&#8217;s how a custom backend for the object database is set up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">git_odb *odb;
int error = git_odb_new(&amp;odb); <b class="conum">(1)</b>

git_odb_backend *my_backend;
error = git_odb_backend_mine(&amp;my_backend, /*…*/); <b class="conum">(2)</b>

error = git_odb_add_backend(odb, my_backend, 1); <b class="conum">(3)</b>

git_repository *repo;
error = git_repository_open(&amp;repo, "some-path");
error = git_repository_set_odb(odb); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>(Note that errors are captured, but not handled. We hope your code is better than ours.)</em></p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initialize an empty object database (ODB) &#8220;frontend,&#8221; which will act as a container for the &#8220;backends&#8221; which are the ones doing the real work.</p>
</li>
<li>
<p>Initialize a custom ODB backend.</p>
</li>
<li>
<p>Add the backend to the frontend.</p>
</li>
<li>
<p>Open a repository, and set it to use our ODB to look up objects.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But what is this <code>git_odb_backend_mine</code> thing?
Well, that&#8217;s the constructor for your own ODB implementation, and you can do whatever you want in there, so long as you fill in the <code>git_odb_backend</code> structure properly.
Here&#8217;s what it <em>could</em> look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">typedef struct {
    git_odb_backend parent;

    // Some other stuff
    void *custom_context;
} my_backend_struct;

int git_odb_backend_mine(git_odb_backend **backend_out, /*…*/)
{
    my_backend_struct *backend;

    backend = calloc(1, sizeof (my_backend_struct));

    backend-&gt;custom_context = …;

    backend-&gt;parent.read = &amp;my_backend__read;
    backend-&gt;parent.read_prefix = &amp;my_backend__read_prefix;
    backend-&gt;parent.read_header = &amp;my_backend__read_header;
    // …

    *backend_out = (git_odb_backend *) backend;

    return GIT_SUCCESS;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The subtlest constraint here is that <code>my_backend_struct</code>'s first member must be a <code>git_odb_backend</code> structure; this ensures that the memory layout is what the Libgit2 code expects it to be.
The rest of it is arbitrary; this structure can be as large or small as you need it to be.</p>
</div>
<div class="paragraph">
<p>The initialization function allocates some memory for the structure, sets up the custom context, and then fills in the members of the <code>parent</code> structure that it supports.
Take a look at the <code>include/git2/sys/odb_backend.h</code> file in the Libgit2 source for a complete set of call signatures; your particular use case will help determine which of these you&#8217;ll want to support.</p>
</div>
</div>
<div class="sect3">
<h4 id="_libgit2_bindings">Other Bindings</h4>
<div class="paragraph">
<p>Libgit2 has bindings for many languages.
Here we show a small example using a few of the more complete bindings pakages as of this writing; libraries exist for many other languages, including C++, Go, Node.js, Erlang, and the JVM, all in various stages of maturity.
The official collection of bindings can be found by browsing the repositories at <a href="https://github.com/libgit2" class="bare">https://github.com/libgit2</a>.
The code we&#8217;ll write will return the commit message from the commit eventually pointed to by HEAD (sort of like <code>git log -1</code>).</p>
</div>
<div class="sect4">
<h5 id="_libgit2sharp">LibGit2Sharp</h5>
<div class="paragraph">
<p>
If you&#8217;re writing a .NET or Mono application, LibGit2Sharp (<a href="https://github.com/libgit2/libgit2sharp" class="bare">https://github.com/libgit2/libgit2sharp</a>) is what you&#8217;re looking for.
The bindings are written in C#, and great care has been taken to wrap the raw Libgit2 calls with native-feeling CLR APIs.
Here&#8217;s what our example program looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">new Repository(@"C:\path\to\repo").Head.Tip.Message;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For desktop Windows applications, there&#8217;s even a NuGet package that will help you get started quickly.</p>
</div>
</div>
<div class="sect4">
<h5 id="_objective_git">objective-git</h5>
<div class="paragraph">
<p>
If your application is running on an Apple platform, you&#8217;re likely using Objective-C as your implementation language.
Objective-Git (<a href="https://github.com/libgit2/objective-git" class="bare">https://github.com/libgit2/objective-git</a>) is the name of the Libgit2 bindings for that environment.
The example program looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-objc" data-lang="objc">GTRepository *repo =
    [[GTRepository alloc] initWithURL:[NSURL fileURLWithPath: @"/path/to/repo"] error:NULL];
NSString *msg = [[[repo headReferenceWithError:NULL] resolvedTarget] message];</code></pre>
</div>
</div>
<div class="paragraph">
<p>Objective-git is fully interoperable with Swift, so don&#8217;t fear if you&#8217;ve left Objective-C behind.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pygit2">pygit2</h5>
<div class="paragraph">
<p>
The bindings for Libgit2 in Python are called Pygit2, and can be found at <a href="http://www.pygit2.org/" class="bare">http://www.pygit2.org/</a>.
Our example program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">pygit2.Repository("/path/to/repo") # open repository
    .head.resolve()                # get a direct ref
    .get_object().message          # get commit, read message</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_further_reading">Further Reading</h4>
<div class="paragraph">
<p>Of course, a full treatment of Libgit2&#8217;s capabilities is outside the scope of this book.
If you want more information on Libgit2 itself, there&#8217;s API documentation at <a href="https://libgit2.github.com/libgit2" class="bare">https://libgit2.github.com/libgit2</a>, and a set of guides at <a href="https://libgit2.github.com/docs" class="bare">https://libgit2.github.com/docs</a>.
For the other bindings, check the bundled README and tests; there are often small tutorials and pointers to further reading there.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jgit">JGit</h3>
<div class="paragraph">
<p>
If you want to use Git from within a Java program, there is a fully featured Git library called JGit.
JGit is a relatively full-featured implementation of Git written natively in Java, and is widely used in the Java community.
The JGit project is under the Eclipse umbrella, and its home can be found at <a href="http://www.eclipse.org/jgit" class="bare">http://www.eclipse.org/jgit</a>.</p>
</div>
<div class="sect3">
<h4 id="_getting_set_up">Getting Set Up</h4>
<div class="paragraph">
<p>There are a number of ways to connect your project with JGit and start writing code against it.
Probably the easiest is to use Maven – the integration is accomplished by adding the following snipped to the <code>&lt;dependencies&gt;</code> tag in your pom.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.eclipse.jgit&lt;/groupId&gt;
    &lt;artifactId&gt;org.eclipse.jgit&lt;/artifactId&gt;
    &lt;version&gt;3.5.0.201409260305-r&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>version</code> will most likely have advanced by the time you read this; check <a href="http://mvnrepository.com/artifact/org.eclipse.jgit/org.eclipse.jgit" class="bare">http://mvnrepository.com/artifact/org.eclipse.jgit/org.eclipse.jgit</a> for updated repository information.
Once this step is done, Maven will automatically acquire and use the JGit libraries that you&#8217;ll need.</p>
</div>
<div class="paragraph">
<p>If you would rather manage the binary dependencies yourself, pre-built JGit binaries are available from <a href="http://www.eclipse.org/jgit/download" class="bare">http://www.eclipse.org/jgit/download</a>.
You can build them into your project by running a command like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">javac -cp .:org.eclipse.jgit-3.5.0.201409260305-r.jar App.java
java -cp .:org.eclipse.jgit-3.5.0.201409260305-r.jar App</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_plumbing">Plumbing</h4>
<div class="paragraph">
<p>JGit has two basic levels of API: plumbing and porcelain.
The terminology for these comes from Git itself, and JGit is divided into roughly the same kinds of areas: porcelain APIs are a friendly front-end for common user-level actions (the sorts of things a normal user would use the Git command-line tool for), while the plumbing APIs are for interacting with low-level repository objects directly.</p>
</div>
<div class="paragraph">
<p>The starting point for most JGit sessions is the <code>Repository</code> class, and the first thing you&#8217;ll want to do is create an instance of it.
For a filesystem-based repository (yes, JGit allows for other storage models), this is accomplished using <code>FileRepositoryBuilder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Create a new repository; the path must exist
Repository newlyCreatedRepo = FileRepositoryBuilder.create(
    new File("/tmp/new_repo/.git"));

// Open an existing repository
Repository existingRepo = new FileRepositoryBuilder()
    .setGitDir(new File("my_repo/.git"))
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The builder has a fluent API for providing all the things it needs to find a Git repository, whether or not your program knows exactly where it&#8217;s located.
It can use environment variables (<code>.readEnvironment()</code>), start from a place in the working directory and search (<code>.setWorkTree(…).findGitDir()</code>), or just open a known <code>.git</code> directory as above.</p>
</div>
<div class="paragraph">
<p>Once you have a <code>Repository</code> instance, you can do all sorts of things with it.
Here&#8217;s a quick sampling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Get a reference
Ref master = repo.getRef("master");

// Get the object the reference points to
ObjectId masterTip = master.getObjectId();

// Rev-parse
ObjectId obj = repo.resolve("HEAD^{tree}");

// Load raw object contents
ObjectLoader loader = r.open(masterTip);
loader.copyTo(System.out);

// Create a branch
RefUpdate createBranch1 = r.updateRef("refs/heads/branch1");
createBranch1.setNewObjectId(masterTip);
createBranch1.update();

// Delete a branch
RefUpdate deleteBranch1 = r.updateRef("refs/heads/branch1");
deleteBranch1.setForceUpdate(true);
deleteBranch1.delete();

// Config
Config cfg = r.getConfig();
String name = cfg.getString("user", null, "name");</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s quite a bit going on here, so let&#8217;s go through it one section at a time.</p>
</div>
<div class="paragraph">
<p>The first line gets a pointer to the <code>master</code> reference.
JGit automatically grabs the <em>actual</em> master ref, which lives at <code>refs/heads/master</code>, and returns an object that lets you fetch information about the reference.
You can get the name (<code>.getName()</code>), and either the target object of a direct reference (<code>.getObjectId()</code>) or the reference pointed to by a symbolic ref (<code>.getTarget()</code>).
Ref objects are also used to represent tag refs and objects, so you can ask if the tag is &#8220;peeled,&#8221; meaning that it points to the final target of a (potentially long) string of tag objects.</p>
</div>
<div class="paragraph">
<p>The second line gets the target of the <code>master</code> reference, which is returned as an ObjectId instance.
ObjectId represents the SHA-1 hash of an object, which might or might not exist in Git&#8217;s object database.
The third line is similar, but shows how JGit handles the rev-parse syntax (for more on this, see <a href="#_branch_references">分支引用</a>); you can pass any object specifier that Git understands, and JGit will return either a valid ObjectId for that object, or <code>null</code>.</p>
</div>
<div class="paragraph">
<p>The next two lines show how to load the raw contents of an object.
In this example, we call <code>ObjectLoader.copyTo()</code> to stream the contents of the object directly to stdout, but ObjectLoader also has methods to read the type and size of an object, as well as return it as a byte array.
For large objects (where <code>.isLarge()</code> returns <code>true</code>), you can call <code>.openStream()</code> to get an InputStream-like object that can read the raw object data without pulling it all into memory at once.</p>
</div>
<div class="paragraph">
<p>The next few lines show what it takes to create a new branch.
We create a RefUpdate instance, configure some parameters, and call <code>.update()</code> to trigger the change.
Directly following this is the code to delete that same branch.
Note that <code>.setForceUpdate(true)</code> is required for this to work; otherwise the <code>.delete()</code> call will return <code>REJECTED</code>, and nothing will happen.</p>
</div>
<div class="paragraph">
<p>The last example shows how to fetch the <code>user.name</code> value from the Git configuration files.
This Config instance uses the repository we opened earlier for local configuration, but will automatically detect the global and system configuration files and read values from them as well.</p>
</div>
<div class="paragraph">
<p>This is only a small sampling of the full plumbing API; there are many more methods and classes available.
Also not shown here is the way JGit handles errors, which is through the use of exceptions.
JGit APIs sometimes throw standard Java exceptions (such as <code>IOException</code>), but there are a host of JGit-specific exception types that are provided as well (such as <code>NoRemoteRepositoryException</code>, <code>CorruptObjectException</code>, and <code>NoMergeBaseException</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_porcelain">Porcelain</h4>
<div class="paragraph">
<p>The plumbing APIs are rather complete, but it can be cumbersome to string them together to achieve common goals, like adding a file to the index, or making a new commit.
JGit provides a higher-level set of APIs to help out with this, and the entry point to these APIs is the <code>Git</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Repository repo;
// construct repo...
Git git = new Git(repo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Git class has a nice set of high-level <em>builder</em>-style methods that can be used to construct some pretty complex behavior.
Let&#8217;s take a look at an example – doing something like <code>git ls-remote</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CredentialsProvider cp = new UsernamePasswordCredentialsProvider("username", "p4ssw0rd");
Collection&lt;Ref&gt; remoteRefs = git.lsRemote()
    .setCredentialsProvider(cp)
    .setRemote("origin")
    .setTags(true)
    .setHeads(false)
    .call();
for (Ref ref : remoteRefs) {
    System.out.println(ref.getName() + " -&gt; " + ref.getObjectId().name());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a common pattern with the Git class; the methods return a command object that lets you chain method calls to set parameters, which are executed when you call <code>.call()</code>.
In this case, we&#8217;re asking the <code>origin</code> remote for tags, but not heads.
Also notice the use of a <code>CredentialsProvider</code> object for authentication.</p>
</div>
<div class="paragraph">
<p>Many other commands are available through the Git class, including but not limited to <code>add</code>, <code>blame</code>, <code>commit</code>, <code>clean</code>, <code>push</code>, <code>rebase</code>, <code>revert</code>, and <code>reset</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_further_reading_2">Further Reading</h4>
<div class="paragraph">
<p>This is only a small sampling of JGit&#8217;s full capabilities.
If you&#8217;re interested and want to learn more, here&#8217;s where to look for information and inspiration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The official JGit API documentation is available online at <a href="http://download.eclipse.org/jgit/docs/latest/apidocs" class="bare">http://download.eclipse.org/jgit/docs/latest/apidocs</a>.
These are standard Javadoc, so your favorite JVM IDE will be able to install them locally, as well.</p>
</li>
<li>
<p>The JGit Cookbook at <a href="https://github.com/centic9/jgit-cookbook" class="bare">https://github.com/centic9/jgit-cookbook</a> has many examples of how to do specific tasks with JGit.</p>
</li>
<li>
<p>There are several good resources pointed out at <a href="http://stackoverflow.com/questions/6861881" class="bare">http://stackoverflow.com/questions/6861881</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_commands">Appendix C: Git Commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Throughout the book we have introduced dozens of Git commands and have tried hard to introduce them within something of a narrative, adding more commands to the story slowly. However, this leaves us with examples of usage of the commands somewhat scattered throughout the whole book.</p>
</div>
<div class="paragraph">
<p>In this appendix, we&#8217;ll go through all the Git commands we addressed throughout the book, grouped roughly by what they&#8217;re used for. We&#8217;ll talk about what each command very generally does and then point out where in the book you can find us having used it.</p>
</div>
<div class="sect2">
<h3 id="_setup_and_config">Setup and Config</h3>
<div class="paragraph">
<p>There are two commands that are used quite a lot, from the first invocations of Git to common every day tweaking and referencing, the <code>config</code> and <code>help</code> commands.</p>
</div>
<div class="sect3">
<h4 id="_git_config_2">git config</h4>
<div class="paragraph">
<p>Git has a default way of doing hundreds of things. For a lot of these things, you can tell Git to default to doing them a different way, or set your preferences. This invovles everything from telling Git what your name is to specific terminal color preferences or what editor you use. There are several files this command will read from and write to so you can set values globally or down to specific repositories.</p>
</div>
<div class="paragraph">
<p>The <code>git config</code> command has been used in nearly every chapter of the book.</p>
</div>
<div class="paragraph">
<p>In <a href="#_first_time">First-Time Git Setup</a> we used it to specify our name, email address and editor preference before we even got started using Git.</p>
</div>
<div class="paragraph">
<p>In <a href="#_git_aliases">[_git_aliases]</a> we showed how you could use it to create shorthand commands that expand to long option sequences so you don&#8217;t have to type them every time.</p>
</div>
<div class="paragraph">
<p>In <a href="#_rebasing">衍合</a> we used it to make <code>--rebase</code> the default when you run <code>git pull</code>.</p>
</div>
<div class="paragraph">
<p>In <a href="#_credential_caching">凭证存储</a> we used it to set up a default store for your HTTP passwords.</p>
</div>
<div class="paragraph">
<p>In <a href="#_keyword_expansion">Keyword Expansion</a> we showed how to set up smudge and clean filters on content coming in and out of Git.</p>
</div>
<div class="paragraph">
<p>Finally, basically the entirety of <a href="#_git_config">Git Configuration</a> is dedicated to the command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_help_2">git help</h4>
<div class="paragraph">
<p>The <code>git help</code> command is used to show you all the documentation shipped with Git about any command. While we&#8217;re giving a rough overview of most of the more popular ones in this appendix, for a full listing of all of the possible options and flags for every command, you can always run <code>git help &lt;command&gt;</code>.</p>
</div>
<div class="paragraph">
<p>We introduced the <code>git help</code> command in <a href="#_git_help">获取帮助</a> and showed you how to use it to find more information about the <code>git shell</code> in <a href="#_setting_up_server">Setting Up the Server</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_and_creating_projects">Getting and Creating Projects</h3>
<div class="paragraph">
<p>There are two ways to get a Git repository. One is to copy it from an existing repository on the network or elsewhere and the other is to create a new one in an existing directory.</p>
</div>
<div class="sect3">
<h4 id="_git_init">git init</h4>
<div class="paragraph">
<p>To take a directory and turn it into a new Git repository so you can start version controlling it, you can simply run <code>git init</code>.</p>
</div>
<div class="paragraph">
<p>We first introduce this in <a id="_getting_a_repo"></a>, where we show creating a brand new repository to start working with.</p>
</div>
<div class="paragraph">
<p>We talk briefly about how you can change the default branch from &#8220;master&#8221; in <a href="#_remote_branches">Remote Branches</a>.</p>
</div>
<div class="paragraph">
<p>We use this command to create an empty bare  repository for a server in <a href="#_bare_repo">Putting the Bare Repository on a Server</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we go through some of the details of what it actually does behind the scenes in <a href="#_plumbing_porcelain">Plumbing and Porcelain</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_clone">git clone</h4>
<div class="paragraph">
<p>The <code>git clone</code> command is actually something of a wrapper around several other commands. It creates a new directory, goes into it and runs <code>git init</code> to make it an empty Git repository, adds a remote (<code>git remote add</code>) to the URL that you pass it (by default named <code>origin</code>), runs a <code>git fetch</code> from that remote repository and then checks out the latest commit into your working directory with <code>git checkout</code>.</p>
</div>
<div class="paragraph">
<p>The <code>git clone</code> command is used in dozens of places throughout the book, but we&#8217;ll just list a few interesting places.</p>
</div>
<div class="paragraph">
<p>It&#8217;s basically introduced and explained in <a href="#_git_cloning">克隆现有的仓库</a>, where we go through a few examples.</p>
</div>
<div class="paragraph">
<p>In <a href="#_git_on_the_server">Getting Git on a Server</a> we look at using the <code>--bare</code> option to create a copy of a Git repository with no working directory.</p>
</div>
<div class="paragraph">
<p>In <a href="#_bundling">打包</a> we use it to unbundle a bundled Git repository.</p>
</div>
<div class="paragraph">
<p>Finally, in <a href="#_cloning_submodules">Cloning a Project with Submodules</a> we learn the <code>--recursive</code> option to make cloning a repository with submodules a little simpler.</p>
</div>
<div class="paragraph">
<p>Though it&#8217;s used in many other places through the book, these are the ones that are somewhat unique or where it is used in ways that are a little different.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_snapshotting">Basic Snapshotting</h3>
<div class="paragraph">
<p>For the basic workflow of staging content and committing it to your history, there are only a few basic commands.</p>
</div>
<div class="sect3">
<h4 id="_git_add">git add</h4>
<div class="paragraph">
<p>The <code>git add</code> command adds content from the working directory into the staging area (or &#8220;index&#8221;) for the next commit. When the <code>git commit</code> command is run, by default it only looks at this staging area, so <code>git add</code> is used to craft what exactly you would like your next commit snapshot to look like.</p>
</div>
<div class="paragraph">
<p>This command is an incredibly important command in Git and is mentioned or used dozens of times in this book. We&#8217;ll quickly cover some of the unique uses that can be found.</p>
</div>
<div class="paragraph">
<p>We first introduce and explain <code>git add</code> in detail in <a href="#_tracking_files">跟踪新文件</a>.</p>
</div>
<div class="paragraph">
<p>We mention how to use it to resolve merge conflicts in <a href="#_basic_merge_conflicts">Basic Merge Conflicts</a>.</p>
</div>
<div class="paragraph">
<p>We go over using it to interactively stage only specific parts of a modified file in <a href="#_interactive_staging">Interactive Staging</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we emulate it at a low level in <a href="#_tree_objects">Tree Objects</a>, so you can get an idea of what it&#8217;s doing behind the scenes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_status">git status</h4>
<div class="paragraph">
<p>The <code>git status</code> command will show you the different states of files in your working directory and staging area. Which files are modified and unstaged and which are staged but not yet committed. In it&#8217;s normal form, it also will show you some basic hints on how to move files between these stages.</p>
</div>
<div class="paragraph">
<p>We first cover <code>status</code> in <a href="#_checking_status">检查当前文件状态</a>, both in it&#8217;s basic and simplified forms. While we use it throughout the book, pretty much everything you can do with the <code>git status</code> command is covered there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_diff">git diff</h4>
<div class="paragraph">
<p>The <code>git diff</code> command is used when you want to see differences between any two trees. This could be the difference between your working environment and your staging area (<code>git diff</code> by itself), between your staging area and your last commit (<code>git diff --staged</code>), or between two commits (<code>git diff master branchB</code>).</p>
</div>
<div class="paragraph">
<p>We first look at the basic uses of <code>git diff</code> in <a href="#_git_diff_staged">查看已暂存和未暂存的修改</a>, where we show how to see what changes are staged and which are not yet staged.</p>
</div>
<div class="paragraph">
<p>We use it to look for possible whitespace issues before committing with the <code>--check</code> option in <a href="#_commit_guidelines">Commit Guidelines</a>.</p>
</div>
<div class="paragraph">
<p>We see how to check the differences between branches more effectively with the <code>git diff A...B</code> syntax in <a href="#_what_is_introduced">Determining What Is Introduced</a>.</p>
</div>
<div class="paragraph">
<p>We use it to filter out whitespace differences with <code>-w</code> and how to compare different stages of conflicted files with <code>--theirs</code>, <code>--ours</code> and <code>--base</code> in <a href="#_advanced_merging">Advanced Merging</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we use it to effectively compare submodule changes with <code>--submodule</code> in <a href="#_starting_submodules">Starting with Submodules</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_difftool_2">git difftool</h4>
<div class="paragraph">
<p>The <code>git difftool</code> command simply launches an external tool to show you the difference between two trees in case you want to use something other than the built in <code>git diff</code> command.</p>
</div>
<div class="paragraph">
<p>We only briefly mention this in <a href="#_git_difftool">Git Diff 的插件版本</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_commit">git commit</h4>
<div class="paragraph">
<p>The <code>git commit</code> command takes all the file contents that have been staged with <code>git add</code> and records a new permanent snapshot in the database and then moves the branch pointer on the current branch up to it.</p>
</div>
<div class="paragraph">
<p>We first cover the basics of committing in <a href="#_committing_changes">提交更新</a>. There we also demonstrate how to use the <code>-a</code> flag to skip the <code>git add</code> step in daily workflows and how to use the <code>-m</code> flag to pass a commit message in on the command line instead of firing up an editor.</p>
</div>
<div class="paragraph">
<p>In <a href="#_undoing">Undoing Things</a> we cover using the <code>--amend</code> option to redo the most recent commit.</p>
</div>
<div class="paragraph">
<p>In <a href="#_git_branches_overview">分支简介</a>, we go into much more detail about what <code>git commit</code> does and why it does it like that.</p>
</div>
<div class="paragraph">
<p>We looked at how to sign commits cryptographically with the <code>-S</code> flag in <a href="#_signing_commits">Signing Commits</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we take a look at what the <code>git commit</code> command does in the background and how it&#8217;s actually implemented in <a href="#_git_commit_objects">Commit Objects</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_reset_2">git reset</h4>
<div class="paragraph">
<p>The <code>git reset</code> command is primarily used to undo things, as you can possibly tell by the verb. It moves around the <code>HEAD</code> pointer and optionally changes the <code>index</code> or staging area and can also optionally change the working directory if you use <code>--hard</code>. This final option makes it possible for this command to lose your work if used incorrectly, so make sure you understand it before using it.</p>
</div>
<div class="paragraph">
<p>We first effectively cover the simplest use of <code>git reset</code> in <a href="#_unstaging">Unstaging a Staged File</a>, where we use it to unstage a file we had run <code>git add</code> on.</p>
</div>
<div class="paragraph">
<p>We then cover it in quite some detail in <a href="#_git_reset">Reset Demystified</a>, which is entirely devoted to explaining this command.</p>
</div>
<div class="paragraph">
<p>We use <code>git reset --hard</code> to abort a merge in <a href="#_abort_merge">Aborting a Merge</a>, where we also use <code>git merge --abort</code>, which is a bit of a wrapper for the <code>git reset</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_rm">git rm</h4>
<div class="paragraph">
<p>The <code>git rm</code> command is used to remove files from the staging area and working directory for Git. It is similar to <code>git add</code> in that it stages a removal of a file for the next commit.</p>
</div>
<div class="paragraph">
<p>We cover the <code>git rm</code> command in some detail in <a href="#_removing_files">移除文件</a>, including recursively removing files and only removing files from the staging area but leaving them in the working directory with <code>--cached</code>.</p>
</div>
<div class="paragraph">
<p>The only other differing use of <code>git rm</code> in the book is in <a href="#_removing_objects">Removing Objects</a> where we briefly use and explain the <code>--ignore-unmatch</code> when running <code>git filter-branch</code>, which simply makes it not error out when the file we are trying to remove doesn&#8217;t exist. This can be useful for scripting purposes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_mv_2">git mv</h4>
<div class="paragraph">
<p>The <code>git mv</code> command is a thin convenience command to move a file and then run <code>git add</code> on the new file and <code>git rm</code> on the old file.</p>
</div>
<div class="paragraph">
<p>We only briefly mention this command in <a href="#_git_mv">移动文件</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_clean_2">git clean</h4>
<div class="paragraph">
<p>The <code>git clean</code> command is used to remove unwanted files from your working directory. This could include removing temporary build artifacts or merge conflict files.</p>
</div>
<div class="paragraph">
<p>We cover many of the options and scenarios in which you might used the clean command in <a href="#_git_clean">Cleaning your Working Directory</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_branching_and_merging">Branching and Merging</h3>
<div class="paragraph">
<p>There are just a handful of commands that implement most of the branching and merging functionality in Git.</p>
</div>
<div class="sect3">
<h4 id="_git_branch">git branch</h4>
<div class="paragraph">
<p>The <code>git branch</code> command is actually something of a branch management tool. It can list the branches you have, create a new branch, delete branches and rename branches.</p>
</div>
<div class="paragraph">
<p>Most of <a href="#_git_branching">Git 分支</a> is dedicated to the <code>branch</code> command and it&#8217;s used throughout the entire chapter. We first introduce it in <a href="#_create_new_branch">分支创建</a> and we go through most of it&#8217;s other features (listing and deleting) in <a href="#_branch_management">Branch Management</a>.</p>
</div>
<div class="paragraph">
<p>In <a href="#_tracking_branches">Tracking Branches</a> we use the <code>git branch -u</code> option to set up a tracking branch.</p>
</div>
<div class="paragraph">
<p>Finally, we go through some of what it does in the background in <a href="#_git_refs">Git References</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_checkout">git checkout</h4>
<div class="paragraph">
<p>The <code>git checkout</code> command is used to switch branches and  check content out into your working directory.</p>
</div>
<div class="paragraph">
<p>We first encounter the command in <a href="#_switching_branches">分支切换</a> along with the <code>git branch</code> command.</p>
</div>
<div class="paragraph">
<p>We see how to use it to start tracking branches with the <code>--track</code> flag in <a href="#_tracking_branches">Tracking Branches</a>.</p>
</div>
<div class="paragraph">
<p>We use it to reintroduce file conflicts with <code>--conflict=diff3</code> in <a href="#_checking_out_conflicts">Checking Out Conflicts</a>.</p>
</div>
<div class="paragraph">
<p>We go into closer detail on it&#8217;s relationship with <code>git reset</code> in <a href="#_git_reset">Reset Demystified</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we go into some implementation detail in <a href="#_the_head">The HEAD</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_merge">git merge</h4>
<div class="paragraph">
<p>The <code>git merge</code> tool is used to merge one or more branches  into the branch you have checked out. It will then advance the current branch to the result of the merge.</p>
</div>
<div class="paragraph">
<p>The <code>git merge</code> command was first introduced in <a href="#_basic_branching">Basic Branching</a>. Though it is used in various places in the book, there are very few variations of the <code>merge</code> command&#8201;&#8212;&#8201;generally just <code>git merge &lt;branch&gt;</code> with the name of the single branch you want to merge in.</p>
</div>
<div class="paragraph">
<p>We covered how to do a squashed merge (where Git merges the work but pretends like it&#8217;s just a new commit without recording the history of the branch you&#8217;re merging in) at the very end of <a href="#_public_project">Forked Public Project</a>.</p>
</div>
<div class="paragraph">
<p>We went over a lot about the merge process and command, including the <code>-Xignore-all-whitespace</code> command and the <code>--abort</code> flag to abort a problem merge in <a href="#_advanced_merging">Advanced Merging</a>.</p>
</div>
<div class="paragraph">
<p>We learned how to verify signatures before merging if your project is using GPG signing in <a href="#_signing_commits">Signing Commits</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we learned about Subtree merging in <a href="#_subtree_merge">子树合并</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_mergetool">git mergetool</h4>
<div class="paragraph">
<p>The <code>git mergetool</code> command simply launches an external merge helper in case you have issues with a merge in Git.</p>
</div>
<div class="paragraph">
<p>We mention it quickly in <a href="#_basic_merge_conflicts">Basic Merge Conflicts</a> and go into detail on how to implement your own external merge tool in <a href="#_external_merge_tools">External Merge and Diff Tools</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_log">git log</h4>
<div class="paragraph">
<p>The <code>git log</code> command is used to show the reachable recorded history of a project from the most recent commit snapshot backwards. By default it will only show the history of the branch you&#8217;re currently on, but can be given different or even multiple heads or branches from which to traverse. It is also often used to show differences between two or more branches at the commit level.</p>
</div>
<div class="paragraph">
<p>This command is used in nearly every chapter of the book to demonstrate the history of a project.</p>
</div>
<div class="paragraph">
<p>We introduce the command and cover it in some depth in <a href="#_viewing_history">Viewing the Commit History</a>. There we look at the <code>-p</code> and <code>--stat</code> option to get an idea of what was introduced in each commit and the <code>--pretty</code> and <code>--oneline</code> options to view the history more concisely, along with some simple date and author filtering options.</p>
</div>
<div class="paragraph">
<p>In <a href="#_create_new_branch">分支创建</a> we use it with the <code>--decorate</code> option to easily visualize where our branch pointers are located and we also use the <code>--graph</code> option to see what divergent histories look like.</p>
</div>
<div class="paragraph">
<p>In <a href="#_private_team">Private Small Team</a> and <a href="#_commit_ranges">提交区间</a> we cover the <code>branchA..branchB</code> syntax to use the <code>git log</code> command to see what commits are unique to a branch relative to another branch. In <a href="#_commit_ranges">提交区间</a> we go through this fairly extensively.</p>
</div>
<div class="paragraph">
<p>In <a href="#_merge_log">Merge Log</a> and <a href="#_triple_dot">三点</a> we cover using the <code>branchA...branchB</code> format and the <code>--left-right</code> syntax to see what is in one branch or the other but not in both. In <a href="#_merge_log">Merge Log</a> we also look at how to use the <code>--merge</code> option to help with merge conflict debugging as well as using the <code>--cc</code> option to look at merge commit conflicts in your history.</p>
</div>
<div class="paragraph">
<p>In <a href="#_git_notes">[_git_notes]</a> we use the <code>--notes=</code> option to display notes inline in the log output, and in <a href="#_git_reflog">引用日志</a> we use the <code>-g</code> option to view the Git reflog through this tool instead of doing branch traversal.</p>
</div>
<div class="paragraph">
<p>In <a href="#_searching">搜索</a> we look at using the <code>-S</code> and <code>-L</code> options to do fairly sophisticated searches for something that happened historically in the code such as seeing the history of a function.</p>
</div>
<div class="paragraph">
<p>In <a href="#_signing_commits">Signing Commits</a> we see how to use <code>--show-signature</code> to add a validation string to each commit in the <code>git log</code> output based on if it was validly signed or not.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_stash">git stash</h4>
<div class="paragraph">
<p>The <code>git stash</code> command is used to temporarily store uncommitted work in order to clean out your working directory without having to commit unfinished work on a branch.</p>
</div>
<div class="paragraph">
<p>This is basically entirely covered in <a href="#_git_stashing">Stashing and Cleaning</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_tag">git tag</h4>
<div class="paragraph">
<p>The <code>git tag</code> command is used to give a permanent bookmark to a specific point in the code history. Generally this is used for things like releases.</p>
</div>
<div class="paragraph">
<p>This command is introduced and covered in detail in <a href="#_git_tagging">Tagging</a> and we use it in practice in <a href="#_tagging_releases">Tagging Your Releases</a>.</p>
</div>
<div class="paragraph">
<p>We also cover how to create a GPG signed tag with the <code>-s</code> flag and verify one with the <code>-v</code> flag in <a href="#_signing">Signing Your Work</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_and_updating_projects">Sharing and Updating Projects</h3>
<div class="paragraph">
<p>There are not very many commands in Git that access the network, nearly all of the commands operate on the local database. When you are ready to share your work or pull changes from elsewhere, there are a handful of commands that deal with remote repositories.</p>
</div>
<div class="sect3">
<h4 id="_git_fetch">git fetch</h4>
<div class="paragraph">
<p>The <code>git fetch</code> command communicates with a remote repository and fetches down all the information that is in that repository that is not in your current one and stores it in your local database.</p>
</div>
<div class="paragraph">
<p>We first look at this command in <a href="#_fetching_and_pulling">Fetching and Pulling from Your Remotes</a> and we continue to see examples of it use in <a href="#_remote_branches">Remote Branches</a>.</p>
</div>
<div class="paragraph">
<p>We also use it in several of the examples in <a href="#_contributing_project">Contributing to a Project</a>.</p>
</div>
<div class="paragraph">
<p>We use it to fetch a single specific reference that is outside of the default space in <a href="#_pr_refs">Pull Request Refs</a> and we see how to fetch from a bundle in <a href="#_bundling">打包</a>.</p>
</div>
<div class="paragraph">
<p>We set up highly custom refspecs in order to make <code>git fetch</code> do something a little different than the default in <a href="#_getting_notes">[_getting_notes]</a> and <a href="#_refspec">The Refspec</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_pull">git pull</h4>
<div class="paragraph">
<p>The <code>git pull</code> command is basically a combination of the <code>git fetch</code> and <code>git merge</code> commands, where Git will fetch from the remote you specify and then immediately try to merge it into the branch you&#8217;re on.</p>
</div>
<div class="paragraph">
<p>We introduce it quicking in <a href="#_fetching_and_pulling">Fetching and Pulling from Your Remotes</a> and show how to see what it will merge if you run it in <a href="#_inspecting_remote">Inspecting a Remote</a>.</p>
</div>
<div class="paragraph">
<p>We also see how to use it to help with rebasing difficulties in <a href="#_rebase_rebase">用衍合解决衍合</a>.</p>
</div>
<div class="paragraph">
<p>We show how to use it with a URL to pull in changes in a one-off fashion in <a href="#_checking_out_remotes">Checking Out Remote Branches</a>.</p>
</div>
<div class="paragraph">
<p>Finally, we very quickly mention that you can use the <code>--verify-signatures</code> option to it in order to verify that commits you are pulling have been GPG signed in <a href="#_signing_commits">Signing Commits</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_push">git push</h4>
<div class="paragraph">
<p>The <code>git push</code> command is used to communicate with another repository, calculate what your local database has that the remote one does not, and then pushes the difference into the other repository. It requires write access to the other repository and so normally is authenticated somehow.</p>
</div>
<div class="paragraph">
<p>We first look at the <code>git push</code> command in <a href="#_pushing_remotes">Pushing to Your Remotes</a>. Here we cover the basics of pushing a branch to a remote repository. In <a href="#_pushing_branches">Pushing</a> we go a little deeper into pushing specific branches and in <a href="#_tracking_branches">Tracking Branches</a> we see how to set up tracking branches to automatically push to. In <a href="#_delete_branches">Deleting Remote Branches</a> we use the <code>--delete</code> flag to delete a branch on the server with <code>git push</code>.</p>
</div>
<div class="paragraph">
<p>Throughout <a href="#_contributing_project">Contributing to a Project</a> we see several examples of using <code>git push</code> to share work on branches through multiple remotes.</p>
</div>
<div class="paragraph">
<p>We see how to use it to share tags that you have made with the <code>--tags</code> option in <a href="#_sharing_tags">Sharing Tags</a>.</p>
</div>
<div class="paragraph">
<p>In <a href="#_sharing_notes">[_sharing_notes]</a> we use it in a slightly less common way to share references for commit notes&#8201;&#8212;&#8201;references that sit outside of the normal refs namespace.</p>
</div>
<div class="paragraph">
<p>In <a href="#_publishing_submodules">Publishing Submodule Changes</a> we use the <code>--recurse-submodules</code> option to check that all of our submodules work has been published before pushing the superproject, which can be really helpful when using submodules.</p>
</div>
<div class="paragraph">
<p>In <a href="#_other_client_hooks">Other Client Hooks</a> we talk briefly about the <code>pre-push</code> hook, which is a script we can setup to run before a push completes to verify that it should be allowed to push.</p>
</div>
<div class="paragraph">
<p>Finally, in <a href="#_pushing_refspecs">Pushing Refspecs</a> we look at pushing with a full refspec instead of the general shortcuts that are normally used. This can help you be very specific about what work you wish to share.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_remote">git remote</h4>
<div class="paragraph">
<p>The <code>git remote</code> command is a management tool for your record of remote repositories. It allows you to save long URLs as short handles, such as &#8220;origin&#8221; so you don&#8217;t have to type them out all the time. You can have several of these and the <code>git remote</code> command is used to add, change and delete them.</p>
</div>
<div class="paragraph">
<p>This command is covered in detail in <a href="#_remote_repos">Working with Remotes</a>, including listing, adding, removing and renaming them.</p>
</div>
<div class="paragraph">
<p>It is used in nearly every subsequent chapter in the book too, but always in the standard <code>git remote add &lt;name&gt; &lt;url&gt;</code> format.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_archive">git archive</h4>
<div class="paragraph">
<p>The <code>git archive</code> command is used to create an archive file of a specific snapshot of the project.</p>
</div>
<div class="paragraph">
<p>We use <code>git archive</code> to create a tarball of a project for sharing in <a href="#_preparing_release">Preparing a Release</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_submodule">git submodule</h4>
<div class="paragraph">
<p>The <code>git submodule</code> command is used to manage external repositories within a normal repositories. This could be for libraries or other types of shared resources. The <code>submodule</code> command has several sub-commands (<code>add</code>, <code>update</code>, <code>sync</code>, etc) for managing these resources.</p>
</div>
<div class="paragraph">
<p>This command is only mentioned and entirely covered in <a href="#_git_submodules">Submodules</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inspection_and_comparison">Inspection and Comparison</h3>
<div class="sect3">
<h4 id="_git_show">git show</h4>
<div class="paragraph">
<p>The <code>git show</code> command can show a Git object in a simple and human readable way. Normally you would use this to show the information about a tag or a commit.</p>
</div>
<div class="paragraph">
<p>We first use it to show annotated tag information in <a href="#_annotated_tags">Annotated Tags</a>.</p>
</div>
<div class="paragraph">
<p>Later we use it quite a bit in <a href="#_revision_selection">选择修订版本（Revision）</a> to show the commits that our various revision selections resolve to.</p>
</div>
<div class="paragraph">
<p>One of the more interesting things we do with <code>git show</code> is in <a href="#_manual_remerge">Manual File Re-merging</a> to extract specific file contents of various stages during a merge conflict.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_shortlog">git shortlog</h4>
<div class="paragraph">
<p>The <code>git shortlog</code> command is used to summarize the output of <code>git log</code>. It will take many of the same options that the <code>git log</code> command will but instead of listing out all of the commits it will present a summary of the commits grouped by author.</p>
</div>
<div class="paragraph">
<p>We showed how to use it to create a nice changelog in <a href="#_the_shortlog">The Shortlog</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_describe">git describe</h4>
<div class="paragraph">
<p>The <code>git describe</code> command is used to take anything that resolves to a commit and produces a string that is somewhat human-readable and will not change. It&#8217;s a way to get a description of a commit that is as unambiguous as a commit SHA but more understandable.</p>
</div>
<div class="paragraph">
<p>We use <code>git describe</code> in <a href="#_build_number">Generating a Build Number</a> and <a href="#_preparing_release">Preparing a Release</a> to get a string to name our release file after.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_2">Debugging</h3>
<div class="paragraph">
<p>Git has a couple of commands that are used to help debug an issue in your code. This ranges from figuring out where something was introduced to figuring out who introduced it.</p>
</div>
<div class="sect3">
<h4 id="_git_bisect">git bisect</h4>
<div class="paragraph">
<p>The <code>git bisect</code> tool is an incredibly helpful debugging tool used to find which specific commit was the first one to introduce a bug or problem by doing an automatic binary search.</p>
</div>
<div class="paragraph">
<p>It is fully covered in <a href="#_binary_search">二分查找</a> and is only mentioned in that section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_blame">git blame</h4>
<div class="paragraph">
<p>The <code>git blame</code> command annotates the lines of any file with which commit was the last one to introduce a change to each line of the file and what person authored that commit. This is helpful in order to find the person to ask for more information about a specific section of your code.</p>
</div>
<div class="paragraph">
<p>It is covered in <a href="#_file_annotation">文件标注</a> and is only mentioned in that section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_grep_2">git grep</h4>
<div class="paragraph">
<p>The <code>git grep</code> command can help you find any string or regular expression in any of the files in your source code, even older versions of your project.</p>
</div>
<div class="paragraph">
<p>It is covered in <a href="#_git_grep">Git Grep</a> and is only mentioned in that section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_patching">Patching</h3>
<div class="paragraph">
<p>A few commands in Git are centered around the concept of thinking of commits in terms of the changes they introduce, as thought the commit series is a series of patches. These commands help you manage your branches in this manner.</p>
</div>
<div class="sect3">
<h4 id="_git_cherry_pick">git cherry-pick</h4>
<div class="paragraph">
<p>The <code>git cherry-pick</code> command is used to take the change introduced in a single Git commit and try to re-introduce it as a new commit on the branch you&#8217;re currently on. This can be useful to only take one or two commits from a branch individually rather than merging in the branch which takes all the changes.</p>
</div>
<div class="paragraph">
<p>Cherry picking is described and demonstrated in <a href="#_rebase_cherry_pick">Rebasing and Cherry Picking Workflows</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_rebase">git rebase</h4>
<div class="paragraph">
<p>The <code>git rebase</code> command is basically an automated <code>cherry-pick</code>. It determines a series of commits and then cherry-picks them one by one in the same order somewhere else.</p>
</div>
<div class="paragraph">
<p>Rebasing is covered in detail in <a href="#_rebasing">衍合</a>, including covering the collaborative issues involved with rebasing branches that are already public.</p>
</div>
<div class="paragraph">
<p>We use it in practice during an example of splitting your history into two separate repositories in <a href="#_replace">Replace</a>, using the <code>--onto</code> flag as well.</p>
</div>
<div class="paragraph">
<p>We go through running into a merge conflict during rebasing in <a href="#_rerere">Rerere</a>.</p>
</div>
<div class="paragraph">
<p>We also use it in an interactive scripting mode with the <code>-i</code> option in <a href="#_changing_multiple">Changing Multiple Commit Messages</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_revert">git revert</h4>
<div class="paragraph">
<p>The <code>git revert</code> command is essentially a reverse <code>git cherry-pick</code>. It creates a new commit that applies the exact opposite of the change introduced in the commit you&#8217;re targeting, essentially undoing or reverting it.</p>
</div>
<div class="paragraph">
<p>We use this in <a href="#_reverse_commit">Reverse the commit</a> to undo a merge commit.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_email">Email</h3>
<div class="paragraph">
<p>Many Git projects, including Git itself, are entirely maintained over mailing lists. Git has a number of tools built into it that help make this process easier, from generating patches you can easily email to applying those patches from an email box.</p>
</div>
<div class="sect3">
<h4 id="_git_apply">git apply</h4>
<div class="paragraph">
<p>The <code>git apply</code> command applies a patch created with the <code>git diff</code> or even GNU diff command. It is similar to what the <code>patch</code> command might do with a few small differences.</p>
</div>
<div class="paragraph">
<p>We demonstrate using it and the circumstances in which you might do so in <a href="#_patches_from_email">Applying Patches from E-mail</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_am_2">git am</h4>
<div class="paragraph">
<p>The <code>git am</code> command is used to apply patches from an email inbox, specifically one that is mbox formatted. This is useful for receiving patches over email and applying them to your project easily.</p>
</div>
<div class="paragraph">
<p>We covered usage and workflow around <code>git am</code> in <a href="#_git_am">Applying a Patch with <code>am</code></a> including using the <code>--resolved</code>, <code>-i</code> and <code>-3</code> options.</p>
</div>
<div class="paragraph">
<p>There are also a number of hooks you can use to help with the workflow around <code>git am</code> and they are all covered in <a href="#_email_hooks">E-mail Workflow Hooks</a>.</p>
</div>
<div class="paragraph">
<p>We also use it to apply patch formatted GitHub Pull Request changes in <a href="#_email_notifications">Email Notifications</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_format_patch">git format-patch</h4>
<div class="paragraph">
<p>The <code>git format-patch</code> command is used to generate a series of patches in mbox format that you can use to send to a mailing list properly formatted.</p>
</div>
<div class="paragraph">
<p>We go through an example of contributing to a project using the <code>git format-patch</code> tool in <a href="#_project_over_email">Public Project over E-Mail</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_send_email">git send-email</h4>
<div class="paragraph">
<p>The <code>git send-email</code> command is used to send patches that are generated with <code>git format-patch</code> over email.</p>
</div>
<div class="paragraph">
<p>We go through an example of contributing to a project by sending patches with the <code>git send-email</code> tool in <a href="#_project_over_email">Public Project over E-Mail</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_request_pull">git request-pull</h4>
<div class="paragraph">
<p>The <code>git request-pull</code> command is simply used to generate an example message body to email to someone. If you have a branch on a public server and want to let someone know how to integrate those changes without sending the patches over email, you can run this command and send the output to the person you want to pull the changes in.</p>
</div>
<div class="paragraph">
<p>We demonstrate how to use <code>git request-pull</code> to generate a pull message in <a href="#_public_project">Forked Public Project</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_external_systems">External Systems</h3>
<div class="paragraph">
<p>Git comes with a few commands to integrate with other version control systems.</p>
</div>
<div class="sect3">
<h4 id="_git_svn_2">git svn</h4>
<div class="paragraph">
<p>The <code>git svn</code> command is used to communicate with the Subversion version control system as a client. This means you can use Git to checkout from and commit to a Subversion server.</p>
</div>
<div class="paragraph">
<p>This command is covered in depth in <a href="#_git_svn">Git and Subversion</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_fast_import">git fast-import</h4>
<div class="paragraph">
<p>For other version control systems or importing from nearly any format, you can use <code>git fast-import</code> to quickly map the other format to something Git can easily record.</p>
</div>
<div class="paragraph">
<p>This command is coverd in depth in <a href="#_custom_importer">A Custom Importer</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_administration_2">Administration</h3>
<div class="paragraph">
<p>If you&#8217;re administering a Git repository or need to fix something in a big way, Git provides a number of administrative commands to help you out.</p>
</div>
<div class="sect3">
<h4 id="_git_gc_2">git gc</h4>
<div class="paragraph">
<p>The <code>git gc</code> command runs &#8220;garbage collection&#8221; on your repository, removing unnecessary files in your database and packing up the remaining files into a more efficient format.</p>
</div>
<div class="paragraph">
<p>This command normally runs in the background for you, though you can manually run it if you wish. We go over some examples of this in <a href="#_git_gc">Maintenance</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_fsck">git fsck</h4>
<div class="paragraph">
<p>The <code>git fsck</code> command is used to check the internal database for problems or inconsistencies.</p>
</div>
<div class="paragraph">
<p>We only quickly use this once in <a href="#_data_recovery">Data Recovery</a> to search for dangling objects.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_reflog_2">git reflog</h4>
<div class="paragraph">
<p>The <code>git reflog</code> command goes through a log of where all the heads of your branches have been as you work to find commits you may have lost through rewriting histories.</p>
</div>
<div class="paragraph">
<p>We cover this command mainly in <a href="#_git_reflog">引用日志</a>, where we show normal usage to and how to use <code>git log -g</code> to view the same information with <code>git log</code> output.</p>
</div>
<div class="paragraph">
<p>We also go through a practical example of recovering such a lost branch in <a href="#_data_recovery">Data Recovery</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_filter_branch">git filter-branch</h4>
<div class="paragraph">
<p>The <code>git filter-branch</code> command is used to rewrite loads of commits according to certain patterns, like removing a file everywhere or filtering the entire repository down to a single subdirectory for extracting a project.</p>
</div>
<div class="paragraph">
<p>In <a href="#_removing_file_every_commit">Removing a File from Every Commit</a> we explain the command and explore several different options such as <code>--commit-filter</code>, <code>--subdirectory-filter</code> and <code>--tree-filter</code>.</p>
</div>
<div class="paragraph">
<p>In <a href="#_git_p4">Git-p4</a> and <a href="#_git_tfs">TFS</a> we use it to fix up imported external repositories.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_plumbing_commands">Plumbing Commands</h3>
<div class="paragraph">
<p>There were also quite a number of lower level plumbing commands that we encountered in the book.</p>
</div>
<div class="paragraph">
<p>The first one we encounter is <code>ls-remote</code> in <a href="#_pr_refs">Pull Request Refs</a> which we use to look at the raw references on the server.</p>
</div>
<div class="paragraph">
<p>We use <code>ls-files</code> in <a href="#_manual_remerge">Manual File Re-merging</a>, <a href="#_rerere">Rerere</a> and <a href="#_the_index">The Index</a> to take a more raw look at what your staging area looks like.</p>
</div>
<div class="paragraph">
<p>We also mention <code>rev-parse</code> in <a href="#_branch_references">分支引用</a> to take just about any string and turn it into an object SHA.</p>
</div>
<div class="paragraph">
<p>However, most of the low level plumbing commands we cover are in <a href="#_git_internals">Git Internals</a>, which is more or less what the chapter is focused on. We tried to avoid use of them throughout most of the rest of the book.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-10-31 23:12:16 CST
</div>
</div>
</body>
</html>